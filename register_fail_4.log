npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

 DEV  v4.0.16 C:/Users/scoot/poll/VaultLogic

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768675231564,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

{"level":30,"time":1768675235454,"env":"test","msg":"DB: initializing... Local"}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768675235684,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
Î“Ã…âŒ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Applied failsafe schema fixes

{"level":30,"time":1768675237341,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768675237352,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768675237346,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768675237346,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768675237349,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768675237349,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768675237352,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768675237352,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768675237352,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768675237352,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768675237820,"env":"test","module":"user-credentials-repository","userId":"adbe176c-a5e7-4e4a-a4aa-b4f20585840e","msg":"User credentials created"}
{"level":30,"time":1768675237931,"env":"test","module":"email-queue","jobId":"a1edff83-bfea-48df-9314-d295298e0597","to":"test-6L9dKaT8ZHYVKts7473te@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768675237934,"env":"test","module":"auth-routes","error":{},"msg":"Registration failed"}
{"level":30,"time":1768675237942,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768675237942,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
CRITICAL REGISTRATION ERROR: ReferenceError: JWT_SECRET is not defined
    at AuthService.createToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:72:9)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:248:33
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 3395ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiÎ“Ã‡Âª
       |             ^
    115|     }
    116| 
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  12:40:22
   Duration  19.11s (transform 5.13s, setup 2.41s, import 9.07s, tests 3.40s, environment 0ms)

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/AuthService.ts x1 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768675271538,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768675416295,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768675416327,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
Î“Ã…âŒ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768675418069,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768675418081,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768675418074,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768675418074,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768675418078,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768675418078,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768675418080,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768675418081,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768675418081,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768675418081,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768675418546,"env":"test","module":"user-credentials-repository","userId":"7378f57d-b3ae-41e6-bf78-2478667b9e3e","msg":"User credentials created"}
{"level":30,"time":1768675418656,"env":"test","module":"email-queue","jobId":"816b9366-58c1-4c8c-ba59-fafe292f0332","to":"test-fUzIRiWhsuuZP8BEKbEMg@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675418718,"env":"test","module":"auth-routes","userId":"7378f57d-b3ae-41e6-bf78-2478667b9e3e","email":"test-fUzIRiWhsuuZP8BEKbEMg@example.com","msg":"User registered"}
{"level":30,"time":1768675419411,"env":"test","module":"user-credentials-repository","userId":"2bc60d38-eb29-45b5-abb9-f778eec0fad2","msg":"User credentials created"}
{"level":30,"time":1768675419520,"env":"test","module":"email-queue","jobId":"7a7cf87d-3e56-41bb-b03f-b22319033f0f","to":"protected-test-qPXIVuC2wNibOPqiZ8-8l@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675419575,"env":"test","module":"auth-routes","userId":"2bc60d38-eb29-45b5-abb9-f778eec0fad2","email":"protected-test-qPXIVuC2wNibOPqiZ8-8l@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675420258,"env":"test","module":"auth-routes","userId":"2bc60d38-eb29-45b5-abb9-f778eec0fad2","msg":"User logged in successfully"}
{"level":30,"time":1768675420313,"env":"test","module":"audit-log-service","userId":"2bc60d38-eb29-45b5-abb9-f778eec0fad2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675420755,"env":"test","module":"user-credentials-repository","userId":"d78b4603-978c-45db-a39f-d27130882298","msg":"User credentials created"}
{"level":30,"time":1768675420863,"env":"test","module":"email-queue","jobId":"a997a4ff-67ba-43b0-8f96-11d3de4de5d2","to":"protected-test-or4o03sl5DfcfDx5y7EEW@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675420919,"env":"test","module":"auth-routes","userId":"d78b4603-978c-45db-a39f-d27130882298","email":"protected-test-or4o03sl5DfcfDx5y7EEW@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675421579,"env":"test","module":"auth-routes","userId":"d78b4603-978c-45db-a39f-d27130882298","msg":"User logged in successfully"}
{"level":30,"time":1768675421634,"env":"test","module":"audit-log-service","userId":"d78b4603-978c-45db-a39f-d27130882298","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675421638,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675422031,"env":"test","module":"user-credentials-repository","userId":"095fec33-385b-4c4f-bcd1-d29d7b130ef7","msg":"User credentials created"}
{"level":30,"time":1768675422139,"env":"test","module":"email-queue","jobId":"120d79c2-efcd-4ec2-b141-b22a792e1fd7","to":"protected-test-37_i4pFn6M82-x-hZDbPO@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675422196,"env":"test","module":"auth-routes","userId":"095fec33-385b-4c4f-bcd1-d29d7b130ef7","email":"protected-test-37_i4pFn6M82-x-hZDbPO@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675422861,"env":"test","module":"auth-routes","userId":"095fec33-385b-4c4f-bcd1-d29d7b130ef7","msg":"User logged in successfully"}
{"level":30,"time":1768675422917,"env":"test","module":"audit-log-service","userId":"095fec33-385b-4c4f-bcd1-d29d7b130ef7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675422920,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675423314,"env":"test","module":"user-credentials-repository","userId":"c113ad5c-7c6d-43b3-b45d-0d4211bf20c0","msg":"User credentials created"}
{"level":30,"time":1768675423430,"env":"test","module":"email-queue","jobId":"3e5b711b-5870-42ac-be6a-017ff70e1b2c","to":"protected-test-1Yzr4NF506OtgrRShP_PC@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675423484,"env":"test","module":"auth-routes","userId":"c113ad5c-7c6d-43b3-b45d-0d4211bf20c0","email":"protected-test-1Yzr4NF506OtgrRShP_PC@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675424162,"env":"test","module":"auth-routes","userId":"c113ad5c-7c6d-43b3-b45d-0d4211bf20c0","msg":"User logged in successfully"}
{"level":30,"time":1768675424218,"env":"test","module":"audit-log-service","userId":"c113ad5c-7c6d-43b3-b45d-0d4211bf20c0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675424221,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675424607,"env":"test","module":"user-credentials-repository","userId":"af57b294-df1e-435c-8b29-c5b44ddb3eae","msg":"User credentials created"}
{"level":30,"time":1768675424723,"env":"test","module":"email-queue","jobId":"8d13cb28-31b9-4c0e-96d4-53381c83fa4b","to":"protected-test-1B7vPZIcKsm2X6Y3MXgJx@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675424780,"env":"test","module":"auth-routes","userId":"af57b294-df1e-435c-8b29-c5b44ddb3eae","email":"protected-test-1B7vPZIcKsm2X6Y3MXgJx@example.com","msg":"User registered"}
{"level":30,"time":1768675425463,"env":"test","module":"auth-routes","userId":"af57b294-df1e-435c-8b29-c5b44ddb3eae","msg":"User logged in successfully"}
{"level":30,"time":1768675425517,"env":"test","module":"audit-log-service","userId":"af57b294-df1e-435c-8b29-c5b44ddb3eae","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768675425520,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768675425521,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675425924,"env":"test","module":"user-credentials-repository","userId":"a1d028f2-51b3-4021-b63c-7c88fc9b915a","msg":"User credentials created"}
{"level":30,"time":1768675426040,"env":"test","module":"email-queue","jobId":"18108ec9-6f8d-40e4-a753-96e9bafbe415","to":"protected-test-ZmDxkZxisjavhDgHhJ8L3@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675426096,"env":"test","module":"auth-routes","userId":"a1d028f2-51b3-4021-b63c-7c88fc9b915a","email":"protected-test-ZmDxkZxisjavhDgHhJ8L3@example.com","msg":"User registered"}
{"level":30,"time":1768675426772,"env":"test","module":"auth-routes","userId":"a1d028f2-51b3-4021-b63c-7c88fc9b915a","msg":"User logged in successfully"}
{"level":30,"time":1768675426828,"env":"test","module":"audit-log-service","userId":"a1d028f2-51b3-4021-b63c-7c88fc9b915a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675427279,"env":"test","module":"user-credentials-repository","userId":"97de07b6-3043-4744-ad1e-8d95f52e979f","msg":"User credentials created"}
{"level":30,"time":1768675427407,"env":"test","module":"email-queue","jobId":"4a776a3e-0057-43b6-a301-645ca0f97021","to":"protected-test-0BGCCJfdzmhz3pcdU_CWo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675427466,"env":"test","module":"auth-routes","userId":"97de07b6-3043-4744-ad1e-8d95f52e979f","email":"protected-test-0BGCCJfdzmhz3pcdU_CWo@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675428149,"env":"test","module":"auth-routes","userId":"97de07b6-3043-4744-ad1e-8d95f52e979f","msg":"User logged in successfully"}
{"level":30,"time":1768675428225,"env":"test","module":"audit-log-service","userId":"97de07b6-3043-4744-ad1e-8d95f52e979f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675428230,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675428635,"env":"test","module":"user-credentials-repository","userId":"4b4f3cfb-79f9-4b54-82c9-cc1950a72887","msg":"User credentials created"}
{"level":30,"time":1768675428744,"env":"test","module":"email-queue","jobId":"378e09ac-1772-4da6-86d5-770fcf5a5583","to":"protected-test-OhOsdWy_jaUbj7EnVHmcD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675428801,"env":"test","module":"auth-routes","userId":"4b4f3cfb-79f9-4b54-82c9-cc1950a72887","email":"protected-test-OhOsdWy_jaUbj7EnVHmcD@example.com","msg":"User registered"}
{"level":30,"time":1768675429460,"env":"test","module":"auth-routes","userId":"4b4f3cfb-79f9-4b54-82c9-cc1950a72887","msg":"User logged in successfully"}
{"level":30,"time":1768675429520,"env":"test","module":"audit-log-service","userId":"4b4f3cfb-79f9-4b54-82c9-cc1950a72887","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675429523,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675429908,"env":"test","module":"user-credentials-repository","userId":"15eaa60d-7185-429d-8e05-0ac8928946aa","msg":"User credentials created"}
{"level":30,"time":1768675430019,"env":"test","module":"email-queue","jobId":"bb54228d-3eaa-46f4-af5b-f46644b7d67c","to":"protected-test-zE-5YDeuKb5oQo6iKz_DS@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675430074,"env":"test","module":"auth-routes","userId":"15eaa60d-7185-429d-8e05-0ac8928946aa","email":"protected-test-zE-5YDeuKb5oQo6iKz_DS@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675430746,"env":"test","module":"auth-routes","userId":"15eaa60d-7185-429d-8e05-0ac8928946aa","msg":"User logged in successfully"}
{"level":30,"time":1768675430804,"env":"test","module":"audit-log-service","userId":"15eaa60d-7185-429d-8e05-0ac8928946aa","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[DEBUG] BaseRepository.update users: id=15eaa60d-7185-429d-8e05-0ac8928946aa, updates={"defaultMode":"advanced","updatedAt":"2026-01-17T18:43:50.924Z"}
{"level":30,"time":1768675431408,"env":"test","module":"user-credentials-repository","userId":"6b38f2cb-697b-4b83-b652-fe932ae940e4","msg":"User credentials created"}
{"level":30,"time":1768675431518,"env":"test","module":"email-queue","jobId":"916ef83b-3259-477b-82dc-547f963df94d","to":"protected-test-mV3k9DkRzAFiHu-xVqczC@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675431574,"env":"test","module":"auth-routes","userId":"6b38f2cb-697b-4b83-b652-fe932ae940e4","email":"protected-test-mV3k9DkRzAFiHu-xVqczC@example.com","msg":"User registered"}
{"level":30,"time":1768675432262,"env":"test","module":"auth-routes","userId":"6b38f2cb-697b-4b83-b652-fe932ae940e4","msg":"User logged in successfully"}
{"level":30,"time":1768675432319,"env":"test","module":"audit-log-service","userId":"6b38f2cb-697b-4b83-b652-fe932ae940e4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675432323,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675432750,"env":"test","module":"user-credentials-repository","userId":"f4492b9e-12ea-4a70-8d8a-1456fbb064f3","msg":"User credentials created"}
{"level":30,"time":1768675432866,"env":"test","module":"email-queue","jobId":"60af3999-3f89-485b-8339-f90b82e56a25","to":"protected-test-89ZQidjE33I0XpxqASDP2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675432928,"env":"test","module":"auth-routes","userId":"f4492b9e-12ea-4a70-8d8a-1456fbb064f3","email":"protected-test-89ZQidjE33I0XpxqASDP2@example.com","msg":"User registered"}
{"level":30,"time":1768675433609,"env":"test","module":"auth-routes","userId":"f4492b9e-12ea-4a70-8d8a-1456fbb064f3","msg":"User logged in successfully"}
{"level":30,"time":1768675433670,"env":"test","module":"audit-log-service","userId":"f4492b9e-12ea-4a70-8d8a-1456fbb064f3","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675434247,"env":"test","module":"user-credentials-repository","userId":"c17f6ae9-0559-460d-89ae-6b7430f7fad5","msg":"User credentials created"}
{"level":30,"time":1768675434361,"env":"test","module":"email-queue","jobId":"a4557f9d-0037-4417-b157-4c5e9447b194","to":"protected-test-dkaOwhpLXRdQZQUYCF3pi@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675434423,"env":"test","module":"auth-routes","userId":"c17f6ae9-0559-460d-89ae-6b7430f7fad5","email":"protected-test-dkaOwhpLXRdQZQUYCF3pi@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675435092,"env":"test","module":"auth-routes","userId":"c17f6ae9-0559-460d-89ae-6b7430f7fad5","msg":"User logged in successfully"}
{"level":30,"time":1768675435146,"env":"test","module":"audit-log-service","userId":"c17f6ae9-0559-460d-89ae-6b7430f7fad5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675435150,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675435545,"env":"test","module":"user-credentials-repository","userId":"346faa0c-962a-4116-b22f-5cdbe0bf3308","msg":"User credentials created"}
{"level":30,"time":1768675435655,"env":"test","module":"email-queue","jobId":"0a7d243c-2611-4494-bd1c-86c040a064a7","to":"protected-test-Y8NKas4JUGJdiNbNOmePx@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675435716,"env":"test","module":"auth-routes","userId":"346faa0c-962a-4116-b22f-5cdbe0bf3308","email":"protected-test-Y8NKas4JUGJdiNbNOmePx@example.com","msg":"User registered"}
{"level":30,"time":1768675436383,"env":"test","module":"auth-routes","userId":"346faa0c-962a-4116-b22f-5cdbe0bf3308","msg":"User logged in successfully"}
{"level":30,"time":1768675436443,"env":"test","module":"audit-log-service","userId":"346faa0c-962a-4116-b22f-5cdbe0bf3308","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675437609,"env":"test","module":"user-credentials-repository","userId":"6f726ada-c2ce-4426-ac0c-38f1a2aad367","msg":"User credentials created"}
{"level":30,"time":1768675437723,"env":"test","module":"email-queue","jobId":"e8e20a30-f196-42cb-8fc1-a9c105db26f4","to":"protected-test-Sk6b8APhPVy-wwuKJlyW1@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675437784,"env":"test","module":"auth-routes","userId":"6f726ada-c2ce-4426-ac0c-38f1a2aad367","email":"protected-test-Sk6b8APhPVy-wwuKJlyW1@example.com","msg":"User registered"}
{"level":30,"time":1768675438453,"env":"test","module":"auth-routes","userId":"6f726ada-c2ce-4426-ac0c-38f1a2aad367","msg":"User logged in successfully"}
{"level":30,"time":1768675438514,"env":"test","module":"audit-log-service","userId":"6f726ada-c2ce-4426-ac0c-38f1a2aad367","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675438519,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675438904,"env":"test","module":"user-credentials-repository","userId":"f3da896b-6e60-4b62-9819-f6add382aee5","msg":"User credentials created"}
{"level":30,"time":1768675439019,"env":"test","module":"email-queue","jobId":"b861d1b4-5009-4c4a-97d7-44d1ee79a63a","to":"protected-test-0OoSZDLj79EIT1i0P6mG-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675439077,"env":"test","module":"auth-routes","userId":"f3da896b-6e60-4b62-9819-f6add382aee5","email":"protected-test-0OoSZDLj79EIT1i0P6mG-@example.com","msg":"User registered"}
{"level":30,"time":1768675439743,"env":"test","module":"auth-routes","userId":"f3da896b-6e60-4b62-9819-f6add382aee5","msg":"User logged in successfully"}
{"level":30,"time":1768675439799,"env":"test","module":"audit-log-service","userId":"f3da896b-6e60-4b62-9819-f6add382aee5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768675439803,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768675439804,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675440205,"env":"test","module":"user-credentials-repository","userId":"ae691eb9-9757-43cf-8b9d-b675eabb8829","msg":"User credentials created"}
{"level":30,"time":1768675440320,"env":"test","module":"email-queue","jobId":"9296e607-4917-443d-b1fb-c561cd170b66","to":"protected-test-WVMQtyksP2k_VfPWHI0iq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675440377,"env":"test","module":"auth-routes","userId":"ae691eb9-9757-43cf-8b9d-b675eabb8829","email":"protected-test-WVMQtyksP2k_VfPWHI0iq@example.com","msg":"User registered"}
{"level":30,"time":1768675441052,"env":"test","module":"auth-routes","userId":"ae691eb9-9757-43cf-8b9d-b675eabb8829","msg":"User logged in successfully"}
{"level":30,"time":1768675441113,"env":"test","module":"audit-log-service","userId":"ae691eb9-9757-43cf-8b9d-b675eabb8829","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675441117,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675441504,"env":"test","module":"user-credentials-repository","userId":"69116584-1d88-4493-b75d-ca06ffed7c28","msg":"User credentials created"}
{"level":30,"time":1768675441615,"env":"test","module":"email-queue","jobId":"82e8a27f-e492-4e72-9206-9211882d61f4","to":"protected-test-PdzPPgZ_LbT2tN3Y8KcYl@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675441674,"env":"test","module":"auth-routes","userId":"69116584-1d88-4493-b75d-ca06ffed7c28","email":"protected-test-PdzPPgZ_LbT2tN3Y8KcYl@example.com","msg":"User registered"}
{"level":30,"time":1768675442375,"env":"test","module":"auth-routes","userId":"69116584-1d88-4493-b75d-ca06ffed7c28","msg":"User logged in successfully"}
{"level":30,"time":1768675442436,"env":"test","module":"audit-log-service","userId":"69116584-1d88-4493-b75d-ca06ffed7c28","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675442441,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675442825,"env":"test","module":"user-credentials-repository","userId":"6f7dc630-d464-4d62-9655-de1bcd69feca","msg":"User credentials created"}
{"level":30,"time":1768675442941,"env":"test","module":"email-queue","jobId":"e63ac079-be62-4ed9-afff-da60e964578a","to":"protected-test-dVcbEzl3vDXW_-ni7af-2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675442997,"env":"test","module":"auth-routes","userId":"6f7dc630-d464-4d62-9655-de1bcd69feca","email":"protected-test-dVcbEzl3vDXW_-ni7af-2@example.com","msg":"User registered"}
{"level":30,"time":1768675443676,"env":"test","module":"auth-routes","userId":"6f7dc630-d464-4d62-9655-de1bcd69feca","msg":"User logged in successfully"}
{"level":30,"time":1768675443735,"env":"test","module":"audit-log-service","userId":"6f7dc630-d464-4d62-9655-de1bcd69feca","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675443739,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675444129,"env":"test","module":"user-credentials-repository","userId":"0bac0ec9-c2f4-4b4f-a331-9d967fefab0d","msg":"User credentials created"}
{"level":30,"time":1768675444238,"env":"test","module":"email-queue","jobId":"c660be00-ac13-4872-aa54-c57e16fdc8d9","to":"protected-test-kEq8y4Fub--ugunE7CJz9@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675444301,"env":"test","module":"auth-routes","userId":"0bac0ec9-c2f4-4b4f-a331-9d967fefab0d","email":"protected-test-kEq8y4Fub--ugunE7CJz9@example.com","msg":"User registered"}
{"level":30,"time":1768675444978,"env":"test","module":"auth-routes","userId":"0bac0ec9-c2f4-4b4f-a331-9d967fefab0d","msg":"User logged in successfully"}
{"level":30,"time":1768675445033,"env":"test","module":"audit-log-service","userId":"0bac0ec9-c2f4-4b4f-a331-9d967fefab0d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675445036,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675445422,"env":"test","module":"user-credentials-repository","userId":"66378c3c-22bd-475b-86a3-159ddfa0e56d","msg":"User credentials created"}
{"level":30,"time":1768675445539,"env":"test","module":"email-queue","jobId":"5684a965-67c6-42b1-8b18-164eba5e36b4","to":"protected-test-vY-13VqHyaet1NkEqn79q@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675445595,"env":"test","module":"auth-routes","userId":"66378c3c-22bd-475b-86a3-159ddfa0e56d","email":"protected-test-vY-13VqHyaet1NkEqn79q@example.com","msg":"User registered"}
{"level":30,"time":1768675446265,"env":"test","module":"auth-routes","userId":"66378c3c-22bd-475b-86a3-159ddfa0e56d","msg":"User logged in successfully"}
{"level":30,"time":1768675446319,"env":"test","module":"audit-log-service","userId":"66378c3c-22bd-475b-86a3-159ddfa0e56d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675446322,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675446721,"env":"test","module":"user-credentials-repository","userId":"2270748a-a712-42b4-832e-6dc5ec078e7d","msg":"User credentials created"}
{"level":30,"time":1768675446833,"env":"test","module":"email-queue","jobId":"640f91a4-4eef-417a-bdfc-ca20740e3ea2","to":"protected-test-knGOsg6O_DieOAqsAuBpg@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675446888,"env":"test","module":"auth-routes","userId":"2270748a-a712-42b4-832e-6dc5ec078e7d","email":"protected-test-knGOsg6O_DieOAqsAuBpg@example.com","msg":"User registered"}
{"level":30,"time":1768675447555,"env":"test","module":"auth-routes","userId":"2270748a-a712-42b4-832e-6dc5ec078e7d","msg":"User logged in successfully"}
{"level":30,"time":1768675447611,"env":"test","module":"audit-log-service","userId":"2270748a-a712-42b4-832e-6dc5ec078e7d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675447616,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675448040,"env":"test","module":"user-credentials-repository","userId":"6d14510b-480c-451f-9a8f-862073e84d90","msg":"User credentials created"}
{"level":30,"time":1768675448155,"env":"test","module":"email-queue","jobId":"7d0382ee-64e1-42a1-ad61-5c738d54053d","to":"protected-test-JroYFbLCF4sVupszEgHe3@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675448219,"env":"test","module":"auth-routes","userId":"6d14510b-480c-451f-9a8f-862073e84d90","email":"protected-test-JroYFbLCF4sVupszEgHe3@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675448905,"env":"test","module":"auth-routes","userId":"6d14510b-480c-451f-9a8f-862073e84d90","msg":"User logged in successfully"}
{"level":30,"time":1768675448962,"env":"test","module":"audit-log-service","userId":"6d14510b-480c-451f-9a8f-862073e84d90","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675449359,"env":"test","module":"user-credentials-repository","userId":"e232750c-e204-4e80-853c-002cef33d9e7","msg":"User credentials created"}
{"level":30,"time":1768675449477,"env":"test","module":"email-queue","jobId":"b70b09fa-3617-46e1-bb1f-0aaf5fdb3961","to":"protected-test-_QGlOUoeOlMZFqHjResY9@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675449532,"env":"test","module":"auth-routes","userId":"e232750c-e204-4e80-853c-002cef33d9e7","email":"protected-test-_QGlOUoeOlMZFqHjResY9@example.com","msg":"User registered"}
{"level":30,"time":1768675450221,"env":"test","module":"auth-routes","userId":"e232750c-e204-4e80-853c-002cef33d9e7","msg":"User logged in successfully"}
{"level":30,"time":1768675450277,"env":"test","module":"audit-log-service","userId":"e232750c-e204-4e80-853c-002cef33d9e7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675450824,"env":"test","module":"user-credentials-repository","userId":"a3923207-9fb7-4d72-a3e4-603beb541330","msg":"User credentials created"}
{"level":30,"time":1768675450939,"env":"test","module":"email-queue","jobId":"38655bf8-62a5-4974-8eba-5c9e5af06869","to":"protected-test-NLhySZdN6NivaXAY7KG7f@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675450995,"env":"test","module":"auth-routes","userId":"a3923207-9fb7-4d72-a3e4-603beb541330","email":"protected-test-NLhySZdN6NivaXAY7KG7f@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675451682,"env":"test","module":"auth-routes","userId":"a3923207-9fb7-4d72-a3e4-603beb541330","msg":"User logged in successfully"}
{"level":30,"time":1768675451741,"env":"test","module":"audit-log-service","userId":"a3923207-9fb7-4d72-a3e4-603beb541330","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675452136,"env":"test","module":"user-credentials-repository","userId":"7730dd50-2d5b-4d93-85fd-3c62e119cacc","msg":"User credentials created"}
{"level":30,"time":1768675452252,"env":"test","module":"email-queue","jobId":"4daff981-e619-456d-bd16-76641df85a19","to":"user2-_YtO2oKcrSn1Maf6yOM81@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675452308,"env":"test","module":"auth-routes","userId":"7730dd50-2d5b-4d93-85fd-3c62e119cacc","email":"user2-_YtO2oKcrSn1Maf6yOM81@example.com","msg":"User registered"}
{"level":30,"time":1768675452927,"env":"test","module":"auth-routes","userId":"7730dd50-2d5b-4d93-85fd-3c62e119cacc","msg":"User logged in successfully"}
{"level":30,"time":1768675452989,"env":"test","module":"audit-log-service","userId":"7730dd50-2d5b-4d93-85fd-3c62e119cacc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768675453053,"env":"test","module":"rbac-middleware","userId":"7730dd50-2d5b-4d93-85fd-3c62e119cacc","userRole":"viewer","permission":"project:delete","path":"/f3d3f20f-c17c-4d74-8d3c-9b0bca3d39d4","msg":"Permission denied"}
{"level":30,"time":1768675453449,"env":"test","module":"user-credentials-repository","userId":"665f2ed0-c8b5-4bad-84f4-a51c094af738","msg":"User credentials created"}
{"level":30,"time":1768675453558,"env":"test","module":"email-queue","jobId":"4f05f04e-281f-4b2d-96af-a2ddaf4950fe","to":"protected-test-p5P_evVlWJwq5i6IIHuDq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675453617,"env":"test","module":"auth-routes","userId":"665f2ed0-c8b5-4bad-84f4-a51c094af738","email":"protected-test-p5P_evVlWJwq5i6IIHuDq@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675454304,"env":"test","module":"auth-routes","userId":"665f2ed0-c8b5-4bad-84f4-a51c094af738","msg":"User logged in successfully"}
{"level":30,"time":1768675454363,"env":"test","module":"audit-log-service","userId":"665f2ed0-c8b5-4bad-84f4-a51c094af738","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675454824,"env":"test","module":"user-credentials-repository","userId":"abc5374c-07ae-46b8-bb49-f5251b41c633","msg":"User credentials created"}
{"level":30,"time":1768675454935,"env":"test","module":"email-queue","jobId":"b99235e0-5883-46b9-80de-1cc8aae7c270","to":"protected-test-m4QrYoZ2Rnm6nzLGIEyho@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675454992,"env":"test","module":"auth-routes","userId":"abc5374c-07ae-46b8-bb49-f5251b41c633","email":"protected-test-m4QrYoZ2Rnm6nzLGIEyho@example.com","msg":"User registered"}
{"level":30,"time":1768675455659,"env":"test","module":"auth-routes","userId":"abc5374c-07ae-46b8-bb49-f5251b41c633","msg":"User logged in successfully"}
{"level":30,"time":1768675455714,"env":"test","module":"audit-log-service","userId":"abc5374c-07ae-46b8-bb49-f5251b41c633","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675456155,"env":"test","module":"user-credentials-repository","userId":"7cb1cfa1-007e-437c-9d32-43deeb77c284","msg":"User credentials created"}
{"level":30,"time":1768675456265,"env":"test","module":"email-queue","jobId":"9c223cc3-47f1-4ee4-a5fa-f5e5411b2337","to":"protected-test-aA8MWQmYQal-wLo73NCRO@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675456321,"env":"test","module":"auth-routes","userId":"7cb1cfa1-007e-437c-9d32-43deeb77c284","email":"protected-test-aA8MWQmYQal-wLo73NCRO@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675456995,"env":"test","module":"auth-routes","userId":"7cb1cfa1-007e-437c-9d32-43deeb77c284","msg":"User logged in successfully"}
{"level":30,"time":1768675457050,"env":"test","module":"audit-log-service","userId":"7cb1cfa1-007e-437c-9d32-43deeb77c284","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675457507,"env":"test","module":"user-credentials-repository","userId":"26f90bc6-19af-45ef-a082-7b6a7d62907a","msg":"User credentials created"}
{"level":30,"time":1768675457627,"env":"test","module":"email-queue","jobId":"aeefe1ef-a06e-4d43-9f50-8407d05a38ec","to":"protected-test-isGohqfaMHYqjBeUwjGRH@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675457688,"env":"test","module":"auth-routes","userId":"26f90bc6-19af-45ef-a082-7b6a7d62907a","email":"protected-test-isGohqfaMHYqjBeUwjGRH@example.com","msg":"User registered"}
{"level":30,"time":1768675458408,"env":"test","module":"auth-routes","userId":"26f90bc6-19af-45ef-a082-7b6a7d62907a","msg":"User logged in successfully"}
{"level":30,"time":1768675458466,"env":"test","module":"audit-log-service","userId":"26f90bc6-19af-45ef-a082-7b6a7d62907a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675459322,"env":"test","module":"user-credentials-repository","userId":"10b155d7-731f-4d2d-a9f2-35df16628547","msg":"User credentials created"}
{"level":30,"time":1768675459430,"env":"test","module":"email-queue","jobId":"b49b1c6f-5624-4cb3-86b5-c9ecdba98e28","to":"protected-test-GSJvfaua86XeS8qhwKZPh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675459486,"env":"test","module":"auth-routes","userId":"10b155d7-731f-4d2d-a9f2-35df16628547","email":"protected-test-GSJvfaua86XeS8qhwKZPh@example.com","msg":"User registered"}
{"level":30,"time":1768675460163,"env":"test","module":"auth-routes","userId":"10b155d7-731f-4d2d-a9f2-35df16628547","msg":"User logged in successfully"}
{"level":30,"time":1768675460234,"env":"test","module":"audit-log-service","userId":"10b155d7-731f-4d2d-a9f2-35df16628547","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675460793,"env":"test","module":"auth-routes","userId":"10b155d7-731f-4d2d-a9f2-35df16628547","msg":"User logged in successfully"}
{"level":30,"time":1768675460849,"env":"test","module":"audit-log-service","userId":"10b155d7-731f-4d2d-a9f2-35df16628547","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675461319,"env":"test","module":"user-credentials-repository","userId":"f5f3556a-c359-4d87-a469-31258a4f0fa7","msg":"User credentials created"}
{"level":30,"time":1768675461433,"env":"test","module":"email-queue","jobId":"15c8cba6-7731-4f97-b750-b6a65c6b53c1","to":"protected-test-54wIpBMs540tdaubRNk3E@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675461494,"env":"test","module":"auth-routes","userId":"f5f3556a-c359-4d87-a469-31258a4f0fa7","email":"protected-test-54wIpBMs540tdaubRNk3E@example.com","msg":"User registered"}
{"level":30,"time":1768675462161,"env":"test","module":"auth-routes","userId":"f5f3556a-c359-4d87-a469-31258a4f0fa7","msg":"User logged in successfully"}
{"level":30,"time":1768675462217,"env":"test","module":"audit-log-service","userId":"f5f3556a-c359-4d87-a469-31258a4f0fa7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675462786,"env":"test","module":"auth-routes","userId":"f5f3556a-c359-4d87-a469-31258a4f0fa7","msg":"User logged in successfully"}
{"level":30,"time":1768675462846,"env":"test","module":"audit-log-service","userId":"f5f3556a-c359-4d87-a469-31258a4f0fa7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675463235,"env":"test","module":"user-credentials-repository","userId":"c039e7f0-ae6f-4e22-a40d-44e37145dce5","msg":"User credentials created"}
{"level":30,"time":1768675463345,"env":"test","module":"email-queue","jobId":"61f067f9-48e1-4f8f-9845-4a99b7076876","to":"user2-1y7r1_AJWWIp-EgrF4RcD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675463400,"env":"test","module":"auth-routes","userId":"c039e7f0-ae6f-4e22-a40d-44e37145dce5","email":"user2-1y7r1_AJWWIp-EgrF4RcD@example.com","msg":"User registered"}
{"level":30,"time":1768675463964,"env":"test","module":"auth-routes","userId":"c039e7f0-ae6f-4e22-a40d-44e37145dce5","msg":"User logged in successfully"}
{"level":30,"time":1768675464020,"env":"test","module":"audit-log-service","userId":"c039e7f0-ae6f-4e22-a40d-44e37145dce5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675464532,"env":"test","module":"user-credentials-repository","userId":"c45daace-7a59-4cf2-9082-7746bd6ebf59","msg":"User credentials created"}
{"level":30,"time":1768675464640,"env":"test","module":"email-queue","jobId":"de1a77e5-0404-4360-9983-22862269c85e","to":"protected-test-R1i38B8PAxVMtTTiYWRuu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675464695,"env":"test","module":"auth-routes","userId":"c45daace-7a59-4cf2-9082-7746bd6ebf59","email":"protected-test-R1i38B8PAxVMtTTiYWRuu@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675465383,"env":"test","module":"auth-routes","userId":"c45daace-7a59-4cf2-9082-7746bd6ebf59","msg":"User logged in successfully"}
{"level":30,"time":1768675465439,"env":"test","module":"audit-log-service","userId":"c45daace-7a59-4cf2-9082-7746bd6ebf59","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675466024,"env":"test","module":"intake-service","runId":"48d69e7f-02ff-47eb-8eb7-148c046da979","slug":"public-fPiO1XFwsLahXB-nKGMeP","msg":"Created intake run"}
{"level":30,"time":1768675466502,"env":"test","module":"user-credentials-repository","userId":"d1d172d2-6425-4800-977f-9f8792b772ca","msg":"User credentials created"}
{"level":30,"time":1768675466618,"env":"test","module":"email-queue","jobId":"86e2de84-2e38-47e5-ad36-6d8143c6713c","to":"protected-test-1JcTXj1YGF-Ngg9jSUzUB@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675466673,"env":"test","module":"auth-routes","userId":"d1d172d2-6425-4800-977f-9f8792b772ca","email":"protected-test-1JcTXj1YGF-Ngg9jSUzUB@example.com","msg":"User registered"}
{"level":30,"time":1768675467378,"env":"test","module":"auth-routes","userId":"d1d172d2-6425-4800-977f-9f8792b772ca","msg":"User logged in successfully"}
{"level":30,"time":1768675467439,"env":"test","module":"audit-log-service","userId":"d1d172d2-6425-4800-977f-9f8792b772ca","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675468011,"env":"test","module":"intake-service","runId":"d559e780-f39b-43de-a63d-dc2375c9c24f","slug":"optional-GOPwnt1tVdrn7nmbjCnHg","userId":"d1d172d2-6425-4800-977f-9f8792b772ca","msg":"Created intake run"}
{"level":30,"time":1768675468442,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768675468443,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â£Ã´ tests/integration/auth/protected.routes.test.ts (33 tests | 1 skipped) 52940ms
       Î“Â£Ã´ should allow access with valid Bearer token  1363ms
       Î“Â£Ã´ should reject access without Authorization header  1265ms
       Î“Â£Ã´ should reject access with empty Bearer token  1282ms
       Î“Â£Ã´ should reject access with malformed Authorization header  1301ms
       Î“Â£Ã´ should reject access with wrong token type  1299ms
       Î“Â£Ã´ should allow POST with valid Bearer token  1371ms
       Î“Â£Ã´ should reject POST without Bearer token  1339ms
       Î“Â£Ã´ should reject POST with invalid token  1292ms
       Î“Â£Ã´ should allow PUT with valid Bearer token  1457ms
       Î“Â£Ã´ should reject PUT without Bearer token  1343ms
       Î“Â£Ã´ should allow DELETE with valid Bearer token  1530ms
       Î“Â£Ã´ should reject DELETE without Bearer token  1297ms
       Î“Â£Ã´ should allow PATCH with valid Bearer token  2068ms
       Î“Â£Ã´ should reject PATCH without Bearer token  1300ms
       Î“Â£Ã´ should handle Bearer token with extra spaces  1285ms
       Î“Â£Ã´ should handle very long invalid token  1313ms
       Î“Â£Ã´ should handle empty Authorization header  1324ms
       Î“Â£Ã´ should handle Authorization header with only Bearer  1299ms
       Î“Â£Ã´ should handle multiple Authorization headers  1298ms
       Î“Â£Ã´ should reject token with SQL injection attempt  1284ms
       Î“Â£Ã´ should reject token with XSS attempt  1295ms
       Î“Â£Ã´ should reject token with missing userId  1350ms
       Î“Â£Ã´ should reject token with non-existent userId  1426ms
       Î“Â£Ã´ should not allow user to access another user's resources  2659ms
       Î“Â£Ã´ should inject userId into request context  1378ms
       Î“Â£Ã´ should inject tenantId into request context  1343ms
       Î“Â£Ã´ should inject role into request context  1336ms
       Î“Â£Ã´ should not apply general rate limiting to authenticated requests  1797ms
       Î“Â£Ã´ should handle request with both Bearer token and cookies  2002ms
       Î“Â£Ã´ should prioritize Bearer token over cookie when both present  3230ms
       Î“Â£Ã´ should allow unauthenticated access to optional auth routes  1945ms
       Î“Â£Ã´ should enhance optional auth routes with user context when authenticated  2041ms

 Test Files  1 passed (1)
      Tests  32 passed | 1 skipped (33)
   Start at  12:40:53
   Duration  214.45s

 PASS  Waiting for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x2 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768675492115,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768675495124,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768675495168,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
Î“Ã…âŒ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: []

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768675496710,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768675496725,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768675496717,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768675496718,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768675496721,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768675496721,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768675496724,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768675496725,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768675496725,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768675496725,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768675497175,"env":"test","module":"user-credentials-repository","userId":"9aeea2ac-d0b0-4ad5-8241-b4016c480fc5","msg":"User credentials created"}
{"level":30,"time":1768675497273,"env":"test","module":"email-queue","jobId":"6be51cc2-0a75-4404-89d2-204bbc32d174","to":"test-VUQmw6VCptAqFXVuuGTWN@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675497326,"env":"test","module":"auth-routes","userId":"9aeea2ac-d0b0-4ad5-8241-b4016c480fc5","email":"test-VUQmw6VCptAqFXVuuGTWN@example.com","msg":"User registered"}
{"level":30,"time":1768675497952,"env":"test","module":"user-credentials-repository","userId":"3f3a7141-54e6-4b3a-86ce-a1c5cd648b38","msg":"User credentials created"}
{"level":30,"time":1768675498055,"env":"test","module":"email-queue","jobId":"c652760a-1037-4f30-89e9-c983bedccbc1","to":"protected-test-GANEfk8LswjW6fV_jPoWm@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675498101,"env":"test","module":"auth-routes","userId":"3f3a7141-54e6-4b3a-86ce-a1c5cd648b38","email":"protected-test-GANEfk8LswjW6fV_jPoWm@example.com","msg":"User registered"}
{"level":50,"time":1768675498716,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["3f3a7141-54e6-4b3a-86ce-a1c5cd648b38","ddf8a87773c749783c4152a24f61fb59e56d195d50c059543e65a0f511b5741a","2026-02-16T18:44:58.666Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T18:44:58.667Z"],"cause":{"length":327,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(3f3a7141-54e6-4b3a-86ce-a1c5cd648b38) is not present in table \"users\".","schema":"public","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: 3f3a7141-54e6-4b3a-86ce-a1c5cd648b38,ddf8a87773c749783c4152a24f61fb59e56d195d50c059543e65a0f511b5741a,2026-02-16T18:44:58.666Z,false,{"ip":"::1"},,::1,Location Unknown,2026-01-17T18:44:58.667Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
  query: 'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)',
  params: [
    '3f3a7141-54e6-4b3a-86ce-a1c5cd648b38',
    'ddf8a87773c749783c4152a24f61fb59e56d195d50c059543e65a0f511b5741a',
    '2026-02-16T18:44:58.666Z',
    false,
    '{"ip":"::1"}',
    null,
    '::1',
    'Location Unknown',
    '2026-01-17T18:44:58.667Z'
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
    length: 327,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(3f3a7141-54e6-4b3a-86ce-a1c5cd648b38) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'public',
    table: 'refresh_tokens',
    column: undefined,
    dataType: undefined,
    constraint: 'refresh_tokens_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":30,"time":1768675499494,"env":"test","module":"user-credentials-repository","userId":"df8a0b13-4d1f-4c30-b9bd-109739b9066e","msg":"User credentials created"}
{"level":30,"time":1768675499620,"env":"test","module":"email-queue","jobId":"2acff9c4-233b-4077-a777-7ed0a879908f","to":"protected-test-bucs_onQsgdRB5nRRFrcT@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675499683,"env":"test","module":"auth-routes","userId":"df8a0b13-4d1f-4c30-b9bd-109739b9066e","email":"protected-test-bucs_onQsgdRB5nRRFrcT@example.com","msg":"User registered"}
{"level":30,"time":1768675500503,"env":"test","module":"user-credentials-repository","userId":"25bf5173-cdc6-43eb-93cc-140d0ca2d5cd","msg":"User credentials created"}
{"level":30,"time":1768675500631,"env":"test","module":"email-queue","jobId":"70626be1-f926-4f06-b5c8-5ed9ab665aaa","to":"protected-test-i8tISvKEmzHI2Tro4qSMY@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675500689,"env":"test","module":"auth-routes","userId":"25bf5173-cdc6-43eb-93cc-140d0ca2d5cd","email":"protected-test-i8tISvKEmzHI2Tro4qSMY@example.com","msg":"User registered"}
{"level":30,"time":1768675501519,"env":"test","module":"user-credentials-repository","userId":"f4cbe3b6-afeb-4d69-81a5-03665c3a140d","msg":"User credentials created"}
{"level":30,"time":1768675501635,"env":"test","module":"email-queue","jobId":"1b1c8653-493c-4ffa-af77-70723d5db535","to":"protected-test-_lNkSFdI1c2PV5oCr-wc-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675501724,"env":"test","module":"auth-routes","userId":"f4cbe3b6-afeb-4d69-81a5-03665c3a140d","email":"protected-test-_lNkSFdI1c2PV5oCr-wc-@example.com","msg":"User registered"}
{"level":30,"time":1768675502455,"env":"test","module":"user-credentials-repository","userId":"6dfac80b-b47b-4cda-a0f3-26bda4a85379","msg":"User credentials created"}
{"level":30,"time":1768675502554,"env":"test","module":"email-queue","jobId":"34919e63-87ed-4aae-8bb1-44211cca16eb","to":"protected-test-0azGIJgAqt9XkW3Exo-So@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675502603,"env":"test","module":"auth-routes","userId":"6dfac80b-b47b-4cda-a0f3-26bda4a85379","email":"protected-test-0azGIJgAqt9XkW3Exo-So@example.com","msg":"User registered"}
{"level":30,"time":1768675503442,"env":"test","module":"user-credentials-repository","userId":"cbf80c2f-b29f-463c-b838-a1c0e484c087","msg":"User credentials created"}
{"level":30,"time":1768675503559,"env":"test","module":"email-queue","jobId":"a2c52f38-0e97-40cf-9e93-562c748d0c5f","to":"protected-test-L6utB1oLGZeKI9pafJlQh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675503617,"env":"test","module":"auth-routes","userId":"cbf80c2f-b29f-463c-b838-a1c0e484c087","email":"protected-test-L6utB1oLGZeKI9pafJlQh@example.com","msg":"User registered"}
{"level":30,"time":1768675504338,"env":"test","module":"user-credentials-repository","userId":"f3ec1074-2c78-4288-9038-c6f0339d4253","msg":"User credentials created"}
{"level":30,"time":1768675504425,"env":"test","module":"email-queue","jobId":"9ffd5c9f-c789-41a9-91b5-6ff74b39d2b7","to":"protected-test-_M_-zbY1j399u0pqDqXDp@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675504473,"env":"test","module":"auth-routes","userId":"f3ec1074-2c78-4288-9038-c6f0339d4253","email":"protected-test-_M_-zbY1j399u0pqDqXDp@example.com","msg":"User registered"}
{"level":30,"time":1768675505188,"env":"test","module":"user-credentials-repository","userId":"6ed4a796-6dc4-48fe-a99a-107159f83b23","msg":"User credentials created"}
{"level":30,"time":1768675505282,"env":"test","module":"email-queue","jobId":"204aec22-641a-4d53-9590-baf5597e6d65","to":"protected-test-iTUaxfS4AwzhUtJzYX50g@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675505327,"env":"test","module":"auth-routes","userId":"6ed4a796-6dc4-48fe-a99a-107159f83b23","email":"protected-test-iTUaxfS4AwzhUtJzYX50g@example.com","msg":"User registered"}
{"level":30,"time":1768675506135,"env":"test","module":"user-credentials-repository","userId":"d1894e64-b192-4d4d-884a-ad05ac825103","msg":"User credentials created"}
{"level":30,"time":1768675506250,"env":"test","module":"email-queue","jobId":"bc3b94d3-5176-4dfa-97b9-cbe9aa6852be","to":"protected-test-wyCNw0n21VN8fvAJhVXVo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675506312,"env":"test","module":"auth-routes","userId":"d1894e64-b192-4d4d-884a-ad05ac825103","email":"protected-test-wyCNw0n21VN8fvAJhVXVo@example.com","msg":"User registered"}
{"level":30,"time":1768675507026,"env":"test","module":"user-credentials-repository","userId":"74760594-c2e5-4cf5-a99d-99ffe7b34446","msg":"User credentials created"}
{"level":30,"time":1768675507116,"env":"test","module":"email-queue","jobId":"5ef50e8a-eda2-4040-9913-14a1d80d9756","to":"protected-test-hOeCjzcY6n51LHyhfM0m2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675507161,"env":"test","module":"auth-routes","userId":"74760594-c2e5-4cf5-a99d-99ffe7b34446","email":"protected-test-hOeCjzcY6n51LHyhfM0m2@example.com","msg":"User registered"}
{"level":30,"time":1768675507855,"env":"test","module":"user-credentials-repository","userId":"6169057d-5657-4106-b870-16fd18a08909","msg":"User credentials created"}
{"level":50,"time":1768675507905,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["6169057d-5657-4106-b870-16fd18a08909","1bef082340500dc18aee26a583aa658130d134718cf088231c159907a214902a","2026-01-18T18:45:07.856Z"],"cause":{"length":382,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(6169057d-5657-4106-b870-16fd18a08909) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675508558,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["3fe59f41-22e2-49be-99c0-ddda1f253b69","$2b$12$wR9aDPk5djeu1wcc7W6KuOpKeOFfpMF.VjD/SmPAmTouMNo1WIpym"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(3fe59f41-22e2-49be-99c0-ddda1f253b69) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"3fe59f41-22e2-49be-99c0-ddda1f253b69","msg":"Failed to create user credentials"}
{"level":50,"time":1768675508559,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["3fe59f41-22e2-49be-99c0-ddda1f253b69","$2b$12$wR9aDPk5djeu1wcc7W6KuOpKeOFfpMF.VjD/SmPAmTouMNo1WIpym"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(3fe59f41-22e2-49be-99c0-ddda1f253b69) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675509302,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["f701b8bc-5241-4509-a6db-3dcf2a64785d","$2b$12$vtHo0Omc1ivwj7vgoTDD6OKn90hRRl5itTL5cDGF/1IQvd44yoeFK"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f701b8bc-5241-4509-a6db-3dcf2a64785d) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"f701b8bc-5241-4509-a6db-3dcf2a64785d","msg":"Failed to create user credentials"}
{"level":50,"time":1768675509302,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["f701b8bc-5241-4509-a6db-3dcf2a64785d","$2b$12$vtHo0Omc1ivwj7vgoTDD6OKn90hRRl5itTL5cDGF/1IQvd44yoeFK"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f701b8bc-5241-4509-a6db-3dcf2a64785d) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675510067,"env":"test","module":"user-credentials-repository","userId":"dd6b72d6-dcf3-4d12-a04e-d7e90efe97a0","msg":"User credentials created"}
{"level":30,"time":1768675510188,"env":"test","module":"email-queue","jobId":"c1d80b7d-76fd-46e0-9a26-5964a9d2f18c","to":"protected-test-CXFGn5t8yjBYvFvQS_Gct@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768675510246,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["dd6b72d6-dcf3-4d12-a04e-d7e90efe97a0","42e76bc9dfbf7091efe912b0e67e9111e611f79f2a7b5d80231bd619b3d011a1","2026-02-16T18:45:10.188Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T18:45:10.188Z"],"cause":{"length":327,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(dd6b72d6-dcf3-4d12-a04e-d7e90efe97a0) is not present in table \"users\".","schema":"public","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675510895,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["3afe0f5b-49c4-4574-bc9b-2691723d2151","$2b$12$i7irUePMuAMgeGqQGIfG4.oR9OYosEbTiioMZwc6nl0IhY8.C0MGa"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(3afe0f5b-49c4-4574-bc9b-2691723d2151) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"3afe0f5b-49c4-4574-bc9b-2691723d2151","msg":"Failed to create user credentials"}
{"level":50,"time":1768675510895,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["3afe0f5b-49c4-4574-bc9b-2691723d2151","$2b$12$i7irUePMuAMgeGqQGIfG4.oR9OYosEbTiioMZwc6nl0IhY8.C0MGa"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(3afe0f5b-49c4-4574-bc9b-2691723d2151) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675511558,"env":"test","module":"user-credentials-repository","userId":"7812095d-aab6-47b2-903b-dca5cf9c2d95","msg":"User credentials created"}
{"level":30,"time":1768675511651,"env":"test","module":"email-queue","jobId":"9db49657-1643-4147-8215-fb184107b378","to":"protected-test-rbLr-yuENOS7xDUsVEKOo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768675511701,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["7812095d-aab6-47b2-903b-dca5cf9c2d95","ac00c7f79ac82b4bcca2ddf7b6f53c9155ef22f02ced6e3cc52125f2d587fe12","2026-02-16T18:45:11.654Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T18:45:11.654Z"],"cause":{"length":327,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(7812095d-aab6-47b2-903b-dca5cf9c2d95) is not present in table \"users\".","schema":"public","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675512488,"env":"test","module":"user-credentials-repository","userId":"4ebc286a-e345-4c60-95ff-fa21c9524dc0","msg":"User credentials created"}
{"level":30,"time":1768675512610,"env":"test","module":"email-queue","jobId":"90def4a5-263c-41e0-8f94-5f34021b98d1","to":"protected-test-8WMbhZDbJIeHtrboucd9i@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768675512672,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["4ebc286a-e345-4c60-95ff-fa21c9524dc0","0e4925bfd94d518addc275cd53f7c9dadc5804541502dca6abf4fc80e22409a0","2026-02-16T18:45:12.611Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T18:45:12.611Z"],"cause":{"length":338,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(4ebc286a-e345-4c60-95ff-fa21c9524dc0) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675513438,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["0d167c24-d2e7-499a-898c-800c1f0f87cf","$2b$12$jnYAuj2EdbLM3D1APjNnqeK9lcJxSstrJ9hMYcRHv549IK/pf7/Kq"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(0d167c24-d2e7-499a-898c-800c1f0f87cf) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"0d167c24-d2e7-499a-898c-800c1f0f87cf","msg":"Failed to create user credentials"}
{"level":50,"time":1768675513438,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["0d167c24-d2e7-499a-898c-800c1f0f87cf","$2b$12$jnYAuj2EdbLM3D1APjNnqeK9lcJxSstrJ9hMYcRHv549IK/pf7/Kq"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(0d167c24-d2e7-499a-898c-800c1f0f87cf) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675514113,"env":"test","module":"user-credentials-repository","userId":"609cd4d1-2279-46d7-896d-99e542367b40","msg":"User credentials created"}
{"level":30,"time":1768675514205,"env":"test","module":"email-queue","jobId":"d6c51756-7472-4f42-9d32-a48302789192","to":"protected-test-tGBLPxpb95831FZHKaI0t@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675514265,"env":"test","module":"auth-routes","userId":"609cd4d1-2279-46d7-896d-99e542367b40","email":"protected-test-tGBLPxpb95831FZHKaI0t@example.com","msg":"User registered"}
{"level":30,"time":1768675515124,"env":"test","module":"user-credentials-repository","userId":"7f19b08b-860a-4601-9a39-dd6694871feb","msg":"User credentials created"}
{"level":30,"time":1768675515239,"env":"test","module":"email-queue","jobId":"c46f7255-f2fc-4092-adb1-d9b671475d29","to":"protected-test-hhsQcTg53NtjMOVHV1gnB@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675515296,"env":"test","module":"auth-routes","userId":"7f19b08b-860a-4601-9a39-dd6694871feb","email":"protected-test-hhsQcTg53NtjMOVHV1gnB@example.com","msg":"User registered"}
{"level":50,"time":1768675516111,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["21cca690-c6de-4b48-8123-8d320f720617","$2b$12$65r44KfBiuuCgEURKDExW.XPWhAWCbXSI0iwyl9VC11aMF7.asdCi"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(21cca690-c6de-4b48-8123-8d320f720617) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"21cca690-c6de-4b48-8123-8d320f720617","msg":"Failed to create user credentials"}
{"level":50,"time":1768675516111,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["21cca690-c6de-4b48-8123-8d320f720617","$2b$12$65r44KfBiuuCgEURKDExW.XPWhAWCbXSI0iwyl9VC11aMF7.asdCi"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(21cca690-c6de-4b48-8123-8d320f720617) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675516769,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["c877f824-55c4-481f-aa45-669dce80d894","$2b$12$IIki3ryeetKJklno3wxXdeNG6yS6jsOlztnutY4q.F9V2An3/30RG"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c877f824-55c4-481f-aa45-669dce80d894) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"c877f824-55c4-481f-aa45-669dce80d894","msg":"Failed to create user credentials"}
{"level":50,"time":1768675516769,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["c877f824-55c4-481f-aa45-669dce80d894","$2b$12$IIki3ryeetKJklno3wxXdeNG6yS6jsOlztnutY4q.F9V2An3/30RG"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c877f824-55c4-481f-aa45-669dce80d894) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675517529,"env":"test","module":"user-credentials-repository","userId":"555201ea-38d0-442b-a306-4ec4fb589970","msg":"User credentials created"}
{"level":30,"time":1768675517649,"env":"test","module":"email-queue","jobId":"65478303-e3d9-4da1-b87e-7982711067ca","to":"protected-test-p8Ar6xfLaBZfYptUpQsOd@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675517709,"env":"test","module":"auth-routes","userId":"555201ea-38d0-442b-a306-4ec4fb589970","email":"protected-test-p8Ar6xfLaBZfYptUpQsOd@example.com","msg":"User registered"}
{"level":30,"time":1768675518478,"env":"test","module":"user-credentials-repository","userId":"864f40a8-9814-4280-811c-4b154aeffe50","msg":"User credentials created"}
{"level":30,"time":1768675518574,"env":"test","module":"email-queue","jobId":"def7ddf0-c474-4f8b-8846-059468337066","to":"protected-test-3QWEUXUXcVPqyOHIQlWBO@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675518625,"env":"test","module":"auth-routes","userId":"864f40a8-9814-4280-811c-4b154aeffe50","email":"protected-test-3QWEUXUXcVPqyOHIQlWBO@example.com","msg":"User registered"}
{"level":30,"time":1768675519415,"env":"test","module":"user-credentials-repository","userId":"ca2d1616-fc0f-469c-b1c0-801060a62c4c","msg":"User credentials created"}
{"level":30,"time":1768675519535,"env":"test","module":"email-queue","jobId":"5751dc48-33b0-4a6c-a01c-dc7c5561e3b2","to":"protected-test--8yOP1GHvbfvkBX32zEW8@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675519596,"env":"test","module":"auth-routes","userId":"ca2d1616-fc0f-469c-b1c0-801060a62c4c","email":"protected-test--8yOP1GHvbfvkBX32zEW8@example.com","msg":"User registered"}
{"level":50,"time":1768675520382,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["5cd61eb9-e865-4b85-8e05-1630f8984913","$2b$12$l7vHRDeutGpkjYrTdvH9S.uXBg9pDWcFTxo8zAbv14PUd/PUzb9Yq"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5cd61eb9-e865-4b85-8e05-1630f8984913) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"5cd61eb9-e865-4b85-8e05-1630f8984913","msg":"Failed to create user credentials"}
{"level":50,"time":1768675520382,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["5cd61eb9-e865-4b85-8e05-1630f8984913","$2b$12$l7vHRDeutGpkjYrTdvH9S.uXBg9pDWcFTxo8zAbv14PUd/PUzb9Yq"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5cd61eb9-e865-4b85-8e05-1630f8984913) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675521061,"env":"test","module":"user-credentials-repository","userId":"bb25997f-5058-4d2c-af09-f3b9d17453da","msg":"User credentials created"}
{"level":30,"time":1768675521156,"env":"test","module":"email-queue","jobId":"0093e422-ff14-4015-8a18-ec9fe5241b2a","to":"protected-test-juhT7b5ldTW4oZzj3DWWd@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675521205,"env":"test","module":"auth-routes","userId":"bb25997f-5058-4d2c-af09-f3b9d17453da","email":"protected-test-juhT7b5ldTW4oZzj3DWWd@example.com","msg":"User registered"}
{"level":50,"time":1768675521893,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["022b15b3-4f33-4087-9183-68bad2e0c75a","$2b$12$9s8C9tVcGjD36mRdFvz8tOGC4ewrXCjEKs0WX7NUFodFBhf5dSNpu"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(022b15b3-4f33-4087-9183-68bad2e0c75a) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"022b15b3-4f33-4087-9183-68bad2e0c75a","msg":"Failed to create user credentials"}
{"level":50,"time":1768675521893,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["022b15b3-4f33-4087-9183-68bad2e0c75a","$2b$12$9s8C9tVcGjD36mRdFvz8tOGC4ewrXCjEKs0WX7NUFodFBhf5dSNpu"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(022b15b3-4f33-4087-9183-68bad2e0c75a) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675522638,"env":"test","module":"user-credentials-repository","userId":"6e39376f-1946-4c9d-bf04-109123d2de73","msg":"User credentials created"}
{"level":50,"time":1768675522701,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["6e39376f-1946-4c9d-bf04-109123d2de73","3568a90dfc523f063b3c56ee50415711a6200bca3ce71d893a6a627b5d51108e","2026-01-18T18:45:22.638Z"],"cause":{"length":382,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(6e39376f-1946-4c9d-bf04-109123d2de73) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675523453,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["6807c985-601f-46c0-b8e0-b40c0f5bef0e","$2b$12$NNa1lBW7SIyHhSsOhuJQu.EWdtf12gA/qvvcrxLmBIKvJYttXllea"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(6807c985-601f-46c0-b8e0-b40c0f5bef0e) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"6807c985-601f-46c0-b8e0-b40c0f5bef0e","msg":"Failed to create user credentials"}
{"level":50,"time":1768675523453,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["6807c985-601f-46c0-b8e0-b40c0f5bef0e","$2b$12$NNa1lBW7SIyHhSsOhuJQu.EWdtf12gA/qvvcrxLmBIKvJYttXllea"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(6807c985-601f-46c0-b8e0-b40c0f5bef0e) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675524238,"env":"test","module":"user-credentials-repository","userId":"ce09ecb8-c018-4722-a3cd-cc9442ecd842","msg":"User credentials created"}
{"level":30,"time":1768675524362,"env":"test","module":"email-queue","jobId":"1afa4c0e-4be2-45f8-b903-468cd061b6aa","to":"protected-test-E-q-pg1wElKR0QM6caAjl@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768675524417,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["ce09ecb8-c018-4722-a3cd-cc9442ecd842","adbd85a3acf762e7782ffb194c735e7fb8b427c42ae47f5bb211af8b26f1dd89","2026-02-16T18:45:24.362Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T18:45:24.362Z"],"cause":{"length":338,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(ce09ecb8-c018-4722-a3cd-cc9442ecd842) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675525163,"env":"test","module":"user-credentials-repository","userId":"2a4a8c82-1d4f-4fc9-a66e-077b9609f180","msg":"User credentials created"}
{"level":30,"time":1768675525280,"env":"test","module":"email-queue","jobId":"6fdbb023-0d45-4922-ba51-84bd38776909","to":"protected-test-ro92JDcAsnxHp_saYVYhV@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675525334,"env":"test","module":"auth-routes","userId":"2a4a8c82-1d4f-4fc9-a66e-077b9609f180","email":"protected-test-ro92JDcAsnxHp_saYVYhV@example.com","msg":"User registered"}
{"level":30,"time":1768675525873,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768675525873,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 32 failed | 1 skipped) 31574ms
       â”œÃ¹ should allow access with valid Bearer token 1139ms
       â”œÃ¹ should reject access without Authorization header 1020ms
       â”œÃ¹ should reject access with empty Bearer token 1002ms
       â”œÃ¹ should reject access with malformed Authorization header 1038ms
       â”œÃ¹ should reject access with wrong token type 913ms
       â”œÃ¹ should allow POST with valid Bearer token 980ms
       â”œÃ¹ should reject POST without Bearer token 841ms
       â”œÃ¹ should reject POST with invalid token 853ms
       â”œÃ¹ should allow PUT with valid Bearer token 1001ms
       â”œÃ¹ should reject PUT without Bearer token 838ms
       â”œÃ¹ should allow DELETE with valid Bearer token 696ms
       â”œÃ¹ should reject DELETE without Bearer token 654ms
       â”œÃ¹ should allow PATCH with valid Bearer token 743ms
       â”œÃ¹ should reject PATCH without Bearer token 944ms
       â”œÃ¹ should handle Bearer token with extra spaces 650ms
       Î“Ã¥Ã´ should handle token with newlines
       â”œÃ¹ should handle very long invalid token 806ms
       â”œÃ¹ should handle empty Authorization header 971ms
       â”œÃ¹ should handle Authorization header with only Bearer 766ms
       â”œÃ¹ should handle multiple Authorization headers 881ms
       â”œÃ¹ should reject token with SQL injection attempt 1035ms
       â”œÃ¹ should reject token with XSS attempt 757ms
       â”œÃ¹ should reject token with missing userId 658ms
       â”œÃ¹ should reject token with non-existent userId 1058ms
       â”œÃ¹ should not allow user to access another user's resources 841ms
       â”œÃ¹ should inject userId into request context 981ms
       â”œÃ¹ should inject tenantId into request context 732ms
       â”œÃ¹ should inject role into request context 868ms
       â”œÃ¹ should not apply general rate limiting to authenticated requests 644ms
       â”œÃ¹ should handle request with both Bearer token and cookies 807ms
       â”œÃ¹ should prioritize Bearer token over cookie when both present 753ms
       â”œÃ¹ should allow unauthenticated access to optional auth routes 964ms
       â”œÃ¹ should enhance optional auth routes with user context when authenticated 972ms

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 32 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
Error: expected 200 "OK", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:84:14
     82|                 password: testUser.password,
     83|             })
     84|             .expect(200);
       |              ^
     85| 
     86|         userToken = loginRes.body.token;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/32]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: deb53264-9aba-4dc7-892d-b852188f097e,owner,true,df8a0b13-4d1f-4c30-b9bd-109739b9066e
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(deb53264-9aba-4dc7-892d-b852188f097e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/32]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: deb53264-9aba-4dc7-892d-b852188f097e,owner,true,25bf5173-cdc6-43eb-93cc-140d0ca2d5cd
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(deb53264-9aba-4dc7-892d-b852188f097e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/32]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: deb53264-9aba-4dc7-892d-b852188f097e,owner,true,f4cbe3b6-afeb-4d69-81a5-03665c3a140d
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(deb53264-9aba-4dc7-892d-b852188f097e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/32]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
Error: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: c86c4230-7dbb-4f72-bac1-6cc7a5db6437,6dfac80b-b47b-4cda-a0f3-26bda4a85379,admin
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:71:13
     69|         // This fixes the 403 error in "Cross-User Authorization" test
     70|         if (ctx.orgId) {
     71|             await db.insert(organizationMemberships).values({
       |             ^
     72|                 orgId: ctx.orgId,
     73|                 userId: userId,

Caused by: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:71:13

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 378, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(6dfac80b-b47b-4cda-a0f3-26bda4a85379) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/32]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: deb53264-9aba-4dc7-892d-b852188f097e,owner,true,cbf80c2f-b29f-463c-b838-a1c0e484c087
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(deb53264-9aba-4dc7-892d-b852188f097e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/32]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: deb53264-9aba-4dc7-892d-b852188f097e,owner,true,f3ec1074-2c78-4288-9038-c6f0339d4253
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(deb53264-9aba-4dc7-892d-b852188f097e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/32]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: deb53264-9aba-4dc7-892d-b852188f097e,owner,true,6ed4a796-6dc4-48fe-a99a-107159f83b23
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(deb53264-9aba-4dc7-892d-b852188f097e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/32]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: deb53264-9aba-4dc7-892d-b852188f097e,owner,true,d1894e64-b192-4d4d-884a-ad05ac825103
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(deb53264-9aba-4dc7-892d-b852188f097e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/32]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: deb53264-9aba-4dc7-892d-b852188f097e,owner,true,74760594-c2e5-4cf5-a99d-99ffe7b34446
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(deb53264-9aba-4dc7-892d-b852188f097e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/32]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
Error: expected 201 "Created", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:56:14
     54|             .post("/api/auth/register")
     55|             .send(testUser)
     56|             .expect(201);
       |              ^
     57| 
     58|         const userId = registerRes.body.user.id;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/32]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: deb53264-9aba-4dc7-892d-b852188f097e,owner,true,609cd4d1-2279-46d7-896d-99e542367b40
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(deb53264-9aba-4dc7-892d-b852188f097e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[12/32]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: deb53264-9aba-4dc7-892d-b852188f097e,owner,true,7f19b08b-860a-4601-9a39-dd6694871feb
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(deb53264-9aba-4dc7-892d-b852188f097e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[13/32]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
Error: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: c86c4230-7dbb-4f72-bac1-6cc7a5db6437,555201ea-38d0-442b-a306-4ec4fb589970,admin
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:71:13
     69|         // This fixes the 403 error in "Cross-User Authorization" test
     70|         if (ctx.orgId) {
     71|             await db.insert(organizationMemberships).values({
       |             ^
     72|                 orgId: ctx.orgId,
     73|                 userId: userId,

Caused by: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_user_id_users_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:71:13

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 378, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(555201ea-38d0-442b-a306-4ec4fb589970) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[14/32]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: deb53264-9aba-4dc7-892d-b852188f097e,owner,true,864f40a8-9814-4280-811c-4b154aeffe50
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(deb53264-9aba-4dc7-892d-b852188f097e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[15/32]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: deb53264-9aba-4dc7-892d-b852188f097e,owner,true,ca2d1616-fc0f-469c-b1c0-801060a62c4c
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(deb53264-9aba-4dc7-892d-b852188f097e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[16/32]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: deb53264-9aba-4dc7-892d-b852188f097e,owner,true,bb25997f-5058-4d2c-af09-f3b9d17453da
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(deb53264-9aba-4dc7-892d-b852188f097e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[17/32]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: deb53264-9aba-4dc7-892d-b852188f097e,owner,true,2a4a8c82-1d4f-4fc9-a66e-077b9609f180
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(deb53264-9aba-4dc7-892d-b852188f097e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[18/32]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  32 failed | 1 skipped (33)
   Start at  12:44:34
   Duration  47.46s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x3 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768678738858,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768678747039,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768678747090,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
Î“Ã…âŒ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: []

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768678748739,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768678748753,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768678748745,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768678748746,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768678748749,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768678748750,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768678748753,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768678748753,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768678748753,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768678748753,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768678749250,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["9eecf314-94eb-47dc-85d0-27aa8e61fa19","$2b$12$SYx.dEqlx9QeR1qCv3lX2ONYcqSXXr2RkXlGW5G//JKgbPvgoRRHy"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(9eecf314-94eb-47dc-85d0-27aa8e61fa19) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"9eecf314-94eb-47dc-85d0-27aa8e61fa19","msg":"Failed to create user credentials"}
{"level":50,"time":1768678749250,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["9eecf314-94eb-47dc-85d0-27aa8e61fa19","$2b$12$SYx.dEqlx9QeR1qCv3lX2ONYcqSXXr2RkXlGW5G//JKgbPvgoRRHy"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(9eecf314-94eb-47dc-85d0-27aa8e61fa19) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768678749258,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768678749258,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 3050ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiÎ“Ã‡Âª
       |             ^
    115|     }
    116| 
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:38:49
   Duration  17.17s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x4 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768678768946,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768678777627,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768678777666,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:188:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:188:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768678777984,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768678778003,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768678777992,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768678777993,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768678777996,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768678777997,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768678778002,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768678778002,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768678778002,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768678778003,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant OBxbC0kPwlMj3Ki5HpHzJ,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant OBxbC0kPwlMj3Ki5HpHzJ', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768678778387,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768678778387,"env":"test","msg":"DB: pool closed."}

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant OBxbC0kPwlMj3Ki5HpHzJ,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1775ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
     98|       plan: 'pro',
       Î“Ã¥Ã´ should reject access with empty Bearer token
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type

       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

 Test Files  1 failed (1)
      Tests  33 skipped (33)
Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
   Start at  13:39:17
   Duration  17.86s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»

c[3J RERUN  tests/setup.ts x5 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768678787528,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768678840776,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768678840874,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:191:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:191:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768678841261,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768678841284,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768678841272,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768678841273,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768678841278,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768678841278,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768678841283,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768678841283,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768678841284,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768678841284,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant i5Orr2cE-7fpVgdL7RWgZ,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant i5Orr2cE-7fpVgdL7RWgZ', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
{"level":30,"time":1768678841675,"env":"test","msg":"DB: closing pool..."}
    line: undefined,
{"level":30,"time":1768678841675,"env":"test","msg":"DB: pool closed."}
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1879ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant i5Orr2cE-7fpVgdL7RWgZ,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:39:38
   Duration  62.55s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x6 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768679038785,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768679144440,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768679144476,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
Î“Ã…âŒ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768679146216,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768679146231,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768679146223,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768679146223,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768679146226,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768679146227,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768679146230,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768679146230,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768679146231,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768679146231,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768679146783,"env":"test","module":"user-credentials-repository","userId":"e638077f-9ad3-4dc8-8da6-338fff8f7e5d","msg":"User credentials created"}
{"level":30,"time":1768679146958,"env":"test","module":"email-queue","jobId":"49aef1d4-febb-42e0-bc47-7da137a72c49","to":"test-q5DjMAmklRRCsVzl3fJGe@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679147020,"env":"test","module":"auth-routes","userId":"e638077f-9ad3-4dc8-8da6-338fff8f7e5d","email":"test-q5DjMAmklRRCsVzl3fJGe@example.com","msg":"User registered"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: update "users" set "tenant_id" = $1, "role" = $2, "tenant_role" = $3 where "users"."id" = $4
params: 2c076d2e-b4b3-4b43-b0b0-28929abc9232,admin,owner,e638077f-9ad3-4dc8-8da6-338fff8f7e5d
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:121:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'update "users" set "tenant_id" = $1, "role" = $2, "tenant_role" = $3 where "users"."id" = $4',
  params: [
    '2c076d2e-b4b3-4b43-b0b0-28929abc9232',
    'admin',
    'owner',
    'e638077f-9ad3-4dc8-8da6-338fff8f7e5d'
  ],
  cause: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:121:5)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 315,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (tenant_id)=(2c076d2e-b4b3-4b43-b0b0-28929abc9232) is not present in table "tenants".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w32_v3',
    table: 'users',
    column: undefined,
    dataType: undefined,
    constraint: 'users_tenant_id_tenants_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":30,"time":1768679147093,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768679147094,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 3469ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: update "users" set "tenant_id" = $1, "role" = $2, "tenant_role" = $3 where "users"."id" = $4
params: 2c076d2e-b4b3-4b43-b0b0-28929abc9232,admin,owner,e638077f-9ad3-4dc8-8da6-338fff8f7e5d
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:121:5
    119| 
    120|     // Update user with tenant and roles
    121|     await db.update(schema.users)
       |     ^
    122|       .set({
    123|         tenantId,
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:121:5
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(2c076d2e-b4b3-4b43-b0b0-28929abc9232) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w32_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:43:49
   Duration  117.49s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x7 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768679219334,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768679224132,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768679224588,"env":"test","msg":"DB: Set search_path on initial connection: \"test_schema_w0_v3\",public"}
{"level":30,"time":1768679224588,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public"}
{"level":30,"time":1768679230340,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768679231826,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768679231848,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768679231837,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768679231838,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768679231842,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768679231842,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768679231847,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768679231847,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768679231847,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768679231847,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768679232411,"env":"test","module":"user-credentials-repository","userId":"693ed6ba-f5fe-4a0e-8f2a-cebdf3fb798d","msg":"User credentials created"}
{"level":30,"time":1768679232526,"env":"test","module":"email-queue","jobId":"49ea2419-9dd4-424f-a26b-4cef64ef64cc","to":"test-ZUowpST6cf6G3i2-79pQ-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679232586,"env":"test","module":"auth-routes","userId":"693ed6ba-f5fe-4a0e-8f2a-cebdf3fb798d","email":"test-ZUowpST6cf6G3i2-79pQ-@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
Î“Ã…âŒ Schema reused, skipping migrations.

{"level":30,"time":1768679233362,"env":"test","module":"user-credentials-repository","userId":"c97656ec-8f3d-4087-a4ea-7579fd688a78","msg":"User credentials created"}
{"level":30,"time":1768679233472,"env":"test","module":"email-queue","jobId":"583c8258-2945-4b4a-8b93-c77c7a34337f","to":"protected-test-MW785Vh-X98jlCq6TMstH@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679233528,"env":"test","module":"auth-routes","userId":"c97656ec-8f3d-4087-a4ea-7579fd688a78","email":"protected-test-MW785Vh-X98jlCq6TMstH@example.com","msg":"User registered"}
{"level":30,"time":1768679234258,"env":"test","module":"auth-routes","userId":"c97656ec-8f3d-4087-a4ea-7579fd688a78","msg":"User logged in successfully"}
{"level":30,"time":1768679234314,"env":"test","module":"audit-log-service","userId":"c97656ec-8f3d-4087-a4ea-7579fd688a78","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679234855,"env":"test","module":"user-credentials-repository","userId":"bd1afe52-42f4-4ace-ac52-4e8ad4eada1e","msg":"User credentials created"}
{"level":30,"time":1768679234972,"env":"test","module":"email-queue","jobId":"9590d800-7efb-4750-a477-6cf4b4eb54ce","to":"protected-test-oQ07fQ5hBNXkPcBbQk6W2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679235028,"env":"test","module":"auth-routes","userId":"bd1afe52-42f4-4ace-ac52-4e8ad4eada1e","email":"protected-test-oQ07fQ5hBNXkPcBbQk6W2@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Applied failsafe schema fixes

{"level":30,"time":1768679235751,"env":"test","module":"auth-routes","userId":"bd1afe52-42f4-4ace-ac52-4e8ad4eada1e","msg":"User logged in successfully"}
{"level":30,"time":1768679235809,"env":"test","module":"audit-log-service","userId":"bd1afe52-42f4-4ace-ac52-4e8ad4eada1e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679235814,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679236221,"env":"test","module":"user-credentials-repository","userId":"002fc0d0-a707-42a1-8ddd-0c5926f7286d","msg":"User credentials created"}
{"level":30,"time":1768679236334,"env":"test","module":"email-queue","jobId":"5362ac74-cde7-4f94-b692-06063ccb1b00","to":"protected-test-8M7WgAcU5_8vA35lkzSjD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679236389,"env":"test","module":"auth-routes","userId":"002fc0d0-a707-42a1-8ddd-0c5926f7286d","email":"protected-test-8M7WgAcU5_8vA35lkzSjD@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768679237094,"env":"test","module":"auth-routes","userId":"002fc0d0-a707-42a1-8ddd-0c5926f7286d","msg":"User logged in successfully"}
{"level":30,"time":1768679237150,"env":"test","module":"audit-log-service","userId":"002fc0d0-a707-42a1-8ddd-0c5926f7286d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679237154,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679237568,"env":"test","module":"user-credentials-repository","userId":"06376a7e-6598-449f-baee-823b3b59482a","msg":"User credentials created"}
{"level":30,"time":1768679237691,"env":"test","module":"email-queue","jobId":"8afd489b-bd31-42bc-b8de-a691fcbf7010","to":"protected-test-Jt1N2H5LhvdTZDa0-md7N@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679237754,"env":"test","module":"auth-routes","userId":"06376a7e-6598-449f-baee-823b3b59482a","email":"protected-test-Jt1N2H5LhvdTZDa0-md7N@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

{"level":30,"time":1768679238455,"env":"test","module":"auth-routes","userId":"06376a7e-6598-449f-baee-823b3b59482a","msg":"User logged in successfully"}
{"level":30,"time":1768679238516,"env":"test","module":"audit-log-service","userId":"06376a7e-6598-449f-baee-823b3b59482a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679238520,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679238950,"env":"test","module":"user-credentials-repository","userId":"c5a3f29d-d012-42a2-9788-43192b1dab08","msg":"User credentials created"}
{"level":30,"time":1768679239071,"env":"test","module":"email-queue","jobId":"8a0f26fc-90e3-4c5b-b1e6-2eb518af7d1b","to":"protected-test-Fs-AUDJKh-21Y6NJAHMlY@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679239134,"env":"test","module":"auth-routes","userId":"c5a3f29d-d012-42a2-9788-43192b1dab08","email":"protected-test-Fs-AUDJKh-21Y6NJAHMlY@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768679239854,"env":"test","module":"auth-routes","userId":"c5a3f29d-d012-42a2-9788-43192b1dab08","msg":"User logged in successfully"}
{"level":30,"time":1768679239910,"env":"test","module":"audit-log-service","userId":"c5a3f29d-d012-42a2-9788-43192b1dab08","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768679239914,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768679239914,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679240314,"env":"test","module":"user-credentials-repository","userId":"bba684da-f848-4c49-be49-ff2ca9efbf2e","msg":"User credentials created"}
{"level":30,"time":1768679240438,"env":"test","module":"email-queue","jobId":"6041ea2f-66ff-4f27-a833-77a8e530d109","to":"protected-test-eluTmjUvRQqQ3L91O0bWX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679240493,"env":"test","module":"auth-routes","userId":"bba684da-f848-4c49-be49-ff2ca9efbf2e","email":"protected-test-eluTmjUvRQqQ3L91O0bWX@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768679241179,"env":"test","module":"auth-routes","userId":"bba684da-f848-4c49-be49-ff2ca9efbf2e","msg":"User logged in successfully"}
{"level":30,"time":1768679241240,"env":"test","module":"audit-log-service","userId":"bba684da-f848-4c49-be49-ff2ca9efbf2e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679241717,"env":"test","module":"user-credentials-repository","userId":"23aa374b-62df-4b69-88af-c5ba8d4008eb","msg":"User credentials created"}
{"level":30,"time":1768679241834,"env":"test","module":"email-queue","jobId":"c3ad827b-7679-4162-9748-31c779d0dd56","to":"protected-test-LNzmSLZ27xe6E-VtBTpfL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679241889,"env":"test","module":"auth-routes","userId":"23aa374b-62df-4b69-88af-c5ba8d4008eb","email":"protected-test-LNzmSLZ27xe6E-VtBTpfL@example.com","msg":"User registered"}
{"level":30,"time":1768679242598,"env":"test","module":"auth-routes","userId":"23aa374b-62df-4b69-88af-c5ba8d4008eb","msg":"User logged in successfully"}
{"level":30,"time":1768679242655,"env":"test","module":"audit-log-service","userId":"23aa374b-62df-4b69-88af-c5ba8d4008eb","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679242659,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679243052,"env":"test","module":"user-credentials-repository","userId":"93077330-3c60-45cc-82f4-2b88f8dbde63","msg":"User credentials created"}
{"level":30,"time":1768679243166,"env":"test","module":"email-queue","jobId":"f8c0ea87-a2bf-4560-9510-011e35d4afa9","to":"protected-test-CXWPZ8dWXvK3QxX-u2FE0@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679243230,"env":"test","module":"auth-routes","userId":"93077330-3c60-45cc-82f4-2b88f8dbde63","email":"protected-test-CXWPZ8dWXvK3QxX-u2FE0@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679243920,"env":"test","module":"auth-routes","userId":"93077330-3c60-45cc-82f4-2b88f8dbde63","msg":"User logged in successfully"}
{"level":30,"time":1768679243977,"env":"test","module":"audit-log-service","userId":"93077330-3c60-45cc-82f4-2b88f8dbde63","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679243982,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679244391,"env":"test","module":"user-credentials-repository","userId":"55b43c71-bdb7-426d-8d76-f075cd4fb9ae","msg":"User credentials created"}
{"level":30,"time":1768679244503,"env":"test","module":"email-queue","jobId":"49973865-d63e-4d3e-98b9-5b8e72e4e2fc","to":"protected-test-5Ufmt6LRIU1VmaRwT4P1o@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679244558,"env":"test","module":"auth-routes","userId":"55b43c71-bdb7-426d-8d76-f075cd4fb9ae","email":"protected-test-5Ufmt6LRIU1VmaRwT4P1o@example.com","msg":"User registered"}
{"level":30,"time":1768679245244,"env":"test","module":"auth-routes","userId":"55b43c71-bdb7-426d-8d76-f075cd4fb9ae","msg":"User logged in successfully"}
{"level":30,"time":1768679245306,"env":"test","module":"audit-log-service","userId":"55b43c71-bdb7-426d-8d76-f075cd4fb9ae","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[DEBUG] BaseRepository.update users: id=55b43c71-bdb7-426d-8d76-f075cd4fb9ae, updates={"defaultMode":"advanced","updatedAt":"2026-01-17T19:47:25.426Z"}
{"level":30,"time":1768679245883,"env":"test","module":"user-credentials-repository","userId":"8d24279f-6380-41d8-b107-39f9cfde26a3","msg":"User credentials created"}
{"level":30,"time":1768679245994,"env":"test","module":"email-queue","jobId":"46688e7a-194c-4a67-a1c9-9bcc88bc5664","to":"protected-test-tkLjz-E-SmzG70wcmkQV4@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679246051,"env":"test","module":"auth-routes","userId":"8d24279f-6380-41d8-b107-39f9cfde26a3","email":"protected-test-tkLjz-E-SmzG70wcmkQV4@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679246747,"env":"test","module":"auth-routes","userId":"8d24279f-6380-41d8-b107-39f9cfde26a3","msg":"User logged in successfully"}
{"level":30,"time":1768679246803,"env":"test","module":"audit-log-service","userId":"8d24279f-6380-41d8-b107-39f9cfde26a3","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679246809,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679247237,"env":"test","module":"user-credentials-repository","userId":"1c6892ed-4e26-43c8-8404-ed1a4e7b4ae0","msg":"User credentials created"}
{"level":30,"time":1768679247349,"env":"test","module":"email-queue","jobId":"970713c5-00cd-44dd-91c1-ccd1186b85ff","to":"protected-test-5OJHZxQ8_YN0XAqcObAJ5@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679247404,"env":"test","module":"auth-routes","userId":"1c6892ed-4e26-43c8-8404-ed1a4e7b4ae0","email":"protected-test-5OJHZxQ8_YN0XAqcObAJ5@example.com","msg":"User registered"}
{"level":30,"time":1768679248112,"env":"test","module":"auth-routes","userId":"1c6892ed-4e26-43c8-8404-ed1a4e7b4ae0","msg":"User logged in successfully"}
{"level":30,"time":1768679248167,"env":"test","module":"audit-log-service","userId":"1c6892ed-4e26-43c8-8404-ed1a4e7b4ae0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679248757,"env":"test","module":"user-credentials-repository","userId":"8f8bd6b0-c46e-4f12-a130-3f66d6c7c5bb","msg":"User credentials created"}
{"level":30,"time":1768679248870,"env":"test","module":"email-queue","jobId":"4af5c8b3-7ae0-41c2-b569-ddd7a5691095","to":"protected-test-rC9GEjG6qy9aa8LyERCny@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679248929,"env":"test","module":"auth-routes","userId":"8f8bd6b0-c46e-4f12-a130-3f66d6c7c5bb","email":"protected-test-rC9GEjG6qy9aa8LyERCny@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679249626,"env":"test","module":"auth-routes","userId":"8f8bd6b0-c46e-4f12-a130-3f66d6c7c5bb","msg":"User logged in successfully"}
{"level":30,"time":1768679249687,"env":"test","module":"audit-log-service","userId":"8f8bd6b0-c46e-4f12-a130-3f66d6c7c5bb","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679249691,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679250094,"env":"test","module":"user-credentials-repository","userId":"d39d13ca-6e16-4a40-a74a-8febed8d605f","msg":"User credentials created"}
{"level":30,"time":1768679250215,"env":"test","module":"email-queue","jobId":"d33e1f7a-f1f9-47db-aae4-83b2c170f625","to":"protected-test-5pPj0tOtIrX4FiYoTLgFU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679250274,"env":"test","module":"auth-routes","userId":"d39d13ca-6e16-4a40-a74a-8febed8d605f","email":"protected-test-5pPj0tOtIrX4FiYoTLgFU@example.com","msg":"User registered"}
{"level":30,"time":1768679250965,"env":"test","module":"auth-routes","userId":"d39d13ca-6e16-4a40-a74a-8febed8d605f","msg":"User logged in successfully"}
{"level":30,"time":1768679251019,"env":"test","module":"audit-log-service","userId":"d39d13ca-6e16-4a40-a74a-8febed8d605f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679252217,"env":"test","module":"user-credentials-repository","userId":"34b68381-4f50-40bc-8f3c-2a4c61872e14","msg":"User credentials created"}
{"level":30,"time":1768679252333,"env":"test","module":"email-queue","jobId":"294ea45a-bb6f-4f93-b49b-1918afab7a92","to":"protected-test-WC5qJd69NdUBh3YbGjzR7@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679252390,"env":"test","module":"auth-routes","userId":"34b68381-4f50-40bc-8f3c-2a4c61872e14","email":"protected-test-WC5qJd69NdUBh3YbGjzR7@example.com","msg":"User registered"}
{"level":30,"time":1768679253127,"env":"test","module":"auth-routes","userId":"34b68381-4f50-40bc-8f3c-2a4c61872e14","msg":"User logged in successfully"}
{"level":30,"time":1768679253188,"env":"test","module":"audit-log-service","userId":"34b68381-4f50-40bc-8f3c-2a4c61872e14","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679253192,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679253627,"env":"test","module":"user-credentials-repository","userId":"bbdf6ab3-593d-4063-9804-61c54754afff","msg":"User credentials created"}
{"level":30,"time":1768679253763,"env":"test","module":"email-queue","jobId":"aa3db2d1-a157-466f-b595-11ca5feec19e","to":"protected-test-sgmSH8j93Yls2lu_b0aM4@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679253820,"env":"test","module":"auth-routes","userId":"bbdf6ab3-593d-4063-9804-61c54754afff","email":"protected-test-sgmSH8j93Yls2lu_b0aM4@example.com","msg":"User registered"}
{"level":30,"time":1768679254514,"env":"test","module":"auth-routes","userId":"bbdf6ab3-593d-4063-9804-61c54754afff","msg":"User logged in successfully"}
{"level":30,"time":1768679254571,"env":"test","module":"audit-log-service","userId":"bbdf6ab3-593d-4063-9804-61c54754afff","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768679254574,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768679254575,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679254971,"env":"test","module":"user-credentials-repository","userId":"0f4b6a07-8cc5-4b73-8641-a87d240888ef","msg":"User credentials created"}
{"level":30,"time":1768679255086,"env":"test","module":"email-queue","jobId":"a378b641-6e46-4d60-993d-f02c738d6700","to":"protected-test-ezmj6AkWWiN1bR_1Tdud2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679255145,"env":"test","module":"auth-routes","userId":"0f4b6a07-8cc5-4b73-8641-a87d240888ef","email":"protected-test-ezmj6AkWWiN1bR_1Tdud2@example.com","msg":"User registered"}
{"level":30,"time":1768679255829,"env":"test","module":"auth-routes","userId":"0f4b6a07-8cc5-4b73-8641-a87d240888ef","msg":"User logged in successfully"}
{"level":30,"time":1768679255891,"env":"test","module":"audit-log-service","userId":"0f4b6a07-8cc5-4b73-8641-a87d240888ef","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679255895,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679256295,"env":"test","module":"user-credentials-repository","userId":"2efdbd0f-e463-46f0-a0fa-60123fbb502c","msg":"User credentials created"}
{"level":30,"time":1768679256416,"env":"test","module":"email-queue","jobId":"72df3fbd-2fa8-4447-8b3e-1f0c31c816c7","to":"protected-test-sdkItx6_jIwEDQhbJ1p5T@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679256474,"env":"test","module":"auth-routes","userId":"2efdbd0f-e463-46f0-a0fa-60123fbb502c","email":"protected-test-sdkItx6_jIwEDQhbJ1p5T@example.com","msg":"User registered"}
{"level":30,"time":1768679257171,"env":"test","module":"auth-routes","userId":"2efdbd0f-e463-46f0-a0fa-60123fbb502c","msg":"User logged in successfully"}
{"level":30,"time":1768679257226,"env":"test","module":"audit-log-service","userId":"2efdbd0f-e463-46f0-a0fa-60123fbb502c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679257229,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679257628,"env":"test","module":"user-credentials-repository","userId":"68d31e63-652a-4817-8532-2e0b73cf7215","msg":"User credentials created"}
{"level":30,"time":1768679257743,"env":"test","module":"email-queue","jobId":"a412d8bd-4161-4a53-a702-f23259115511","to":"protected-test-q56zR3HrFEK6mF_S6gumD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679257800,"env":"test","module":"auth-routes","userId":"68d31e63-652a-4817-8532-2e0b73cf7215","email":"protected-test-q56zR3HrFEK6mF_S6gumD@example.com","msg":"User registered"}
{"level":30,"time":1768679258487,"env":"test","module":"auth-routes","userId":"68d31e63-652a-4817-8532-2e0b73cf7215","msg":"User logged in successfully"}
{"level":30,"time":1768679258542,"env":"test","module":"audit-log-service","userId":"68d31e63-652a-4817-8532-2e0b73cf7215","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679258545,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679258949,"env":"test","module":"user-credentials-repository","userId":"eb39018a-13cb-4295-b213-7b9dad4f449b","msg":"User credentials created"}
{"level":30,"time":1768679259061,"env":"test","module":"email-queue","jobId":"92b22ad1-b21a-441f-bdab-d910eb3330fa","to":"protected-test-95-VPUBza2N8DuqvP88O_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679259118,"env":"test","module":"auth-routes","userId":"eb39018a-13cb-4295-b213-7b9dad4f449b","email":"protected-test-95-VPUBza2N8DuqvP88O_@example.com","msg":"User registered"}
{"level":30,"time":1768679259802,"env":"test","module":"auth-routes","userId":"eb39018a-13cb-4295-b213-7b9dad4f449b","msg":"User logged in successfully"}
{"level":30,"time":1768679259861,"env":"test","module":"audit-log-service","userId":"eb39018a-13cb-4295-b213-7b9dad4f449b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679259864,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679260305,"env":"test","module":"user-credentials-repository","userId":"cdfc3d02-7874-40e4-984c-7474157fed70","msg":"User credentials created"}
{"level":30,"time":1768679260419,"env":"test","module":"email-queue","jobId":"a5225aa4-6272-4e82-82b2-381a101177c8","to":"protected-test-fB_qFm5h4nzik7MSApYBR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679260478,"env":"test","module":"auth-routes","userId":"cdfc3d02-7874-40e4-984c-7474157fed70","email":"protected-test-fB_qFm5h4nzik7MSApYBR@example.com","msg":"User registered"}
{"level":30,"time":1768679261184,"env":"test","module":"auth-routes","userId":"cdfc3d02-7874-40e4-984c-7474157fed70","msg":"User logged in successfully"}
{"level":30,"time":1768679261239,"env":"test","module":"audit-log-service","userId":"cdfc3d02-7874-40e4-984c-7474157fed70","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679261242,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679261641,"env":"test","module":"user-credentials-repository","userId":"cf1fe1ed-4d8f-4256-a4da-fcaac1a6ade0","msg":"User credentials created"}
{"level":30,"time":1768679261751,"env":"test","module":"email-queue","jobId":"44b21e91-706c-415e-87af-c0f8ef6055c2","to":"protected-test-JMAV-ukdUMyW_y5yLeI_Q@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679261809,"env":"test","module":"auth-routes","userId":"cf1fe1ed-4d8f-4256-a4da-fcaac1a6ade0","email":"protected-test-JMAV-ukdUMyW_y5yLeI_Q@example.com","msg":"User registered"}
{"level":30,"time":1768679262520,"env":"test","module":"auth-routes","userId":"cf1fe1ed-4d8f-4256-a4da-fcaac1a6ade0","msg":"User logged in successfully"}
{"level":30,"time":1768679262578,"env":"test","module":"audit-log-service","userId":"cf1fe1ed-4d8f-4256-a4da-fcaac1a6ade0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679262582,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679262981,"env":"test","module":"user-credentials-repository","userId":"2384c87d-d4bc-4ce5-8c66-24d6a5ce083a","msg":"User credentials created"}
{"level":30,"time":1768679263103,"env":"test","module":"email-queue","jobId":"2e85e7df-634f-421c-a2e5-b1882fcb6816","to":"protected-test-LqEKUamDEcPECH1GTx7P9@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679263161,"env":"test","module":"auth-routes","userId":"2384c87d-d4bc-4ce5-8c66-24d6a5ce083a","email":"protected-test-LqEKUamDEcPECH1GTx7P9@example.com","msg":"User registered"}
{"level":30,"time":1768679263830,"env":"test","module":"auth-routes","userId":"2384c87d-d4bc-4ce5-8c66-24d6a5ce083a","msg":"User logged in successfully"}
{"level":30,"time":1768679263885,"env":"test","module":"audit-log-service","userId":"2384c87d-d4bc-4ce5-8c66-24d6a5ce083a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679264292,"env":"test","module":"user-credentials-repository","userId":"0b9c7b93-a4c7-4896-9a46-7dcd8aac8c87","msg":"User credentials created"}
{"level":30,"time":1768679264411,"env":"test","module":"email-queue","jobId":"a88ef862-3dcd-4a1f-89c4-1f4182a40508","to":"protected-test-nWGIgC7M6B-WEAisSZdof@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679264468,"env":"test","module":"auth-routes","userId":"0b9c7b93-a4c7-4896-9a46-7dcd8aac8c87","email":"protected-test-nWGIgC7M6B-WEAisSZdof@example.com","msg":"User registered"}
{"level":30,"time":1768679265149,"env":"test","module":"auth-routes","userId":"0b9c7b93-a4c7-4896-9a46-7dcd8aac8c87","msg":"User logged in successfully"}
{"level":30,"time":1768679265205,"env":"test","module":"audit-log-service","userId":"0b9c7b93-a4c7-4896-9a46-7dcd8aac8c87","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679265729,"env":"test","module":"user-credentials-repository","userId":"fe667048-31bb-4353-91c2-addac794c3fc","msg":"User credentials created"}
{"level":30,"time":1768679265838,"env":"test","module":"email-queue","jobId":"50f0c343-8576-4ce8-a673-a6f0b7b2394d","to":"protected-test-gcZq8tOCmGKA2di1t5IHS@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679265893,"env":"test","module":"auth-routes","userId":"fe667048-31bb-4353-91c2-addac794c3fc","email":"protected-test-gcZq8tOCmGKA2di1t5IHS@example.com","msg":"User registered"}
{"level":30,"time":1768679266578,"env":"test","module":"auth-routes","userId":"fe667048-31bb-4353-91c2-addac794c3fc","msg":"User logged in successfully"}
{"level":30,"time":1768679266645,"env":"test","module":"audit-log-service","userId":"fe667048-31bb-4353-91c2-addac794c3fc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679267049,"env":"test","module":"user-credentials-repository","userId":"91b8fd01-6739-4bdb-9972-27b2061df70b","msg":"User credentials created"}
{"level":30,"time":1768679267168,"env":"test","module":"email-queue","jobId":"cc44616f-4909-4df6-9e4a-af606742c110","to":"user2-KJ10-U7GxCo2R2OpEZyuI@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679267222,"env":"test","module":"auth-routes","userId":"91b8fd01-6739-4bdb-9972-27b2061df70b","email":"user2-KJ10-U7GxCo2R2OpEZyuI@example.com","msg":"User registered"}
{"level":30,"time":1768679267860,"env":"test","module":"auth-routes","userId":"91b8fd01-6739-4bdb-9972-27b2061df70b","msg":"User logged in successfully"}
{"level":30,"time":1768679267919,"env":"test","module":"audit-log-service","userId":"91b8fd01-6739-4bdb-9972-27b2061df70b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768679267981,"env":"test","module":"rbac-middleware","userId":"91b8fd01-6739-4bdb-9972-27b2061df70b","userRole":"viewer","permission":"project:delete","path":"/13431741-b003-4933-8731-3a8e4ffc6459","msg":"Permission denied"}
{"level":30,"time":1768679268389,"env":"test","module":"user-credentials-repository","userId":"913a1795-6548-47b3-bba5-b8ecff2ab56a","msg":"User credentials created"}
{"level":30,"time":1768679268500,"env":"test","module":"email-queue","jobId":"3d5ec4a4-6ad9-40dc-bff2-34c6993dfe07","to":"protected-test-ghRbMoYEw0aMoxZaivnla@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679268557,"env":"test","module":"auth-routes","userId":"913a1795-6548-47b3-bba5-b8ecff2ab56a","email":"protected-test-ghRbMoYEw0aMoxZaivnla@example.com","msg":"User registered"}
{"level":30,"time":1768679269251,"env":"test","module":"auth-routes","userId":"913a1795-6548-47b3-bba5-b8ecff2ab56a","msg":"User logged in successfully"}
{"level":30,"time":1768679269309,"env":"test","module":"audit-log-service","userId":"913a1795-6548-47b3-bba5-b8ecff2ab56a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679269812,"env":"test","module":"user-credentials-repository","userId":"b792e425-0222-4d55-be5f-f27d4f1fcdd3","msg":"User credentials created"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679269937,"env":"test","module":"email-queue","jobId":"40c0c3ae-5205-4d43-b585-aabd228c0f59","to":"protected-test-3mL3tJJpsxHoHRQSn8b3U@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679270004,"env":"test","module":"auth-routes","userId":"b792e425-0222-4d55-be5f-f27d4f1fcdd3","email":"protected-test-3mL3tJJpsxHoHRQSn8b3U@example.com","msg":"User registered"}
{"level":30,"time":1768679270717,"env":"test","module":"auth-routes","userId":"b792e425-0222-4d55-be5f-f27d4f1fcdd3","msg":"User logged in successfully"}
{"level":30,"time":1768679270772,"env":"test","module":"audit-log-service","userId":"b792e425-0222-4d55-be5f-f27d4f1fcdd3","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679271246,"env":"test","module":"user-credentials-repository","userId":"19fc1bd8-125f-425a-a47e-ee2a82777a3c","msg":"User credentials created"}
{"level":30,"time":1768679271361,"env":"test","module":"email-queue","jobId":"cbf818d0-9899-4865-aa27-442a89c8e23b","to":"protected-test-DFVGE7_yyuEvhfGryWPrx@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679271424,"env":"test","module":"auth-routes","userId":"19fc1bd8-125f-425a-a47e-ee2a82777a3c","email":"protected-test-DFVGE7_yyuEvhfGryWPrx@example.com","msg":"User registered"}
{"level":30,"time":1768679272243,"env":"test","module":"auth-routes","userId":"19fc1bd8-125f-425a-a47e-ee2a82777a3c","msg":"User logged in successfully"}
{"level":30,"time":1768679272299,"env":"test","module":"audit-log-service","userId":"19fc1bd8-125f-425a-a47e-ee2a82777a3c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679272839,"env":"test","module":"user-credentials-repository","userId":"f709eaed-111d-42ba-9348-2dc6f76f62c1","msg":"User credentials created"}
{"level":30,"time":1768679272963,"env":"test","module":"email-queue","jobId":"2b58a8a7-399a-4ee2-b683-258eb443dfad","to":"protected-test-TBzfTp_mA_ZHEOfEchbkY@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679273020,"env":"test","module":"auth-routes","userId":"f709eaed-111d-42ba-9348-2dc6f76f62c1","email":"protected-test-TBzfTp_mA_ZHEOfEchbkY@example.com","msg":"User registered"}
{"level":30,"time":1768679273844,"env":"test","module":"auth-routes","userId":"f709eaed-111d-42ba-9348-2dc6f76f62c1","msg":"User logged in successfully"}
{"level":30,"time":1768679273899,"env":"test","module":"audit-log-service","userId":"f709eaed-111d-42ba-9348-2dc6f76f62c1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679274994,"env":"test","module":"user-credentials-repository","userId":"c6854d4b-e323-451b-b670-df7ed454c5b1","msg":"User credentials created"}
{"level":30,"time":1768679275106,"env":"test","module":"email-queue","jobId":"ddaade2d-30ae-4003-8a72-e67753e4cad4","to":"protected-test-LKD-HZimPLbdpbxvrkVe2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679275162,"env":"test","module":"auth-routes","userId":"c6854d4b-e323-451b-b670-df7ed454c5b1","email":"protected-test-LKD-HZimPLbdpbxvrkVe2@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679275859,"env":"test","module":"auth-routes","userId":"c6854d4b-e323-451b-b670-df7ed454c5b1","msg":"User logged in successfully"}
{"level":30,"time":1768679275914,"env":"test","module":"audit-log-service","userId":"c6854d4b-e323-451b-b670-df7ed454c5b1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679276558,"env":"test","module":"auth-routes","userId":"c6854d4b-e323-451b-b670-df7ed454c5b1","msg":"User logged in successfully"}
{"level":30,"time":1768679276617,"env":"test","module":"audit-log-service","userId":"c6854d4b-e323-451b-b670-df7ed454c5b1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679277166,"env":"test","module":"user-credentials-repository","userId":"c33cabd2-bb7e-489d-98ee-44d2e724666a","msg":"User credentials created"}
{"level":30,"time":1768679277285,"env":"test","module":"email-queue","jobId":"821cc0a2-26c3-4656-ac55-ceebd740bf32","to":"protected-test-Utql87f_Yf7MN8tOzgdlN@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679277348,"env":"test","module":"auth-routes","userId":"c33cabd2-bb7e-489d-98ee-44d2e724666a","email":"protected-test-Utql87f_Yf7MN8tOzgdlN@example.com","msg":"User registered"}
{"level":30,"time":1768679278068,"env":"test","module":"auth-routes","userId":"c33cabd2-bb7e-489d-98ee-44d2e724666a","msg":"User logged in successfully"}
{"level":30,"time":1768679278129,"env":"test","module":"audit-log-service","userId":"c33cabd2-bb7e-489d-98ee-44d2e724666a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679278813,"env":"test","module":"auth-routes","userId":"c33cabd2-bb7e-489d-98ee-44d2e724666a","msg":"User logged in successfully"}
{"level":30,"time":1768679278871,"env":"test","module":"audit-log-service","userId":"c33cabd2-bb7e-489d-98ee-44d2e724666a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679279306,"env":"test","module":"user-credentials-repository","userId":"b4d6e8e4-15c0-4f40-82e0-202c6e1bab47","msg":"User credentials created"}
{"level":30,"time":1768679279425,"env":"test","module":"email-queue","jobId":"62247f25-417b-4c8c-80b0-d708b087ed33","to":"user2-DAmMWTesAFaLdOzQ78-Pq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679279485,"env":"test","module":"auth-routes","userId":"b4d6e8e4-15c0-4f40-82e0-202c6e1bab47","email":"user2-DAmMWTesAFaLdOzQ78-Pq@example.com","msg":"User registered"}
{"level":50,"time":1768679280326,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["b4d6e8e4-15c0-4f40-82e0-202c6e1bab47","f9d8775df68c3cea5713236e5707549e64bac95b9413594a8289841f05c927f9","2026-02-16T19:48:00.236Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T19:48:00.236Z"],"cause":{"length":338,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b4d6e8e4-15c0-4f40-82e0-202c6e1bab47) is not present in table \"users\".","schema":"test_schema_w1_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
{"level":50,"time":1768679280765,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["622752fd-eff1-4cc6-ae5c-5bfc361dbfbb","$2b$12$413youRTJsRUaq09grhhTOSil2XFw49BRmyaxkFjXTRIM/CH0iEhm"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(622752fd-eff1-4cc6-ae5c-5bfc361dbfbb) is not present in table \"users\".","schema":"test_schema_w1_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"622752fd-eff1-4cc6-ae5c-5bfc361dbfbb","msg":"Failed to create user credentials"}
{"level":50,"time":1768679280765,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["622752fd-eff1-4cc6-ae5c-5bfc361dbfbb","$2b$12$413youRTJsRUaq09grhhTOSil2XFw49BRmyaxkFjXTRIM/CH0iEhm"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(622752fd-eff1-4cc6-ae5c-5bfc361dbfbb) is not present in table \"users\".","schema":"test_schema_w1_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768679281244,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b9e0489d-e537-4f81-b0cc-b50a37a3ad49","$2b$12$MZHCuZgeGRWW.kG691OU2.JXPPWvTeKGYVXeFjp2cMQqlllTgXnYO"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b9e0489d-e537-4f81-b0cc-b50a37a3ad49) is not present in table \"users\".","schema":"test_schema_w1_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"b9e0489d-e537-4f81-b0cc-b50a37a3ad49","msg":"Failed to create user credentials"}
{"level":50,"time":1768679281244,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b9e0489d-e537-4f81-b0cc-b50a37a3ad49","$2b$12$MZHCuZgeGRWW.kG691OU2.JXPPWvTeKGYVXeFjp2cMQqlllTgXnYO"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b9e0489d-e537-4f81-b0cc-b50a37a3ad49) is not present in table \"users\".","schema":"test_schema_w1_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768679281386,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768679281387,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: b4d6e8e4-15c0-4f40-82e0-202c6e1bab47,f9d8775df68c3cea5713236e5707549e64bac95b9413594a8289841f05c927f9,2026-02-16T19:48:00.236Z,false,{"ip":"::1"},,::1,Location Unknown,2026-01-17T19:48:00.236Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
  query: 'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)',
  params: [
    'b4d6e8e4-15c0-4f40-82e0-202c6e1bab47',
    'f9d8775df68c3cea5713236e5707549e64bac95b9413594a8289841f05c927f9',
    '2026-02-16T19:48:00.236Z',
    false,
    '{"ip":"::1"}',
    null,
    '::1',
    'Location Unknown',
    '2026-01-17T19:48:00.236Z'
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
    length: 338,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(b4d6e8e4-15c0-4f40-82e0-202c6e1bab47) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w1_v3',
    table: 'refresh_tokens',
    column: undefined,
    dataType: undefined,
    constraint: 'refresh_tokens_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Cleanup error: DrizzleQueryError: Failed query: delete from "tenants" where "tenants"."id" = $1
params: 145a7b57-5843-4f2b-ab09-e326609e8c19
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at Object.cleanup (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:173:11)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:41:9 {
  query: 'delete from "tenants" where "tenants"."id" = $1',
  params: [ '145a7b57-5843-4f2b-ab09-e326609e8c19' ],
  cause: error: update or delete on table "users" violates foreign key constraint "audit_logs_user_id_users_id_fk" on table "audit_logs"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at Object.cleanup (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:173:11)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:41:9 {
    length: 346,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (id)=(c5a3f29d-d012-42a2-9788-43192b1dab08) is still referenced from table "audit_logs".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w0_v3',
    table: 'audit_logs',
    column: undefined,
    dataType: undefined,
    constraint: 'audit_logs_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2612',
    routine: 'ri_ReportViolation'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 3 failed | 1 skipped) 58183ms
       Î“Â£Ã´ should allow access with valid Bearer token  1492ms
       Î“Â£Ã´ should reject access without Authorization header  1430ms
       Î“Â£Ã´ should reject access with empty Bearer token  1339ms
       Î“Â£Ã´ should reject access with malformed Authorization header  1368ms
       Î“Â£Ã´ should reject access with wrong token type  1392ms
       Î“Â£Ã´ should allow POST with valid Bearer token  1387ms
       Î“Â£Ã´ should reject POST without Bearer token  1358ms
       Î“Â£Ã´ should reject POST with invalid token  1323ms
       Î“Â£Ã´ should allow PUT with valid Bearer token  1502ms
       Î“Â£Ã´ should reject PUT without Bearer token  1325ms
       Î“Â£Ã´ should allow DELETE with valid Bearer token  1532ms
       Î“Â£Ã´ should reject DELETE without Bearer token  1349ms
       Î“Â£Ã´ should allow PATCH with valid Bearer token  2108ms
       Î“Â£Ã´ should reject PATCH without Bearer token  1393ms
       Î“Â£Ã´ should handle Bearer token with extra spaces  1382ms
       Î“Ã¥Ã´ should handle token with newlines
       Î“Â£Ã´ should handle very long invalid token  1321ms
       Î“Â£Ã´ should handle empty Authorization header  1335ms
       Î“Â£Ã´ should handle Authorization header with only Bearer  1315ms
       Î“Â£Ã´ should handle multiple Authorization headers  1321ms
       Î“Â£Ã´ should reject token with SQL injection attempt  1377ms
       Î“Â£Ã´ should reject token with XSS attempt  1340ms
       Î“Â£Ã´ should reject token with missing userId  1309ms
       Î“Â£Ã´ should reject token with non-existent userId  1436ms
       Î“Â£Ã´ should not allow user to access another user's resources  2655ms
       Î“Â£Ã´ should inject userId into request context  1395ms
       Î“Â£Ã´ should inject tenantId into request context  1455ms
       Î“Â£Ã´ should inject role into request context  1534ms
       Î“Â£Ã´ should not apply general rate limiting to authenticated requests  2070ms
       Î“Â£Ã´ should handle request with both Bearer token and cookies  2265ms
       â”œÃ¹ should prioritize Bearer token over cookie when both present 3640ms
       â”œÃ¹ should allow unauthenticated access to optional auth routes 425ms
       â”œÃ¹ should enhance optional auth routes with user context when authenticated 479ms

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 3 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
Error: expected 200 "OK", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:472:18
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/3]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Error: expected 201 "Created", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:56:14
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/3]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  3 failed | 29 passed | 1 skipped (33)
   Start at  13:46:49
   Duration  71.13s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x8 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768679499448,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768679502090,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768679502090,"env":"test","msg":"DB: Using test schema \"test_schema_w0_v3\" (from connection string options)"}
{"level":30,"time":1768679502135,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
Î“Ã…âŒ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768679503671,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768679503687,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768679503678,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768679503679,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768679503683,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768679503683,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768679503687,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768679503687,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768679503687,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768679503687,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768679504195,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["5af6e717-fd5a-457e-b814-1cac6f40ac18","$2b$12$JF6/5H83gw/a4.on0qSuyecufrW7ZLaVRCoYmIf.STLikdvaAGFji"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5af6e717-fd5a-457e-b814-1cac6f40ac18) is not present in table \"users\".","schema":"test_schema_w139_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"5af6e717-fd5a-457e-b814-1cac6f40ac18","msg":"Failed to create user credentials"}
{"level":50,"time":1768679504195,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["5af6e717-fd5a-457e-b814-1cac6f40ac18","$2b$12$JF6/5H83gw/a4.on0qSuyecufrW7ZLaVRCoYmIf.STLikdvaAGFji"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5af6e717-fd5a-457e-b814-1cac6f40ac18) is not present in table \"users\".","schema":"test_schema_w139_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768679504205,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768679504205,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 3134ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiÎ“Ã‡Âª
       |             ^
    115|     }
    116| 
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:51:33
   Duration  9.93s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x9 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768679566738,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768679593398,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768679593399,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w0_v3\",public on all connections"}
{"level":30,"time":1768679593439,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768679892582,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 600008ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
Error: Hook timed out in 300000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Î“Â¥Â» tests/setup.ts:114:1
    112| 
    113| // Global test hooks
    114| beforeAll(async () => {
       | ^
    115|   // Conditionally load jest-dom for UI tests (JSDOM environment)
    116|   if (typeof window !== 'undefined') {

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
Error: Hook timed out in 300000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Î“Â¥Â» tests/setup.ts:334:1
    332| });
    333| 
    334| afterAll(async () => {
       | ^
    335|   // Cleanup test database
    336|   console.log("â‰¡Æ’Âºâ•£ Cleaning up test environment...");

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:52:34
   Duration  634.81s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/helpers/schemaManager.ts x10 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768680389579,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768680394149,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768680394150,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w0_v3\",public on all connections"}
{"level":30,"time":1768680394204,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768680693104,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 600024ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
Error: Hook timed out in 300000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Î“Â¥Â» tests/setup.ts:114:1
    112| 
    113| // Global test hooks
    114| beforeAll(async () => {
       | ^
    115|   // Conditionally load jest-dom for UI tests (JSDOM environment)
    116|   if (typeof window !== 'undefined') {

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
Error: Hook timed out in 300000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Î“Â¥Â» tests/setup.ts:334:1
    332| });
    333| 
    334| afterAll(async () => {
       | ^
    335|   // Cleanup test database
    336|   console.log("â‰¡Æ’Âºâ•£ Cleaning up test environment...");

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:06:21
   Duration  611.30s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x11 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681267380,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681274204,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681274204,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w0_v3\",public on all connections"}
{"level":30,"time":1768681274290,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
Î“Ã…âŒ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681276213,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681276233,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768681276222,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681276223,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681276228,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681276228,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681276233,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681276233,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681276233,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681276233,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768681276805,"env":"test","module":"user-credentials-repository","userId":"3acfb7f3-65eb-49b8-90a3-7610f06e72e8","msg":"User credentials created"}
{"level":30,"time":1768681276922,"env":"test","module":"email-queue","jobId":"064d356c-373f-472d-8eef-765d01bd1622","to":"test-1NkQlScbVOYig7O0DWDTG@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681276987,"env":"test","module":"auth-routes","userId":"3acfb7f3-65eb-49b8-90a3-7610f06e72e8","email":"test-1NkQlScbVOYig7O0DWDTG@example.com","msg":"User registered"}
{"level":30,"time":1768681277770,"env":"test","module":"user-credentials-repository","userId":"97bf8385-2894-4d9e-9481-649ab3382955","msg":"User credentials created"}
{"level":30,"time":1768681277897,"env":"test","module":"email-queue","jobId":"affff866-08a4-4941-a011-c5b729272c18","to":"protected-test-wLYOm4RWYtdW6xmKLcNmp@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681277954,"env":"test","module":"auth-routes","userId":"97bf8385-2894-4d9e-9481-649ab3382955","email":"protected-test-wLYOm4RWYtdW6xmKLcNmp@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681278140,"env":"test","module":"auth-routes","email":"protected-test-wLYOm4RWYtdW6xmKLcNmp@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768681278263,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768681278697,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["1e724f97-56f7-4fd8-92d7-c7ef8594ead8","$2b$12$daIOswTfh0LMLgoyXbd/cedd0CVpPClhIWyk7h/TWALaB1jZ93I5y"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(1e724f97-56f7-4fd8-92d7-c7ef8594ead8) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"1e724f97-56f7-4fd8-92d7-c7ef8594ead8","msg":"Failed to create user credentials"}
{"level":50,"time":1768681278697,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["1e724f97-56f7-4fd8-92d7-c7ef8594ead8","$2b$12$daIOswTfh0LMLgoyXbd/cedd0CVpPClhIWyk7h/TWALaB1jZ93I5y"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(1e724f97-56f7-4fd8-92d7-c7ef8594ead8) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681279542,"env":"test","module":"user-credentials-repository","userId":"82ba4f32-2560-4f4d-8eef-64a8b57c24b5","msg":"User credentials created"}
{"level":30,"time":1768681279657,"env":"test","module":"email-queue","jobId":"443639aa-cdfd-47b2-bf36-586f770e9e38","to":"protected-test-gkVvBHHXFpg8nz169VWh1@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681279719,"env":"test","module":"auth-routes","userId":"82ba4f32-2560-4f4d-8eef-64a8b57c24b5","email":"protected-test-gkVvBHHXFpg8nz169VWh1@example.com","msg":"User registered"}
{"level":30,"time":1768681280640,"env":"test","module":"user-credentials-repository","userId":"bfc8e8c9-6811-4a40-91c5-483f7c56d0c2","msg":"User credentials created"}
{"level":30,"time":1768681280734,"env":"test","module":"email-queue","jobId":"87a510e1-afa5-47b2-b751-0b5b8ff09f90","to":"protected-test-B1B_ybOGqql4ukbuUtr0Q@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681280778,"env":"test","module":"auth-routes","userId":"bfc8e8c9-6811-4a40-91c5-483f7c56d0c2","email":"protected-test-B1B_ybOGqql4ukbuUtr0Q@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681281418,"env":"test","module":"auth-routes","userId":"bfc8e8c9-6811-4a40-91c5-483f7c56d0c2","msg":"User logged in successfully"}
{"level":30,"time":1768681281468,"env":"test","module":"audit-log-service","userId":"bfc8e8c9-6811-4a40-91c5-483f7c56d0c2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681281475,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681281890,"env":"test","module":"user-credentials-repository","userId":"4e0fcabd-db39-4185-aa01-032edd40b9a1","msg":"User credentials created"}
{"level":30,"time":1768681281983,"env":"test","module":"email-queue","jobId":"0de71e0c-4410-477d-8b65-8f8ea1e398a9","to":"protected-test-KstKmssoa3xaP8ytpa_OO@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681282029,"env":"test","module":"auth-routes","userId":"4e0fcabd-db39-4185-aa01-032edd40b9a1","email":"protected-test-KstKmssoa3xaP8ytpa_OO@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681282681,"env":"test","module":"auth-routes","userId":"4e0fcabd-db39-4185-aa01-032edd40b9a1","msg":"User logged in successfully"}
{"level":30,"time":1768681282726,"env":"test","module":"audit-log-service","userId":"4e0fcabd-db39-4185-aa01-032edd40b9a1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681282732,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768681282732,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681283157,"env":"test","module":"user-credentials-repository","userId":"547e3739-c3da-4313-bf31-2e1f0229bd11","msg":"User credentials created"}
{"level":30,"time":1768681283249,"env":"test","module":"email-queue","jobId":"44da9b36-1255-493b-9779-fb7ed52f4550","to":"protected-test-2CwlnNzLJB7xpHazmNnPr@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681283294,"env":"test","module":"auth-routes","userId":"547e3739-c3da-4313-bf31-2e1f0229bd11","email":"protected-test-2CwlnNzLJB7xpHazmNnPr@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681283928,"env":"test","module":"auth-routes","userId":"547e3739-c3da-4313-bf31-2e1f0229bd11","msg":"User logged in successfully"}
{"level":30,"time":1768681283973,"env":"test","module":"audit-log-service","userId":"547e3739-c3da-4313-bf31-2e1f0229bd11","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681284486,"env":"test","module":"user-credentials-repository","userId":"94c51155-f4b8-4ec7-b458-3f21675c82a0","msg":"User credentials created"}
{"level":30,"time":1768681284574,"env":"test","module":"email-queue","jobId":"ee77fc66-dd00-4a40-9dd0-89c34b27043a","to":"protected-test-u_ZPgWWmFApSBl3RtvoK3@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681284620,"env":"test","module":"auth-routes","userId":"94c51155-f4b8-4ec7-b458-3f21675c82a0","email":"protected-test-u_ZPgWWmFApSBl3RtvoK3@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681285261,"env":"test","module":"auth-routes","userId":"94c51155-f4b8-4ec7-b458-3f21675c82a0","msg":"User logged in successfully"}
{"level":30,"time":1768681285309,"env":"test","module":"audit-log-service","userId":"94c51155-f4b8-4ec7-b458-3f21675c82a0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681285313,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681285810,"env":"test","module":"user-credentials-repository","userId":"5994b1ed-776f-44ad-a974-694623b67733","msg":"User credentials created"}
{"level":30,"time":1768681285909,"env":"test","module":"email-queue","jobId":"3e161928-a600-47bc-aa04-896107c5240b","to":"protected-test-c0BM2ZDOv6oBGX7HjsQkq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681285958,"env":"test","module":"auth-routes","userId":"5994b1ed-776f-44ad-a974-694623b67733","email":"protected-test-c0BM2ZDOv6oBGX7HjsQkq@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681286565,"env":"test","module":"auth-routes","userId":"5994b1ed-776f-44ad-a974-694623b67733","msg":"User logged in successfully"}
{"level":30,"time":1768681286609,"env":"test","module":"audit-log-service","userId":"5994b1ed-776f-44ad-a974-694623b67733","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681286614,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681287034,"env":"test","module":"user-credentials-repository","userId":"96e403d0-b6e0-46de-898c-f1cf0ac427b2","msg":"User credentials created"}
{"level":30,"time":1768681287128,"env":"test","module":"email-queue","jobId":"36318d02-b20d-40cf-8766-bfd8c5b43d5e","to":"protected-test-za0zC6taUg86yzCYDfd9u@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681287175,"env":"test","module":"auth-routes","userId":"96e403d0-b6e0-46de-898c-f1cf0ac427b2","email":"protected-test-za0zC6taUg86yzCYDfd9u@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681287863,"env":"test","module":"auth-routes","userId":"96e403d0-b6e0-46de-898c-f1cf0ac427b2","msg":"User logged in successfully"}
{"level":30,"time":1768681287914,"env":"test","module":"audit-log-service","userId":"96e403d0-b6e0-46de-898c-f1cf0ac427b2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[DEBUG] BaseRepository.update users: id=96e403d0-b6e0-46de-898c-f1cf0ac427b2, updates={"defaultMode":"advanced","updatedAt":"2026-01-17T20:21:28.015Z"}
{"level":30,"time":1768681288466,"env":"test","module":"user-credentials-repository","userId":"6c2a1f31-7d71-4e98-aa24-a973e8a2608d","msg":"User credentials created"}
{"level":30,"time":1768681288567,"env":"test","module":"email-queue","jobId":"813b10a6-7992-485c-aeee-cce1a24ac998","to":"protected-test-iUzZT22bUUhVgvScF1Bta@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681288613,"env":"test","module":"auth-routes","userId":"6c2a1f31-7d71-4e98-aa24-a973e8a2608d","email":"protected-test-iUzZT22bUUhVgvScF1Bta@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681289241,"env":"test","module":"auth-routes","userId":"6c2a1f31-7d71-4e98-aa24-a973e8a2608d","msg":"User logged in successfully"}
{"level":30,"time":1768681289284,"env":"test","module":"audit-log-service","userId":"6c2a1f31-7d71-4e98-aa24-a973e8a2608d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681289289,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681289710,"env":"test","module":"user-credentials-repository","userId":"b131deaa-b08c-476d-b548-11a0860b25bc","msg":"User credentials created"}
{"level":30,"time":1768681289803,"env":"test","module":"email-queue","jobId":"d2eeae92-c683-4785-bb9e-c3ba1932f8e3","to":"protected-test-HBHlv94VQbTxAV8Z6rbC6@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681289852,"env":"test","module":"auth-routes","userId":"b131deaa-b08c-476d-b548-11a0860b25bc","email":"protected-test-HBHlv94VQbTxAV8Z6rbC6@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681290500,"env":"test","module":"auth-routes","userId":"b131deaa-b08c-476d-b548-11a0860b25bc","msg":"User logged in successfully"}
{"level":30,"time":1768681290549,"env":"test","module":"audit-log-service","userId":"b131deaa-b08c-476d-b548-11a0860b25bc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681291103,"env":"test","module":"user-credentials-repository","userId":"be72f0e0-1db8-4f59-ba90-1ae697b5d3a7","msg":"User credentials created"}
{"level":30,"time":1768681291194,"env":"test","module":"email-queue","jobId":"e674965b-6ac7-4117-9c03-0e8cae3b814f","to":"protected-test-fQSm5juXEjqjxBHliRxdZ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681291238,"env":"test","module":"auth-routes","userId":"be72f0e0-1db8-4f59-ba90-1ae697b5d3a7","email":"protected-test-fQSm5juXEjqjxBHliRxdZ@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681291961,"env":"test","module":"auth-routes","userId":"be72f0e0-1db8-4f59-ba90-1ae697b5d3a7","msg":"User logged in successfully"}
{"level":30,"time":1768681292012,"env":"test","module":"audit-log-service","userId":"be72f0e0-1db8-4f59-ba90-1ae697b5d3a7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681292017,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681292422,"env":"test","module":"user-credentials-repository","userId":"1daff50c-5d75-4966-b1a8-c95cfe26af2a","msg":"User credentials created"}
{"level":30,"time":1768681292513,"env":"test","module":"email-queue","jobId":"d6dbddd2-d8ab-4583-8da0-25d0021d734b","to":"protected-test-yd4B69Lm1_5SyDHOxegfB@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681292559,"env":"test","module":"auth-routes","userId":"1daff50c-5d75-4966-b1a8-c95cfe26af2a","email":"protected-test-yd4B69Lm1_5SyDHOxegfB@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681293194,"env":"test","module":"auth-routes","userId":"1daff50c-5d75-4966-b1a8-c95cfe26af2a","msg":"User logged in successfully"}
{"level":30,"time":1768681293245,"env":"test","module":"audit-log-service","userId":"1daff50c-5d75-4966-b1a8-c95cfe26af2a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681294290,"env":"test","module":"user-credentials-repository","userId":"5bbcde6a-2607-49f0-a55f-a0f24716df1b","msg":"User credentials created"}
{"level":30,"time":1768681294387,"env":"test","module":"email-queue","jobId":"2695ff16-a4ed-451e-bc5e-9ebe485b032a","to":"protected-test-NN2T1ZMih3P3dnZTFInlt@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681294431,"env":"test","module":"auth-routes","userId":"5bbcde6a-2607-49f0-a55f-a0f24716df1b","email":"protected-test-NN2T1ZMih3P3dnZTFInlt@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681295066,"env":"test","module":"auth-routes","userId":"5bbcde6a-2607-49f0-a55f-a0f24716df1b","msg":"User logged in successfully"}
{"level":30,"time":1768681295169,"env":"test","module":"audit-log-service","userId":"5bbcde6a-2607-49f0-a55f-a0f24716df1b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681295175,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681295585,"env":"test","module":"user-credentials-repository","userId":"355bab88-15f0-473f-a564-277283119455","msg":"User credentials created"}
{"level":30,"time":1768681295676,"env":"test","module":"email-queue","jobId":"1fc0d793-feaa-4596-a3ce-3d90948dda0d","to":"protected-test-e-kyOYSG1vQeDjzr6quyo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681295723,"env":"test","module":"auth-routes","userId":"355bab88-15f0-473f-a564-277283119455","email":"protected-test-e-kyOYSG1vQeDjzr6quyo@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681296388,"env":"test","module":"auth-routes","userId":"355bab88-15f0-473f-a564-277283119455","msg":"User logged in successfully"}
{"level":30,"time":1768681296436,"env":"test","module":"audit-log-service","userId":"355bab88-15f0-473f-a564-277283119455","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681296442,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768681296443,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681296913,"env":"test","module":"user-credentials-repository","userId":"95bab47a-bba2-4aaa-83df-6139bffccfcf","msg":"User credentials created"}
{"level":30,"time":1768681297004,"env":"test","module":"email-queue","jobId":"fa3230c6-455e-4ec7-90bb-8eb0fa0cbff1","to":"protected-test-aM6Fa4N8biBs_iOk2EahB@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681297051,"env":"test","module":"auth-routes","userId":"95bab47a-bba2-4aaa-83df-6139bffccfcf","email":"protected-test-aM6Fa4N8biBs_iOk2EahB@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681297710,"env":"test","module":"auth-routes","userId":"95bab47a-bba2-4aaa-83df-6139bffccfcf","msg":"User logged in successfully"}
{"level":30,"time":1768681297758,"env":"test","module":"audit-log-service","userId":"95bab47a-bba2-4aaa-83df-6139bffccfcf","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681297763,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681298187,"env":"test","module":"user-credentials-repository","userId":"804ca61d-00fe-4737-a8c0-9877948d1746","msg":"User credentials created"}
{"level":30,"time":1768681298287,"env":"test","module":"email-queue","jobId":"6f8a7bb5-86a7-451e-b50e-90c8291dc623","to":"protected-test-9htqTqs-oNRA6K5V6BDUq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681298333,"env":"test","module":"auth-routes","userId":"804ca61d-00fe-4737-a8c0-9877948d1746","email":"protected-test-9htqTqs-oNRA6K5V6BDUq@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681298959,"env":"test","module":"auth-routes","userId":"804ca61d-00fe-4737-a8c0-9877948d1746","msg":"User logged in successfully"}
{"level":30,"time":1768681299009,"env":"test","module":"audit-log-service","userId":"804ca61d-00fe-4737-a8c0-9877948d1746","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681299014,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681299406,"env":"test","module":"user-credentials-repository","userId":"5cf2e851-0561-4135-be6c-002030a333c3","msg":"User credentials created"}
{"level":30,"time":1768681299496,"env":"test","module":"email-queue","jobId":"d43eb33b-373f-4183-bb92-255da7a128b4","to":"protected-test-87nUYZZf0ZM-0j--tsQEu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681299545,"env":"test","module":"auth-routes","userId":"5cf2e851-0561-4135-be6c-002030a333c3","email":"protected-test-87nUYZZf0ZM-0j--tsQEu@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681300227,"env":"test","module":"auth-routes","userId":"5cf2e851-0561-4135-be6c-002030a333c3","msg":"User logged in successfully"}
{"level":30,"time":1768681300273,"env":"test","module":"audit-log-service","userId":"5cf2e851-0561-4135-be6c-002030a333c3","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681300280,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681300685,"env":"test","module":"user-credentials-repository","userId":"b28dcc97-cda4-431d-8c64-300c805cd257","msg":"User credentials created"}
{"level":30,"time":1768681300776,"env":"test","module":"email-queue","jobId":"74dce3e7-ec64-455d-a27a-3bcd55bc4086","to":"protected-test-orAC1hjkAkbfk5MiH3Kl5@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681300822,"env":"test","module":"auth-routes","userId":"b28dcc97-cda4-431d-8c64-300c805cd257","email":"protected-test-orAC1hjkAkbfk5MiH3Kl5@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681301533,"env":"test","module":"auth-routes","userId":"b28dcc97-cda4-431d-8c64-300c805cd257","msg":"User logged in successfully"}
{"level":30,"time":1768681301580,"env":"test","module":"audit-log-service","userId":"b28dcc97-cda4-431d-8c64-300c805cd257","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681301584,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681302064,"env":"test","module":"user-credentials-repository","userId":"473c5865-feb1-4236-9543-f4f5b5eb0772","msg":"User credentials created"}
{"level":30,"time":1768681302158,"env":"test","module":"email-queue","jobId":"7f6a4219-a7de-4a62-a757-6e828e611859","to":"protected-test-ZrcF36QWUQrFTBJEeYoTI@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681302203,"env":"test","module":"auth-routes","userId":"473c5865-feb1-4236-9543-f4f5b5eb0772","email":"protected-test-ZrcF36QWUQrFTBJEeYoTI@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681302847,"env":"test","module":"auth-routes","userId":"473c5865-feb1-4236-9543-f4f5b5eb0772","msg":"User logged in successfully"}
{"level":30,"time":1768681302898,"env":"test","module":"audit-log-service","userId":"473c5865-feb1-4236-9543-f4f5b5eb0772","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681302902,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681303275,"env":"test","module":"user-credentials-repository","userId":"d8de003c-e143-4a91-9c28-8622d3272742","msg":"User credentials created"}
{"level":30,"time":1768681303363,"env":"test","module":"email-queue","jobId":"602c16db-2199-406f-a5ef-0880a8cea64a","to":"protected-test-FFPy9kNAuHo-8RNOE0zHq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681303410,"env":"test","module":"auth-routes","userId":"d8de003c-e143-4a91-9c28-8622d3272742","email":"protected-test-FFPy9kNAuHo-8RNOE0zHq@example.com","msg":"User registered"}
{"level":30,"time":1768681304033,"env":"test","module":"auth-routes","userId":"d8de003c-e143-4a91-9c28-8622d3272742","msg":"User logged in successfully"}
{"level":30,"time":1768681304084,"env":"test","module":"audit-log-service","userId":"d8de003c-e143-4a91-9c28-8622d3272742","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681304088,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681304479,"env":"test","module":"user-credentials-repository","userId":"a808cdb8-7852-44f4-809e-c82b0a20a6eb","msg":"User credentials created"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681304576,"env":"test","module":"email-queue","jobId":"4dc6538e-34d2-4002-8585-4a91ef7d78b5","to":"protected-test-j_DkrnJaKuCsFBqw9Kao0@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681304624,"env":"test","module":"auth-routes","userId":"a808cdb8-7852-44f4-809e-c82b0a20a6eb","email":"protected-test-j_DkrnJaKuCsFBqw9Kao0@example.com","msg":"User registered"}
{"level":30,"time":1768681305230,"env":"test","module":"auth-routes","userId":"a808cdb8-7852-44f4-809e-c82b0a20a6eb","msg":"User logged in successfully"}
{"level":30,"time":1768681305274,"env":"test","module":"audit-log-service","userId":"a808cdb8-7852-44f4-809e-c82b0a20a6eb","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681305651,"env":"test","module":"user-credentials-repository","userId":"bf8a0cb6-b6a5-47ca-8d6f-decbd17e51d3","msg":"User credentials created"}
{"level":30,"time":1768681305742,"env":"test","module":"email-queue","jobId":"81c268dc-404c-486f-acae-d5312531baeb","to":"protected-test-XDtWxY6lFYdbasZyIc73o@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681305786,"env":"test","module":"auth-routes","userId":"bf8a0cb6-b6a5-47ca-8d6f-decbd17e51d3","email":"protected-test-XDtWxY6lFYdbasZyIc73o@example.com","msg":"User registered"}
{"level":30,"time":1768681306395,"env":"test","module":"auth-routes","userId":"bf8a0cb6-b6a5-47ca-8d6f-decbd17e51d3","msg":"User logged in successfully"}
{"level":30,"time":1768681306439,"env":"test","module":"audit-log-service","userId":"bf8a0cb6-b6a5-47ca-8d6f-decbd17e51d3","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681306916,"env":"test","module":"user-credentials-repository","userId":"c2989a3a-08f5-4b5e-bfff-75a03a1ae36a","msg":"User credentials created"}
{"level":30,"time":1768681307009,"env":"test","module":"email-queue","jobId":"bc2f222b-388f-4490-8651-7df2ec7a5441","to":"protected-test-GPK0YF2EDzWLuP_NHm_XP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681307056,"env":"test","module":"auth-routes","userId":"c2989a3a-08f5-4b5e-bfff-75a03a1ae36a","email":"protected-test-GPK0YF2EDzWLuP_NHm_XP@example.com","msg":"User registered"}
{"level":30,"time":1768681307674,"env":"test","module":"auth-routes","userId":"c2989a3a-08f5-4b5e-bfff-75a03a1ae36a","msg":"User logged in successfully"}
{"level":30,"time":1768681307719,"env":"test","module":"audit-log-service","userId":"c2989a3a-08f5-4b5e-bfff-75a03a1ae36a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681308081,"env":"test","module":"user-credentials-repository","userId":"8800a82d-7246-458e-ba07-1b62e0e353b9","msg":"User credentials created"}
{"level":30,"time":1768681308183,"env":"test","module":"email-queue","jobId":"d08680b9-c941-4764-8f44-a2456a43d327","to":"user2-EBeiQdiVtV45MmolXSbJU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681308228,"env":"test","module":"auth-routes","userId":"8800a82d-7246-458e-ba07-1b62e0e353b9","email":"user2-EBeiQdiVtV45MmolXSbJU@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681308782,"env":"test","module":"auth-routes","userId":"8800a82d-7246-458e-ba07-1b62e0e353b9","msg":"User logged in successfully"}
{"level":30,"time":1768681308826,"env":"test","module":"audit-log-service","userId":"8800a82d-7246-458e-ba07-1b62e0e353b9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681308885,"env":"test","module":"rbac-middleware","userId":"8800a82d-7246-458e-ba07-1b62e0e353b9","userRole":"viewer","permission":"project:delete","path":"/5988e38b-052b-4f32-809b-084f21b0dccf","msg":"Permission denied"}
{"level":30,"time":1768681309260,"env":"test","module":"user-credentials-repository","userId":"1d0bb5fa-ff22-418b-b663-168b250a2a59","msg":"User credentials created"}
{"level":30,"time":1768681309352,"env":"test","module":"email-queue","jobId":"50f85175-2f62-4ffc-bd97-859cb2dd19c3","to":"protected-test-fYcfe3QKLuL7Z2qYVdmGV@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681309402,"env":"test","module":"auth-routes","userId":"1d0bb5fa-ff22-418b-b663-168b250a2a59","email":"protected-test-fYcfe3QKLuL7Z2qYVdmGV@example.com","msg":"User registered"}
{"level":30,"time":1768681310026,"env":"test","module":"auth-routes","userId":"1d0bb5fa-ff22-418b-b663-168b250a2a59","msg":"User logged in successfully"}
{"level":30,"time":1768681310071,"env":"test","module":"audit-log-service","userId":"1d0bb5fa-ff22-418b-b663-168b250a2a59","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681310496,"env":"test","module":"user-credentials-repository","userId":"3fc0ca61-6c6d-43fb-8717-da4122a11481","msg":"User credentials created"}
{"level":30,"time":1768681310583,"env":"test","module":"email-queue","jobId":"5b0eeaf6-8918-4a1f-a33e-e5bfb1a0a376","to":"protected-test-Rdcf3rH5YxizGWt-ysrkX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681310628,"env":"test","module":"auth-routes","userId":"3fc0ca61-6c6d-43fb-8717-da4122a11481","email":"protected-test-Rdcf3rH5YxizGWt-ysrkX@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681311222,"env":"test","module":"auth-routes","userId":"3fc0ca61-6c6d-43fb-8717-da4122a11481","msg":"User logged in successfully"}
{"level":30,"time":1768681311266,"env":"test","module":"audit-log-service","userId":"3fc0ca61-6c6d-43fb-8717-da4122a11481","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681311710,"env":"test","module":"user-credentials-repository","userId":"f4809335-ccdc-4d1e-bd4b-6feeca0f861a","msg":"User credentials created"}
{"level":30,"time":1768681311799,"env":"test","module":"email-queue","jobId":"85f0106c-378e-4e56-b4f9-fe371af43ac2","to":"protected-test-y5WluverxGU0GDI0ERYPQ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681311843,"env":"test","module":"auth-routes","userId":"f4809335-ccdc-4d1e-bd4b-6feeca0f861a","email":"protected-test-y5WluverxGU0GDI0ERYPQ@example.com","msg":"User registered"}
{"level":30,"time":1768681312461,"env":"test","module":"auth-routes","userId":"f4809335-ccdc-4d1e-bd4b-6feeca0f861a","msg":"User logged in successfully"}
{"level":30,"time":1768681312506,"env":"test","module":"audit-log-service","userId":"f4809335-ccdc-4d1e-bd4b-6feeca0f861a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681312954,"env":"test","module":"user-credentials-repository","userId":"fe582707-8429-4aaf-870b-f9e7bc9b658c","msg":"User credentials created"}
{"level":30,"time":1768681313044,"env":"test","module":"email-queue","jobId":"0721e992-074b-496e-a7ab-d2513b5a86df","to":"protected-test-aOh87GM2MEm78qWJczvew@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681313091,"env":"test","module":"auth-routes","userId":"fe582707-8429-4aaf-870b-f9e7bc9b658c","email":"protected-test-aOh87GM2MEm78qWJczvew@example.com","msg":"User registered"}
{"level":30,"time":1768681313706,"env":"test","module":"auth-routes","userId":"fe582707-8429-4aaf-870b-f9e7bc9b658c","msg":"User logged in successfully"}
{"level":30,"time":1768681313751,"env":"test","module":"audit-log-service","userId":"fe582707-8429-4aaf-870b-f9e7bc9b658c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681314688,"env":"test","module":"user-credentials-repository","userId":"943ca7be-6e29-44ec-bfd0-32fcd9ecd8fc","msg":"User credentials created"}
{"level":30,"time":1768681314804,"env":"test","module":"email-queue","jobId":"5f3e42ef-4013-4aa0-add3-d78dd60927ca","to":"protected-test-GjjtnWsA5Nh48yhm-ZCLu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681314859,"env":"test","module":"auth-routes","userId":"943ca7be-6e29-44ec-bfd0-32fcd9ecd8fc","email":"protected-test-GjjtnWsA5Nh48yhm-ZCLu@example.com","msg":"User registered"}
{"level":30,"time":1768681315588,"env":"test","module":"auth-routes","userId":"943ca7be-6e29-44ec-bfd0-32fcd9ecd8fc","msg":"User logged in successfully"}
{"level":30,"time":1768681315651,"env":"test","module":"audit-log-service","userId":"943ca7be-6e29-44ec-bfd0-32fcd9ecd8fc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681316229,"env":"test","module":"auth-routes","userId":"943ca7be-6e29-44ec-bfd0-32fcd9ecd8fc","msg":"User logged in successfully"}
{"level":30,"time":1768681316286,"env":"test","module":"audit-log-service","userId":"943ca7be-6e29-44ec-bfd0-32fcd9ecd8fc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681316798,"env":"test","module":"user-credentials-repository","userId":"2cb546d7-d743-47bc-bf8f-0ed63335d461","msg":"User credentials created"}
{"level":30,"time":1768681316919,"env":"test","module":"email-queue","jobId":"6860fcd1-807b-4a86-9b09-be95bfe9dc8d","to":"protected-test-4bbxPXZOkCEgwu1TBj7ux@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681317001,"env":"test","module":"auth-routes","userId":"2cb546d7-d743-47bc-bf8f-0ed63335d461","email":"protected-test-4bbxPXZOkCEgwu1TBj7ux@example.com","msg":"User registered"}
{"level":30,"time":1768681317756,"env":"test","module":"auth-routes","userId":"2cb546d7-d743-47bc-bf8f-0ed63335d461","msg":"User logged in successfully"}
{"level":30,"time":1768681317815,"env":"test","module":"audit-log-service","userId":"2cb546d7-d743-47bc-bf8f-0ed63335d461","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681318443,"env":"test","module":"auth-routes","userId":"2cb546d7-d743-47bc-bf8f-0ed63335d461","msg":"User logged in successfully"}
{"level":30,"time":1768681318502,"env":"test","module":"audit-log-service","userId":"2cb546d7-d743-47bc-bf8f-0ed63335d461","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681318930,"env":"test","module":"user-credentials-repository","userId":"4baacaab-1ebd-416b-91a5-78211004ca88","msg":"User credentials created"}
{"level":30,"time":1768681319049,"env":"test","module":"email-queue","jobId":"d5c35b92-a300-40b1-942f-9340f1be80f9","to":"user2-vi0Ck-4oFQ0dJV2BAGXYE@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681319104,"env":"test","module":"auth-routes","userId":"4baacaab-1ebd-416b-91a5-78211004ca88","email":"user2-vi0Ck-4oFQ0dJV2BAGXYE@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681319805,"env":"test","module":"auth-routes","userId":"4baacaab-1ebd-416b-91a5-78211004ca88","msg":"User logged in successfully"}
{"level":30,"time":1768681319863,"env":"test","module":"audit-log-service","userId":"4baacaab-1ebd-416b-91a5-78211004ca88","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681320480,"env":"test","module":"user-credentials-repository","userId":"011e1e09-200e-4b85-9646-9cfccb9597c0","msg":"User credentials created"}
{"level":30,"time":1768681320694,"env":"test","module":"email-queue","jobId":"d41c6049-f910-4e42-ae8e-b6b261ca667f","to":"protected-test-pQu_TKuKWWlCXljZrrZLn@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768681320753,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["011e1e09-200e-4b85-9646-9cfccb9597c0","54540f665e9af3889ce1afd5c780aa8fdbf3b42e0e943fd850b08c5fd4acbcf2","2026-02-16T20:22:00.695Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T20:22:00.695Z"],"cause":{"length":338,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(011e1e09-200e-4b85-9646-9cfccb9597c0) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681321195,"env":"test","module":"user-credentials-repository","userId":"06f3ca68-aeb4-4572-8744-ebdbacfabbfa","msg":"User credentials created"}
{"level":30,"time":1768681321309,"env":"test","module":"email-queue","jobId":"76f8cca4-525b-4934-a92f-f4d1ae9491ab","to":"protected-test-YVnz9NhCdjsYrfisu5O6m@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681321367,"env":"test","module":"auth-routes","userId":"06f3ca68-aeb4-4572-8744-ebdbacfabbfa","email":"protected-test-YVnz9NhCdjsYrfisu5O6m@example.com","msg":"User registered"}
{"level":30,"time":1768681321871,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681321872,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 6 failed | 1 skipped) 48527ms
       â”œÃ¹ should allow access with valid Bearer token 960ms
       â”œÃ¹ should reject access without Authorization header 430ms
       â”œÃ¹ should reject access with empty Bearer token 1149ms
       Î“Â£Ã´ should reject access with malformed Authorization header  1628ms
       Î“Â£Ã´ should reject access with wrong token type  1255ms
       Î“Â£Ã´ should allow POST with valid Bearer token  1291ms
       Î“Â£Ã´ should reject POST without Bearer token  1290ms
       Î“Â£Ã´ should reject POST with invalid token  1301ms
       Î“Â£Ã´ should allow PUT with valid Bearer token  1454ms
       Î“Â£Ã´ should reject PUT without Bearer token  1222ms
       Î“Â£Ã´ should allow DELETE with valid Bearer token  1416ms
       Î“Â£Ã´ should reject DELETE without Bearer token  1311ms
       Î“Â£Ã´ should allow PATCH with valid Bearer token  1857ms
       Î“Â£Ã´ should reject PATCH without Bearer token  1300ms
       Î“Â£Ã´ should handle Bearer token with extra spaces  1269ms
       Î“Ã¥Ã´ should handle token with newlines
       Î“Â£Ã´ should handle very long invalid token  1319ms
       Î“Â£Ã´ should handle empty Authorization header  1251ms
       Î“Â£Ã´ should handle Authorization header with only Bearer  1265ms
       Î“Â£Ã´ should handle multiple Authorization headers  1306ms
       Î“Â£Ã´ should reject token with SQL injection attempt  1317ms
       Î“Â£Ã´ should reject token with XSS attempt  1185ms
       Î“Â£Ã´ should reject token with missing userId  1192ms
       Î“Â£Ã´ should reject token with non-existent userId  1262ms
       Î“Â£Ã´ should not allow user to access another user's resources  2343ms
       Î“Â£Ã´ should inject userId into request context  1234ms
       Î“Â£Ã´ should inject tenantId into request context  1196ms
       Î“Â£Ã´ should inject role into request context  1245ms
       Î“Â£Ã´ should not apply general rate limiting to authenticated requests  1704ms
       Î“Â£Ã´ should handle request with both Bearer token and cookies  2084ms
       â”œÃ¹ should prioritize Bearer token over cookie when both present 3641ms
       â”œÃ¹ should allow unauthenticated access to optional auth routes 765ms
       â”œÃ¹ should enhance optional auth routes with user context when authenticated 758ms

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 6 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:84:14
     82|                 password: testUser.password,
     83|             })
     84|             .expect(200);
       |              ^
     85| 
     86|         userToken = loginRes.body.token;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/6]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
Error: expected 201 "Created", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:56:14
     54|             .post("/api/auth/register")
     55|             .send(testUser)
     56|             .expect(201);
       |              ^
     57| 
     58|         const userId = registerRes.body.user.id;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/6]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
Error: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 377c030b-66be-436a-ae99-daa0f9dc0f78,82ba4f32-2560-4f4d-8eef-64a8b57c24b5,admin
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:71:13
     69|         // This fixes the 403 error in "Cross-User Authorization" test
     70|         if (ctx.orgId) {
     71|             await db.insert(organizationMemberships).values({
       |             ^
     72|                 orgId: ctx.orgId,
     73|                 userId: userId,

Caused by: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:71:13

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 388, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(377c030b-66be-436a-ae99-daa0f9dc0f78) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/6]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
Error: expected 200 "OK", got 404 "Not Found"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:479:18
    477|                 .set("Authorization", `Bearer ${user2LoginRes.body.tokÎ“Ã‡Âª
    478|                 .set("Cookie", user1LoginRes.headers['set-cookie'])
    479|                 .expect(200);
       |                  ^
    480| 
    481|             // Should authenticate as user2 (Bearer wins)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/6]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Error: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 377c030b-66be-436a-ae99-daa0f9dc0f78,06f3ca68-aeb4-4572-8744-ebdbacfabbfa,admin
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:71:13
     69|         // This fixes the 403 error in "Cross-User Authorization" test
     70|         if (ctx.orgId) {
     71|             await db.insert(organizationMemberships).values({
       |             ^
     72|                 orgId: ctx.orgId,
     73|                 userId: userId,

Caused by: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:71:13

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 400, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(377c030b-66be-436a-ae99-daa0f9dc0f78) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/6]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  6 failed | 26 passed | 1 skipped (33)
   Start at  14:20:50
   Duration  67.40s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x12 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681468066,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681472624,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681472624,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w0_v3\",public on all connections"}
{"level":30,"time":1768681472677,"env":"test","msg":"DB: Wrapped execute() to set search_path=\"test_schema_w0_v3\",public"}
{"level":30,"time":1768681472677,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
Î“Ã…âŒ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: []

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681475442,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681475457,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768681475449,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681475449,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681475453,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681475453,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681475456,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681475456,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681475457,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681475457,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768681475984,"env":"test","module":"user-credentials-repository","userId":"627669c8-ebee-412a-a603-318cc70a9658","msg":"User credentials created"}
{"level":30,"time":1768681476106,"env":"test","module":"email-queue","jobId":"40c3480d-ce30-4250-9f60-cfad7fdf650d","to":"test-AVmrrFOmMzIquSrs4pAzW@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681476170,"env":"test","module":"auth-routes","userId":"627669c8-ebee-412a-a603-318cc70a9658","email":"test-AVmrrFOmMzIquSrs4pAzW@example.com","msg":"User registered"}
{"level":30,"time":1768681476877,"env":"test","module":"user-credentials-repository","userId":"26ec8989-3b1c-4498-a88a-a71bbd54cc48","msg":"User credentials created"}
{"level":30,"time":1768681477001,"env":"test","module":"email-queue","jobId":"b7652ebc-5245-4ab9-aba1-35b13af4d1ae","to":"protected-test-VKD43Yu-_X-UIhii6wExU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681477060,"env":"test","module":"auth-routes","userId":"26ec8989-3b1c-4498-a88a-a71bbd54cc48","email":"protected-test-VKD43Yu-_X-UIhii6wExU@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681477243,"env":"test","module":"auth-routes","email":"protected-test-VKD43Yu-_X-UIhii6wExU@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768681477368,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768681477788,"env":"test","module":"user-credentials-repository","userId":"f6107d60-ba01-4448-9046-436c7006cb2c","msg":"User credentials created"}
{"level":30,"time":1768681477905,"env":"test","module":"email-queue","jobId":"3836b68c-48fb-4805-a834-9dae5289e791","to":"protected-test-hZe4dUZu_7213n9e8nLRW@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681477963,"env":"test","module":"auth-routes","userId":"f6107d60-ba01-4448-9046-436c7006cb2c","email":"protected-test-hZe4dUZu_7213n9e8nLRW@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681478662,"env":"test","module":"auth-routes","userId":"f6107d60-ba01-4448-9046-436c7006cb2c","msg":"User logged in successfully"}
{"level":30,"time":1768681478725,"env":"test","module":"audit-log-service","userId":"f6107d60-ba01-4448-9046-436c7006cb2c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681478731,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681479150,"env":"test","module":"user-credentials-repository","userId":"87daa46e-3ba1-43de-b6f3-8750a854b44a","msg":"User credentials created"}
{"level":30,"time":1768681479266,"env":"test","module":"email-queue","jobId":"d1e4e921-2a64-44a1-9466-c1ef3c15fd75","to":"protected-test-SHKb5PZolgEkGtc589MkZ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681479322,"env":"test","module":"auth-routes","userId":"87daa46e-3ba1-43de-b6f3-8750a854b44a","email":"protected-test-SHKb5PZolgEkGtc589MkZ@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681480008,"env":"test","module":"auth-routes","userId":"87daa46e-3ba1-43de-b6f3-8750a854b44a","msg":"User logged in successfully"}
{"level":30,"time":1768681480068,"env":"test","module":"audit-log-service","userId":"87daa46e-3ba1-43de-b6f3-8750a854b44a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681480074,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681480475,"env":"test","module":"user-credentials-repository","userId":"57c1f41b-4bc3-4702-8026-b002435991d7","msg":"User credentials created"}
{"level":30,"time":1768681480590,"env":"test","module":"email-queue","jobId":"ee3275c4-9f2d-42d4-90b2-0adc4f76279e","to":"protected-test-u5raYfZb-7wyEIASerOxj@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681480652,"env":"test","module":"auth-routes","userId":"57c1f41b-4bc3-4702-8026-b002435991d7","email":"protected-test-u5raYfZb-7wyEIASerOxj@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681481334,"env":"test","module":"auth-routes","userId":"57c1f41b-4bc3-4702-8026-b002435991d7","msg":"User logged in successfully"}
{"level":30,"time":1768681481390,"env":"test","module":"audit-log-service","userId":"57c1f41b-4bc3-4702-8026-b002435991d7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681481394,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681481793,"env":"test","module":"user-credentials-repository","userId":"e46a66a0-f48a-4cde-b114-5e8022147224","msg":"User credentials created"}
{"level":30,"time":1768681481909,"env":"test","module":"email-queue","jobId":"419b40a1-faf2-49dc-9c50-462ea73a0527","to":"protected-test-_T9StWCfPJDDnhdq_S1-6@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681481965,"env":"test","module":"auth-routes","userId":"e46a66a0-f48a-4cde-b114-5e8022147224","email":"protected-test-_T9StWCfPJDDnhdq_S1-6@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681482649,"env":"test","module":"auth-routes","userId":"e46a66a0-f48a-4cde-b114-5e8022147224","msg":"User logged in successfully"}
{"level":30,"time":1768681482705,"env":"test","module":"audit-log-service","userId":"e46a66a0-f48a-4cde-b114-5e8022147224","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681482709,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768681482709,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681483119,"env":"test","module":"user-credentials-repository","userId":"7b3719ab-9f08-4f37-8a56-7c30503daff5","msg":"User credentials created"}
{"level":30,"time":1768681483238,"env":"test","module":"email-queue","jobId":"5870c333-789f-4558-8754-cc02776f0075","to":"protected-test-Q3SbWj3PFFFRqHpFpdlRk@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681483300,"env":"test","module":"auth-routes","userId":"7b3719ab-9f08-4f37-8a56-7c30503daff5","email":"protected-test-Q3SbWj3PFFFRqHpFpdlRk@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681483999,"env":"test","module":"auth-routes","userId":"7b3719ab-9f08-4f37-8a56-7c30503daff5","msg":"User logged in successfully"}
{"level":30,"time":1768681484059,"env":"test","module":"audit-log-service","userId":"7b3719ab-9f08-4f37-8a56-7c30503daff5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681484535,"env":"test","module":"user-credentials-repository","userId":"97fda262-d973-4731-8053-14e3205a9aa4","msg":"User credentials created"}
{"level":30,"time":1768681484645,"env":"test","module":"email-queue","jobId":"6f0269d6-1f41-4c41-b4e2-6fd5da46fe86","to":"protected-test-_rzuNRCXhhMJaQz2ZvToo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681484700,"env":"test","module":"auth-routes","userId":"97fda262-d973-4731-8053-14e3205a9aa4","email":"protected-test-_rzuNRCXhhMJaQz2ZvToo@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681485383,"env":"test","module":"auth-routes","userId":"97fda262-d973-4731-8053-14e3205a9aa4","msg":"User logged in successfully"}
{"level":30,"time":1768681485443,"env":"test","module":"audit-log-service","userId":"97fda262-d973-4731-8053-14e3205a9aa4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681485449,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681485857,"env":"test","module":"user-credentials-repository","userId":"63f3b6c4-dc73-4cb4-bcdb-ea968e36faa0","msg":"User credentials created"}
{"level":30,"time":1768681485981,"env":"test","module":"email-queue","jobId":"ed9e7482-b3c9-44ce-813c-d25532f0b23b","to":"protected-test-FuwdMiN2dRqbHx8nl6RKp@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681486038,"env":"test","module":"auth-routes","userId":"63f3b6c4-dc73-4cb4-bcdb-ea968e36faa0","email":"protected-test-FuwdMiN2dRqbHx8nl6RKp@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681486724,"env":"test","module":"auth-routes","userId":"63f3b6c4-dc73-4cb4-bcdb-ea968e36faa0","msg":"User logged in successfully"}
{"level":30,"time":1768681486779,"env":"test","module":"audit-log-service","userId":"63f3b6c4-dc73-4cb4-bcdb-ea968e36faa0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681486783,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681487191,"env":"test","module":"user-credentials-repository","userId":"71eef18e-fba9-48fc-b857-9a5bc849b87c","msg":"User credentials created"}
{"level":30,"time":1768681487317,"env":"test","module":"email-queue","jobId":"12a0752a-d870-497b-a9ff-87143e52482c","to":"protected-test-skHdTili3z35gOo_PTNNx@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681487378,"env":"test","module":"auth-routes","userId":"71eef18e-fba9-48fc-b857-9a5bc849b87c","email":"protected-test-skHdTili3z35gOo_PTNNx@example.com","msg":"User registered"}
{"level":30,"time":1768681488082,"env":"test","module":"auth-routes","userId":"71eef18e-fba9-48fc-b857-9a5bc849b87c","msg":"User logged in successfully"}
{"level":30,"time":1768681488138,"env":"test","module":"audit-log-service","userId":"71eef18e-fba9-48fc-b857-9a5bc849b87c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[DEBUG] BaseRepository.update users: id=71eef18e-fba9-48fc-b857-9a5bc849b87c, updates={"defaultMode":"advanced","updatedAt":"2026-01-17T20:24:48.286Z"}
{"level":30,"time":1768681488768,"env":"test","module":"user-credentials-repository","userId":"0a102aba-2053-4259-80b0-ae8b43abcaae","msg":"User credentials created"}
{"level":30,"time":1768681488886,"env":"test","module":"email-queue","jobId":"f54ec4b3-d194-47e3-94c8-c8af273d3d05","to":"protected-test-IzftMi9uitVEmx4WK942w@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681488948,"env":"test","module":"auth-routes","userId":"0a102aba-2053-4259-80b0-ae8b43abcaae","email":"protected-test-IzftMi9uitVEmx4WK942w@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681489654,"env":"test","module":"auth-routes","userId":"0a102aba-2053-4259-80b0-ae8b43abcaae","msg":"User logged in successfully"}
{"level":30,"time":1768681489717,"env":"test","module":"audit-log-service","userId":"0a102aba-2053-4259-80b0-ae8b43abcaae","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681489723,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681490119,"env":"test","module":"user-credentials-repository","userId":"6a6388b6-09a7-4395-b6dc-9c0ad10fc4ff","msg":"User credentials created"}
{"level":30,"time":1768681490237,"env":"test","module":"email-queue","jobId":"afd7ee1a-f607-4353-9d74-92699a397064","to":"protected-test-ELz4XxXhuhNRnNVCN6q7x@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681490300,"env":"test","module":"auth-routes","userId":"6a6388b6-09a7-4395-b6dc-9c0ad10fc4ff","email":"protected-test-ELz4XxXhuhNRnNVCN6q7x@example.com","msg":"User registered"}
{"level":30,"time":1768681491011,"env":"test","module":"auth-routes","userId":"6a6388b6-09a7-4395-b6dc-9c0ad10fc4ff","msg":"User logged in successfully"}
{"level":30,"time":1768681491071,"env":"test","module":"audit-log-service","userId":"6a6388b6-09a7-4395-b6dc-9c0ad10fc4ff","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681491726,"env":"test","module":"user-credentials-repository","userId":"717fd9fb-ebe3-4fd2-b9ec-c79558583702","msg":"User credentials created"}
{"level":30,"time":1768681491843,"env":"test","module":"email-queue","jobId":"f773c45a-00cd-4d0f-a00b-2508bef21933","to":"protected-test-K1BBaDua3NFCZuqzvmta5@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681491907,"env":"test","module":"auth-routes","userId":"717fd9fb-ebe3-4fd2-b9ec-c79558583702","email":"protected-test-K1BBaDua3NFCZuqzvmta5@example.com","msg":"User registered"}
{"level":30,"time":1768681492667,"env":"test","module":"auth-routes","userId":"717fd9fb-ebe3-4fd2-b9ec-c79558583702","msg":"User logged in successfully"}
{"level":30,"time":1768681492729,"env":"test","module":"audit-log-service","userId":"717fd9fb-ebe3-4fd2-b9ec-c79558583702","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681492734,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681493174,"env":"test","module":"user-credentials-repository","userId":"b24a1946-0ef7-4d8e-b660-338e3a689596","msg":"User credentials created"}
{"level":30,"time":1768681493294,"env":"test","module":"email-queue","jobId":"30b3ad26-3971-481c-8a4c-8cc8217b9255","to":"protected-test-ybLKTbKLIwfYsON9pjKVK@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681493355,"env":"test","module":"auth-routes","userId":"b24a1946-0ef7-4d8e-b660-338e3a689596","email":"protected-test-ybLKTbKLIwfYsON9pjKVK@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681494084,"env":"test","module":"auth-routes","userId":"b24a1946-0ef7-4d8e-b660-338e3a689596","msg":"User logged in successfully"}
{"level":50,"time":1768681494140,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"b24a1946-0ef7-4d8e-b660-338e3a689596","login_success","security","b24a1946-0ef7-4d8e-b660-338e3a689596","security","b24a1946-0ef7-4d8e-b660-338e3a689596","{\"metadata\":{\"timestamp\":\"2026-01-17T20:24:54.084Z\"}}","::1",null,"2026-01-17T20:24:54.084Z"],"cause":{"length":311,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b24a1946-0ef7-4d8e-b660-338e3a689596) is not present in table \"users\".","schema":"public","table":"audit_logs","constraint":"audit_logs_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"b24a1946-0ef7-4d8e-b660-338e3a689596","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768681494144,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"b24a1946-0ef7-4d8e-b660-338e3a689596","login_success","security","b24a1946-0ef7-4d8e-b660-338e3a689596","security","b24a1946-0ef7-4d8e-b660-338e3a689596","{\"metadata\":{\"timestamp\":\"2026-01-17T20:24:54.084Z\"}}","::1",null,"2026-01-17T20:24:54.084Z"],"cause":{"length":311,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b24a1946-0ef7-4d8e-b660-338e3a689596) is not present in table \"users\".","schema":"public","table":"audit_logs","constraint":"audit_logs_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
{"level":30,"time":1768681494856,"env":"test","module":"user-credentials-repository","userId":"ca2ca12d-9280-4a0f-846e-44949dd522a8","msg":"User credentials created"}
{"level":30,"time":1768681494952,"env":"test","module":"email-queue","jobId":"1b59315a-eeb8-4953-8eeb-afa38d39feda","to":"protected-test-NaLWqAv7eqsTfyXPa4SWp@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681494999,"env":"test","module":"auth-routes","userId":"ca2ca12d-9280-4a0f-846e-44949dd522a8","email":"protected-test-NaLWqAv7eqsTfyXPa4SWp@example.com","msg":"User registered"}
{"level":30,"time":1768681495621,"env":"test","module":"auth-routes","userId":"ca2ca12d-9280-4a0f-846e-44949dd522a8","msg":"User logged in successfully"}
{"level":30,"time":1768681495665,"env":"test","module":"audit-log-service","userId":"ca2ca12d-9280-4a0f-846e-44949dd522a8","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681495670,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681496043,"env":"test","module":"user-credentials-repository","userId":"5c568a41-f354-436e-958b-41bd19c6c56f","msg":"User credentials created"}
{"level":30,"time":1768681496132,"env":"test","module":"email-queue","jobId":"8133a1a8-078c-4f64-801a-95e6f0b42997","to":"protected-test-Z-8-cQav5zppG-3lFkRJb@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681496177,"env":"test","module":"auth-routes","userId":"5c568a41-f354-436e-958b-41bd19c6c56f","email":"protected-test-Z-8-cQav5zppG-3lFkRJb@example.com","msg":"User registered"}
{"level":30,"time":1768681496795,"env":"test","module":"auth-routes","userId":"5c568a41-f354-436e-958b-41bd19c6c56f","msg":"User logged in successfully"}
{"level":30,"time":1768681496845,"env":"test","module":"audit-log-service","userId":"5c568a41-f354-436e-958b-41bd19c6c56f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681496849,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768681496849,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681497238,"env":"test","module":"user-credentials-repository","userId":"ef606b4c-5fd2-4b02-8ecd-c4091cbc9d0a","msg":"User credentials created"}
{"level":30,"time":1768681497339,"env":"test","module":"email-queue","jobId":"a73d1e35-d1c5-4bc8-9bc1-e0702af7d92b","to":"protected-test-t5yu37EsZb_lNYQXx4Q3f@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681497390,"env":"test","module":"auth-routes","userId":"ef606b4c-5fd2-4b02-8ecd-c4091cbc9d0a","email":"protected-test-t5yu37EsZb_lNYQXx4Q3f@example.com","msg":"User registered"}
{"level":30,"time":1768681498015,"env":"test","module":"auth-routes","userId":"ef606b4c-5fd2-4b02-8ecd-c4091cbc9d0a","msg":"User logged in successfully"}
{"level":30,"time":1768681498064,"env":"test","module":"audit-log-service","userId":"ef606b4c-5fd2-4b02-8ecd-c4091cbc9d0a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681498069,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681498481,"env":"test","module":"user-credentials-repository","userId":"29126dac-af33-4947-a3f9-6e6e8e3f3126","msg":"User credentials created"}
{"level":30,"time":1768681498581,"env":"test","module":"email-queue","jobId":"360caa9d-6479-4784-87a5-e3c9624d3ad6","to":"protected-test-bmqr8e87Q_gPXyyaosmNc@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681498627,"env":"test","module":"auth-routes","userId":"29126dac-af33-4947-a3f9-6e6e8e3f3126","email":"protected-test-bmqr8e87Q_gPXyyaosmNc@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681499264,"env":"test","module":"auth-routes","userId":"29126dac-af33-4947-a3f9-6e6e8e3f3126","msg":"User logged in successfully"}
{"level":30,"time":1768681499312,"env":"test","module":"audit-log-service","userId":"29126dac-af33-4947-a3f9-6e6e8e3f3126","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681499321,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681499722,"env":"test","module":"user-credentials-repository","userId":"58c071dd-8b60-4ec4-a31c-8b7264ed6875","msg":"User credentials created"}
{"level":30,"time":1768681499841,"env":"test","module":"email-queue","jobId":"30e6fac4-fa49-43f2-b904-ef61b4980008","to":"protected-test-lsDvja4sXkP6BI4kf9Ej7@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681499888,"env":"test","module":"auth-routes","userId":"58c071dd-8b60-4ec4-a31c-8b7264ed6875","email":"protected-test-lsDvja4sXkP6BI4kf9Ej7@example.com","msg":"User registered"}
{"level":30,"time":1768681500522,"env":"test","module":"auth-routes","userId":"58c071dd-8b60-4ec4-a31c-8b7264ed6875","msg":"User logged in successfully"}
{"level":30,"time":1768681500570,"env":"test","module":"audit-log-service","userId":"58c071dd-8b60-4ec4-a31c-8b7264ed6875","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681500575,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681501028,"env":"test","module":"user-credentials-repository","userId":"c1bfb2f5-10f4-4c82-aeb8-268775d0a514","msg":"User credentials created"}
{"level":30,"time":1768681501119,"env":"test","module":"email-queue","jobId":"c8cea644-d990-4ccc-a46b-affc8f645091","to":"protected-test-z5ZB_knTVwR56W6bv7xk6@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681501169,"env":"test","module":"auth-routes","userId":"c1bfb2f5-10f4-4c82-aeb8-268775d0a514","email":"protected-test-z5ZB_knTVwR56W6bv7xk6@example.com","msg":"User registered"}
{"level":30,"time":1768681501808,"env":"test","module":"auth-routes","userId":"c1bfb2f5-10f4-4c82-aeb8-268775d0a514","msg":"User logged in successfully"}
{"level":30,"time":1768681501856,"env":"test","module":"audit-log-service","userId":"c1bfb2f5-10f4-4c82-aeb8-268775d0a514","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681501860,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681502272,"env":"test","module":"user-credentials-repository","userId":"97a3a1eb-78aa-4463-a387-b04be45c8a5d","msg":"User credentials created"}
{"level":30,"time":1768681502370,"env":"test","module":"email-queue","jobId":"7675f84e-d544-4ef2-b145-bd1f059159d6","to":"protected-test-rEua4YUBqVng04l8hJbEy@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681502417,"env":"test","module":"auth-routes","userId":"97a3a1eb-78aa-4463-a387-b04be45c8a5d","email":"protected-test-rEua4YUBqVng04l8hJbEy@example.com","msg":"User registered"}
{"level":30,"time":1768681503093,"env":"test","module":"auth-routes","userId":"97a3a1eb-78aa-4463-a387-b04be45c8a5d","msg":"User logged in successfully"}
{"level":30,"time":1768681503139,"env":"test","module":"audit-log-service","userId":"97a3a1eb-78aa-4463-a387-b04be45c8a5d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681503143,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681503625,"env":"test","module":"user-credentials-repository","userId":"36f07a38-ed4c-4165-8556-97a944e4a7e2","msg":"User credentials created"}
{"level":30,"time":1768681503717,"env":"test","module":"email-queue","jobId":"ab24222f-ec9d-49b3-a78c-1315716ebe4b","to":"protected-test-zOhrQie_0e8eDCuQr3pRL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681503761,"env":"test","module":"auth-routes","userId":"36f07a38-ed4c-4165-8556-97a944e4a7e2","email":"protected-test-zOhrQie_0e8eDCuQr3pRL@example.com","msg":"User registered"}
{"level":30,"time":1768681504429,"env":"test","module":"auth-routes","userId":"36f07a38-ed4c-4165-8556-97a944e4a7e2","msg":"User logged in successfully"}
{"level":30,"time":1768681504478,"env":"test","module":"audit-log-service","userId":"36f07a38-ed4c-4165-8556-97a944e4a7e2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681504483,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681504894,"env":"test","module":"user-credentials-repository","userId":"fc24859b-9d72-48a9-9b3e-2fc38157dd59","msg":"User credentials created"}
{"level":30,"time":1768681504987,"env":"test","module":"email-queue","jobId":"0c73de0b-0c25-433c-b6e1-94758f18b424","to":"protected-test-aAbVbTn-hEv5OHeGS7IKa@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681505042,"env":"test","module":"auth-routes","userId":"fc24859b-9d72-48a9-9b3e-2fc38157dd59","email":"protected-test-aAbVbTn-hEv5OHeGS7IKa@example.com","msg":"User registered"}
{"level":30,"time":1768681505688,"env":"test","module":"auth-routes","userId":"fc24859b-9d72-48a9-9b3e-2fc38157dd59","msg":"User logged in successfully"}
{"level":30,"time":1768681505736,"env":"test","module":"audit-log-service","userId":"fc24859b-9d72-48a9-9b3e-2fc38157dd59","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681506133,"env":"test","module":"user-credentials-repository","userId":"645d49ea-95aa-4fef-932c-cd10e6946129","msg":"User credentials created"}
{"level":30,"time":1768681506228,"env":"test","module":"email-queue","jobId":"5765e8d8-931b-4e00-91e6-b11923782133","to":"protected-test-dWb3HpTHtMcybaDMMPHPL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681506273,"env":"test","module":"auth-routes","userId":"645d49ea-95aa-4fef-932c-cd10e6946129","email":"protected-test-dWb3HpTHtMcybaDMMPHPL@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681506999,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["645d49ea-95aa-4fef-932c-cd10e6946129","8c3c07d6ccbcddac6d75176aeca6c231cb5f963b110fa551c39eb12e28907488","2026-02-16T20:25:06.843Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T20:25:06.843Z"],"cause":{"length":338,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(645d49ea-95aa-4fef-932c-cd10e6946129) is not present in table \"users\".","schema":"test_schema_w5_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
{"level":50,"time":1768681507760,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["df133b13-a4ae-4137-8f8e-7974526e3696","$2b$12$g6MWDdzJoSCuPXntSUaQcODiz.uBit7hEQETZhknvOSvBAULAXZ.q"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(df133b13-a4ae-4137-8f8e-7974526e3696) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"df133b13-a4ae-4137-8f8e-7974526e3696","msg":"Failed to create user credentials"}
{"level":50,"time":1768681507760,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["df133b13-a4ae-4137-8f8e-7974526e3696","$2b$12$g6MWDdzJoSCuPXntSUaQcODiz.uBit7hEQETZhknvOSvBAULAXZ.q"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(df133b13-a4ae-4137-8f8e-7974526e3696) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681508472,"env":"test","module":"user-credentials-repository","userId":"d21d2dad-e868-44e3-8581-0ffa94e5961b","msg":"User credentials created"}
{"level":30,"time":1768681508571,"env":"test","module":"email-queue","jobId":"2585a195-cbb0-4f43-96d9-da527d96a484","to":"protected-test-D03ONIokvt9OO6jYQ6RXl@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681508616,"env":"test","module":"auth-routes","userId":"d21d2dad-e868-44e3-8581-0ffa94e5961b","email":"protected-test-D03ONIokvt9OO6jYQ6RXl@example.com","msg":"User registered"}
{"level":50,"time":1768681509527,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["42f03aa2-74b4-491d-b576-a2d78b3d9136","$2b$12$2zg5Ks.Yabp7XzZkpM3zAusrD0y/5hNcvIX6bG30xljL7x0TiiOnO"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(42f03aa2-74b4-491d-b576-a2d78b3d9136) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"42f03aa2-74b4-491d-b576-a2d78b3d9136","msg":"Failed to create user credentials"}
{"level":50,"time":1768681509527,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["42f03aa2-74b4-491d-b576-a2d78b3d9136","$2b$12$2zg5Ks.Yabp7XzZkpM3zAusrD0y/5hNcvIX6bG30xljL7x0TiiOnO"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(42f03aa2-74b4-491d-b576-a2d78b3d9136) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681510267,"env":"test","module":"user-credentials-repository","userId":"6e0e3129-c1ae-4736-b1a4-b80a1ab27a26","msg":"User credentials created"}
{"level":50,"time":1768681510346,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["6e0e3129-c1ae-4736-b1a4-b80a1ab27a26","72d5904f639a93a729ac1d05a0fe965f06cae44a3bed187c9bbecc5520d2f856","2026-01-18T20:25:10.267Z"],"cause":{"length":383,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(6e0e3129-c1ae-4736-b1a4-b80a1ab27a26) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681511281,"env":"test","module":"user-credentials-repository","userId":"900b2757-1e8f-4a9b-aea6-9e853e14630b","msg":"User credentials created"}
{"level":50,"time":1768681511372,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["900b2757-1e8f-4a9b-aea6-9e853e14630b","40eef7f9f4d424fe6889e56e8c5b44cfee59846f035d3b04bd883f45a65968cf","2026-01-18T20:25:11.281Z"],"cause":{"length":382,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(900b2757-1e8f-4a9b-aea6-9e853e14630b) is not present in table \"users\".","schema":"test_schema_w3_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768681512256,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["0c38e13b-a2c6-411b-9c2c-3ee98bddd166","$2b$12$OM72woKNiffQAPnJ9/TBdu8pqdqpiq/cReoWHDx078BW/NzZGJli."],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(0c38e13b-a2c6-411b-9c2c-3ee98bddd166) is not present in table \"users\".","schema":"test_schema_w6_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"0c38e13b-a2c6-411b-9c2c-3ee98bddd166","msg":"Failed to create user credentials"}
{"level":50,"time":1768681512256,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["0c38e13b-a2c6-411b-9c2c-3ee98bddd166","$2b$12$OM72woKNiffQAPnJ9/TBdu8pqdqpiq/cReoWHDx078BW/NzZGJli."],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(0c38e13b-a2c6-411b-9c2c-3ee98bddd166) is not present in table \"users\".","schema":"test_schema_w6_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768681513045,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b6c81a0f-8ddf-45b9-9994-b3e99e355df8","$2b$12$Hxt3B4RkBefvJQZMvYJ.b.4eHhp4w7Aremrh83jiUg6dC8XxV/Wiy"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b6c81a0f-8ddf-45b9-9994-b3e99e355df8) is not present in table \"users\".","schema":"test_schema_w14_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"b6c81a0f-8ddf-45b9-9994-b3e99e355df8","msg":"Failed to create user credentials"}
{"level":50,"time":1768681513045,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b6c81a0f-8ddf-45b9-9994-b3e99e355df8","$2b$12$Hxt3B4RkBefvJQZMvYJ.b.4eHhp4w7Aremrh83jiUg6dC8XxV/Wiy"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b6c81a0f-8ddf-45b9-9994-b3e99e355df8) is not present in table \"users\".","schema":"test_schema_w14_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768681513789,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["0d0f4300-a74c-4a47-868e-c3f8acf665ac","$2b$12$kH8/576B50V.iQRlwT7sOuFq3Aw23/AcxKkAbf2uL.FBNI42UORDS"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(0d0f4300-a74c-4a47-868e-c3f8acf665ac) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"0d0f4300-a74c-4a47-868e-c3f8acf665ac","msg":"Failed to create user credentials"}
{"level":50,"time":1768681513789,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["0d0f4300-a74c-4a47-868e-c3f8acf665ac","$2b$12$kH8/576B50V.iQRlwT7sOuFq3Aw23/AcxKkAbf2uL.FBNI42UORDS"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(0d0f4300-a74c-4a47-868e-c3f8acf665ac) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681514636,"env":"test","module":"user-credentials-repository","userId":"091ed263-4969-4be3-b526-69ee38dae059","msg":"User credentials created"}
{"level":50,"time":1768681514691,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["091ed263-4969-4be3-b526-69ee38dae059","1720b0b84a64eb03eea6f43b01feda044e8f8b3f816b28ad63d329bf2201afb6","2026-01-18T20:25:14.636Z"],"cause":{"length":382,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(091ed263-4969-4be3-b526-69ee38dae059) is not present in table \"users\".","schema":"test_schema_w5_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681515128,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681515128,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
DEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
AUDIT LOG ERROR: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,b24a1946-0ef7-4d8e-b660-338e3a689596,login_success,security,b24a1946-0ef7-4d8e-b660-338e3a689596,security,b24a1946-0ef7-4d8e-b660-338e3a689596,{"metadata":{"timestamp":"2026-01-17T20:24:54.084Z"}},::1,,2026-01-17T20:24:54.084Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"',
  params: [
    null,
    null,
    'b24a1946-0ef7-4d8e-b660-338e3a689596',
    'login_success',
    'security',
    'b24a1946-0ef7-4d8e-b660-338e3a689596',
    'security',
    'b24a1946-0ef7-4d8e-b660-338e3a689596',
    '{"metadata":{"timestamp":"2026-01-17T20:24:54.084Z"}}',
    '::1',
    null,
    '2026-01-17T20:24:54.084Z'
  ],
  cause: error: insert or update on table "audit_logs" violates foreign key constraint "audit_logs_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
    length: 311,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(b24a1946-0ef7-4d8e-b660-338e3a689596) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'public',
    table: 'audit_logs',
    column: undefined,
    dataType: undefined,
    constraint: 'audit_logs_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,b24a1946-0ef7-4d8e-b660-338e3a689596,login_success,security,b24a1946-0ef7-4d8e-b660-338e3a689596,security,b24a1946-0ef7-4d8e-b660-338e3a689596,{"metadata":{"timestamp":"2026-01-17T20:24:54.084Z"}},::1,,2026-01-17T20:24:54.084Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"',
  params: [
    null,
    null,
    'b24a1946-0ef7-4d8e-b660-338e3a689596',
    'login_success',
    'security',
    'b24a1946-0ef7-4d8e-b660-338e3a689596',
    'security',
    'b24a1946-0ef7-4d8e-b660-338e3a689596',
    '{"metadata":{"timestamp":"2026-01-17T20:24:54.084Z"}}',
    '::1',
    null,
    '2026-01-17T20:24:54.084Z'
  ],
  cause: error: insert or update on table "audit_logs" violates foreign key constraint "audit_logs_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
    length: 311,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(b24a1946-0ef7-4d8e-b660-338e3a689596) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'public',
    table: 'audit_logs',
    column: undefined,
    dataType: undefined,
    constraint: 'audit_logs_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
DEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: 645d49ea-95aa-4fef-932c-cd10e6946129,8c3c07d6ccbcddac6d75176aeca6c231cb5f963b110fa551c39eb12e28907488,2026-02-16T20:25:06.843Z,false,{"ip":"::1"},,::1,Location Unknown,2026-01-17T20:25:06.843Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
  query: 'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)',
  params: [
    '645d49ea-95aa-4fef-932c-cd10e6946129',
    '8c3c07d6ccbcddac6d75176aeca6c231cb5f963b110fa551c39eb12e28907488',
    '2026-02-16T20:25:06.843Z',
    false,
    '{"ip":"::1"}',
    null,
    '::1',
    'Location Unknown',
    '2026-01-17T20:25:06.843Z'
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
    length: 338,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(645d49ea-95aa-4fef-932c-cd10e6946129) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w5_v3',
    table: 'refresh_tokens',
    column: undefined,
    dataType: undefined,
    constraint: 'refresh_tokens_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Cleanup error: DrizzleQueryError: Failed query: delete from "tenants" where "tenants"."id" = $1
params: 51df26d1-c85b-47dd-ae9a-db27892b645c
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at Object.cleanup (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:173:11)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:41:9 {
  query: 'delete from "tenants" where "tenants"."id" = $1',
  params: [ '51df26d1-c85b-47dd-ae9a-db27892b645c' ],
  cause: error: update or delete on table "users" violates foreign key constraint "audit_logs_user_id_users_id_fk" on table "audit_logs"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at Object.cleanup (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:173:11)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:41:9 {
    length: 346,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (id)=(f6107d60-ba01-4448-9046-436c7006cb2c) is still referenced from table "audit_logs".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w0_v3',
    table: 'audit_logs',
    column: undefined,
    dataType: undefined,
    constraint: 'audit_logs_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2612',
    routine: 'ri_ReportViolation'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 12 failed | 1 skipped) 43424ms
       â”œÃ¹ should allow access with valid Bearer token 892ms
       Î“Â£Ã´ should reject access without Authorization header  1360ms
       Î“Â£Ã´ should reject access with empty Bearer token  1342ms
       Î“Â£Ã´ should reject access with malformed Authorization header  1320ms
       Î“Â£Ã´ should reject access with wrong token type  1315ms
       Î“Â£Ã´ should allow POST with valid Bearer token  1417ms
       Î“Â£Ã´ should reject POST without Bearer token  1323ms
       Î“Â£Ã´ should reject POST with invalid token  1334ms
       Î“Â£Ã´ should allow PUT with valid Bearer token  1563ms
       Î“Â£Ã´ should reject PUT without Bearer token  1377ms
       Î“Â£Ã´ should allow DELETE with valid Bearer token  1554ms
       Î“Â£Ã´ should reject DELETE without Bearer token  1457ms
       â”œÃ¹ should allow PATCH with valid Bearer token 1412ms
       Î“Â£Ã´ should reject PATCH without Bearer token  1525ms
       Î“Â£Ã´ should handle Bearer token with extra spaces  1179ms
       Î“Ã¥Ã´ should handle token with newlines
       Î“Â£Ã´ should handle very long invalid token  1219ms
       Î“Â£Ã´ should handle empty Authorization header  1253ms
       Î“Â£Ã´ should handle Authorization header with only Bearer  1254ms
       Î“Â£Ã´ should handle multiple Authorization headers  1286ms
       Î“Â£Ã´ should reject token with SQL injection attempt  1281ms
       Î“Â£Ã´ should reject token with XSS attempt  1340ms
       Î“Â£Ã´ should reject token with missing userId  1259ms
       â”œÃ¹ should reject token with non-existent userId 1260ms
       â”œÃ¹ should not allow user to access another user's resources 758ms
       â”œÃ¹ should inject userId into request context 949ms
       â”œÃ¹ should inject tenantId into request context 818ms
       â”œÃ¹ should inject role into request context 818ms
       â”œÃ¹ should not apply general rate limiting to authenticated requests 1028ms
       â”œÃ¹ should handle request with both Bearer token and cookies 882ms
       â”œÃ¹ should prioritize Bearer token over cookie when both present 789ms
       â”œÃ¹ should allow unauthenticated access to optional auth routes 744ms
       â”œÃ¹ should enhance optional auth routes with user context when authenticated 902ms

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 12 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:84:14
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/12]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
Error: expected 200 "OK", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:84:14
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/12]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Error: expected 201 "Created", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:56:14
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/12]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
Error: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 732c2946-cb1a-478c-8765-963966b6983f,d21d2dad-e868-44e3-8581-0ffa94e5961b,admin
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:71:13

Caused by: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:71:13

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 399, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(732c2946-cb1a-478c-8765-963966b6983f) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/12]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  12 failed | 20 passed | 1 skipped (33)
   Start at  14:24:19
   Duration  54.94s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x13 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681688099,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stderr | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Failed to create schema test_schema_w0_v3: error: Too many connections attempts
    at Parser.parseErrorMessage (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:285:98)
    at Parser.handlePacket (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:122:29)
    at Parser.parse (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:35:38)
    at TLSSocket.<anonymous> (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\index.js:11:42)
    at TLSSocket.emit (node:events:508:28)
    at addChunk (node:internal/streams/readable:559:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
    at TLSSocket.Readable.push (node:internal/streams/readable:390:5)
    at TLSWrap.onStreamRead (node:internal/stream_base_commons:189:23) {
  length: 50,
  severity: 'ERROR',
  code: 'XX000',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: undefined,
  line: undefined,
  routine: undefined
}

stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): error: Too many connections attempts
    at Parser.parseErrorMessage (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:285:98)
    at Parser.handlePacket (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:122:29)
    at Parser.parse (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:35:38)
    at TLSSocket.<anonymous> (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\index.js:11:42)
    at TLSSocket.emit (node:events:508:28)
    at addChunk (node:internal/streams/readable:559:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
    at TLSSocket.Readable.push (node:internal/streams/readable:390:5)
    at TLSWrap.onStreamRead (node:internal/stream_base_commons:189:23) {
  length: 50,
  severity: 'ERROR',
  code: 'XX000',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: undefined,
  line: undefined,
  routine: undefined
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

{"level":30,"time":1768681693876,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681693986,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681694009,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768681693989,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681693997,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681693998,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681694002,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681694003,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681694008,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681694008,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681694008,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681694009,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant oEBRYWyUf3tVJ2fdBY8zs,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant oEBRYWyUf3tVJ2fdBY8zs', 'pro' ],
  cause: error: Too many connections attempts
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 50,
    severity: 'ERROR',
    code: 'XX000',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 858ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant oEBRYWyUf3tVJ2fdBY8zs,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: Too many connections attempts
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 50, severity: 'ERROR', code: 'XX000', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:27:00
   Duration  68.85s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x14 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681705228,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681710034,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681710034,"env":"test","msg":"DB: Using test schema \"test_schema_w0_v3\" (via PGOPTIONS)"}
{"level":30,"time":1768681710201,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:196:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:196:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681710638,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681710663,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768681710646,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681710647,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681710652,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681710653,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681710662,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681710662,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681710663,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681710663,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant ZpMtjeIXzfGJscQ93X1Ez,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant ZpMtjeIXzfGJscQ93X1Ez', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768681711114,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768681711115,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1990ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant ZpMtjeIXzfGJscQ93X1Ez,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19

 Test Files  1 failed (1)
      Tests  33 skipped (33)
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 
   Start at  14:28:14

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»

   Duration  15.60s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x15 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681928330,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

{"level":30,"time":1768681963327,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681963328,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681968070,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681968424,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681968443,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768681968432,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681968432,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681968436,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681968436,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681968442,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681968442,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681968443,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681968443,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768681968816,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681968816,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:196:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:196:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 82UcusIge_nf-MtLsblTx,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant 82UcusIge_nf-MtLsblTx', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 6394ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 82UcusIge_nf-MtLsblTx,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:31:53
   Duration  50.32s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x16 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681996475,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681999227,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681999227,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768681999265,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681999556,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681999568,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768681999561,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681999561,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681999564,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681999564,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681999567,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681999568,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681999568,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681999568,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant JqX5sspUJ-Sc5HOpe4rmY,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant JqX5sspUJ-Sc5HOpe4rmY', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768681999928,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768681999928,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1689ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant JqX5sspUJ-Sc5HOpe4rmY,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:33:03
   Duration  10.97s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x17 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768688759147,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

{"level":30,"time":1768688770064,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768688770064,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768688778098,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768688778410,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768688778430,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768688778420,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768688778420,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768688778424,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768688778424,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768688778430,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768688778430,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768688778430,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768688778430,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768688778738,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768688778739,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant dG-enn7-CpzFiWHODkp3W,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant dG-enn7-CpzFiWHODkp3W', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 9521ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant dG-enn7-CpzFiWHODkp3W,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:25:36
   Duration  38.34s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x18 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768688872387,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

{"level":30,"time":1768688887768,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768688887769,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768688893063,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768688893368,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768688893387,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768688893376,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768688893377,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768688893382,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768688893382,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768688893386,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768688893386,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768688893386,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768688893387,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768688893689,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768688893690,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant urkG_aZC6n2gCynklUVtF,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant urkG_aZC6n2gCynklUVtF', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 6795ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant urkG_aZC6n2gCynklUVtF,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:26:39
   Duration  87.69s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x19 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768688929378,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768688942553,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768688942553,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768688942605,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768688942913,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768688942931,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768688942921,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768688942922,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768688942926,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768688942927,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768688942931,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768688942931,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768688942931,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768688942931,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant iLST1YOwumxLc7qjwmhmT,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant iLST1YOwumxLc7qjwmhmT', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768688943251,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768688943252,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1549ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant iLST1YOwumxLc7qjwmhmT,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:28:29
   Duration  28.76s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x20 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768689107438,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

{"level":30,"time":1768689134319,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768689134319,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768689137921,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768689138231,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768689138249,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768689138239,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768689138239,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768689138244,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768689138244,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768689138249,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768689138249,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768689138249,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768689138249,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768689138548,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768689138548,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant dxeaGw5H4QVYjnT2YRxkl,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant dxeaGw5H4QVYjnT2YRxkl', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 5200ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant dxeaGw5H4QVYjnT2YRxkl,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:31:36
   Duration  41.98s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x21 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768689238991,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768689248094,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768689248094,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768689248144,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768689248451,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768689248488,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768689248458,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768689248459,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768689248481,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768689248481,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768689248487,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768689248487,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768689248488,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768689248488,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 7bby6EvfiNDt_vfbxkrPQ,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant 7bby6EvfiNDt_vfbxkrPQ', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768689248804,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768689248804,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1646ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 7bby6EvfiNDt_vfbxkrPQ,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:33:48
   Duration  19.40s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x22 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768689259711,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

{"level":30,"time":1768689291841,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768689291842,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768689297030,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768689297334,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768689297351,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768689297341,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768689297341,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768689297347,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768689297347,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768689297351,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768689297351,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768689297351,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768689297351,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768689297670,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768689297670,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 8KlxsWlcNcj2ggzA5d9NU,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant 8KlxsWlcNcj2ggzA5d9NU', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 6645ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 8KlxsWlcNcj2ggzA5d9NU,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:34:08
   Duration  46.46s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x23 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768689333164,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768689338408,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768689338408,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768689338467,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768689338770,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768689338788,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768689338778,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768689338779,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768689338783,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768689338783,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768689338788,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768689338788,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768689338788,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768689338788,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 0N1itUSPgwvKyuQ9FIEHV,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant 0N1itUSPgwvKyuQ9FIEHV', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768689339092,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768689339092,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1570ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 0N1itUSPgwvKyuQ9FIEHV,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:35:15
   Duration  17.67s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x24 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768689372804,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768689382802,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768689382802,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768689382875,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768689383182,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768689383202,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768689383191,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768689383192,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768689383196,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768689383197,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768689383201,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768689383202,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768689383202,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768689383202,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant roDpsAZwlhIZb3OspGGHN,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant roDpsAZwlhIZb3OspGGHN', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768689383520,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768689383520,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1647ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant roDpsAZwlhIZb3OspGGHN,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:36:01
   Duration  21.29s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x25 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768690617016,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768690623453,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768690623454,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768690623519,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768690623824,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768690623845,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768690623833,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768690623834,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768690623839,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768690623840,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768690623844,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768690623844,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768690623845,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768690623845,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant Arspqy0n-EZVPUyh-8SzW,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant Arspqy0n-EZVPUyh-8SzW', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
{"level":30,"time":1768690624165,"env":"test","msg":"DB: closing pool..."}
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
{"level":30,"time":1768690624166,"env":"test","msg":"DB: pool closed."}
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1548ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant Arspqy0n-EZVPUyh-8SzW,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:56:43
   Duration  19.56s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x26 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768690698467,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768690742615,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768690742616,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768690744382,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768690744688,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768690744701,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768690744693,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768690744693,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768690744696,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768690744696,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768690744700,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768690744700,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768690744701,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768690744701,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768690744996,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768690744997,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 1gxh8hnb_NKQ9iZITspi1,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant 1gxh8hnb_NKQ9iZITspi1', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 3193ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 1gxh8hnb_NKQ9iZITspi1,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:58:08
   Duration  53.42s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x27 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768690764359,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768690779385,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768690779386,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768690782562,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768690782856,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768690782866,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768690782860,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768690782860,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768690782863,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768690782863,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768690782865,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768690782866,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768690782866,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768690782866,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768690783161,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768690783161,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant LF5A98ueIWPZkaB-o8nye,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant LF5A98ueIWPZkaB-o8nye', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 4581ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant LF5A98ueIWPZkaB-o8nye,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:59:08
   Duration  31.81s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x28 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768690809101,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768690813132,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768690813132,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768690813180,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768690813492,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768690813509,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768690813499,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768690813499,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768690813503,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768690813503,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768690813508,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768690813508,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768690813509,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768690813509,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant oXi8JPRVnRcBBnH1ojJz2,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
{"level":30,"time":1768690813825,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768690813825,"env":"test","msg":"DB: pool closed."}
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant oXi8JPRVnRcBBnH1ojJz2', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1567ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant oXi8JPRVnRcBBnH1ojJz2,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  16:59:59
   Duration  13.88s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/RunService.ts x29 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768690838083,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768690866045,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768690866046,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768690866086,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768690866379,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768690866396,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768690866386,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768690866386,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768690866391,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768690866391,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768690866395,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768690866395,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768690866396,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768690866396,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 0IwCwzmACsxM6KOi6i3Z8,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant 0IwCwzmACsxM6KOi6i3Z8', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768690866698,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768690866698,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1463ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 0IwCwzmACsxM6KOi6i3Z8,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:00:22
   Duration  42.09s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x30 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768690886536,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768690890499,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768690890500,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768690890554,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768690890874,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768690890894,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768690890883,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768690890884,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768690890888,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768690890889,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768690890893,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768690890893,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768690890894,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768690890894,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant KyGVz3-MrBnvwsucWQ1N_,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant KyGVz3-MrBnvwsucWQ1N_', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768690891203,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768690891204,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1560ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant KyGVz3-MrBnvwsucWQ1N_,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:01:18
   Duration  12.05s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x31 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768690902877,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768690906899,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768690906900,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768690906950,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768690907295,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768690907314,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768690907303,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768690907304,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768690907308,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768690907309,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768690907314,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768690907314,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768690907314,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768690907314,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant jmwgaNABHbcCPQ__iUQNR,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant jmwgaNABHbcCPQ__iUQNR', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768690907611,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768690907612,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1558ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant jmwgaNABHbcCPQ__iUQNR,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:01:31
   Duration  15.88s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/RunService.ts x32 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768690918929,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768690935613,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768690935614,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768690935667,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768690935971,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768690935992,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768690935981,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768690935981,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768690935986,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768690935987,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768690935992,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768690935992,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768690935992,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768690935992,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant BcVgSTi6Ko21GtrHZztiV,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant BcVgSTi6Ko21GtrHZztiV', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768690936304,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768690936305,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1539ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant BcVgSTi6Ko21GtrHZztiV,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:01:47
   Duration  28.03s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/RunService.ts x33 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768690994227,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768690998578,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768690998579,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768691001289,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768691001595,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768691001612,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768691001602,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768691001603,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768691001607,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768691001607,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768691001611,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768691001611,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768691001611,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768691001612,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768691001924,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768691001925,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 7337AWbCs5cAov0ogtYz6,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant 7337AWbCs5cAov0ogtYz6', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 4354ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 7337AWbCs5cAov0ogtYz6,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:02:46
   Duration  33.35s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x34 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768691057481,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768691065419,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768691065420,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768691065485,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768691065811,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768691065831,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768691065820,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768691065820,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768691065826,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768691065826,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768691065830,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768691065830,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768691065831,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768691065831,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant i-30PmsKaPIoIDFrv-ZNW,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant i-30PmsKaPIoIDFrv-ZNW', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768691066213,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1693ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated
{"level":30,"time":1768691066214,"env":"test","msg":"DB: pool closed."}

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant i-30PmsKaPIoIDFrv-ZNW,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:03:37
   Duration  43.63s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x35 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768691078798,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768691081650,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768691081651,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768691081699,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768691081997,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768691082016,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768691082005,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768691082006,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768691082010,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768691082011,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768691082016,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768691082016,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768691082016,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768691082016,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant U1zf32ICpMhu7534EdRWy,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant U1zf32ICpMhu7534EdRWy', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768691082327,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768691082328,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1523ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant U1zf32ICpMhu7534EdRWy,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:04:26
   Duration  15.36s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x36 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768691122976,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768691129876,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768691129877,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768691129930,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768691130242,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768691130262,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768691130251,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768691130251,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768691130256,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768691130256,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768691130261,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768691130261,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768691130261,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768691130262,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 7RchUOpvuk20kUC0fVYEr,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant 7RchUOpvuk20kUC0fVYEr', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768691130578,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1616ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated
{"level":30,"time":1768691130579,"env":"test","msg":"DB: pool closed."}

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 7RchUOpvuk20kUC0fVYEr,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:05:12
   Duration  17.31s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/RunService.ts x37 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768691226493,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768691275472,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768691275472,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

stderr | tests/integration/auth/protected.routes.test.ts
{"level":30,"time":1768691279098,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768691279407,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768691279423,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768691279415,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768691279415,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768691279419,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768691279419,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
{"level":30,"time":1768691279422,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
{"level":40,"time":1768691279422,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768691279423,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768691279423,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768691279734,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768691279734,"env":"test","msg":"DB: pool closed."}
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant XYrBGCVP6WnI9KGNvQvhA,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant XYrBGCVP6WnI9KGNvQvhA', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 5179ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant XYrBGCVP6WnI9KGNvQvhA,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:06:18
   Duration  99.23s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x38 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768691292001,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768691294466,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768691294467,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768691294501,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768691294792,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768691294807,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768691294799,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768691294799,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768691294803,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768691294803,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768691294807,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768691294807,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768691294807,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768691294807,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant m1XzB1pZNP5rBDUQ4z9tL,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant m1XzB1pZNP5rBDUQ4z9tL', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768691295111,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768691295111,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1484ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant m1XzB1pZNP5rBDUQ4z9tL,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:08:02
   Duration  8.15s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/middleware/auth.ts x39 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test


Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
TypeError: Router.use() requires a middleware function
 Î“Â¥Â» router.use node_modules/express/lib/router/index.js:462:11
 Î“Â¥Â» server/routes/ai.doc.routes.ts:73:8
     71| 
     72| // Middleware
     73| router.use(hybridAuth);
       |        ^
     74| 
     75| /**
 Î“Â¥Â» server/routes/index.ts:9:1
 Î“Â¥Â» server/routes.ts:11:1
 Î“Â¥Â» tests/helpers/integrationTestHelper.ts:23:1

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/1]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  no tests
   Start at  17:50:27
   Duration  237ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/middleware/auth.ts x40 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test


Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
TypeError: Router.use() requires a middleware function
 Î“Â¥Â» router.use node_modules/express/lib/router/index.js:462:11
 Î“Â¥Â» server/routes/ai.doc.routes.ts:73:8
     71| 
     72| // Middleware
     73| router.use(hybridAuth);
       |        ^
     74| 
     75| /**
 Î“Â¥Â» server/routes/index.ts:9:1
 Î“Â¥Â» server/routes.ts:11:1
 Î“Â¥Â» tests/helpers/integrationTestHelper.ts:23:1

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/1]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  no tests
   Start at  17:50:40
   Duration  114ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/middleware/auth.ts x41 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768693881231,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768693922706,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768693922707,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768693922742,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768693923027,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768693923042,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768693923035,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768693923035,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768693923038,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768693923039,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768693923042,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768693923042,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768693923042,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768693923042,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant GzYUDGU4w1ofQR172JlOH,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant GzYUDGU4w1ofQR172JlOH', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768693923335,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768693923335,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1453ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant GzYUDGU4w1ofQR172JlOH,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:51:04
   Duration  58.77s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/RunService.ts x42 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768693961812,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768693969191,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768693969192,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768693971203,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768693971500,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768693971516,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768693971507,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768693971507,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768693971511,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768693971511,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768693971515,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768693971516,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768693971516,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768693971516,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768693971820,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768693971820,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant Y1-P4U6I2JuNMfhm6x2_w,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant Y1-P4U6I2JuNMfhm6x2_w', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 3479ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant Y1-P4U6I2JuNMfhm6x2_w,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:52:32
   Duration  19.18s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/RunService.ts x43 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768694013981,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

{"level":30,"time":1768694039281,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768694039281,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768694044232,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768694044539,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768694044556,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768694044546,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768694044547,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768694044551,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768694044551,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768694044555,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768694044556,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768694044556,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768694044556,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768694044843,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768694044843,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant ZLrc3YcB0BJ3cXSGqsdFn,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant ZLrc3YcB0BJ3cXSGqsdFn', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 6376ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant ZLrc3YcB0BJ3cXSGqsdFn,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:53:08
   Duration  46.72s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x44 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768694138809,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768694152688,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768694152689,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768694152740,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768694153039,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768694153058,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768694153047,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768694153048,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768694153052,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768694153053,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768694153058,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768694153058,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768694153058,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768694153058,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant i5ndlmtQLLrnEucFwcGkl,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant i5ndlmtQLLrnEucFwcGkl', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768694153393,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768694153394,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1569ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant i5ndlmtQLLrnEucFwcGkl,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:54:22
   Duration  83.19s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/RunService.ts x45 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768694157397,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768694159604,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768694159604,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768694159633,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768694159933,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768694159949,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768694159940,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768694159941,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768694159944,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768694159944,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768694159948,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768694159948,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768694159949,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768694159949,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant RXVxrhPNcbDEkApmfhVQv,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant RXVxrhPNcbDEkApmfhVQv', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768694160257,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768694160257,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1489ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant RXVxrhPNcbDEkApmfhVQv,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  17:55:53
   Duration  6.37s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x46 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768694467591,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768694472722,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768694472723,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768694472771,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768694473069,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768694473089,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768694473078,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768694473078,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768694473084,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768694473084,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768694473089,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768694473089,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768694473089,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768694473089,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant IFkad31lTqEcHBPwoHLZr,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant IFkad31lTqEcHBPwoHLZr', 'pro' ],
  cause: error: Too many connections attempts
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 50,
    severity: 'ERROR',
    code: 'XX000',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768694473383,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768694473383,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1521ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant IFkad31lTqEcHBPwoHLZr,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: Too many connections attempts
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 50, severity: 'ERROR', code: 'XX000', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:00:46
   Duration  25.98s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x47 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768694490792,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768694494566,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768694494567,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768694494619,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768694494928,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768694494948,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768694494936,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768694494937,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768694494942,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768694494942,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768694494947,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768694494947,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768694494948,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768694494948,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant Mwe_G9IBY6xb9UMoHaO1U,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant Mwe_G9IBY6xb9UMoHaO1U', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768694495251,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768694495251,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1579ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant Mwe_G9IBY6xb9UMoHaO1U,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:01:14
   Duration  19.64s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x48 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768694516775,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768694599136,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768694599136,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768694606032,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768694606343,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768694606361,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768694606351,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768694606352,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768694606356,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768694606356,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768694606360,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768694606361,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768694606361,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768694606361,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768694606680,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768694606680,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant hovPG6ioMqqrLhGZ-wVcj,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant hovPG6ioMqqrLhGZ-wVcj', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 8608ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant hovPG6ioMqqrLhGZ-wVcj,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:01:39
   Duration  102.71s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x49 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768694726986,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768694767900,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768694767901,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768694775517,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768694775842,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768694775864,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768694775852,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768694775853,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768694775858,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768694775858,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768694775863,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768694775863,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768694775864,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768694775864,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768694776192,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768694776193,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant JBimp8WQ4Oo-hqXY2eRQ0,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant JBimp8WQ4Oo-hqXY2eRQ0', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 9290ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant JBimp8WQ4Oo-hqXY2eRQ0,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:03:49
   Duration  137.32s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x50 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768694816245,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768694820302,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768694820303,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768694820351,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768694820733,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768694820757,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768694820742,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768694820743,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768694820751,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768694820751,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768694820757,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768694820757,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768694820757,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768694820757,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant cxlp_10XNs0psit4zcYX5,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant cxlp_10XNs0psit4zcYX5', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768694821082,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768694821083,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1683ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant cxlp_10XNs0psit4zcYX5,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:06:36
   Duration  17.75s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/WorkflowService.ts x51 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768694865124,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768694867913,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768694867914,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768694867959,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768694868257,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768694868268,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768694868262,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768694868262,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768694868265,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768694868265,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768694868268,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768694868268,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768694868268,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768694868268,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 5g1t2TRCsoEXnHIA9soKa,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant 5g1t2TRCsoEXnHIA9soKa', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768694868575,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768694868576,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1479ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 5g1t2TRCsoEXnHIA9soKa,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:07:20
   Duration  21.17s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x52 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768695008760,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768695020873,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768695020874,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768695020925,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768695021238,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768695021260,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768695021248,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768695021248,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768695021254,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768695021254,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768695021259,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768695021259,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768695021259,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768695021260,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 08DmDoiBBO1d5mewJIlgN,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant 08DmDoiBBO1d5mewJIlgN', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768695021583,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768695021584,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1583ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 08DmDoiBBO1d5mewJIlgN,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:09:55
   Duration  26.01s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x53 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768695197773,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 6ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
ReferenceError: properties is not defined
 Î“Â¥Â» shouldConnectToDb tests/setup.ts:105:90
 Î“Â¥Â» tests/setup.ts:127:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/1]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:12:00
   Duration  91.18s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x54 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768695348108,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SETUP] Check DB Connection: TEST_TYPE=undefined, DB_URL=PRESENT

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768695351152,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768695351153,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768695351204,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:201:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:201:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768695351523,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768695351542,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768695351532,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768695351532,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768695351536,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768695351537,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768695351541,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768695351541,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768695351542,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768695351542,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 3v59MGGkWb5e4oQ__bc-J,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant 3v59MGGkWb5e4oQ__bc-J', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768695351860,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768695351860,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1567ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 3v59MGGkWb5e4oQ__bc-J,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:13:32
   Duration  138.30s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x55 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768695357748,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768695360480,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768695360480,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768695360525,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768695360837,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768695360859,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768695360847,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768695360847,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768695360853,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768695360854,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768695360859,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768695360859,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768695360859,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768695360859,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant WaI-IQxX-UErcsqPOsNqZ,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant WaI-IQxX-UErcsqPOsNqZ', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768695361163,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768695361163,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1518ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant WaI-IQxX-UErcsqPOsNqZ,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:15:51
   Duration  8.72s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/integration/auth/protected.routes.test.ts x56 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768695564083,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

{"level":30,"time":1768695687256,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768695687257,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768695711311,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768695711612,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768695711628,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768695711619,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768695711619,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768695711623,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768695711623,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768695711627,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768695711627,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768695711628,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768695711628,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768695711953,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768695711954,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant ONdHh-O2gv0MhUL5R1LI_,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant ONdHh-O2gv0MhUL5R1LI_', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 25517ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant ONdHh-O2gv0MhUL5R1LI_,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/1]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  18:19:14
   Duration  157.36s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x57 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768702253376,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768702281266,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768702281266,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w0_v3\",public"}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768702306269,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768702306569,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768702306585,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768702306576,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768702306576,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768702306580,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768702306581,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768702306585,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768702306585,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768702306585,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768702306585,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768702306874,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768702306875,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:200:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant bwL5YT7uqi5pzDe8oQro2,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant bwL5YT7uqi5pzDe8oQro2', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 26448ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant bwL5YT7uqi5pzDe8oQro2,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/1]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  19:56:32
   Duration  867.24s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x58 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768702491130,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768702493929,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768702493930,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w0_v3\",public"}
{"level":30,"time":1768702493986,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Set default search_path for database: test_schema_w0_v3, public
Î“Â£Ã  Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
Î“Â£Ã  Current search_path: test_schema_w0_v3, public
Î“Ã…âŒ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768702495969,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768702495991,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768702495979,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768702495980,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768702495985,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768702495985,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768702495990,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768702495990,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768702495991,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768702495991,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768702496476,"env":"test","module":"user-credentials-repository","userId":"14c364b1-a62a-45de-83dd-97b5d28afe53","msg":"User credentials created"}
{"level":30,"time":1768702496573,"env":"test","module":"email-queue","jobId":"1175355c-882f-4cd6-83ef-01081f9c69d4","to":"test-iJYfB8QsfwsrpC8cAJMGq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702496624,"env":"test","module":"auth-routes","userId":"14c364b1-a62a-45de-83dd-97b5d28afe53","email":"test-iJYfB8QsfwsrpC8cAJMGq@example.com","msg":"User registered"}
{"level":30,"time":1768702497289,"env":"test","module":"user-credentials-repository","userId":"a0b9815a-5f95-4382-adf1-0ae6c33d61ba","msg":"User credentials created"}
{"level":30,"time":1768702497383,"env":"test","module":"email-queue","jobId":"f8176dc7-ba37-4ce7-b9bd-6a61ed880a39","to":"protected-test-LkXn6SaXzcpoD7c66yGCV@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702497430,"env":"test","module":"auth-routes","userId":"a0b9815a-5f95-4382-adf1-0ae6c33d61ba","email":"protected-test-LkXn6SaXzcpoD7c66yGCV@example.com","msg":"User registered"}
{"level":30,"time":1768702498057,"env":"test","module":"auth-routes","userId":"a0b9815a-5f95-4382-adf1-0ae6c33d61ba","msg":"User logged in successfully"}
{"level":30,"time":1768702498103,"env":"test","module":"audit-log-service","userId":"a0b9815a-5f95-4382-adf1-0ae6c33d61ba","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702498563,"env":"test","module":"user-credentials-repository","userId":"d4068a01-55d5-489e-ae80-598e6dfa5aa6","msg":"User credentials created"}
{"level":30,"time":1768702498655,"env":"test","module":"email-queue","jobId":"d551fcf0-28ad-4b81-9f6b-662437853d28","to":"protected-test-xafgY6GK5wEytvk-ecmxF@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702498702,"env":"test","module":"auth-routes","userId":"d4068a01-55d5-489e-ae80-598e6dfa5aa6","email":"protected-test-xafgY6GK5wEytvk-ecmxF@example.com","msg":"User registered"}
{"level":30,"time":1768702499315,"env":"test","module":"auth-routes","userId":"d4068a01-55d5-489e-ae80-598e6dfa5aa6","msg":"User logged in successfully"}
{"level":30,"time":1768702499363,"env":"test","module":"audit-log-service","userId":"d4068a01-55d5-489e-ae80-598e6dfa5aa6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702499369,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702499745,"env":"test","module":"user-credentials-repository","userId":"9e803b3e-8d8e-4d71-ad05-d22fb08c2c79","msg":"User credentials created"}
{"level":30,"time":1768702499849,"env":"test","module":"email-queue","jobId":"2d08ee1e-ca8a-4182-a290-1c3a9feb2838","to":"protected-test-_Dy63MeA2XMeANALbX8GI@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702499896,"env":"test","module":"auth-routes","userId":"9e803b3e-8d8e-4d71-ad05-d22fb08c2c79","email":"protected-test-_Dy63MeA2XMeANALbX8GI@example.com","msg":"User registered"}
{"level":30,"time":1768702500502,"env":"test","module":"auth-routes","userId":"9e803b3e-8d8e-4d71-ad05-d22fb08c2c79","msg":"User logged in successfully"}
{"level":30,"time":1768702500548,"env":"test","module":"audit-log-service","userId":"9e803b3e-8d8e-4d71-ad05-d22fb08c2c79","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702500554,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702501077,"env":"test","module":"user-credentials-repository","userId":"ee21ba3f-31a6-47bf-ae49-5d749fd4b6ed","msg":"User credentials created"}
{"level":30,"time":1768702501170,"env":"test","module":"email-queue","jobId":"0dfa3244-e399-4c8f-83be-c12ed3d4295e","to":"protected-test-HBiBuqSLYpYqRX0Lb69hg@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702501229,"env":"test","module":"auth-routes","userId":"ee21ba3f-31a6-47bf-ae49-5d749fd4b6ed","email":"protected-test-HBiBuqSLYpYqRX0Lb69hg@example.com","msg":"User registered"}
{"level":30,"time":1768702501834,"env":"test","module":"auth-routes","userId":"ee21ba3f-31a6-47bf-ae49-5d749fd4b6ed","msg":"User logged in successfully"}
{"level":30,"time":1768702501882,"env":"test","module":"audit-log-service","userId":"ee21ba3f-31a6-47bf-ae49-5d749fd4b6ed","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702501886,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702502255,"env":"test","module":"user-credentials-repository","userId":"cca39feb-1973-446e-b93d-1f34348e962d","msg":"User credentials created"}
{"level":30,"time":1768702502352,"env":"test","module":"email-queue","jobId":"09bd8476-427a-4fe3-a546-26b4c0e24392","to":"protected-test-rPHCetFV0sf9U-a9Zs5Ay@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702502398,"env":"test","module":"auth-routes","userId":"cca39feb-1973-446e-b93d-1f34348e962d","email":"protected-test-rPHCetFV0sf9U-a9Zs5Ay@example.com","msg":"User registered"}
{"level":30,"time":1768702502985,"env":"test","module":"auth-routes","userId":"cca39feb-1973-446e-b93d-1f34348e962d","msg":"User logged in successfully"}
{"level":30,"time":1768702503049,"env":"test","module":"audit-log-service","userId":"cca39feb-1973-446e-b93d-1f34348e962d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768702503053,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768702503054,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702503410,"env":"test","module":"user-credentials-repository","userId":"d2f256c1-6b29-45f3-91de-0ab7a2c8e7fd","msg":"User credentials created"}
{"level":30,"time":1768702503503,"env":"test","module":"email-queue","jobId":"01ddcbe2-defe-41ad-876d-8c8ee6b84591","to":"protected-test-hjgToR4NYRV4Lw2XoFFg8@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702503550,"env":"test","module":"auth-routes","userId":"d2f256c1-6b29-45f3-91de-0ab7a2c8e7fd","email":"protected-test-hjgToR4NYRV4Lw2XoFFg8@example.com","msg":"User registered"}
{"level":30,"time":1768702504150,"env":"test","module":"auth-routes","userId":"d2f256c1-6b29-45f3-91de-0ab7a2c8e7fd","msg":"User logged in successfully"}
{"level":30,"time":1768702504195,"env":"test","module":"audit-log-service","userId":"d2f256c1-6b29-45f3-91de-0ab7a2c8e7fd","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702504620,"env":"test","module":"user-credentials-repository","userId":"99ae182d-0b96-4be7-bc5d-05451c9986ab","msg":"User credentials created"}
{"level":30,"time":1768702504719,"env":"test","module":"email-queue","jobId":"1aab036b-58c6-47d6-899d-542462ba442a","to":"protected-test-Bb-xI2DmIovD6ac96E-ha@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702504767,"env":"test","module":"auth-routes","userId":"99ae182d-0b96-4be7-bc5d-05451c9986ab","email":"protected-test-Bb-xI2DmIovD6ac96E-ha@example.com","msg":"User registered"}
{"level":30,"time":1768702505392,"env":"test","module":"auth-routes","userId":"99ae182d-0b96-4be7-bc5d-05451c9986ab","msg":"User logged in successfully"}
{"level":30,"time":1768702505443,"env":"test","module":"audit-log-service","userId":"99ae182d-0b96-4be7-bc5d-05451c9986ab","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702505447,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702505817,"env":"test","module":"user-credentials-repository","userId":"54f3473b-43b2-4533-9de7-6391fded8e5b","msg":"User credentials created"}
{"level":30,"time":1768702505918,"env":"test","module":"email-queue","jobId":"b056cf34-8885-4bbd-8fd4-10443d949629","to":"protected-test--64EPAtvsIEtk0X4WLZLa@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702505964,"env":"test","module":"auth-routes","userId":"54f3473b-43b2-4533-9de7-6391fded8e5b","email":"protected-test--64EPAtvsIEtk0X4WLZLa@example.com","msg":"User registered"}
{"level":30,"time":1768702506582,"env":"test","module":"auth-routes","userId":"54f3473b-43b2-4533-9de7-6391fded8e5b","msg":"User logged in successfully"}
{"level":30,"time":1768702506640,"env":"test","module":"audit-log-service","userId":"54f3473b-43b2-4533-9de7-6391fded8e5b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702506646,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702507014,"env":"test","module":"user-credentials-repository","userId":"914f1926-7555-4d42-a837-2ea57aeb8670","msg":"User credentials created"}
{"level":30,"time":1768702507102,"env":"test","module":"email-queue","jobId":"d698643a-53ef-4bf1-9844-40e4c89c972b","to":"protected-test-SFBaU-dVGbf5LRmP95nxe@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702507150,"env":"test","module":"auth-routes","userId":"914f1926-7555-4d42-a837-2ea57aeb8670","email":"protected-test-SFBaU-dVGbf5LRmP95nxe@example.com","msg":"User registered"}
{"level":30,"time":1768702507736,"env":"test","module":"auth-routes","userId":"914f1926-7555-4d42-a837-2ea57aeb8670","msg":"User logged in successfully"}
{"level":30,"time":1768702507782,"env":"test","module":"audit-log-service","userId":"914f1926-7555-4d42-a837-2ea57aeb8670","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[DEBUG] BaseRepository.update users: id=914f1926-7555-4d42-a837-2ea57aeb8670, updates={"defaultMode":"advanced","updatedAt":"2026-01-18T02:15:07.879Z"}
{"level":30,"time":1768702508292,"env":"test","module":"user-credentials-repository","userId":"55cf9f60-c8aa-49eb-b98c-f262788d8a7e","msg":"User credentials created"}
{"level":30,"time":1768702508394,"env":"test","module":"email-queue","jobId":"6d6028f4-102b-4d07-8011-916091e8eca0","to":"protected-test-gCRoF8Bz8A_OX7zvA-MtL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702508446,"env":"test","module":"auth-routes","userId":"55cf9f60-c8aa-49eb-b98c-f262788d8a7e","email":"protected-test-gCRoF8Bz8A_OX7zvA-MtL@example.com","msg":"User registered"}
{"level":30,"time":1768702509072,"env":"test","module":"auth-routes","userId":"55cf9f60-c8aa-49eb-b98c-f262788d8a7e","msg":"User logged in successfully"}
{"level":30,"time":1768702509123,"env":"test","module":"audit-log-service","userId":"55cf9f60-c8aa-49eb-b98c-f262788d8a7e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702509128,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702509489,"env":"test","module":"user-credentials-repository","userId":"5abd6c49-8560-402c-ba4d-fbfe03acc337","msg":"User credentials created"}
{"level":30,"time":1768702509579,"env":"test","module":"email-queue","jobId":"627b7578-4497-461d-b8b3-c17abdcb98de","to":"protected-test-h0hud-BnFvs5IYjbt8c24@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702509625,"env":"test","module":"auth-routes","userId":"5abd6c49-8560-402c-ba4d-fbfe03acc337","email":"protected-test-h0hud-BnFvs5IYjbt8c24@example.com","msg":"User registered"}
{"level":30,"time":1768702510232,"env":"test","module":"auth-routes","userId":"5abd6c49-8560-402c-ba4d-fbfe03acc337","msg":"User logged in successfully"}
{"level":30,"time":1768702510279,"env":"test","module":"audit-log-service","userId":"5abd6c49-8560-402c-ba4d-fbfe03acc337","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702510859,"env":"test","module":"user-credentials-repository","userId":"2635f335-1397-4857-9c37-edb685e1a61a","msg":"User credentials created"}
{"level":30,"time":1768702510977,"env":"test","module":"email-queue","jobId":"f85b7168-b66d-4933-945c-5460049bf8fa","to":"protected-test-DD91iMmPQUqCDTRIE-x2-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702511023,"env":"test","module":"auth-routes","userId":"2635f335-1397-4857-9c37-edb685e1a61a","email":"protected-test-DD91iMmPQUqCDTRIE-x2-@example.com","msg":"User registered"}
{"level":30,"time":1768702511626,"env":"test","module":"auth-routes","userId":"2635f335-1397-4857-9c37-edb685e1a61a","msg":"User logged in successfully"}
{"level":30,"time":1768702511673,"env":"test","module":"audit-log-service","userId":"2635f335-1397-4857-9c37-edb685e1a61a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702511677,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702512045,"env":"test","module":"user-credentials-repository","userId":"fe0eea13-4c5d-4e29-b2bf-eaf8143808b7","msg":"User credentials created"}
{"level":30,"time":1768702512136,"env":"test","module":"email-queue","jobId":"0239cc0d-2d13-4641-927c-fe3eb0f3942c","to":"protected-test-Zx3w_1RS8-1OBoPeXedkl@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702512181,"env":"test","module":"auth-routes","userId":"fe0eea13-4c5d-4e29-b2bf-eaf8143808b7","email":"protected-test-Zx3w_1RS8-1OBoPeXedkl@example.com","msg":"User registered"}
{"level":30,"time":1768702512817,"env":"test","module":"auth-routes","userId":"fe0eea13-4c5d-4e29-b2bf-eaf8143808b7","msg":"User logged in successfully"}
{"level":30,"time":1768702512868,"env":"test","module":"audit-log-service","userId":"fe0eea13-4c5d-4e29-b2bf-eaf8143808b7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702513882,"env":"test","module":"user-credentials-repository","userId":"71025869-9680-4779-a834-261b77e1b3ba","msg":"User credentials created"}
{"level":30,"time":1768702513978,"env":"test","module":"email-queue","jobId":"484522ea-9729-43c1-9895-f915fe8607a4","to":"protected-test-5b1b6oHY_JlGnwzXf2_6q@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702514024,"env":"test","module":"auth-routes","userId":"71025869-9680-4779-a834-261b77e1b3ba","email":"protected-test-5b1b6oHY_JlGnwzXf2_6q@example.com","msg":"User registered"}
{"level":30,"time":1768702514635,"env":"test","module":"auth-routes","userId":"71025869-9680-4779-a834-261b77e1b3ba","msg":"User logged in successfully"}
{"level":30,"time":1768702514683,"env":"test","module":"audit-log-service","userId":"71025869-9680-4779-a834-261b77e1b3ba","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702514689,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702515066,"env":"test","module":"user-credentials-repository","userId":"cd5ff73c-c82e-4893-a6a3-97d63fd2307b","msg":"User credentials created"}
{"level":30,"time":1768702515169,"env":"test","module":"email-queue","jobId":"6844a666-0029-40ef-8d92-d32e62ee6005","to":"protected-test-NpV7wDklY0XI-i1WY_aCF@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702515219,"env":"test","module":"auth-routes","userId":"cd5ff73c-c82e-4893-a6a3-97d63fd2307b","email":"protected-test-NpV7wDklY0XI-i1WY_aCF@example.com","msg":"User registered"}
{"level":30,"time":1768702515829,"env":"test","module":"auth-routes","userId":"cd5ff73c-c82e-4893-a6a3-97d63fd2307b","msg":"User logged in successfully"}
{"level":30,"time":1768702515873,"env":"test","module":"audit-log-service","userId":"cd5ff73c-c82e-4893-a6a3-97d63fd2307b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768702515878,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768702515878,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702516303,"env":"test","module":"user-credentials-repository","userId":"d95f11d0-c5c9-411c-b2b8-e888b1caf182","msg":"User credentials created"}
{"level":30,"time":1768702516401,"env":"test","module":"email-queue","jobId":"a1a15633-a7f5-4442-b6f3-e2ce10cf8257","to":"protected-test-megQWQSRdcHMNiw0Eopbi@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702516451,"env":"test","module":"auth-routes","userId":"d95f11d0-c5c9-411c-b2b8-e888b1caf182","email":"protected-test-megQWQSRdcHMNiw0Eopbi@example.com","msg":"User registered"}
{"level":30,"time":1768702517030,"env":"test","module":"auth-routes","userId":"d95f11d0-c5c9-411c-b2b8-e888b1caf182","msg":"User logged in successfully"}
{"level":30,"time":1768702517080,"env":"test","module":"audit-log-service","userId":"d95f11d0-c5c9-411c-b2b8-e888b1caf182","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702517085,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702517445,"env":"test","module":"user-credentials-repository","userId":"f2db1dc7-8750-4111-8e6b-d99c5b84674b","msg":"User credentials created"}
{"level":30,"time":1768702517534,"env":"test","module":"email-queue","jobId":"f5e99f9e-d74c-4f02-b3d8-e035e02d214d","to":"protected-test-Fqg4DLb9I7tHIujN0ZNni@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702517586,"env":"test","module":"auth-routes","userId":"f2db1dc7-8750-4111-8e6b-d99c5b84674b","email":"protected-test-Fqg4DLb9I7tHIujN0ZNni@example.com","msg":"User registered"}
{"level":30,"time":1768702518169,"env":"test","module":"auth-routes","userId":"f2db1dc7-8750-4111-8e6b-d99c5b84674b","msg":"User logged in successfully"}
{"level":30,"time":1768702518217,"env":"test","module":"audit-log-service","userId":"f2db1dc7-8750-4111-8e6b-d99c5b84674b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702518220,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702518579,"env":"test","module":"user-credentials-repository","userId":"dc194f25-ae62-4f08-a773-f28f1baee498","msg":"User credentials created"}
{"level":30,"time":1768702518674,"env":"test","module":"email-queue","jobId":"bc99680a-44bd-48dd-a632-714501891ec5","to":"protected-test-Z-RbyS6tmJEOSx5h-YD5L@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702518720,"env":"test","module":"auth-routes","userId":"dc194f25-ae62-4f08-a773-f28f1baee498","email":"protected-test-Z-RbyS6tmJEOSx5h-YD5L@example.com","msg":"User registered"}
{"level":30,"time":1768702519302,"env":"test","module":"auth-routes","userId":"dc194f25-ae62-4f08-a773-f28f1baee498","msg":"User logged in successfully"}
{"level":30,"time":1768702519350,"env":"test","module":"audit-log-service","userId":"dc194f25-ae62-4f08-a773-f28f1baee498","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702519353,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702519719,"env":"test","module":"user-credentials-repository","userId":"19dc8c84-1e41-481e-8120-09f1587091f6","msg":"User credentials created"}
{"level":30,"time":1768702519817,"env":"test","module":"email-queue","jobId":"89ba3319-5fa1-4df0-92d8-bae9217a8f5d","to":"protected-test-rgHwjJvvy5Bj6rTJWlsh2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702519866,"env":"test","module":"auth-routes","userId":"19dc8c84-1e41-481e-8120-09f1587091f6","email":"protected-test-rgHwjJvvy5Bj6rTJWlsh2@example.com","msg":"User registered"}
{"level":30,"time":1768702520461,"env":"test","module":"auth-routes","userId":"19dc8c84-1e41-481e-8120-09f1587091f6","msg":"User logged in successfully"}
{"level":30,"time":1768702520510,"env":"test","module":"audit-log-service","userId":"19dc8c84-1e41-481e-8120-09f1587091f6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702520513,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702520879,"env":"test","module":"user-credentials-repository","userId":"30c0bc61-70ee-4e05-bbd6-b6d3e69d61a1","msg":"User credentials created"}
{"level":30,"time":1768702520977,"env":"test","module":"email-queue","jobId":"d8729e37-ee97-48d1-9e4d-4c10032cd199","to":"protected-test-DHjL-9NEKKpsjoufKPk26@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702521030,"env":"test","module":"auth-routes","userId":"30c0bc61-70ee-4e05-bbd6-b6d3e69d61a1","email":"protected-test-DHjL-9NEKKpsjoufKPk26@example.com","msg":"User registered"}
{"level":30,"time":1768702521626,"env":"test","module":"auth-routes","userId":"30c0bc61-70ee-4e05-bbd6-b6d3e69d61a1","msg":"User logged in successfully"}
{"level":30,"time":1768702521677,"env":"test","module":"audit-log-service","userId":"30c0bc61-70ee-4e05-bbd6-b6d3e69d61a1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702521681,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702522045,"env":"test","module":"user-credentials-repository","userId":"91f040d6-3d45-485a-9083-026ad0dd8941","msg":"User credentials created"}
{"level":30,"time":1768702522134,"env":"test","module":"email-queue","jobId":"b3e86215-cd33-44cd-a24b-b81aaffbf5b3","to":"protected-test-Sx7aqdX0paE7OuY6w505p@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702522181,"env":"test","module":"auth-routes","userId":"91f040d6-3d45-485a-9083-026ad0dd8941","email":"protected-test-Sx7aqdX0paE7OuY6w505p@example.com","msg":"User registered"}
{"level":30,"time":1768702522801,"env":"test","module":"auth-routes","userId":"91f040d6-3d45-485a-9083-026ad0dd8941","msg":"User logged in successfully"}
{"level":30,"time":1768702522846,"env":"test","module":"audit-log-service","userId":"91f040d6-3d45-485a-9083-026ad0dd8941","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768702522850,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768702523220,"env":"test","module":"user-credentials-repository","userId":"0224830f-44ab-42aa-afcc-0a254be04ea9","msg":"User credentials created"}
{"level":30,"time":1768702523314,"env":"test","module":"email-queue","jobId":"7d75f180-8d65-46cd-bd7f-0d65349df55a","to":"protected-test-tmP7j9ERfi4Bpz-rNsFPD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702523360,"env":"test","module":"auth-routes","userId":"0224830f-44ab-42aa-afcc-0a254be04ea9","email":"protected-test-tmP7j9ERfi4Bpz-rNsFPD@example.com","msg":"User registered"}
{"level":30,"time":1768702523970,"env":"test","module":"auth-routes","userId":"0224830f-44ab-42aa-afcc-0a254be04ea9","msg":"User logged in successfully"}
{"level":30,"time":1768702524016,"env":"test","module":"audit-log-service","userId":"0224830f-44ab-42aa-afcc-0a254be04ea9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702524396,"env":"test","module":"user-credentials-repository","userId":"41baf239-74a8-491f-911a-1d441f64ff83","msg":"User credentials created"}
{"level":30,"time":1768702524489,"env":"test","module":"email-queue","jobId":"77eca2eb-2921-49d5-b5e9-2c6204b2a87e","to":"protected-test-fVsRONvc0QkJQO98lFXW5@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702524534,"env":"test","module":"auth-routes","userId":"41baf239-74a8-491f-911a-1d441f64ff83","email":"protected-test-fVsRONvc0QkJQO98lFXW5@example.com","msg":"User registered"}
{"level":30,"time":1768702525133,"env":"test","module":"auth-routes","userId":"41baf239-74a8-491f-911a-1d441f64ff83","msg":"User logged in successfully"}
{"level":30,"time":1768702525178,"env":"test","module":"audit-log-service","userId":"41baf239-74a8-491f-911a-1d441f64ff83","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702525660,"env":"test","module":"user-credentials-repository","userId":"2ab779f0-dc77-4a26-9fc7-4e5f2f7da593","msg":"User credentials created"}
{"level":30,"time":1768702525756,"env":"test","module":"email-queue","jobId":"83f9fea5-8cc2-4bbd-8c6e-00919fb5df08","to":"protected-test-Wx2D2HBrXmOkf528pR4Y3@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702525804,"env":"test","module":"auth-routes","userId":"2ab779f0-dc77-4a26-9fc7-4e5f2f7da593","email":"protected-test-Wx2D2HBrXmOkf528pR4Y3@example.com","msg":"User registered"}
{"level":30,"time":1768702526420,"env":"test","module":"auth-routes","userId":"2ab779f0-dc77-4a26-9fc7-4e5f2f7da593","msg":"User logged in successfully"}
{"level":30,"time":1768702526467,"env":"test","module":"audit-log-service","userId":"2ab779f0-dc77-4a26-9fc7-4e5f2f7da593","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702526843,"env":"test","module":"user-credentials-repository","userId":"1179942e-1e28-4409-ace9-a4f47bb28c4e","msg":"User credentials created"}
{"level":30,"time":1768702526941,"env":"test","module":"email-queue","jobId":"5a3a1bd0-7f62-4e94-9c10-64ae62d47a8e","to":"user2-vYjLDeAJPBR7iuY26Dmae@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702526991,"env":"test","module":"auth-routes","userId":"1179942e-1e28-4409-ace9-a4f47bb28c4e","email":"user2-vYjLDeAJPBR7iuY26Dmae@example.com","msg":"User registered"}
{"level":30,"time":1768702527546,"env":"test","module":"auth-routes","userId":"1179942e-1e28-4409-ace9-a4f47bb28c4e","msg":"User logged in successfully"}
{"level":30,"time":1768702527597,"env":"test","module":"audit-log-service","userId":"1179942e-1e28-4409-ace9-a4f47bb28c4e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768702527648,"env":"test","module":"rbac-middleware","userId":"1179942e-1e28-4409-ace9-a4f47bb28c4e","userRole":"viewer","permission":"project:delete","path":"/e83903d9-5e75-4871-96f9-53c51425b957","msg":"Permission denied"}
{"level":30,"time":1768702528024,"env":"test","module":"user-credentials-repository","userId":"e461bc8f-99d9-474d-97f2-6ad2d284482e","msg":"User credentials created"}
{"level":30,"time":1768702528120,"env":"test","module":"email-queue","jobId":"e97e0d54-c463-49c7-a9e1-87daca67586a","to":"protected-test-4J19cZYv_8VoLLyrXdh_Y@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702528168,"env":"test","module":"auth-routes","userId":"e461bc8f-99d9-474d-97f2-6ad2d284482e","email":"protected-test-4J19cZYv_8VoLLyrXdh_Y@example.com","msg":"User registered"}
{"level":30,"time":1768702528764,"env":"test","module":"auth-routes","userId":"e461bc8f-99d9-474d-97f2-6ad2d284482e","msg":"User logged in successfully"}
{"level":30,"time":1768702528810,"env":"test","module":"audit-log-service","userId":"e461bc8f-99d9-474d-97f2-6ad2d284482e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702529228,"env":"test","module":"user-credentials-repository","userId":"43a9bd40-a734-4d10-bfbc-271c3a7a0cac","msg":"User credentials created"}
{"level":30,"time":1768702529317,"env":"test","module":"email-queue","jobId":"faf6debc-c05c-4919-af60-37813a1e8b73","to":"protected-test-toBDClK9rw5S-_ITvzudG@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702529365,"env":"test","module":"auth-routes","userId":"43a9bd40-a734-4d10-bfbc-271c3a7a0cac","email":"protected-test-toBDClK9rw5S-_ITvzudG@example.com","msg":"User registered"}
{"level":30,"time":1768702529957,"env":"test","module":"auth-routes","userId":"43a9bd40-a734-4d10-bfbc-271c3a7a0cac","msg":"User logged in successfully"}
{"level":30,"time":1768702530004,"env":"test","module":"audit-log-service","userId":"43a9bd40-a734-4d10-bfbc-271c3a7a0cac","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702530450,"env":"test","module":"user-credentials-repository","userId":"fcfd8a31-8543-4e83-bed6-0fe77231bb12","msg":"User credentials created"}
{"level":30,"time":1768702530540,"env":"test","module":"email-queue","jobId":"f43d78ba-c1bc-4ba6-8d02-b48c38b57c40","to":"protected-test-i6WbWTjhXrUPwDB3mzsTu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702530587,"env":"test","module":"auth-routes","userId":"fcfd8a31-8543-4e83-bed6-0fe77231bb12","email":"protected-test-i6WbWTjhXrUPwDB3mzsTu@example.com","msg":"User registered"}
{"level":30,"time":1768702531194,"env":"test","module":"auth-routes","userId":"fcfd8a31-8543-4e83-bed6-0fe77231bb12","msg":"User logged in successfully"}
{"level":30,"time":1768702531246,"env":"test","module":"audit-log-service","userId":"fcfd8a31-8543-4e83-bed6-0fe77231bb12","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702531669,"env":"test","module":"user-credentials-repository","userId":"10d06f50-c144-4a38-9d1f-806701fa6b0c","msg":"User credentials created"}
{"level":30,"time":1768702531765,"env":"test","module":"email-queue","jobId":"a99d8eb5-e55b-41da-a691-689a866ca474","to":"protected-test-T89EiKZOC196E9OpJZSJx@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702531817,"env":"test","module":"auth-routes","userId":"10d06f50-c144-4a38-9d1f-806701fa6b0c","email":"protected-test-T89EiKZOC196E9OpJZSJx@example.com","msg":"User registered"}
{"level":30,"time":1768702532420,"env":"test","module":"auth-routes","userId":"10d06f50-c144-4a38-9d1f-806701fa6b0c","msg":"User logged in successfully"}
{"level":30,"time":1768702532473,"env":"test","module":"audit-log-service","userId":"10d06f50-c144-4a38-9d1f-806701fa6b0c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702533346,"env":"test","module":"user-credentials-repository","userId":"8b058c1d-76ac-4db3-b053-fcf27ba3c753","msg":"User credentials created"}
{"level":30,"time":1768702533436,"env":"test","module":"email-queue","jobId":"8d2cb9d0-cacc-47f1-bcbc-2e3ec8760d89","to":"protected-test-gYCGl44c4BgZbdDPxNW7v@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702533506,"env":"test","module":"auth-routes","userId":"8b058c1d-76ac-4db3-b053-fcf27ba3c753","email":"protected-test-gYCGl44c4BgZbdDPxNW7v@example.com","msg":"User registered"}
{"level":30,"time":1768702534107,"env":"test","module":"auth-routes","userId":"8b058c1d-76ac-4db3-b053-fcf27ba3c753","msg":"User logged in successfully"}
{"level":30,"time":1768702534162,"env":"test","module":"audit-log-service","userId":"8b058c1d-76ac-4db3-b053-fcf27ba3c753","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702534662,"env":"test","module":"auth-routes","userId":"8b058c1d-76ac-4db3-b053-fcf27ba3c753","msg":"User logged in successfully"}
{"level":30,"time":1768702534707,"env":"test","module":"audit-log-service","userId":"8b058c1d-76ac-4db3-b053-fcf27ba3c753","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702535130,"env":"test","module":"user-credentials-repository","userId":"c3ab638b-e1f3-4744-a3f8-2a2ec869ff85","msg":"User credentials created"}
{"level":30,"time":1768702535225,"env":"test","module":"email-queue","jobId":"be786dfd-ed0f-48fa-96c0-23fec3e200bf","to":"protected-test-qB7ZY_C6ZU1Y-lHcrKn-5@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702535271,"env":"test","module":"auth-routes","userId":"c3ab638b-e1f3-4744-a3f8-2a2ec869ff85","email":"protected-test-qB7ZY_C6ZU1Y-lHcrKn-5@example.com","msg":"User registered"}
{"level":30,"time":1768702535885,"env":"test","module":"auth-routes","userId":"c3ab638b-e1f3-4744-a3f8-2a2ec869ff85","msg":"User logged in successfully"}
{"level":30,"time":1768702535932,"env":"test","module":"audit-log-service","userId":"c3ab638b-e1f3-4744-a3f8-2a2ec869ff85","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702536434,"env":"test","module":"auth-routes","userId":"c3ab638b-e1f3-4744-a3f8-2a2ec869ff85","msg":"User logged in successfully"}
{"level":30,"time":1768702536481,"env":"test","module":"audit-log-service","userId":"c3ab638b-e1f3-4744-a3f8-2a2ec869ff85","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702536850,"env":"test","module":"user-credentials-repository","userId":"2fbeb4f3-7ae7-43ba-8026-f9538749f8eb","msg":"User credentials created"}
{"level":30,"time":1768702536946,"env":"test","module":"email-queue","jobId":"744213cb-ac4e-4396-a17e-5ff367c2037c","to":"user2-E8mYVRbF2yyHXj5Zi_Y6I@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702536997,"env":"test","module":"auth-routes","userId":"2fbeb4f3-7ae7-43ba-8026-f9538749f8eb","email":"user2-E8mYVRbF2yyHXj5Zi_Y6I@example.com","msg":"User registered"}
{"level":30,"time":1768702537500,"env":"test","module":"auth-routes","userId":"2fbeb4f3-7ae7-43ba-8026-f9538749f8eb","msg":"User logged in successfully"}
{"level":30,"time":1768702537546,"env":"test","module":"audit-log-service","userId":"2fbeb4f3-7ae7-43ba-8026-f9538749f8eb","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702538007,"env":"test","module":"user-credentials-repository","userId":"3bf0faeb-0903-4688-946f-2817ad05d184","msg":"User credentials created"}
{"level":30,"time":1768702538101,"env":"test","module":"email-queue","jobId":"0ead80cc-b5a5-409f-a99d-13588f1afd61","to":"protected-test-SPcKWpalGKGeYLQ1WwXhu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702538146,"env":"test","module":"auth-routes","userId":"3bf0faeb-0903-4688-946f-2817ad05d184","email":"protected-test-SPcKWpalGKGeYLQ1WwXhu@example.com","msg":"User registered"}
{"level":30,"time":1768702538742,"env":"test","module":"auth-routes","userId":"3bf0faeb-0903-4688-946f-2817ad05d184","msg":"User logged in successfully"}
{"level":30,"time":1768702538789,"env":"test","module":"audit-log-service","userId":"3bf0faeb-0903-4688-946f-2817ad05d184","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702539292,"env":"test","module":"intake-service","runId":"44ef4e73-3aa0-4bb0-9f41-ae88a80c1d04","slug":"public-IOZp724k3_J1hEzjzGMej","msg":"Created intake run"}
{"level":30,"time":1768702539715,"env":"test","module":"user-credentials-repository","userId":"4d195705-eaff-4519-8a42-edae9ed53ab2","msg":"User credentials created"}
{"level":30,"time":1768702539807,"env":"test","module":"email-queue","jobId":"6f9f2f2b-4e46-455a-bf3e-7d09528456e2","to":"protected-test-Xu74FE5ULx7fEednEyBLi@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768702539857,"env":"test","module":"auth-routes","userId":"4d195705-eaff-4519-8a42-edae9ed53ab2","email":"protected-test-Xu74FE5ULx7fEednEyBLi@example.com","msg":"User registered"}
{"level":30,"time":1768702540465,"env":"test","module":"auth-routes","userId":"4d195705-eaff-4519-8a42-edae9ed53ab2","msg":"User logged in successfully"}
{"level":30,"time":1768702540514,"env":"test","module":"audit-log-service","userId":"4d195705-eaff-4519-8a42-edae9ed53ab2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768702541000,"env":"test","module":"intake-service","runId":"9345a927-034b-4ac8-9c82-cce4988e9dee","slug":"optional-_XzSX7-r8iWuuglsLoJgF","userId":"4d195705-eaff-4519-8a42-edae9ed53ab2","msg":"Created intake run"}
{"level":30,"time":1768702541368,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768702541369,"env":"test","msg":"DB: pool closed."}
 Î“Â£Ã´ tests/integration/auth/protected.routes.test.ts (33 tests | 1 skipped) 48272ms
       Î“Â£Ã´ should allow access with valid Bearer token  1256ms
       Î“Â£Ã´ should reject access without Authorization header  1206ms
       Î“Â£Ã´ should reject access with empty Bearer token  1185ms
       Î“Â£Ã´ should reject access with malformed Authorization header  1332ms
       Î“Â£Ã´ should reject access with wrong token type  1167ms
       Î“Â£Ã´ should allow POST with valid Bearer token  1196ms
       Î“Â£Ã´ should reject POST without Bearer token  1196ms
       Î“Â£Ã´ should reject POST with invalid token  1199ms
       Î“Â£Ã´ should allow PUT with valid Bearer token  1282ms
       Î“Â£Ã´ should reject PUT without Bearer token  1200ms
       Î“Â£Ã´ should allow DELETE with valid Bearer token  1301ms
       Î“Â£Ã´ should reject DELETE without Bearer token  1248ms
       Î“Â£Ã´ should allow PATCH with valid Bearer token  1828ms
       Î“Â£Ã´ should reject PATCH without Bearer token  1184ms
       Î“Â£Ã´ should handle Bearer token with extra spaces  1189ms
       Î“Â£Ã´ should handle very long invalid token  1206ms
       Î“Â£Ã´ should handle empty Authorization header  1135ms
       Î“Â£Ã´ should handle Authorization header with only Bearer  1134ms
       Î“Â£Ã´ should handle multiple Authorization headers  1161ms
       Î“Â£Ã´ should reject token with SQL injection attempt  1166ms
       Î“Â£Ã´ should reject token with XSS attempt  1168ms
       Î“Â£Ã´ should reject token with missing userId  1172ms
       Î“Â£Ã´ should reject token with non-existent userId  1258ms
       Î“Â£Ã´ should not allow user to access another user's resources  2368ms
       Î“Â£Ã´ should inject userId into request context  1213ms
       Î“Â£Ã´ should inject tenantId into request context  1193ms
       Î“Â£Ã´ should inject role into request context  1249ms
       Î“Â£Ã´ should not apply general rate limiting to authenticated requests  1662ms
       Î“Â£Ã´ should handle request with both Bearer token and cookies  1793ms
       Î“Â£Ã´ should prioritize Bearer token over cookie when both present  2883ms
       Î“Â£Ã´ should allow unauthenticated access to optional auth routes  1698ms
       Î“Â£Ã´ should enhance optional auth routes with user context when authenticated  1764ms

 Test Files  1 passed (1)
      Tests  32 passed | 1 skipped (33)
   Start at  20:13:10
   Duration  150.16s

 PASS  Waiting for file changes...
       press h to show help, press q to quit
