
[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768608025559,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768608025660,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768608025699,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: public
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":30,"time":1768608027691,"env":"test","module":"user-credentials-repository","userId":"1YKoAtXMFfaYjOxyuF6OP","msg":"User credentials created"}
{"level":30,"time":1768608027912,"env":"test","module":"auth-routes","userId":"1YKoAtXMFfaYjOxyuF6OP","sessionCount":2,"msg":"Listed active sessions"}
{"level":30,"time":1768608028247,"env":"test","module":"user-credentials-repository","userId":"3v8lLWlXsRpXitpabu8rf","msg":"User credentials created"}
{"level":30,"time":1768608028364,"env":"test","module":"auth-routes","userId":"3v8lLWlXsRpXitpabu8rf","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768608028691,"env":"test","module":"user-credentials-repository","userId":"Xjn07D4oSi56bOTjfK_ws","msg":"User credentials created"}
{"level":30,"time":1768608028804,"env":"test","module":"auth-routes","userId":"Xjn07D4oSi56bOTjfK_ws","sessionCount":0,"msg":"Listed active sessions"}
{"level":30,"time":1768608029141,"env":"test","module":"user-credentials-repository","userId":"DWj7yoJQ1_r6l9VmiM-sJ","msg":"User credentials created"}
{"level":30,"time":1768608029265,"env":"test","module":"auth-routes","userId":"DWj7yoJQ1_r6l9VmiM-sJ","sessionCount":0,"msg":"Listed active sessions"}
{"level":30,"time":1768608029608,"env":"test","module":"user-credentials-repository","userId":"8u0QN3aepSY2g3RBs1JCF","msg":"User credentials created"}
{"level":30,"time":1768608029791,"env":"test","module":"auth-routes","userId":"8u0QN3aepSY2g3RBs1JCF","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768608030129,"env":"test","module":"user-credentials-repository","userId":"DIc4dtJDDM3kqLQ84V2Rd","msg":"User credentials created"}
{"level":30,"time":1768608030248,"env":"test","module":"auth-routes","userId":"DIc4dtJDDM3kqLQ84V2Rd","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768608030590,"env":"test","module":"user-credentials-repository","userId":"2hV-H5oaM2vxJtFemLwbE","msg":"User credentials created"}
{"level":50,"time":1768608030593,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768608030924,"env":"test","module":"user-credentials-repository","userId":"1toeA7B4dutW_PBTjZwHD","msg":"User credentials created"}
{"level":30,"time":1768608031155,"env":"test","module":"auth-routes","userId":"1toeA7B4dutW_PBTjZwHD","sessionId":"35e9e185-ac56-4c8d-921f-184e99637f34","msg":"Session revoked"}
{"level":30,"time":1768608031547,"env":"test","module":"user-credentials-repository","userId":"Oj_oHFrENd3ghRe00Voml","msg":"User credentials created"}
{"level":30,"time":1768608031895,"env":"test","module":"user-credentials-repository","userId":"b6r3oS7jlHfYw7xR8jhU7","msg":"User credentials created"}
{"level":30,"time":1768608032392,"env":"test","module":"user-credentials-repository","userId":"FjRrwo1WMPf29K5kxuCSE","msg":"User credentials created"}
{"level":30,"time":1768608032966,"env":"test","module":"user-credentials-repository","userId":"-nVfG8ZYc33l76ndBtEeM","msg":"User credentials created"}
{"level":50,"time":1768608032969,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768608033301,"env":"test","module":"user-credentials-repository","userId":"yHTFyfrK5nxVdbw8ekqcP","msg":"User credentials created"}
{"level":30,"time":1768608033740,"env":"test","module":"auth-routes","userId":"yHTFyfrK5nxVdbw8ekqcP","msg":"All other sessions revoked"}
{"level":50,"time":1768608033784,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"yHTFyfrK5nxVdbw8ekqcP","all_sessions_revoked","security","yHTFyfrK5nxVdbw8ekqcP","security","yHTFyfrK5nxVdbw8ekqcP",null,"::ffff:127.0.0.1",null,"2026-01-17T00:00:33.740Z"],"cause":{"length":134,"name":"error","severity":"ERROR","code":"42703","position":"83","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"yHTFyfrK5nxVdbw8ekqcP","eventType":"all_sessions_revoked","msg":"Failed to log security event"}
{"level":50,"time":1768608033787,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"yHTFyfrK5nxVdbw8ekqcP","all_sessions_revoked","security","yHTFyfrK5nxVdbw8ekqcP","security","yHTFyfrK5nxVdbw8ekqcP",null,"::ffff:127.0.0.1",null,"2026-01-17T00:00:33.740Z"],"cause":{"length":134,"name":"error","severity":"ERROR","code":"42703","position":"83","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Error revoking all sessions"}
{"level":30,"time":1768608034104,"env":"test","module":"user-credentials-repository","userId":"aGFbPJ3NqOv3PSxf8pk83","msg":"User credentials created"}
{"level":30,"time":1768608034301,"env":"test","module":"auth-routes","userId":"aGFbPJ3NqOv3PSxf8pk83","msg":"All other sessions revoked"}
{"level":50,"time":1768608034348,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"aGFbPJ3NqOv3PSxf8pk83","all_sessions_revoked","security","aGFbPJ3NqOv3PSxf8pk83","security","aGFbPJ3NqOv3PSxf8pk83",null,"::ffff:127.0.0.1",null,"2026-01-17T00:00:34.302Z"],"cause":{"length":134,"name":"error","severity":"ERROR","code":"42703","position":"83","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"aGFbPJ3NqOv3PSxf8pk83","eventType":"all_sessions_revoked","msg":"Failed to log security event"}
{"level":50,"time":1768608034349,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"aGFbPJ3NqOv3PSxf8pk83","all_sessions_revoked","security","aGFbPJ3NqOv3PSxf8pk83","security","aGFbPJ3NqOv3PSxf8pk83",null,"::ffff:127.0.0.1",null,"2026-01-17T00:00:34.302Z"],"cause":{"length":134,"name":"error","severity":"ERROR","code":"42703","position":"83","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Error revoking all sessions"}
{"level":30,"time":1768608034689,"env":"test","module":"user-credentials-repository","userId":"lw-cEwvnP8rODg7k3YpI4","msg":"User credentials created"}
{"level":30,"time":1768608035026,"env":"test","module":"user-credentials-repository","userId":"nRN_CQOnu2tFZqYj_b8Ij","msg":"User credentials created"}
{"level":50,"time":1768608035028,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768608035366,"env":"test","module":"user-credentials-repository","userId":"Vks6aRFaeEa74-Q0NL7Oz","msg":"User credentials created"}
{"level":30,"time":1768608035501,"env":"test","module":"auth-routes","userId":"Vks6aRFaeEa74-Q0NL7Oz","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":30,"time":1768608035898,"env":"test","module":"user-credentials-repository","userId":"TL9DA_2MpaQLs2Ur70B3L","msg":"User credentials created"}
{"level":30,"time":1768608036023,"env":"test","module":"auth-routes","userId":"TL9DA_2MpaQLs2Ur70B3L","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":30,"time":1768608036204,"env":"test","module":"auth-routes","userId":"TL9DA_2MpaQLs2Ur70B3L","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Trusted device expiry updated"}
{"level":30,"time":1768608036596,"env":"test","module":"user-credentials-repository","userId":"qZC7k1-vr53ChFk-7_82-","msg":"User credentials created"}
{"level":30,"time":1768608036715,"env":"test","module":"auth-routes","userId":"qZC7k1-vr53ChFk-7_82-","deviceCount":2,"msg":"Listed trusted devices"}
{"level":30,"time":1768608037048,"env":"test","module":"user-credentials-repository","userId":"0AKbP0HpTQ0xws5ZYMipx","msg":"User credentials created"}
{"level":30,"time":1768608037162,"env":"test","module":"auth-routes","userId":"0AKbP0HpTQ0xws5ZYMipx","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768608037492,"env":"test","module":"user-credentials-repository","userId":"QUVeC6NLgaFvYZpU4OVFo","msg":"User credentials created"}
{"level":30,"time":1768608037662,"env":"test","module":"auth-routes","userId":"QUVeC6NLgaFvYZpU4OVFo","deviceId":"e12a589f-9316-4e1c-8542-a4aa6b3214f8","msg":"Trusted device revoked"}
{"level":30,"time":1768608038046,"env":"test","module":"user-credentials-repository","userId":"C0j7_1yfXX5E4izckQV16","msg":"User credentials created"}
{"level":30,"time":1768608038377,"env":"test","module":"user-credentials-repository","userId":"71A3US5njDwgSoNPWKEPU","msg":"User credentials created"}
{"level":30,"time":1768608038834,"env":"test","module":"user-credentials-repository","userId":"syIHbvD0MOtc3S-kdsNtg","msg":"User credentials created"}
{"level":30,"time":1768608039289,"env":"test","module":"user-credentials-repository","userId":"h-N68FwWspixZcjOrKIdT","msg":"User credentials created"}
{"level":30,"time":1768608039509,"env":"test","module":"auth-service","tokenHash":"527ac5e481348923453342c648263d6d41c4c1b43233acddb4509f1966ee7a89","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768608039794,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768608039795,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/auth/oauth2.sessions.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 14137[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should list all active sessions for current user [33m 565[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should mark current session as current [33m 445[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return empty array when user has no active sessions [33m 440[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not include expired sessions [33m 460[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not include revoked sessions [33m 526[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should parse device name from user agent [33m 457[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for unauthenticated request [33m 345[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke a specific session [33m 616[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent session [33m 341[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking current session [33m 517[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking another user's session [33m 574[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for unauthenticated request [33m 327[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke all sessions except current[39m[33m 823[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke all trusted devices[39m[33m 558[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 when no active session found [33m 342[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for unauthenticated request [33m 335[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should mark current device as trusted [33m 529[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should update existing trusted device expiry [33m 712[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should list all trusted devices [33m 448[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should not include revoked devices [33m 446[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should revoke a trusted device [33m 556[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent device [33m 330[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should track IP address for sessions [33m 450[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should track user agent for sessions [33m 445[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update lastUsedAt on token refresh [33m 849[2mms[22m[39m

[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m2 failed[39m[22m[2m | [22m[1m[32m23 passed[39m[22m[90m (25)[39m
[2m   Start at [22m 18:00:22
[2m   Duration [22m 17.16s[2m (transform 705ms, setup 156ms, import 2.41s, tests 14.14s, environment 0ms)[22m

