npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

> ezbuildr@1.0.0 test
> cross-env VITEST_INTEGRATION=true vitest run --coverage


[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m
      [2mCoverage enabled with [22m[33mv8[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w10
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w10,public

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w10 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w10%2Cpublic

{"level":30,"time":1768516023080,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516023130,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w10, public

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w10
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w131.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w114.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w131.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w114.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w8
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w8,public

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w8 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w8%2Cpublic

{"level":30,"time":1768516023789,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w7
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w7,public

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w7 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w7%2Cpublic

{"level":30,"time":1768516023858,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516023860,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516023923,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w9
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w9,public

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w9 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w9%2Cpublic

{"level":30,"time":1768516024094,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w11
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w11,public

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w12
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w12,public

{"level":30,"time":1768516024149,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w11 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w11%2Cpublic

{"level":30,"time":1768516024150,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w12 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w12%2Cpublic

{"level":30,"time":1768516024185,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516024209,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w8, public

{"level":30,"time":1768516024246,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w7, public

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w8
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w7
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w10.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w10.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w10.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w10.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w9, public

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w9
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w11, public

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w12, public

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w7.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w8.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w7.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w11
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w12
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w14
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w14,public

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w8.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w8.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w8.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w8.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w8.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w14 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w14%2Cpublic

{"level":30,"time":1768516024696,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516024753,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516024877,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768516024878,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768516024878,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768516024887,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768516024893,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768516024907,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768516024949,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w14, public

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w14
‚è© Schema reused, skipping migrations.

{"level":50,"time":1768516025194,"env":"test","error":{},"msg":"Failed to create connection:"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w9.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w11.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w12.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w9.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768516025205,"env":"test","module":"auth","err":{"type":"TypeError","message":"Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')","stack":"TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')\n    at getTableColumns (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/utils.js:109:15)\n    at PgSelectBuilder.from (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/query-builders/select.js:62:16)\n    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)\n    at SystemStatsRepository.incrementUsersCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:103:16)\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:95:37)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"userId":"google-user-123","msg":"Failed to upsert user during authentication"}
{"level":50,"time":1768516025207,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
{"level":30,"time":1768516025233,"env":"test","workflowId":"394d55bd-83a1-4870-9600-5102deb3d768","userId":"7c25e665-3504-4054-91ce-31fa7b924fca","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w11.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w12.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768516025331,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"394d55bd-83a1-4870-9600-5102deb3d768","msg":"AI model call failed"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w5
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w5,public

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w2
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w2,public

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w3,public

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w0
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0,public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w1
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w1,public

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w4
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w4,public

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w5 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w5%2Cpublic

{"level":30,"time":1768516025390,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768516025393,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":50,"time":1768516025394,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google authentication failed"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w6
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w6,public

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w2 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w2%2Cpublic

{"level":30,"time":1768516025404,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w3 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w3%2Cpublic

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w0 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0%2Cpublic

{"level":30,"time":1768516025414,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516025415,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w1 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w1%2Cpublic

{"level":30,"time":1768516025426,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w4 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w4%2Cpublic

{"level":30,"time":1768516025429,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516025441,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w6 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w6%2Cpublic

{"level":40,"time":1768516025448,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":30,"time":1768516025450,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768516025448,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google token verification failed"}
{"level":50,"time":1768516025449,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google authentication failed"}
{"level":30,"time":1768516025456,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516025472,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516025472,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516025479,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516025480,"env":"test","msg":"DB: initialized flag set."}
{"level":40,"time":1768516025482,"env":"test","msg":"Failed to parse legacy string condition: \"trigger == \", defaulting to visible"}
{"level":40,"time":1768516025483,"env":"test","msg":"Failed to parse legacy string condition: \"trigger == \", defaulting to visible"}
{"level":30,"time":1768516025496,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w5, public

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w2, public

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w4, public

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w3, public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w1, public

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w0, public

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w5
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516025831,"env":"test","workflowId":"3af14a8b-eaa3-4da0-a9cd-850a3613f423","userId":"7c25e665-3504-4054-91ce-31fa7b924fca","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w6, public

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w2
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w4
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w3
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w1
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w0
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w6
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516025884,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516025885,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516025902,"env":"test","module":"auth","email":"existing@example.com","msg":"OAuth2 login successful"}
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [31m‚ùØ[39m tests/integration/regression-REG-1.test.ts [2m([22m[2m8 tests[22m[2m | [22m[31m5 failed[39m[2m)[22m[33m 3238[2mms[22m[39m
[31m       [31m√ó[31m should block Next when required visible question is empty[39m[32m 61[2mms[22m[39m
[31m       [31m√ó[31m should NOT block Next when required question is hidden[39m[33m 333[2mms[22m[39m
[31m       [31m√ó[31m should block when required becomes visible and is empty[39m[33m 333[2mms[22m[39m
[31m       [31m√ó[31m should skip hidden required page entirely[39m[33m 339[2mms[22m[39m
[31m       [31m√ó[31m should enforce required on visible page[39m[33m 336[2mms[22m[39m
       [32m‚úì[39m should evaluate visibility consistently across modes[32m 2[2mms[22m[39m
       [32m‚úì[39m should handle malformed visibility expression gracefully[32m 2[2mms[22m[39m
       [32m‚úì[39m should handle missing variable in visibility expression[32m 0[2mms[22m[39m
{"level":50,"time":1768516025929,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"3af14a8b-eaa3-4da0-a9cd-850a3613f423","msg":"AI model call failed"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":50,"time":1768516026060,"env":"test","error":{},"msg":"Failed to create connection:"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

{"level":30,"time":1768516026315,"env":"test","module":"auth","email":"refresh@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768516026389,"env":"test","workflowId":"4072774e-bb16-40c5-ba6d-6f2552525f53","userId":"7c25e665-3504-4054-91ce-31fa7b924fca","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w13
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w13,public

{"level":50,"time":1768516026484,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"4072774e-bb16-40c5-ba6d-6f2552525f53","msg":"AI model call failed"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w13 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w13%2Cpublic

{"level":30,"time":1768516026488,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516026520,"env":"test","module":"user-credentials-repository","userId":"jvdXmIaPuM5FX2zapzzxf","msg":"User credentials created"}
{"level":30,"time":1768516026536,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516026567,"env":"test","module":"user-credentials-repository","userId":"5940b145-b513-45a0-a483-3267e970a16d","msg":"User credentials created"}
{"level":30,"time":1768516026567,"env":"test","module":"user-credentials-repository","userId":"43eca2be-c6d0-493c-86ea-85f983578104","msg":"User credentials created"}
{"level":30,"time":1768516026570,"env":"test","module":"user-credentials-repository","userId":"IBxBqepSOqeW3fABmsM7H","msg":"User credentials created"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould complete full MFA setup flow
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516026606,"env":"test","module":"auth-service","tokenHash":"6b326fa08a3c57fa0053c12af9da8d39d7c2569cf4fa4984ef2955e4e2099f5f","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for 80a152bb8297588c4ed451294387de6f

{"level":30,"time":1768516026664,"env":"test","module":"email-queue","jobId":"d348e6fc-32ff-462b-91a6-e29373a1b283","to":"test-1768516026143-kd22fg@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768516026664,"env":"test","module":"email-queue","jobId":"ca0607f5-8acb-4d0d-be5e-2e376da63825","to":"test-1768516026143-qqey5@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768516026699,"env":"test","module":"auth","email":"idtoken@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768516026702,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516026703,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768516026720,"env":"test","module":"auth-routes","userId":"5940b145-b513-45a0-a483-3267e970a16d","email":"test-1768516026143-kd22fg@example.com","msg":"User registered"}
{"level":30,"time":1768516026719,"env":"test","module":"auth-routes","userId":"43eca2be-c6d0-493c-86ea-85f983578104","email":"test-1768516026143-qqey5@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration ‚Üí Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516026771,"env":"test","module":"auth-routes","userId":"IBxBqepSOqeW3fABmsM7H","sessionCount":2,"msg":"Listed active sessions"}
{"level":30,"time":1768516026782,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516026783,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/auth/oauth2.callback.test.ts [2m([22m[2m16 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 2968[2mms[22m[39m
[31m       [31m√ó[31m should initiate OAuth2 3-legged flow and generate authorization URL[39m[32m 142[2mms[22m[39m
       [32m‚úì[39m should include optional scope in authorization URL[32m 99[2mms[22m[39m
       [32m‚úì[39m should validate valid OAuth2 state token[32m 93[2mms[22m[39m
       [32m‚úì[39m should reject invalid OAuth2 state token[32m 89[2mms[22m[39m
       [32m‚úì[39m should reject expired OAuth2 state token[32m 89[2mms[22m[39m
       [32m‚úì[39m should clean up OAuth2 state after use[32m 100[2mms[22m[39m
       [32m‚úì[39m should handle callback with missing state parameter[32m 91[2mms[22m[39m
       [32m‚úì[39m should handle callback with missing code parameter[32m 93[2mms[22m[39m
       [32m‚úì[39m should handle OAuth2 provider error responses[32m 95[2mms[22m[39m
[31m       [31m√ó[31m should track OAuth2 connection status[39m[32m 98[2mms[22m[39m
       [32m‚úì[39m should store OAuth2 state in connection metadata[32m 91[2mms[22m[39m
       [32m‚úì[39m should use cryptographically secure random state[32m 103[2mms[22m[39m
       [32m‚úì[39m should prevent state reuse after validation[32m 88[2mms[22m[39m
       [32m‚úì[39m should include PKCE support metadata in state record[32m 98[2mms[22m[39m
       [32m‚úì[39m should validate redirect URI matches allowed URIs[32m 93[2mms[22m[39m
       [32m‚úì[39m should encode redirect URI in authorization URL[32m 98[2mms[22m[39m
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39müßπ Cleaning up test environment...

 [31m‚ùØ[39m tests/integration/externalSends.test.ts [2m([22m[2m2 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 2528[2mms[22m[39m
[31m     [31m√ó[31m PREVIEW MODE: Should simulate send and NOT call fetch[39m[32m 50[2mms[22m[39m
[31m     [31m√ó[31m LIVE MODE: Should call fetch with mapped payload[39m[33m 329[2mms[22m[39m
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w13, public

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w13
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w2.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w4.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w6.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w5.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w1.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w0.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w2.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516026985,"env":"test","workflowId":"1b10ec45-cd7b-430a-871a-7d0400e7bbfe","userId":"7c25e665-3504-4054-91ce-31fa7b924fca","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w4.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516027063,"env":"test","module":"auth-routes","userId":"a56a2fc6a76164af829d176c1717eaee","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768516027078,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"1b10ec45-cd7b-430a-871a-7d0400e7bbfe","msg":"AI model call failed"}
{"level":30,"time":1768516027080,"env":"test","module":"auth-routes","userId":"e4a640a2912338b2c1b0ccc7330360d6","msg":"User logged in successfully"}
{"level":30,"time":1768516027099,"env":"test","module":"auth","email":"minimal@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768516027107,"env":"test","module":"user-credentials-repository","userId":"GGIENYl5cWJuvmjjR8Ppt","msg":"User credentials created"}
{"level":50,"time":1768516027113,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"a56a2fc6a76164af829d176c1717eaee","login_success","security","a56a2fc6a76164af829d176c1717eaee","security","a56a2fc6a76164af829d176c1717eaee","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:07.063Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:07.063Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"a56a2fc6a76164af829d176c1717eaee","eventType":"login_success","msg":"Failed to log security event"}
{"level":40,"time":1768516027115,"env":"test","module":"auth-routes","userId":"5940b145-b513-45a0-a483-3267e970a16d","email":"test-1768516026143-kd22fg@example.com","msg":"Login blocked: email not verified"}
{"level":30,"time":1768516027122,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516027123,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration ‚Üí Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mLogin Failed DEBUG: EmailNotVerifiedError: Please verify your email before logging in. Check your inbox for the verification link.
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:90:11)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_006'[39m,
  statusCode: [33m403[39m,
  isOperational: [33mtrue[39m
}

[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould complete full MFA setup flow
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,a56a2fc6a76164af829d176c1717eaee,login_success,security,a56a2fc6a76164af829d176c1717eaee,security,a56a2fc6a76164af829d176c1717eaee,{"metadata":{"timestamp":"2026-01-15T22:27:07.063Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:07.063Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'a56a2fc6a76164af829d176c1717eaee'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'a56a2fc6a76164af829d176c1717eaee'[39m,
    [32m'security'[39m,
    [32m'a56a2fc6a76164af829d176c1717eaee'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:07.063Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:07.063Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516027116,"env":"test","module":"auth-routes","error":{"name":"EmailNotVerifiedError","code":"AUTH_006","statusCode":403,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1768516027113,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"a56a2fc6a76164af829d176c1717eaee","login_success","security","a56a2fc6a76164af829d176c1717eaee","security","a56a2fc6a76164af829d176c1717eaee","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:07.063Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:07.063Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w6.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768516027129,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"e4a640a2912338b2c1b0ccc7330360d6","login_success","security","e4a640a2912338b2c1b0ccc7330360d6","security","e4a640a2912338b2c1b0ccc7330360d6","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:07.081Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:27:07.081Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"e4a640a2912338b2c1b0ccc7330360d6","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,e4a640a2912338b2c1b0ccc7330360d6,login_success,security,e4a640a2912338b2c1b0ccc7330360d6,security,e4a640a2912338b2c1b0ccc7330360d6,{"metadata":{"timestamp":"2026-01-15T22:27:07.081Z"}},::ffff:127.0.0.1,Mozilla/5.0 (Windows NT 10.0; Win64; x64),2026-01-15T22:27:07.081Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'e4a640a2912338b2c1b0ccc7330360d6'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'e4a640a2912338b2c1b0ccc7330360d6'[39m,
    [32m'security'[39m,
    [32m'e4a640a2912338b2c1b0ccc7330360d6'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:07.081Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [32m'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'[39m,
    [32m'2026-01-15T22:27:07.081Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516027130,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"e4a640a2912338b2c1b0ccc7330360d6","login_success","security","e4a640a2912338b2c1b0ccc7330360d6","security","e4a640a2912338b2c1b0ccc7330360d6","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:07.081Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:27:07.081Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516027169,"env":"test","module":"user-credentials-repository","userId":"gDqYvjaoMbMmvqIOhJxbg","msg":"User credentials created"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w5.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration ‚Üí Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mDEBUG: LOGIN HANDLER HIT

 [31m‚ùØ[39m tests/integration/variableSafety.test.ts [2m([22m[2m4 tests[22m[2m | [22m[31m4 failed[39m[2m)[22m[33m 3472[2mms[22m[39m
[31m     [31m√ó[31m REPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided[39m[32m 207[2mms[22m[39m
[31m     [31m√ó[31m ScriptEngine resolves alias 'input_variable' when aliasMap is provided[39m[33m 478[2mms[22m[39m
[31m     [31m√ó[31m REPRO: BlockRunner fails to resolve alias in CreateRecordConfig[39m[33m 476[2mms[22m[39m
[31m     [31m√ó[31m BlockRunner logic resolves alias with aliasMap[39m[33m 505[2mms[22m[39m
{"level":50,"time":1768516027194,"env":"test","module":"auth","err":{"type":"Error","message":"Token verification failed","stack":"Error: Token verification failed\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:431:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768516027214,"env":"test","module":"auth-routes","userId":"GGIENYl5cWJuvmjjR8Ppt","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768516027222,"env":"test","module":"auth-service","tokenHash":"f3d99a36f187c30f0eeab78bd4032e83f9d94c356c202cfd800ae68768bd08c1","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w1.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":40,"time":1768516027241,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768516027241,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w0.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768516027290,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token payload","stack":"Error: Invalid token payload\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:88:26)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":30,"time":1768516027344,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516027344,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w15
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w15,public

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w15 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w15%2Cpublic

{"level":30,"time":1768516027406,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516027410,"env":"test","module":"auth-routes","userId":"80a152bb8297588c4ed451294387de6f","msg":"Login requires MFA verification"}
 [31m‚ùØ[39m tests/integration/auth/oauth2.google.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 3641[2mms[22m[39m
[31m       [31m√ó[31m should successfully authenticate with valid Google ID token[39m[32m 260[2mms[22m[39m
       [32m‚úì[39m should return 400 when ID token is missing[32m 67[2mms[22m[39m
       [32m‚úì[39m should return 403 when Origin header is invalid[32m 49[2mms[22m[39m
       [32m‚úì[39m should return 401 when Google token verification fails[32m 56[2mms[22m[39m
       [32m‚úì[39m should return 401 when email is not verified by Google[32m 55[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update existing user on subsequent logins [33m 502[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create refresh token record in database [33m 411[2mms[22m[39m
       [33m[2m‚úì[22m[39m should support both "token" and "idToken" fields [33m 337[2mms[22m[39m
       [32m‚úì[39m should respect rate limiting[32m 49[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle missing profile information gracefully [33m 351[2mms[22m[39m
       [32m‚úì[39m should verify valid Google ID token[32m 44[2mms[22m[39m
       [32m‚úì[39m should throw error when token verification fails[32m 50[2mms[22m[39m
       [32m‚úì[39m should throw error when email is not verified[32m 45[2mms[22m[39m
       [32m‚úì[39m should throw error when payload is null[32m 49[2mms[22m[39m
{"level":30,"time":1768516027450,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516027529,"env":"test","module":"mfa-service","userId":"80a152bb8297588c4ed451294387de6f","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768516027530,"env":"test","workflowId":"c372f26f-a1b7-40d3-a0ba-fd05ca5e4e35","userId":"7c25e665-3504-4054-91ce-31fa7b924fca","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768516027544,"env":"test","module":"user-credentials-repository","userId":"duOSoBQqfsIpCEBg5ssbZ","msg":"User credentials created"}
{"level":30,"time":1768516027581,"env":"test","module":"auth-routes","userId":"80a152bb8297588c4ed451294387de6f","msg":"MFA login successful"}
{"level":50,"time":1768516027626,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"c372f26f-a1b7-40d3-a0ba-fd05ca5e4e35","msg":"AI model call failed"}
{"level":30,"time":1768516027646,"env":"test","module":"auth-routes","userId":"duOSoBQqfsIpCEBg5ssbZ","sessionCount":0,"msg":"Listed active sessions"}
{"level":30,"time":1768516027652,"env":"test","module":"auth-routes","userId":"5940b145-b513-45a0-a483-3267e970a16d","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w16
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w16,public

{"level":50,"time":1768516027701,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"5940b145-b513-45a0-a483-3267e970a16d","login_success","security","5940b145-b513-45a0-a483-3267e970a16d","security","5940b145-b513-45a0-a483-3267e970a16d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:07.652Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:07.653Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"5940b145-b513-45a0-a483-3267e970a16d","eventType":"login_success","msg":"Failed to log security event"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w16 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w16%2Cpublic

[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration ‚Üí Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,5940b145-b513-45a0-a483-3267e970a16d,login_success,security,5940b145-b513-45a0-a483-3267e970a16d,security,5940b145-b513-45a0-a483-3267e970a16d,{"metadata":{"timestamp":"2026-01-15T22:27:07.652Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:07.653Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'5940b145-b513-45a0-a483-3267e970a16d'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'5940b145-b513-45a0-a483-3267e970a16d'[39m,
    [32m'security'[39m,
    [32m'5940b145-b513-45a0-a483-3267e970a16d'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:07.652Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:07.653Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516027701,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"5940b145-b513-45a0-a483-3267e970a16d","login_success","security","5940b145-b513-45a0-a483-3267e970a16d","security","5940b145-b513-45a0-a483-3267e970a16d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:07.652Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:07.653Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768516027754,"env":"test","module":"auth-routes","userId":"80a152bb8297588c4ed451294387de6f","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768516027785,"env":"test","module":"user-credentials-repository","userId":"09a0f05b-1999-4197-915a-f780d3599fa0","msg":"User credentials created"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w15, public

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w15
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516027853,"env":"test","module":"user-credentials-repository","userId":"h_Y75FIELbOfq4obERNLp","msg":"User credentials created"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516027885,"env":"test","module":"email-queue","jobId":"8dd33370-f00a-4988-b626-125f9167f86e","to":"test-1768516027393-77gecn@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w13.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w13.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516027920,"env":"test","module":"auth-routes","userId":"e4a640a2912338b2c1b0ccc7330360d6","msg":"User logged in successfully"}
{"level":30,"time":1768516027935,"env":"test","module":"auth-routes","userId":"09a0f05b-1999-4197-915a-f780d3599fa0","email":"test-1768516027393-77gecn@example.com","msg":"User registered"}
{"level":50,"time":1768516027967,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"e4a640a2912338b2c1b0ccc7330360d6","login_success","security","e4a640a2912338b2c1b0ccc7330360d6","security","e4a640a2912338b2c1b0ccc7330360d6","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:07.920Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)","2026-01-15T22:27:07.920Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"e4a640a2912338b2c1b0ccc7330360d6","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,e4a640a2912338b2c1b0ccc7330360d6,login_success,security,e4a640a2912338b2c1b0ccc7330360d6,security,e4a640a2912338b2c1b0ccc7330360d6,{"metadata":{"timestamp":"2026-01-15T22:27:07.920Z"}},::ffff:127.0.0.1,Mozilla/5.0 (iPhone; CPU iPhone OS 14_0),2026-01-15T22:27:07.920Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'e4a640a2912338b2c1b0ccc7330360d6'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'e4a640a2912338b2c1b0ccc7330360d6'[39m,
    [32m'security'[39m,
    [32m'e4a640a2912338b2c1b0ccc7330360d6'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:07.920Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [32m'Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)'[39m,
    [32m'2026-01-15T22:27:07.920Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516027967,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"e4a640a2912338b2c1b0ccc7330360d6","login_success","security","e4a640a2912338b2c1b0ccc7330360d6","security","e4a640a2912338b2c1b0ccc7330360d6","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:07.920Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)","2026-01-15T22:27:07.920Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516027977,"env":"test","module":"user-credentials-repository","userId":"CD5kq5t0KPE2VSAuqi7Mb","msg":"User credentials created"}
{"level":30,"time":1768516028075,"env":"test","workflowId":"7baf2eee-0e0f-4cb1-ab24-ec370088a654","userId":"7c25e665-3504-4054-91ce-31fa7b924fca","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768516028079,"env":"test","module":"auth-routes","userId":"CD5kq5t0KPE2VSAuqi7Mb","sessionCount":0,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768516028173,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"7baf2eee-0e0f-4cb1-ab24-ec370088a654","msg":"AI model call failed"}
{"level":30,"time":1768516028227,"env":"test","module":"user-credentials-repository","userId":"eYbksBal9Lrh-hQYbDJse","msg":"User credentials created"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516028277,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","plainTokenLen":19,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768516028277,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516028310,"env":"test","msg":"DB: initialized flag set."}
{"level":40,"time":1768516028323,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","msg":"Security: Unknown refresh token used (Not Found in DB)"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w17
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w17,public

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w17 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w17%2Cpublic

{"level":30,"time":1768516028390,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516028402,"env":"test","module":"user-credentials-repository","userId":"wklTuZ5X6qcm9toVb3c_o","msg":"User credentials created"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould reject invalid TOTP code during setup
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516028433,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w18
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w18,public

{"level":30,"time":1768516028546,"env":"test","module":"auth-routes","userId":"wklTuZ5X6qcm9toVb3c_o","sessionCount":1,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w18 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w18%2Cpublic

{"level":30,"time":1768516028597,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516028645,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w16, public

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w16
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w15.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w15.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516028767,"env":"test","module":"auth-routes","userId":"e4a640a2912338b2c1b0ccc7330360d6","msg":"User logged in successfully"}
{"level":30,"time":1768516028771,"env":"test","module":"auth-service","allTokensCount":5702,"sampleToken":"2b484d683e217a5794883c3321285a69f23da26d5e0f749725f993d77b121982","msg":"DEBUG: Tokens in DB"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w17, public

{"level":30,"time":1768516028784,"env":"test","workflowId":"74e14cb0-030c-4f04-9f8b-d0e6f99cc91a","userId":"7c25e665-3504-4054-91ce-31fa7b924fca","sectionsCount":1,"stepsCount":1,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":50,"time":1768516028813,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"e4a640a2912338b2c1b0ccc7330360d6","login_success","security","e4a640a2912338b2c1b0ccc7330360d6","security","e4a640a2912338b2c1b0ccc7330360d6","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:08.767Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)","2026-01-15T22:27:08.767Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"e4a640a2912338b2c1b0ccc7330360d6","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,e4a640a2912338b2c1b0ccc7330360d6,login_success,security,e4a640a2912338b2c1b0ccc7330360d6,security,e4a640a2912338b2c1b0ccc7330360d6,{"metadata":{"timestamp":"2026-01-15T22:27:08.767Z"}},::ffff:127.0.0.1,Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7),2026-01-15T22:27:08.767Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'e4a640a2912338b2c1b0ccc7330360d6'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'e4a640a2912338b2c1b0ccc7330360d6'[39m,
    [32m'security'[39m,
    [32m'e4a640a2912338b2c1b0ccc7330360d6'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:08.767Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [32m'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)'[39m,
    [32m'2026-01-15T22:27:08.767Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516028813,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"e4a640a2912338b2c1b0ccc7330360d6","login_success","security","e4a640a2912338b2c1b0ccc7330360d6","security","e4a640a2912338b2c1b0ccc7330360d6","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:08.767Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)","2026-01-15T22:27:08.767Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516028820,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w17
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516028850,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516028851,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for fdadaa1ee91b63e66df5fe1dee611823

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w16.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w16.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768516028883,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"74e14cb0-030c-4f04-9f8b-d0e6f99cc91a","msg":"AI model call failed"}
 [31m‚ùØ[39m tests/integration/workflow_versioning.test.ts [2m([22m[2m3 tests[22m[2m | [22m[33m3 skipped[39m[2m)[22m[33m 1863[2mms[22m[39m
     [2m[90m‚Üì[39m[22m should diff two versions correctly
     [2m[90m‚Üì[39m[22m should create a version and populate changelog
     [2m[90m‚Üì[39m[22m should track execution lineage via snapshot
{"level":30,"time":1768516028888,"env":"test","module":"user-credentials-repository","userId":"jJ16GTwbJTBTp32sWrG2T","msg":"User credentials created"}
{"level":30,"time":1768516028898,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516028899,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516028908,"env":"test","module":"auth-routes","userId":"950b2258becfed215a0e4a7624931a49","msg":"User logged in successfully"}
{"level":50,"time":1768516028959,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"950b2258becfed215a0e4a7624931a49","login_success","security","950b2258becfed215a0e4a7624931a49","security","950b2258becfed215a0e4a7624931a49","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:08.908Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:08.908Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"950b2258becfed215a0e4a7624931a49","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould reject invalid TOTP code during setup
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,950b2258becfed215a0e4a7624931a49,login_success,security,950b2258becfed215a0e4a7624931a49,security,950b2258becfed215a0e4a7624931a49,{"metadata":{"timestamp":"2026-01-15T22:27:08.908Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:08.908Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'950b2258becfed215a0e4a7624931a49'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'950b2258becfed215a0e4a7624931a49'[39m,
    [32m'security'[39m,
    [32m'950b2258becfed215a0e4a7624931a49'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:08.908Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:08.908Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516028959,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"950b2258becfed215a0e4a7624931a49","login_success","security","950b2258becfed215a0e4a7624931a49","security","950b2258becfed215a0e4a7624931a49","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:08.908Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:08.908Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516028966,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768516028972,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516028989,"env":"test","module":"auth-routes","userId":"jJ16GTwbJTBTp32sWrG2T","sessionCount":1,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w18, public

{"level":50,"time":1768516029017,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"step.create","sectionRef":"temp-section-1","type":"short_text","title":"Field 1","alias":"field1"},"msg":"Failed to apply operation"}
{"level":30,"time":1768516029017,"env":"test","module":"user-credentials-repository","userId":"f2b7f4ac-1ba3-4832-8889-f647e347f922","msg":"User credentials created"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768516029035,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"document.bindFields","id":"template-123","bindings":{"client_name":"nonExistentAlias"}},"msg":"Failed to apply operation"}
{"level":30,"time":1768516029040,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516029040,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w18
‚è© Schema reused, skipping migrations.

 [31m‚ùØ[39m tests/integration/dataBlocks.test.ts [2m([22m[2m2 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 2860[2mms[22m[39m
[31m     [31m√ó[31m should write data to DataVault via WriteBlock[39m[32m 106[2mms[22m[39m
[31m     [31m√ó[31m should query data from DataVault via QueryBlock and use in Logic[39m[33m 356[2mms[22m[39m
 [31m‚ùØ[39m tests/unit/services/WorkflowPatchService.test.ts [2m([22m[2m21 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 1759[2mms[22m[39m
       [32m‚úì[39m should resolve section tempId to real UUID when creating step[32m 12[2mms[22m[39m
       [32m‚úì[39m should handle multi-level tempId references[32m 2[2mms[22m[39m
       [32m‚úì[39m should reject duplicate step alias on create[32m 1[2mms[22m[39m
       [32m‚úì[39m should allow same alias on update of same step[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject duplicate alias on update to different step[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject completely unknown operation[32m 2[2mms[22m[39m
       [32m‚úì[39m should reject malformed operation (missing required fields)[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject unsafe DataVault operations (dropTable)[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject unsafe DataVault operations (dropColumn)[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject unsafe DataVault operations (deleteRows)[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject unsafe DataVault operations (updateRowData)[32m 1[2mms[22m[39m
       [32m‚úì[39m should allow safe DataVault operations (createTable, addColumns)[32m 1[2mms[22m[39m
       [32m‚úì[39m should rollback all ops if any op fails[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should clear tempId mappings between batch calls[39m[32m 11[2mms[22m[39m
       [32m‚úì[39m should create visibility rule on step[32m 2[2mms[22m[39m
       [32m‚úì[39m should parse complex condition expressions[32m 1[2mms[22m[39m
       [32m‚úì[39m should attach document to workflow (document.add)[32m 2[2mms[22m[39m
       [32m‚úì[39m should bind document fields to workflow variables (document.bindFields)[32m 2[2mms[22m[39m
[31m       [31m√ó[31m should reject binding to non-existent step alias[39m[32m 1[2mms[22m[39m
       [32m‚úì[39m should create DataVault table with columns (datavault.createTable)[32m 2[2mms[22m[39m
       [32m‚úì[39m should create writeback mapping (datavault.createWritebackMapping)[32m 2[2mms[22m[39m
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w17.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w17.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516029113,"env":"test","module":"email-queue","jobId":"38043378-26a8-4520-b156-20e996f438e1","to":"test-1768516028623-37blg@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768516029120,"env":"test","module":"user-credentials-repository","userId":"Cd41i5QYUbCTZbAjWFqnZ","msg":"User credentials created"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516029166,"env":"test","module":"auth-routes","userId":"f2b7f4ac-1ba3-4832-8889-f647e347f922","email":"test-1768516028623-37blg@example.com","msg":"User registered"}
{"level":30,"time":1768516029220,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","plainTokenLen":17,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768516029264,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768516029264,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

{"level":30,"time":1768516029265,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768516029328,"env":"test","module":"user-credentials-repository","userId":"OjfTHBirxunzvshr53Rk0","msg":"User credentials created"}
{"level":50,"time":1768516029332,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
 [31m‚ùØ[39m tests/integration/ai/workflowEdit.test.ts [2m([22m[2m8 tests[22m[2m | [22m[31m7 failed[39m[2m)[22m[33m 5922[2mms[22m[39m
[31m     [31m√ó[31m should create draft version on successful AI edit[39m[33m 608[2mms[22m[39m
[31m     [31m√ó[31m should enforce draft mode (revert active workflow to draft)[39m[33m 592[2mms[22m[39m
[31m     [31m√ó[31m should not create version when no changes detected (checksum match)[39m[33m 555[2mms[22m[39m
     [32m‚úì[39m should reject unauthorized access[32m 55[2mms[22m[39m
[31m     [31m√ó[31m should reject unsafe DataVault operations[39m[33m 539[2mms[22m[39m
[31m     [31m√ó[31m should handle multi-operation edits with tempId resolution[39m[33m 547[2mms[22m[39m
[31m     [31m√ó[31m should create BEFORE and AFTER snapshots[39m[33m 547[2mms[22m[39m
[31m     [31m√ó[31m should rollback on validation failure[39m[33m 711[2mms[22m[39m
{"level":30,"time":1768516029392,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768516029393,"env":"test","module":"auth-routes","email":"test-1768516028596-2cdtii@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768516029393,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/analytics_preservation.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 1228[2mms[22m[39m
[31m     [31m√ó[31m should preserve lifetime user count when a user is deleted[39m[32m 6[2mms[22m[39m
{"level":50,"time":1768516029498,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould login with valid credentials
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516029580,"env":"test","module":"auth-service","allTokensCount":5708,"sampleToken":"2b484d683e217a5794883c3321285a69f23da26d5e0f749725f993d77b121982","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768516029585,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516029585,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/collections.e2e.test.ts [2m([22m[2m22 tests[22m[2m | [22m[33m22 skipped[39m[2m)[22m[33m 1614[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should create a collection
       [2m[90m‚Üì[39m[22m should list collections
       [2m[90m‚Üì[39m[22m should get a collection by ID
       [2m[90m‚Üì[39m[22m should update a collection
       [2m[90m‚Üì[39m[22m should create text field
       [2m[90m‚Üì[39m[22m should create email field
       [2m[90m‚Üì[39m[22m should create number field
       [2m[90m‚Üì[39m[22m should create select field with options
       [2m[90m‚Üì[39m[22m should create boolean field
       [2m[90m‚Üì[39m[22m should list all fields
       [2m[90m‚Üì[39m[22m should update field
       [2m[90m‚Üì[39m[22m should create a record
       [2m[90m‚Üì[39m[22m should create multiple records
       [2m[90m‚Üì[39m[22m should list records with pagination
       [2m[90m‚Üì[39m[22m should get a single record
       [2m[90m‚Üì[39m[22m should update a record
       [2m[90m‚Üì[39m[22m should find records by filters
       [2m[90m‚Üì[39m[22m should delete a record
       [2m[90m‚Üì[39m[22m should list collections with stats
       [2m[90m‚Üì[39m[22m should enforce required fields
       [2m[90m‚Üì[39m[22m should validate field types
       [2m[90m‚Üì[39m[22m should delete collection (cascade fields and records)
{"level":30,"time":1768516029647,"env":"test","module":"auth-routes","userId":"fdadaa1ee91b63e66df5fe1dee611823","msg":"Login requires MFA verification"}
{"level":30,"time":1768516029700,"env":"test","module":"user-credentials-repository","userId":"bBnb5hfSkiRL3AfiTV7iE","msg":"User credentials created"}
{"level":30,"time":1768516029751,"env":"test","module":"mfa-service","userId":"fdadaa1ee91b63e66df5fe1dee611823","msg":"TOTP verification successful"}
{"level":30,"time":1768516029803,"env":"test","module":"auth-routes","userId":"fdadaa1ee91b63e66df5fe1dee611823","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768516029901,"env":"test","module":"auth-routes","userId":"bBnb5hfSkiRL3AfiTV7iE","sessionId":"8a25c64e-3c2b-4351-8512-70b0a440329f","msg":"Session revoked"}
{"level":50,"time":1768516029910,"env":"test","module":"auth-routes","email":"test-1768516028596-2cdtii@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

{"level":30,"time":1768516029950,"env":"test","module":"auth-routes","userId":"fdadaa1ee91b63e66df5fe1dee611823","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768516029965,"env":"test","module":"user-credentials-repository","userId":"2KChyArqEdom25aVm20G9","msg":"User credentials created"}
{"level":50,"time":1768516030007,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768516030068,"env":"test","module":"auth-routes","userId":"4e480b3886a2d458a401b3b8141cf50c","msg":"User logged in successfully"}
{"level":30,"time":1768516030071,"env":"test","module":"auth-service","tokenHash":"a619a1321fcd48b9c9b4e57c92c8f2f661b2c20d160eccadf78fed1fe8a3e184","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768516030118,"env":"test","module":"auth-service","userId":"2KChyArqEdom25aVm20G9","tokenHash":"a619a1321fcd48b9c9b4e57c92c8f2f661b2c20d160eccadf78fed1fe8a3e184","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":50,"time":1768516030118,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"4e480b3886a2d458a401b3b8141cf50c","login_success","security","4e480b3886a2d458a401b3b8141cf50c","security","4e480b3886a2d458a401b3b8141cf50c","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:10.069Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:10.069Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"4e480b3886a2d458a401b3b8141cf50c","eventType":"login_success","msg":"Failed to log security event"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould login with valid credentials
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,4e480b3886a2d458a401b3b8141cf50c,login_success,security,4e480b3886a2d458a401b3b8141cf50c,security,4e480b3886a2d458a401b3b8141cf50c,{"metadata":{"timestamp":"2026-01-15T22:27:10.069Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:10.069Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'4e480b3886a2d458a401b3b8141cf50c'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'4e480b3886a2d458a401b3b8141cf50c'[39m,
    [32m'security'[39m,
    [32m'4e480b3886a2d458a401b3b8141cf50c'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:10.069Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:10.069Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516030118,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"4e480b3886a2d458a401b3b8141cf50c","login_success","security","4e480b3886a2d458a401b3b8141cf50c","security","4e480b3886a2d458a401b3b8141cf50c","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:10.069Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:10.069Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768516030315,"env":"test","module":"user-credentials-repository","userId":"P91fjlh0cP2GkkP_UFHfE","msg":"User credentials created"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould not allow MFA setup if already enabled
[22m[39m[TEST UTILS] MFA Secret verified for e8b1e8ecc79d2128db516161b09a3632

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768516030462,"env":"test","module":"auth-routes","email":"test-1768516028596-2cdtii@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768516030558,"env":"test","module":"user-credentials-repository","userId":"210LUnMVrvO665ojUOPyP","msg":"User credentials created"}
{"level":50,"time":1768516030607,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516030672,"env":"test","module":"auth-service","tokenHash":"c56acf06f930537cecb9095ee2c1e088515a43ad3325577bf7502c3388885717","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768516030697,"env":"test","module":"auth-routes","userId":"834f083771855ae3549c34df842be5ec","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould not allow MFA setup if already enabled
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768516030728,"env":"test","module":"auth-service","tokenHash":"c56acf06f930537cecb9095ee2c1e088515a43ad3325577bf7502c3388885717","msg":"Security: Unknown refresh token used (Not Found in DB)"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768516030741,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"834f083771855ae3549c34df842be5ec","login_success","security","834f083771855ae3549c34df842be5ec","security","834f083771855ae3549c34df842be5ec","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:10.697Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:10.697Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"834f083771855ae3549c34df842be5ec","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,834f083771855ae3549c34df842be5ec,login_success,security,834f083771855ae3549c34df842be5ec,security,834f083771855ae3549c34df842be5ec,{"metadata":{"timestamp":"2026-01-15T22:27:10.697Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:10.697Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'834f083771855ae3549c34df842be5ec'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'834f083771855ae3549c34df842be5ec'[39m,
    [32m'security'[39m,
    [32m'834f083771855ae3549c34df842be5ec'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:10.697Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:10.697Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516030741,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"834f083771855ae3549c34df842be5ec","login_success","security","834f083771855ae3549c34df842be5ec","security","834f083771855ae3549c34df842be5ec","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:10.697Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:10.697Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516030753,"env":"test","module":"user-credentials-repository","userId":"Tj8TAR76ozUkgqyoOQioP","msg":"User credentials created"}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":50,"time":1768516031011,"env":"test","module":"auth-routes","email":"test-1768516028596-2cdtii@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768516031094,"env":"test","module":"auth-service","allTokensCount":5707,"sampleToken":"2b484d683e217a5794883c3321285a69f23da26d5e0f749725f993d77b121982","msg":"DEBUG: Tokens in DB"}
{"level":50,"time":1768516031109,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for 7550a5017ae5aa66099029f374bc2ce2

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516031277,"env":"test","module":"auth-routes","userId":"e8b1e8ecc79d2128db516161b09a3632","msg":"Login requires MFA verification"}
{"level":30,"time":1768516031280,"env":"test","module":"user-credentials-repository","userId":"f_I3Et56bHL4bVjscLdLT","msg":"User credentials created"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for invalid password
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516031501,"env":"test","module":"user-credentials-repository","userId":"ZCL7g7Ml_1tuJSXqqk81s","msg":"User credentials created"}
{"level":50,"time":1768516031540,"env":"test","module":"auth-routes","email":"test-1768516028596-2cdtii@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768516031553,"env":"test","module":"auth-routes","userId":"834f083771855ae3549c34df842be5ec","msg":"User logged in successfully"}
{"level":30,"time":1768516031558,"env":"test","module":"auth-service","tokenHash":"19a121074513f444031d3ca8245b6af2d892912dde1ab9ad2b9beaf383cfcd44","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstderr[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,834f083771855ae3549c34df842be5ec,login_success,security,834f083771855ae3549c34df842be5ec,security,834f083771855ae3549c34df842be5ec,{"metadata":{"timestamp":"2026-01-15T22:27:11.553Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:11.553Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'834f083771855ae3549c34df842be5ec'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'834f083771855ae3549c34df842be5ec'[39m,
    [32m'security'[39m,
    [32m'834f083771855ae3549c34df842be5ec'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:11.553Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:11.553Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516031624,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"834f083771855ae3549c34df842be5ec","login_success","security","834f083771855ae3549c34df842be5ec","security","834f083771855ae3549c34df842be5ec","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:11.553Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:11.553Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"834f083771855ae3549c34df842be5ec","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768516031624,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"834f083771855ae3549c34df842be5ec","login_success","security","834f083771855ae3549c34df842be5ec","security","834f083771855ae3549c34df842be5ec","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:11.553Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:11.553Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516031632,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768516031739,"env":"test","module":"account-lockout","userId":"ac6a3bafb9a8ebc8c675e5fae0445674","email":"test-1768516028596-2cdtii@example.com","lockedUntil":"2026-01-15T22:42:11.691Z","msg":"Account locked due to too many failed attempts"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768516031739,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1768516031831,"env":"test","module":"auth-routes","email":"test-1768516031010-dqma3sh@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":40,"time":1768516031837,"env":"test","module":"auth-routes","userId":"ac6a3bafb9a8ebc8c675e5fae0445674","email":"test-1768516028596-2cdtii@example.com","msg":"Login blocked: account locked"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: AccountLockedError: Account is locked until 2026-01-15T22:42:11.691Z
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:62:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_005'[39m,
  statusCode: [33m423[39m,
  isOperational: [33mtrue[39m,
  lockedUntil: [35m2026-01-15T22:42:11.691Z[39m,
  remainingMinutes: [33m15[39m
}

{"level":50,"time":1768516031837,"env":"test","module":"auth-routes","error":{"name":"AccountLockedError","code":"AUTH_005","statusCode":423,"isOperational":true,"lockedUntil":"2026-01-15T22:42:11.691Z","remainingMinutes":15},"msg":"Login failed"}
{"level":30,"time":1768516031857,"env":"test","module":"user-credentials-repository","userId":"e_jQaZs44V-HP8DZk6xQR","msg":"User credentials created"}
{"level":50,"time":1768516031862,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":50,"time":1768516031929,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for invalid password
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":30,"time":1768516031981,"env":"test","module":"auth-routes","userId":"7550a5017ae5aa66099029f374bc2ce2","msg":"Login requires MFA verification"}
{"level":30,"time":1768516032078,"env":"test","module":"mfa-service","userId":"7550a5017ae5aa66099029f374bc2ce2","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516032125,"env":"test","module":"auth-routes","userId":"7550a5017ae5aa66099029f374bc2ce2","msg":"MFA login successful"}
[90mstderr[2m | tests/integration/api.projects.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768516032188,"env":"test","module":"user-credentials-repository","userId":"t6-Vb_diTqwvrzk-trdAV","msg":"User credentials created"}
{"level":30,"time":1768516032224,"env":"test","module":"user-credentials-repository","userId":"dG84--LfvFxZBsS49El3D","msg":"User credentials created"}
{"level":30,"time":1768516032242,"env":"test","module":"auth-service","tokenHash":"7f4787b7535842949c847c215573f8363a722bae8ec4e97cc097294f2cd94b7d","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768516032243,"env":"test","module":"auth-service","tokenHash":"7f4787b7535842949c847c215573f8363a722bae8ec4e97cc097294f2cd94b7d","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768516032278,"env":"test","module":"auth-routes","userId":"7550a5017ae5aa66099029f374bc2ce2","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould generate unique backup codes
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516032528,"env":"test","module":"auth-routes","userId":"7550a5017ae5aa66099029f374bc2ce2","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Trusted device expiry updated"}
{"level":50,"time":1768516032548,"env":"test","module":"auth-routes","email":"nonexistent@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":40,"time":1768516032586,"env":"test","module":"auth-service","userId":"t6-Vb_diTqwvrzk-trdAV","tokenHash":"7f4787b7535842949c847c215573f8363a722bae8ec4e97cc097294f2cd94b7d","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768516032681,"env":"test","module":"auth-routes","userId":"dG84--LfvFxZBsS49El3D","msg":"All other sessions revoked"}
[90mstderr[2m | tests/integration/api.snapshots.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":50,"time":1768516032694,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstderr[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":50,"time":1768516032727,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"dG84--LfvFxZBsS49El3D","all_sessions_revoked","security","dG84--LfvFxZBsS49El3D","security","dG84--LfvFxZBsS49El3D",null,"::ffff:127.0.0.1",null,"2026-01-15T22:27:12.681Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"dG84--LfvFxZBsS49El3D","eventType":"all_sessions_revoked","msg":"Failed to log security event"}
{"level":50,"time":1768516032727,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"dG84--LfvFxZBsS49El3D","all_sessions_revoked","security","dG84--LfvFxZBsS49El3D","security","dG84--LfvFxZBsS49El3D",null,"::ffff:127.0.0.1",null,"2026-01-15T22:27:12.681Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Error revoking all sessions"}
{"level":30,"time":1768516032816,"env":"test","module":"auth-routes","userId":"78a1bb59efa2b3b05e0ea04171436f40","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould generate unique backup codes
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,78a1bb59efa2b3b05e0ea04171436f40,login_success,security,78a1bb59efa2b3b05e0ea04171436f40,security,78a1bb59efa2b3b05e0ea04171436f40,{"metadata":{"timestamp":"2026-01-15T22:27:12.816Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:12.816Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'78a1bb59efa2b3b05e0ea04171436f40'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'78a1bb59efa2b3b05e0ea04171436f40'[39m,
    [32m'security'[39m,
    [32m'78a1bb59efa2b3b05e0ea04171436f40'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:12.816Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:12.816Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516032858,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"78a1bb59efa2b3b05e0ea04171436f40","login_success","security","78a1bb59efa2b3b05e0ea04171436f40","security","78a1bb59efa2b3b05e0ea04171436f40","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:12.816Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:12.816Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"78a1bb59efa2b3b05e0ea04171436f40","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768516032859,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"78a1bb59efa2b3b05e0ea04171436f40","login_success","security","78a1bb59efa2b3b05e0ea04171436f40","security","78a1bb59efa2b3b05e0ea04171436f40","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:12.816Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:12.816Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516032865,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

{"level":30,"time":1768516032998,"env":"test","module":"user-credentials-repository","userId":"w1_LI0J7hOwj7fbhAjBbP","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516033053,"env":"test","module":"auth-service","tokenHash":"5ea63fd81e5dd22dd8755c728682f3a4a400613902211c9c99dc6acbbed2e7f1","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768516033086,"env":"test","module":"user-credentials-repository","userId":"s73jGa3QKSEck1Ih9CL9v","msg":"User credentials created"}
{"level":30,"time":1768516033115,"env":"test","module":"user-credentials-repository","userId":"290419ee-0612-4dfe-b534-c603996ea69f","msg":"User credentials created"}
{"level":50,"time":1768516033142,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768516033213,"env":"test","module":"email-queue","jobId":"1adbaf4d-1898-462b-8a64-40ed498e3db4","to":"test-1768516032698-vcpi5g@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768516033258,"env":"test","module":"auth-routes","userId":"290419ee-0612-4dfe-b534-c603996ea69f","email":"test-1768516032698-vcpi5g@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516033287,"env":"test","module":"auth-routes","userId":"s73jGa3QKSEck1Ih9CL9v","msg":"All other sessions revoked"}
{"level":50,"time":1768516033334,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"s73jGa3QKSEck1Ih9CL9v","all_sessions_revoked","security","s73jGa3QKSEck1Ih9CL9v","security","s73jGa3QKSEck1Ih9CL9v",null,"::ffff:127.0.0.1",null,"2026-01-15T22:27:13.287Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"s73jGa3QKSEck1Ih9CL9v","eventType":"all_sessions_revoked","msg":"Failed to log security event"}
{"level":50,"time":1768516033334,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"s73jGa3QKSEck1Ih9CL9v","all_sessions_revoked","security","s73jGa3QKSEck1Ih9CL9v","security","s73jGa3QKSEck1Ih9CL9v",null,"::ffff:127.0.0.1",null,"2026-01-15T22:27:13.287Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Error revoking all sessions"}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/api.workflows.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":50,"time":1768516033454,"env":"test","module":"auth-routes","email":"test-1768516032600-zfbxxgi@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768516033483,"env":"test","module":"auth-routes","userId":"172eb98c8f29d399cb7910f58c6c5786","msg":"User logged in successfully"}
{"level":50,"time":1768516033531,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"172eb98c8f29d399cb7910f58c6c5786","login_success","security","172eb98c8f29d399cb7910f58c6c5786","security","172eb98c8f29d399cb7910f58c6c5786","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:13.484Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:13.484Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"172eb98c8f29d399cb7910f58c6c5786","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,172eb98c8f29d399cb7910f58c6c5786,login_success,security,172eb98c8f29d399cb7910f58c6c5786,security,172eb98c8f29d399cb7910f58c6c5786,{"metadata":{"timestamp":"2026-01-15T22:27:13.484Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:13.484Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'172eb98c8f29d399cb7910f58c6c5786'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'172eb98c8f29d399cb7910f58c6c5786'[39m,
    [32m'security'[39m,
    [32m'172eb98c8f29d399cb7910f58c6c5786'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:13.484Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:13.484Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516033531,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"172eb98c8f29d399cb7910f58c6c5786","login_success","security","172eb98c8f29d399cb7910f58c6c5786","security","172eb98c8f29d399cb7910f58c6c5786","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:13.484Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:13.484Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768516033551,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts[2m > [22m[2mDataVault Autonumber Integration Tests
[22m[39mError cleaning up table: Error: Table not found
    at DatavaultTablesService.verifyTenantOwnership (C:/Users/scoot/poll/VaultLogic/server/services/DatavaultTablesService.ts:152:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at DatavaultTablesService.deleteTable (C:/Users/scoot/poll/VaultLogic/server/services/DatavaultTablesService.ts:290:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/datavault.autonumber.test.ts:91:9

{"level":30,"time":1768516033594,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516033595,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 668ab6ca0a19a78269fde0591cfce404

 [31m‚ùØ[39m tests/integration/datavault.autonumber.test.ts [2m([22m[2m5 tests[22m[2m | [22m[31m5 failed[39m[2m)[22m[33m 10322[2mms[22m[39m
[31m     [31m√ó[31m should generate basic autonumber without prefix[39m[33m 333[2mms[22m[39m
[31m     [31m√ó[31m should generate autonumber with prefix[39m[33m 338[2mms[22m[39m
[31m     [31m√ó[31m should generate autonumber with yearly reset format[39m[33m 341[2mms[22m[39m
[31m     [31m√ó[31m should be atomic and prevent race conditions[39m[33m 327[2mms[22m[39m
[31m     [31m√ó[31m should prevent manual updates to autonumber values[39m[33m 334[2mms[22m[39m
{"level":30,"time":1768516033691,"env":"test","module":"user-credentials-repository","userId":"VMMQzL2Z5Ga77MxN8V7Tj","msg":"User credentials created"}
{"level":40,"time":1768516033696,"env":"test","module":"auth-routes","userId":"290419ee-0612-4dfe-b534-c603996ea69f","email":"test-1768516032698-vcpi5g@example.com","msg":"Login blocked: email not verified"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mLogin Failed DEBUG: EmailNotVerifiedError: Please verify your email before logging in. Check your inbox for the verification link.
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:90:11)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_006'[39m,
  statusCode: [33m403[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768516033697,"env":"test","module":"auth-routes","error":{"name":"EmailNotVerifiedError","code":"AUTH_006","statusCode":403,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516033704,"env":"test","module":"user-credentials-repository","userId":"Cur62iOyHh_dpNvzhj4J9","msg":"User credentials created"}
{"level":30,"time":1768516033746,"env":"test","module":"auth-service","tokenHash":"30a00f2d2e8ed8ecaf324d1166fa59c55c52c52dd4593c37cd66565faf124cff","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768516033959,"env":"test","module":"auth-routes","email":"test-1768516032600-zfbxxgi@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768516034069,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516034082,"env":"test","module":"user-credentials-repository","userId":"9cRD8UuXGQ6sGjdFfqHIU","msg":"User credentials created"}
{"level":50,"time":1768516034088,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould record failed login attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould store hashed backup codes
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516034320,"env":"test","module":"user-credentials-repository","userId":"pZGU6afkrKaOfZnLmPovq","msg":"User credentials created"}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768516034363,"env":"test","module":"auth-routes","userId":"172eb98c8f29d399cb7910f58c6c5786","msg":"User logged in successfully"}
{"level":30,"time":1768516034372,"env":"test","module":"auth-service","tokenHash":"eb7b71d54d1cb24610e6b176b870cc9ff1b9da1c3dff1aac23592995800ac799","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768516034407,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"172eb98c8f29d399cb7910f58c6c5786","login_success","security","172eb98c8f29d399cb7910f58c6c5786","security","172eb98c8f29d399cb7910f58c6c5786","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:14.363Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:14.363Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"172eb98c8f29d399cb7910f58c6c5786","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,172eb98c8f29d399cb7910f58c6c5786,login_success,security,172eb98c8f29d399cb7910f58c6c5786,security,172eb98c8f29d399cb7910f58c6c5786,{"metadata":{"timestamp":"2026-01-15T22:27:14.363Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:14.363Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'172eb98c8f29d399cb7910f58c6c5786'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'172eb98c8f29d399cb7910f58c6c5786'[39m,
    [32m'security'[39m,
    [32m'172eb98c8f29d399cb7910f58c6c5786'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:14.363Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:14.363Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516034407,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"172eb98c8f29d399cb7910f58c6c5786","login_success","security","172eb98c8f29d399cb7910f58c6c5786","security","172eb98c8f29d399cb7910f58c6c5786","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:14.363Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:14.363Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768516034467,"env":"test","module":"auth-routes","userId":"668ab6ca0a19a78269fde0591cfce404","msg":"Login requires MFA verification"}
{"level":30,"time":1768516034500,"env":"test","module":"user-credentials-repository","userId":"65Ter6vYbcWBGPUdA0Nuc","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

{"level":50,"time":1768516034549,"env":"test","module":"auth-routes","email":"test-1768516033700-nqk0x8@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768516034572,"env":"test","module":"mfa-service","userId":"668ab6ca0a19a78269fde0591cfce404","msg":"TOTP verification successful"}
{"level":30,"time":1768516034580,"env":"test","module":"auth-routes","userId":"ad4f7c986bb5a0c7ddebad5a88b8bc65","msg":"User logged in successfully"}
{"level":30,"time":1768516034604,"env":"test","module":"auth-routes","userId":"65Ter6vYbcWBGPUdA0Nuc","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":30,"time":1768516034618,"env":"test","module":"auth-routes","userId":"668ab6ca0a19a78269fde0591cfce404","msg":"MFA login successful"}
{"level":50,"time":1768516034624,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"ad4f7c986bb5a0c7ddebad5a88b8bc65","login_success","security","ad4f7c986bb5a0c7ddebad5a88b8bc65","security","ad4f7c986bb5a0c7ddebad5a88b8bc65","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:14.580Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:14.580Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"ad4f7c986bb5a0c7ddebad5a88b8bc65","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,ad4f7c986bb5a0c7ddebad5a88b8bc65,login_success,security,ad4f7c986bb5a0c7ddebad5a88b8bc65,security,ad4f7c986bb5a0c7ddebad5a88b8bc65,{"metadata":{"timestamp":"2026-01-15T22:27:14.580Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:14.580Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'ad4f7c986bb5a0c7ddebad5a88b8bc65'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'ad4f7c986bb5a0c7ddebad5a88b8bc65'[39m,
    [32m'security'[39m,
    [32m'ad4f7c986bb5a0c7ddebad5a88b8bc65'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:14.580Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:14.580Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516034624,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"ad4f7c986bb5a0c7ddebad5a88b8bc65","login_success","security","ad4f7c986bb5a0c7ddebad5a88b8bc65","security","ad4f7c986bb5a0c7ddebad5a88b8bc65","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:14.580Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:14.580Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould record failed login attempt
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768516034644,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516034726,"env":"test","module":"auth-routes","userId":"bea41856e5411388ef5421ca2a7d6b45","msg":"User logged in successfully"}
{"level":30,"time":1768516034767,"env":"test","module":"auth-routes","userId":"668ab6ca0a19a78269fde0591cfce404","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768516034775,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"bea41856e5411388ef5421ca2a7d6b45","login_success","security","bea41856e5411388ef5421ca2a7d6b45","security","bea41856e5411388ef5421ca2a7d6b45","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:14.726Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:14.726Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"bea41856e5411388ef5421ca2a7d6b45","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould store hashed backup codes
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,bea41856e5411388ef5421ca2a7d6b45,login_success,security,bea41856e5411388ef5421ca2a7d6b45,security,bea41856e5411388ef5421ca2a7d6b45,{"metadata":{"timestamp":"2026-01-15T22:27:14.726Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:14.726Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'bea41856e5411388ef5421ca2a7d6b45'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'bea41856e5411388ef5421ca2a7d6b45'[39m,
    [32m'security'[39m,
    [32m'bea41856e5411388ef5421ca2a7d6b45'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:14.726Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:14.726Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516034775,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"bea41856e5411388ef5421ca2a7d6b45","login_success","security","bea41856e5411388ef5421ca2a7d6b45","security","bea41856e5411388ef5421ca2a7d6b45","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:14.726Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:14.726Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516034783,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768516034801,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768516034920,"env":"test","module":"user-credentials-repository","userId":"WVplbASfUyDfDR5NWZmAL","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22m[2mOAuth2 Token Refresh Flow[2m > [22m[2mRefresh Token Lifecycle[2m > [22m[2mshould create refresh token on login
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768516035030,"env":"test","module":"user-credentials-repository","userId":"rdJnswOdg8YbJBJuPHAzR","msg":"User credentials created"}
{"level":30,"time":1768516035134,"env":"test","module":"auth-routes","userId":"rdJnswOdg8YbJBJuPHAzR","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
[90mstderr[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768516035280,"env":"test","module":"auth-routes","userId":"668ab6ca0a19a78269fde0591cfce404","msg":"Login requires MFA verification"}
{"level":30,"time":1768516035298,"env":"test","module":"auth-routes","userId":"rdJnswOdg8YbJBJuPHAzR","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Trusted device expiry updated"}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516035387,"env":"test","module":"mfa-service","userId":"668ab6ca0a19a78269fde0591cfce404","msg":"TOTP verification successful"}
{"level":30,"time":1768516035434,"env":"test","module":"auth-routes","userId":"668ab6ca0a19a78269fde0591cfce404","msg":"MFA login successful"}
[90mstderr[2m | tests/integration/intake.workflow.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768516035545,"env":"test","module":"auth-routes","userId":"WVplbASfUyDfDR5NWZmAL","msg":"User logged in successfully"}
[90mstderr[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768516035582,"env":"test","module":"auth-routes","userId":"668ab6ca0a19a78269fde0591cfce404","deviceFingerprint":"091366faa1882b5c8dc1cba02126615a77a378274bbfd3375e821aa38bdd1b4f","msg":"Device marked as trusted"}
[90mstderr[2m | tests/integration/js_helpers.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768516035591,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"WVplbASfUyDfDR5NWZmAL","login_success","security","WVplbASfUyDfDR5NWZmAL","security","WVplbASfUyDfDR5NWZmAL","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:15.545Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:15.545Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"WVplbASfUyDfDR5NWZmAL","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22m[2mOAuth2 Token Refresh Flow[2m > [22m[2mRefresh Token Lifecycle[2m > [22m[2mshould create refresh token on login
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,WVplbASfUyDfDR5NWZmAL,login_success,security,WVplbASfUyDfDR5NWZmAL,security,WVplbASfUyDfDR5NWZmAL,{"metadata":{"timestamp":"2026-01-15T22:27:15.545Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:15.545Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'WVplbASfUyDfDR5NWZmAL'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'WVplbASfUyDfDR5NWZmAL'[39m,
    [32m'security'[39m,
    [32m'WVplbASfUyDfDR5NWZmAL'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:15.545Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:15.545Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516035591,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"WVplbASfUyDfDR5NWZmAL","login_success","security","WVplbASfUyDfDR5NWZmAL","security","WVplbASfUyDfDR5NWZmAL","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:15.545Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:15.545Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/unit/debug_import.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768516035737,"env":"test","module":"user-credentials-repository","userId":"uNu4B398UNBqJ_O_fRTxF","msg":"User credentials created"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return requiresMfa=true for MFA-enabled users
[22m[39m[TEST UTILS] MFA Secret verified for bd91e24f25963e94ed8c9ea5d37c538b

{"level":30,"time":1768516035830,"env":"test","module":"auth-routes","userId":"uNu4B398UNBqJ_O_fRTxF","deviceCount":2,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516035995,"env":"test","module":"user-credentials-repository","userId":"wWz69IwsAnx-6GxGC5we4","msg":"User credentials created"}
[90mstderr[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768516036174,"env":"test","module":"auth-routes","userId":"668ab6ca0a19a78269fde0591cfce404","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould require MFA for enabled users
[22m[39m[TEST UTILS] MFA Secret verified for f0f1cc3b9b45479a17e5b1b8843b1c64

{"level":30,"time":1768516036232,"env":"test","module":"user-credentials-repository","userId":"G-FnSOZ3TCFk4wuOONLMt","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return requiresMfa=true for MFA-enabled users
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768516036275,"env":"test","module":"mfa-service","userId":"668ab6ca0a19a78269fde0591cfce404","msg":"TOTP verification successful"}
{"level":30,"time":1768516036326,"env":"test","module":"auth-routes","userId":"668ab6ca0a19a78269fde0591cfce404","msg":"MFA login successful"}
{"level":30,"time":1768516036341,"env":"test","module":"auth-routes","userId":"G-FnSOZ3TCFk4wuOONLMt","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768516036356,"env":"test","module":"auth-routes","userId":"d266a9453b7fc5c1a06b497d8eac9fb3","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,d266a9453b7fc5c1a06b497d8eac9fb3,login_success,security,d266a9453b7fc5c1a06b497d8eac9fb3,security,d266a9453b7fc5c1a06b497d8eac9fb3,{"metadata":{"timestamp":"2026-01-15T22:27:16.356Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:16.356Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'd266a9453b7fc5c1a06b497d8eac9fb3'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'd266a9453b7fc5c1a06b497d8eac9fb3'[39m,
    [32m'security'[39m,
    [32m'd266a9453b7fc5c1a06b497d8eac9fb3'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:16.356Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:16.356Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516036400,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"d266a9453b7fc5c1a06b497d8eac9fb3","login_success","security","d266a9453b7fc5c1a06b497d8eac9fb3","security","d266a9453b7fc5c1a06b497d8eac9fb3","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:16.356Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:16.356Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"d266a9453b7fc5c1a06b497d8eac9fb3","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768516036400,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"d266a9453b7fc5c1a06b497d8eac9fb3","login_success","security","d266a9453b7fc5c1a06b497d8eac9fb3","security","d266a9453b7fc5c1a06b497d8eac9fb3","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:16.356Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:16.356Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768516036429,"env":"test","module":"auth-routes","userId":"668ab6ca0a19a78269fde0591cfce404","deviceCount":2,"msg":"Listed trusted devices"}
{"level":30,"time":1768516036500,"env":"test","module":"user-credentials-repository","userId":"cFdvHbNLtqnofwOrnf8qL","msg":"User credentials created"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould require MFA for enabled users
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516036508,"env":"test","module":"auth-routes","userId":"6c479f44a6e9ec92adf6a95010d71efc","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768516036562,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"6c479f44a6e9ec92adf6a95010d71efc","login_success","security","6c479f44a6e9ec92adf6a95010d71efc","security","6c479f44a6e9ec92adf6a95010d71efc","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:16.508Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:16.508Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"6c479f44a6e9ec92adf6a95010d71efc","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,6c479f44a6e9ec92adf6a95010d71efc,login_success,security,6c479f44a6e9ec92adf6a95010d71efc,security,6c479f44a6e9ec92adf6a95010d71efc,{"metadata":{"timestamp":"2026-01-15T22:27:16.508Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:16.508Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'6c479f44a6e9ec92adf6a95010d71efc'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'6c479f44a6e9ec92adf6a95010d71efc'[39m,
    [32m'security'[39m,
    [32m'6c479f44a6e9ec92adf6a95010d71efc'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:16.508Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:16.508Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516036562,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"6c479f44a6e9ec92adf6a95010d71efc","login_success","security","6c479f44a6e9ec92adf6a95010d71efc","security","6c479f44a6e9ec92adf6a95010d71efc","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:16.508Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:16.508Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516036570,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

{"level":30,"time":1768516036738,"env":"test","module":"user-credentials-repository","userId":"fXbfoXTWni1_r3Owsm6kl","msg":"User credentials created"}
{"level":30,"time":1768516036783,"env":"test","module":"auth-routes","userId":"bd91e24f25963e94ed8c9ea5d37c538b","msg":"Login requires MFA verification"}
{"level":30,"time":1768516036893,"env":"test","module":"auth-routes","userId":"fXbfoXTWni1_r3Owsm6kl","deviceId":"96efc1fd-d431-41cc-9d97-ea0b7c0d0a32","msg":"Trusted device revoked"}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768516036959,"env":"test","module":"user-credentials-repository","userId":"uJcGNPhC3GsFgnI9DV2ME","msg":"User credentials created"}
{"level":30,"time":1768516037007,"env":"test","module":"auth-routes","userId":"f0f1cc3b9b45479a17e5b1b8843b1c64","msg":"Login requires MFA verification"}
[90mstderr[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516037318,"env":"test","module":"user-credentials-repository","userId":"EulrNsX9hXOCvlWD3GUcQ","msg":"User credentials created"}
{"level":30,"time":1768516037326,"env":"test","module":"auth-routes","userId":"d266a9453b7fc5c1a06b497d8eac9fb3","msg":"User logged in successfully"}
{"level":50,"time":1768516037375,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"d266a9453b7fc5c1a06b497d8eac9fb3","login_success","security","d266a9453b7fc5c1a06b497d8eac9fb3","security","d266a9453b7fc5c1a06b497d8eac9fb3","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:17.326Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:17.326Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"d266a9453b7fc5c1a06b497d8eac9fb3","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,d266a9453b7fc5c1a06b497d8eac9fb3,login_success,security,d266a9453b7fc5c1a06b497d8eac9fb3,security,d266a9453b7fc5c1a06b497d8eac9fb3,{"metadata":{"timestamp":"2026-01-15T22:27:17.326Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:17.326Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'd266a9453b7fc5c1a06b497d8eac9fb3'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'd266a9453b7fc5c1a06b497d8eac9fb3'[39m,
    [32m'security'[39m,
    [32m'd266a9453b7fc5c1a06b497d8eac9fb3'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:17.326Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:17.326Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516037375,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"d266a9453b7fc5c1a06b497d8eac9fb3","login_success","security","d266a9453b7fc5c1a06b497d8eac9fb3","security","d266a9453b7fc5c1a06b497d8eac9fb3","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:17.326Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:17.326Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 2de7dcc9aa0bf6341ea81a65002d0748

{"level":30,"time":1768516037546,"env":"test","module":"user-credentials-repository","userId":"xjktfcbwTdHH2eDqrnCPo","msg":"User credentials created"}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516037685,"env":"test","module":"user-credentials-repository","userId":"gp4uTA9Oq1eXSFBHXQrtH","msg":"User credentials created"}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould login with backup code when TOTP unavailable
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould complete MFA login with valid TOTP
[22m[39m[TEST UTILS] MFA Secret verified for 105ab858631132941743e9fe5892c70b

{"level":30,"time":1768516038168,"env":"test","module":"user-credentials-repository","userId":"2ZDUVfeMLFp-oiQt6JLMp","msg":"User credentials created"}
{"level":30,"time":1768516038174,"env":"test","module":"user-credentials-repository","userId":"r8VdgEUzYNYGJ6CyUhf67","msg":"User credentials created"}
{"level":50,"time":1768516038258,"env":"test","module":"auth-routes","email":"test-1768516037360-jdkbih@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768516038355,"env":"test","module":"auth-routes","userId":"d266a9453b7fc5c1a06b497d8eac9fb3","msg":"User logged in successfully"}
{"level":50,"time":1768516038361,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516038397,"env":"test","module":"auth-routes","userId":"2de7dcc9aa0bf6341ea81a65002d0748","msg":"Login requires MFA verification"}
{"level":50,"time":1768516038403,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"d266a9453b7fc5c1a06b497d8eac9fb3","login_success","security","d266a9453b7fc5c1a06b497d8eac9fb3","security","d266a9453b7fc5c1a06b497d8eac9fb3","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:18.355Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:18.355Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"d266a9453b7fc5c1a06b497d8eac9fb3","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,d266a9453b7fc5c1a06b497d8eac9fb3,login_success,security,d266a9453b7fc5c1a06b497d8eac9fb3,security,d266a9453b7fc5c1a06b497d8eac9fb3,{"metadata":{"timestamp":"2026-01-15T22:27:18.355Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:18.355Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'd266a9453b7fc5c1a06b497d8eac9fb3'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'd266a9453b7fc5c1a06b497d8eac9fb3'[39m,
    [32m'security'[39m,
    [32m'd266a9453b7fc5c1a06b497d8eac9fb3'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:18.355Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:18.355Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516038403,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"d266a9453b7fc5c1a06b497d8eac9fb3","login_success","security","d266a9453b7fc5c1a06b497d8eac9fb3","security","d266a9453b7fc5c1a06b497d8eac9fb3","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:18.355Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:18.355Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516038411,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould complete MFA login with valid TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w38
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w38,public

{"level":30,"time":1768516038497,"env":"test","module":"mfa-service","userId":"2de7dcc9aa0bf6341ea81a65002d0748","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w40
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w40,public

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w38 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w38%2Cpublic

{"level":30,"time":1768516038534,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516038543,"env":"test","module":"auth-routes","userId":"2de7dcc9aa0bf6341ea81a65002d0748","msg":"MFA login successful"}
{"level":30,"time":1768516038543,"env":"test","module":"auth-routes","userId":"b8f6b54348ef6e7d42400b7ff33250d8","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w39
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w39,public

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w40 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w40%2Cpublic

{"level":30,"time":1768516038572,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w41
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w41,public

[90mstderr[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768516038585,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768516038594,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"b8f6b54348ef6e7d42400b7ff33250d8","login_success","security","b8f6b54348ef6e7d42400b7ff33250d8","security","b8f6b54348ef6e7d42400b7ff33250d8","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:18.544Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:18.544Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"b8f6b54348ef6e7d42400b7ff33250d8","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould login with backup code when TOTP unavailable
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,b8f6b54348ef6e7d42400b7ff33250d8,login_success,security,b8f6b54348ef6e7d42400b7ff33250d8,security,b8f6b54348ef6e7d42400b7ff33250d8,{"metadata":{"timestamp":"2026-01-15T22:27:18.544Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:18.544Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'b8f6b54348ef6e7d42400b7ff33250d8'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'b8f6b54348ef6e7d42400b7ff33250d8'[39m,
    [32m'security'[39m,
    [32m'b8f6b54348ef6e7d42400b7ff33250d8'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:18.544Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:18.544Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516038595,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"b8f6b54348ef6e7d42400b7ff33250d8","login_success","security","b8f6b54348ef6e7d42400b7ff33250d8","security","b8f6b54348ef6e7d42400b7ff33250d8","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:18.544Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:18.544Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516038602,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w39 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w39%2Cpublic

{"level":30,"time":1768516038608,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w41 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w41%2Cpublic

{"level":30,"time":1768516038623,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516038621,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516038657,"env":"test","module":"user-credentials-repository","userId":"Ye6wzwudCdfqZleQ6eXTU","msg":"User credentials created"}
{"level":30,"time":1768516038660,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516038674,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516038687,"env":"test","module":"auth-routes","userId":"2de7dcc9aa0bf6341ea81a65002d0748","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":50,"time":1768516038776,"env":"test","module":"auth-routes","email":"test-1768516037360-jdkbih@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768516038787,"env":"test","module":"auth-routes","userId":"2de7dcc9aa0bf6341ea81a65002d0748","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768516038856,"env":"test","module":"auth-service","tokenHash":"909e99b8930f96f24da63e414b954f529900421975e74053c083a169d1c122a6","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstderr[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":50,"time":1768516038875,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516038932,"env":"test","module":"auth-routes","userId":"105ab858631132941743e9fe5892c70b","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w38, public

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w40, public

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w38
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w39, public

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w40
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w41, public

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w18.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w18.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516039035,"env":"test","module":"mfa-service","userId":"105ab858631132941743e9fe5892c70b","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w39
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w41
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w18.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w18.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516039083,"env":"test","module":"auth-routes","userId":"105ab858631132941743e9fe5892c70b","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768516039115,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516039116,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

 [31m‚ùØ[39m tests/integration/auth/oauth2.sessions.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 14091[2mms[22m[39m
       [33m[2m‚úì[22m[39m should list all active sessions for current user [33m 549[2mms[22m[39m
       [33m[2m‚úì[22m[39m should mark current session as current [33m 434[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return empty array when user has no active sessions [33m 432[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not include expired sessions [33m 432[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not include revoked sessions [33m 467[2mms[22m[39m
       [33m[2m‚úì[22m[39m should parse device name from user agent [33m 443[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for unauthenticated request [33m 343[2mms[22m[39m
       [33m[2m‚úì[22m[39m should revoke a specific session [33m 616[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 404 for non-existent session [33m 371[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent revoking current session [33m 579[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent revoking another user's session [33m 576[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for unauthenticated request [33m 387[2mms[22m[39m
[31m       [31m√ó[31m should revoke all sessions except current[39m[33m 876[2mms[22m[39m
[31m       [31m√ó[31m should revoke all trusted devices[39m[33m 598[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 400 when no active session found [33m 372[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for unauthenticated request [33m 381[2mms[22m[39m
         [33m[2m‚úì[22m[39m should mark current device as trusted [33m 565[2mms[22m[39m
         [33m[2m‚úì[22m[39m should update existing trusted device expiry [33m 692[2mms[22m[39m
         [33m[2m‚úì[22m[39m should list all trusted devices [33m 484[2mms[22m[39m
         [33m[2m‚úì[22m[39m should not include revoked devices [33m 510[2mms[22m[39m
         [33m[2m‚úì[22m[39m should revoke a trusted device [33m 597[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return 404 for non-existent device [33m 384[2mms[22m[39m
       [33m[2m‚úì[22m[39m should track IP address for sessions [33m 450[2mms[22m[39m
       [33m[2m‚úì[22m[39m should track user agent for sessions [33m 488[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update lastUsedAt on token refresh [33m 853[2mms[22m[39m
{"level":50,"time":1768516039266,"env":"test","module":"auth-routes","email":"test-1768516037360-jdkbih@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768516039356,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w42
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w42,public

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w42 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w42%2Cpublic

{"level":30,"time":1768516039458,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516039507,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

{"level":50,"time":1768516039731,"env":"test","module":"auth-routes","email":"test-1768516037360-jdkbih@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for 86303a8b5a0a1b2ea286c8fc4b0a80e2

{"level":50,"time":1768516039825,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w42, public

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w42
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w38.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w40.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w39.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w41.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w38.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w40.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould transfer user-owned project to org
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,81b6e027-b56b-4681-afe5-3f56d6a4f911,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'81b6e027-b56b-4681-afe5-3f56d6a4f911'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould create placeholder user for non-existent email
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,e023f29d-608f-4419-9768-c43689cbfbeb,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'e023f29d-608f-4419-9768-c43689cbfbeb'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w39.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w41.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mcreateOrganization[2m > [22m[2mshould create organization and auto-create admin membership
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,63c06527-2042-4d94-b33e-95e4fbd48c62,{"after":{"name":"Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'63c06527-2042-4d94-b33e-95e4fbd48c62'[39m,
    [32m'{"after":{"name":"Test Org Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:74:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould reject invalid TOTP during login
[22m[39m[TEST UTILS] MFA Secret verified for 4771bc0ff3f846932da616fd9bf5d9e9

{"level":30,"time":1768516040173,"env":"test","module":"email-queue","jobId":"c34633a8-a82e-4d71-82d3-f49977a1b5f1","to":"test-1768516039591-4e4eg7@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768516040173,"env":"test","module":"auth-service","email":"test-1768516039591-4e4eg7@example.com","msg":"Password reset email sent"}
{"level":50,"time":1768516040213,"env":"test","module":"auth-routes","email":"test-1768516037360-jdkbih@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould transfer user-owned project to org
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:97:30
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w44
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w44,public

{"level":40,"time":1768516040405,"env":"test","module":"account-lockout","userId":"f11b9340120cebe2631db3ae1e24cc78","email":"test-1768516037360-jdkbih@example.com","lockedUntil":"2026-01-15T22:42:20.355Z","msg":"Account locked due to too many failed attempts"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768516040406,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w44 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w44%2Cpublic

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould reject invalid TOTP during login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516040470,"env":"test","module":"email-queue","jobId":"00a68d4a-2f0f-4d54-b363-edf86eccd598","to":"test-1768516039591-4e4eg7@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768516040470,"env":"test","module":"auth-service","email":"test-1768516039591-4e4eg7@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w43
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w43,public

{"level":40,"time":1768516040505,"env":"test","module":"auth-routes","userId":"f11b9340120cebe2631db3ae1e24cc78","email":"test-1768516037360-jdkbih@example.com","msg":"Login blocked: account locked"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: AccountLockedError: Account is locked until 2026-01-15T22:42:20.355Z
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:62:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_005'[39m,
  statusCode: [33m423[39m,
  isOperational: [33mtrue[39m,
  lockedUntil: [35m2026-01-15T22:42:20.355Z[39m,
  remainingMinutes: [33m15[39m
}

{"level":50,"time":1768516040505,"env":"test","module":"auth-routes","error":{"name":"AccountLockedError","code":"AUTH_005","statusCode":423,"isOperational":true,"lockedUntil":"2026-01-15T22:42:20.355Z","remainingMinutes":15},"msg":"Login failed"}
{"level":30,"time":1768516040518,"env":"test","module":"auth-routes","userId":"941663ebb8d73818c374fc3dbc47e208","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w43 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w43%2Cpublic

{"level":30,"time":1768516040536,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768516040565,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"941663ebb8d73818c374fc3dbc47e208","login_success","security","941663ebb8d73818c374fc3dbc47e208","security","941663ebb8d73818c374fc3dbc47e208","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:20.518Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:20.518Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"941663ebb8d73818c374fc3dbc47e208","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,941663ebb8d73818c374fc3dbc47e208,login_success,security,941663ebb8d73818c374fc3dbc47e208,security,941663ebb8d73818c374fc3dbc47e208,{"metadata":{"timestamp":"2026-01-15T22:27:20.518Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:20.518Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'941663ebb8d73818c374fc3dbc47e208'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'941663ebb8d73818c374fc3dbc47e208'[39m,
    [32m'security'[39m,
    [32m'941663ebb8d73818c374fc3dbc47e208'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:20.518Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:20.518Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516040565,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"941663ebb8d73818c374fc3dbc47e208","login_success","security","941663ebb8d73818c374fc3dbc47e208","security","941663ebb8d73818c374fc3dbc47e208","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:20.518Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:20.518Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768516040570,"env":"test","module":"auth-routes","userId":"86303a8b5a0a1b2ea286c8fc4b0a80e2","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516040576,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516040585,"env":"test","module":"email-queue","jobId":"de3cd49e-faea-4f43-a728-f07448f1fcff","to":"newuser_1768516038034@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":30,"time":1768516040667,"env":"test","module":"mfa-service","userId":"86303a8b5a0a1b2ea286c8fc4b0a80e2","msg":"TOTP verification successful"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould create placeholder user for non-existent email
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,e023f29d-608f-4419-9768-c43689cbfbeb,{"after":{"invitedEmail":"newuser_1768516038034@test.com","token":"bb1f1383d39fde47d453eb34adc04220a675a35fdc03a4b64e4565a5935f91dd"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'e023f29d-608f-4419-9768-c43689cbfbeb'[39m,
    [32m'{"after":{"invitedEmail":"newuser_1768516038034@test.com","token":"bb1f1383d39fde47d453eb34adc04220a675a35fdc03a4b64e4565a5935f91dd"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:81:28
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516040715,"env":"test","module":"auth-routes","userId":"86303a8b5a0a1b2ea286c8fc4b0a80e2","msg":"MFA login successful"}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w44, public

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w44
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516040861,"env":"test","module":"user-credentials-repository","userId":"326c687e54e681ce16398f611ca30f7c","msg":"User password updated"}
{"level":30,"time":1768516040865,"env":"test","module":"auth-routes","userId":"86303a8b5a0a1b2ea286c8fc4b0a80e2","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w42.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w42.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516040885,"env":"test","module":"auth-routes","userId":"4771bc0ff3f846932da616fd9bf5d9e9","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w43, public

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w46
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w46,public

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w45
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w45,public

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w46 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w46%2Cpublic

{"level":30,"time":1768516040975,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w43
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w45 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w45%2Cpublic

{"level":30,"time":1768516040982,"env":"test","msg":"DB: initializing... Local"}
{"level":40,"time":1768516040986,"env":"test","module":"mfa-service","userId":"4771bc0ff3f846932da616fd9bf5d9e9","msg":"TOTP verification failed"}
{"level":40,"time":1768516040986,"env":"test","module":"auth-routes","userId":"4771bc0ff3f846932da616fd9bf5d9e9","msg":"MFA verification failed during login"}
{"level":30,"time":1768516041020,"env":"test","module":"auth-routes","userId":"86303a8b5a0a1b2ea286c8fc4b0a80e2","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w44.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w44.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516041023,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768516041022,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"326c687e54e681ce16398f611ca30f7c","password_reset","security","326c687e54e681ce16398f611ca30f7c","security","326c687e54e681ce16398f611ca30f7c","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:20.975Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:20.975Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"326c687e54e681ce16398f611ca30f7c","eventType":"password_reset","msg":"Failed to log security event"}
{"level":50,"time":1768516041022,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"326c687e54e681ce16398f611ca30f7c","password_reset","security","326c687e54e681ce16398f611ca30f7c","security","326c687e54e681ce16398f611ca30f7c","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:20.975Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:20.975Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Reset password error"}
{"level":30,"time":1768516041032,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mgetUserOrganizations[2m > [22m[2mshould return all organizations for user
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,62cd5384-806c-4ecb-b321-31aae8ebf16d,{"after":{"name":"User Org Test Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'62cd5384-806c-4ecb-b321-31aae8ebf16d'[39m,
    [32m'{"after":{"name":"User Org Test Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:100:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516041346,"env":"test","module":"auth-routes","userId":"941663ebb8d73818c374fc3dbc47e208","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w46, public

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w45, public

{"level":50,"time":1768516041395,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"941663ebb8d73818c374fc3dbc47e208","login_success","security","941663ebb8d73818c374fc3dbc47e208","security","941663ebb8d73818c374fc3dbc47e208","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:21.346Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:21.346Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"941663ebb8d73818c374fc3dbc47e208","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,941663ebb8d73818c374fc3dbc47e208,login_success,security,941663ebb8d73818c374fc3dbc47e208,security,941663ebb8d73818c374fc3dbc47e208,{"metadata":{"timestamp":"2026-01-15T22:27:21.346Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:21.346Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'941663ebb8d73818c374fc3dbc47e208'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'941663ebb8d73818c374fc3dbc47e208'[39m,
    [32m'security'[39m,
    [32m'941663ebb8d73818c374fc3dbc47e208'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:21.346Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:21.346Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516041396,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"941663ebb8d73818c374fc3dbc47e208","login_success","security","941663ebb8d73818c374fc3dbc47e208","security","941663ebb8d73818c374fc3dbc47e208","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:21.346Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:21.346Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w46
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w45
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w43.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w43.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/logout[2m > [22m[2mshould logout and clear refresh token cookie
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w43.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w43.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,fe6dbf6f-a79a-4139-b4b8-b693afd99fce,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'fe6dbf6f-a79a-4139-b4b8-b693afd99fce'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516041908,"env":"test","module":"auth-routes","userId":"7fc36bf210b36cb1af9a856eedc4530c","msg":"User logged in successfully"}
{"level":50,"time":1768516041957,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"7fc36bf210b36cb1af9a856eedc4530c","login_success","security","7fc36bf210b36cb1af9a856eedc4530c","security","7fc36bf210b36cb1af9a856eedc4530c","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:21.908Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:21.908Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"7fc36bf210b36cb1af9a856eedc4530c","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/logout[2m > [22m[2mshould logout and clear refresh token cookie
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,7fc36bf210b36cb1af9a856eedc4530c,login_success,security,7fc36bf210b36cb1af9a856eedc4530c,security,7fc36bf210b36cb1af9a856eedc4530c,{"metadata":{"timestamp":"2026-01-15T22:27:21.908Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:21.908Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'7fc36bf210b36cb1af9a856eedc4530c'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'7fc36bf210b36cb1af9a856eedc4530c'[39m,
    [32m'security'[39m,
    [32m'7fc36bf210b36cb1af9a856eedc4530c'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:21.908Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:21.908Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516041958,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"7fc36bf210b36cb1af9a856eedc4530c","login_success","security","7fc36bf210b36cb1af9a856eedc4530c","security","7fc36bf210b36cb1af9a856eedc4530c","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:21.908Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:21.908Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768516042130,"env":"test","module":"auth-routes","userId":"9497f8ce33397a7b711d84f722537ea0","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,9742dfda-92b1-41ce-aa0d-626ab8fef0a7,organization.create,organization,d25ed85c-8df9-45b7-b937-e5d3bfbd86f1,{"after":{"name":"Test Org Audit","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:58:17 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'9742dfda-92b1-41ce-aa0d-626ab8fef0a7'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'd25ed85c-8df9-45b7-b937-e5d3bfbd86f1'[39m,
    [32m'{"after":{"name":"Test Org Audit","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:58:17 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould create invite for existing user without creating placeholder
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,29fcfa2f-2e7e-4d94-a401-2b16172d67df,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'29fcfa2f-2e7e-4d94-a401-2b16172d67df'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516042176,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"9497f8ce33397a7b711d84f722537ea0","login_success","security","9497f8ce33397a7b711d84f722537ea0","security","9497f8ce33397a7b711d84f722537ea0","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:22.130Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:22.130Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"9497f8ce33397a7b711d84f722537ea0","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,9497f8ce33397a7b711d84f722537ea0,login_success,security,9497f8ce33397a7b711d84f722537ea0,security,9497f8ce33397a7b711d84f722537ea0,{"metadata":{"timestamp":"2026-01-15T22:27:22.130Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:22.130Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'9497f8ce33397a7b711d84f722537ea0'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'9497f8ce33397a7b711d84f722537ea0'[39m,
    [32m'security'[39m,
    [32m'9497f8ce33397a7b711d84f722537ea0'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:22.130Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:22.130Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516042177,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"9497f8ce33397a7b711d84f722537ea0","login_success","security","9497f8ce33397a7b711d84f722537ea0","security","9497f8ce33397a7b711d84f722537ea0","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:22.130Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:22.130Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516042182,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for 2c71be21c2700a8d31ad09831e46db52

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould accept TOTP codes within 60-second window
[22m[39m[TEST UTILS] MFA Secret verified for 4737ecf08f8c2aa07219fcdf2903fb8b

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould invalidate all sessions after password reset
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mComplete Organization Workflow[2m > [22m[2mStep 1: Create organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,d4120252-1510-4751-b8c5-0adc6329e83d,organization.create,organization,f1847d55-e2c3-48d1-b3e4-d26186d06bfa,{"after":{"name":"Test Organization","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'd4120252-1510-4751-b8c5-0adc6329e83d'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'f1847d55-e2c3-48d1-b3e4-d26186d06bfa'[39m,
    [32m'{"after":{"name":"Test Organization","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:92:19
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,92ca655d-f276-4280-a36d-b62183664c39,{"after":{"name":"Other Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'92ca655d-f276-4280-a36d-b62183664c39'[39m,
    [32m'{"after":{"name":"Other Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:131:30
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould accept TOTP codes within 60-second window
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #1: Project transfer cascades runs ownership[2m > [22m[2mshould cascade ownership to workflow runs when project is transferred
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:124:24
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

{"level":30,"time":1768516042749,"env":"test","module":"auth-routes","userId":"6d32dc8bff120029e3777b254c475d9e","msg":"User logged in successfully"}
{"level":50,"time":1768516042794,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"6d32dc8bff120029e3777b254c475d9e","login_success","security","6d32dc8bff120029e3777b254c475d9e","security","6d32dc8bff120029e3777b254c475d9e","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:22.749Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:22.749Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"6d32dc8bff120029e3777b254c475d9e","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould invalidate all sessions after password reset
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,6d32dc8bff120029e3777b254c475d9e,login_success,security,6d32dc8bff120029e3777b254c475d9e,security,6d32dc8bff120029e3777b254c475d9e,{"metadata":{"timestamp":"2026-01-15T22:27:22.749Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:22.749Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'6d32dc8bff120029e3777b254c475d9e'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'6d32dc8bff120029e3777b254c475d9e'[39m,
    [32m'security'[39m,
    [32m'6d32dc8bff120029e3777b254c475d9e'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:22.749Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:22.749Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516042795,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"6d32dc8bff120029e3777b254c475d9e","login_success","security","6d32dc8bff120029e3777b254c475d9e","security","6d32dc8bff120029e3777b254c475d9e","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:22.749Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:22.749Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768516042859,"env":"test","module":"email-queue","jobId":"5d98a0b9-0f2f-4a0a-a680-2f7da485a04c","to":"existing_1768516038034@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":30,"time":1768516042868,"env":"test","module":"email-queue","jobId":"1bb8fef8-6910-406a-87d2-e9a9e455286a","to":"org-member@test.com","subject":"You've been invited to join Test Organization","msg":"Email added to queue"}
{"level":30,"time":1768516042938,"env":"test","module":"auth-routes","userId":"2c71be21c2700a8d31ad09831e46db52","msg":"Login requires MFA verification"}
{"level":30,"time":1768516042945,"env":"test","module":"auth-routes","userId":"4737ecf08f8c2aa07219fcdf2903fb8b","msg":"Login requires MFA verification"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould create invite for existing user without creating placeholder
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,29fcfa2f-2e7e-4d94-a401-2b16172d67df,{"after":{"invitedEmail":"existing_1768516038034@test.com","token":"994ebdc412d46eaf3f142ed79de21f264b273e053e7d132fee1f3d9af157fbf0"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'29fcfa2f-2e7e-4d94-a401-2b16172d67df'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768516038034@test.com","token":"994ebdc412d46eaf3f142ed79de21f264b273e053e7d132fee1f3d9af157fbf0"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:100:28
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mComplete Organization Workflow[2m > [22m[2mStep 2: Invite member via email
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,d4120252-1510-4751-b8c5-0adc6329e83d,organization.invite_send,organization,f1847d55-e2c3-48d1-b3e4-d26186d06bfa,{"after":{"invitedEmail":"org-member@test.com","token":"b688311380bd77fa299a25bfe4bc27f9f3fd1c9ceb5770ffd6be9b93298d8f18"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'd4120252-1510-4751-b8c5-0adc6329e83d'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'f1847d55-e2c3-48d1-b3e4-d26186d06bfa'[39m,
    [32m'{"after":{"invitedEmail":"org-member@test.com","token":"b688311380bd77fa299a25bfe4bc27f9f3fd1c9ceb5770ffd6be9b93298d8f18"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:117:22
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516043035,"env":"test","module":"mfa-service","userId":"2c71be21c2700a8d31ad09831e46db52","msg":"TOTP verification successful"}
{"level":30,"time":1768516043048,"env":"test","module":"mfa-service","userId":"4737ecf08f8c2aa07219fcdf2903fb8b","msg":"TOTP verification successful"}
{"level":30,"time":1768516043081,"env":"test","module":"auth-routes","userId":"2c71be21c2700a8d31ad09831e46db52","msg":"MFA login successful"}
{"level":30,"time":1768516043093,"env":"test","module":"auth-routes","userId":"4737ecf08f8c2aa07219fcdf2903fb8b","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould accept TOTP codes within 60-second window
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mupdateOrganization[2m > [22m[2mshould allow admin to update organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,f047458b-43b6-4433-88f4-b26e2f7f1a72,{"after":{"name":"Original Name Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'f047458b-43b6-4433-88f4-b26e2f7f1a72'[39m,
    [32m'{"after":{"name":"Original Name Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:122:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516043228,"env":"test","module":"auth-routes","userId":"2c71be21c2700a8d31ad09831e46db52","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould refresh access token with valid refresh token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516043279,"env":"test","module":"email-queue","jobId":"3bf65d90-344d-4a3d-b42e-930a64f57632","to":"test-1768516041933-w1002c@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768516043279,"env":"test","module":"auth-service","email":"test-1768516041933-w1002c@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768516043373,"env":"test","module":"auth-routes","userId":"2c71be21c2700a8d31ad09831e46db52","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768516043488,"env":"test","module":"user-credentials-repository","userId":"It3fo9lC3bLNk_i0etM7B","msg":"User credentials created"}
{"level":30,"time":1768516043547,"env":"test","module":"auth-routes","userId":"4737ecf08f8c2aa07219fcdf2903fb8b","msg":"Login requires MFA verification"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould allow org member to transfer org-owned project to another org they belong to
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,5bfa9884-2be4-42b1-8fea-0b31bfdc2bf9,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'5bfa9884-2be4-42b1-8fea-0b31bfdc2bf9'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516043646,"env":"test","module":"user-credentials-repository","userId":"6d32dc8bff120029e3777b254c475d9e","msg":"User password updated"}
{"level":30,"time":1768516043646,"env":"test","module":"mfa-service","userId":"4737ecf08f8c2aa07219fcdf2903fb8b","msg":"TOTP verification successful"}
{"level":50,"time":1768516043655,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768516043698,"env":"test","module":"auth-routes","userId":"4737ecf08f8c2aa07219fcdf2903fb8b","msg":"MFA login successful"}
{"level":30,"time":1768516043703,"env":"test","module":"auth-routes","userId":"8f81282a3cd2b27a19095e09247eba75","msg":"User logged in successfully"}
{"level":50,"time":1768516043746,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"8f81282a3cd2b27a19095e09247eba75","login_success","security","8f81282a3cd2b27a19095e09247eba75","security","8f81282a3cd2b27a19095e09247eba75","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:23.703Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:23.703Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"8f81282a3cd2b27a19095e09247eba75","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould refresh access token with valid refresh token
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,8f81282a3cd2b27a19095e09247eba75,login_success,security,8f81282a3cd2b27a19095e09247eba75,security,8f81282a3cd2b27a19095e09247eba75,{"metadata":{"timestamp":"2026-01-15T22:27:23.703Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:23.703Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'8f81282a3cd2b27a19095e09247eba75'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'8f81282a3cd2b27a19095e09247eba75'[39m,
    [32m'security'[39m,
    [32m'8f81282a3cd2b27a19095e09247eba75'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:23.703Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:23.703Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516043747,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"8f81282a3cd2b27a19095e09247eba75","login_success","security","8f81282a3cd2b27a19095e09247eba75","security","8f81282a3cd2b27a19095e09247eba75","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:23.703Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:23.703Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768516043752,"env":"test","module":"auth-service","tokenHash":"839920d9360076348995912582c195bdf2460352eb2961d8bb6c65e968229d8d","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768516043795,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"6d32dc8bff120029e3777b254c475d9e","password_reset","security","6d32dc8bff120029e3777b254c475d9e","security","6d32dc8bff120029e3777b254c475d9e","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:23.745Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:23.745Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"6d32dc8bff120029e3777b254c475d9e","eventType":"password_reset","msg":"Failed to log security event"}
{"level":50,"time":1768516043796,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"6d32dc8bff120029e3777b254c475d9e","password_reset","security","6d32dc8bff120029e3777b254c475d9e","security","6d32dc8bff120029e3777b254c475d9e","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:23.745Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:23.745Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Reset password error"}
{"level":50,"time":1768516043800,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mComplete Organization Workflow[2m > [22m[2mStep 3: Accept invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,5f53091f-e85d-4d7a-a0bd-95b6c931acc2,organization.invite_accept,organization,f1847d55-e2c3-48d1-b3e4-d26186d06bfa,{"after":{"email":"org-member@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'5f53091f-e85d-4d7a-a0bd-95b6c931acc2'[39m,
    [32m'organization.invite_accept'[39m,
    [32m'organization'[39m,
    [32m'f1847d55-e2c3-48d1-b3e4-d26186d06bfa'[39m,
    [32m'{"after":{"email":"org-member@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:141:22
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516043819,"env":"test","module":"email-queue","jobId":"49ed7a2a-f609-436f-b4c2-d0a96354137d","to":"audit-user2@test.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #2: Invite acceptance race condition[2m > [22m[2mshould prevent double-acceptance via transaction
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,9742dfda-92b1-41ce-aa0d-626ab8fef0a7,organization.invite_send,organization,d25ed85c-8df9-45b7-b937-e5d3bfbd86f1,{"after":{"invitedEmail":"audit-user2@test.com","token":"a28c5e2a2ba3d8919e54eba271a1cebe10539d4766697f9848af7ad05eb1cef5"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'9742dfda-92b1-41ce-aa0d-626ab8fef0a7'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'd25ed85c-8df9-45b7-b937-e5d3bfbd86f1'[39m,
    [32m'{"after":{"invitedEmail":"audit-user2@test.com","token":"a28c5e2a2ba3d8919e54eba271a1cebe10539d4766697f9848af7ad05eb1cef5"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:164:22
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516043963,"env":"test","module":"user-credentials-repository","userId":"appddLe9C8RnLfPsvHVVh","msg":"User credentials created"}
{"level":30,"time":1768516044012,"env":"test","module":"auth-service","tokenHash":"e7e782fc0987311be971a82d66900534c6f5e51d7dff9f785d7a48d3cbb7241a","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516044198,"env":"test","module":"auth-service","tokenHash":"e7e782fc0987311be971a82d66900534c6f5e51d7dff9f785d7a48d3cbb7241a","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mupdateOrganization[2m > [22m[2mshould deny non-admin from updating organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,c8421629-e012-4646-abcf-83401cb81ce6,{"after":{"name":"Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'c8421629-e012-4646-abcf-83401cb81ce6'[39m,
    [32m'{"after":{"name":"Test Org Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:139:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould prevent duplicate pending invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,757a7760-dfc5-47cc-9e48-099a17677b88,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'757a7760-dfc5-47cc-9e48-099a17677b88'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":40,"time":1768516044244,"env":"test","module":"auth-service","userId":"appddLe9C8RnLfPsvHVVh","tokenHash":"e7e782fc0987311be971a82d66900534c6f5e51d7dff9f785d7a48d3cbb7241a","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mComplete Organization Workflow[2m > [22m[2mStep 4: Create workflow owned by user
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:167:24
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 62199d3f97e08946c8543781824cec4f

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould allow org member to transfer org-owned project to another org they belong to
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,e449dff3-bb4c-46f9-adcd-27bd8a3e15b5,{"after":{"name":"Second Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'e449dff3-bb4c-46f9-adcd-27bd8a3e15b5'[39m,
    [32m'{"after":{"name":"Second Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:154:26
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516044481,"env":"test","module":"auth-routes","userId":"ab07070235b68a252bda5d42fb7eb4c4","msg":"User logged in successfully"}
{"level":50,"time":1768516044524,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"ab07070235b68a252bda5d42fb7eb4c4","login_success","security","ab07070235b68a252bda5d42fb7eb4c4","security","ab07070235b68a252bda5d42fb7eb4c4","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:24.481Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:24.481Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"ab07070235b68a252bda5d42fb7eb4c4","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,ab07070235b68a252bda5d42fb7eb4c4,login_success,security,ab07070235b68a252bda5d42fb7eb4c4,security,ab07070235b68a252bda5d42fb7eb4c4,{"metadata":{"timestamp":"2026-01-15T22:27:24.481Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:24.481Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'ab07070235b68a252bda5d42fb7eb4c4'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'ab07070235b68a252bda5d42fb7eb4c4'[39m,
    [32m'security'[39m,
    [32m'ab07070235b68a252bda5d42fb7eb4c4'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:24.481Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:24.481Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516044524,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"ab07070235b68a252bda5d42fb7eb4c4","login_success","security","ab07070235b68a252bda5d42fb7eb4c4","security","ab07070235b68a252bda5d42fb7eb4c4","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:24.481Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:24.481Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516044616,"env":"test","module":"user-credentials-repository","userId":"u_lmdROu_Al4V28JKJYw9","msg":"User credentials created"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #2: Invite acceptance race condition[2m > [22m[2mshould prevent double-acceptance via transaction
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,b1a91269-b99f-4721-8467-82b13241a077,organization.invite_accept,organization,d25ed85c-8df9-45b7-b937-e5d3bfbd86f1,{"after":{"email":"audit-user2@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'b1a91269-b99f-4721-8467-82b13241a077'[39m,
    [32m'organization.invite_accept'[39m,
    [32m'organization'[39m,
    [32m'd25ed85c-8df9-45b7-b937-e5d3bfbd86f1'[39m,
    [32m'{"after":{"email":"audit-user2@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:171:7
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould login with valid backup code
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516044725,"env":"test","module":"email-queue","jobId":"499e092f-43c1-4cd1-b999-72ff3fe19bd7","to":"newuser_1768516038034@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould prevent duplicate pending invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,757a7760-dfc5-47cc-9e48-099a17677b88,{"after":{"invitedEmail":"newuser_1768516038034@test.com","token":"81a20e2ae7db056b6fea21a77abe17ec0148efdca24868e86d5863d4742f691a"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'757a7760-dfc5-47cc-9e48-099a17677b88'[39m,
    [32m'{"after":{"invitedEmail":"newuser_1768516038034@test.com","token":"81a20e2ae7db056b6fea21a77abe17ec0148efdca24868e86d5863d4742f691a"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:119:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516045086,"env":"test","module":"user-credentials-repository","userId":"ZZ-kf0MrhYbo9afz1bNcT","msg":"User credentials created"}
{"level":30,"time":1768516045106,"env":"test","module":"auth-routes","userId":"10cd8fd03b900015dd24a66397fc4cbe","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on each use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516045116,"env":"test","module":"auth-routes","userId":"62199d3f97e08946c8543781824cec4f","msg":"Login requires MFA verification"}
{"level":30,"time":1768516045139,"env":"test","module":"auth-service","tokenHash":"e27c2d2a2c361ecde0dbb6395f0cd0f21dca57f9c4c4f33a529b5bb9e9f0267d","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768516045144,"env":"test","workflowId":"7307124b-062f-496b-9304-178c857e7ec0","userId":"5f53091f-e85d-4d7a-a0bd-95b6c931acc2","sectionsCount":1,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":50,"time":1768516045155,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"10cd8fd03b900015dd24a66397fc4cbe","login_success","security","10cd8fd03b900015dd24a66397fc4cbe","security","10cd8fd03b900015dd24a66397fc4cbe","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:25.106Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:25.106Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"10cd8fd03b900015dd24a66397fc4cbe","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould login with valid backup code
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,10cd8fd03b900015dd24a66397fc4cbe,login_success,security,10cd8fd03b900015dd24a66397fc4cbe,security,10cd8fd03b900015dd24a66397fc4cbe,{"metadata":{"timestamp":"2026-01-15T22:27:25.106Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:25.106Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'10cd8fd03b900015dd24a66397fc4cbe'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'10cd8fd03b900015dd24a66397fc4cbe'[39m,
    [32m'security'[39m,
    [32m'10cd8fd03b900015dd24a66397fc4cbe'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:25.106Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:25.106Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516045155,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"10cd8fd03b900015dd24a66397fc4cbe","login_success","security","10cd8fd03b900015dd24a66397fc4cbe","security","10cd8fd03b900015dd24a66397fc4cbe","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:25.106Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:25.106Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516045160,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mgetOrganizationMembers[2m > [22m[2mshould return all members of organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,e0b54d30-8860-4c78-a378-f048790e465b,{"after":{"name":"Members Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'e0b54d30-8860-4c78-a378-f048790e465b'[39m,
    [32m'{"after":{"name":"Members Test Org Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:160:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould rotate refresh token after use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516045217,"env":"test","module":"mfa-service","userId":"62199d3f97e08946c8543781824cec4f","msg":"TOTP verification successful"}
{"level":30,"time":1768516045285,"env":"test","module":"auth-routes","userId":"62199d3f97e08946c8543781824cec4f","msg":"MFA login successful"}
{"level":30,"time":1768516045291,"env":"test","module":"auth-routes","userId":"ab07070235b68a252bda5d42fb7eb4c4","msg":"User logged in successfully"}
{"level":50,"time":1768516045343,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"ab07070235b68a252bda5d42fb7eb4c4","login_success","security","ab07070235b68a252bda5d42fb7eb4c4","security","ab07070235b68a252bda5d42fb7eb4c4","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:25.291Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:25.291Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"ab07070235b68a252bda5d42fb7eb4c4","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,ab07070235b68a252bda5d42fb7eb4c4,login_success,security,ab07070235b68a252bda5d42fb7eb4c4,security,ab07070235b68a252bda5d42fb7eb4c4,{"metadata":{"timestamp":"2026-01-15T22:27:25.291Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:25.291Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'ab07070235b68a252bda5d42fb7eb4c4'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'ab07070235b68a252bda5d42fb7eb4c4'[39m,
    [32m'security'[39m,
    [32m'ab07070235b68a252bda5d42fb7eb4c4'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:25.291Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:25.291Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516045343,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"ab07070235b68a252bda5d42fb7eb4c4","login_success","security","ab07070235b68a252bda5d42fb7eb4c4","security","ab07070235b68a252bda5d42fb7eb4c4","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:25.291Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:25.291Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516045348,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768516045429,"env":"test","module":"auth-routes","userId":"62199d3f97e08946c8543781824cec4f","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768516045455,"env":"test","module":"email-queue","jobId":"3f6e3ad6-1354-4644-a4f1-616ff50b7a2f","to":"email-test@example.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
{"level":30,"time":1768516045521,"env":"test","module":"auth-routes","userId":"62199d3f97e08946c8543781824cec4f","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768516045531,"env":"test","workflowId":"7307124b-062f-496b-9304-178c857e7ec0","userId":"d4120252-1510-4751-b8c5-0adc6329e83d","sectionsCount":1,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #3: Invite email failure rollback[2m > [22m[2mshould not create invite if email fails
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,9742dfda-92b1-41ce-aa0d-626ab8fef0a7,organization.invite_send,organization,d25ed85c-8df9-45b7-b937-e5d3bfbd86f1,{"after":{"invitedEmail":"email-test@example.com","token":"a1424494f91b119324118b15b683a253c5e303ed7b470017861d3b77138d1a07"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'9742dfda-92b1-41ce-aa0d-626ab8fef0a7'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'd25ed85c-8df9-45b7-b937-e5d3bfbd86f1'[39m,
    [32m'{"after":{"invitedEmail":"email-test@example.com","token":"a1424494f91b119324118b15b683a253c5e303ed7b470017861d3b77138d1a07"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:192:22
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516045570,"env":"test","module":"auth-routes","userId":"4f09ff6b3e262c2b5c8309c188f52bd8","msg":"User logged in successfully"}
{"level":50,"time":1768516045616,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"4f09ff6b3e262c2b5c8309c188f52bd8","login_success","security","4f09ff6b3e262c2b5c8309c188f52bd8","security","4f09ff6b3e262c2b5c8309c188f52bd8","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:25.570Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:25.570Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"4f09ff6b3e262c2b5c8309c188f52bd8","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on each use
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,4f09ff6b3e262c2b5c8309c188f52bd8,login_success,security,4f09ff6b3e262c2b5c8309c188f52bd8,security,4f09ff6b3e262c2b5c8309c188f52bd8,{"metadata":{"timestamp":"2026-01-15T22:27:25.570Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:25.570Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'4f09ff6b3e262c2b5c8309c188f52bd8'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'4f09ff6b3e262c2b5c8309c188f52bd8'[39m,
    [32m'security'[39m,
    [32m'4f09ff6b3e262c2b5c8309c188f52bd8'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:25.570Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:25.570Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516045616,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"4f09ff6b3e262c2b5c8309c188f52bd8","login_success","security","4f09ff6b3e262c2b5c8309c188f52bd8","security","4f09ff6b3e262c2b5c8309c188f52bd8","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:25.570Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:25.570Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768516045623,"env":"test","module":"auth-service","tokenHash":"99354f24172569cefbb50b01dbf523cea548bc15a7a7673597c45fab44f59659","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768516045658,"env":"test","module":"auth-routes","userId":"8fc28c09beef3e2a7f22e601aaea00ba","msg":"User logged in successfully"}
{"level":30,"time":1768516045669,"env":"test","module":"auth-routes","userId":"62199d3f97e08946c8543781824cec4f","deviceId":"1b8b64b7-f1c4-4db0-9a16-a18ffbd79c61","msg":"Trusted device revoked"}
{"level":30,"time":1768516045677,"env":"test","module":"user-credentials-repository","userId":"zTROT8tWuGYkchxGiQcB9","msg":"User credentials created"}
{"level":50,"time":1768516045702,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"8fc28c09beef3e2a7f22e601aaea00ba","login_success","security","8fc28c09beef3e2a7f22e601aaea00ba","security","8fc28c09beef3e2a7f22e601aaea00ba","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:25.658Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:25.658Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"8fc28c09beef3e2a7f22e601aaea00ba","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould rotate refresh token after use
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,8fc28c09beef3e2a7f22e601aaea00ba,login_success,security,8fc28c09beef3e2a7f22e601aaea00ba,security,8fc28c09beef3e2a7f22e601aaea00ba,{"metadata":{"timestamp":"2026-01-15T22:27:25.658Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:25.658Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'8fc28c09beef3e2a7f22e601aaea00ba'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'8fc28c09beef3e2a7f22e601aaea00ba'[39m,
    [32m'security'[39m,
    [32m'8fc28c09beef3e2a7f22e601aaea00ba'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:25.658Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:25.658Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516045702,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"8fc28c09beef3e2a7f22e601aaea00ba","login_success","security","8fc28c09beef3e2a7f22e601aaea00ba","security","8fc28c09beef3e2a7f22e601aaea00ba","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:25.658Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:25.658Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768516045707,"env":"test","module":"auth-service","tokenHash":"9bf4f7827e6b8cc82bcf9463639b6aebbbb7c6367c83cfa56d6950868327b7b1","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768516045726,"env":"test","module":"auth-service","tokenHash":"53a3d9b097c8820867059c20d6ef61b100dfc5215d75901043f63d8d0ad744cc","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768516045816,"env":"test","module":"auth-routes","userId":"62199d3f97e08946c8543781824cec4f","deviceCount":0,"msg":"Listed trusted devices"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould detach workflow from project when transferring to different owner
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,4079ff42-1472-4dd8-9a5c-730b5e4db22f,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'4079ff42-1472-4dd8-9a5c-730b5e4db22f'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516045979,"env":"test","error":{"error":{"code":"INTERNAL_ERROR","message":""}},"msg":"Failed to render template"}
{"level":30,"time":1768516046121,"env":"test","module":"auth-service","tokenHash":"7907a6d3313aaf80893a754f3f4ac8953ff1868d58f6054123a2fccec5526c1b","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould detach workflow from project when transferring to different owner
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:187:30
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

{"level":30,"time":1768516046194,"env":"test","module":"auth-service","tokenHash":"9bf4f7827e6b8cc82bcf9463639b6aebbbb7c6367c83cfa56d6950868327b7b1","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768516046231,"env":"test","module":"user-credentials-repository","userId":"9jnxm3fFuAheKSw-Cst2X","msg":"User credentials created"}
{"level":40,"time":1768516046245,"env":"test","module":"auth-service","userId":"8fc28c09beef3e2a7f22e601aaea00ba","tokenHash":"9bf4f7827e6b8cc82bcf9463639b6aebbbb7c6367c83cfa56d6950868327b7b1","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768516046285,"env":"test","module":"auth-service","tokenHash":"d799b7153efa9b83e3666882d0929c0383d817382bd8efa76442e816a386f6ef","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould prevent inviting existing members
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,31882536-3548-4cd7-800d-a14c67d7dc7f,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'31882536-3548-4cd7-800d-a14c67d7dc7f'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516046305,"env":"test","module":"auth-service","tokenHash":"8d11b9b2a15742063603fd5153c5c7195ea73740b4ac20cdfd4cf5d9c7e46a42","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768516046357,"env":"test","module":"email-queue","jobId":"73384199-9a17-441c-b2de-ac1e894d3920","to":"expired-test@example.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mpromoteMember[2m > [22m[2mshould allow admin to promote member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,e485104f-19fd-4490-ba5c-81e73879a25f,{"after":{"name":"Promote Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'e485104f-19fd-4490-ba5c-81e73879a25f'[39m,
    [32m'{"after":{"name":"Promote Test Org Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:179:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #5: Expired invites[2m > [22m[2mshould allow re-invite after invite expires
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,9742dfda-92b1-41ce-aa0d-626ab8fef0a7,organization.invite_send,organization,d25ed85c-8df9-45b7-b937-e5d3bfbd86f1,{"after":{"invitedEmail":"expired-test@example.com","token":"d335a1ae01a2e000e896fc60da6e423e6c57a67b11abc2ee14b62c760d77c0f8"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'9742dfda-92b1-41ce-aa0d-626ab8fef0a7'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'd25ed85c-8df9-45b7-b937-e5d3bfbd86f1'[39m,
    [32m'{"after":{"invitedEmail":"expired-test@example.com","token":"d335a1ae01a2e000e896fc60da6e423e6c57a67b11abc2ee14b62c760d77c0f8"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:215:23
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking current session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould mark backup code as used
[22m[39m[TEST UTILS] MFA Secret verified for 4e9514f4c85a573750f3c80fc0411caa

[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mComplete Organization Workflow[2m > [22m[2mStep 14: Remove member from org
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,d4120252-1510-4751-b8c5-0adc6329e83d,organization.member_remove,organization,f1847d55-e2c3-48d1-b3e4-d26186d06bfa,{"after":{"removedUserId":"5f53091f-e85d-4d7a-a0bd-95b6c931acc2"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'd4120252-1510-4751-b8c5-0adc6329e83d'[39m,
    [32m'organization.member_remove'[39m,
    [32m'organization'[39m,
    [32m'f1847d55-e2c3-48d1-b3e4-d26186d06bfa'[39m,
    [32m'{"after":{"removedUserId":"5f53091f-e85d-4d7a-a0bd-95b6c931acc2"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.removeMember (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:343:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:285:7
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for 7d440e1b64f086c24472dc17ac11505c

{"level":30,"time":1768516046835,"env":"test","module":"user-credentials-repository","userId":"yWsgvtwtAof-j21M87bDV","msg":"User credentials created"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mpromoteMember[2m > [22m[2mshould allow admin to promote member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.member_promote,organization,e485104f-19fd-4490-ba5c-81e73879a25f,{"after":{"userId":"00000000-0000-0000-0000-000000000012","newRole":"admin"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.member_promote'[39m,
    [32m'organization'[39m,
    [32m'e485104f-19fd-4490-ba5c-81e73879a25f'[39m,
    [32m'{"after":{"userId":"00000000-0000-0000-0000-000000000012","newRole":"admin"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.promoteMember (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:248:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:186:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516046890,"env":"test","module":"auth-service","tokenHash":"78328c5326fd3ca1f1252cafb9c21cf2c8c1ab9fa3c207144b893a9bc57e5dcb","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768516047045,"env":"test","module":"auth-routes","userId":"e36bb0230b15a7d871727789124d2500","msg":"User logged in successfully"}
{"level":50,"time":1768516047093,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"e36bb0230b15a7d871727789124d2500","login_success","security","e36bb0230b15a7d871727789124d2500","security","e36bb0230b15a7d871727789124d2500","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:27.045Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:27.046Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"e36bb0230b15a7d871727789124d2500","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking current session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,e36bb0230b15a7d871727789124d2500,login_success,security,e36bb0230b15a7d871727789124d2500,security,e36bb0230b15a7d871727789124d2500,{"metadata":{"timestamp":"2026-01-15T22:27:27.045Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:27.046Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'e36bb0230b15a7d871727789124d2500'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'e36bb0230b15a7d871727789124d2500'[39m,
    [32m'security'[39m,
    [32m'e36bb0230b15a7d871727789124d2500'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:27.045Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:27.046Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516047093,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"e36bb0230b15a7d871727789124d2500","login_success","security","e36bb0230b15a7d871727789124d2500","security","e36bb0230b15a7d871727789124d2500","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:27.045Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:27.046Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516047099,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516047297,"env":"test","module":"email-queue","jobId":"68806344-8bcf-4b54-96af-f77577279b0c","to":"expired-test@example.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
{"level":30,"time":1768516047314,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516047315,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould keep workflow in project when transferring to same owner
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,cf0857e0-8ebf-47a5-a6ed-92b7c99f4e9d,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'cf0857e0-8ebf-47a5-a6ed-92b7c99f4e9d'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #5: Expired invites[2m > [22m[2mshould allow re-invite after invite expires
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,9742dfda-92b1-41ce-aa0d-626ab8fef0a7,organization.invite_send,organization,d25ed85c-8df9-45b7-b937-e5d3bfbd86f1,{"after":{"invitedEmail":"expired-test@example.com","token":"e105dacb1787fe3fcef225c5b786bae2d5eb0ad8f5248d0af3074c64afab69c8"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'9742dfda-92b1-41ce-aa0d-626ab8fef0a7'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'd25ed85c-8df9-45b7-b937-e5d3bfbd86f1'[39m,
    [32m'{"after":{"invitedEmail":"expired-test@example.com","token":"e105dacb1787fe3fcef225c5b786bae2d5eb0ad8f5248d0af3074c64afab69c8"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:224:23
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

 [31m‚ùØ[39m tests/integration/auth/oauth2.token-refresh.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 22342[2mms[22m[39m
       [33m[2m‚úì[22m[39m should refresh access token with valid refresh token [33m 680[2mms[22m[39m
       [33m[2m‚úì[22m[39m should rotate refresh token after use [33m 681[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 when refresh token is missing [33m 377[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for invalid refresh token [33m 869[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for expired refresh token [33m 820[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for revoked refresh token [33m 578[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 when user is not found [33m 926[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update refresh token metadata on rotation [33m 725[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle concurrent refresh token requests (token reuse detection) [33m 825[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set secure cookie in production [33m 606[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set proper cookie attributes [33m 691[2mms[22m[39m
       [33m[2m‚úì[22m[39m should include user role information in response [33m 624[2mms[22m[39m
[31m       [31m√ó[31m should create refresh token on login[39m[33m 1046[2mms[22m[39m
       [33m[2m‚úì[22m[39m should revoke refresh token on logout [33m 532[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle logout without refresh token gracefully [33m 417[2mms[22m[39m
       [33m[2m‚úì[22m[39m should support multiple active refresh tokens per user [33m 587[2mms[22m[39m
       [33m[2m‚úì[22m[39m should revoke all user tokens on password reset [33m 647[2mms[22m[39m
       [33m[2m‚úì[22m[39m should use cryptographically strong random tokens [33m 5377[2mms[22m[39m
       [33m[2m‚úì[22m[39m should hash refresh tokens before storing in database [33m 468[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent refresh token reuse after rotation [33m 654[2mms[22m[39m
       [33m[2m‚úì[22m[39m should validate token ownership [33m 470[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set HttpOnly flag to prevent XSS [33m 580[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set SameSite=Strict to prevent CSRF [33m 575[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set proper cookie path [33m 560[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set appropriate expiry (30 days) [33m 615[2mms[22m[39m
{"level":30,"time":1768516047452,"env":"test","module":"email-queue","jobId":"ecd8c53e-dd8e-43a8-9f44-92a355d6e25e","to":"test-1768516046879-m1u6s6@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768516047452,"env":"test","module":"auth-service","email":"test-1768516046879-m1u6s6@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect and prevent refresh token reuse (token theft)
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould require admin access to create invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,cf5df2f9-fe7c-42c5-adf5-6b270d21481d,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'cf5df2f9-fe7c-42c5-adf5-6b270d21481d'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516047567,"env":"test","module":"auth-routes","userId":"7d440e1b64f086c24472dc17ac11505c","msg":"Login requires MFA verification"}
{"level":30,"time":1768516047616,"env":"test","workflowId":"7307124b-062f-496b-9304-178c857e7ec0","userId":"5f53091f-e85d-4d7a-a0bd-95b6c931acc2","sectionsCount":1,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768516047670,"env":"test","module":"mfa-service","userId":"7d440e1b64f086c24472dc17ac11505c","msg":"TOTP verification successful"}
{"level":30,"time":1768516047719,"env":"test","module":"auth-routes","userId":"7d440e1b64f086c24472dc17ac11505c","msg":"MFA login successful"}
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould keep workflow in project when transferring to same owner
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:215:30
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

{"level":30,"time":1768516047926,"env":"test","module":"auth-routes","userId":"71396ca2cbeb133c53c7de24a64c07ee","msg":"User logged in successfully"}
{"level":50,"time":1768516047977,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"71396ca2cbeb133c53c7de24a64c07ee","login_success","security","71396ca2cbeb133c53c7de24a64c07ee","security","71396ca2cbeb133c53c7de24a64c07ee","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:27.927Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:27.927Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"71396ca2cbeb133c53c7de24a64c07ee","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect and prevent refresh token reuse (token theft)
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,71396ca2cbeb133c53c7de24a64c07ee,login_success,security,71396ca2cbeb133c53c7de24a64c07ee,security,71396ca2cbeb133c53c7de24a64c07ee,{"metadata":{"timestamp":"2026-01-15T22:27:27.927Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:27.927Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'71396ca2cbeb133c53c7de24a64c07ee'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'71396ca2cbeb133c53c7de24a64c07ee'[39m,
    [32m'security'[39m,
    [32m'71396ca2cbeb133c53c7de24a64c07ee'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:27.927Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:27.927Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516047978,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"71396ca2cbeb133c53c7de24a64c07ee","login_success","security","71396ca2cbeb133c53c7de24a64c07ee","security","71396ca2cbeb133c53c7de24a64c07ee","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:27.927Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:27.927Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768516047983,"env":"test","module":"auth-service","tokenHash":"8f1c854064df071c58156f5f2e3b03f6ed28b7a64ee6674af3d494c5314e0537","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould prevent backup code reuse
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516048100,"env":"test","module":"email-queue","jobId":"cc3d483d-9b45-4c06-8bcd-f6a9bc0b6440","to":"duplicate@test.com","subject":"You've been invited to join Test Organization","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mdemoteMember[2m > [22m[2mshould allow admin to demote other admin
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,6f01d69c-4cf3-46f6-8cc6-107c2d682103,{"after":{"name":"Demote Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'6f01d69c-4cf3-46f6-8cc6-107c2d682103'[39m,
    [32m'{"after":{"name":"Demote Test Org Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:197:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mEdge Cases and Security[2m > [22m[2mCannot invite same email twice (pending invite exists)
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,d4120252-1510-4751-b8c5-0adc6329e83d,organization.invite_send,organization,f1847d55-e2c3-48d1-b3e4-d26186d06bfa,{"after":{"invitedEmail":"duplicate@test.com","token":"4473a0de8c622267bdbdebe898d7fcabe808e9e3250503fa74ab57b42a28755e"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'd4120252-1510-4751-b8c5-0adc6329e83d'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'f1847d55-e2c3-48d1-b3e4-d26186d06bfa'[39m,
    [32m'{"after":{"invitedEmail":"duplicate@test.com","token":"4473a0de8c622267bdbdebe898d7fcabe808e9e3250503fa74ab57b42a28755e"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:323:23
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #7: Delete organization[2m > [22m[2mshould allow last admin to delete empty organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,9742dfda-92b1-41ce-aa0d-626ab8fef0a7,organization.create,organization,9a1202f7-eb36-4a3d-863c-33eb7e533bb8,{"after":{"name":"Delete Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'9742dfda-92b1-41ce-aa0d-626ab8fef0a7'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'9a1202f7-eb36-4a3d-863c-33eb7e533bb8'[39m,
    [32m'{"after":{"name":"Delete Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:244:19
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould return 404 for non-existent session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516048459,"env":"test","module":"auth-routes","userId":"7be0ce236cb0061dee6657e53b15e650","msg":"User logged in successfully"}
{"level":30,"time":1768516048471,"env":"test","module":"auth-service","tokenHash":"8f1c854064df071c58156f5f2e3b03f6ed28b7a64ee6674af3d494c5314e0537","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768516048507,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"7be0ce236cb0061dee6657e53b15e650","login_success","security","7be0ce236cb0061dee6657e53b15e650","security","7be0ce236cb0061dee6657e53b15e650","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:28.459Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:28.459Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"7be0ce236cb0061dee6657e53b15e650","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould prevent backup code reuse
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,7be0ce236cb0061dee6657e53b15e650,login_success,security,7be0ce236cb0061dee6657e53b15e650,security,7be0ce236cb0061dee6657e53b15e650,{"metadata":{"timestamp":"2026-01-15T22:27:28.459Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:28.459Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'7be0ce236cb0061dee6657e53b15e650'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'7be0ce236cb0061dee6657e53b15e650'[39m,
    [32m'security'[39m,
    [32m'7be0ce236cb0061dee6657e53b15e650'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:28.459Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:28.459Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516048507,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"7be0ce236cb0061dee6657e53b15e650","login_success","security","7be0ce236cb0061dee6657e53b15e650","security","7be0ce236cb0061dee6657e53b15e650","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:28.459Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:28.459Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516048513,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768516048519,"env":"test","module":"auth-service","userId":"71396ca2cbeb133c53c7de24a64c07ee","tokenHash":"8f1c854064df071c58156f5f2e3b03f6ed28b7a64ee6674af3d494c5314e0537","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould set expiry to 7 days from now
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,574386f0-1bf6-4de6-9568-56aeaf49c441,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'574386f0-1bf6-4de6-9568-56aeaf49c441'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mdemoteMember[2m > [22m[2mshould allow admin to demote other admin
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.member_demote,organization,6f01d69c-4cf3-46f6-8cc6-107c2d682103,{"after":{"userId":"00000000-0000-0000-0000-000000000012","newRole":"member"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.member_demote'[39m,
    [32m'organization'[39m,
    [32m'6f01d69c-4cf3-46f6-8cc6-107c2d682103'[39m,
    [32m'{"after":{"userId":"00000000-0000-0000-0000-000000000012","newRole":"member"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.demoteMember (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:296:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:204:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516048628,"env":"test","module":"email-queue","jobId":"ad84f0a0-5cc5-400c-be66-ffeb054a5f63","to":"test-1768516048059-7ofpxj@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768516048629,"env":"test","module":"auth-service","email":"test-1768516048059-7ofpxj@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 5def5864f791d1bc065835b272ea5deb

{"level":30,"time":1768516048879,"env":"test","module":"auth-routes","userId":"d0ad13b9b0023618aa41f40ef4da8dd5","msg":"User logged in successfully"}
{"level":30,"time":1768516048918,"env":"test","module":"email-queue","jobId":"9a82c20b-8ffa-4f72-9dca-ccc276d409fa","to":"expired@test.com","subject":"You've been invited to join Test Organization","msg":"Email added to queue"}
{"level":50,"time":1768516048927,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"d0ad13b9b0023618aa41f40ef4da8dd5","login_success","security","d0ad13b9b0023618aa41f40ef4da8dd5","security","d0ad13b9b0023618aa41f40ef4da8dd5","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:28.879Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:28.879Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"d0ad13b9b0023618aa41f40ef4da8dd5","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould return 404 for non-existent session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,d0ad13b9b0023618aa41f40ef4da8dd5,login_success,security,d0ad13b9b0023618aa41f40ef4da8dd5,security,d0ad13b9b0023618aa41f40ef4da8dd5,{"metadata":{"timestamp":"2026-01-15T22:27:28.879Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:28.879Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'd0ad13b9b0023618aa41f40ef4da8dd5'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'd0ad13b9b0023618aa41f40ef4da8dd5'[39m,
    [32m'security'[39m,
    [32m'd0ad13b9b0023618aa41f40ef4da8dd5'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:28.879Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:28.879Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516048927,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"d0ad13b9b0023618aa41f40ef4da8dd5","login_success","security","d0ad13b9b0023618aa41f40ef4da8dd5","security","d0ad13b9b0023618aa41f40ef4da8dd5","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:28.879Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:28.879Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516048933,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould prevent non-member from transferring org workflow
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,53312beb-2ab2-4d14-bba5-22d635bed14a,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'53312beb-2ab2-4d14-bba5-22d635bed14a'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516049007,"env":"test","module":"user-credentials-repository","userId":"2f597d97854654eb3819ed9f420565f5","msg":"User password updated"}
[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mEdge Cases and Security[2m > [22m[2mCannot accept expired invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,d4120252-1510-4751-b8c5-0adc6329e83d,organization.invite_send,organization,f1847d55-e2c3-48d1-b3e4-d26186d06bfa,{"after":{"invitedEmail":"expired@test.com","token":"c39764ebd37cef38188043ceff25eb49b4bac86902b9a8d5c89d82eb851479df"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'd4120252-1510-4751-b8c5-0adc6329e83d'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'f1847d55-e2c3-48d1-b3e4-d26186d06bfa'[39m,
    [32m'{"after":{"invitedEmail":"expired@test.com","token":"c39764ebd37cef38188043ceff25eb49b4bac86902b9a8d5c89d82eb851479df"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:348:22
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516049085,"env":"test","module":"email-queue","jobId":"2c6c891b-d95d-4a48-97ce-62f97fc2022f","to":"newuser_1768516038034@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w47
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w47,public

{"level":50,"time":1768516049144,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"2f597d97854654eb3819ed9f420565f5","password_reset","security","2f597d97854654eb3819ed9f420565f5","security","2f597d97854654eb3819ed9f420565f5","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:29.094Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:29.094Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"2f597d97854654eb3819ed9f420565f5","eventType":"password_reset","msg":"Failed to log security event"}
{"level":50,"time":1768516049144,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"2f597d97854654eb3819ed9f420565f5","password_reset","security","2f597d97854654eb3819ed9f420565f5","security","2f597d97854654eb3819ed9f420565f5","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:29.094Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:29.094Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Reset password error"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould set expiry to 7 days from now
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,574386f0-1bf6-4de6-9568-56aeaf49c441,{"after":{"invitedEmail":"newuser_1768516038034@test.com","token":"fb4cc6d3bf399522d224fdb90d967f9dc38a3e6cb5cb703c29b4501079b3abe8"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'574386f0-1bf6-4de6-9568-56aeaf49c441'[39m,
    [32m'{"after":{"invitedEmail":"newuser_1768516038034@test.com","token":"fb4cc6d3bf399522d224fdb90d967f9dc38a3e6cb5cb703c29b4501079b3abe8"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:143:28
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w47 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w47%2Cpublic

[90mstderr[2m | tests/unit/services/AuthService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17[90m)[39m
    at Object.get [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:144:34
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m {
  codeFrame: [32m'vi.mock(import("../../../server/db"), async (importOriginal) => {\n'[39m +
    [32m'  const actual = await importOriginal()\n'[39m +
    [32m'  return {\n'[39m +
    [32m'    ...actual,\n'[39m +
    [32m'    // your mocked methods\n'[39m +
    [32m'  }\n'[39m +
    [32m'})'[39m
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould prevent non-member from transferring org workflow
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:236:30
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #7: Delete organization[2m > [22m[2mshould prevent deletion if org owns assets
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,9742dfda-92b1-41ce-aa0d-626ab8fef0a7,organization.create,organization,ab7e3810-cbd0-4ac7-8b2a-bea7e4c35672,{"after":{"name":"Has Assets Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'9742dfda-92b1-41ce-aa0d-626ab8fef0a7'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'ab7e3810-cbd0-4ac7-8b2a-bea7e4c35672'[39m,
    [32m'{"after":{"name":"Has Assets Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:262:19
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #7: Delete organization[2m > [22m[2mshould prevent deletion if org owns assets
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:267:24
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 87605dffece294cd8f911c9b58d210ee

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mEdge Cases and Security[2m > [22m[2mCannot transfer workflow to org user is not a member of
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,c032548f-6366-41db-9473-82be2bfa30e5,organization.create,organization,e8faa04f-7daf-4126-9056-e044bdbb080b,{"after":{"name":"Other Organization","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'c032548f-6366-41db-9473-82be2bfa30e5'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'e8faa04f-7daf-4126-9056-e044bdbb080b'[39m,
    [32m'{"after":{"name":"Other Organization","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:373:20
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mdemoteMember[2m > [22m[2mshould prevent self-demotion
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,bc048f21-af46-421e-9317-266ad17718f8,{"after":{"name":"Self Demote Test Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'bc048f21-af46-421e-9317-266ad17718f8'[39m,
    [32m'{"after":{"name":"Self Demote Test Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:213:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould try TOTP before backup code
[22m[39m[TEST UTILS] MFA Secret verified for 19b15c5f83cba753e731af34eb1d47e6

{"level":30,"time":1768516050101,"env":"test","module":"auth-routes","userId":"015cb1c85aa475cb66c2afd9f3e104bc","msg":"User logged in successfully"}
{"level":50,"time":1768516050148,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"015cb1c85aa475cb66c2afd9f3e104bc","login_success","security","015cb1c85aa475cb66c2afd9f3e104bc","security","015cb1c85aa475cb66c2afd9f3e104bc","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:30.101Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:27:30.101Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"015cb1c85aa475cb66c2afd9f3e104bc","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,015cb1c85aa475cb66c2afd9f3e104bc,login_success,security,015cb1c85aa475cb66c2afd9f3e104bc,security,015cb1c85aa475cb66c2afd9f3e104bc,{"metadata":{"timestamp":"2026-01-15T22:27:30.101Z"}},::ffff:127.0.0.1,Mozilla/5.0 (Windows NT 10.0; Win64; x64),2026-01-15T22:27:30.101Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'015cb1c85aa475cb66c2afd9f3e104bc'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'015cb1c85aa475cb66c2afd9f3e104bc'[39m,
    [32m'security'[39m,
    [32m'015cb1c85aa475cb66c2afd9f3e104bc'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:30.101Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [32m'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'[39m,
    [32m'2026-01-15T22:27:30.101Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516050148,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"015cb1c85aa475cb66c2afd9f3e104bc","login_success","security","015cb1c85aa475cb66c2afd9f3e104bc","security","015cb1c85aa475cb66c2afd9f3e104bc","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:30.101Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:27:30.101Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould try TOTP before backup code
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516050260,"env":"test","module":"auth-routes","userId":"5def5864f791d1bc065835b272ea5deb","msg":"Login requires MFA verification"}
{"level":30,"time":1768516050356,"env":"test","module":"mfa-service","userId":"5def5864f791d1bc065835b272ea5deb","msg":"TOTP verification successful"}
{"level":30,"time":1768516050376,"env":"test","module":"email-queue","jobId":"27edbe58-209c-4336-b103-f2ed76514e8b","to":"placeholder-test@example.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
{"level":30,"time":1768516050404,"env":"test","module":"auth-routes","userId":"5def5864f791d1bc065835b272ea5deb","msg":"MFA login successful"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould accept invite and create membership
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,b2c073e3-7935-414a-be66-2c5de2d6b9cb,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'b2c073e3-7935-414a-be66-2c5de2d6b9cb'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #8: Placeholder user cleanup[2m > [22m[2mshould cleanup placeholder user when invite is revoked
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,9742dfda-92b1-41ce-aa0d-626ab8fef0a7,organization.invite_send,organization,d25ed85c-8df9-45b7-b937-e5d3bfbd86f1,{"after":{"invitedEmail":"placeholder-test@example.com","token":"a94923ca663f2a540b4a4faba89e42f2dc446e64c9262ff3dadeabd9e53d9ae1"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'9742dfda-92b1-41ce-aa0d-626ab8fef0a7'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'd25ed85c-8df9-45b7-b937-e5d3bfbd86f1'[39m,
    [32m'{"after":{"invitedEmail":"placeholder-test@example.com","token":"a94923ca663f2a540b4a4faba89e42f2dc446e64c9262ff3dadeabd9e53d9ae1"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:295:22
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould transfer database ownership
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,8fcd04a6-618b-497c-bc2c-7f7b65001a4b,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'8fcd04a6-618b-497c-bc2c-7f7b65001a4b'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516050546,"env":"test","module":"auth-routes","userId":"5def5864f791d1bc065835b272ea5deb","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking other user's session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516050594,"env":"test","module":"email-queue","jobId":"ecd0f8b6-85a6-41b6-a9b9-77588a14f169","to":"test-1768516050044-15m46@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768516050594,"env":"test","module":"auth-service","email":"test-1768516050044-15m46@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768516050645,"env":"test","module":"auth-routes","userId":"5def5864f791d1bc065835b272ea5deb","deviceCount":1,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516050667,"env":"test","module":"auth-routes","userId":"19b15c5f83cba753e731af34eb1d47e6","msg":"Login requires MFA verification"}
{"level":30,"time":1768516050671,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516050671,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/organizations-workflow.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 10131[2mms[22m[39m
       [33m[2m‚úì[22m[39m Step 1: Create organization [33m 647[2mms[22m[39m
       [33m[2m‚úì[22m[39m Step 2: Invite member via email [33m 856[2mms[22m[39m
       [33m[2m‚úì[22m[39m Step 3: Accept invite [33m 902[2mms[22m[39m
       [33m[2m‚úì[22m[39m Step 6: Org member (user2) can access workflow [33m 520[2mms[22m[39m
       [33m[2m‚úì[22m[39m Step 16: Re-add member and verify access restored [33m 661[2mms[22m[39m
       [33m[2m‚úì[22m[39m Cannot invite same email twice (pending invite exists) [33m 822[2mms[22m[39m
       [33m[2m‚úì[22m[39m Cannot accept expired invite [33m 716[2mms[22m[39m
       [33m[2m‚úì[22m[39m Cannot transfer workflow to org user is not a member of [33m 870[2mms[22m[39m
{"level":30,"time":1768516050774,"env":"test","module":"mfa-service","userId":"19b15c5f83cba753e731af34eb1d47e6","msg":"TOTP verification successful"}
{"level":30,"time":1768516050847,"env":"test","module":"auth-routes","userId":"19b15c5f83cba753e731af34eb1d47e6","msg":"MFA login successful"}
{"level":30,"time":1768516050938,"env":"test","module":"auth-routes","userId":"015cb1c85aa475cb66c2afd9f3e104bc","msg":"User logged in successfully"}
{"level":30,"time":1768516050939,"env":"test","module":"email-queue","jobId":"41fd85e9-2a2e-49e4-b7e8-8bed60cfc4a6","to":"existing_1768516038034@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":50,"time":1768516050982,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"015cb1c85aa475cb66c2afd9f3e104bc","login_success","security","015cb1c85aa475cb66c2afd9f3e104bc","security","015cb1c85aa475cb66c2afd9f3e104bc","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:30.938Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)","2026-01-15T22:27:30.938Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"015cb1c85aa475cb66c2afd9f3e104bc","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,015cb1c85aa475cb66c2afd9f3e104bc,login_success,security,015cb1c85aa475cb66c2afd9f3e104bc,security,015cb1c85aa475cb66c2afd9f3e104bc,{"metadata":{"timestamp":"2026-01-15T22:27:30.938Z"}},::ffff:127.0.0.1,Mozilla/5.0 (iPhone; CPU iPhone OS 14_0),2026-01-15T22:27:30.938Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'015cb1c85aa475cb66c2afd9f3e104bc'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'015cb1c85aa475cb66c2afd9f3e104bc'[39m,
    [32m'security'[39m,
    [32m'015cb1c85aa475cb66c2afd9f3e104bc'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:30.938Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [32m'Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)'[39m,
    [32m'2026-01-15T22:27:30.938Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

{"level":50,"time":1768516050982,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"015cb1c85aa475cb66c2afd9f3e104bc","login_success","security","015cb1c85aa475cb66c2afd9f3e104bc","security","015cb1c85aa475cb66c2afd9f3e104bc","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:30.938Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)","2026-01-15T22:27:30.938Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516050989,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768516050996,"env":"test","module":"auth-routes","userId":"c646127ae0358c7c73de620b368abb4f","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould accept invite and create membership
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,b2c073e3-7935-414a-be66-2c5de2d6b9cb,{"after":{"invitedEmail":"existing_1768516038034@test.com","token":"b44ebfeaac055a11010406add402a4ff003231a79e20fb89daeb63eb6aa52f9c"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'b2c073e3-7935-414a-be66-2c5de2d6b9cb'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768516038034@test.com","token":"b44ebfeaac055a11010406add402a4ff003231a79e20fb89daeb63eb6aa52f9c"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:165:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516051044,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"c646127ae0358c7c73de620b368abb4f","login_success","security","c646127ae0358c7c73de620b368abb4f","security","c646127ae0358c7c73de620b368abb4f","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:30.996Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:30.996Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"c646127ae0358c7c73de620b368abb4f","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking other user's session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,c646127ae0358c7c73de620b368abb4f,login_success,security,c646127ae0358c7c73de620b368abb4f,security,c646127ae0358c7c73de620b368abb4f,{"metadata":{"timestamp":"2026-01-15T22:27:30.996Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:30.996Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'c646127ae0358c7c73de620b368abb4f'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'c646127ae0358c7c73de620b368abb4f'[39m,
    [32m'security'[39m,
    [32m'c646127ae0358c7c73de620b368abb4f'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:30.996Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:30.996Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516051044,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"c646127ae0358c7c73de620b368abb4f","login_success","security","c646127ae0358c7c73de620b368abb4f","security","c646127ae0358c7c73de620b368abb4f","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:30.996Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:30.996Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking other user's session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #8: Placeholder user cleanup[2m > [22m[2mshould cleanup placeholder user when invite is revoked
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: 9db04bee-70ec-4c54-a65d-b1647855d533,9742dfda-92b1-41ce-aa0d-626ab8fef0a7,organization.invite_revoke,organization,d25ed85c-8df9-45b7-b937-e5d3bfbd86f1,{"after":{"inviteId":"ad6fff01-8bf9-4728-a6c0-d0acd49cb12f","email":"placeholder-test@example.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [32m'9db04bee-70ec-4c54-a65d-b1647855d533'[39m,
    [32m'9742dfda-92b1-41ce-aa0d-626ab8fef0a7'[39m,
    [32m'organization.invite_revoke'[39m,
    [32m'organization'[39m,
    [32m'd25ed85c-8df9-45b7-b937-e5d3bfbd86f1'[39m,
    [32m'{"after":{"inviteId":"ad6fff01-8bf9-4728-a6c0-d0acd49cb12f","email":"placeholder-test@example.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.revokeInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:840:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:305:7
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516051127,"env":"test","module":"auth-routes","userId":"87605dffece294cd8f911c9b58d210ee","msg":"Login requires MFA verification"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mremoveMember[2m > [22m[2mshould allow admin to remove member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,21e770ba-06a1-4d04-8049-c12fd4f74520,{"after":{"name":"Remove Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'21e770ba-06a1-4d04-8049-c12fd4f74520'[39m,
    [32m'{"after":{"name":"Remove Test Org Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:227:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516051221,"env":"test","module":"mfa-service","userId":"87605dffece294cd8f911c9b58d210ee","msg":"TOTP verification successful"}
{"level":30,"time":1768516051266,"env":"test","module":"auth-routes","userId":"87605dffece294cd8f911c9b58d210ee","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mremoveMember[2m > [22m[2mshould allow admin to remove member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.member_remove,organization,21e770ba-06a1-4d04-8049-c12fd4f74520,{"after":{"removedUserId":"00000000-0000-0000-0000-000000000012"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.member_remove'[39m,
    [32m'organization'[39m,
    [32m'21e770ba-06a1-4d04-8049-c12fd4f74520'[39m,
    [32m'{"after":{"removedUserId":"00000000-0000-0000-0000-000000000012"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.removeMember (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:343:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:234:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #8: Placeholder user cleanup[2m > [22m[2mshould cleanup placeholder user when invite is revoked
[22m[39mCleaned up placeholder user 617bd08c-8b49-4eb8-96e3-8b67dbf09509 (no pending invites or memberships)

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mGET /api/auth/me[2m > [22m[2mshould return current user for valid token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould accept invite and create membership
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000022,organization.invite_accept,organization,b2c073e3-7935-414a-be66-2c5de2d6b9cb,{"after":{"email":"existing_1768516038034@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000022'[39m,
    [32m'organization.invite_accept'[39m,
    [32m'organization'[39m,
    [32m'b2c073e3-7935-414a-be66-2c5de2d6b9cb'[39m,
    [32m'{"after":{"email":"existing_1768516038034@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:171:28
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return MFA status for user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516051787,"env":"test","module":"auth-routes","userId":"c34e1a4b1de987e18c277c072c8bb93b","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould allow org member to transfer org database
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,9944b52e-b468-4b0f-9bac-c21609e243b7,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'9944b52e-b468-4b0f-9bac-c21609e243b7'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516051839,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"c34e1a4b1de987e18c277c072c8bb93b","login_success","security","c34e1a4b1de987e18c277c072c8bb93b","security","c34e1a4b1de987e18c277c072c8bb93b","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:31.787Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:31.787Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"c34e1a4b1de987e18c277c072c8bb93b","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking other user's session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,c34e1a4b1de987e18c277c072c8bb93b,login_success,security,c34e1a4b1de987e18c277c072c8bb93b,security,c34e1a4b1de987e18c277c072c8bb93b,{"metadata":{"timestamp":"2026-01-15T22:27:31.787Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:31.787Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'c34e1a4b1de987e18c277c072c8bb93b'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'c34e1a4b1de987e18c277c072c8bb93b'[39m,
    [32m'security'[39m,
    [32m'c34e1a4b1de987e18c277c072c8bb93b'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:31.787Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:31.787Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516051839,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"c34e1a4b1de987e18c277c072c8bb93b","login_success","security","c34e1a4b1de987e18c277c072c8bb93b","security","c34e1a4b1de987e18c277c072c8bb93b","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:31.787Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:31.787Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516051844,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768516051859,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516051860,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/PdfQueueService.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 11869[2mms[22m[39m
       [33m[2m‚úì[22m[39m should enqueue a PDF conversion job [33m 665[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create output with empty storagePath initially [33m 640[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return job status for pending job [33m 635[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return null for non-existent job [33m 592[2mms[22m[39m
       [33m[2m‚úì[22m[39m should parse attempt count from error field [33m 626[2mms[22m[39m
       [33m[2m‚úì[22m[39m should convert DOCX to PDF immediately [33m 678[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle conversion errors gracefully [33m 651[2mms[22m[39m
       [33m[2m‚úì[22m[39m should start and stop service [33m 883[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not start if already running [33m 539[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle stop when not running [33m 552[2mms[22m[39m
       [33m[2m‚úì[22m[39m should process pending jobs when queue is processed [33m 938[2mms[22m[39m
       [33m[2m‚úì[22m[39m should process multiple jobs in batch [33m 1184[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle missing DOCX output gracefully [33m 744[2mms[22m[39m
       [33m[2m‚úì[22m[39m should support enqueue within transaction [33m 737[2mms[22m[39m
       [33m[2m‚úì[22m[39m should support convertImmediate within transaction [33m 658[2mms[22m[39m
 [32m‚úì[39m tests/unit/engine/templateNode.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 11312[2mms[22m[39m
       [33m[2m‚úì[22m[39m should resolve template by key from workflowTemplates mapping [33m 822[2mms[22m[39m
       [33m[2m‚úì[22m[39m should throw error if template key not found [33m 560[2mms[22m[39m
       [33m[2m‚úì[22m[39m should store output in runOutputs table [33m 720[2mms[22m[39m
       [33m[2m‚úì[22m[39m should resolve template by templateId directly [33m 563[2mms[22m[39m
       [33m[2m‚úì[22m[39m should throw error if templateId not found [33m 558[2mms[22m[39m
       [33m[2m‚úì[22m[39m should use docxRenderer2 by default (v2 engine) [33m 619[2mms[22m[39m
       [33m[2m‚úì[22m[39m should use legacy engine when engine="legacy" [33m 534[2mms[22m[39m
       [33m[2m‚úì[22m[39m should generate PDF when toPdf=true [33m 704[2mms[22m[39m
       [33m[2m‚úì[22m[39m should default to DOCX when toPdf=false [33m 720[2mms[22m[39m
       [33m[2m‚úì[22m[39m should skip execution when condition evaluates to false [33m 497[2mms[22m[39m
       [33m[2m‚úì[22m[39m should execute when condition evaluates to true [33m 535[2mms[22m[39m
       [33m[2m‚úì[22m[39m should resolve simple bindings [33m 543[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle binding resolution errors gracefully [33m 494[2mms[22m[39m
       [33m[2m‚úì[22m[39m should record failed output in runOutputs table [33m 658[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not throw errors (should return error in result) [33m 547[2mms[22m[39m
       [33m[2m‚úì[22m[39m should deny access to templates from different tenant [33m 594[2mms[22m[39m
       [33m[2m‚úì[22m[39m should require either templateKey or templateId [33m 486[2mms[22m[39m
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #9: Transfer validation order[2m > [22m[2mshould fail fast on non-existent org
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:324:24
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

{"level":30,"time":1768516052129,"env":"test","module":"auth-routes","userId":"51dd3f10d094bec4219c65437d837a34","msg":"User logged in successfully"}
{"level":50,"time":1768516052172,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"51dd3f10d094bec4219c65437d837a34","login_success","security","51dd3f10d094bec4219c65437d837a34","security","51dd3f10d094bec4219c65437d837a34","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:32.129Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:32.129Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"51dd3f10d094bec4219c65437d837a34","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mGET /api/auth/me[2m > [22m[2mshould return current user for valid token
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,51dd3f10d094bec4219c65437d837a34,login_success,security,51dd3f10d094bec4219c65437d837a34,security,51dd3f10d094bec4219c65437d837a34,{"metadata":{"timestamp":"2026-01-15T22:27:32.129Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:32.129Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'51dd3f10d094bec4219c65437d837a34'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'51dd3f10d094bec4219c65437d837a34'[39m,
    [32m'security'[39m,
    [32m'51dd3f10d094bec4219c65437d837a34'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:32.129Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:32.129Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516052173,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"51dd3f10d094bec4219c65437d837a34","login_success","security","51dd3f10d094bec4219c65437d837a34","security","51dd3f10d094bec4219c65437d837a34","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:32.129Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:32.129Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516052179,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768516052242,"env":"test","module":"auth-routes","userId":"cde5485e81c136b75e347da8e42d00f7","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768516052289,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"cde5485e81c136b75e347da8e42d00f7","login_success","security","cde5485e81c136b75e347da8e42d00f7","security","cde5485e81c136b75e347da8e42d00f7","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:32.242Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:32.242Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"cde5485e81c136b75e347da8e42d00f7","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return MFA status for user
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,cde5485e81c136b75e347da8e42d00f7,login_success,security,cde5485e81c136b75e347da8e42d00f7,security,cde5485e81c136b75e347da8e42d00f7,{"metadata":{"timestamp":"2026-01-15T22:27:32.242Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:32.242Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'cde5485e81c136b75e347da8e42d00f7'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'cde5485e81c136b75e347da8e42d00f7'[39m,
    [32m'security'[39m,
    [32m'cde5485e81c136b75e347da8e42d00f7'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:32.242Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:32.242Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516052289,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"cde5485e81c136b75e347da8e42d00f7","login_success","security","cde5485e81c136b75e347da8e42d00f7","security","cde5485e81c136b75e347da8e42d00f7","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:32.242Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:32.242Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516052296,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w48
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w48,public

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w48 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w48%2Cpublic

{"level":30,"time":1768516052615,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516052661,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516052706,"env":"test","module":"auth-routes","userId":"3a4e846b8dc781aea5cf3d0c25ba42b9","msg":"User logged in successfully"}
{"level":50,"time":1768516052749,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"3a4e846b8dc781aea5cf3d0c25ba42b9","login_success","security","3a4e846b8dc781aea5cf3d0c25ba42b9","security","3a4e846b8dc781aea5cf3d0c25ba42b9","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:32.706Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:32.706Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"3a4e846b8dc781aea5cf3d0c25ba42b9","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,3a4e846b8dc781aea5cf3d0c25ba42b9,login_success,security,3a4e846b8dc781aea5cf3d0c25ba42b9,security,3a4e846b8dc781aea5cf3d0c25ba42b9,{"metadata":{"timestamp":"2026-01-15T22:27:32.706Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:32.706Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'3a4e846b8dc781aea5cf3d0c25ba42b9'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'3a4e846b8dc781aea5cf3d0c25ba42b9'[39m,
    [32m'security'[39m,
    [32m'3a4e846b8dc781aea5cf3d0c25ba42b9'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:32.706Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:32.706Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516052749,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"3a4e846b8dc781aea5cf3d0c25ba42b9","login_success","security","3a4e846b8dc781aea5cf3d0c25ba42b9","security","3a4e846b8dc781aea5cf3d0c25ba42b9","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:32.706Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:32.706Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mremoveMember[2m > [22m[2mshould prevent self-removal
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,741d5d7c-92e2-498f-acc9-1d8b290b7833,{"after":{"name":"Self Remove Test Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'741d5d7c-92e2-498f-acc9-1d8b290b7833'[39m,
    [32m'{"after":{"name":"Self Remove Test Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:243:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516052871,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516052871,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/organizations-audit-fixes.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 12772[2mms[22m[39m
       [33m[2m‚úì[22m[39m should cascade ownership to workflow runs when project is transferred [33m 862[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent double-acceptance via transaction [33m 1638[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not create invite if email fails [33m 898[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow re-invite after invite expires [33m 1897[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow last admin to delete empty organization [33m 955[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent deletion if org owns assets [33m 1116[2mms[22m[39m
       [33m[2m‚úì[22m[39m should cleanup placeholder user when invite is revoked [33m 1983[2mms[22m[39m
       [33m[2m‚úì[22m[39m should fail fast on non-existent org [33m 365[2mms[22m[39m
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for f48360816d2b296175445dfb6f489735

{"level":30,"time":1768516053003,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w48, public

{"level":30,"time":1768516053004,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768516053040,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
 [32m‚úì[39m tests/unit/repositories/WorkflowTemplateRepository.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 13996[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create a workflow template mapping [33m 598[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create non-primary mapping by default [33m 617[2mms[22m[39m
       [33m[2m‚úì[22m[39m should find all templates for a workflow version [33m 700[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return empty array for version with no templates [33m 563[2mms[22m[39m
       [33m[2m‚úì[22m[39m should order by createdAt desc (newest first) [33m 687[2mms[22m[39m
       [33m[2m‚úì[22m[39m should find mapping by workflow version and key [33m 649[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return undefined for non-existent key [33m 576[2mms[22m[39m
       [33m[2m‚úì[22m[39m should find primary template for workflow version [33m 682[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return undefined when no primary template exists [33m 631[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set a template as primary and unset others [33m 852[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle setting primary when none existed before [33m 852[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not delete mapping if workflow version does not match [33m 804[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return true if key exists in workflow version [33m 637[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return false if key does not exist [33m 579[2mms[22m[39m
       [33m[2m‚úì[22m[39m should exclude specified id when checking existence [33m 624[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return true if key exists on different mapping [33m 724[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update mapping fields [33m 659[2mms[22m[39m
       [33m[2m‚úì[22m[39m should find mapping by id [33m 638[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return undefined for non-existent id [33m 605[2mms[22m[39m
{"level":50,"time":1768516053045,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w48
‚è© Schema reused, skipping migrations.

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould convert placeholder user to real user on accept
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,ed3ca986-03f2-4cf2-b026-b5a7b9f0d17c,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'ed3ca986-03f2-4cf2-b026-b5a7b9f0d17c'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w46.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w45.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w46.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w49
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w49,public

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w45.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w49 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w49%2Cpublic

{"level":30,"time":1768516053191,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,7604c5a4-ead6-421e-b78c-31dbc55f9d3c,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'7604c5a4-ead6-421e-b78c-31dbc55f9d3c'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516053236,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould complete MFA login with valid TOTP code
[22m[39m[TEST UTILS] MFA Secret verified for 91ccc9f4d2e7b755eae6ed61fea4da06

{"level":30,"time":1768516053551,"env":"test","module":"auth-routes","userId":"3a4e846b8dc781aea5cf3d0c25ba42b9","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/services/AuthService.test.ts[2m > [22m[2mAuthService[2m > [22m[2mJWT Token Management[2m > [22m[2mverifyToken()[2m > [22m[2mshould throw error for invalid token signature
[22m[39mDEBUG: verifyToken threw: Invalid or malformed token InvalidTokenError

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w49, public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return backup codes count for MFA users
[22m[39m[TEST UTILS] MFA Secret verified for b7d8ed84bbc2a0c96a6a9cfe65efdd9d

{"level":50,"time":1768516053595,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"3a4e846b8dc781aea5cf3d0c25ba42b9","login_success","security","3a4e846b8dc781aea5cf3d0c25ba42b9","security","3a4e846b8dc781aea5cf3d0c25ba42b9","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:33.551Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:33.551Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"3a4e846b8dc781aea5cf3d0c25ba42b9","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,3a4e846b8dc781aea5cf3d0c25ba42b9,login_success,security,3a4e846b8dc781aea5cf3d0c25ba42b9,security,3a4e846b8dc781aea5cf3d0c25ba42b9,{"metadata":{"timestamp":"2026-01-15T22:27:33.551Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:33.551Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'3a4e846b8dc781aea5cf3d0c25ba42b9'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'3a4e846b8dc781aea5cf3d0c25ba42b9'[39m,
    [32m'security'[39m,
    [32m'3a4e846b8dc781aea5cf3d0c25ba42b9'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:33.551Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:33.551Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516053595,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"3a4e846b8dc781aea5cf3d0c25ba42b9","login_success","security","3a4e846b8dc781aea5cf3d0c25ba42b9","security","3a4e846b8dc781aea5cf3d0c25ba42b9","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:33.551Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:33.551Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516053601,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768516053624,"env":"test","module":"email-queue","jobId":"b922b7c6-6293-42ea-b064-f27424b422e0","to":"newuser_1768516038034@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w49
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w48.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w48.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516053676,"env":"test","module":"auth-routes","userId":"f48360816d2b296175445dfb6f489735","msg":"Login requires MFA verification"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould convert placeholder user to real user on accept
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,ed3ca986-03f2-4cf2-b026-b5a7b9f0d17c,{"after":{"invitedEmail":"newuser_1768516038034@test.com","token":"9c033c67457b505c9f90893e549745102e11d55de712fe816efb1dfcee993e2c"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'ed3ca986-03f2-4cf2-b026-b5a7b9f0d17c'[39m,
    [32m'{"after":{"invitedEmail":"newuser_1768516038034@test.com","token":"9c033c67457b505c9f90893e549745102e11d55de712fe816efb1dfcee993e2c"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:194:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516053769,"env":"test","module":"mfa-service","userId":"f48360816d2b296175445dfb6f489735","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould complete MFA login with valid TOTP code
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516053819,"env":"test","module":"auth-routes","userId":"f48360816d2b296175445dfb6f489735","msg":"MFA login successful"}
{"level":30,"time":1768516053836,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mleaveOrganization[2m > [22m[2mshould allow member to leave organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,3f798eb2-b986-443d-a724-04eb3a73c7d5,{"after":{"name":"Leave Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'3f798eb2-b986-443d-a724-04eb3a73c7d5'[39m,
    [32m'{"after":{"name":"Leave Test Org Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:257:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516053839,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768516053866,"env":"test","module":"auth-service","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return backup codes count for MFA users
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516053869,"env":"test","module":"auth-service","tokenHash":"9206c2394794b8fc97fcd896f95e40028ab7a15c10279446c23fbdd4b4ae7a1e","plainTokenLen":13,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768516053869,"env":"test","module":"auth-service","tokenHash":"9206c2394794b8fc97fcd896f95e40028ab7a15c10279446c23fbdd4b4ae7a1e","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768516053869,"env":"test","module":"auth-service","allTokensCount":0,"msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768516053871,"env":"test","module":"auth-service","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768516053871,"env":"test","module":"auth-service","userId":"user-123","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768516053874,"env":"test","module":"auth-service","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768516053874,"env":"test","module":"auth-service","userId":"user-123","msg":"Security: Expired refresh token used"}
{"level":30,"time":1768516053879,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
{"level":30,"time":1768516053882,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
{"level":30,"time":1768516053884,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
{"level":30,"time":1768516053885,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516053963,"env":"test","module":"auth-routes","userId":"f48360816d2b296175445dfb6f489735","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000032,organization.create,organization,6c571f78-2da6-435a-85ba-47488082d70a,{"after":{"name":"Other Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000032'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'6c571f78-2da6-435a-85ba-47488082d70a'[39m,
    [32m'{"after":{"name":"Other Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:328:30
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516054023,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516054023,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/WorkflowTemplateService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 15864[2mms[22m[39m
       [33m[2m‚úì[22m[39m should throw error if template belongs to different project [33m 570[2mms[22m[39m
       [33m[2m‚úì[22m[39m should automatically unset other primaries when setting new primary [33m 1067[2mms[22m[39m
         [33m[2m‚úì[22m[39m should list all templates for workflow version [33m 743[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return empty array for version with no templates [33m 761[2mms[22m[39m
         [33m[2m‚úì[22m[39m should get template mapping by id and version [33m 662[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if mapping not found [33m 508[2mms[22m[39m
         [33m[2m‚úì[22m[39m should get template by key [33m 659[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if key not found [33m 494[2mms[22m[39m
         [33m[2m‚úì[22m[39m should get primary template for workflow version [33m 730[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return null when no primary template exists [33m 566[2mms[22m[39m
         [33m[2m‚úì[22m[39m should update mapping key [33m 691[2mms[22m[39m
         [33m[2m‚úì[22m[39m should update isPrimary flag [33m 781[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if new key already exists [33m 720[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if mapping not found [33m 497[2mms[22m[39m
         [33m[2m‚úì[22m[39m should unset other primaries when setting isPrimary to true [33m 966[2mms[22m[39m
         [33m[2m‚úì[22m[39m should detach template from workflow version [33m 758[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if mapping not found [33m 545[2mms[22m[39m
         [33m[2m‚úì[22m[39m should set template as primary [33m 958[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if mapping not found [33m 480[2mms[22m[39m
         [33m[2m‚úì[22m[39m should support operations within a transaction [33m 760[2mms[22m[39m
         [33m[2m‚úì[22m[39m should rollback on transaction error [33m 723[2mms[22m[39m
{"level":30,"time":1768516054110,"env":"test","module":"auth-routes","userId":"8a6f1a7f2ffd4fe301db37013e75352b","msg":"User logged in successfully"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w50
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w50,public

{"level":50,"time":1768516054169,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"8a6f1a7f2ffd4fe301db37013e75352b","login_success","security","8a6f1a7f2ffd4fe301db37013e75352b","security","8a6f1a7f2ffd4fe301db37013e75352b","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:34.110Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:34.110Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"8a6f1a7f2ffd4fe301db37013e75352b","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,8a6f1a7f2ffd4fe301db37013e75352b,login_success,security,8a6f1a7f2ffd4fe301db37013e75352b,security,8a6f1a7f2ffd4fe301db37013e75352b,{"metadata":{"timestamp":"2026-01-15T22:27:34.110Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:34.110Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'8a6f1a7f2ffd4fe301db37013e75352b'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'8a6f1a7f2ffd4fe301db37013e75352b'[39m,
    [32m'security'[39m,
    [32m'8a6f1a7f2ffd4fe301db37013e75352b'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:34.110Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:34.110Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516054169,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"8a6f1a7f2ffd4fe301db37013e75352b","login_success","security","8a6f1a7f2ffd4fe301db37013e75352b","security","8a6f1a7f2ffd4fe301db37013e75352b","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:34.110Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:34.110Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w50 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w50%2Cpublic

{"level":30,"time":1768516054273,"env":"test","module":"auth-routes","userId":"91ccc9f4d2e7b755eae6ed61fea4da06","msg":"Login requires MFA verification"}
{"level":30,"time":1768516054337,"env":"test","module":"auth-routes","userId":"b7d8ed84bbc2a0c96a6a9cfe65efdd9d","msg":"Login requires MFA verification"}
{"level":30,"time":1768516054375,"env":"test","module":"mfa-service","userId":"91ccc9f4d2e7b755eae6ed61fea4da06","msg":"TOTP verification successful"}
{"level":30,"time":1768516054424,"env":"test","module":"auth-routes","userId":"91ccc9f4d2e7b755eae6ed61fea4da06","msg":"MFA login successful"}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768516054479,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516054479,"env":"test","module":"auth-routes","userId":"f48360816d2b296175445dfb6f489735","msg":"Login from trusted device - MFA skipped"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516054479,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768516054494,"env":"test","module":"mfa-service","userId":"b7d8ed84bbc2a0c96a6a9cfe65efdd9d","msg":"TOTP verification successful"}
{"level":30,"time":1768516054538,"env":"test","module":"auth-routes","userId":"f48360816d2b296175445dfb6f489735","msg":"User logged in successfully"}
{"level":30,"time":1768516054539,"env":"test","module":"auth-routes","userId":"b7d8ed84bbc2a0c96a6a9cfe65efdd9d","msg":"MFA login successful"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould convert placeholder user to real user on accept
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,bc4b9813-d372-45da-ba9e-e478fe6353b0,organization.invite_accept,organization,ed3ca986-03f2-4cf2-b026-b5a7b9f0d17c,{"after":{"email":"newuser_1768516038034@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'bc4b9813-d372-45da-ba9e-e478fe6353b0'[39m,
    [32m'organization.invite_accept'[39m,
    [32m'organization'[39m,
    [32m'ed3ca986-03f2-4cf2-b026-b5a7b9f0d17c'[39m,
    [32m'{"after":{"email":"newuser_1768516038034@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:204:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516054585,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"f48360816d2b296175445dfb6f489735","login_success","security","f48360816d2b296175445dfb6f489735","security","f48360816d2b296175445dfb6f489735","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:34.539Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:27:34.539Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"f48360816d2b296175445dfb6f489735","eventType":"login_success","msg":"Failed to log security event"}
{"level":30,"time":1768516054591,"env":"test","module":"writeback-execution-service","runId":"d348bd3a-5264-44d8-8654-47292f1a3b26","workflowId":"7d93f161-c806-475a-9515-73f6e1fba786","msg":"Executing writeback mappings for completed run"}
 [31m‚ùØ[39m tests/integration/auth.flows.real.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m6 failed[39m[2m)[22m[33m 29492[2mms[22m[39m
[31m       [31m√ó[31m should complete registration, verify email, then login[39m[33m 2454[2mms[22m[39m
       [33m[2m‚úì[22m[39m should lock account after 5 failed attempts, then unlock after waiting [33m 4004[2mms[22m[39m
       [33m[2m‚úì[22m[39m should record all login attempts [33m 2982[2mms[22m[39m
[31m       [31m√ó[31m should complete MFA setup and login with TOTP[39m[33m 1967[2mms[22m[39m
[31m       [31m√ó[31m should login with backup code when TOTP unavailable[39m[33m 2041[2mms[22m[39m
[31m       [31m√ó[31m should complete full password reset flow[39m[33m 2342[2mms[22m[39m
       [33m[2m‚úì[22m[39m should invalidate all sessions after password reset [33m 2814[2mms[22m[39m
       [33m[2m‚úì[22m[39m should rotate refresh token on each use [33m 2343[2mms[22m[39m
       [33m[2m‚úì[22m[39m should detect and prevent refresh token reuse (token theft) [33m 2165[2mms[22m[39m
[31m       [31m√ó[31m should list all active sessions[39m[33m 2607[2mms[22m[39m
[31m       [31m√ó[31m should revoke specific session[39m[33m 2616[2mms[22m[39m
[90mstderr[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,f48360816d2b296175445dfb6f489735,login_success,security,f48360816d2b296175445dfb6f489735,security,f48360816d2b296175445dfb6f489735,{"metadata":{"timestamp":"2026-01-15T22:27:34.539Z"}},192.168.1.100,Mozilla/5.0 (Windows NT 10.0; Win64; x64),2026-01-15T22:27:34.539Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'f48360816d2b296175445dfb6f489735'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'f48360816d2b296175445dfb6f489735'[39m,
    [32m'security'[39m,
    [32m'f48360816d2b296175445dfb6f489735'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:34.539Z"}}'[39m,
    [32m'192.168.1.100'[39m,
    [32m'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'[39m,
    [32m'2026-01-15T22:27:34.539Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516054585,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"f48360816d2b296175445dfb6f489735","login_success","security","f48360816d2b296175445dfb6f489735","security","f48360816d2b296175445dfb6f489735","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:34.539Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:27:34.539Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768516054638,"env":"test","module":"writeback-execution-service","runId":"d348bd3a-5264-44d8-8654-47292f1a3b26","workflowId":"7d93f161-c806-475a-9515-73f6e1fba786","mappingCount":1,"msg":"Found writeback mappings"}
{"level":30,"time":1768516054839,"env":"test","module":"writeback-execution-service","runId":"d348bd3a-5264-44d8-8654-47292f1a3b26","workflowId":"7d93f161-c806-475a-9515-73f6e1fba786","mappingId":"148aec9a-af54-4e95-a2b9-19d045dc3b6d","tableId":"0636e81e-5a03-49cd-84fd-a51b6a8fcde5","msg":"Executing writeback mapping"}
{"level":30,"time":1768516054969,"env":"test","module":"auth-routes","userId":"8a6f1a7f2ffd4fe301db37013e75352b","msg":"User logged in successfully"}
{"level":50,"time":1768516055015,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"8a6f1a7f2ffd4fe301db37013e75352b","login_success","security","8a6f1a7f2ffd4fe301db37013e75352b","security","8a6f1a7f2ffd4fe301db37013e75352b","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:34.970Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:34.970Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"8a6f1a7f2ffd4fe301db37013e75352b","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,8a6f1a7f2ffd4fe301db37013e75352b,login_success,security,8a6f1a7f2ffd4fe301db37013e75352b,security,8a6f1a7f2ffd4fe301db37013e75352b,{"metadata":{"timestamp":"2026-01-15T22:27:34.970Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:34.970Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'8a6f1a7f2ffd4fe301db37013e75352b'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'8a6f1a7f2ffd4fe301db37013e75352b'[39m,
    [32m'security'[39m,
    [32m'8a6f1a7f2ffd4fe301db37013e75352b'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:34.970Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:34.970Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516055016,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"8a6f1a7f2ffd4fe301db37013e75352b","login_success","security","8a6f1a7f2ffd4fe301db37013e75352b","security","8a6f1a7f2ffd4fe301db37013e75352b","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:34.970Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:34.970Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516055091,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516055133,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mleaveOrganization[2m > [22m[2mshould allow admin to leave organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,794fd911-a822-4eec-8e81-abfea0278b8a,{"after":{"name":"Admin Leave Test Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'794fd911-a822-4eec-8e81-abfea0278b8a'[39m,
    [32m'{"after":{"name":"Admin Leave Test Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:272:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mTransfer Validation[2m > [22m[2mshould only allow transfer to self when targetOwnerType is user
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,b53fec62-9e10-4da7-bfe4-08ef4b18fec5,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'b53fec62-9e10-4da7-bfe4-08ef4b18fec5'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w51
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w51,public

{"level":30,"time":1768516055217,"env":"test","module":"writeback-execution-service","runId":"d348bd3a-5264-44d8-8654-47292f1a3b26","workflowId":"7d93f161-c806-475a-9515-73f6e1fba786","mappingId":"148aec9a-af54-4e95-a2b9-19d045dc3b6d","columnCount":3,"msg":"Successfully created DataVault row"}
{"level":30,"time":1768516055217,"env":"test","module":"writeback-execution-service","runId":"d348bd3a-5264-44d8-8654-47292f1a3b26","workflowId":"7d93f161-c806-475a-9515-73f6e1fba786","rowsCreated":1,"errorCount":0,"msg":"Writeback execution completed"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w51 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w51%2Cpublic

{"level":30,"time":1768516055259,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516055301,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould reject invalid MFA code
[22m[39m[TEST UTILS] MFA Secret verified for 160b4062c1471113a29bc469dedd8705

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w50, public

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w50
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w49.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w49.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w51, public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould disable MFA with password verification
[22m[39m[TEST UTILS] MFA Secret verified for 8836d8d72ab564da53eb2ace00dbb1db

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w51
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516055707,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516055707,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768516055735,"env":"test","module":"auth-service","tokenHash":"c5e9e6699b71b891a32a57b846d5a5e4e2594151955bea8c142c5c85d86eff7c","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768516055738,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
 [32m‚úì[39m tests/integration/organizationService.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 17652[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create organization and auto-create admin membership [33m 976[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return all organizations for user [33m 969[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return empty array for user with no memberships [33m 651[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to update organization [33m 1410[2mms[22m[39m
       [33m[2m‚úì[22m[39m should deny non-admin from updating organization [33m 1103[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return all members of organization [33m 1126[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to promote member [33m 1777[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to demote other admin [33m 1756[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent self-demotion [33m 1043[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to remove member [33m 1972[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent self-removal [33m 987[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow member to leave organization [33m 1258[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to leave organization [33m 1331[2mms[22m[39m
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w50.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w50.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516055773,"env":"test","module":"auth-routes","userId":"8a6f1a7f2ffd4fe301db37013e75352b","msg":"User logged in successfully"}
{"level":50,"time":1768516055821,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"8a6f1a7f2ffd4fe301db37013e75352b","login_success","security","8a6f1a7f2ffd4fe301db37013e75352b","security","8a6f1a7f2ffd4fe301db37013e75352b","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:35.773Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:35.773Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"8a6f1a7f2ffd4fe301db37013e75352b","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,8a6f1a7f2ffd4fe301db37013e75352b,login_success,security,8a6f1a7f2ffd4fe301db37013e75352b,security,8a6f1a7f2ffd4fe301db37013e75352b,{"metadata":{"timestamp":"2026-01-15T22:27:35.773Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:35.773Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'8a6f1a7f2ffd4fe301db37013e75352b'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'8a6f1a7f2ffd4fe301db37013e75352b'[39m,
    [32m'security'[39m,
    [32m'8a6f1a7f2ffd4fe301db37013e75352b'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:35.773Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:35.773Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516055821,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"8a6f1a7f2ffd4fe301db37013e75352b","login_success","security","8a6f1a7f2ffd4fe301db37013e75352b","security","8a6f1a7f2ffd4fe301db37013e75352b","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:35.773Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:35.773Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w52
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w52,public

{"level":40,"time":1768516055828,"env":"test","module":"mfa-service","userId":"160b4062c1471113a29bc469dedd8705","msg":"TOTP verification failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768516055828,"env":"test","module":"auth-routes","userId":"160b4062c1471113a29bc469dedd8705","msg":"MFA verification failed during login"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject expired invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,0e455192-7adf-4a07-9892-832037d6fcac,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'0e455192-7adf-4a07-9892-832037d6fcac'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w52 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w52%2Cpublic

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for 9e681edb9ec12147a05e251ce2581ba2

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould disable MFA with password verification
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516056182,"env":"test","module":"writeback-execution-service","runId":"932e06f2-307a-4d92-91ca-ac08c40f8bf4","workflowId":"7d93f161-c806-475a-9515-73f6e1fba786","msg":"Executing writeback mappings for completed run"}
{"level":30,"time":1768516056221,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768516056227,"env":"test","module":"writeback-execution-service","runId":"932e06f2-307a-4d92-91ca-ac08c40f8bf4","workflowId":"7d93f161-c806-475a-9515-73f6e1fba786","mappingCount":1,"msg":"Found writeback mappings"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768516056322,"env":"test","module":"email-queue","jobId":"c56625bd-9c94-4463-8f67-921b170ef494","to":"existing_1768516038034@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/analytics_service.test.ts[2m > [22m[2mAnalytics Service Integration
[22m[39mMANUAL PATCH: Applied FK fix for workflow_run_events AND workflow_run_metrics

{"level":30,"time":1768516056376,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516056376,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768516056414,"env":"test","module":"writeback-execution-service","runId":"932e06f2-307a-4d92-91ca-ac08c40f8bf4","workflowId":"7d93f161-c806-475a-9515-73f6e1fba786","mappingId":"148aec9a-af54-4e95-a2b9-19d045dc3b6d","tableId":"0636e81e-5a03-49cd-84fd-a51b6a8fcde5","msg":"Executing writeback mapping"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject expired invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,0e455192-7adf-4a07-9892-832037d6fcac,{"after":{"invitedEmail":"existing_1768516038034@test.com","token":"fc8eecf037466b428d336b035a802e803c84cb5b114373ce7e622b355a1f4721"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'0e455192-7adf-4a07-9892-832037d6fcac'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768516038034@test.com","token":"fc8eecf037466b428d336b035a802e803c84cb5b114373ce7e622b355a1f4721"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:216:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mTransfer Validation[2m > [22m[2mshould allow transfer from user to self (org member transferring org asset to themselves)
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,84d639c1-fcc6-456d-985c-38a394f2dbf9,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'84d639c1-fcc6-456d-985c-38a394f2dbf9'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516056466,"env":"test","module":"auth-routes","userId":"8836d8d72ab564da53eb2ace00dbb1db","msg":"Login requires MFA verification"}
 [31m‚ùØ[39m tests/integration/auth.routes.real.test.ts [2m([22m[2m26 tests[22m[2m | [22m[31m3 failed[39m[2m)[22m[33m 31389[2mms[22m[39m
       [33m[2m‚úì[22m[39m should register a new user successfully [33m 1239[2mms[22m[39m
       [32m‚úì[39m should return 400 for invalid email format[32m 7[2mms[22m[39m
       [32m‚úì[39m should return 400 for weak password[32m 6[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 409 for duplicate email [33m 1230[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set httpOnly refresh token cookie [33m 545[2mms[22m[39m
[31m       [31m√ó[31m should login with valid credentials[39m[33m 1841[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for invalid password [33m 1487[2mms[22m[39m
       [32m‚úì[39m should return 401 for non-existent user[32m 201[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 403 for unverified email [33m 1002[2mms[22m[39m
       [33m[2m‚úì[22m[39m should record failed login attempt [33m 1545[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return requiresMfa=true for MFA-enabled users [33m 2114[2mms[22m[39m
       [33m[2m‚úì[22m[39m should lock account after 5 failed attempts [33m 3727[2mms[22m[39m
       [33m[2m‚úì[22m[39m should logout and clear refresh token cookie [33m 1805[2mms[22m[39m
       [33m[2m‚úì[22m[39m should refresh access token with valid refresh token [33m 1927[2mms[22m[39m
       [32m‚úì[39m should return 401 for missing refresh token[32m 4[2mms[22m[39m
       [33m[2m‚úì[22m[39m should rotate refresh token after use [33m 2055[2mms[22m[39m
       [33m[2m‚úì[22m[39m should send password reset email for existing user [33m 1131[2mms[22m[39m
       [32m‚úì[39m should not reveal if email exists (security)[32m 49[2mms[22m[39m
[31m       [31m√ó[31m should reset password with valid token[39m[33m 1932[2mms[22m[39m
       [32m‚úì[39m should return 400 for invalid token[32m 53[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 400 for weak new password [33m 1250[2mms[22m[39m
[31m       [31m√ó[31m should return current user for valid token[39m[33m 1742[2mms[22m[39m
       [32m‚úì[39m should return 401 for missing token[32m 5[2mms[22m[39m
       [32m‚úì[39m should return 401 for invalid token[32m 5[2mms[22m[39m
         [33m[2m‚úì[22m[39m should complete MFA login with valid TOTP code [33m 1943[2mms[22m[39m
         [33m[2m‚úì[22m[39m should reject invalid MFA code [33m 1385[2mms[22m[39m
{"level":30,"time":1768516056575,"env":"test","module":"mfa-service","userId":"8836d8d72ab564da53eb2ace00dbb1db","msg":"TOTP verification successful"}
{"level":30,"time":1768516056620,"env":"test","module":"auth-routes","userId":"8a6f1a7f2ffd4fe301db37013e75352b","msg":"User logged in successfully"}
{"level":30,"time":1768516056624,"env":"test","module":"auth-routes","userId":"8836d8d72ab564da53eb2ace00dbb1db","msg":"MFA login successful"}
{"level":50,"time":1768516056663,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"8a6f1a7f2ffd4fe301db37013e75352b","login_success","security","8a6f1a7f2ffd4fe301db37013e75352b","security","8a6f1a7f2ffd4fe301db37013e75352b","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:36.620Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:36.620Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"8a6f1a7f2ffd4fe301db37013e75352b","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,8a6f1a7f2ffd4fe301db37013e75352b,login_success,security,8a6f1a7f2ffd4fe301db37013e75352b,security,8a6f1a7f2ffd4fe301db37013e75352b,{"metadata":{"timestamp":"2026-01-15T22:27:36.620Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:36.620Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'8a6f1a7f2ffd4fe301db37013e75352b'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'8a6f1a7f2ffd4fe301db37013e75352b'[39m,
    [32m'security'[39m,
    [32m'8a6f1a7f2ffd4fe301db37013e75352b'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:36.620Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:36.620Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516056664,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"8a6f1a7f2ffd4fe301db37013e75352b","login_success","security","8a6f1a7f2ffd4fe301db37013e75352b","security","8a6f1a7f2ffd4fe301db37013e75352b","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:36.620Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:36.620Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516056671,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516056674,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516056721,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516056731,"env":"test","module":"auth-routes","userId":"9e681edb9ec12147a05e251ce2581ba2","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w53
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w53,public

{"level":30,"time":1768516056794,"env":"test","module":"writeback-execution-service","runId":"932e06f2-307a-4d92-91ca-ac08c40f8bf4","workflowId":"7d93f161-c806-475a-9515-73f6e1fba786","mappingId":"148aec9a-af54-4e95-a2b9-19d045dc3b6d","columnCount":3,"msg":"Successfully created DataVault row"}
{"level":30,"time":1768516056794,"env":"test","module":"writeback-execution-service","runId":"932e06f2-307a-4d92-91ca-ac08c40f8bf4","workflowId":"7d93f161-c806-475a-9515-73f6e1fba786","rowsCreated":1,"errorCount":0,"msg":"Writeback execution completed"}
{"level":30,"time":1768516056794,"env":"test","runId":"932e06f2-307a-4d92-91ca-ac08c40f8bf4","rowsCreated":1,"msg":"DataVault writeback completed"}
{"level":30,"time":1768516056794,"env":"test","runId":"932e06f2-307a-4d92-91ca-ac08c40f8bf4","service":"DocumentGenerationService","msg":"Starting document generation for run"}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w53 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w53%2Cpublic

{"level":30,"time":1768516056833,"env":"test","module":"mfa-service","userId":"9e681edb9ec12147a05e251ce2581ba2","msg":"TOTP verification successful"}
{"level":30,"time":1768516056881,"env":"test","module":"auth-routes","userId":"9e681edb9ec12147a05e251ce2581ba2","msg":"MFA login successful"}
{"level":40,"time":1768516056887,"env":"test","runId":"932e06f2-307a-4d92-91ca-ac08c40f8bf4","service":"DocumentGenerationService","allSections":[{"id":"5549cf9e-0a11-432d-ac32-4a4e5f95b5c5","config":{}}],"runId":"932e06f2-307a-4d92-91ca-ac08c40f8bf4","msg":"No Final Documents sections found, skipping generation. This might cause the frontend to hang."}
{"level":30,"time":1768516056887,"env":"test","runId":"932e06f2-307a-4d92-91ca-ac08c40f8bf4","msg":"Documents generated successfully"}
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/AuthService.test.ts [2m([22m[2m113 tests[22m[2m)[22m[33m 8234[2mms[22m[39m
         [33m[2m‚úì[22m[39m should generate different hashes for same password [33m 428[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return true for correct password [33m 443[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return false for incorrect password [33m 439[2mms[22m[39m
         [33m[2m‚úì[22m[39m should be case-sensitive [33m 445[2mms[22m[39m
         [33m[2m‚úì[22m[39m should handle empty password comparison [33m 460[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error for expired token [33m 1104[2mms[22m[39m
         [33m[2m‚úì[22m[39m should handle password with special characters [33m 467[2mms[22m[39m
         [33m[2m‚úì[22m[39m should handle password with newlines and tabs [33m 458[2mms[22m[39m
         [33m[2m‚úì[22m[39m should reject password with null bytes (if validation exists) [33m 450[2mms[22m[39m
         [33m[2m‚úì[22m[39m should support complete password reset workflow [33m 483[2mms[22m[39m
         [33m[2m‚úì[22m[39m should compare password in reasonable time (< 500ms) [33m 488[2mms[22m[39m
{"level":30,"time":1768516057043,"env":"test","module":"auth-routes","userId":"9e681edb9ec12147a05e251ce2581ba2","deviceFingerprint":"10fa3aea039bf6fec7b6bcb982cbed1cc6ab844dd3c0879bec32baefb2997b52","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w52, public

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w52
‚è© Schema reused, skipping migrations.

[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mError Handling[2m > [22m[2mreverts value on save error
[22m[39mFailed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:206:36
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

{"level":30,"time":1768516057142,"env":"test","module":"mfa-service","userId":"8836d8d72ab564da53eb2ace00dbb1db","msg":"MFA disabled"}
{"level":50,"time":1768516057143,"env":"test","error":{"query":"insert into \"workflow_run_events\" (\"id\", \"run_id\", \"version_id\", \"workflow_id\", \"block_id\", \"page_id\", \"type\", \"timestamp\", \"payload\", \"is_preview\") values (default, $1, $2, $3, default, default, $4, $5, $6, $7)","params":["932e06f2-307a-4d92-91ca-ac08c40f8bf4","draft","7d93f161-c806-475a-9515-73f6e1fba786","workflow.complete","2026-01-15T22:27:37.092Z","{\"durationMs\":1150,\"stepCount\":2}",false],"cause":{"length":137,"name":"error","severity":"ERROR","code":"22P02","where":"unnamed portal parameter $2 = '...'","file":"uuid.c","line":"138","routine":"string_to_uuid"}},"input":{"runId":"932e06f2-307a-4d92-91ca-ac08c40f8bf4","workflowId":"7d93f161-c806-475a-9515-73f6e1fba786","versionId":"draft","type":"workflow.complete","timestamp":"2026-01-15T22:27:37.092Z","isPreview":false,"payload":{"durationMs":1150,"stepCount":2}},"msg":"Failed to record analytics event"}
{"level":30,"time":1768516057142,"env":"test","module":"auth-routes","userId":"8836d8d72ab564da53eb2ace00dbb1db","msg":"MFA disabled by user"}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w51.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w51.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768516057191,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"8836d8d72ab564da53eb2ace00dbb1db","mfa_disabled","security","8836d8d72ab564da53eb2ace00dbb1db","security","8836d8d72ab564da53eb2ace00dbb1db","{\"metadata\":{\"mfaMethod\":\"totp\",\"timestamp\":\"2026-01-15T22:27:37.142Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:37.142Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"8836d8d72ab564da53eb2ace00dbb1db","eventType":"mfa_disabled","msg":"Failed to log security event"}
{"level":50,"time":1768516057191,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"8836d8d72ab564da53eb2ace00dbb1db","mfa_disabled","security","8836d8d72ab564da53eb2ace00dbb1db","security","8836d8d72ab564da53eb2ace00dbb1db","{\"metadata\":{\"mfaMethod\":\"totp\",\"timestamp\":\"2026-01-15T22:27:37.142Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:37.142Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"MFA disable error"}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w54
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w54,public

[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mError Handling[2m > [22m[2mdisplays error indicator on save failure
[22m[39mFailed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:222:36
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w54 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w54%2Cpublic

{"level":30,"time":1768516057249,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516057250,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

 [32m‚úì[39m tests/integration/transferOwnership.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 19090[2mms[22m[39m
       [33m[2m‚úì[22m[39m should transfer user-owned project to org [33m 1741[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent transfer to org if user is not a member [33m 1894[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow org member to transfer org-owned project to another org they belong to [33m 2243[2mms[22m[39m
       [33m[2m‚úì[22m[39m should detach workflow from project when transferring to different owner [33m 1518[2mms[22m[39m
       [33m[2m‚úì[22m[39m should keep workflow in project when transferring to same owner [33m 1641[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent non-member from transferring org workflow [33m 1507[2mms[22m[39m
       [33m[2m‚úì[22m[39m should transfer database ownership [33m 1336[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow org member to transfer org database [33m 1400[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent transfer to org if user is not a member [33m 1936[2mms[22m[39m
       [33m[2m‚úì[22m[39m should only allow transfer to self when targetOwnerType is user [33m 1211[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow transfer from user to self (org member transferring org asset to themselves) [33m 1475[2mms[22m[39m
[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mBoolean Type (Checkbox)[2m > [22m[2mshows loading spinner when saving checkbox
[22m[39mWarning: An update to EditableCell inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at EditableCell (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/EditableCell.tsx:12:25)

{"level":30,"time":1768516057550,"env":"test","module":"auth-routes","userId":"9e681edb9ec12147a05e251ce2581ba2","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516057666,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516057731,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516057764,"env":"test","module":"writeback-execution-service","runId":"82a34bb7-87b4-4476-94c9-0fccad926f2a","workflowId":"0369c187-76ec-4acc-8e0b-c524d5ec1467","msg":"Executing writeback mappings for completed run"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject already accepted invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,7fd13015-15ea-485f-9809-2c49e05edfb7,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'7fd13015-15ea-485f-9809-2c49e05edfb7'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516057801,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516057802,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768516057808,"env":"test","runId":"82a34bb7-87b4-4476-94c9-0fccad926f2a","service":"DocumentGenerationService","msg":"Starting document generation for run"}
 [32m‚úì[39m tests/integration/ownershipAccess.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 5030[2mms[22m[39m
{"level":40,"time":1768516057899,"env":"test","runId":"82a34bb7-87b4-4476-94c9-0fccad926f2a","service":"DocumentGenerationService","allSections":[],"runId":"82a34bb7-87b4-4476-94c9-0fccad926f2a","msg":"No Final Documents sections found, skipping generation. This might cause the frontend to hang."}
{"level":30,"time":1768516057899,"env":"test","runId":"82a34bb7-87b4-4476-94c9-0fccad926f2a","msg":"Documents generated successfully"}
{"level":30,"time":1768516057974,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516057975,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w53, public

 [32m‚úì[39m tests/ui/datavault/EditableCell.test.tsx [2m([22m[2m29 tests[22m[2m)[22m[33m 4227[2mms[22m[39m
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w53
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w52.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w52.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516058279,"env":"test","module":"email-queue","jobId":"10bb75ee-f172-4c71-808e-8c59b27f5a45","to":"existing_1768516038034@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516058299,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768516058359,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject already accepted invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,7fd13015-15ea-485f-9809-2c49e05edfb7,{"after":{"invitedEmail":"existing_1768516038034@test.com","token":"1efdc575625a6f1fb7bac95ffcf7e19b2a8113837e2bc6588ce3bb3d535b9342"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'7fd13015-15ea-485f-9809-2c49e05edfb7'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768516038034@test.com","token":"1efdc575625a6f1fb7bac95ffcf7e19b2a8113837e2bc6588ce3bb3d535b9342"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:241:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516058511,"env":"test","module":"auth-routes","userId":"3f9ed10c5f5bc82bc37f68ce02454dda","msg":"User logged in successfully"}
{"level":50,"time":1768516058568,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"3f9ed10c5f5bc82bc37f68ce02454dda","login_success","security","3f9ed10c5f5bc82bc37f68ce02454dda","security","3f9ed10c5f5bc82bc37f68ce02454dda","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:38.511Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:38.511Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"3f9ed10c5f5bc82bc37f68ce02454dda","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,3f9ed10c5f5bc82bc37f68ce02454dda,login_success,security,3f9ed10c5f5bc82bc37f68ce02454dda,security,3f9ed10c5f5bc82bc37f68ce02454dda,{"metadata":{"timestamp":"2026-01-15T22:27:38.511Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:38.511Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'3f9ed10c5f5bc82bc37f68ce02454dda'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'3f9ed10c5f5bc82bc37f68ce02454dda'[39m,
    [32m'security'[39m,
    [32m'3f9ed10c5f5bc82bc37f68ce02454dda'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:38.511Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:38.511Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516058569,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"3f9ed10c5f5bc82bc37f68ce02454dda","login_success","security","3f9ed10c5f5bc82bc37f68ce02454dda","security","3f9ed10c5f5bc82bc37f68ce02454dda","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:38.511Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:38.511Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w55
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w55,public

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 50173a57a5bf4cbc1f8bd2c49ad3a810

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould require correct password to disable MFA
[22m[39m[TEST UTILS] MFA Secret verified for c9163bc5a89e1090e283bc138d2f8c23

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w55 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w55%2Cpublic

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w54, public

{"level":30,"time":1768516058739,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516058740,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w54
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w53.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w53.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/integration/workflows/runtime-pipelines.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 6556[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create DataVault row on workflow completion [33m 871[2mms[22m[39m
       [33m[2m‚úì[22m[39m should execute writebacks via RunService.completeRun() [33m 2318[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould require correct password to disable MFA
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject already accepted invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000022,organization.invite_accept,organization,7fd13015-15ea-485f-9809-2c49e05edfb7,{"after":{"email":"existing_1768516038034@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000022'[39m,
    [32m'organization.invite_accept'[39m,
    [32m'organization'[39m,
    [32m'7fd13015-15ea-485f-9809-2c49e05edfb7'[39m,
    [32m'{"after":{"email":"existing_1768516038034@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:248:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768516059375,"env":"test","module":"auth-routes","userId":"3f9ed10c5f5bc82bc37f68ce02454dda","msg":"User logged in successfully"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w56
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w56,public

{"level":50,"time":1768516059424,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"3f9ed10c5f5bc82bc37f68ce02454dda","login_success","security","3f9ed10c5f5bc82bc37f68ce02454dda","security","3f9ed10c5f5bc82bc37f68ce02454dda","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:39.376Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:39.376Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"3f9ed10c5f5bc82bc37f68ce02454dda","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,3f9ed10c5f5bc82bc37f68ce02454dda,login_success,security,3f9ed10c5f5bc82bc37f68ce02454dda,security,3f9ed10c5f5bc82bc37f68ce02454dda,{"metadata":{"timestamp":"2026-01-15T22:27:39.376Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:39.376Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'3f9ed10c5f5bc82bc37f68ce02454dda'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'3f9ed10c5f5bc82bc37f68ce02454dda'[39m,
    [32m'security'[39m,
    [32m'3f9ed10c5f5bc82bc37f68ce02454dda'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:39.376Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:39.376Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516059424,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"3f9ed10c5f5bc82bc37f68ce02454dda","login_success","security","3f9ed10c5f5bc82bc37f68ce02454dda","security","3f9ed10c5f5bc82bc37f68ce02454dda","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:39.376Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:39.376Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516059433,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768516059441,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w60
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w60,public

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w56 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w56%2Cpublic

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w60 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w60%2Cpublic

{"level":30,"time":1768516059500,"env":"test","module":"auth-routes","userId":"50173a57a5bf4cbc1f8bd2c49ad3a810","msg":"Login requires MFA verification"}
{"level":30,"time":1768516059507,"env":"test","module":"auth-routes","userId":"c9163bc5a89e1090e283bc138d2f8c23","msg":"Login requires MFA verification"}
{"level":30,"time":1768516059521,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516059521,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768516059605,"env":"test","module":"mfa-service","userId":"50173a57a5bf4cbc1f8bd2c49ad3a810","msg":"TOTP verification successful"}
{"level":30,"time":1768516059610,"env":"test","module":"mfa-service","userId":"c9163bc5a89e1090e283bc138d2f8c23","msg":"TOTP verification successful"}
 [32m‚úì[39m tests/integration/analytics_service.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 4693[2mms[22m[39m
     [33m[2m‚úì[22m[39m should generate events and metrics on run completion [33m 2826[2mms[22m[39m
{"level":30,"time":1768516059656,"env":"test","module":"auth-routes","userId":"50173a57a5bf4cbc1f8bd2c49ad3a810","msg":"MFA login successful"}
{"level":30,"time":1768516059663,"env":"test","module":"auth-routes","userId":"c9163bc5a89e1090e283bc138d2f8c23","msg":"MFA login successful"}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516059683,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516059749,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516059814,"env":"test","module":"auth-routes","userId":"50173a57a5bf4cbc1f8bd2c49ad3a810","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w61
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w61,public

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w61 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w61%2Cpublic

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w55, public

{"level":30,"time":1768516060095,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516060097,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w55
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w54.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w54.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

 [32m‚úì[39m tests/unit/components/datavault/TableGridView.test.tsx [2m([22m[2m9 tests[22m[2m)[22m[33m 4680[2mms[22m[39m
     [33m[2m‚úì[22m[39m loads table schema and rows [33m 530[2mms[22m[39m
     [33m[2m‚úì[22m[39m enters edit mode on double click [33m 378[2mms[22m[39m
     [33m[2m‚úì[22m[39m updates cell value on blur [33m 841[2mms[22m[39m
     [33m[2m‚úì[22m[39m renders delete button for each row [33m 519[2mms[22m[39m
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould verify email matches invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,fe722c72-4da6-43ea-97d1-3525182b4549,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'fe722c72-4da6-43ea-97d1-3525182b4549'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516060415,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w57
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w57,public

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w57 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w57%2Cpublic

{"level":30,"time":1768516060470,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516060498,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516060509,"env":"test","module":"auth-routes","userId":"50173a57a5bf4cbc1f8bd2c49ad3a810","msg":"Login from trusted device - MFA skipped"}
{"level":30,"time":1768516060562,"env":"test","module":"auth-routes","userId":"50173a57a5bf4cbc1f8bd2c49ad3a810","msg":"User logged in successfully"}
{"level":30,"time":1768516060563,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768516060609,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"50173a57a5bf4cbc1f8bd2c49ad3a810","login_success","security","50173a57a5bf4cbc1f8bd2c49ad3a810","security","50173a57a5bf4cbc1f8bd2c49ad3a810","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:40.562Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:27:40.562Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"50173a57a5bf4cbc1f8bd2c49ad3a810","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,50173a57a5bf4cbc1f8bd2c49ad3a810,login_success,security,50173a57a5bf4cbc1f8bd2c49ad3a810,security,50173a57a5bf4cbc1f8bd2c49ad3a810,{"metadata":{"timestamp":"2026-01-15T22:27:40.562Z"}},192.168.1.100,Mozilla/5.0 (Windows NT 10.0; Win64; x64),2026-01-15T22:27:40.562Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'50173a57a5bf4cbc1f8bd2c49ad3a810'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'50173a57a5bf4cbc1f8bd2c49ad3a810'[39m,
    [32m'security'[39m,
    [32m'50173a57a5bf4cbc1f8bd2c49ad3a810'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:40.562Z"}}'[39m,
    [32m'192.168.1.100'[39m,
    [32m'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'[39m,
    [32m'2026-01-15T22:27:40.562Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516060609,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"50173a57a5bf4cbc1f8bd2c49ad3a810","login_success","security","50173a57a5bf4cbc1f8bd2c49ad3a810","security","50173a57a5bf4cbc1f8bd2c49ad3a810","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:40.562Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:27:40.562Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768516060661,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516060662,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w62
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w62,public

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w58
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w58,public

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould return 400 if no active session found
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w62 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w62%2Cpublic

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w58 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w58%2Cpublic

 [32m‚úì[39m tests/unit/collab.client.test.tsx [2m([22m[2m17 tests[22m[2m)[22m[33m 3859[2mms[22m[39m
     [33m[2m‚úì[22m[39m should add a comment [33m 488[2mms[22m[39m
     [33m[2m‚úì[22m[39m should allow comment owner to delete their comment [33m 304[2mms[22m[39m
{"level":30,"time":1768516060808,"env":"test","module":"email-queue","jobId":"6529f0cf-d32f-4cac-ba15-506a650c6edc","to":"existing_1768516038034@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w60, public

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w60
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516060874,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould verify email matches invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,fe722c72-4da6-43ea-97d1-3525182b4549,{"after":{"invitedEmail":"existing_1768516038034@test.com","token":"4ee76cdb38915f152566b4876450d4bd56d65c3c35493327168142310b3b06b9"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'fe722c72-4da6-43ea-97d1-3525182b4549'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768516038034@test.com","token":"4ee76cdb38915f152566b4876450d4bd56d65c3c35493327168142310b3b06b9"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:257:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w56, public

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w55.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w55.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516060952,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w56
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w63
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w63,public

[90mstderr[2m | tests/unit/shared/workflowLogic.test.ts[2m > [22m[2mworkflowLogic[2m > [22m[2mevaluateRules[2m > [22m[2mOperators[2m > [22m[2mUnknown operator[2m > [22m[2mshould return false and log warning for unknown operator
[22m[39mUnknown operator: unknown_operator

{"level":30,"time":1768516061185,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516061186,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w63 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w63%2Cpublic

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould regenerate backup codes
[22m[39m[TEST UTILS] MFA Secret verified for a4e7c3445482bbc6c0a9257490da1364

 [32m‚úì[39m tests/unit/shared/workflowLogic.test.ts [2m([22m[2m65 tests[22m[2m)[22m[33m 2147[2mms[22m[39m
{"level":30,"time":1768516061243,"env":"test","module":"auth-routes","userId":"1268a97d1a7dacdf61b06031e86c8323","msg":"User logged in successfully"}
{"level":50,"time":1768516061293,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"1268a97d1a7dacdf61b06031e86c8323","login_success","security","1268a97d1a7dacdf61b06031e86c8323","security","1268a97d1a7dacdf61b06031e86c8323","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:41.243Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:41.243Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"1268a97d1a7dacdf61b06031e86c8323","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould validate expression after debounce
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould return 400 if no active session found
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,1268a97d1a7dacdf61b06031e86c8323,login_success,security,1268a97d1a7dacdf61b06031e86c8323,security,1268a97d1a7dacdf61b06031e86c8323,{"metadata":{"timestamp":"2026-01-15T22:27:41.243Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:41.243Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'1268a97d1a7dacdf61b06031e86c8323'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'1268a97d1a7dacdf61b06031e86c8323'[39m,
    [32m'security'[39m,
    [32m'1268a97d1a7dacdf61b06031e86c8323'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:41.243Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:41.243Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516061293,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"1268a97d1a7dacdf61b06031e86c8323","login_success","security","1268a97d1a7dacdf61b06031e86c8323","security","1268a97d1a7dacdf61b06031e86c8323","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:41.243Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:41.243Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w61, public

{"level":50,"time":1768516061300,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w61
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516061349,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516061350,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w59
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w59,public

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w60.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w56.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w60.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516061419,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w59 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w59%2Cpublic

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w56.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768516061466,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/ui/runs.components.test.tsx [2m([22m[2m19 tests[22m[2m)[22m[33m 4984[2mms[22m[39m
       [33m[2m‚úì[22m[39m should show download options for successful runs [33m 1280[2mms[22m[39m
       [33m[2m‚úì[22m[39m should call onChange when status filter changes [33m 437[2mms[22m[39m
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould regenerate backup codes
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516061522,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516061523,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mValidation Result DEBUG: {"ok":false,"errors":[{"message":"Unknown identifier: unknown_var","start":{"line":0,"col":0},"end":{"line":0,"col":11}}]}
IsValid DEBUG: [33mfalse[39m

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516061611,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould debounce validation calls
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768516061618,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516061619,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 36537[2mms[22m[39m
       [33m[2m‚úì[22m[39m should trust current device [33m 2246[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set trust expiry to 30 days [33m 2217[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update expiry if device already trusted [33m 2540[2mms[22m[39m
       [32m‚úì[39m should require authentication[32m 8[2mms[22m[39m
       [33m[2m‚úì[22m[39m should list all trusted devices [33m 3859[2mms[22m[39m
       [33m[2m‚úì[22m[39m should mark current device [33m 2346[2mms[22m[39m
       [33m[2m‚úì[22m[39m should exclude revoked devices [33m 2412[2mms[22m[39m
       [33m[2m‚úì[22m[39m should exclude expired devices [33m 2186[2mms[22m[39m
       [33m[2m‚úì[22m[39m should revoke specific device [33m 2413[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 404 for non-existent device [33m 1974[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent revoking other user's device [33m 4143[2mms[22m[39m
[31m       [31m√ó[31m should skip MFA for trusted device[39m[33m 3008[2mms[22m[39m
       [33m[2m‚úì[22m[39m should require MFA for untrusted device [33m 2625[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update lastUsedAt on trusted device login [33m 3408[2mms[22m[39m
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516061689,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516061691,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/ui/datavault/TableCard.test.tsx [2m([22m[2m8 tests[22m[2m)[22m[33m 3462[2mms[22m[39m
     [33m[2m‚úì[22m[39m should call onDelete when delete button is clicked [33m 939[2mms[22m[39m
{"level":30,"time":1768516061727,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516061728,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768516061751,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould not validate when workflowId or nodeId is missing
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

 [32m‚úì[39m tests/unit/services/docxHelpers.test.ts [2m([22m[2m39 tests[22m[2m)[22m[33m 2212[2mms[22m[39m
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould not validate when workflowId or nodeId is missing
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w64
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w64,public

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w57, public

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w64 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w64%2Cpublic

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w57
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w61.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w61.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould validate helper functions in expressions
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768516062014,"env":"test","module":"auth-routes","userId":"a4e7c3445482bbc6c0a9257490da1364","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w62, public

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould validate complex expressions with multiple helpers
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w62
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w58, public

{"level":30,"time":1768516062122,"env":"test","module":"mfa-service","userId":"a4e7c3445482bbc6c0a9257490da1364","msg":"TOTP verification successful"}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516062131,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w57.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w57.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w58
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768516062169,"env":"test","module":"auth-routes","userId":"a4e7c3445482bbc6c0a9257490da1364","msg":"MFA login successful"}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mDEBUG: Existing functions: []

{"level":30,"time":1768516062189,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject invalid token
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,73cb6aff-ceeb-4d5c-9806-71957e62a12a,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'73cb6aff-ceeb-4d5c-9806-71957e62a12a'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould handle syntax errors
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression Editor component behavior[2m > [22m[2mshould update validation when expression changes
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516062366,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516062407,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516062408,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768516062410,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/unit/services/RunExecutionCoordinator.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 2098[2mms[22m[39m
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression Editor component behavior[2m > [22m[2mshould update validation when expression changes
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w66
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w66,public

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w63, public

{"level":30,"time":1768516062560,"env":"test","module":"mfa-service","userId":"a4e7c3445482bbc6c0a9257490da1364","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768516062560,"env":"test","module":"mfa-service","userId":"a4e7c3445482bbc6c0a9257490da1364","msg":"Regenerated backup codes"}
{"level":30,"time":1768516062560,"env":"test","module":"auth-routes","userId":"a4e7c3445482bbc6c0a9257490da1364","msg":"Backup codes regenerated"}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w66 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w66%2Cpublic

[90mstderr[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx[2m > [22m[2mTableGridView - Drag & Drop[2m > [22m[2mrenders DndContext wrapper
[22m[39mWarning: validateDOMNesting(...): <th> cannot appear as a child of <div>.
    at th
    at SortableColumnHeader (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/SortableColumnHeader.tsx:12:33)
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
Warning: validateDOMNesting(...): <div> cannot appear as a child of <tr>.
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w63
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w62.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w58.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w62.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w67
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w67,public

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516062661,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516062672,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516062673,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w58.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w67 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w67%2Cpublic

{"level":30,"time":1768516062724,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/ui/expression-editor.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 3719[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update validation when expression changes [33m 325[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w59, public

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w59
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w63.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w63.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w68
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w68,public

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w68 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w68%2Cpublic

{"level":30,"time":1768516062942,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516062943,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/shared/validation/Validator.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 2187[2mms[22m[39m
{"level":30,"time":1768516063060,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516063061,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768516063070,"env":"test","module":"auth-routes","userId":"a92176e22f7d23b55b22bb4be16bb4c6","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w64, public

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

{"level":50,"time":1768516063119,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"a92176e22f7d23b55b22bb4be16bb4c6","login_success","security","a92176e22f7d23b55b22bb4be16bb4c6","security","a92176e22f7d23b55b22bb4be16bb4c6","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:43.070Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:43.070Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"a92176e22f7d23b55b22bb4be16bb4c6","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all trusted devices
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,a92176e22f7d23b55b22bb4be16bb4c6,login_success,security,a92176e22f7d23b55b22bb4be16bb4c6,security,a92176e22f7d23b55b22bb4be16bb4c6,{"metadata":{"timestamp":"2026-01-15T22:27:43.070Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:43.070Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'a92176e22f7d23b55b22bb4be16bb4c6'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'a92176e22f7d23b55b22bb4be16bb4c6'[39m,
    [32m'security'[39m,
    [32m'a92176e22f7d23b55b22bb4be16bb4c6'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:43.070Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:43.070Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516063119,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"a92176e22f7d23b55b22bb4be16bb4c6","login_success","security","a92176e22f7d23b55b22bb4be16bb4c6","security","a92176e22f7d23b55b22bb4be16bb4c6","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:43.070Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:43.070Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w64
‚è© Schema reused, skipping migrations.

{"level":50,"time":1768516063130,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768516063136,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w59.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w59.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/components/datavault/CellRenderer.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 3102[2mms[22m[39m
     [33m[2m‚úì[22m[39m renders boolean value as Yes/No [33m 433[2mms[22m[39m
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould return pending invites for user email
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,5ad0c8f8-e5f3-4dab-ba99-14315c7d1422,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'5ad0c8f8-e5f3-4dab-ba99-14315c7d1422'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w69
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w69,public

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w69 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w69%2Cpublic

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w70
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w70,public

{"level":30,"time":1768516063424,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516063425,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w70 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w70%2Cpublic

{"level":30,"time":1768516063438,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516063439,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516063464,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/unit/utils/pagination.test.ts [2m([22m[2m24 tests[22m[2m)[22m[33m 2051[2mms[22m[39m
{"level":30,"time":1768516063517,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

 [32m‚úì[39m tests/unit/components/datavault/TableGridViewDragDrop.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 3145[2mms[22m[39m
     [33m[2m‚úì[22m[39m displays columns in order based on orderIndex [33m 456[2mms[22m[39m
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould return error if MFA not enabled
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516063628,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516063683,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516063712,"env":"test","module":"email-queue","jobId":"8beb94a7-3dd9-4b1c-bc5d-626061d73085","to":"existing_1768516038034@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould return pending invites for user email
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,5ad0c8f8-e5f3-4dab-ba99-14315c7d1422,{"after":{"invitedEmail":"existing_1768516038034@test.com","token":"f042571d013af59407d822d6b6d157e914dd4ccf400bbcf54eae06d928e901be"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'5ad0c8f8-e5f3-4dab-ba99-14315c7d1422'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768516038034@test.com","token":"f042571d013af59407d822d6b6d157e914dd4ccf400bbcf54eae06d928e901be"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:278:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w71
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w71,public

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w66, public

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516063879,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w71 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w71%2Cpublic

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w66
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516063932,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w64.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w64.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516063962,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516063963,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w72
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w72,public

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w67, public

 [32m‚úì[39m tests/ui/datavault/DatabaseSettingsPage.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 3009[2mms[22m[39m
     [33m[2m‚úì[22m[39m should render database settings page with breadcrumbs [33m 490[2mms[22m[39m
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w72 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w72%2Cpublic

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w67
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w65
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w65,public

{"level":30,"time":1768516064107,"env":"test","module":"auth-routes","userId":"3ae7e0277cff22bad954b31713b3d1b9","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w66.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w66.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w65 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w65%2Cpublic

{"level":50,"time":1768516064163,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"3ae7e0277cff22bad954b31713b3d1b9","login_success","security","3ae7e0277cff22bad954b31713b3d1b9","security","3ae7e0277cff22bad954b31713b3d1b9","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:44.107Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:44.107Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"3ae7e0277cff22bad954b31713b3d1b9","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould return error if MFA not enabled
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,3ae7e0277cff22bad954b31713b3d1b9,login_success,security,3ae7e0277cff22bad954b31713b3d1b9,security,3ae7e0277cff22bad954b31713b3d1b9,{"metadata":{"timestamp":"2026-01-15T22:27:44.107Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:44.107Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'3ae7e0277cff22bad954b31713b3d1b9'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'3ae7e0277cff22bad954b31713b3d1b9'[39m,
    [32m'security'[39m,
    [32m'3ae7e0277cff22bad954b31713b3d1b9'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:44.107Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:44.107Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516064163,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"3ae7e0277cff22bad954b31713b3d1b9","login_success","security","3ae7e0277cff22bad954b31713b3d1b9","security","3ae7e0277cff22bad954b31713b3d1b9","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:44.107Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:44.107Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516064171,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768516064218,"env":"test","module":"rbac-middleware","path":"/api/workflows","permission":"workflow:create","msg":"Unauthenticated user attempted to access protected resource"}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w73
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w73,public

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516064228,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":40,"time":1768516064223,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permission":"workflow:create","path":"/api/workflows","msg":"Permission denied"}
{"level":40,"time":1768516064224,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"permission":"workflow:view","path":"/api/workflows","msg":"Permission denied"}
{"level":40,"time":1768516064226,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permissions":["workflow:create","workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (none of required permissions)"}
{"level":40,"time":1768516064227,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","permissions":["workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (missing some required permissions)"}
{"level":40,"time":1768516064229,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder"],"path":"/api/admin","msg":"Role check failed"}
{"level":40,"time":1768516064230,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"requiredRoles":["owner"],"path":"/api/admin","msg":"Role check failed"}
{"level":40,"time":1768516064231,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","requiredRoles":["owner"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768516064232,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"runner","requiredRoles":["owner","builder"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768516064234,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder","runner"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768516064238,"env":"test","module":"rbac-middleware","path":"/api/test","permission":"workflow:view","msg":"Unauthenticated user attempted to access protected resource"}
{"level":40,"time":1768516064239,"env":"test","module":"rbac-middleware","userId":"user-123","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
{"level":40,"time":1768516064240,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"invalid-role","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
{"level":30,"time":1768516064240,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516064241,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516064258,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w73 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w73%2Cpublic

{"level":30,"time":1768516064277,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/unit/middleware/rbac.test.ts [2m([22m[2m44 tests[22m[2m)[22m[33m 2116[2mms[22m[39m
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w68, public

{"level":30,"time":1768516064311,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w68
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w67.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w67.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516064421,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516064421,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/listPipeline.semantics.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 2167[2mms[22m[39m
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould handle user with single session gracefully
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w69, public

{"level":30,"time":1768516064640,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516064640,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w70, public

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w69
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/unit/services/TemplateAnalysisService.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 2158[2mms[22m[39m
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w70
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w68.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w68.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516064749,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w68.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w68.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516064805,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516064905,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516064959,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

{"level":30,"time":1768516064974,"env":"test","module":"auth-routes","userId":"4f0f8d58fc8fb779277e496485d1ac6c","msg":"User logged in successfully"}
{"level":30,"time":1768516064993,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516064994,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516065024,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768516065026,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"4f0f8d58fc8fb779277e496485d1ac6c","login_success","security","4f0f8d58fc8fb779277e496485d1ac6c","security","4f0f8d58fc8fb779277e496485d1ac6c","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:44.974Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:44.974Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"4f0f8d58fc8fb779277e496485d1ac6c","eventType":"login_success","msg":"Failed to log security event"}
{"level":30,"time":1768516065025,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould handle user with single session gracefully
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,4f0f8d58fc8fb779277e496485d1ac6c,login_success,security,4f0f8d58fc8fb779277e496485d1ac6c,security,4f0f8d58fc8fb779277e496485d1ac6c,{"metadata":{"timestamp":"2026-01-15T22:27:44.974Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:44.974Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'4f0f8d58fc8fb779277e496485d1ac6c'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'4f0f8d58fc8fb779277e496485d1ac6c'[39m,
    [32m'security'[39m,
    [32m'4f0f8d58fc8fb779277e496485d1ac6c'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:44.974Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:44.974Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516065026,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"4f0f8d58fc8fb779277e496485d1ac6c","login_success","security","4f0f8d58fc8fb779277e496485d1ac6c","security","4f0f8d58fc8fb779277e496485d1ac6c","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:44.974Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:44.974Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516065035,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
 [32m‚úì[39m tests/unit/services/docxRenderer2.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 2113[2mms[22m[39m
 [32m‚úì[39m tests/ui/builder.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 2039[2mms[22m[39m
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516065122,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return expired invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,7949a529-d577-4e6f-a716-b005b3f8c1b7,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'7949a529-d577-4e6f-a716-b005b3f8c1b7'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516065138,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w71, public

{"level":30,"time":1768516065181,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516065191,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w71
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w69.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w70.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w69.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w72, public

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w70.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w72
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w78
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w78,public

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w78 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w78%2Cpublic

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w65, public

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w73, public

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w75
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w75,public

{"level":30,"time":1768516065571,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516065571,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mTenant-Level MFA Enforcement[2m > [22m[2mshould enforce MFA for tenant users when required by tenant
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w65
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w73
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w75 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w75%2Cpublic

{"level":30,"time":1768516065598,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516065603,"env":"test","module":"email-queue","jobId":"042cb363-7b33-4f1f-ac42-997960f09356","to":"existing_1768516038034@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
 [32m‚úì[39m tests/unit/workflows/conditionTruthTable.test.ts [2m([22m[2m51 tests[22m[2m)[22m[33m 2172[2mms[22m[39m
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w71.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w72.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w71.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w71.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w72.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w71.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516065644,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516065645,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768516065650,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w72.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w72.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/workflow/QueryBlock.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2054[2mms[22m[39m
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return expired invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,7949a529-d577-4e6f-a716-b005b3f8c1b7,{"after":{"invitedEmail":"existing_1768516038034@test.com","token":"677e4abb67da4e105efccd07a5e5a90062cb2b82844ef78b0cf34686497315ed"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'7949a529-d577-4e6f-a716-b005b3f8c1b7'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768516038034@test.com","token":"677e4abb67da4e105efccd07a5e5a90062cb2b82844ef78b0cf34686497315ed"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:294:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w80
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w80,public

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768516065930,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516065931,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w80 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w80%2Cpublic

 [32m‚úì[39m tests/unit/captcha.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 2105[2mms[22m[39m
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w75, public

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w75
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w73.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w65.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w73.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

{"level":30,"time":1768516066098,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516066099,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768516066105,"env":"test","module":"auth-routes","userId":"da4ffe6ea1bc5b233c12bce7478504a0","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w65.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

 [32m‚úì[39m tests/unit/components/datavault/SortableColumnHeader.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 2446[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w74
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w74,public

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould include device metadata in sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w74 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w74%2Cpublic

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516066423,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

{"level":30,"time":1768516066470,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w76
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w76,public

[90mstderr[2m | tests/integration/dynamic_options_workflow.test.ts[2m > [22m[2mDynamic Options Integration Flow
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/dynamic_options_workflow.test.ts:41:26

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w82
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w82,public

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w76 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w76%2Cpublic

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w82 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w82%2Cpublic

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w83
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w83,public

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516066752,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w83 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w83%2Cpublic

{"level":30,"time":1768516066785,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w78, public

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768516066850,"env":"test","module":"auth-routes","userId":"8d176e8f021b349541c311b49aeb7e77","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w78
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w84
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w84,public

{"level":50,"time":1768516066895,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"8d176e8f021b349541c311b49aeb7e77","login_success","security","8d176e8f021b349541c311b49aeb7e77","security","8d176e8f021b349541c311b49aeb7e77","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:46.851Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/96.0","2026-01-15T22:27:46.851Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"8d176e8f021b349541c311b49aeb7e77","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould include device metadata in sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,8d176e8f021b349541c311b49aeb7e77,login_success,security,8d176e8f021b349541c311b49aeb7e77,security,8d176e8f021b349541c311b49aeb7e77,{"metadata":{"timestamp":"2026-01-15T22:27:46.851Z"}},192.168.1.100,Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/96.0,2026-01-15T22:27:46.851Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'8d176e8f021b349541c311b49aeb7e77'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'8d176e8f021b349541c311b49aeb7e77'[39m,
    [32m'security'[39m,
    [32m'8d176e8f021b349541c311b49aeb7e77'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:46.851Z"}}'[39m,
    [32m'192.168.1.100'[39m,
    [32m'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/96.0'[39m,
    [32m'2026-01-15T22:27:46.851Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516066896,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"8d176e8f021b349541c311b49aeb7e77","login_success","security","8d176e8f021b349541c311b49aeb7e77","security","8d176e8f021b349541c311b49aeb7e77","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:46.851Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/96.0","2026-01-15T22:27:46.851Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516066902,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w75.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w75.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w84 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w84%2Cpublic

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w77
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w77,public

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w77 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w77%2Cpublic

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return accepted invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,a98b4454-3177-411a-8b02-cb2d311819c1,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'a98b4454-3177-411a-8b02-cb2d311819c1'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w79
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w79,public

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w79 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w79%2Cpublic

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w85
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w85,public

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w80, public

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516067147,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w85 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w85%2Cpublic

[90mstderr[2m | tests/unit/shared/conditionEvaluator.test.ts[2m > [22m[2mconditionEvaluator[2m > [22m[2mComparison operators[2m > [22m[2mUnknown operator[2m > [22m[2mshould default to true and log warning
[22m[39mUnknown operator: unknown_operator

{"level":30,"time":1768516067164,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516067165,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w80
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516067192,"env":"test","blockId":"b83d0949-b532-4264-927a-d797eca00413","virtualStepId":"f2c0cbd8-12e9-4f2e-b432-678c8cabbb9e","outputVar":"userList","msg":"Created read table block with virtual step"}
 [32m‚úì[39m tests/unit/shared/conditionEvaluator.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 2116[2mms[22m[39m
{"level":30,"time":1768516067222,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w78.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w78.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516067273,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516067277,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516067278,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516067293,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516067327,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516067345,"env":"test","msg":"DB: initialized flag set."}
 [31m‚ùØ[39m tests/integration/mfa.flow.real.test.ts [2m([22m[2m20 tests[22m[2m | [22m[31m9 failed[39m[2m)[22m[33m 42290[2mms[22m[39m
[31m       [31m√ó[31m should complete full MFA setup flow[39m[33m 1875[2mms[22m[39m
[31m       [31m√ó[31m should reject invalid TOTP code during setup[39m[33m 1818[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not allow MFA setup if already enabled [33m 2013[2mms[22m[39m
[31m       [31m√ó[31m should generate unique backup codes[39m[33m 1876[2mms[22m[39m
[31m       [31m√ó[31m should store hashed backup codes[39m[33m 1957[2mms[22m[39m
       [33m[2m‚úì[22m[39m should require MFA for enabled users [33m 1877[2mms[22m[39m
       [33m[2m‚úì[22m[39m should complete MFA login with valid TOTP [33m 2077[2mms[22m[39m
       [33m[2m‚úì[22m[39m should reject invalid TOTP during login [33m 2108[2mms[22m[39m
       [33m[2m‚úì[22m[39m should accept TOTP codes within 60-second window [33m 2515[2mms[22m[39m
[31m       [31m√ó[31m should login with valid backup code[39m[33m 1881[2mms[22m[39m
       [33m[2m‚úì[22m[39m should mark backup code as used [33m 1457[2mms[22m[39m
[31m       [31m√ó[31m should prevent backup code reuse[39m[33m 1867[2mms[22m[39m
       [33m[2m‚úì[22m[39m should try TOTP before backup code [33m 1932[2mms[22m[39m
[31m       [31m√ó[31m should return MFA status for user[39m[33m 1719[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return backup codes count for MFA users [33m 2108[2mms[22m[39m
[31m       [31m√ó[31m should disable MFA with password verification[39m[33m 2831[2mms[22m[39m
       [33m[2m‚úì[22m[39m should require correct password to disable MFA [33m 2650[2mms[22m[39m
       [33m[2m‚úì[22m[39m should regenerate backup codes [33m 2455[2mms[22m[39m
[31m       [31m√ó[31m should return error if MFA not enabled[39m[33m 1914[2mms[22m[39m
       [33m[2m‚úì[22m[39m should enforce MFA for tenant users when required by tenant [33m 2184[2mms[22m[39m
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516067400,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516067444,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516067489,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516067490,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/WorkflowOptimizationService.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 1961[2mms[22m[39m
{"level":30,"time":1768516067526,"env":"test","module":"email-queue","jobId":"1f8810f8-f188-4935-b97b-e3eda0e63ae6","to":"existing_1768516038034@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w74, public

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w74
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516067608,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516067609,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return accepted invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,a98b4454-3177-411a-8b02-cb2d311819c1,{"after":{"invitedEmail":"existing_1768516038034@test.com","token":"f22ab3c78ec516fd986f1064858fd60c00b87ffe7122812e790ed81bb541e81e"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'a98b4454-3177-411a-8b02-cb2d311819c1'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768516038034@test.com","token":"f22ab3c78ec516fd986f1064858fd60c00b87ffe7122812e790ed81bb541e81e"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:312:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516067623,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w81
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w81,public

 [32m‚úì[39m tests/integration/dynamic_options_workflow.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 2450[2mms[22m[39m
     [33m[2m‚úì[22m[39m should successfully configure a workflow with Read Table -> Dynamic Choice [33m 689[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w80.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w80.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w82, public

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w81 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w81%2Cpublic

{"level":30,"time":1768516067673,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w76, public

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w82
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w76
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w74.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w74.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w74.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w74.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w83, public

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516067814,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w83
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516067833,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516067845,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516067866,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w82.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w76.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w82.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516067885,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516067896,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w76.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w86
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w86,public

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

{"level":50,"time":1768516068029,"env":"test","status":401,"statusText":"Unauthorized","error":"Invalid client credentials","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":30,"time":1768516068034,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516068035,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768516068029,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768516068031,"env":"test","data":{"token_type":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768516068031,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768516068032,"env":"test","data":{"access_token":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768516068032,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768516068033,"env":"test","error":"Network error: ECONNREFUSED","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w84, public

{"level":30,"time":1768516068054,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w86 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w86%2Cpublic

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516068055,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/ui/blocks/SendDataToTableBlockEditor.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 2072[2mms[22m[39m
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w84
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/ui/datavault/TemplateCard.test.tsx [2m([22m[2m6 tests[22m[2m)[22m[33m 2158[2mms[22m[39m
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w83.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w83.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768516068140,"env":"test","error":"Invalid credentials","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768516068140,"env":"test","error":"ECONNREFUSED","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768516068142,"env":"test","status":400,"statusText":"Bad Request","error":"Invalid grant_type","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768516068142,"env":"test","error":"OAuth2 token request failed: 400 Bad Request","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768516068142,"env":"test","status":401,"statusText":"Unauthorized","error":"Client authentication failed","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768516068142,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768516068143,"env":"test","status":403,"statusText":"Forbidden","error":"Access denied","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768516068143,"env":"test","error":"OAuth2 token request failed: 403 Forbidden","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768516068143,"env":"test","status":500,"statusText":"Internal Server Error","error":"Server error","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768516068143,"env":"test","error":"OAuth2 token request failed: 500 Internal Server Error","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768516068143,"env":"test","error":"Unexpected token in JSON","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768516068144,"env":"test","error":"Request timeout","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":30,"time":1768516068145,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516068146,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/auth/oauth2.client-credentials.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 1967[2mms[22m[39m
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould not expose sensitive token data
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w79, public

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w77, public

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w85, public

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w79
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w77
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w88
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w88,public

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w85
‚è© Schema reused, skipping migrations.

{"level":40,"time":1768516068316,"env":"test","error":{},"msg":"PDF conversion failed"}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516068320,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w84.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w84.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516068321,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w84.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w84.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return accepted invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000022,organization.invite_accept,organization,a98b4454-3177-411a-8b02-cb2d311819c1,{"after":{"email":"existing_1768516038034@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000022'[39m,
    [32m'organization.invite_accept'[39m,
    [32m'organization'[39m,
    [32m'a98b4454-3177-411a-8b02-cb2d311819c1'[39m,
    [32m'{"after":{"email":"existing_1768516038034@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:318:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w88 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w88%2Cpublic

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w84.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w84.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/docxRenderer.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 1999[2mms[22m[39m
[90mstderr[2m | tests/unit/client/choice-utils.test.ts[2m > [22m[2mchoice-utils[2m > [22m[2mhandles missing content gracefully
[22m[39m[generateOptionsFromList] Invalid list data: [1mnull[22m

{"level":30,"time":1768516068390,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516068391,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/client/choice-utils.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 1919[2mms[22m[39m
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w89
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w89,public

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w89 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w89%2Cpublic

{"level":30,"time":1768516068495,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768516068557,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516068602,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"sectionCount":0,"msg":"Attempting single-shot workflow revision"}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516068604,"env":"test","module":"gemini-provider","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":812,"responseTokens":66,"durationMs":0,"estimatedCostUSD":0.00010760000000000001,"msg":"Gemini request succeeded"}
{"level":30,"time":1768516068607,"env":"test","module":"ai-service","duration":5,"workflowId":"123","changeCount":1,"msg":"AI workflow revision succeeded"}
{"level":30,"time":1768516068610,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"sectionCount":0,"msg":"Attempting single-shot workflow revision"}
{"level":30,"time":1768516068611,"env":"test","module":"gemini-provider","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":812,"responseTokens":45,"durationMs":1,"estimatedCostUSD":0.00009920000000000001,"msg":"Gemini request succeeded"}
{"level":30,"time":1768516068611,"env":"test","module":"ai-service","duration":1,"workflowId":"123","changeCount":0,"msg":"AI workflow revision succeeded"}
{"level":30,"time":1768516068612,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"sectionCount":0,"msg":"Attempting single-shot workflow revision"}
{"level":30,"time":1768516068612,"env":"test","module":"gemini-provider","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":811,"responseTokens":4,"durationMs":0,"estimatedCostUSD":0.0000827,"msg":"Gemini request succeeded"}
{"level":40,"time":1768516068613,"env":"test","module":"ai-provider","lastChar":"N","last50":"I am not JSON","msg":"Response does not end with closing brace/bracket"}
{"level":50,"time":1768516068613,"env":"test","module":"ai-service","responseLength":13,"estimatedTokens":4,"responseSuffix":"I am not JSON","msg":"Detected truncated AI response - workflow too large for single-shot revision"}
{"level":50,"time":1768516068613,"env":"test","module":"ai-service","error":{"code":"RESPONSE_TRUNCATED","estimatedTokens":4,"responseLength":13},"duration":1,"msg":"AI workflow revision failed"}
{"level":40,"time":1768516068613,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"actualOutputTokens":4,"responseLength":13,"msg":"Single-shot revision truncated - automatically retrying with chunking"}
{"level":30,"time":1768516068614,"env":"test","module":"gemini-provider","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":811,"responseTokens":4,"durationMs":0,"estimatedCostUSD":0.0000827,"msg":"Gemini request succeeded"}
{"level":40,"time":1768516068614,"env":"test","module":"ai-provider","lastChar":"N","last50":"I am not JSON","msg":"Response does not end with closing brace/bracket"}
{"level":50,"time":1768516068614,"env":"test","module":"ai-service","responseLength":13,"estimatedTokens":4,"responseSuffix":"I am not JSON","msg":"Detected truncated AI response - workflow too large for single-shot revision"}
{"level":50,"time":1768516068614,"env":"test","module":"ai-service","error":{"code":"RESPONSE_TRUNCATED","estimatedTokens":4,"responseLength":13},"duration":1,"msg":"AI workflow revision failed"}
{"level":50,"time":1768516068614,"env":"test","module":"ai-service","duration":2,"error":{"code":"RESPONSE_TRUNCATED","estimatedTokens":4,"responseLength":13},"msg":"AI workflow revision failed"}
{"level":30,"time":1768516068617,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516068617,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

 [32m‚úì[39m tests/unit/services/AIService.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1890[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768516068715,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
{"level":30,"time":1768516068716,"env":"test","module":"auth-routes","userId":"a70cda5b112095e3cffa7f2d3fc9527e","msg":"User logged in successfully"}
{"level":30,"time":1768516068715,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768516068718,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":50,"time":1768516068762,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"a70cda5b112095e3cffa7f2d3fc9527e","login_success","security","a70cda5b112095e3cffa7f2d3fc9527e","security","a70cda5b112095e3cffa7f2d3fc9527e","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:48.717Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:48.717Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"a70cda5b112095e3cffa7f2d3fc9527e","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould not expose sensitive token data
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,a70cda5b112095e3cffa7f2d3fc9527e,login_success,security,a70cda5b112095e3cffa7f2d3fc9527e,security,a70cda5b112095e3cffa7f2d3fc9527e,{"metadata":{"timestamp":"2026-01-15T22:27:48.717Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:48.717Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'a70cda5b112095e3cffa7f2d3fc9527e'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'a70cda5b112095e3cffa7f2d3fc9527e'[39m,
    [32m'security'[39m,
    [32m'a70cda5b112095e3cffa7f2d3fc9527e'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:48.717Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:48.717Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516068762,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"a70cda5b112095e3cffa7f2d3fc9527e","login_success","security","a70cda5b112095e3cffa7f2d3fc9527e","security","a70cda5b112095e3cffa7f2d3fc9527e","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:48.717Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:48.717Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768516068770,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768516068774,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
{"level":30,"time":1768516068815,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516068822,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768516068857,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
{"level":30,"time":1768516068857,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768516068858,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":40,"time":1768516068867,"env":"test","module":"metrics-routes","ip":"::ffff:127.0.0.1","msg":"Unauthorized metrics access attempt"}
{"level":30,"time":1768516068879,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516068880,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516068880,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/ui/common/Breadcrumbs.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 2249[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w81, public

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w81
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516068970,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/integration/metrics.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 2232[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w77.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w79.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w85.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w77.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516069045,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w90
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w90,public

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w79.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w90 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w90%2Cpublic

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w91
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w91,public

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w92
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w92,public

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w85.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w91 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w91%2Cpublic

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w92 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w92%2Cpublic

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516069306,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w86, public

{"level":30,"time":1768516069402,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w93
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w93,public

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w94
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w94,public

{"level":30,"time":1768516069442,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w86
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w93 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w93%2Cpublic

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w81.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w81.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w94 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w94%2Cpublic

{"level":30,"time":1768516069516,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516069548,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516069549,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w95
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w95,public

 [32m‚úì[39m tests/ui/datavault/ColumnTypeIcon.test.tsx [2m([22m[2m27 tests[22m[2m)[22m[33m 2371[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w95 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w95%2Cpublic

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould allow admin to revoke invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,bf47f70e-b29b-4810-8d88-a3d5bc31b0aa,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'bf47f70e-b29b-4810-8d88-a3d5bc31b0aa'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516069746,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516069747,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w88, public

 [32m‚úì[39m tests/integration/mfa.flow.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 2128[2mms[22m[39m
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w88
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w86.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w86.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w89, public

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w97
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w97,public

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w89
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w96
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w96,public

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w97 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w97%2Cpublic

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w88.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w88.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w96 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w96%2Cpublic

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516070073,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould track session activity timestamps
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516070101,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516070124,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516070124,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768516070132,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516070141,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/integration/intake.portal.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 2211[2mms[22m[39m
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768516070190,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516070193,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516070218,"env":"test","module":"email-queue","jobId":"bdbc9aa9-30cb-463a-a4f6-e3f368f689be","to":"existing_1768516038034@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":30,"time":1768516070227,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516070228,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/workflows/validation.test.ts [2m([22m[2m66 tests[22m[2m)[22m[33m 2161[2mms[22m[39m
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould allow admin to revoke invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,bf47f70e-b29b-4810-8d88-a3d5bc31b0aa,{"after":{"invitedEmail":"existing_1768516038034@test.com","token":"822cd1e0bd18224143d799f271d7b119803592756e73b62fdbba33fdfe61c89e"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'bf47f70e-b29b-4810-8d88-a3d5bc31b0aa'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768516038034@test.com","token":"822cd1e0bd18224143d799f271d7b119803592756e73b62fdbba33fdfe61c89e"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:328:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516070361,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516070375,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516070414,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516070438,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w90, public

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w90
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w91, public

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w92, public

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w89.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w89.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w91
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516070603,"env":"test","module":"auth-routes","userId":"53444ac8a077a9414536d168cb428051","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w92
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":50,"time":1768516070651,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"53444ac8a077a9414536d168cb428051","login_success","security","53444ac8a077a9414536d168cb428051","security","53444ac8a077a9414536d168cb428051","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:50.603Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:50.603Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"53444ac8a077a9414536d168cb428051","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould track session activity timestamps
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,53444ac8a077a9414536d168cb428051,login_success,security,53444ac8a077a9414536d168cb428051,security,53444ac8a077a9414536d168cb428051,{"metadata":{"timestamp":"2026-01-15T22:27:50.603Z"}},::ffff:127.0.0.1,,2026-01-15T22:27:50.603Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'53444ac8a077a9414536d168cb428051'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'53444ac8a077a9414536d168cb428051'[39m,
    [32m'security'[39m,
    [32m'53444ac8a077a9414536d168cb428051'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:27:50.603Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:27:50.603Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768516070651,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"53444ac8a077a9414536d168cb428051","login_success","security","53444ac8a077a9414536d168cb428051","security","53444ac8a077a9414536d168cb428051","{\"metadata\":{\"timestamp\":\"2026-01-15T22:27:50.603Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:27:50.603Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":50,"time":1768516070659,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516070752,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w93, public

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w94, public

{"level":30,"time":1768516070805,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w99
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w99,public

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w93
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516070837,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516070838,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w94
‚è© Schema reused, skipping migrations.

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould allow admin to revoke invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: 00000000-0000-0000-0000-000000000098,00000000-0000-0000-0000-000000000021,organization.invite_revoke,organization,bf47f70e-b29b-4810-8d88-a3d5bc31b0aa,{"after":{"inviteId":"4b40c843-25f0-4817-b7bf-ab497d0dbe08","email":"existing_1768516038034@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [32m'00000000-0000-0000-0000-000000000098'[39m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_revoke'[39m,
    [32m'organization'[39m,
    [32m'bf47f70e-b29b-4810-8d88-a3d5bc31b0aa'[39m,
    [32m'{"after":{"inviteId":"4b40c843-25f0-4817-b7bf-ab497d0dbe08","email":"existing_1768516038034@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.revokeInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:840:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:334:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w99 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w99%2Cpublic

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w90.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w91.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w92.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w90.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/integration/conditions/conditionEvaluation.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 2217[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516070888,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w90.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w91.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w92.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w90.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516070906,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516070907,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w91.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516070922,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516070923,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w91.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516070941,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516070943,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/unit/engine.expr.test.ts [2m([22m[2m26 tests[22m[2m)[22m[33m 2239[2mms[22m[39m
 [32m‚úì[39m tests/unit/utils/variableResolver.test.ts [2m([22m[2m20 tests[22m[2m)[22m[33m 2205[2mms[22m[39m
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w92.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w98
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w98,public

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w92.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516070998,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w98 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w98%2Cpublic

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w95, public

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w95
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mMOCK SETUP DONE. Mock questions: [
  {
    id: [32m'q1'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q1'[39m,
    order: [33m0[39m,
    isVirtual: [33mfalse[39m,
    alias: [32m'show'[39m,
    visibleIf: [1mnull[22m
  },
  {
    id: [32m'q2'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q2'[39m,
    order: [33m1[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: { op: [32m'equals'[39m, left: [36m[Object][39m, right: [36m[Object][39m }
  },
  {
    id: [32m'q3'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q3'[39m,
    order: [33m2[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: [1mnull[22m
  }
]
Calling getVisibleQuestionCount...

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mCOUNT RESULT: [33m0[39m
Mock called times: [33m1[39m
Mock last call args: [ [ [32m'section1'[39m ] ]

{"level":50,"time":1768516071224,"env":"test","module":"intake-question-visibility","error":{},"questionId":"q1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516071225,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516071226,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w100
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w100,public

{"level":30,"time":1768516071253,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516071253,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w93.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w94.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w93.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/services/intakeQuestionVisibility.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 2240[2mms[22m[39m
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w100 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w100%2Cpublic

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w97, public

 [32m‚úì[39m tests/unit/utils/conditionalLogic.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 2228[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w94.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w101
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w101,public

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w97
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w96, public

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w101 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w101%2Cpublic

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w96
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w95.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w95.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516071525,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516071526,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768516071568,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516071569,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/utils/encryption.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 2345[2mms[22m[39m
{"level":30,"time":1768516071622,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516071623,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/utils/conditionalLogic-simple.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2138[2mms[22m[39m
 [31m‚ùØ[39m tests/integration/session.management.real.test.ts [2m([22m[2m18 tests[22m[2m | [22m[31m16 failed[39m[2m)[22m[33m 46539[2mms[22m[39m
[31m       [31m√ó[31m should list all active sessions for current user[39m[33m 3535[2mms[22m[39m
[31m       [31m√ó[31m should mark current session correctly[39m[33m 2824[2mms[22m[39m
[31m       [31m√ó[31m should exclude revoked sessions[39m[33m 2837[2mms[22m[39m
[31m       [31m√ó[31m should order sessions by last used (most recent first)[39m[33m 3904[2mms[22m[39m
[31m       [31m√ó[31m should filter sessions by current user only[39m[33m 4389[2mms[22m[39m
       [32m‚úì[39m should return 401 for unauthenticated request[32m 5[2mms[22m[39m
[31m       [31m√ó[31m should revoke specific session[39m[33m 2551[2mms[22m[39m
[31m       [31m√ó[31m should prevent revoking current session[39m[33m 1782[2mms[22m[39m
[31m       [31m√ó[31m should return 404 for non-existent session[39m[33m 1824[2mms[22m[39m
[31m       [31m√ó[31m should prevent revoking other user's session[39m[33m 3453[2mms[22m[39m
[31m       [31m√ó[31m should revoke all other sessions[39m[33m 4293[2mms[22m[39m
[31m       [31m√ó[31m should keep current session active[39m[33m 2757[2mms[22m[39m
[31m       [31m√ó[31m should return 400 if no active session found[39m[33m 1875[2mms[22m[39m
       [33m[2m‚úì[22m[39m should revoke all trusted devices [33m 1868[2mms[22m[39m
[31m       [31m√ó[31m should handle user with single session gracefully[39m[33m 1867[2mms[22m[39m
[31m       [31m√ó[31m should include device metadata in sessions[39m[33m 1892[2mms[22m[39m
[31m       [31m√ó[31m should not expose sensitive token data[39m[33m 1854[2mms[22m[39m
[31m       [31m√ó[31m should track session activity timestamps[39m[33m 1853[2mms[22m[39m
{"level":30,"time":1768516071689,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516071690,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516071700,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

 [32m‚úì[39m tests/unit/engine/Performance.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2172[2mms[22m[39m
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w102
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w102,public

{"level":30,"time":1768516071762,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w102 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w102%2Cpublic

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w104
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w104,public

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w103
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w103,public

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w103 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w103%2Cpublic

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w104 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w104%2Cpublic

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516071910,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516072020,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w99, public

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w99
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516072194,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w97.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w96.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w97.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516072252,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w96.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould prevent accepting revoked invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,1755c9e5-1e88-4e1b-ab02-828b700b944c,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'1755c9e5-1e88-4e1b-ab02-828b700b944c'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516072290,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768516072348,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w105
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w105,public

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w98, public

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w105 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w105%2Cpublic

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w98
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w99.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w99.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516072521,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516072521,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/auth.routes.test.ts [2m([22m[2m41 tests[22m[2m)[22m[33m 2114[2mms[22m[39m
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w100, public

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w100
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w106
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w106,public

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w98.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w98.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w101, public

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w106 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w106%2Cpublic

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516072739,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516072742,"env":"test","warnings":["Python code does not call emit(). Script will not produce output."],"msg":"Script validation warnings"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516072744,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516072745,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w101
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516072763,"env":"test","module":"email-queue","jobId":"c8c7c320-f32d-4a15-92e4-6b3c3d41310e","to":"existing_1768516038034@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w109
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w109,public

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w107
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w107,public

 [32m‚úì[39m tests/unit/ScriptEngine.test.ts [2m([22m[2m26 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[33m 2177[2mms[22m[39m
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w100.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w100.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516072811,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516072819,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w109 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w109%2Cpublic

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w108
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w108,public

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w107 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w107%2Cpublic

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516072853,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould prevent accepting revoked invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,1755c9e5-1e88-4e1b-ab02-828b700b944c,{"after":{"invitedEmail":"existing_1768516038034@test.com","token":"7c7edadf92f940bee0ebf05ae7fd3f0e874aba40f0ca2474fe2eaf7910e32f35"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'1755c9e5-1e88-4e1b-ab02-828b700b944c'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768516038034@test.com","token":"7c7edadf92f940bee0ebf05ae7fd3f0e874aba40f0ca2474fe2eaf7910e32f35"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:344:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w108 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w108%2Cpublic

{"level":30,"time":1768516072898,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516072918,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516072954,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516072955,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/repeater.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 2111[2mms[22m[39m
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w110
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w110,public

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

{"level":40,"time":1768516073066,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w110 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w110%2Cpublic

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768516073081,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768516073084,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768516073084,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768516073084,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768516073085,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768516073085,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768516073090,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768516073094,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768516073094,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768516073094,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768516073097,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768516073099,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
{"level":30,"time":1768516073100,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516073100,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/middleware/auth.middleware.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 2191[2mms[22m[39m
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w102, public

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w102
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w103, public

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w101.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w101.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w104, public

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w103
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w104
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516073349,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w102.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w102.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould prevent accepting revoked invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: 00000000-0000-0000-0000-000000000098,00000000-0000-0000-0000-000000000021,organization.invite_revoke,organization,1755c9e5-1e88-4e1b-ab02-828b700b944c,{"after":{"inviteId":"b06a460a-1eae-4f20-8d55-bee6934818e0","email":"existing_1768516038034@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [32m'00000000-0000-0000-0000-000000000098'[39m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_revoke'[39m,
    [32m'organization'[39m,
    [32m'1755c9e5-1e88-4e1b-ab02-828b700b944c'[39m,
    [32m'{"after":{"inviteId":"b06a460a-1eae-4f20-8d55-bee6934818e0","email":"existing_1768516038034@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.revokeInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:840:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:350:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768516073411,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516073513,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516073513,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

 [32m‚úì[39m tests/unit/WorkflowChangeAnalyzer.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 2177[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w111
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w111,public

{"level":30,"time":1768516073595,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516073595,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w111 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w111%2Cpublic

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516073632,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516073632,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768516073634,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/unit/client/list-choice-options.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 2178[2mms[22m[39m
 [32m‚úì[39m tests/integration/session.management.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 2220[2mms[22m[39m
{"level":30,"time":1768516073705,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516073757,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w105, public

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516073823,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w105
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516073844,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516073876,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w103.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w104.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w103.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w104.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w113
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w113,public

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516073950,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w113 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w113%2Cpublic

{"level":30,"time":1768516074004,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516074029,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w106, public

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516074093,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516074093,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w106
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/integration/organizationInvites.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 36052[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create placeholder user for non-existent email [33m 1952[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create invite for existing user without creating placeholder [33m 2241[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent duplicate pending invites [33m 2064[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent inviting existing members [33m 1291[2mms[22m[39m
       [33m[2m‚úì[22m[39m should require admin access to create invite [33m 1003[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set expiry to 7 days from now [33m 1881[2mms[22m[39m
       [33m[2m‚úì[22m[39m should accept invite and create membership [33m 2662[2mms[22m[39m
       [33m[2m‚úì[22m[39m should convert placeholder user to real user on accept [33m 2709[2mms[22m[39m
       [33m[2m‚úì[22m[39m should reject expired invite [33m 1975[2mms[22m[39m
       [33m[2m‚úì[22m[39m should reject already accepted invite [33m 2539[2mms[22m[39m
       [33m[2m‚úì[22m[39m should verify email matches invite [33m 1869[2mms[22m[39m
       [33m[2m‚úì[22m[39m should reject invalid token [33m 1047[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return pending invites for user email [33m 1879[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not return expired invites [33m 1909[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not return accepted invites [33m 2628[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to revoke invite [33m 2624[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent accepting revoked invite [33m 2524[2mms[22m[39m
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w105.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w105.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768516074183,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768516074183,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating skipIf condition"}
{"level":30,"time":1768516074185,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516074186,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w107, public

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w108, public

 [32m‚úì[39m tests/unit/services/intakeNavigation.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2279[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w107
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w109, public

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w108
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w106.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w106.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w109
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w106.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w106.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w110, public

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w110
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w107.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w108.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w107.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516074460,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516074461,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w114
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w114,public

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w108.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w114 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w114%2Cpublic

{"level":30,"time":1768516074548,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516074549,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/HelperLibrary.test.ts [2m([22m[2m60 tests[22m[2m)[22m[33m 2263[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516074592,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516074592,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/api.ai.test.ts [2m([22m[2m32 tests[22m[2m)[22m[33m 2170[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516074617,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/shared/validation/stepConfigSchemas.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 2162[2mms[22m[39m
 [32m‚úì[39m tests/unit/BlockRunner.validate.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 2234[2mms[22m[39m
{"level":30,"time":1768516074680,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":40,"time":1768516074760,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w112
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w112,public

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":40,"time":1768516074777,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768516074780,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768516074784,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768516074790,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":30,"time":1768516074803,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516074803,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w112 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w112%2Cpublic

{"level":30,"time":1768516074822,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/unit/isolatedVmBridge.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 2169[2mms[22m[39m
{"level":30,"time":1768516074874,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w111, public

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w111
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w109.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w110.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w109.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516075144,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w110.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w112, public

{"level":30,"time":1768516075231,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w112
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w111.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w111.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768516075459,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516075460,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/shared/validation/PageValidator.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2321[2mms[22m[39m
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts[2m > [22m[2mDatavaultColumnsService[2m > [22m[2mgetColumns[2m > [22m[2mshould throw 404 if table not found
[22m[39m[DEBUG] Table not found: 660e8400-e29b-41d4-a716-446655440001

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w113, public

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516075621,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w113
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516075664,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516075665,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768516075677,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w112.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w112.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/services/DatavaultColumnsService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1296[2mms[22m[39m
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516075945,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516075946,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/ui/blocks/SendDataBlockEditorRouting.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 2395[2mms[22m[39m
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w114, public

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w114
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w113.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w113.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w115
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w115,public

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w115 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w115%2Cpublic

{"level":30,"time":1768516076241,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516076293,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w118
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w118,public

{"level":30,"time":1768516076361,"env":"test","module":"workflow-quality-validator","overall":99,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"issuesCount":1,"passed":true,"msg":"Workflow quality validation completed"}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w118 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w118%2Cpublic

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516076362,"env":"test","module":"ai-service","duration":6,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":99,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":1,"msg":"AI workflow generation succeeded"}
{"level":50,"time":1768516076369,"env":"test","module":"ai-service","error":{"code":"VALIDATION_ERROR","troubleshooting":"üîß Troubleshooting Steps:\n1. The AI response structure doesn't match our expected format\n2. This may indicate:\n   - A breaking change in the AI model behavior\n   - The model is struggling with the complexity of the request\n3. Try simplifying your workflow or request\n4. If this persists, please report this issue with the workflow details"},"duration":3,"msg":"AI workflow generation failed"}
{"level":50,"time":1768516076374,"env":"test","module":"ai-service","error":{"code":"VALIDATION_ERROR","troubleshooting":"üîß Troubleshooting Steps:\n1. The AI response structure doesn't match our expected format\n2. This may indicate:\n   - A breaking change in the AI model behavior\n   - The model is struggling with the complexity of the request\n3. Try simplifying your workflow or request\n4. If this persists, please report this issue with the workflow details"},"duration":1,"msg":"AI workflow generation failed"}
{"level":50,"time":1768516076377,"env":"test","module":"ai-service","error":{"code":"VALIDATION_ERROR","troubleshooting":"üîß Troubleshooting Steps:\n1. The AI response structure doesn't match our expected format\n2. This may indicate:\n   - A breaking change in the AI model behavior\n   - The model is struggling with the complexity of the request\n3. Try simplifying your workflow or request\n4. If this persists, please report this issue with the workflow details"},"duration":0,"msg":"AI workflow generation failed"}
{"level":40,"time":1768516076383,"env":"test","module":"ai-service","attempt":0,"retryAfter":1000,"error":"Rate limit exceeded","msg":"Retrying AI request..."}
{"level":40,"time":1768516076383,"env":"test","module":"ai-service","attempt":1,"retryAfter":2000,"error":"Rate limit exceeded","msg":"Retrying AI request..."}
{"level":40,"time":1768516076383,"env":"test","module":"ai-service","attempt":2,"retryAfter":4000,"error":"Rate limit exceeded","msg":"Retrying AI request..."}
{"level":50,"time":1768516076383,"env":"test","module":"ai-service","event":"ai_request_failed","provider":"openai","model":"gpt-4-turbo-preview","taskType":"workflow_generation","errorType":"RATE_LIMIT","durationMs":2,"attempts":4,"msg":"AI request failed: rate limit"}
{"level":50,"time":1768516076383,"env":"test","module":"ai-service","error":{"code":"RATE_LIMIT","details":{"originalError":"Rate limit exceeded","retryAfterSeconds":60},"troubleshooting":"üîß Troubleshooting Steps:\n1. You've hit the AI provider's rate limit\n2. Solutions:\n   - Wait 60 seconds and try again\n   - Check your API key quota at your provider's dashboard\n   - Consider upgrading your API plan for higher limits\n   - If using free tier, you may need to wait until limits reset"},"duration":2,"msg":"AI workflow generation failed"}
{"level":50,"time":1768516076388,"env":"test","module":"ai-service","error":{},"duration":0,"msg":"AI workflow generation failed"}
{"level":30,"time":1768516076396,"env":"test","module":"workflow-quality-validator","overall":100,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"issuesCount":0,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768516076397,"env":"test","module":"ai-service","duration":1,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":100,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":0,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768516076400,"env":"test","module":"workflow-quality-validator","overall":96,"breakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"issuesCount":2,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768516076400,"env":"test","module":"ai-service","duration":1,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":96,"qualityBreakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"qualityPassed":true,"issuesCount":2,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768516076410,"env":"test","module":"ai-service","duration":1,"suggestionsCount":1,"msg":"AI binding suggestion succeeded"}
{"level":30,"time":1768516076411,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516076411,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516076422,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/unit/ai.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 2322[2mms[22m[39m
{"level":30,"time":1768516076479,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w119
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w119,public

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w119 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w119%2Cpublic

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516076546,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516076591,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w116
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w116,public

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w115, public

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w116 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w116%2Cpublic

{"level":30,"time":1768516076648,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w115
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516076701,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w114.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w114.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w121
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w121,public

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w126
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w126,public

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w120
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w120,public

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w121 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w121%2Cpublic

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w126 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w126%2Cpublic

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w118, public

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w120 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w120%2Cpublic

{"level":30,"time":1768516076871,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w118
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516076918,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w119, public

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w115.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w115.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

{"level":30,"time":1768516076987,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w119
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516077022,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","msg":"AI workflow revision job enqueued"}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":30,"time":1768516077035,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":50,"time":1768516077043,"env":"test","module":"ai-controller","error":{"issues":[{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["workflowId"]},{"code":"invalid_type","expected":"object","received":"undefined","path":["currentWorkflow"],"message":"Required"},{"code":"invalid_type","expected":"string","received":"undefined","path":["userInstruction"],"message":"Required"}],"name":"ZodError"},"msg":"Failed to enqueue AI revision job"}
{"level":30,"time":1768516077046,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w123
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w123,public

{"level":30,"time":1768516077047,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w116, public

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w123 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w123%2Cpublic

{"level":30,"time":1768516077098,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w116
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w124
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w124,public

 [32m‚úì[39m tests/unit/api.ai.revise.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 1298[2mms[22m[39m
{"level":30,"time":1768516077144,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w118.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w119.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w118.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ListTools.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w124 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w124%2Cpublic

{"level":30,"time":1768516077162,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w119.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516077211,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516077276,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516077277,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w120, public

{"level":30,"time":1768516077303,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516077304,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/schema/collections.test.ts [2m([22m[2m34 tests[22m[2m)[22m[33m 1342[2mms[22m[39m
 [32m‚úì[39m tests/services/EmailTemplateMetadataService.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 1277[2mms[22m[39m
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w120
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w117
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w117,public

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w116.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w116.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w122
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w122,public

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w117 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w117%2Cpublic

{"level":30,"time":1768516077442,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516077466,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516077470,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w122 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w122%2Cpublic

{"level":30,"time":1768516077480,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w123, public

{"level":30,"time":1768516077515,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516077535,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w123
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w124, public

 [32m‚úì[39m tests/integration/branding.routes.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 1275[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w120.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w120.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w124
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768516077641,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516077642,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mDEBUG: Existing functions: []

 [32m‚úì[39m tests/unit/lib/queries/QueryRunner.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 1225[2mms[22m[39m
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w125
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w125,public

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w125 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w125%2Cpublic

{"level":30,"time":1768516077726,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516077777,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w122, public

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w117, public

{"level":30,"time":1768516077891,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516077892,"env":"test","workflowId":"123e4567-e89b-12d3-a456-426614174000","userId":"user-123","sectionsCount":2,"stepsCount":0,"logicRulesCount":1,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768516077892,"env":"test","msg":"DB: pool closed."}
{"level":40,"time":1768516077908,"env":"test","sourceListVar":"nonexistent_list","inputKey":"nonexistent_list","msg":"Input list not found, treating as empty array"}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w122
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/ListTools.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516077909,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516077913,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w117
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/unit/services/CollectionFieldService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 1251[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w123.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w124.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w123.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/ListTools.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 1198[2mms[22m[39m
 [32m‚úì[39m tests/unit/services/WorkflowService.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 1509[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return workflow if user is the creator [33m 1018[2mms[22m[39m
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w123.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w124.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w123.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w124.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w124.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w125, public

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w125
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w122.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w117.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w122.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516078244,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516078245,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w117.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/services/MfaService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 1845[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould skip question when condition is false
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute question when condition is true
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: true. Context keys: 4

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute question when condition is true
[22m[39m[DEBUG Question] Node q2 executed. Key: code, Value: ABC123. Context keys: 5

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould skip compute node when condition is false
[22m[39m[DEBUG Question] Node q1 executed. Key: amount, Value: 0. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute compute node when condition is true
[22m[39m[DEBUG Question] Node q1 executed. Key: amount, Value: 100. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould handle complex workflow with multiple conditions
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 4

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould handle complex workflow with multiple conditions
[22m[39m[DEBUG Question] Node q3 executed. Key: amount, Value: 1000. Context keys: 5

 [32m‚úì[39m tests/integration/datavault.api-tokens.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 1206[2mms[22m[39m
[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mDebug Mode[2m > [22m[2mshould return trace when debug is enabled
[22m[39m[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

{"level":30,"time":1768516078392,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516078392,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mDebug Mode[2m > [22m[2mshould not return trace when debug is disabled
[22m[39m[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w128
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w128,public

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w128 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w128%2Cpublic

{"level":30,"time":1768516078517,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516078518,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/engine.run-conditions.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 1407[2mms[22m[39m
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516078524,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/unit/services/StepService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1227[2mms[22m[39m
{"level":30,"time":1768516078573,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w128, public

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w128
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w125.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w125.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w129
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w129,public

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w129 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w129%2Cpublic

{"level":30,"time":1768516079225,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516079280,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516079302,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516079303,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

 [32m‚úì[39m tests/unit/schema/documentEngine.test.ts [2m([22m[2m33 tests[22m[2m)[22m[33m 1279[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w131
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w131,public

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w131 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w131%2Cpublic

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w130
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w130,public

{"level":30,"time":1768516079442,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w130 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w130%2Cpublic

{"level":30,"time":1768516079493,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516079499,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w127
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w127,public

{"level":30,"time":1768516079549,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w127 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w127%2Cpublic

{"level":30,"time":1768516079581,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w129, public

{"level":30,"time":1768516079636,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w132
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w132,public

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w129
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w132 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w132%2Cpublic

{"level":30,"time":1768516079710,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w128.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w128.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516079758,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w131, public

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w133
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w133,public

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w130, public

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w131
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w133 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w133%2Cpublic

{"level":30,"time":1768516079925,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w129.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w129.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w130
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516079978,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768516079982,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516079983,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w127, public

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w129.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w129.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/services/DataSourceService.test.ts [2m([22m[2m9 tests[22m[2m)[22m[33m 1272[2mms[22m[39m
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w127
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w131.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w131.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w132, public

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w135
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w135,public

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w132
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w87
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w87,public

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w135 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w135%2Cpublic

{"level":30,"time":1768516080193,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w127.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w130.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w127.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516080219,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516080220,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w87 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w87%2Cpublic

{"level":30,"time":1768516080238,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516080246,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w130.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/services/CollectionService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1227[2mms[22m[39m
{"level":30,"time":1768516080269,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516080270,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768516080293,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w134
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w134,public

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

 [32m‚úì[39m tests/unit/services/RecordService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1245[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w133, public

[90mstderr[2m | tests/unit/debugging/Lineage.test.ts[2m > [22m[2mDebug & Lineage[2m > [22m[2mshould generate execution trace with lineage
[22m[39m[DEBUG Question] Node q1 executed. Key: userName, Value: Alice. Context keys: 3

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w134 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w134%2Cpublic

{"level":30,"time":1768516080360,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516080360,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516080361,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w137
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w137,public

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w133
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516080411,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w137 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w137%2Cpublic

{"level":30,"time":1768516080422,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w132.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w132.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768516080474,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/unit/debugging/Lineage.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 1230[2mms[22m[39m
{"level":30,"time":1768516080516,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516080517,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/repositories/DocumentTemplateRepository.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 1281[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w135, public

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w135
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w87, public

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w133.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w133.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w87
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516080709,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516080710,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w139
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w139,public

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w134, public

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w139 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w139%2Cpublic

{"level":30,"time":1768516080765,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/unit/repositories/DatavaultColumnsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 1259[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w134
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768516080816,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w137, public

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w135.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w87.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w135.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w137
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w87.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w87.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w87.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516080939,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516080939,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/repositories/DatavaultTablesRepository.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 1205[2mms[22m[39m
{"level":30,"time":1768516080989,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts[2m > [22m[2mPersonalization API Integration Tests
[22m[39müìö API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768516080999,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768516081000,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768516081006,"env":"test","module":"documents-routes","msg":"Document routes registered"}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768516081170,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516081171,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w139, public

{"level":30,"time":1768516081194,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516081195,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/DocumentTemplateService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1259[2mms[22m[39m
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w139
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/unit/services/DatavaultTablesService.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 1196[2mms[22m[39m
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w134.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w137.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w134.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w137.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516081529,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768516081530,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768516081581,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516081582,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/services/BrandingService.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 1263[2mms[22m[39m
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w136
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w136,public

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w136 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w136%2Cpublic

{"level":30,"time":1768516081738,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516081795,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

 [32m‚úì[39m tests/integration/api.ai.personalization.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1726[2mms[22m[39m
[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w142
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w142,public

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w146
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w146,public

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w148
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w148,public

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w142 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w142%2Cpublic

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w146 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w146%2Cpublic

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w148 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w148%2Cpublic

[90mstderr[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17[90m)[39m
    at Object.get [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:144:34
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m {
  codeFrame: [32m'vi.mock(import("../../../server/db"), async (importOriginal) => {\n'[39m +
    [32m'  const actual = await importOriginal()\n'[39m +
    [32m'  return {\n'[39m +
    [32m'    ...actual,\n'[39m +
    [32m'    // your mocked methods\n'[39m +
    [32m'  }\n'[39m +
    [32m'})'[39m
}

{"level":30,"time":1768516082036,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[{"columnId":"col-first","value":"{{ firstName }}"},{"columnId":"col-last","value":"Doe"},{"columnId":"col-age","value":"{{ age }}"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":30,"time":1768516082045,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[]},"tableId":"table-users","preview":true,"msg":"Starting write execution"}
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516082045,"env":"test","module":"write-runner","operation":"write_preview_simulated","values":{},"msg":"Simulating write in preview mode"}
{"level":30,"time":1768516082047,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"test@example.com","columnMappings":[{"columnId":"col-status","value":"Active"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":30,"time":1768516082048,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":50,"time":1768516082048,"env":"test","module":"write-runner","error":{},"config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"msg":"Write execution failed"}
 [32m‚úì[39m tests/unit/services/Guardrail.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 463[2mms[22m[39m
 [32m‚úì[39m tests/unit/writes/WriteRunner.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 457[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w136, public

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w136
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/unit/services/PortalAuthService.test.ts [2m([22m[2m42 tests[22m[2m)[22m[33m 646[2mms[22m[39m
[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w144
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w144,public

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w139.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w139.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w143
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w143,public

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w144 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w144%2Cpublic

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w143 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w143%2Cpublic

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/BrandingService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 483[2mms[22m[39m
 [32m‚úì[39m tests/unit/repositories/DatavaultRowsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 481[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w145
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w145,public

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w145 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w145%2Cpublic

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516082490,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516082491,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/AccountLockoutService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 458[2mms[22m[39m
 [32m‚úì[39m tests/unit/workflow/PreviewExecution.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1202[2mms[22m[39m
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w138
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w138,public

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w138 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w138%2Cpublic

{"level":30,"time":1768516083120,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w152
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w152,public

{"level":30,"time":1768516083179,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w152 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w152%2Cpublic

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":30,"time":1768516083223,"env":"test","msg":"External Send Completed","destination":"My Webhook","success":true,"status":200}
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516083229,"env":"test","msg":"Simulating External Send","destination":"Test","payload":{}}
[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w147
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w147,public

 [32m‚úì[39m tests/unit/external/ExternalSendRunner.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 471[2mms[22m[39m
[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w150
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w150,public

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w147 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w147%2Cpublic

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":40,"time":1768516083306,"env":"test","hookId":"hook-1","hookName":"Hook 1","error":"Test error","msg":"LifecycleHookService: Hook execution failed"}
[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w150 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w150%2Cpublic

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768516083312,"env":"test","error":{},"workflowId":"workflow-1","runId":"run-1","phase":"beforePage","msg":"LifecycleHookService: Failed to execute hooks for phase"}
{"level":30,"time":1768516083316,"env":"test","hookId":"hook-1","workflowId":"workflow-1","phase":"beforePage","msg":"LifecycleHookService: Created lifecycle hook"}
{"level":30,"time":1768516083325,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Updated lifecycle hook"}
{"level":30,"time":1768516083327,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Deleted lifecycle hook"}
[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/LifecycleHookService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 489[2mms[22m[39m
 [32m‚úì[39m tests/unit/services/EmailTemplateMetadataService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 473[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w149
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w149,public

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w149 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w149%2Cpublic

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w138, public

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/DatavaultRowsService.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 447[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w138
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w151
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w151,public

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w136.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w136.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w151 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w151%2Cpublic

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w141
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w141,public

 [32m‚úì[39m tests/unit/services/DatavaultReferenceColumns.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 433[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w141 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w141%2Cpublic

{"level":30,"time":1768516083717,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768516083765,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w153
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w153,public

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w154
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w154,public

{"level":30,"time":1768516083850,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516083851,"env":"test","msg":"DB: pool closed."}
 [2m[90m‚Üì[39m[22m tests/unit/collab.server.test.ts [2m([22m[2m14 tests[22m[2m | [22m[33m14 skipped[39m[2m)[22m
[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w153 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w153%2Cpublic

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w154 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w154%2Cpublic

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/AuditLogService.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 426[2mms[22m[39m
 [32m‚úì[39m tests/unit/engine/FinalBlockSnapshot.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 431[2mms[22m[39m
{"level":30,"time":1768516083959,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
 [32m‚úì[39m tests/integration/datavault.row-notes.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 1185[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w141, public

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w141
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w138.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w138.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516084418,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516084419,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/datavault.routes.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 1136[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w140
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w140,public

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w140 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w140%2Cpublic

{"level":30,"time":1768516085569,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768516085604,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w140, public

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w140
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w141.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w141.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768516086258,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768516086276,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts[2m > [22m[2mAI Document Assistant API Integration Tests
[22m[39müìö API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768516086265,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768516086265,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768516086270,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768516086275,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768516086275,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768516086275,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768516086275,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":40,"time":1768516086294,"env":"test","error":{},"msg":"Deterministic DOCX extraction failed"}
{"level":30,"time":1768516086328,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768516086328,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/api.ai.doc.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 1168[2mms[22m[39m

[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m[1m[41m Failed Suites 21 [49m[22m[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m

[41m[1m FAIL [22m[49m tests/integration/api.dataSources.native.test.ts[2m [ tests/integration/api.dataSources.native.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.expression-validation.test.ts[2m [ tests/integration/api.expression-validation.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.projects.test.ts[2m [ tests/integration/api.projects.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.runs.docx.test.ts[2m [ tests/integration/api.runs.docx.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.runs.graph.test.ts[2m [ tests/integration/api.runs.graph.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.snapshots.test.ts[2m [ tests/integration/api.snapshots.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.templates-runs.test.ts[2m [ tests/integration/api.templates-runs.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.workflows.test.ts[2m [ tests/integration/api.workflows.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/datavault-v4-regression.test.ts[2m [ tests/integration/datavault-v4-regression.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/datavault.permissions.test.ts[2m [ tests/integration/datavault.permissions.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/intake.workflow.test.ts[2m [ tests/integration/intake.workflow.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/js_helpers.test.ts[2m [ tests/integration/js_helpers.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/lifecycle-hooks-execution.test.ts[2m [ tests/integration/lifecycle-hooks-execution.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m [ tests/integration/auth/auth.middleware.integration.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/auth/jwt.authentication.test.ts[2m [ tests/integration/auth/jwt.authentication.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/auth/protected.routes.test.ts[2m [ tests/integration/auth/protected.routes.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/auth/session.management.integration.test.ts[2m [ tests/integration/auth/session.management.integration.test.ts ][22m
[31m[1mTypeError[22m: () => ({
      getGenerativeModel: __vite_ssr_import_0__.vi.fn().mockReturnValue({
        generateContent: __v...<omitted>...}) is not a constructor[39m
[36m [2m‚ùØ[22m new DocumentAIAssistService server/lib/ai/DocumentAIAssistService.ts:[2m43:26[22m[39m
    [90m 41| [39m        [35mconst[39m apiKey [33m=[39m process[33m.[39menv[33m.[39m[33mGEMINI_API_KEY[39m[33m;[39m
    [90m 42| [39m        [35mif[39m (apiKey) {
    [90m 43| [39m            [35mthis[39m[33m.[39mgenAI [33m=[39m [35mnew[39m [33mGoogleGenerativeAI[39m(apiKey)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m 44| [39m            const model = process.env.GEMINI_MODEL || "gemini-2.0-flas‚Ä¶
    [90m 45| [39m            [35mthis[39m[33m.[39mmodel [33m=[39m [35mthis[39m[33m.[39mgenAI[33m.[39m[34mgetGenerativeModel[39m({ model })[33m;[39m
[90m [2m‚ùØ[22m server/lib/ai/DocumentAIAssistService.ts:[2m258:40[22m[39m
[90m [2m‚ùØ[22m server/routes/ai.doc.routes.ts:[2m5:1[22m[39m
[90m [2m‚ùØ[22m server/routes/index.ts:[2m9:1[22m[39m
[90m [2m‚ùØ[22m server/routes.ts:[2m11:1[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[1/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, default, $7, $8, $9, default, default, $10, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: test-user-collections-e2e,test-collections-e2e@example.com,Collections E2E Test User,Collections,E2E Test User,0f3e208f-bafb-44cd-94ac-b92acb2c4572,owner,local,easy,[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m34:20[22m[39m
    [90m 32| [39m
    [90m 33| [39m    [90m// Create test user[39m
    [90m 34| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 35| [39m      id[33m:[39m [32m'test-user-collections-e2e'[39m[33m,[39m
    [90m 36| [39m      email[33m:[39m [32m'test-collections-e2e@example.com'[39m[33m,[39m

[31m[1mCaused by: error[22m: duplicate key value violates unique constraint "users_pkey"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m34:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 204, severity: 'ERROR', code: '23505', detail: 'Key (id)=(test-user-collections-e2e) already exists.', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_pkey', file: 'nbtinsert.c', routine: '_bt_check_unique' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[2/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/workflow_versioning.test.ts[2m > [22mWorkflow Versioning & Lineage
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, default, $2, $3, default, default, default, default, default, default, default, default, default, default, default, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Versioning Test Workflow,11e5587b-915f-4058-9988-6bb4d0185128,11e5587b-915f-4058-9988-6bb4d0185128[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/workflow_versioning.test.ts:[2m48:28[22m[39m
    [90m 46| [39m
    [90m 47| [39m        [90m// Create Workflow[39m
    [90m 48| [39m        [35mconst[39m [workflow] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m                           [31m^[39m
    [90m 49| [39m
    [90m 50| [39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/workflow_versioning.test.ts:[2m48:28[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 474, severity: 'ERROR', code: '23502', detail: 'Failing row contains (5372d20b-8023-49f5-9c6c-a9ea33eb2798, Versioning Test Workflow, null, 11e5587b-915f-4058-9988-6bb4d0185128, null, 2026-01-15 22:27:09.429953, 2026-01-15 22:27:09.429953, 11e5587b-915f-4058-9988-6bb4d0185128, null, null, null, null, null, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[3/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/api.ai.logic.test.ts[2m [ tests/unit/api.ai.logic.test.ts ][22m
[41m[1m FAIL [22m[49m tests/unit/debug_import.test.ts[2m [ tests/unit/debug_import.test.ts ][22m
[31m[1mTypeError[22m: () => ({
      getGenerativeModel: __vite_ssr_import_0__.vi.fn().mockReturnValue({
        generateContent: __v...<omitted>...}) is not a constructor[39m
[36m [2m‚ùØ[22m new GeminiService server/services/geminiService.ts:[2m27:18[22m[39m
    [90m 25| [39m    }
    [90m 26| [39m
    [90m 27| [39m    [35mthis[39m[33m.[39mgenAI [33m=[39m [35mnew[39m [33mGoogleGenerativeAI[39m(apiKey)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m 28| [39m    // Use configurable Gemini model from env, fallback to gemini-2.0-‚Ä¶
    [90m 29| [39m    [35mconst[39m model [33m=[39m process[33m.[39menv[33m.[39m[33mGEMINI_MODEL[39m [33m||[39m [32m"gemini-2.0-flash"[39m[33m;[39m
[90m [2m‚ùØ[22m server/services/geminiService.ts:[2m299:30[22m[39m
[90m [2m‚ùØ[22m server/controllers/AiController.ts:[2m16:1[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[4/90]‚éØ[22m[39m


[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m[1m[41m Failed Tests 69 [49m[22m[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m

[41m[1m FAIL [22m[49m tests/integration/analytics_preservation.test.ts[2m > [22mAnalytics Preservation[2m > [22mshould preserve lifetime user count when a user is deleted
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')[39m
[90m [2m‚ùØ[22m getTableColumns node_modules/drizzle-orm/utils.js:[2m109:15[22m[39m
[90m [2m‚ùØ[22m PgSelectBuilder.from node_modules/drizzle-orm/pg-core/query-builders/select.js:[2m62:16[22m[39m
[36m [2m‚ùØ[22m SystemStatsRepository.getOrInitialize server/repositories/SystemStatsRepository.ts:[2m18:35[22m[39m
    [90m 16| [39m   */[39m
    [90m 17| [39m  [35masync[39m [34mgetOrInitialize[39m()[33m:[39m [33mPromise[39m[33m<[39m[33mSystemStats[39m[33m>[39m {
    [90m 18| [39m    let stats = await db.select().from(systemStats).where(eq(systemSta‚Ä¶
    [90m   | [39m                                  [31m^[39m
    [90m 19| [39m
    [90m 20| [39m    [35mif[39m (stats[33m.[39mlength [33m===[39m [34m0[39m) {
[90m [2m‚ùØ[22m SystemStatsRepository.getStats server/repositories/SystemStatsRepository.ts:[2m133:17[22m[39m
[90m [2m‚ùØ[22m tests/integration/analytics_preservation.test.ts:[2m18:58[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[5/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mComplete Registration ‚Üí Login Flow[2m > [22mshould complete registration, verify email, then login
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m97:36[22m[39m
    [90m 95| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password })[33m;[39m
    [90m 96| [39m
    [90m 97| [39m      [34mexpect[39m(loginAttempt2[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m 98| [39m      [34mexpect[39m(loginAttempt2[33m.[39mbody[33m.[39mtoken)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m 99| [39m      [34mexpect[39m(loginAttempt2[33m.[39mbody[33m.[39muser[33m.[39memailVerified)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[6/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mMFA Enrollment and Login Flow[2m > [22mshould complete MFA setup and login with TOTP
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m197:36[22m[39m
    [90m195| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m196| [39m
    [90m197| [39m      [34mexpect[39m(setupResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m198| [39m      [34mexpect[39m(setupResponse[33m.[39mbody[33m.[39mqrCodeDataUrl)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m199| [39m      [34mexpect[39m(setupResponse[33m.[39mbody[33m.[39mbackupCodes)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[7/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mMFA Enrollment and Login Flow[2m > [22mshould login with backup code when TOTP unavailable
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'secret')[39m
[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m279:52[22m[39m
    [90m277| [39m      })[33m;[39m
    [90m278| [39m
    [90m279| [39m      [35mconst[39m totpCode [33m=[39m [34mgenerateTotpCode[39m(mfaSecret[33m![39m[33m.[39msecret)[33m;[39m
    [90m   | [39m                                                   [31m^[39m
    [90m280| [39m
    [90m281| [39m      [35mawait[39m [34mrequest[39m(app)

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[8/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mPassword Reset Flow[2m > [22mshould complete full password reset flow
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m364:36[22m[39m
    [90m362| [39m        })[33m;[39m
    [90m363| [39m
    [90m364| [39m      [34mexpect[39m(resetResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m365| [39m
    [90m366| [39m      [90m// Step 4: Verify old password no longer works[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[9/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mSession Management Flow[2m > [22mshould list all active sessions
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m528:39[22m[39m
    [90m526| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m527| [39m
    [90m528| [39m      [34mexpect[39m(sessionsResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                      [31m^[39m
    [90m529| [39m      [34mexpect[39m(sessionsResponse[33m.[39mbody[33m.[39msessions)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m530| [39m      expect(sessionsResponse.body.sessions.length).toBeGreaterThanOrE‚Ä¶

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[10/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mSession Management Flow[2m > [22mshould revoke specific session
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m554:40[22m[39m
    [90m552| [39m
    [90m553| [39m      [35mconst[39m sessions [33m=[39m sessionsResponse[33m.[39mbody[33m.[39msessions[33m;[39m
    [90m554| [39m      [35mconst[39m sessionToRevoke [33m=[39m sessions[33m.[39m[34mfind[39m((s[33m:[39m any) [33m=>[39m [33m![39ms[33m.[39mcurrent)[33m;[39m
    [90m   | [39m                                       [31m^[39m
    [90m555| [39m
    [90m556| [39m      [90m// Revoke first session[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[11/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould login with valid credentials
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m171:31[22m[39m
    [90m169| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password })[33m;[39m
    [90m170| [39m
    [90m171| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m172| [39m      [34mexpect[39m((response[33m.[39mbody)[33m.[39mmessage)[33m.[39m[34mtoBe[39m([32m"Login successful"[39m)[33m;[39m
    [90m173| [39m      [34mexpect[39m((response[33m.[39mbody)[33m.[39mtoken)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[12/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/reset-password[2m > [22mshould reset password with valid token
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m439:31[22m[39m
    [90m437| [39m        })[33m;[39m
    [90m438| [39m
    [90m439| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m440| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"Password updated"[39m)[33m;[39m
    [90m441| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[13/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mGET /api/auth/me[2m > [22mshould return current user for valid token
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m500:31[22m[39m
    [90m498| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m499| [39m
    [90m500| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m501| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39memail)[33m.[39m[34mtoBe[39m(email)[33m;[39m
    [90m502| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mid)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[14/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/dataBlocks.test.ts[2m > [22mData Block Integration Tests[2m > [22mshould write data to DataVault via WriteBlock
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, default, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Write Block Workflow,a7cb2c89-9b29-40da-bd1f-4cfd6cc35776,a7cb2c89-9b29-40da-bd1f-4cfd6cc35776,e51b422a-fd16-438f-baee-4e8bee3aecb6[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/dataBlocks.test.ts:[2m113:28[22m[39m
    [90m111| [39m        projectId [33m=[39m project[33m.[39mid[33m;[39m
    [90m112| [39m
    [90m113| [39m        [35mconst[39m [workflow] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m                           [31m^[39m
    [90m114| [39m            projectId[33m:[39m projectId[33m,[39m
    [90m115| [39m            title[33m:[39m [32m'Write Block Workflow'[39m[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/dataBlocks.test.ts:[2m113:28[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 502, severity: 'ERROR', code: '23502', detail: 'Failing row contains (060da57b-b031-476f-b9e4-2fb0cf781f8a, Write Block Workflow, null, a7cb2c89-9b29-40da-bd1f-4cfd6cc35776, null, 2026-01-15 22:27:09.217245, 2026-01-15 22:27:09.217245, a7cb2c89-9b29-40da-bd1f-4cfd6cc35776, e51b422a-fd16-438f-baee-4e8bee3aecb6, null, null, null, null, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[15/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/dataBlocks.test.ts[2m > [22mData Block Integration Tests[2m > [22mshould query data from DataVault via QueryBlock and use in Logic
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, default, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Query Block Workflow,a7cb2c89-9b29-40da-bd1f-4cfd6cc35776,a7cb2c89-9b29-40da-bd1f-4cfd6cc35776,e51b422a-fd16-438f-baee-4e8bee3aecb6[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/dataBlocks.test.ts:[2m194:28[22m[39m
    [90m192| [39m    it('should query data from DataVault via QueryBlock and use in Log‚Ä¶
    [90m193| [39m        [90m// 1. Create Workflow & Query[39m
    [90m194| [39m        [35mconst[39m [workflow] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m                           [31m^[39m
    [90m195| [39m            projectId[33m:[39m projectId[33m,[39m
    [90m196| [39m            title[33m:[39m [32m'Query Block Workflow'[39m[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/dataBlocks.test.ts:[2m194:28[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 502, severity: 'ERROR', code: '23502', detail: 'Failing row contains (d33010b3-bc7a-4c81-816e-0bb1145fda72, Query Block Workflow, null, a7cb2c89-9b29-40da-bd1f-4cfd6cc35776, null, 2026-01-15 22:27:09.576653, 2026-01-15 22:27:09.576653, a7cb2c89-9b29-40da-bd1f-4cfd6cc35776, e51b422a-fd16-438f-baee-4e8bee3aecb6, null, null, null, null, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[16/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.autonumber.test.ts[2m > [22mDataVault Autonumber Integration Tests[2m > [22mshould generate basic autonumber without prefix
[31m[1mError[22m: Failed query: SELECT datavault_get_next_autonumber(
        $1::UUID,
        $2::UUID,
        $3::UUID,
        'default'::TEXT,
        $4::INTEGER,
        $5::TEXT,
        $6::TEXT
      ) as next_value
params: 15f19932-cda8-4294-a8e2-851fe4a1a2ad,d77d017a-76ff-44e4-9ffd-51c5fd0e826c,1d896c66-759c-4261-826a-90c856d268dd,4,,[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
    [90m440| [39m    [90m// Call the database function with all parameters[39m
    [90m441| [39m    // SQL Signature: (tenant, table, column, context_key, min_digits,‚Ä¶
    [90m442| [39m    [35mconst[39m res [33m=[39m [35mawait[39m database[33m.[39m[34mexecute[39m(
    [90m   | [39m                [31m^[39m
    [90m443| [39m      sql[32m`SELECT datavault_get_next_autonumber(
    [90m444| [39m        [39m[36m${[39mtenantId[36m}[39m[32m::UUID,
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m101:18[22m[39m

[31m[1mCaused by: error[22m: function datavault_get_next_autonumber(uuid, uuid, uuid, text, integer, text, text) does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m101:18[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 266, severity: 'ERROR', code: '42883', detail: undefined, hint: 'No function matches the given name and argument types. You might need to add explicit type casts.', position: '8', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_func.c', routine: 'ParseFuncOrColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[17/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.autonumber.test.ts[2m > [22mDataVault Autonumber Integration Tests[2m > [22mshould generate autonumber with prefix
[31m[1mError[22m: Failed query: SELECT datavault_get_next_autonumber(
        $1::UUID,
        $2::UUID,
        $3::UUID,
        'default'::TEXT,
        $4::INTEGER,
        $5::TEXT,
        $6::TEXT
      ) as next_value
params: 15f19932-cda8-4294-a8e2-851fe4a1a2ad,d77d017a-76ff-44e4-9ffd-51c5fd0e826c,1d896c66-759c-4261-826a-90c856d268dd,4,,[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
    [90m440| [39m    [90m// Call the database function with all parameters[39m
    [90m441| [39m    // SQL Signature: (tenant, table, column, context_key, min_digits,‚Ä¶
    [90m442| [39m    [35mconst[39m res [33m=[39m [35mawait[39m database[33m.[39m[34mexecute[39m(
    [90m   | [39m                [31m^[39m
    [90m443| [39m      sql[32m`SELECT datavault_get_next_autonumber(
    [90m444| [39m        [39m[36m${[39mtenantId[36m}[39m[32m::UUID,
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m126:18[22m[39m

[31m[1mCaused by: error[22m: function datavault_get_next_autonumber(uuid, uuid, uuid, text, integer, text, text) does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m126:18[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 266, severity: 'ERROR', code: '42883', detail: undefined, hint: 'No function matches the given name and argument types. You might need to add explicit type casts.', position: '8', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_func.c', routine: 'ParseFuncOrColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[18/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.autonumber.test.ts[2m > [22mDataVault Autonumber Integration Tests[2m > [22mshould generate autonumber with yearly reset format
[31m[1mError[22m: Failed query: SELECT datavault_get_next_autonumber(
        $1::UUID,
        $2::UUID,
        $3::UUID,
        'default'::TEXT,
        $4::INTEGER,
        $5::TEXT,
        $6::TEXT
      ) as next_value
params: 15f19932-cda8-4294-a8e2-851fe4a1a2ad,d77d017a-76ff-44e4-9ffd-51c5fd0e826c,1d896c66-759c-4261-826a-90c856d268dd,4,,[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
    [90m440| [39m    [90m// Call the database function with all parameters[39m
    [90m441| [39m    // SQL Signature: (tenant, table, column, context_key, min_digits,‚Ä¶
    [90m442| [39m    [35mconst[39m res [33m=[39m [35mawait[39m database[33m.[39m[34mexecute[39m(
    [90m   | [39m                [31m^[39m
    [90m443| [39m      sql[32m`SELECT datavault_get_next_autonumber(
    [90m444| [39m        [39m[36m${[39mtenantId[36m}[39m[32m::UUID,
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m150:18[22m[39m

[31m[1mCaused by: error[22m: function datavault_get_next_autonumber(uuid, uuid, uuid, text, integer, text, text) does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m150:18[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 266, severity: 'ERROR', code: '42883', detail: undefined, hint: 'No function matches the given name and argument types. You might need to add explicit type casts.', position: '8', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_func.c', routine: 'ParseFuncOrColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[19/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.autonumber.test.ts[2m > [22mDataVault Autonumber Integration Tests[2m > [22mshould be atomic and prevent race conditions
[31m[1mError[22m: Failed query: SELECT datavault_get_next_autonumber(
        $1::UUID,
        $2::UUID,
        $3::UUID,
        'default'::TEXT,
        $4::INTEGER,
        $5::TEXT,
        $6::TEXT
      ) as next_value
params: 15f19932-cda8-4294-a8e2-851fe4a1a2ad,d77d017a-76ff-44e4-9ffd-51c5fd0e826c,1d896c66-759c-4261-826a-90c856d268dd,4,,[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
    [90m440| [39m    [90m// Call the database function with all parameters[39m
    [90m441| [39m    // SQL Signature: (tenant, table, column, context_key, min_digits,‚Ä¶
    [90m442| [39m    [35mconst[39m res [33m=[39m [35mawait[39m database[33m.[39m[34mexecute[39m(
    [90m   | [39m                [31m^[39m
    [90m443| [39m      sql[32m`SELECT datavault_get_next_autonumber(
    [90m444| [39m        [39m[36m${[39mtenantId[36m}[39m[32m::UUID,
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m177:18[22m[39m

[31m[1mCaused by: error[22m: function datavault_get_next_autonumber(uuid, uuid, uuid, text, integer, text, text) does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m177:18[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 266, severity: 'ERROR', code: '42883', detail: undefined, hint: 'No function matches the given name and argument types. You might need to add explicit type casts.', position: '8', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_func.c', routine: 'ParseFuncOrColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[20/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.autonumber.test.ts[2m > [22mDataVault Autonumber Integration Tests[2m > [22mshould prevent manual updates to autonumber values
[31m[1mError[22m: Failed query: SELECT datavault_get_next_autonumber(
        $1::UUID,
        $2::UUID,
        $3::UUID,
        'default'::TEXT,
        $4::INTEGER,
        $5::TEXT,
        $6::TEXT
      ) as next_value
params: 15f19932-cda8-4294-a8e2-851fe4a1a2ad,d77d017a-76ff-44e4-9ffd-51c5fd0e826c,1d896c66-759c-4261-826a-90c856d268dd,4,,[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
    [90m440| [39m    [90m// Call the database function with all parameters[39m
    [90m441| [39m    // SQL Signature: (tenant, table, column, context_key, min_digits,‚Ä¶
    [90m442| [39m    [35mconst[39m res [33m=[39m [35mawait[39m database[33m.[39m[34mexecute[39m(
    [90m   | [39m                [31m^[39m
    [90m443| [39m      sql[32m`SELECT datavault_get_next_autonumber(
    [90m444| [39m        [39m[36m${[39mtenantId[36m}[39m[32m::UUID,
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m189:17[22m[39m

[31m[1mCaused by: error[22m: function datavault_get_next_autonumber(uuid, uuid, uuid, text, integer, text, text) does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m189:17[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 266, severity: 'ERROR', code: '42883', detail: undefined, hint: 'No function matches the given name and argument types. You might need to add explicit type casts.', position: '8', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_func.c', routine: 'ParseFuncOrColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[21/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/externalSends.test.ts[2m > [22mExternal Send Block Integration[2m > [22mPREVIEW MODE: Should simulate send and NOT call fetch
[41m[1m FAIL [22m[49m tests/integration/externalSends.test.ts[2m > [22mExternal Send Block Integration[2m > [22mLIVE MODE: Should call fetch with mapped payload
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, default, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Send Workflow,aa5861cf-6d0a-4b7a-ab0b-e240903481e3,aa5861cf-6d0a-4b7a-ab0b-e240903481e3,47d0cf7f-3617-4460-b6b5-f9f5c5fe19f7[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/externalSends.test.ts:[2m90:28[22m[39m
    [90m 88| [39m
    [90m 89| [39m        [90m// 4. Setup Workflow & Version & Section[39m
    [90m 90| [39m        [35mconst[39m [workflow] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m                           [31m^[39m
    [90m 91| [39m            projectId[33m,[39m
    [90m 92| [39m            title[33m:[39m [32m'Send Workflow'[39m[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/externalSends.test.ts:[2m90:28[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 495, severity: 'ERROR', code: '23502', detail: 'Failing row contains (ba804cea-af6e-4cae-bd5a-78b4a410b0bb, Send Workflow, null, aa5861cf-6d0a-4b7a-ab0b-e240903481e3, null, 2026-01-15 22:27:07.142962, 2026-01-15 22:27:07.142962, aa5861cf-6d0a-4b7a-ab0b-e240903481e3, 47d0cf7f-3617-4460-b6b5-f9f5c5fe19f7, null, null, null, null, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould complete full MFA setup flow
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'mfaEnabled')[39m
[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m68:40[22m[39m
    [90m 66| [39m
    [90m 67| [39m      [35mconst[39m token [33m=[39m (loginResponse[33m.[39mbody)[33m.[39mtoken[33m;[39m
    [90m 68| [39m      [34mexpect[39m((loginResponse[33m.[39mbody)[33m.[39muser[33m.[39mmfaEnabled)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m   | [39m                                       [31m^[39m
    [90m 69| [39m
    [90m 70| [39m      [90m// Step 2: Setup MFA[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[23/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould reject invalid TOTP code during setup
[31m[1mAssertionError[22m: expected 401 to be 400 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 400[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m145:37[22m[39m
    [90m143| [39m        [33m.[39m[34msend[39m({ token[33m:[39m [32m"000000"[39m })[33m;[39m [90m// Invalid code[39m
    [90m144| [39m
    [90m145| [39m      [34mexpect[39m(verifyResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m400[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m146| [39m      [34mexpect[39m(verifyResponse[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"Invalid"[39m)[33m;[39m
    [90m147| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[24/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould generate unique backup codes
[31m[1mAssertionError[22m: expected +0 to be 10 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 10[39m
[31m+ 0[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m186:32[22m[39m
    [90m184| [39m      [90m// All codes should be unique[39m
    [90m185| [39m      [35mconst[39m uniqueCodes [33m=[39m [35mnew[39m [33mSet[39m(backupCodes)[33m;[39m
    [90m186| [39m      [34mexpect[39m(uniqueCodes[33m.[39msize)[33m.[39m[34mtoBe[39m([34m10[39m)[33m;[39m
    [90m   | [39m                               [31m^[39m
    [90m187| [39m    })[33m;[39m
    [90m188| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[25/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould store hashed backup codes
[31m[1mAssertionError[22m: expected [] to have a length of 10 but got +0[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 10[39m
[31m+ 0[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m208:27[22m[39m
    [90m206| [39m      })[33m;[39m
    [90m207| [39m
    [90m208| [39m      [34mexpect[39m(storedCodes)[33m.[39m[34mtoHaveLength[39m([34m10[39m)[33m;[39m
    [90m   | [39m                          [31m^[39m
    [90m209| [39m
    [90m210| [39m      [90m// Hashes should not match plain codes[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[26/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould login with valid backup code
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'secret')[39m
[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m341:52[22m[39m
    [90m339| [39m      })[33m;[39m
    [90m340| [39m
    [90m341| [39m      [35mconst[39m totpCode [33m=[39m [34mgenerateTotpCode[39m(mfaSecret[33m![39m[33m.[39msecret)[33m;[39m
    [90m   | [39m                                                   [31m^[39m
    [90m342| [39m
    [90m343| [39m      [35mawait[39m [34mrequest[39m(app)

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[27/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould prevent backup code reuse
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'secret')[39m
[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m413:52[22m[39m
    [90m411| [39m      })[33m;[39m
    [90m412| [39m
    [90m413| [39m      [35mconst[39m totpCode [33m=[39m [34mgenerateTotpCode[39m(mfaSecret[33m![39m[33m.[39msecret)[33m;[39m
    [90m   | [39m                                                   [31m^[39m
    [90m414| [39m
    [90m415| [39m      [35mawait[39m [34mrequest[39m(app)

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[28/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Status[2m > [22mshould return MFA status for user
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m486:37[22m[39m
    [90m484| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mloginResponse[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m485| [39m
    [90m486| [39m      [34mexpect[39m(statusResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m487| [39m      [34mexpect[39m(statusResponse[33m.[39mbody[33m.[39mmfaEnabled)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m488| [39m      [34mexpect[39m(statusResponse[33m.[39mbody[33m.[39mbackupCodesRemaining)[33m.[39m[34mtoBe[39m([34m0[39m)[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[29/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Disable Flow[2m > [22mshould disable MFA with password verification
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m552:38[22m[39m
    [90m550| [39m        [33m.[39m[34msend[39m({ password })[33m;[39m
    [90m551| [39m
    [90m552| [39m      [34mexpect[39m(disableResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                     [31m^[39m
    [90m553| [39m
    [90m554| [39m      [90m// Verify MFA is disabled[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[30/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Regeneration[2m > [22mshould return error if MFA not enabled
[31m[1mAssertionError[22m: expected 401 to be 400 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 400[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m657:31[22m[39m
    [90m655| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mloginResponse[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m656| [39m
    [90m657| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m400[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m658| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"not enabled"[39m)[33m;[39m
    [90m659| [39m    })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[31/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m1. Required + Show/Hide (Questions)[2m > [22mshould block Next when required visible question is empty
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 588f5b97-cb97-4e1c-aaef-3cd030b1bcaa,Required Question Test,db42d608-4a7c-4b14-a3f1-7df8b0be83d8,db42d608-4a7c-4b14-a3f1-7df8b0be83d8,291035a6-764c-46e9-9462-b166fb4cba1c,b17a0c89-0858-45e6-99b8-2584eff68887[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m
    [90m 98| [39m            workflowVersionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 99| [39m
    [90m100| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m101| [39m                id[33m:[39m workflowId[33m,[39m
    [90m102| [39m                projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 536, severity: 'ERROR', code: '23502', detail: 'Failing row contains (588f5b97-cb97-4e1c-aaef-3cd030b1bcaa, Required Question Test, null, db42d608-4a7c-4b14-a3f1-7df8b0be83d8, null, 2026-01-15 22:27:05.220822, 2026-01-15 22:27:05.220822, db42d608-4a7c-4b14-a3f1-7df8b0be83d8, 291035a6-764c-46e9-9462-b166fb4cba1c, null, null, null, b17a0c89-0858-45e6-99b8-2584eff68887, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[32/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m1. Required + Show/Hide (Questions)[2m > [22mshould NOT block Next when required question is hidden
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: f8d255fb-6f96-4b0e-9d83-88f0d261f72a,Required Question Test,db42d608-4a7c-4b14-a3f1-7df8b0be83d8,db42d608-4a7c-4b14-a3f1-7df8b0be83d8,291035a6-764c-46e9-9462-b166fb4cba1c,afe345b6-ba1b-4353-9817-78cbf664cab7[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m
    [90m 98| [39m            workflowVersionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 99| [39m
    [90m100| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m101| [39m                id[33m:[39m workflowId[33m,[39m
    [90m102| [39m                projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 536, severity: 'ERROR', code: '23502', detail: 'Failing row contains (f8d255fb-6f96-4b0e-9d83-88f0d261f72a, Required Question Test, null, db42d608-4a7c-4b14-a3f1-7df8b0be83d8, null, 2026-01-15 22:27:05.562042, 2026-01-15 22:27:05.562042, db42d608-4a7c-4b14-a3f1-7df8b0be83d8, 291035a6-764c-46e9-9462-b166fb4cba1c, null, null, null, afe345b6-ba1b-4353-9817-78cbf664cab7, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[33/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m1. Required + Show/Hide (Questions)[2m > [22mshould block when required becomes visible and is empty
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 33b419a5-4d3e-4210-8012-e4d38df4104d,Required Question Test,db42d608-4a7c-4b14-a3f1-7df8b0be83d8,db42d608-4a7c-4b14-a3f1-7df8b0be83d8,291035a6-764c-46e9-9462-b166fb4cba1c,db736624-068a-4b98-81cb-52373eee27dc[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m
    [90m 98| [39m            workflowVersionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 99| [39m
    [90m100| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m101| [39m                id[33m:[39m workflowId[33m,[39m
    [90m102| [39m                projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 534, severity: 'ERROR', code: '23502', detail: 'Failing row contains (33b419a5-4d3e-4210-8012-e4d38df4104d, Required Question Test, null, db42d608-4a7c-4b14-a3f1-7df8b0be83d8, null, 2026-01-15 22:27:05.89165, 2026-01-15 22:27:05.89165, db42d608-4a7c-4b14-a3f1-7df8b0be83d8, 291035a6-764c-46e9-9462-b166fb4cba1c, null, null, null, db736624-068a-4b98-81cb-52373eee27dc, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[34/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m2. Required + Show/Hide (Pages)[2m > [22mshould skip hidden required page entirely
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 30b5db58-ab45-4852-ae46-0cb88195b9d7,Page Visibility Test,db42d608-4a7c-4b14-a3f1-7df8b0be83d8,db42d608-4a7c-4b14-a3f1-7df8b0be83d8,291035a6-764c-46e9-9462-b166fb4cba1c,70df2543-0ae5-4734-806f-8e25f66197e8[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m272:13[22m[39m
    [90m270| [39m            workflowVersionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m271| [39m
    [90m272| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m273| [39m                id[33m:[39m workflowId[33m,[39m
    [90m274| [39m                projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m272:13[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 534, severity: 'ERROR', code: '23502', detail: 'Failing row contains (30b5db58-ab45-4852-ae46-0cb88195b9d7, Page Visibility Test, null, db42d608-4a7c-4b14-a3f1-7df8b0be83d8, null, 2026-01-15 22:27:06.226917, 2026-01-15 22:27:06.226917, db42d608-4a7c-4b14-a3f1-7df8b0be83d8, 291035a6-764c-46e9-9462-b166fb4cba1c, null, null, null, 70df2543-0ae5-4734-806f-8e25f66197e8, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[35/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m2. Required + Show/Hide (Pages)[2m > [22mshould enforce required on visible page
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 50de976d-6643-493d-a1c9-75556b57f406,Page Required Test,db42d608-4a7c-4b14-a3f1-7df8b0be83d8,db42d608-4a7c-4b14-a3f1-7df8b0be83d8,291035a6-764c-46e9-9462-b166fb4cba1c,70bcb795-2b21-49a8-90e7-5e11de7e605c[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m357:13[22m[39m
    [90m355| [39m            workflowVersionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m356| [39m
    [90m357| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m358| [39m                id[33m:[39m workflowId[33m,[39m
    [90m359| [39m                projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m357:13[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 532, severity: 'ERROR', code: '23502', detail: 'Failing row contains (50de976d-6643-493d-a1c9-75556b57f406, Page Required Test, null, db42d608-4a7c-4b14-a3f1-7df8b0be83d8, null, 2026-01-15 22:27:06.572015, 2026-01-15 22:27:06.572015, db42d608-4a7c-4b14-a3f1-7df8b0be83d8, 291035a6-764c-46e9-9462-b166fb4cba1c, null, null, null, 70bcb795-2b21-49a8-90e7-5e11de7e605c, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[36/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould list all active sessions for current user
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m86:31[22m[39m
    [90m 84| [39m        [33m.[39m[35mset[39m([32m"Cookie"[39m[33m,[39m cookie[33m![39m)[33m;[39m
    [90m 85| [39m
    [90m 86| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m 87| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39msessions)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m 88| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39msessions[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m3[39m)[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[37/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould mark current session correctly
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'filter')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m128:40[22m[39m
    [90m126| [39m
    [90m127| [39m      [35mconst[39m sessions [33m=[39m response[33m.[39mbody[33m.[39msessions[33m;[39m
    [90m128| [39m      [35mconst[39m currentSessions [33m=[39m sessions[33m.[39m[34mfilter[39m((s[33m:[39m any) [33m=>[39m s[33m.[39mcurrent)[33m;[39m
    [90m   | [39m                                       [31m^[39m
    [90m129| [39m
    [90m130| [39m      [90m// Only one should be current[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[38/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould exclude revoked sessions
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'length')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m163:37[22m[39m
    [90m161| [39m
    [90m162| [39m      [90m// Should only show 1 session (non-revoked)[39m
    [90m163| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39msessions[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m1[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m164| [39m    })[33m;[39m
    [90m165| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould order sessions by last used (most recent first)
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'length')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m190:36[22m[39m
    [90m188| [39m
    [90m189| [39m      [90m// Should be ordered by lastUsedAt descending[39m
    [90m190| [39m      [35mfor[39m ([35mlet[39m i [33m=[39m [34m1[39m[33m;[39m i [33m<[39m sessions[33m.[39mlength[33m;[39m i[33m++[39m) {
    [90m   | [39m                                   [31m^[39m
    [90m191| [39m        [35mconst[39m prev [33m=[39m [35mnew[39m [33mDate[39m(sessions[i [33m-[39m [34m1[39m][33m.[39mlastUsedAt)[33m;[39m
    [90m192| [39m        [35mconst[39m curr [33m=[39m [35mnew[39m [33mDate[39m(sessions[i][33m.[39mlastUsedAt)[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[40/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould filter sessions by current user only
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'length')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m222:37[22m[39m
    [90m220| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39muser1Login[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m221| [39m
    [90m222| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39msessions[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m2[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m223| [39m    })[33m;[39m
    [90m224| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[41/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould revoke specific session
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m254:40[22m[39m
    [90m252| [39m
    [90m253| [39m      [35mconst[39m sessions [33m=[39m sessionsResponse[33m.[39mbody[33m.[39msessions[33m;[39m
    [90m254| [39m      [35mconst[39m sessionToRevoke [33m=[39m sessions[33m.[39m[34mfind[39m((s[33m:[39m any) [33m=>[39m [33m![39ms[33m.[39mcurrent)[33m;[39m
    [90m   | [39m                                       [31m^[39m
    [90m255| [39m
    [90m256| [39m      [90m// Revoke non-current session[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[42/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould prevent revoking current session
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m297:61[22m[39m
    [90m295| [39m        [33m.[39m[35mset[39m([32m"Cookie"[39m[33m,[39m cookie[33m![39m)[33m;[39m
    [90m296| [39m
    [90m297| [39m      [35mconst[39m currentSession [33m=[39m sessionsResponse[33m.[39mbody[33m.[39msessions[33m.[39m[34mfind[39m(
    [90m   | [39m                                                            [31m^[39m
    [90m298| [39m        (s[33m:[39m any) [33m=>[39m s[33m.[39mcurrent
    [90m299| [39m      )[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[43/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould return 404 for non-existent session
[31m[1mAssertionError[22m: expected 401 to be 404 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 404[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m323:31[22m[39m
    [90m321| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mlogin[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m322| [39m
    [90m323| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m404[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m324| [39m    })[33m;[39m
    [90m325| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[44/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould prevent revoking other user's session
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m347:49[22m[39m
    [90m345| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39muser1Login[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m346| [39m
    [90m347| [39m      [35mconst[39m user1SessionId [33m=[39m user1Sessions[33m.[39mbody[33m.[39msessions[[34m0[39m][33m.[39mid[33m;[39m
    [90m   | [39m                                                [31m^[39m
    [90m348| [39m
    [90m349| [39m      [90m// Try to revoke user 1's session as user 2[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[45/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould revoke all other sessions
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m382:31[22m[39m
    [90m380| [39m        [33m.[39m[35mset[39m([32m"Cookie"[39m[33m,[39m cookie[33m![39m)[33m;[39m
    [90m381| [39m
    [90m382| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m383| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"all other devices"[39m)[33m;[39m
    [90m384| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[46/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould keep current session active
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m419:33[22m[39m
    [90m417| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m418| [39m
    [90m419| [39m      [34mexpect[39m(meResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                [31m^[39m
    [90m420| [39m
    [90m421| [39m      [90m// Should be able to refresh with current token[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[47/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould return 400 if no active session found
[31m[1mAssertionError[22m: expected 401 to be 400 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 400[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m444:31[22m[39m
    [90m442| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m443| [39m
    [90m444| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m400[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m445| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"No active session"[39m)[33m;[39m
    [90m446| [39m    })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[48/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould handle user with single session gracefully
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m498:31[22m[39m
    [90m496| [39m        [33m.[39m[35mset[39m([32m"Cookie"[39m[33m,[39m cookie[33m![39m)[33m;[39m
    [90m497| [39m
    [90m498| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m499| [39m
    [90m500| [39m      [90m// Current session should still exist[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[49/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould include device metadata in sessions
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m526:37[22m[39m
    [90m524| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m525| [39m
    [90m526| [39m      [35mconst[39m session [33m=[39m response[33m.[39mbody[33m.[39msessions[[34m0[39m][33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m527| [39m
    [90m528| [39m      [34mexpect[39m(session[33m.[39mdeviceName)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[50/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould not expose sensitive token data
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m544:37[22m[39m
    [90m542| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mlogin[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m543| [39m
    [90m544| [39m      [35mconst[39m session [33m=[39m response[33m.[39mbody[33m.[39msessions[[34m0[39m][33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m545| [39m
    [90m546| [39m      [90m// Should NOT include token hash or metadata[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[51/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould track session activity timestamps
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m563:37[22m[39m
    [90m561| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mlogin[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m562| [39m
    [90m563| [39m      [35mconst[39m session [33m=[39m response[33m.[39mbody[33m.[39msessions[[34m0[39m][33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m564| [39m
    [90m565| [39m      [34mexpect[39m(session[33m.[39mcreatedAt)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[52/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDevice Trust with MFA Login[2m > [22mshould skip MFA for trusted device
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m491:42[22m[39m
    [90m489| [39m
    [90m490| [39m      [90m// Should not require MFA[39m
    [90m491| [39m      [34mexpect[39m(secondLoginResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                         [31m^[39m
    [90m492| [39m      [34mexpect[39m(secondLoginResponse[33m.[39mbody[33m.[39mrequiresMfa)[33m.[39m[34mtoBeUndefined[39m()[33m;[39m
    [90m493| [39m      [34mexpect[39m(secondLoginResponse[33m.[39mbody[33m.[39mtoken)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[53/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mREPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 68bdee23-f4f2-473a-9f79-c3e97cafc59c,Safety Workflow,0932ad53-0b50-42e3-be32-6dca7238b6a2,0932ad53-0b50-42e3-be32-6dca7238b6a2,68be2310-3dba-4d67-ae68-5e1e34eabdfa,047b5ce4-8c6f-475a-89d2-734ae572e2e3[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m
    [90m 73| [39m        workflowId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 74| [39m        versionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 75| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(workflowsSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 76| [39m            id[33m:[39m workflowId[33m,[39m
    [90m 77| [39m            projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 525, severity: 'ERROR', code: '23502', detail: 'Failing row contains (68bdee23-f4f2-473a-9f79-c3e97cafc59c, Safety Workflow, null, 0932ad53-0b50-42e3-be32-6dca7238b6a2, null, 2026-01-15 22:27:06.1968, 2026-01-15 22:27:06.1968, 0932ad53-0b50-42e3-be32-6dca7238b6a2, 68be2310-3dba-4d67-ae68-5e1e34eabdfa, null, null, null, 047b5ce4-8c6f-475a-89d2-734ae572e2e3, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[54/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mScriptEngine resolves alias 'input_variable' when aliasMap is provided
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 4ea1977c-42f2-45ca-afeb-7c45bc907122,Safety Workflow,42472980-595a-4f6f-aea7-f992a42c1c52,42472980-595a-4f6f-aea7-f992a42c1c52,b8a10df8-893e-48c4-8e6e-9ab889671633,d1f6b47b-7023-4d4e-a2a8-fb04a8352a97[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m
    [90m 73| [39m        workflowId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 74| [39m        versionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 75| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(workflowsSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 76| [39m            id[33m:[39m workflowId[33m,[39m
    [90m 77| [39m            projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 529, severity: 'ERROR', code: '23502', detail: 'Failing row contains (4ea1977c-42f2-45ca-afeb-7c45bc907122, Safety Workflow, null, 42472980-595a-4f6f-aea7-f992a42c1c52, null, 2026-01-15 22:27:06.679481, 2026-01-15 22:27:06.679481, 42472980-595a-4f6f-aea7-f992a42c1c52, b8a10df8-893e-48c4-8e6e-9ab889671633, null, null, null, d1f6b47b-7023-4d4e-a2a8-fb04a8352a97, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[55/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mREPRO: BlockRunner fails to resolve alias in CreateRecordConfig
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: bc09b921-bf7d-44a0-b4ff-f993487b0f73,Safety Workflow,7afa6031-8e96-45e9-be56-1dbe248c00a2,7afa6031-8e96-45e9-be56-1dbe248c00a2,35a1742a-63a4-4670-967b-e1aa4444ac1a,ca42710a-5285-4cee-b0da-2f7adc6bf111[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m
    [90m 73| [39m        workflowId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 74| [39m        versionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 75| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(workflowsSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 76| [39m            id[33m:[39m workflowId[33m,[39m
    [90m 77| [39m            projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 529, severity: 'ERROR', code: '23502', detail: 'Failing row contains (bc09b921-bf7d-44a0-b4ff-f993487b0f73, Safety Workflow, null, 7afa6031-8e96-45e9-be56-1dbe248c00a2, null, 2026-01-15 22:27:07.156675, 2026-01-15 22:27:07.156675, 7afa6031-8e96-45e9-be56-1dbe248c00a2, 35a1742a-63a4-4670-967b-e1aa4444ac1a, null, null, null, ca42710a-5285-4cee-b0da-2f7adc6bf111, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[56/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mBlockRunner logic resolves alias with aliasMap
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 8f557be8-1a18-44f6-a440-739a10d168a8,Safety Workflow,4d3bcfdc-7193-4ba5-864e-be9774c2ed3f,4d3bcfdc-7193-4ba5-864e-be9774c2ed3f,37dfa3ab-d1f9-44cb-8ed2-27d1481f6a56,2c18fa5c-28a3-4091-beed-22337a8c17cb[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m
    [90m 73| [39m        workflowId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 74| [39m        versionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 75| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(workflowsSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 76| [39m            id[33m:[39m workflowId[33m,[39m
    [90m 77| [39m            projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 529, severity: 'ERROR', code: '23502', detail: 'Failing row contains (8f557be8-1a18-44f6-a440-739a10d168a8, Safety Workflow, null, 4d3bcfdc-7193-4ba5-864e-be9774c2ed3f, null, 2026-01-15 22:27:07.657431, 2026-01-15 22:27:07.657431, 4d3bcfdc-7193-4ba5-864e-be9774c2ed3f, 37dfa3ab-d1f9-44cb-8ed2-27d1481f6a56, null, null, null, 2c18fa5c-28a3-4091-beed-22337a8c17cb, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[57/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould create draft version on successful AI edit
[31m[1mError[22m: expected 200 "OK", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m183:8[22m[39m
    [90m181| [39m      })
    [90m182| [39m
    [90m183| [39m      [33m.[39m[34mexpect[39m([34m200[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m184| [39m
    [90m185| [39m    [34mexpect[39m(response[33m.[39mbody[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[58/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould enforce draft mode (revert active workflow to draft)
[31m[1mError[22m: expected 200 "OK", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m223:8[22m[39m
    [90m221| [39m        userMessage[33m:[39m [32m'Add a phone number field'[39m[33m,[39m
    [90m222| [39m      })
    [90m223| [39m      [33m.[39m[34mexpect[39m([34m200[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m224| [39m
    [90m225| [39m    [90m// Verify workflow is now draft[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[59/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould not create version when no changes detected (checksum match)
[31m[1mError[22m: expected 200 "OK", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m240:8[22m[39m
    [90m238| [39m        userMessage[33m:[39m [32m'Add contact section'[39m[33m,[39m
    [90m239| [39m      })
    [90m240| [39m      [33m.[39m[34mexpect[39m([34m200[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m241| [39m
    [90m242| [39m    [35mconst[39m versionId1 [33m=[39m response1[33m.[39mbody[33m.[39mdata[33m.[39mversionId[33m;[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[60/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould reject unsafe DataVault operations
[31m[1mError[22m: expected 400 "Bad Request", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m323:8[22m[39m
    [90m321| [39m        userMessage[33m:[39m [32m'Delete all data'[39m[33m,[39m
    [90m322| [39m      })
    [90m323| [39m      [33m.[39m[34mexpect[39m([34m400[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m324| [39m
    [90m325| [39m    [34mexpect[39m(response[33m.[39mbody[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[61/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould handle multi-operation edits with tempId resolution
[31m[1mError[22m: expected 200 "OK", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m394:8[22m[39m
    [90m392| [39m        userMessage: 'Add emergency contact section with name and phon‚Ä¶
    [90m393| [39m      })
    [90m394| [39m      [33m.[39m[34mexpect[39m([34m200[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m395| [39m
    [90m396| [39m    [34mexpect[39m(response[33m.[39mbody[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[62/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould create BEFORE and AFTER snapshots
[31m[1mError[22m: expected 200 "OK", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m431:8[22m[39m
    [90m429| [39m        userMessage[33m:[39m [32m'Add a simple field'[39m[33m,[39m
    [90m430| [39m      })
    [90m431| [39m      [33m.[39m[34mexpect[39m([34m200[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m432| [39m
    [90m433| [39m    [35mconst[39m versionId [33m=[39m response[33m.[39mbody[33m.[39mdata[33m.[39mversionId[33m;[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[63/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould rollback on validation failure
[31m[1mError[22m: expected 400 "Bad Request", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m500:8[22m[39m
    [90m498| [39m        userMessage[33m:[39m [32m'Add backup email field'[39m[33m,[39m
    [90m499| [39m      })
    [90m500| [39m      [33m.[39m[34mexpect[39m([34m400[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m501| [39m
    [90m502| [39m    [34mexpect[39m(response[33m.[39mbody[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[64/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Authorization Flow Initiation[2m > [22mshould initiate OAuth2 3-legged flow and generate authorization URL
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth/oauth2.callback.test.ts:[2m125:37[22m[39m
    [90m123| [39m        })[33m;[39m
    [90m124| [39m
    [90m125| [39m      [34mexpect[39m(createResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m126| [39m      testConnectionId [33m=[39m createResponse[33m.[39mbody[33m.[39mid[33m;[39m
    [90m127| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[65/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Connection Status[2m > [22mshould track OAuth2 connection status
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth/oauth2.callback.test.ts:[2m309:37[22m[39m
    [90m307| [39m        })[33m;[39m
    [90m308| [39m
    [90m309| [39m      [34mexpect[39m(createResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m310| [39m      [35mconst[39m connectionId [33m=[39m createResponse[33m.[39mbody[33m.[39mid[33m;[39m
    [90m311| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[66/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould successfully authenticate with valid Google ID token
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/auth/oauth2.google.test.ts:[2m91:31[22m[39m
    [90m 89| [39m
    [90m 90| [39m      [90m// Verify response[39m
    [90m 91| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m 92| [39m      [34mexpect[39m(response[33m.[39mbody)[33m.[39m[34mtoMatchObject[39m({
    [90m 93| [39m        message[33m:[39m [32m'Authentication successful'[39m[33m,[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[67/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould revoke all sessions except current
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m326:31[22m[39m
    [90m324| [39m        [33m.[39m[35mset[39m([32m'Cookie'[39m[33m,[39m [32m`refresh_token=[39m[36m${[39mcurrentToken[36m}[39m[32m`[39m)[33m;[39m
    [90m325| [39m
    [90m326| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m327| [39m      expect(response.body.message).toBe('Logged out from all other de‚Ä¶
    [90m328| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[68/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould revoke all trusted devices
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m368:31[22m[39m
    [90m366| [39m        [33m.[39m[35mset[39m([32m'Cookie'[39m[33m,[39m [32m`refresh_token=[39m[36m${[39mcurrentToken[36m}[39m[32m`[39m)[33m;[39m
    [90m367| [39m
    [90m368| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m369| [39m
    [90m370| [39m      [90m// Verify all trusted devices are revoked[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[69/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould create refresh token on login
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m322:31[22m[39m
    [90m320| [39m        })[33m;[39m
    [90m321| [39m
    [90m322| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m323| [39m
    [90m324| [39m      [90m// Verify refresh token cookie is set[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[70/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowPatchService.test.ts[2m > [22mWorkflowPatchService[2m > [22mOperation Application[2m > [22mshould clear tempId mappings between batch calls
[31m[1mError[22m: Invalid section ID: temp-section-1[39m
[36m [2m‚ùØ[22m Object.<anonymous> tests/unit/services/WorkflowPatchService.test.ts:[2m599:17[22m[39m
    [90m597| [39m      mockStepRepoCreate[33m.[39m[34mmockImplementation[39m([35masync[39m (data[33m:[39m any) [33m=>[39m {
    [90m598| [39m        [35mif[39m (data[33m.[39msectionId[33m?.[39m[34mstartsWith[39m([32m'temp-'[39m)) {
    [90m599| [39m          [35mthrow[39m [35mnew[39m [33mError[39m([32m`Invalid section ID: [39m[36m${[39mdata[33m.[39msectionId[36m}[39m[32m`[39m)[33m;[39m
    [90m   | [39m                [31m^[39m
    [90m600| [39m        }
    [90m601| [39m        [35mreturn[39m { id[33m:[39m [32m'step-1'[39m }[33m;[39m
[90m [2m‚ùØ[22m WorkflowPatchService.applyOp server/services/WorkflowPatchService.ts:[2m255:48[22m[39m
[90m [2m‚ùØ[22m WorkflowPatchService.applyOps server/services/WorkflowPatchService.ts:[2m134:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowPatchService.test.ts:[2m619:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[71/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowPatchService.test.ts[2m > [22mWorkflowPatchService[2m > [22mDocument Operations[2m > [22mshould reject binding to non-existent step alias
[31m[1mError[22m: Step alias 'nonExistentAlias' not found in workflow. Please create the step first.[39m
[36m [2m‚ùØ[22m WorkflowPatchService.applyOp server/services/WorkflowPatchService.ts:[2m487:19[22m[39m
    [90m485| [39m        [35mfor[39m ([35mconst[39m stepAlias [35mof[39m [33mObject[39m[33m.[39m[34mvalues[39m(op[33m.[39mbindings)) {
    [90m486| [39m          [35mif[39m ([33m![39mvalidAliases[33m.[39m[34mhas[39m(stepAlias)) {
    [90m487| [39m            [35mthrow[39m [35mnew[39m [33mError[39m(
    [90m   | [39m                  [31m^[39m
    [90m488| [39m              `Step alias '${stepAlias}' not found in workflow. Please‚Ä¶
    [90m489| [39m            )[33m;[39m
[90m [2m‚ùØ[22m WorkflowPatchService.applyOps server/services/WorkflowPatchService.ts:[2m134:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowPatchService.test.ts:[2m872:22[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[72/90]‚éØ[22m[39m


[2m Test Files [22m [1m[31m38 failed[39m[22m[2m | [22m[1m[32m117 passed[39m[22m[2m | [22m[33m1 skipped[39m[90m (156)[39m
[2m      Tests [22m [1m[31m69 failed[39m[22m[2m | [22m[1m[32m2270 passed[39m[22m[2m | [22m[33m43 skipped[39m[90m (2382)[39m
[2m   Start at [22m 16:26:59
[2m   Duration [22m 74.52s[2m (transform 28.97s, setup 19.05s, import 157.46s, tests 630.40s, environment 17.68s)[22m

