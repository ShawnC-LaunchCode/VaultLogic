npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

 DEV  v4.0.16 C:/Users/scoot/poll/VaultLogic

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768675109577,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768675113396,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768675114394,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
Î“Ã…âŒ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768675115904,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768675115916,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768675115909,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768675115910,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768675115913,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768675115913,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768675115915,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768675115915,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768675115916,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768675115916,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768675116075,"env":"test","module":"auth-routes","error":{},"msg":"Registration failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
CRITICAL REGISTRATION ERROR: ReferenceError: SALT_ROUNDS is not defined
    at AuthService.hashPassword (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:168:38)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:242:46
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

{"level":30,"time":1768675116082,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768675116082,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 3681ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiÎ“Ã‡Âª
       |             ^
    115|     }
    116| 
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  12:38:21
   Duration  14.80s (transform 5.18s, setup 2.49s, import 8.38s, tests 3.68s, environment 0ms)

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/AuthService.ts x1 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768675167981,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768675171740,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768675171788,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
Î“Ã…âŒ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Applied failsafe schema fixes

{"level":30,"time":1768675173555,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768675173574,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768675173564,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768675173564,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768675173569,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768675173569,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768675173573,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768675173573,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768675173574,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768675173574,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768675174139,"env":"test","module":"user-credentials-repository","userId":"43b4f984-da59-4af6-8a34-c394cf612644","msg":"User credentials created"}
{"level":30,"time":1768675174258,"env":"test","module":"email-queue","jobId":"1db0b005-b793-4463-aa71-1c7c3fc04d8a","to":"test-B46SqyFd4CbDxjjGYkTau@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768675174264,"env":"test","module":"auth-routes","error":{},"msg":"Registration failed"}
{"level":30,"time":1768675174274,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768675174274,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
CRITICAL REGISTRATION ERROR: ReferenceError: JWT_SECRET is not defined
    at AuthService.createToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:72:9)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:248:33
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 3474ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiÎ“Ã‡Âª
       |             ^
    115|     }
    116| 
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  12:39:17
   Duration  16.49s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/AuthService.ts x2 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768675270765,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

{"level":30,"time":1768675282996,"env":"test","msg":"DB: initializing... Local"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768675288652,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
Î“Ã…âŒ Schema reused, skipping migrations.

{"level":30,"time":1768675290404,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768675290423,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768675290412,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768675290413,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768675290417,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768675290418,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768675290422,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768675290422,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768675290423,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768675290423,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768675290945,"env":"test","module":"user-credentials-repository","userId":"26a79437-731f-4181-bf49-b232df13b4b5","msg":"User credentials created"}
{"level":30,"time":1768675291065,"env":"test","module":"email-queue","jobId":"ba2af4bd-114b-4d44-b1d5-66e6f87e0d5c","to":"test-P83wA7AizW6fUqlu4Wbci@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675291125,"env":"test","module":"auth-routes","userId":"26a79437-731f-4181-bf49-b232df13b4b5","email":"test-P83wA7AizW6fUqlu4Wbci@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Applied failsafe schema fixes

{"level":30,"time":1768675291884,"env":"test","module":"user-credentials-repository","userId":"c46072ed-3cbf-488d-ac72-939eedd818e0","msg":"User credentials created"}
{"level":30,"time":1768675291997,"env":"test","module":"email-queue","jobId":"01721e22-bbb7-45c4-b054-c0380ac94b16","to":"protected-test-8l75wfDe6A4Lgt5a2OnPo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675292059,"env":"test","module":"auth-routes","userId":"c46072ed-3cbf-488d-ac72-939eedd818e0","email":"protected-test-8l75wfDe6A4Lgt5a2OnPo@example.com","msg":"User registered"}
{"level":30,"time":1768675292758,"env":"test","module":"auth-routes","userId":"c46072ed-3cbf-488d-ac72-939eedd818e0","msg":"User logged in successfully"}
{"level":30,"time":1768675292829,"env":"test","module":"audit-log-service","userId":"c46072ed-3cbf-488d-ac72-939eedd818e0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768675293302,"env":"test","module":"user-credentials-repository","userId":"0592e3ae-6adf-444b-aee9-46b003ad55ba","msg":"User credentials created"}
{"level":30,"time":1768675293414,"env":"test","module":"email-queue","jobId":"5d8e8340-b773-4698-9d59-08f2d9ba37e6","to":"protected-test-AlxgZTzntYq3ZYP8Izaga@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675293471,"env":"test","module":"auth-routes","userId":"0592e3ae-6adf-444b-aee9-46b003ad55ba","email":"protected-test-AlxgZTzntYq3ZYP8Izaga@example.com","msg":"User registered"}
{"level":30,"time":1768675294170,"env":"test","module":"auth-routes","userId":"0592e3ae-6adf-444b-aee9-46b003ad55ba","msg":"User logged in successfully"}
{"level":30,"time":1768675294230,"env":"test","module":"audit-log-service","userId":"0592e3ae-6adf-444b-aee9-46b003ad55ba","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675294235,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675294695,"env":"test","module":"user-credentials-repository","userId":"425294d6-797b-45f7-a956-1760e921d26d","msg":"User credentials created"}
{"level":30,"time":1768675294807,"env":"test","module":"email-queue","jobId":"5be850a2-9aab-4794-a2a8-78e0827aacfb","to":"protected-test-8Tq6Q_zJW6Me5ZinvfQ8S@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675294863,"env":"test","module":"auth-routes","userId":"425294d6-797b-45f7-a956-1760e921d26d","email":"protected-test-8Tq6Q_zJW6Me5ZinvfQ8S@example.com","msg":"User registered"}
{"level":30,"time":1768675295558,"env":"test","module":"auth-routes","userId":"425294d6-797b-45f7-a956-1760e921d26d","msg":"User logged in successfully"}
{"level":30,"time":1768675295613,"env":"test","module":"audit-log-service","userId":"425294d6-797b-45f7-a956-1760e921d26d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675295620,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

{"level":30,"time":1768675296072,"env":"test","module":"user-credentials-repository","userId":"588bd9af-1893-4fb6-9ddb-3df58ea51d65","msg":"User credentials created"}
{"level":30,"time":1768675296192,"env":"test","module":"email-queue","jobId":"400e7b0e-bb9f-4841-bc9d-6c0566854517","to":"protected-test-oWjqZ4l3IWhiuX1a3UA5X@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675296249,"env":"test","module":"auth-routes","userId":"588bd9af-1893-4fb6-9ddb-3df58ea51d65","email":"protected-test-oWjqZ4l3IWhiuX1a3UA5X@example.com","msg":"User registered"}
{"level":30,"time":1768675296946,"env":"test","module":"auth-routes","userId":"588bd9af-1893-4fb6-9ddb-3df58ea51d65","msg":"User logged in successfully"}
{"level":30,"time":1768675297001,"env":"test","module":"audit-log-service","userId":"588bd9af-1893-4fb6-9ddb-3df58ea51d65","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675297005,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768675297391,"env":"test","module":"user-credentials-repository","userId":"5b89c946-dcbb-4479-9e44-0451d7217f09","msg":"User credentials created"}
{"level":30,"time":1768675297500,"env":"test","module":"email-queue","jobId":"e2c6db12-237a-4c4c-8d40-84e220291df7","to":"protected-test-83fmZFEjmRBFpMFc111NX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675297555,"env":"test","module":"auth-routes","userId":"5b89c946-dcbb-4479-9e44-0451d7217f09","email":"protected-test-83fmZFEjmRBFpMFc111NX@example.com","msg":"User registered"}
{"level":30,"time":1768675298252,"env":"test","module":"auth-routes","userId":"5b89c946-dcbb-4479-9e44-0451d7217f09","msg":"User logged in successfully"}
{"level":30,"time":1768675298309,"env":"test","module":"audit-log-service","userId":"5b89c946-dcbb-4479-9e44-0451d7217f09","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768675298314,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768675298314,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675298720,"env":"test","module":"user-credentials-repository","userId":"c8a8c24a-7f97-4eff-91ae-1120c7140102","msg":"User credentials created"}
{"level":30,"time":1768675298842,"env":"test","module":"email-queue","jobId":"eadf4223-4767-4c60-8452-616052bd895c","to":"protected-test-bHv_WZyQ-T4p9Y4FnruiA@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675298901,"env":"test","module":"auth-routes","userId":"c8a8c24a-7f97-4eff-91ae-1120c7140102","email":"protected-test-bHv_WZyQ-T4p9Y4FnruiA@example.com","msg":"User registered"}
{"level":30,"time":1768675299592,"env":"test","module":"auth-routes","userId":"c8a8c24a-7f97-4eff-91ae-1120c7140102","msg":"User logged in successfully"}
{"level":30,"time":1768675299650,"env":"test","module":"audit-log-service","userId":"c8a8c24a-7f97-4eff-91ae-1120c7140102","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675300120,"env":"test","module":"user-credentials-repository","userId":"535f05b8-4465-45b1-8314-186ccccff74e","msg":"User credentials created"}
{"level":30,"time":1768675300237,"env":"test","module":"email-queue","jobId":"7bfca54f-bec8-4163-880a-83537ce60fd1","to":"protected-test-ctFbN6tFJbjmmT1iQtRcU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675300294,"env":"test","module":"auth-routes","userId":"535f05b8-4465-45b1-8314-186ccccff74e","email":"protected-test-ctFbN6tFJbjmmT1iQtRcU@example.com","msg":"User registered"}
{"level":30,"time":1768675300978,"env":"test","module":"auth-routes","userId":"535f05b8-4465-45b1-8314-186ccccff74e","msg":"User logged in successfully"}
{"level":30,"time":1768675301033,"env":"test","module":"audit-log-service","userId":"535f05b8-4465-45b1-8314-186ccccff74e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675301036,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675301427,"env":"test","module":"user-credentials-repository","userId":"2dc1ea3f-a612-4754-a592-fbbf46341ccb","msg":"User credentials created"}
{"level":30,"time":1768675301536,"env":"test","module":"email-queue","jobId":"fb88bbf4-0cdf-43bb-9616-2ef4ef32a572","to":"protected-test-tKmfdM39bSwNuJ03vKsEh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675301590,"env":"test","module":"auth-routes","userId":"2dc1ea3f-a612-4754-a592-fbbf46341ccb","email":"protected-test-tKmfdM39bSwNuJ03vKsEh@example.com","msg":"User registered"}
{"level":30,"time":1768675302303,"env":"test","module":"auth-routes","userId":"2dc1ea3f-a612-4754-a592-fbbf46341ccb","msg":"User logged in successfully"}
{"level":30,"time":1768675302361,"env":"test","module":"audit-log-service","userId":"2dc1ea3f-a612-4754-a592-fbbf46341ccb","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675302365,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675302772,"env":"test","module":"user-credentials-repository","userId":"2a8ccb93-7283-4918-b282-08c7037e84b7","msg":"User credentials created"}
{"level":30,"time":1768675302882,"env":"test","module":"email-queue","jobId":"f522c2a6-311c-4a3f-bad9-1bc95bbf1e9e","to":"protected-test-BCGSPb3D8d9EZYXQ6AW3h@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675302938,"env":"test","module":"auth-routes","userId":"2a8ccb93-7283-4918-b282-08c7037e84b7","email":"protected-test-BCGSPb3D8d9EZYXQ6AW3h@example.com","msg":"User registered"}
{"level":30,"time":1768675303613,"env":"test","module":"auth-routes","userId":"2a8ccb93-7283-4918-b282-08c7037e84b7","msg":"User logged in successfully"}
{"level":30,"time":1768675303673,"env":"test","module":"audit-log-service","userId":"2a8ccb93-7283-4918-b282-08c7037e84b7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[DEBUG] BaseRepository.update users: id=2a8ccb93-7283-4918-b282-08c7037e84b7, updates={"defaultMode":"advanced","updatedAt":"2026-01-17T18:41:43.792Z"}
{"level":30,"time":1768675304256,"env":"test","module":"user-credentials-repository","userId":"f7c46600-1404-4414-a738-43ed82401216","msg":"User credentials created"}
{"level":30,"time":1768675304373,"env":"test","module":"email-queue","jobId":"22aab207-022f-4afd-997e-c9b48fb560ae","to":"protected-test-VGV1_Xfh5W3uyZxaw6pYC@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675304429,"env":"test","module":"auth-routes","userId":"f7c46600-1404-4414-a738-43ed82401216","email":"protected-test-VGV1_Xfh5W3uyZxaw6pYC@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675305138,"env":"test","module":"auth-routes","userId":"f7c46600-1404-4414-a738-43ed82401216","msg":"User logged in successfully"}
{"level":30,"time":1768675305205,"env":"test","module":"audit-log-service","userId":"f7c46600-1404-4414-a738-43ed82401216","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675305214,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675305611,"env":"test","module":"user-credentials-repository","userId":"bd710f08-2b7b-402b-9f75-7d0d6d518d46","msg":"User credentials created"}
{"level":30,"time":1768675305722,"env":"test","module":"email-queue","jobId":"fdb14fe7-f698-4733-8cd4-f22fb519ba82","to":"protected-test-c47W5sOivecffCfVEmSH6@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675305780,"env":"test","module":"auth-routes","userId":"bd710f08-2b7b-402b-9f75-7d0d6d518d46","email":"protected-test-c47W5sOivecffCfVEmSH6@example.com","msg":"User registered"}
{"level":30,"time":1768675306489,"env":"test","module":"auth-routes","userId":"bd710f08-2b7b-402b-9f75-7d0d6d518d46","msg":"User logged in successfully"}
{"level":30,"time":1768675306550,"env":"test","module":"audit-log-service","userId":"bd710f08-2b7b-402b-9f75-7d0d6d518d46","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675307136,"env":"test","module":"user-credentials-repository","userId":"038f6606-a6e4-457e-bbe1-7c87b4614f51","msg":"User credentials created"}
{"level":30,"time":1768675307248,"env":"test","module":"email-queue","jobId":"108e6eed-0939-46a7-b815-632f05ebb9da","to":"protected-test-CGlm4AIc0beW7shnAVURB@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675307310,"env":"test","module":"auth-routes","userId":"038f6606-a6e4-457e-bbe1-7c87b4614f51","email":"protected-test-CGlm4AIc0beW7shnAVURB@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675307992,"env":"test","module":"auth-routes","userId":"038f6606-a6e4-457e-bbe1-7c87b4614f51","msg":"User logged in successfully"}
{"level":30,"time":1768675308049,"env":"test","module":"audit-log-service","userId":"038f6606-a6e4-457e-bbe1-7c87b4614f51","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675308052,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675308472,"env":"test","module":"user-credentials-repository","userId":"7c3705d5-cee6-4900-9237-2148522d4753","msg":"User credentials created"}
{"level":30,"time":1768675308581,"env":"test","module":"email-queue","jobId":"8837cfa6-2486-4a68-90c7-2d0b4b7f88aa","to":"protected-test-GTbP09DNAo1Su8hIV0iqB@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675308638,"env":"test","module":"auth-routes","userId":"7c3705d5-cee6-4900-9237-2148522d4753","email":"protected-test-GTbP09DNAo1Su8hIV0iqB@example.com","msg":"User registered"}
{"level":30,"time":1768675309334,"env":"test","module":"auth-routes","userId":"7c3705d5-cee6-4900-9237-2148522d4753","msg":"User logged in successfully"}
{"level":30,"time":1768675309389,"env":"test","module":"audit-log-service","userId":"7c3705d5-cee6-4900-9237-2148522d4753","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675310559,"env":"test","module":"user-credentials-repository","userId":"45c68dcf-74cf-4aef-9679-42d3836b313b","msg":"User credentials created"}
{"level":30,"time":1768675310674,"env":"test","module":"email-queue","jobId":"c16cf7f3-7a35-4302-8ecb-51a48b49d4cf","to":"protected-test-27pIBVic-yNv2O6HWWIGq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675310735,"env":"test","module":"auth-routes","userId":"45c68dcf-74cf-4aef-9679-42d3836b313b","email":"protected-test-27pIBVic-yNv2O6HWWIGq@example.com","msg":"User registered"}
{"level":30,"time":1768675311466,"env":"test","module":"auth-routes","userId":"45c68dcf-74cf-4aef-9679-42d3836b313b","msg":"User logged in successfully"}
{"level":30,"time":1768675311522,"env":"test","module":"audit-log-service","userId":"45c68dcf-74cf-4aef-9679-42d3836b313b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675311526,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675311916,"env":"test","module":"user-credentials-repository","userId":"fd605d28-dc49-4ddc-9226-270f0175ac1c","msg":"User credentials created"}
{"level":30,"time":1768675312027,"env":"test","module":"email-queue","jobId":"acb1f2f1-0917-479d-89a7-496ab54397d1","to":"protected-test-gRghn3A4iX8Oc9OcxD-8q@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675312083,"env":"test","module":"auth-routes","userId":"fd605d28-dc49-4ddc-9226-270f0175ac1c","email":"protected-test-gRghn3A4iX8Oc9OcxD-8q@example.com","msg":"User registered"}
{"level":30,"time":1768675312777,"env":"test","module":"auth-routes","userId":"fd605d28-dc49-4ddc-9226-270f0175ac1c","msg":"User logged in successfully"}
{"level":30,"time":1768675312840,"env":"test","module":"audit-log-service","userId":"fd605d28-dc49-4ddc-9226-270f0175ac1c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768675312844,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768675312844,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675313273,"env":"test","module":"user-credentials-repository","userId":"0e932aba-150c-4848-9c9b-8a22a368bcd9","msg":"User credentials created"}
{"level":30,"time":1768675313389,"env":"test","module":"email-queue","jobId":"bb82cb3e-4147-471e-bb02-5922f1ed2fc7","to":"protected-test-7H_k3kGQKdntv9fkD_mRh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675313456,"env":"test","module":"auth-routes","userId":"0e932aba-150c-4848-9c9b-8a22a368bcd9","email":"protected-test-7H_k3kGQKdntv9fkD_mRh@example.com","msg":"User registered"}
{"level":30,"time":1768675314158,"env":"test","module":"auth-routes","userId":"0e932aba-150c-4848-9c9b-8a22a368bcd9","msg":"User logged in successfully"}
{"level":30,"time":1768675314217,"env":"test","module":"audit-log-service","userId":"0e932aba-150c-4848-9c9b-8a22a368bcd9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675314224,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675314674,"env":"test","module":"user-credentials-repository","userId":"8f7f4c6f-3521-457b-bf26-394d830a27c6","msg":"User credentials created"}
{"level":30,"time":1768675314784,"env":"test","module":"email-queue","jobId":"55d61ac1-140b-4b79-9302-781e208b29ee","to":"protected-test-U8ZDn_oR77mjCCgL-AF12@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675314840,"env":"test","module":"auth-routes","userId":"8f7f4c6f-3521-457b-bf26-394d830a27c6","email":"protected-test-U8ZDn_oR77mjCCgL-AF12@example.com","msg":"User registered"}
{"level":30,"time":1768675315522,"env":"test","module":"auth-routes","userId":"8f7f4c6f-3521-457b-bf26-394d830a27c6","msg":"User logged in successfully"}
{"level":30,"time":1768675315582,"env":"test","module":"audit-log-service","userId":"8f7f4c6f-3521-457b-bf26-394d830a27c6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675315586,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675316010,"env":"test","module":"user-credentials-repository","userId":"4fed79ec-6487-403d-8ee3-da7a4364d4fe","msg":"User credentials created"}
{"level":30,"time":1768675316128,"env":"test","module":"email-queue","jobId":"f1076c79-b23e-46f2-91df-954a0046bf7a","to":"protected-test-qk45iNIL8fYUuIR2d_weB@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675316185,"env":"test","module":"auth-routes","userId":"4fed79ec-6487-403d-8ee3-da7a4364d4fe","email":"protected-test-qk45iNIL8fYUuIR2d_weB@example.com","msg":"User registered"}
{"level":30,"time":1768675316865,"env":"test","module":"auth-routes","userId":"4fed79ec-6487-403d-8ee3-da7a4364d4fe","msg":"User logged in successfully"}
{"level":30,"time":1768675316919,"env":"test","module":"audit-log-service","userId":"4fed79ec-6487-403d-8ee3-da7a4364d4fe","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675316922,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675317318,"env":"test","module":"user-credentials-repository","userId":"9864c114-3721-4f1e-8fa0-74f99351ac81","msg":"User credentials created"}
{"level":30,"time":1768675317429,"env":"test","module":"email-queue","jobId":"1317ac54-a90e-4411-88ab-bfc241572de7","to":"protected-test-hpTQx_qPPGrVKDUqjwji4@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675317487,"env":"test","module":"auth-routes","userId":"9864c114-3721-4f1e-8fa0-74f99351ac81","email":"protected-test-hpTQx_qPPGrVKDUqjwji4@example.com","msg":"User registered"}
{"level":30,"time":1768675318161,"env":"test","module":"auth-routes","userId":"9864c114-3721-4f1e-8fa0-74f99351ac81","msg":"User logged in successfully"}
{"level":30,"time":1768675318218,"env":"test","module":"audit-log-service","userId":"9864c114-3721-4f1e-8fa0-74f99351ac81","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675318221,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675318623,"env":"test","module":"user-credentials-repository","userId":"05e310db-21bc-4578-b541-4144a52c83b7","msg":"User credentials created"}
{"level":30,"time":1768675318741,"env":"test","module":"email-queue","jobId":"0e07ef9f-892e-42c7-bf84-df41a5cfb3f7","to":"protected-test-dFtfu26fqJrnL71UNzRqN@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675318798,"env":"test","module":"auth-routes","userId":"05e310db-21bc-4578-b541-4144a52c83b7","email":"protected-test-dFtfu26fqJrnL71UNzRqN@example.com","msg":"User registered"}
{"level":30,"time":1768675319487,"env":"test","module":"auth-routes","userId":"05e310db-21bc-4578-b541-4144a52c83b7","msg":"User logged in successfully"}
{"level":30,"time":1768675319551,"env":"test","module":"audit-log-service","userId":"05e310db-21bc-4578-b541-4144a52c83b7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675319554,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675319950,"env":"test","module":"user-credentials-repository","userId":"0e629938-dd99-4095-afb0-3e66f70c3d5c","msg":"User credentials created"}
{"level":30,"time":1768675320058,"env":"test","module":"email-queue","jobId":"4b8dce49-7e73-4ef9-b910-df4d0117282f","to":"protected-test-KXjiXz8RFEthTWZrctQM-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675320115,"env":"test","module":"auth-routes","userId":"0e629938-dd99-4095-afb0-3e66f70c3d5c","email":"protected-test-KXjiXz8RFEthTWZrctQM-@example.com","msg":"User registered"}
{"level":30,"time":1768675320792,"env":"test","module":"auth-routes","userId":"0e629938-dd99-4095-afb0-3e66f70c3d5c","msg":"User logged in successfully"}
{"level":30,"time":1768675320850,"env":"test","module":"audit-log-service","userId":"0e629938-dd99-4095-afb0-3e66f70c3d5c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675320853,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675321262,"env":"test","module":"user-credentials-repository","userId":"4bd92c70-1386-4997-b71c-4b88951ff2fe","msg":"User credentials created"}
{"level":30,"time":1768675321373,"env":"test","module":"email-queue","jobId":"6c06cf47-74d9-4b7d-bef5-91011f81fed5","to":"protected-test--kLm_sIuIsVxMfN95AUU2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675321436,"env":"test","module":"auth-routes","userId":"4bd92c70-1386-4997-b71c-4b88951ff2fe","email":"protected-test--kLm_sIuIsVxMfN95AUU2@example.com","msg":"User registered"}
{"level":30,"time":1768675322140,"env":"test","module":"auth-routes","userId":"4bd92c70-1386-4997-b71c-4b88951ff2fe","msg":"User logged in successfully"}
{"level":30,"time":1768675322197,"env":"test","module":"audit-log-service","userId":"4bd92c70-1386-4997-b71c-4b88951ff2fe","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675322595,"env":"test","module":"user-credentials-repository","userId":"31b1c157-09ab-4e9a-a681-81c39c0aabab","msg":"User credentials created"}
{"level":30,"time":1768675322712,"env":"test","module":"email-queue","jobId":"8e07fac9-bfbf-469b-841b-419aa0a85761","to":"protected-test-V9BAzIM7QML9SqrXcxP3D@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675322772,"env":"test","module":"auth-routes","userId":"31b1c157-09ab-4e9a-a681-81c39c0aabab","email":"protected-test-V9BAzIM7QML9SqrXcxP3D@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675323470,"env":"test","module":"auth-routes","userId":"31b1c157-09ab-4e9a-a681-81c39c0aabab","msg":"User logged in successfully"}
{"level":30,"time":1768675323532,"env":"test","module":"audit-log-service","userId":"31b1c157-09ab-4e9a-a681-81c39c0aabab","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675324036,"env":"test","module":"user-credentials-repository","userId":"efc4d93e-3a06-419b-b72c-ad57e7fe5d4e","msg":"User credentials created"}
{"level":30,"time":1768675324154,"env":"test","module":"email-queue","jobId":"a643173b-b673-4007-91a2-d531b52393f2","to":"protected-test-XOLHSnIj2zXiYeaR9JbZT@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675324211,"env":"test","module":"auth-routes","userId":"efc4d93e-3a06-419b-b72c-ad57e7fe5d4e","email":"protected-test-XOLHSnIj2zXiYeaR9JbZT@example.com","msg":"User registered"}
{"level":30,"time":1768675324874,"env":"test","module":"auth-routes","userId":"efc4d93e-3a06-419b-b72c-ad57e7fe5d4e","msg":"User logged in successfully"}
{"level":30,"time":1768675324928,"env":"test","module":"audit-log-service","userId":"efc4d93e-3a06-419b-b72c-ad57e7fe5d4e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675325333,"env":"test","module":"user-credentials-repository","userId":"4d7422ea-90da-449c-8941-42450c1eb6ab","msg":"User credentials created"}
{"level":30,"time":1768675325450,"env":"test","module":"email-queue","jobId":"2c01c3e5-a5ea-4c68-ab65-3c0d8e2516db","to":"user2-9I3jIINwFG_uF0qnDkApg@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675325507,"env":"test","module":"auth-routes","userId":"4d7422ea-90da-449c-8941-42450c1eb6ab","email":"user2-9I3jIINwFG_uF0qnDkApg@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675326141,"env":"test","module":"auth-routes","userId":"4d7422ea-90da-449c-8941-42450c1eb6ab","msg":"User logged in successfully"}
{"level":30,"time":1768675326201,"env":"test","module":"audit-log-service","userId":"4d7422ea-90da-449c-8941-42450c1eb6ab","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768675326264,"env":"test","module":"rbac-middleware","userId":"4d7422ea-90da-449c-8941-42450c1eb6ab","userRole":"viewer","permission":"project:delete","path":"/e60bdb71-2954-4451-a95c-96a86c21e3b7","msg":"Permission denied"}
{"level":30,"time":1768675326659,"env":"test","module":"user-credentials-repository","userId":"8d8341d4-963d-4e31-90c7-3e7f28caf8bc","msg":"User credentials created"}
{"level":30,"time":1768675326769,"env":"test","module":"email-queue","jobId":"a75cc0ab-d072-4d81-99c1-5f20c3ac512b","to":"protected-test-o7Scd9x60HrLOEKEJpCcp@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675326825,"env":"test","module":"auth-routes","userId":"8d8341d4-963d-4e31-90c7-3e7f28caf8bc","email":"protected-test-o7Scd9x60HrLOEKEJpCcp@example.com","msg":"User registered"}
{"level":30,"time":1768675327509,"env":"test","module":"auth-routes","userId":"8d8341d4-963d-4e31-90c7-3e7f28caf8bc","msg":"User logged in successfully"}
{"level":30,"time":1768675327570,"env":"test","module":"audit-log-service","userId":"8d8341d4-963d-4e31-90c7-3e7f28caf8bc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675328058,"env":"test","module":"user-credentials-repository","userId":"a2202000-b379-4b15-827a-7f10f4531ad0","msg":"User credentials created"}
{"level":30,"time":1768675328178,"env":"test","module":"email-queue","jobId":"3b0d5cf6-6887-4a11-8024-6855745a5f6e","to":"protected-test-J-wYV4670HjQpopnZzdPU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675328239,"env":"test","module":"auth-routes","userId":"a2202000-b379-4b15-827a-7f10f4531ad0","email":"protected-test-J-wYV4670HjQpopnZzdPU@example.com","msg":"User registered"}
{"level":30,"time":1768675328915,"env":"test","module":"auth-routes","userId":"a2202000-b379-4b15-827a-7f10f4531ad0","msg":"User logged in successfully"}
{"level":30,"time":1768675328970,"env":"test","module":"audit-log-service","userId":"a2202000-b379-4b15-827a-7f10f4531ad0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675329420,"env":"test","module":"user-credentials-repository","userId":"bf6a92c8-05f2-4c76-8f4d-b29db9730345","msg":"User credentials created"}
{"level":30,"time":1768675329532,"env":"test","module":"email-queue","jobId":"201a69f6-205a-42db-b9ae-d56b2dde87da","to":"protected-test-JMY3hNK13sW4i5XkfODkU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675329589,"env":"test","module":"auth-routes","userId":"bf6a92c8-05f2-4c76-8f4d-b29db9730345","email":"protected-test-JMY3hNK13sW4i5XkfODkU@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675330275,"env":"test","module":"auth-routes","userId":"bf6a92c8-05f2-4c76-8f4d-b29db9730345","msg":"User logged in successfully"}
{"level":30,"time":1768675330336,"env":"test","module":"audit-log-service","userId":"bf6a92c8-05f2-4c76-8f4d-b29db9730345","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675330817,"env":"test","module":"user-credentials-repository","userId":"ef5dcf08-4067-438e-b832-7092689e70bc","msg":"User credentials created"}
{"level":30,"time":1768675330935,"env":"test","module":"email-queue","jobId":"9bb275b7-e86b-4fac-a043-9ec13c47e066","to":"protected-test-hoyE5x0qEFg4xtQycs35u@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675330996,"env":"test","module":"auth-routes","userId":"ef5dcf08-4067-438e-b832-7092689e70bc","email":"protected-test-hoyE5x0qEFg4xtQycs35u@example.com","msg":"User registered"}
{"level":30,"time":1768675331725,"env":"test","module":"auth-routes","userId":"ef5dcf08-4067-438e-b832-7092689e70bc","msg":"User logged in successfully"}
{"level":30,"time":1768675331780,"env":"test","module":"audit-log-service","userId":"ef5dcf08-4067-438e-b832-7092689e70bc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675332666,"env":"test","module":"user-credentials-repository","userId":"f77bb1aa-8dfb-4e0c-9f34-8377fb35a7c7","msg":"User credentials created"}
{"level":30,"time":1768675332780,"env":"test","module":"email-queue","jobId":"38e46262-751f-42e3-9e7d-e73eb629b168","to":"protected-test-MXyuoLGhNa3evnr2cYGqX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675332837,"env":"test","module":"auth-routes","userId":"f77bb1aa-8dfb-4e0c-9f34-8377fb35a7c7","email":"protected-test-MXyuoLGhNa3evnr2cYGqX@example.com","msg":"User registered"}
{"level":30,"time":1768675333525,"env":"test","module":"auth-routes","userId":"f77bb1aa-8dfb-4e0c-9f34-8377fb35a7c7","msg":"User logged in successfully"}
{"level":30,"time":1768675333585,"env":"test","module":"audit-log-service","userId":"f77bb1aa-8dfb-4e0c-9f34-8377fb35a7c7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675334159,"env":"test","module":"auth-routes","userId":"f77bb1aa-8dfb-4e0c-9f34-8377fb35a7c7","msg":"User logged in successfully"}
{"level":30,"time":1768675334216,"env":"test","module":"audit-log-service","userId":"f77bb1aa-8dfb-4e0c-9f34-8377fb35a7c7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675334671,"env":"test","module":"user-credentials-repository","userId":"c8e334f7-9764-45fc-9f00-28ed22ee9a31","msg":"User credentials created"}
{"level":30,"time":1768675334789,"env":"test","module":"email-queue","jobId":"e3cf6405-ba54-4da0-9fec-9313b5c8ea7a","to":"protected-test-AGmPlgdaGu3c6euGq8P43@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675334845,"env":"test","module":"auth-routes","userId":"c8e334f7-9764-45fc-9f00-28ed22ee9a31","email":"protected-test-AGmPlgdaGu3c6euGq8P43@example.com","msg":"User registered"}
{"level":30,"time":1768675335530,"env":"test","module":"auth-routes","userId":"c8e334f7-9764-45fc-9f00-28ed22ee9a31","msg":"User logged in successfully"}
{"level":30,"time":1768675335589,"env":"test","module":"audit-log-service","userId":"c8e334f7-9764-45fc-9f00-28ed22ee9a31","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675336170,"env":"test","module":"auth-routes","userId":"c8e334f7-9764-45fc-9f00-28ed22ee9a31","msg":"User logged in successfully"}
{"level":30,"time":1768675336226,"env":"test","module":"audit-log-service","userId":"c8e334f7-9764-45fc-9f00-28ed22ee9a31","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675336625,"env":"test","module":"user-credentials-repository","userId":"d72ec850-55e3-41ee-9178-de6356238c93","msg":"User credentials created"}
{"level":30,"time":1768675336738,"env":"test","module":"email-queue","jobId":"53a967f5-6c45-45d1-b392-b71ddca5dd91","to":"user2-SPYJ_g6rAwFPIHYktdvXi@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675336794,"env":"test","module":"auth-routes","userId":"d72ec850-55e3-41ee-9178-de6356238c93","email":"user2-SPYJ_g6rAwFPIHYktdvXi@example.com","msg":"User registered"}
{"level":30,"time":1768675337359,"env":"test","module":"auth-routes","userId":"d72ec850-55e3-41ee-9178-de6356238c93","msg":"User logged in successfully"}
{"level":30,"time":1768675337416,"env":"test","module":"audit-log-service","userId":"d72ec850-55e3-41ee-9178-de6356238c93","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675337928,"env":"test","module":"user-credentials-repository","userId":"b89f9af6-dee2-40fb-bcf3-0084f6ec46bf","msg":"User credentials created"}
{"level":30,"time":1768675338048,"env":"test","module":"email-queue","jobId":"fba7dd19-3463-4665-a80c-98ce500889ec","to":"protected-test-_5JOtGoMgJSFQ8DKN91WH@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675338110,"env":"test","module":"auth-routes","userId":"b89f9af6-dee2-40fb-bcf3-0084f6ec46bf","email":"protected-test-_5JOtGoMgJSFQ8DKN91WH@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675338805,"env":"test","module":"auth-routes","userId":"b89f9af6-dee2-40fb-bcf3-0084f6ec46bf","msg":"User logged in successfully"}
{"level":30,"time":1768675338876,"env":"test","module":"audit-log-service","userId":"b89f9af6-dee2-40fb-bcf3-0084f6ec46bf","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675339471,"env":"test","module":"intake-service","runId":"90f8a7dc-fb1f-4e0b-817f-dde25d7aae48","slug":"public-dYki_xoUS4jdKn508PsIc","msg":"Created intake run"}
{"level":30,"time":1768675339915,"env":"test","module":"user-credentials-repository","userId":"70195c3f-282a-4a35-a1c6-2b956b483f8c","msg":"User credentials created"}
{"level":30,"time":1768675340035,"env":"test","module":"email-queue","jobId":"77828004-f966-472e-a47d-b60c65c381a1","to":"protected-test-ldQYqJIOITpKzn3tiW6Fh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675340103,"env":"test","module":"auth-routes","userId":"70195c3f-282a-4a35-a1c6-2b956b483f8c","email":"protected-test-ldQYqJIOITpKzn3tiW6Fh@example.com","msg":"User registered"}
{"level":30,"time":1768675340788,"env":"test","module":"auth-routes","userId":"70195c3f-282a-4a35-a1c6-2b956b483f8c","msg":"User logged in successfully"}
{"level":30,"time":1768675340846,"env":"test","module":"audit-log-service","userId":"70195c3f-282a-4a35-a1c6-2b956b483f8c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675341426,"env":"test","module":"intake-service","runId":"804ebdd5-d53b-4513-8c63-f65b2234e098","slug":"optional-2GF9GJRB3oNQpvMvbnRSi","userId":"70195c3f-282a-4a35-a1c6-2b956b483f8c","msg":"Created intake run"}
{"level":30,"time":1768675341892,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768675341893,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â£Ã´ tests/integration/auth/protected.routes.test.ts (33 tests | 1 skipped) 59801ms
       Î“Â£Ã´ should allow access with valid Bearer token  1450ms
       Î“Â£Ã´ should reject access without Authorization header  1342ms
       Î“Â£Ã´ should reject access with empty Bearer token  1384ms
       Î“Â£Ã´ should reject access with malformed Authorization header  1385ms
       Î“Â£Ã´ should reject access with wrong token type  1309ms
       Î“Â£Ã´ should allow POST with valid Bearer token  1403ms
       Î“Â£Ã´ should reject POST without Bearer token  1318ms
       Î“Â£Ã´ should reject POST with invalid token  1329ms
       Î“Â£Ã´ should allow PUT with valid Bearer token  1489ms
       Î“Â£Ã´ should reject PUT without Bearer token  1360ms
       Î“Â£Ã´ should allow DELETE with valid Bearer token  1521ms
       Î“Â£Ã´ should reject DELETE without Bearer token  1317ms
       Î“Â£Ã´ should allow PATCH with valid Bearer token  2105ms
       Î“Â£Ã´ should reject PATCH without Bearer token  1368ms
       Î“Â£Ã´ should handle Bearer token with extra spaces  1318ms
       Î“Â£Ã´ should handle very long invalid token  1380ms
       Î“Â£Ã´ should handle empty Authorization header  1363ms
       Î“Â£Ã´ should handle Authorization header with only Bearer  1335ms
       Î“Â£Ã´ should handle multiple Authorization headers  1300ms
       Î“Â£Ã´ should reject token with SQL injection attempt  1332ms
       Î“Â£Ã´ should reject token with XSS attempt  1299ms
       Î“Â£Ã´ should reject token with missing userId  1350ms
       Î“Â£Ã´ should reject token with non-existent userId  1443ms
       Î“Â£Ã´ should not allow user to access another user's resources  2618ms
       Î“Â£Ã´ should inject userId into request context  1371ms
       Î“Â£Ã´ should inject tenantId into request context  1399ms
       Î“Â£Ã´ should inject role into request context  1368ms
       Î“Â£Ã´ should not apply general rate limiting to authenticated requests  1835ms
       Î“Â£Ã´ should handle request with both Bearer token and cookies  2039ms
       Î“Â£Ã´ should prioritize Bearer token over cookie when both present  3258ms
       Î“Â£Ã´ should allow unauthenticated access to optional auth routes  1996ms
       Î“Â£Ã´ should enhance optional auth routes with user context when authenticated  2020ms

 Test Files  1 passed (1)
      Tests  32 passed | 1 skipped (33)
   Start at  12:40:53
   Duration  84.08s

 PASS  Waiting for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x3 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768675488557,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768675493473,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768675493524,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
Î“Ã…âŒ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: []

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768675495195,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768675495212,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768675495204,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768675495204,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768675495208,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768675495208,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768675495211,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768675495211,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768675495211,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768675495211,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768675495693,"env":"test","module":"user-credentials-repository","userId":"48319118-349b-4dd4-8b77-61170c424516","msg":"User credentials created"}
{"level":30,"time":1768675495818,"env":"test","module":"email-queue","jobId":"b825c881-78f8-4f84-b3c2-ed2c7e7b0297","to":"test-i5AQRj7jzWggcEXISfz8t@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675495881,"env":"test","module":"auth-routes","userId":"48319118-349b-4dd4-8b77-61170c424516","email":"test-i5AQRj7jzWggcEXISfz8t@example.com","msg":"User registered"}
{"level":30,"time":1768675496597,"env":"test","module":"user-credentials-repository","userId":"5290f85b-b625-40c6-9b1f-52237ca79ab6","msg":"User credentials created"}
{"level":30,"time":1768675496716,"env":"test","module":"email-queue","jobId":"54f11a1e-78d3-4a1a-a584-518eff4dfdb3","to":"protected-test-iEfxk1qsDo7qOvdR0pt20@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675496786,"env":"test","module":"auth-routes","userId":"5290f85b-b625-40c6-9b1f-52237ca79ab6","email":"protected-test-iEfxk1qsDo7qOvdR0pt20@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675497493,"env":"test","module":"auth-routes","userId":"5290f85b-b625-40c6-9b1f-52237ca79ab6","msg":"User logged in successfully"}
{"level":30,"time":1768675497567,"env":"test","module":"audit-log-service","userId":"5290f85b-b625-40c6-9b1f-52237ca79ab6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675498038,"env":"test","module":"user-credentials-repository","userId":"0abd8385-8ca4-43fa-b5fa-244d4a3e0a68","msg":"User credentials created"}
{"level":30,"time":1768675498159,"env":"test","module":"email-queue","jobId":"42c31eff-7f29-4a48-be2e-75eb49de125a","to":"protected-test-4E8v45cXJjx5dBEpnQMfR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675498219,"env":"test","module":"auth-routes","userId":"0abd8385-8ca4-43fa-b5fa-244d4a3e0a68","email":"protected-test-4E8v45cXJjx5dBEpnQMfR@example.com","msg":"User registered"}
{"level":30,"time":1768675499198,"env":"test","module":"user-credentials-repository","userId":"2982d756-900c-48c9-aba5-7da84945741a","msg":"User credentials created"}
{"level":30,"time":1768675499314,"env":"test","module":"email-queue","jobId":"fe12c174-91d4-429c-9567-f8e3d3143148","to":"protected-test-wcX7GbxsDSQKCxOapDySz@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675499393,"env":"test","module":"auth-routes","userId":"2982d756-900c-48c9-aba5-7da84945741a","email":"protected-test-wcX7GbxsDSQKCxOapDySz@example.com","msg":"User registered"}
{"level":30,"time":1768675500235,"env":"test","module":"user-credentials-repository","userId":"bb67fc63-6ccd-4ac1-9eb2-debe02b6a54b","msg":"User credentials created"}
{"level":30,"time":1768675500354,"env":"test","module":"email-queue","jobId":"048ade6c-2275-488b-b0d8-052ec20ef13d","to":"protected-test-IJucWXvAbqs1eAAdSowuY@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675500412,"env":"test","module":"auth-routes","userId":"bb67fc63-6ccd-4ac1-9eb2-debe02b6a54b","email":"protected-test-IJucWXvAbqs1eAAdSowuY@example.com","msg":"User registered"}
{"level":30,"time":1768675501208,"env":"test","module":"user-credentials-repository","userId":"502ce11c-ce3c-43f6-a74f-a657cf6b6e3b","msg":"User credentials created"}
{"level":30,"time":1768675501330,"env":"test","module":"email-queue","jobId":"816e2b4b-9082-4c01-b064-c4a73d0cbe39","to":"protected-test-qrHj13PAIyv-ZwZxV0L0q@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675501387,"env":"test","module":"auth-routes","userId":"502ce11c-ce3c-43f6-a74f-a657cf6b6e3b","email":"protected-test-qrHj13PAIyv-ZwZxV0L0q@example.com","msg":"User registered"}
{"level":30,"time":1768675502083,"env":"test","module":"user-credentials-repository","userId":"b5b2cdb3-f683-43e2-a440-de76758c5d2a","msg":"User credentials created"}
{"level":30,"time":1768675502183,"env":"test","module":"email-queue","jobId":"50327ca2-3a66-4950-95d0-9dd703aad3d0","to":"protected-test-T4pWIepO6WJEl-ZkZ8QkQ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675502232,"env":"test","module":"auth-routes","userId":"b5b2cdb3-f683-43e2-a440-de76758c5d2a","email":"protected-test-T4pWIepO6WJEl-ZkZ8QkQ@example.com","msg":"User registered"}
{"level":30,"time":1768675503010,"env":"test","module":"user-credentials-repository","userId":"85e9551f-5774-4c26-9748-778c914c955d","msg":"User credentials created"}
{"level":30,"time":1768675503130,"env":"test","module":"email-queue","jobId":"b733ce14-c427-490c-8260-90696fbaef30","to":"protected-test-WJKAm1RZjLtX7W9yf7BGh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675503193,"env":"test","module":"auth-routes","userId":"85e9551f-5774-4c26-9748-778c914c955d","email":"protected-test-WJKAm1RZjLtX7W9yf7BGh@example.com","msg":"User registered"}
{"level":30,"time":1768675504003,"env":"test","module":"user-credentials-repository","userId":"d4c93f9d-91e9-43c1-960b-6658782ae088","msg":"User credentials created"}
{"level":30,"time":1768675504129,"env":"test","module":"email-queue","jobId":"bae2a157-2d74-4b8f-b641-dea838f2c0e8","to":"protected-test-GViB3llU-ZX6O3RxGtdZi@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675504194,"env":"test","module":"auth-routes","userId":"d4c93f9d-91e9-43c1-960b-6658782ae088","email":"protected-test-GViB3llU-ZX6O3RxGtdZi@example.com","msg":"User registered"}
{"level":30,"time":1768675505003,"env":"test","module":"user-credentials-repository","userId":"4239880c-3848-4d6d-96b3-da4a674c7f62","msg":"User credentials created"}
{"level":30,"time":1768675505117,"env":"test","module":"email-queue","jobId":"9014286a-8a91-4f8b-a0fc-9910b2814e0e","to":"protected-test-fRR2fxVTTZWRc1V7S_9Cw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675505176,"env":"test","module":"auth-routes","userId":"4239880c-3848-4d6d-96b3-da4a674c7f62","email":"protected-test-fRR2fxVTTZWRc1V7S_9Cw@example.com","msg":"User registered"}
{"level":30,"time":1768675505989,"env":"test","module":"user-credentials-repository","userId":"a41258f5-4caa-4f80-9f55-5130016280a5","msg":"User credentials created"}
{"level":30,"time":1768675506104,"env":"test","module":"email-queue","jobId":"adc04792-d7ab-4d1c-8f4e-0f1e5ea8a4a2","to":"protected-test-Du6ryWg6PDbCdW_V6Z4Lx@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675506162,"env":"test","module":"auth-routes","userId":"a41258f5-4caa-4f80-9f55-5130016280a5","email":"protected-test-Du6ryWg6PDbCdW_V6Z4Lx@example.com","msg":"User registered"}
{"level":30,"time":1768675506986,"env":"test","module":"user-credentials-repository","userId":"d107e8bf-3dd2-4d1c-9139-79c8504206ed","msg":"User credentials created"}
{"level":30,"time":1768675507101,"env":"test","module":"email-queue","jobId":"4deda59b-ea63-4621-a511-db45176f38b7","to":"protected-test-Qy-fCvIq91uTwlKJwydd_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675507159,"env":"test","module":"auth-routes","userId":"d107e8bf-3dd2-4d1c-9139-79c8504206ed","email":"protected-test-Qy-fCvIq91uTwlKJwydd_@example.com","msg":"User registered"}
{"level":50,"time":1768675507964,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["bb4dbbbe-890b-46ec-96d9-482f507dfc15","$2b$12$lke7sEnVlJRpFyKfDAHXaegIac954fzUTyPwYFSD7AXDHjxN/n2lO"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(bb4dbbbe-890b-46ec-96d9-482f507dfc15) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"bb4dbbbe-890b-46ec-96d9-482f507dfc15","msg":"Failed to create user credentials"}
{"level":50,"time":1768675507964,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["bb4dbbbe-890b-46ec-96d9-482f507dfc15","$2b$12$lke7sEnVlJRpFyKfDAHXaegIac954fzUTyPwYFSD7AXDHjxN/n2lO"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(bb4dbbbe-890b-46ec-96d9-482f507dfc15) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675508614,"env":"test","module":"user-credentials-repository","userId":"38de482f-8834-4905-b1d7-e3eb69869475","msg":"User credentials created"}
{"level":30,"time":1768675508706,"env":"test","module":"email-queue","jobId":"12f3f66f-337b-4147-b345-8fa6cfaa81c0","to":"protected-test-FaALWZtrfgk8DbBzJSvT0@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675508761,"env":"test","module":"auth-routes","userId":"38de482f-8834-4905-b1d7-e3eb69869475","email":"protected-test-FaALWZtrfgk8DbBzJSvT0@example.com","msg":"User registered"}
{"level":30,"time":1768675509565,"env":"test","module":"user-credentials-repository","userId":"eb88f5ff-8692-49b5-9ffd-e22f4ecefbb8","msg":"User credentials created"}
{"level":30,"time":1768675509684,"env":"test","module":"email-queue","jobId":"16a0b327-7eeb-4699-8e8e-e6ae3917f3ee","to":"protected-test-mtLiBWC_FybOnOCf6k9YR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675509743,"env":"test","module":"auth-routes","userId":"eb88f5ff-8692-49b5-9ffd-e22f4ecefbb8","email":"protected-test-mtLiBWC_FybOnOCf6k9YR@example.com","msg":"User registered"}
{"level":30,"time":1768675510464,"env":"test","module":"user-credentials-repository","userId":"9eb4a9d8-9c23-461b-bd19-7734a583cab3","msg":"User credentials created"}
{"level":30,"time":1768675510563,"env":"test","module":"email-queue","jobId":"d6fb2341-3416-4930-a568-85f581fedcf5","to":"protected-test-zURRWrC3huZOzyglH5BDO@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675510612,"env":"test","module":"auth-routes","userId":"9eb4a9d8-9c23-461b-bd19-7734a583cab3","email":"protected-test-zURRWrC3huZOzyglH5BDO@example.com","msg":"User registered"}
{"level":50,"time":1768675511464,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["31714dd8-f661-47aa-8269-bcea467c2fc1","$2b$12$SyoY8.zAvhvKk1384HJbKuQh4Twu9wXCjTEfiX5Uw.9g9thDM/0DC"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(31714dd8-f661-47aa-8269-bcea467c2fc1) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"31714dd8-f661-47aa-8269-bcea467c2fc1","msg":"Failed to create user credentials"}
{"level":50,"time":1768675511464,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["31714dd8-f661-47aa-8269-bcea467c2fc1","$2b$12$SyoY8.zAvhvKk1384HJbKuQh4Twu9wXCjTEfiX5Uw.9g9thDM/0DC"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(31714dd8-f661-47aa-8269-bcea467c2fc1) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675512238,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["65ea0696-5a3c-4d35-b1b4-5fc9b3cd3de6","$2b$12$8EutLiZMiK0mkjwM0ocrLuVnpNirHcDdiarpPjv5uCpeqzC/.bzJ."],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(65ea0696-5a3c-4d35-b1b4-5fc9b3cd3de6) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"65ea0696-5a3c-4d35-b1b4-5fc9b3cd3de6","msg":"Failed to create user credentials"}
{"level":50,"time":1768675512238,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["65ea0696-5a3c-4d35-b1b4-5fc9b3cd3de6","$2b$12$8EutLiZMiK0mkjwM0ocrLuVnpNirHcDdiarpPjv5uCpeqzC/.bzJ."],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(65ea0696-5a3c-4d35-b1b4-5fc9b3cd3de6) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675512924,"env":"test","module":"user-credentials-repository","userId":"434989f6-8a5d-469d-b779-2cf1148662fe","msg":"User credentials created"}
{"level":30,"time":1768675513024,"env":"test","module":"email-queue","jobId":"c6d13e87-d2c5-4b21-adf2-13d063357933","to":"protected-test-Tzh-Kegit8BKgGjEOc3Hr@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675513076,"env":"test","module":"auth-routes","userId":"434989f6-8a5d-469d-b779-2cf1148662fe","email":"protected-test-Tzh-Kegit8BKgGjEOc3Hr@example.com","msg":"User registered"}
{"level":50,"time":1768675513236,"env":"test","module":"auth-routes","email":"protected-test-Tzh-Kegit8BKgGjEOc3Hr@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768675513370,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768675513751,"env":"test","module":"user-credentials-repository","userId":"1949e51d-b08a-48dc-8a2a-a3c627da1f16","msg":"User credentials created"}
{"level":30,"time":1768675513841,"env":"test","module":"email-queue","jobId":"10fbcc2f-ca42-41c8-9017-e06bc862532c","to":"protected-test-SwBSKSdyrGOkgKd7PyZmB@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675513891,"env":"test","module":"auth-routes","userId":"1949e51d-b08a-48dc-8a2a-a3c627da1f16","email":"protected-test-SwBSKSdyrGOkgKd7PyZmB@example.com","msg":"User registered"}
{"level":50,"time":1768675514725,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["707158e1-cec2-45b3-9da3-e9b22f0f327d","$2b$12$tZWt./y0nwtzqdXfgTpTne0DjKcbtdYikn7sh0Wv/D94ejj7hkLZG"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(707158e1-cec2-45b3-9da3-e9b22f0f327d) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"707158e1-cec2-45b3-9da3-e9b22f0f327d","msg":"Failed to create user credentials"}
{"level":50,"time":1768675514725,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["707158e1-cec2-45b3-9da3-e9b22f0f327d","$2b$12$tZWt./y0nwtzqdXfgTpTne0DjKcbtdYikn7sh0Wv/D94ejj7hkLZG"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(707158e1-cec2-45b3-9da3-e9b22f0f327d) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675515485,"env":"test","module":"user-credentials-repository","userId":"df8b5d2e-06d4-4099-8207-7cc480bdc9a9","msg":"User credentials created"}
{"level":30,"time":1768675515605,"env":"test","module":"email-queue","jobId":"5aead386-cb99-4480-8b9c-9ef6b8f3fe2d","to":"protected-test-OBoXY-3EAS4tU5zOKkTYk@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675515665,"env":"test","module":"auth-routes","userId":"df8b5d2e-06d4-4099-8207-7cc480bdc9a9","email":"protected-test-OBoXY-3EAS4tU5zOKkTYk@example.com","msg":"User registered"}
{"level":50,"time":1768675515953,"env":"test","module":"auth-routes","userId":"df8b5d2e-06d4-4099-8207-7cc480bdc9a9","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768675516070,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768675516474,"env":"test","module":"user-credentials-repository","userId":"5c924e26-d2d5-4c65-8077-874dc1e997c1","msg":"User credentials created"}
{"level":30,"time":1768675516591,"env":"test","module":"email-queue","jobId":"c9f9a283-ac74-4cfd-8596-7720436c8220","to":"protected-test-OGvxmUqPsp15AOPFmq74y@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768675516650,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["5c924e26-d2d5-4c65-8077-874dc1e997c1","172d37941a7ac5aa69dc21c006b2baf68cd06513d6d03da1b520e2338331881b","2026-02-16T18:45:16.592Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T18:45:16.592Z"],"cause":{"length":338,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5c924e26-d2d5-4c65-8077-874dc1e997c1) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675517396,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["ffb4b3e7-b421-4fba-9763-90a9bdabf8e4","$2b$12$9nEzsKDJSA3o6/24940Zv.kXh6XRp.z/QHwi.QBF33EKhH9zCpOLW"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(ffb4b3e7-b421-4fba-9763-90a9bdabf8e4) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"ffb4b3e7-b421-4fba-9763-90a9bdabf8e4","msg":"Failed to create user credentials"}
{"level":50,"time":1768675517396,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["ffb4b3e7-b421-4fba-9763-90a9bdabf8e4","$2b$12$9nEzsKDJSA3o6/24940Zv.kXh6XRp.z/QHwi.QBF33EKhH9zCpOLW"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(ffb4b3e7-b421-4fba-9763-90a9bdabf8e4) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675518026,"env":"test","module":"user-credentials-repository","userId":"d644596d-e994-4af3-8c03-ae87535bb14f","msg":"User credentials created"}
{"level":30,"time":1768675518119,"env":"test","module":"email-queue","jobId":"34a37824-c604-4c8a-b0c8-4fe60b9f2972","to":"protected-test-6f6Y5qfPVR5KsOkSG2FRl@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675518164,"env":"test","module":"auth-routes","userId":"d644596d-e994-4af3-8c03-ae87535bb14f","email":"protected-test-6f6Y5qfPVR5KsOkSG2FRl@example.com","msg":"User registered"}
{"level":50,"time":1768675518998,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["fb5e0c53-30a7-4bdf-86d8-bc2d4d67f79b","$2b$12$mrza2zyf3UjBjBCEYLy8LOZiCpY27gQWdAMWWK1lvAhgPP3wDuJO2"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(fb5e0c53-30a7-4bdf-86d8-bc2d4d67f79b) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"fb5e0c53-30a7-4bdf-86d8-bc2d4d67f79b","msg":"Failed to create user credentials"}
{"level":50,"time":1768675518998,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["fb5e0c53-30a7-4bdf-86d8-bc2d4d67f79b","$2b$12$mrza2zyf3UjBjBCEYLy8LOZiCpY27gQWdAMWWK1lvAhgPP3wDuJO2"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(fb5e0c53-30a7-4bdf-86d8-bc2d4d67f79b) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675519644,"env":"test","module":"user-credentials-repository","userId":"3287d596-5f74-44b9-840f-552e27e7dc20","msg":"User credentials created"}
{"level":30,"time":1768675519732,"env":"test","module":"email-queue","jobId":"e2a86e4c-104d-4a0b-983b-795395f32ee2","to":"protected-test-m-EolPypbWnA-nwY00rFR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675519784,"env":"test","module":"auth-routes","userId":"3287d596-5f74-44b9-840f-552e27e7dc20","email":"protected-test-m-EolPypbWnA-nwY00rFR@example.com","msg":"User registered"}
{"level":50,"time":1768675520587,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["bf8b61d0-a1ee-44e5-8a82-6e3ec857e9ae","$2b$12$s/GhwOF0SmEtjB.YuqiBvO9sxAZM8GkcU284bpj9hNQirNRwWbi9a"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(bf8b61d0-a1ee-44e5-8a82-6e3ec857e9ae) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"bf8b61d0-a1ee-44e5-8a82-6e3ec857e9ae","msg":"Failed to create user credentials"}
{"level":50,"time":1768675520587,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["bf8b61d0-a1ee-44e5-8a82-6e3ec857e9ae","$2b$12$s/GhwOF0SmEtjB.YuqiBvO9sxAZM8GkcU284bpj9hNQirNRwWbi9a"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(bf8b61d0-a1ee-44e5-8a82-6e3ec857e9ae) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675521327,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["c7a40bea-b838-49d3-9354-2c0dd2b353b4","$2b$12$Qa1Nf47ZJ.Tnlwt15btoi.cK2E8QaluF17OplPPtC844SFsEqbkw2"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c7a40bea-b838-49d3-9354-2c0dd2b353b4) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"c7a40bea-b838-49d3-9354-2c0dd2b353b4","msg":"Failed to create user credentials"}
{"level":50,"time":1768675521328,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["c7a40bea-b838-49d3-9354-2c0dd2b353b4","$2b$12$Qa1Nf47ZJ.Tnlwt15btoi.cK2E8QaluF17OplPPtC844SFsEqbkw2"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c7a40bea-b838-49d3-9354-2c0dd2b353b4) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675521987,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["60a9d751-eaf8-45a3-b405-26ef42908e77","$2b$12$xgob4PPtrrJE7GrmJMPXluqaFj/WHLseosmDYQyoRTAu2qO9C40Li"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(60a9d751-eaf8-45a3-b405-26ef42908e77) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"60a9d751-eaf8-45a3-b405-26ef42908e77","msg":"Failed to create user credentials"}
{"level":50,"time":1768675521987,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["60a9d751-eaf8-45a3-b405-26ef42908e77","$2b$12$xgob4PPtrrJE7GrmJMPXluqaFj/WHLseosmDYQyoRTAu2qO9C40Li"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(60a9d751-eaf8-45a3-b405-26ef42908e77) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675522745,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["80958647-2252-4dc9-8421-4edf0c8a9c06","$2b$12$ZVcq4qUGE/j4vzyZ1IiNd.r.PoE4ha5RQedyngL1kXq6NjjgPZpUq"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(80958647-2252-4dc9-8421-4edf0c8a9c06) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"80958647-2252-4dc9-8421-4edf0c8a9c06","msg":"Failed to create user credentials"}
{"level":50,"time":1768675522745,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["80958647-2252-4dc9-8421-4edf0c8a9c06","$2b$12$ZVcq4qUGE/j4vzyZ1IiNd.r.PoE4ha5RQedyngL1kXq6NjjgPZpUq"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(80958647-2252-4dc9-8421-4edf0c8a9c06) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675523383,"env":"test","module":"user-credentials-repository","userId":"217f7c3a-bf27-48e9-b176-3f470640b006","msg":"User credentials created"}
{"level":50,"time":1768675523435,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["217f7c3a-bf27-48e9-b176-3f470640b006","168e437e50c7e147d1f71ee7ed1cc679a4166b2d8cfc426612a58977854e638f","2026-01-18T18:45:23.384Z"],"cause":{"length":382,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(217f7c3a-bf27-48e9-b176-3f470640b006) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675524092,"env":"test","module":"user-credentials-repository","userId":"c16d24e9-826e-491e-b3cd-8afd0c8022aa","msg":"User credentials created"}
{"level":30,"time":1768675524188,"env":"test","module":"email-queue","jobId":"b1c951a7-0c17-417a-9db3-fb7015f19e12","to":"protected-test-bNwkKei1GiEUTK6qr1VIX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675524234,"env":"test","module":"auth-routes","userId":"c16d24e9-826e-491e-b3cd-8afd0c8022aa","email":"protected-test-bNwkKei1GiEUTK6qr1VIX@example.com","msg":"User registered"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768675524739,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768675524739,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
DEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:76:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 31 failed | 1 skipped) 32222ms
       Î“Â£Ã´ should allow access with valid Bearer token  1430ms
       â”œÃ¹ should reject access without Authorization header 779ms
       â”œÃ¹ should reject access with empty Bearer token 1043ms
       â”œÃ¹ should reject access with malformed Authorization header 1015ms
       â”œÃ¹ should reject access with wrong token type 978ms
       â”œÃ¹ should allow POST with valid Bearer token 832ms
       â”œÃ¹ should reject POST without Bearer token 977ms
       â”œÃ¹ should reject POST with invalid token 995ms
       â”œÃ¹ should allow PUT with valid Bearer token 989ms
       â”œÃ¹ should reject PUT without Bearer token 982ms
       â”œÃ¹ should allow DELETE with valid Bearer token 1000ms
       â”œÃ¹ should reject DELETE without Bearer token 745ms
       â”œÃ¹ should allow PATCH with valid Bearer token 844ms
       â”œÃ¹ should reject PATCH without Bearer token 992ms
       â”œÃ¹ should handle Bearer token with extra spaces 916ms
       Î“Ã¥Ã´ should handle token with newlines
       â”œÃ¹ should handle very long invalid token 747ms
       â”œÃ¹ should handle empty Authorization header 774ms
       â”œÃ¹ should handle Authorization header with only Bearer 1141ms
       â”œÃ¹ should handle multiple Authorization headers 561ms
       â”œÃ¹ should reject token with SQL injection attempt 785ms
       â”œÃ¹ should reject token with XSS attempt 1345ms
       â”œÃ¹ should reject token with missing userId 580ms
       â”œÃ¹ should reject token with non-existent userId 746ms
       â”œÃ¹ should not allow user to access another user's resources 865ms
       â”œÃ¹ should inject userId into request context 737ms
       â”œÃ¹ should inject tenantId into request context 833ms
       â”œÃ¹ should inject role into request context 755ms
       â”œÃ¹ should not apply general rate limiting to authenticated requests 741ms
       â”œÃ¹ should handle request with both Bearer token and cookies 660ms
       â”œÃ¹ should prioritize Bearer token over cookie when both present 758ms
       â”œÃ¹ should allow unauthenticated access to optional auth routes 691ms
       â”œÃ¹ should enhance optional auth routes with user context when authenticated 843ms

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 31 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
Error: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: e83294a4-670a-4b6c-9c07-72a3d483d38b,0abd8385-8ca4-43fa-b5fa-244d4a3e0a68,admin
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:71:13
     69|         // This fixes the 403 error in "Cross-User Authorization" test
     70|         if (ctx.orgId) {
     71|             await db.insert(organizationMemberships).values({
       |             ^
     72|                 orgId: ctx.orgId,
     73|                 userId: userId,

Caused by: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:71:13

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 388, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(e83294a4-670a-4b6c-9c07-72a3d483d38b) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/31]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: f39dba29-2b60-46ae-9431-eea672d1ed52,owner,true,2982d756-900c-48c9-aba5-7da84945741a
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f39dba29-2b60-46ae-9431-eea672d1ed52) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/31]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: f39dba29-2b60-46ae-9431-eea672d1ed52,owner,true,bb67fc63-6ccd-4ac1-9eb2-debe02b6a54b
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f39dba29-2b60-46ae-9431-eea672d1ed52) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/31]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: f39dba29-2b60-46ae-9431-eea672d1ed52,owner,true,502ce11c-ce3c-43f6-a74f-a657cf6b6e3b
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f39dba29-2b60-46ae-9431-eea672d1ed52) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/31]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: f39dba29-2b60-46ae-9431-eea672d1ed52,owner,true,b5b2cdb3-f683-43e2-a440-de76758c5d2a
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f39dba29-2b60-46ae-9431-eea672d1ed52) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/31]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: f39dba29-2b60-46ae-9431-eea672d1ed52,owner,true,85e9551f-5774-4c26-9748-778c914c955d
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f39dba29-2b60-46ae-9431-eea672d1ed52) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/31]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: f39dba29-2b60-46ae-9431-eea672d1ed52,owner,true,d4c93f9d-91e9-43c1-960b-6658782ae088
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f39dba29-2b60-46ae-9431-eea672d1ed52) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/31]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: f39dba29-2b60-46ae-9431-eea672d1ed52,owner,true,4239880c-3848-4d6d-96b3-da4a674c7f62
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f39dba29-2b60-46ae-9431-eea672d1ed52) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/31]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: f39dba29-2b60-46ae-9431-eea672d1ed52,owner,true,a41258f5-4caa-4f80-9f55-5130016280a5
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f39dba29-2b60-46ae-9431-eea672d1ed52) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/31]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: f39dba29-2b60-46ae-9431-eea672d1ed52,owner,true,d107e8bf-3dd2-4d1c-9139-79c8504206ed
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f39dba29-2b60-46ae-9431-eea672d1ed52) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/31]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
Error: expected 201 "Created", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:56:14
     54|             .post("/api/auth/register")
     55|             .send(testUser)
     56|             .expect(201);
       |              ^
     57| 
     58|         const userId = registerRes.body.user.id;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/31]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: f39dba29-2b60-46ae-9431-eea672d1ed52,owner,true,38de482f-8834-4905-b1d7-e3eb69869475
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f39dba29-2b60-46ae-9431-eea672d1ed52) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[12/31]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: f39dba29-2b60-46ae-9431-eea672d1ed52,owner,true,eb88f5ff-8692-49b5-9ffd-e22f4ecefbb8
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f39dba29-2b60-46ae-9431-eea672d1ed52) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[13/31]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
Error: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: e83294a4-670a-4b6c-9c07-72a3d483d38b,9eb4a9d8-9c23-461b-bd19-7734a583cab3,admin
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:71:13
     69|         // This fixes the 403 error in "Cross-User Authorization" test
     70|         if (ctx.orgId) {
     71|             await db.insert(organizationMemberships).values({
       |             ^
     72|                 orgId: ctx.orgId,
     73|                 userId: userId,

Caused by: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:71:13

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 388, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(e83294a4-670a-4b6c-9c07-72a3d483d38b) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[14/31]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:84:14
     82|                 password: testUser.password,
     83|             })
     84|             .expect(200);
       |              ^
     85| 
     86|         userToken = loginRes.body.token;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[15/31]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: f39dba29-2b60-46ae-9431-eea672d1ed52,owner,true,1949e51d-b08a-48dc-8a2a-a3c627da1f16
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f39dba29-2b60-46ae-9431-eea672d1ed52) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[16/31]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
Error: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: e83294a4-670a-4b6c-9c07-72a3d483d38b,d644596d-e994-4af3-8c03-ae87535bb14f,admin
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:71:13
     69|         // This fixes the 403 error in "Cross-User Authorization" test
     70|         if (ctx.orgId) {
     71|             await db.insert(organizationMemberships).values({
       |             ^
     72|                 orgId: ctx.orgId,
     73|                 userId: userId,

Caused by: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:71:13

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 388, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(e83294a4-670a-4b6c-9c07-72a3d483d38b) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[17/31]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: f39dba29-2b60-46ae-9431-eea672d1ed52,owner,true,3287d596-5f74-44b9-840f-552e27e7dc20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f39dba29-2b60-46ae-9431-eea672d1ed52) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[18/31]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: f39dba29-2b60-46ae-9431-eea672d1ed52,owner,true,c16d24e9-826e-491e-b3cd-8afd0c8022aa
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f39dba29-2b60-46ae-9431-eea672d1ed52) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[19/31]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  31 failed | 1 passed | 1 skipped (33)
   Start at  12:44:03
   Duration  75.43s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x4 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768678738866,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768678747118,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768678747160,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
Î“Ã…âŒ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: []

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768678748802,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768678748819,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768678748810,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768678748810,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768678748814,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768678748814,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768678748819,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768678748819,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768678748819,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768678748819,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768678749314,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["66a87534-bf8e-4470-90a2-30bddb222a01","$2b$12$zIdJnyrv/AwVgHW8wtQAC.1XVHBxH/JwX3doneMzBpJbZYnWlmpzi"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(66a87534-bf8e-4470-90a2-30bddb222a01) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"66a87534-bf8e-4470-90a2-30bddb222a01","msg":"Failed to create user credentials"}
{"level":50,"time":1768678749315,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["66a87534-bf8e-4470-90a2-30bddb222a01","$2b$12$zIdJnyrv/AwVgHW8wtQAC.1XVHBxH/JwX3doneMzBpJbZYnWlmpzi"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(66a87534-bf8e-4470-90a2-30bddb222a01) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768678749325,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768678749325,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 3160ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiÎ“Ã‡Âª
       |             ^
    115|     }
    116| 
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:38:49
   Duration  17.19s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x5 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768678769526,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768678777760,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768678777801,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:188:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: Too many connections attempts
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:188:11 {
    length: 50,
    severity: 'ERROR',
    code: 'XX000',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768678778171,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768678778191,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768678778179,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768678778179,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768678778184,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768678778185,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768678778190,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768678778190,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768678778191,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768678778191,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant KSM_0ZyRFR-5PnnmwlC3T,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant KSM_0ZyRFR-5PnnmwlC3T', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768678778500,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768678778500,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1771ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant KSM_0ZyRFR-5PnnmwlC3T,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:39:17
   Duration  17.69s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x6 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768678787258,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768678840770,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768678840829,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:191:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:191:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768678841159,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768678841178,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768678841167,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768678841167,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768678841172,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768678841172,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768678841177,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768678841177,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768678841177,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768678841178,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant VWWnVPVwi5jTYQ877L7SD,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant VWWnVPVwi5jTYQ877L7SD', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768678841511,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768678841511,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1706ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant VWWnVPVwi5jTYQ877L7SD,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:39:38
   Duration  62.26s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x7 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768679038632,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

{"level":30,"time":1768679125428,"env":"test","msg":"DB: initializing... Local"}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768679126229,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Database initialized. Current schema: test_schema_w122_v3
Î“Ã…âŒ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Applied failsafe schema fixes

{"level":30,"time":1768679128080,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768679128100,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768679128088,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768679128089,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768679128095,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768679128095,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768679128099,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768679128099,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768679128100,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768679128100,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768679129165,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["715a1659-3b60-4216-af30-5cda33d369a0","$2b$12$jB3.UT.7DhQYfrvnipanuuSSD3LiKZ8gfwWUucWcN/0JexzwzNDn2"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(715a1659-3b60-4216-af30-5cda33d369a0) is not present in table \"users\".","schema":"test_schema_w128_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"715a1659-3b60-4216-af30-5cda33d369a0","msg":"Failed to create user credentials"}
{"level":50,"time":1768679129165,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["715a1659-3b60-4216-af30-5cda33d369a0","$2b$12$jB3.UT.7DhQYfrvnipanuuSSD3LiKZ8gfwWUucWcN/0JexzwzNDn2"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(715a1659-3b60-4216-af30-5cda33d369a0) is not present in table \"users\".","schema":"test_schema_w128_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768679129181,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768679129181,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w77_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w77_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 4725ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiÎ“Ã‡Âª
       |             ^
    115|     }
    116| 
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:43:48
   Duration  99.75s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x8 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768679218978,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768679223702,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768679224173,"env":"test","msg":"DB: Set search_path on initial connection: \"test_schema_w0_v3\",public"}
{"level":30,"time":1768679224173,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public"}
{"level":30,"time":1768679226607,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768679227845,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768679227864,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768679227853,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768679227854,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768679227859,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768679227859,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768679227863,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768679227864,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768679227864,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768679227864,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768679228638,"env":"test","module":"user-credentials-repository","userId":"7d58e53c-6c97-4222-bfb3-f69572a058de","msg":"User credentials created"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Enforced search_path: test_schema_w0_v3, public

{"level":30,"time":1768679229037,"env":"test","module":"email-queue","jobId":"10aff0e4-286a-426a-99dd-b0b63d4c392c","to":"test-V_8YlobZMUJxvQxHPHh3-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679229202,"env":"test","module":"auth-routes","userId":"7d58e53c-6c97-4222-bfb3-f69572a058de","email":"test-V_8YlobZMUJxvQxHPHh3-@example.com","msg":"User registered"}
{"level":30,"time":1768679229263,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768679229263,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
Î“Ã…âŒ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: update "users" set "tenant_id" = $1, "role" = $2, "tenant_role" = $3 where "users"."id" = $4
params: dfd9c9dc-4a82-4e07-9430-4553bee35ca9,admin,owner,7d58e53c-6c97-4222-bfb3-f69572a058de
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:121:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'update "users" set "tenant_id" = $1, "role" = $2, "tenant_role" = $3 where "users"."id" = $4',
  params: [
    'dfd9c9dc-4a82-4e07-9430-4553bee35ca9',
    'admin',
    'owner',
    '7d58e53c-6c97-4222-bfb3-f69572a058de'
  ],
  cause: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:121:5)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 316,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (tenant_id)=(dfd9c9dc-4a82-4e07-9430-4553bee35ca9) is not present in table "tenants".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w154_v3',
    table: 'users',
    column: undefined,
    dataType: undefined,
    constraint: 'users_tenant_id_tenants_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 6410ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: update "users" set "tenant_id" = $1, "role" = $2, "tenant_role" = $3 where "users"."id" = $4
params: dfd9c9dc-4a82-4e07-9430-4553bee35ca9,admin,owner,7d58e53c-6c97-4222-bfb3-f69572a058de
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:121:5
    119| 
    120|     // Update user with tenant and roles
    121|     await db.update(schema.users)
       |     ^
    122|       .set({
    123|         tenantId,
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:121:5
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(dfd9c9dc-4a82-4e07-9430-4553bee35ca9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w154_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:46:49
   Duration  19.04s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x9 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768679495350,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768679498524,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768679498524,"env":"test","msg":"DB: Using test schema \"test_schema_w0_v3\" (from connection string options)"}
{"level":30,"time":1768679498576,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Database initialized. Current schema: test_schema_w38_v3
Î“Ã…âŒ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w38_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w38_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768679500344,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768679500362,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768679500351,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768679500351,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768679500356,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768679500356,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768679500362,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768679500362,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768679500362,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768679500362,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768679500903,"env":"test","module":"user-credentials-repository","userId":"5b584972-3979-47b5-b285-db61755cd27b","msg":"User credentials created"}
{"level":30,"time":1768679501016,"env":"test","module":"email-queue","jobId":"4fb390d5-3647-455b-8721-a01217235ed9","to":"test-8vo6Mb0muSVGlZWxxJWT2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679501077,"env":"test","module":"auth-routes","userId":"5b584972-3979-47b5-b285-db61755cd27b","email":"test-8vo6Mb0muSVGlZWxxJWT2@example.com","msg":"User registered"}
{"level":30,"time":1768679501815,"env":"test","module":"user-credentials-repository","userId":"5cf0da5a-806e-4353-a7b8-2e8c436aff0c","msg":"User credentials created"}
{"level":30,"time":1768679501932,"env":"test","module":"email-queue","jobId":"cff15685-d265-4d3f-ad31-705049e63fda","to":"protected-test-yDNUYcQlttlPvpJahR_H4@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679501993,"env":"test","module":"auth-routes","userId":"5cf0da5a-806e-4353-a7b8-2e8c436aff0c","email":"protected-test-yDNUYcQlttlPvpJahR_H4@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679502687,"env":"test","module":"auth-routes","userId":"5cf0da5a-806e-4353-a7b8-2e8c436aff0c","msg":"User logged in successfully"}
{"level":30,"time":1768679502744,"env":"test","module":"audit-log-service","userId":"5cf0da5a-806e-4353-a7b8-2e8c436aff0c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679503229,"env":"test","module":"user-credentials-repository","userId":"f95dcc34-3193-4851-ab89-1be21827fdc5","msg":"User credentials created"}
{"level":30,"time":1768679503341,"env":"test","module":"email-queue","jobId":"f66a634d-080b-4e12-bbe5-52fb7295e9ef","to":"protected-test-6B5fpwUPAZoq8nFBNGQ9b@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679503399,"env":"test","module":"auth-routes","userId":"f95dcc34-3193-4851-ab89-1be21827fdc5","email":"protected-test-6B5fpwUPAZoq8nFBNGQ9b@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679504075,"env":"test","module":"auth-routes","userId":"f95dcc34-3193-4851-ab89-1be21827fdc5","msg":"User logged in successfully"}
{"level":30,"time":1768679504142,"env":"test","module":"audit-log-service","userId":"f95dcc34-3193-4851-ab89-1be21827fdc5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679504147,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768679504554,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["33c839a6-1e38-453f-87a7-73879dacc918","$2b$12$EgR26D4G4TUOc4IV0kq/KutoRiCSeiOat3P5aaVB7V80wNhqFVli."],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(33c839a6-1e38-453f-87a7-73879dacc918) is not present in table \"users\".","schema":"test_schema_w139_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"33c839a6-1e38-453f-87a7-73879dacc918","msg":"Failed to create user credentials"}
{"level":50,"time":1768679504554,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["33c839a6-1e38-453f-87a7-73879dacc918","$2b$12$EgR26D4G4TUOc4IV0kq/KutoRiCSeiOat3P5aaVB7V80wNhqFVli."],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(33c839a6-1e38-453f-87a7-73879dacc918) is not present in table \"users\".","schema":"test_schema_w139_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768679505318,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["e5ceca15-6bd7-40b3-a28f-ab574c24b16d","$2b$12$uNunOOw67pOw3/35nOcXcuND.EmZ8l3ZNS9cCHXxkz41QuCbsKdNW"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(e5ceca15-6bd7-40b3-a28f-ab574c24b16d) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"e5ceca15-6bd7-40b3-a28f-ab574c24b16d","msg":"Failed to create user credentials"}
{"level":50,"time":1768679505318,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["e5ceca15-6bd7-40b3-a28f-ab574c24b16d","$2b$12$uNunOOw67pOw3/35nOcXcuND.EmZ8l3ZNS9cCHXxkz41QuCbsKdNW"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(e5ceca15-6bd7-40b3-a28f-ab574c24b16d) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768679506083,"env":"test","module":"user-credentials-repository","userId":"b301523d-5e4f-4508-bc82-de0787a94d0e","msg":"User credentials created"}
{"level":30,"time":1768679506203,"env":"test","module":"email-queue","jobId":"8444aa59-697a-4a56-b344-83005ab41724","to":"protected-test-o2fHHDhLyDnbTQtqp1FPe@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679506266,"env":"test","module":"auth-routes","userId":"b301523d-5e4f-4508-bc82-de0787a94d0e","email":"protected-test-o2fHHDhLyDnbTQtqp1FPe@example.com","msg":"User registered"}
{"level":30,"time":1768679506996,"env":"test","module":"auth-routes","userId":"b301523d-5e4f-4508-bc82-de0787a94d0e","msg":"User logged in successfully"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679507051,"env":"test","module":"audit-log-service","userId":"b301523d-5e4f-4508-bc82-de0787a94d0e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768679507055,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768679507055,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679507455,"env":"test","module":"user-credentials-repository","userId":"976ddc39-2def-48f0-90b4-9ce0bd41e0c6","msg":"User credentials created"}
{"level":30,"time":1768679507571,"env":"test","module":"email-queue","jobId":"da7245d5-807f-4a7c-a9eb-aab19df3fbdf","to":"protected-test-dRJ995JaHPeE1QDoHAG_H@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679507627,"env":"test","module":"auth-routes","userId":"976ddc39-2def-48f0-90b4-9ce0bd41e0c6","email":"protected-test-dRJ995JaHPeE1QDoHAG_H@example.com","msg":"User registered"}
{"level":50,"time":1768679507921,"env":"test","module":"auth-routes","userId":"976ddc39-2def-48f0-90b4-9ce0bd41e0c6","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768679508037,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768679508473,"env":"test","module":"user-credentials-repository","userId":"9a020adb-fcd9-413b-b9f4-d4ba549a80cd","msg":"User credentials created"}
{"level":30,"time":1768679508592,"env":"test","module":"email-queue","jobId":"f27b3313-5704-4cd4-8d1d-ad85eaf99966","to":"protected-test-czqbNsDznmSwYvPq_f8e6@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679508652,"env":"test","module":"auth-routes","userId":"9a020adb-fcd9-413b-b9f4-d4ba549a80cd","email":"protected-test-czqbNsDznmSwYvPq_f8e6@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768679509457,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["26e3aad6-dad1-43c1-a1a5-fca4bfe33319","$2b$12$e0cSWyM8mApD5iyhxsIOPuRjhO4UTzErbi395U07/tnDK3oZHv7Ja"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(26e3aad6-dad1-43c1-a1a5-fca4bfe33319) is not present in table \"users\".","schema":"test_schema_w139_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"26e3aad6-dad1-43c1-a1a5-fca4bfe33319","msg":"Failed to create user credentials"}
{"level":50,"time":1768679509458,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["26e3aad6-dad1-43c1-a1a5-fca4bfe33319","$2b$12$e0cSWyM8mApD5iyhxsIOPuRjhO4UTzErbi395U07/tnDK3oZHv7Ja"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(26e3aad6-dad1-43c1-a1a5-fca4bfe33319) is not present in table \"users\".","schema":"test_schema_w139_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768679510104,"env":"test","module":"user-credentials-repository","userId":"90d4a9fe-dd5a-43e7-bd59-b7832836a033","msg":"User credentials created"}
{"level":50,"time":1768679510207,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["90d4a9fe-dd5a-43e7-bd59-b7832836a033","08ad7bf02dd1d6bf998ee159f970af9493c8d5275ee2bf556e536c6b013ae713","2026-01-18T19:51:50.105Z"],"cause":{"length":382,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(90d4a9fe-dd5a-43e7-bd59-b7832836a033) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:76:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768679510848,"env":"test","module":"user-credentials-repository","userId":"5999f79f-efbd-4311-b764-1a443d850f93","msg":"User credentials created"}
{"level":30,"time":1768679510946,"env":"test","module":"email-queue","jobId":"951372a2-1ae6-4619-9e9f-5127ed1cdab5","to":"protected-test-X_RjPYPAKRrFDciLFFa0K@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679510992,"env":"test","module":"auth-routes","userId":"5999f79f-efbd-4311-b764-1a443d850f93","email":"protected-test-X_RjPYPAKRrFDciLFFa0K@example.com","msg":"User registered"}
{"level":30,"time":1768679511590,"env":"test","module":"auth-routes","userId":"5999f79f-efbd-4311-b764-1a443d850f93","msg":"User logged in successfully"}
{"level":30,"time":1768679511641,"env":"test","module":"audit-log-service","userId":"5999f79f-efbd-4311-b764-1a443d850f93","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679511645,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679512016,"env":"test","module":"user-credentials-repository","userId":"af3206b0-097b-4c9d-bac7-b9f46964167c","msg":"User credentials created"}
{"level":30,"time":1768679512110,"env":"test","module":"email-queue","jobId":"5c17bd54-da8e-48c5-8466-dce3862d2f60","to":"protected-test-LqbqmKG0nCK5w8F_N-pB7@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679512153,"env":"test","module":"auth-routes","userId":"af3206b0-097b-4c9d-bac7-b9f46964167c","email":"protected-test-LqbqmKG0nCK5w8F_N-pB7@example.com","msg":"User registered"}
{"level":30,"time":1768679512764,"env":"test","module":"auth-routes","userId":"af3206b0-097b-4c9d-bac7-b9f46964167c","msg":"User logged in successfully"}
{"level":30,"time":1768679512811,"env":"test","module":"audit-log-service","userId":"af3206b0-097b-4c9d-bac7-b9f46964167c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679513322,"env":"test","module":"user-credentials-repository","userId":"1c3a13de-0101-49fc-824a-5af655473c35","msg":"User credentials created"}
{"level":30,"time":1768679513415,"env":"test","module":"email-queue","jobId":"047d92cc-15ec-4cee-a4ac-a476df2f9b7a","to":"protected-test-XNiY88iPPoqHMHikVgudG@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768679513459,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["1c3a13de-0101-49fc-824a-5af655473c35","fe8b7197262f3400a833d1d27e3813616a2542dbb6942d74bb3e408bc8e99eb1","2026-02-16T19:51:53.416Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T19:51:53.416Z"],"cause":{"length":340,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(1c3a13de-0101-49fc-824a-5af655473c35) is not present in table \"users\".","schema":"test_schema_w139_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768679514113,"env":"test","module":"user-credentials-repository","userId":"e4504937-d3da-43d0-8985-9916d32a766a","msg":"User credentials created"}
{"level":30,"time":1768679514219,"env":"test","module":"email-queue","jobId":"71a22a16-cc4b-4e9f-b61e-636063a2372b","to":"protected-test---8xlR5hZr4U86rtQQMB9@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679514263,"env":"test","module":"auth-routes","userId":"e4504937-d3da-43d0-8985-9916d32a766a","email":"protected-test---8xlR5hZr4U86rtQQMB9@example.com","msg":"User registered"}
{"level":30,"time":1768679515061,"env":"test","module":"user-credentials-repository","userId":"a8319913-2e92-4754-9feb-9201e09cfa5f","msg":"User credentials created"}
{"level":50,"time":1768679515121,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["a8319913-2e92-4754-9feb-9201e09cfa5f","0f799b1939c24a1d04239790f338cf25a75269204cb5cfdcfba823b542f9ae81","2026-01-18T19:51:55.061Z"],"cause":{"length":382,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(a8319913-2e92-4754-9feb-9201e09cfa5f) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679515875,"env":"test","module":"user-credentials-repository","userId":"4d3edac9-4341-4b25-9167-209240ddceeb","msg":"User credentials created"}
{"level":30,"time":1768679515991,"env":"test","module":"email-queue","jobId":"8d5c6f26-651b-4da7-89f0-1c97540447a3","to":"protected-test-kn56EXsk-eWoSi1cQ1wBn@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679516050,"env":"test","module":"auth-routes","userId":"4d3edac9-4341-4b25-9167-209240ddceeb","email":"protected-test-kn56EXsk-eWoSi1cQ1wBn@example.com","msg":"User registered"}
{"level":50,"time":1768679516734,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["4d3edac9-4341-4b25-9167-209240ddceeb","151803b21197204803d77206d0aca8178a8e9956d7976f8b7e362ab5df116188","2026-02-16T19:51:56.675Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T19:51:56.675Z"],"cause":{"length":340,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(4d3edac9-4341-4b25-9167-209240ddceeb) is not present in table \"users\".","schema":"test_schema_w139_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
DEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: 4d3edac9-4341-4b25-9167-209240ddceeb,151803b21197204803d77206d0aca8178a8e9956d7976f8b7e362ab5df116188,2026-02-16T19:51:56.675Z,false,{"ip":"::1"},,::1,Location Unknown,2026-01-17T19:51:56.675Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
  query: 'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)',
  params: [
    '4d3edac9-4341-4b25-9167-209240ddceeb',
    '151803b21197204803d77206d0aca8178a8e9956d7976f8b7e362ab5df116188',
    '2026-02-16T19:51:56.675Z',
    false,
    '{"ip":"::1"}',
    null,
    '::1',
    'Location Unknown',
    '2026-01-17T19:51:56.675Z'
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
    length: 340,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(4d3edac9-4341-4b25-9167-209240ddceeb) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w139_v3',
    table: 'refresh_tokens',
    column: undefined,
    dataType: undefined,
    constraint: 'refresh_tokens_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":50,"time":1768679517380,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["f671bc0a-ee83-456c-8ec5-c0be271fe341","$2b$12$lh7ZIMyvL5ujIsQJCZ3JWu63Wyjo1Il2bJsarorAC.eZ/e7MFstHu"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f671bc0a-ee83-456c-8ec5-c0be271fe341) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"f671bc0a-ee83-456c-8ec5-c0be271fe341","msg":"Failed to create user credentials"}
{"level":50,"time":1768679517380,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["f671bc0a-ee83-456c-8ec5-c0be271fe341","$2b$12$lh7ZIMyvL5ujIsQJCZ3JWu63Wyjo1Il2bJsarorAC.eZ/e7MFstHu"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f671bc0a-ee83-456c-8ec5-c0be271fe341) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768679518028,"env":"test","module":"user-credentials-repository","userId":"7a909bb7-ae82-436e-92f0-4fcc2157dc73","msg":"User credentials created"}
{"level":30,"time":1768679518123,"env":"test","module":"email-queue","jobId":"b7e49a56-79e7-48a7-b63e-c142d440dcef","to":"protected-test-xZN0ZtUij48872W5Ack1v@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679518166,"env":"test","module":"auth-routes","userId":"7a909bb7-ae82-436e-92f0-4fcc2157dc73","email":"protected-test-xZN0ZtUij48872W5Ack1v@example.com","msg":"User registered"}
{"level":30,"time":1768679518755,"env":"test","module":"auth-routes","userId":"7a909bb7-ae82-436e-92f0-4fcc2157dc73","msg":"User logged in successfully"}
{"level":30,"time":1768679518801,"env":"test","module":"audit-log-service","userId":"7a909bb7-ae82-436e-92f0-4fcc2157dc73","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679518804,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679519200,"env":"test","module":"user-credentials-repository","userId":"07ec6ffa-3dd7-4cb7-a52a-198e12eda304","msg":"User credentials created"}
{"level":30,"time":1768679519293,"env":"test","module":"email-queue","jobId":"90f511c5-de8c-41be-9e96-1f87f4b26ed2","to":"protected-test-QzHQZ6KZ6NohYBdrx6ve6@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679519338,"env":"test","module":"auth-routes","userId":"07ec6ffa-3dd7-4cb7-a52a-198e12eda304","email":"protected-test-QzHQZ6KZ6NohYBdrx6ve6@example.com","msg":"User registered"}
{"level":30,"time":1768679519933,"env":"test","module":"auth-routes","userId":"07ec6ffa-3dd7-4cb7-a52a-198e12eda304","msg":"User logged in successfully"}
{"level":30,"time":1768679519980,"env":"test","module":"audit-log-service","userId":"07ec6ffa-3dd7-4cb7-a52a-198e12eda304","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679519984,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679520359,"env":"test","module":"user-credentials-repository","userId":"68699421-d46b-4e55-bc26-99af0835e280","msg":"User credentials created"}
{"level":30,"time":1768679520450,"env":"test","module":"email-queue","jobId":"10c3eb31-eccf-4bb7-ae48-a48566f4f9e7","to":"protected-test-Xv0a5ge15yNGrXeRkQcF5@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679520494,"env":"test","module":"auth-routes","userId":"68699421-d46b-4e55-bc26-99af0835e280","email":"protected-test-Xv0a5ge15yNGrXeRkQcF5@example.com","msg":"User registered"}
{"level":30,"time":1768679521114,"env":"test","module":"auth-routes","userId":"68699421-d46b-4e55-bc26-99af0835e280","msg":"User logged in successfully"}
{"level":30,"time":1768679521158,"env":"test","module":"audit-log-service","userId":"68699421-d46b-4e55-bc26-99af0835e280","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679521162,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679521553,"env":"test","module":"user-credentials-repository","userId":"9859bfa1-5193-4db6-99ec-7e56a5d416d5","msg":"User credentials created"}
{"level":30,"time":1768679521645,"env":"test","module":"email-queue","jobId":"abec62e2-57e0-4a16-ac6e-bae944a031a9","to":"protected-test-711ohbuGPB6owkN9yvUFV@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768679521689,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["9859bfa1-5193-4db6-99ec-7e56a5d416d5","31f5293903ac6f6846598d72832090f7dfec0cb40b073179ada2eed1478e1bc5","2026-02-16T19:52:01.645Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T19:52:01.645Z"],"cause":{"length":340,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(9859bfa1-5193-4db6-99ec-7e56a5d416d5) is not present in table \"users\".","schema":"test_schema_w139_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679522359,"env":"test","module":"user-credentials-repository","userId":"6cd91f0d-fee9-4f97-a359-f3abf6709eac","msg":"User credentials created"}
{"level":30,"time":1768679522450,"env":"test","module":"email-queue","jobId":"2f7a1f0d-ded8-49c3-bf2c-2ae430259f0c","to":"protected-test-TMJLzqkbyk-z6teKdr2eZ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679522508,"env":"test","module":"auth-routes","userId":"6cd91f0d-fee9-4f97-a359-f3abf6709eac","email":"protected-test-TMJLzqkbyk-z6teKdr2eZ@example.com","msg":"User registered"}
{"level":30,"time":1768679523117,"env":"test","module":"auth-routes","userId":"6cd91f0d-fee9-4f97-a359-f3abf6709eac","msg":"User logged in successfully"}
{"level":30,"time":1768679523161,"env":"test","module":"audit-log-service","userId":"6cd91f0d-fee9-4f97-a359-f3abf6709eac","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679523164,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679523536,"env":"test","module":"user-credentials-repository","userId":"f2bf9bc7-f6ce-4373-8ae1-52e7d2b21da9","msg":"User credentials created"}
{"level":30,"time":1768679523627,"env":"test","module":"email-queue","jobId":"89b9cb64-b696-4f34-a411-03ad7d308ceb","to":"protected-test-pubQB2wPeFTdtuvT3KGXR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679523670,"env":"test","module":"auth-routes","userId":"f2bf9bc7-f6ce-4373-8ae1-52e7d2b21da9","email":"protected-test-pubQB2wPeFTdtuvT3KGXR@example.com","msg":"User registered"}
{"level":50,"time":1768679524266,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["f2bf9bc7-f6ce-4373-8ae1-52e7d2b21da9","10c376fe1abb8bab0dd63266e8e324f0c48ba961e05d1eeae193397e5dea24e6","2026-02-16T19:52:04.223Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T19:52:04.223Z"],"cause":{"length":340,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f2bf9bc7-f6ce-4373-8ae1-52e7d2b21da9) is not present in table \"users\".","schema":"test_schema_w139_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
DEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768679524904,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["56413633-30d2-45c6-9752-a0bc640b43c4","$2b$12$3HEoN3UsVAWRxlAEZwTI7.Mo/uytmk/DIl2fg0xbRJN6tYk7dIQDG"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(56413633-30d2-45c6-9752-a0bc640b43c4) is not present in table \"users\".","schema":"test_schema_w139_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"56413633-30d2-45c6-9752-a0bc640b43c4","msg":"Failed to create user credentials"}
{"level":50,"time":1768679524904,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["56413633-30d2-45c6-9752-a0bc640b43c4","$2b$12$3HEoN3UsVAWRxlAEZwTI7.Mo/uytmk/DIl2fg0xbRJN6tYk7dIQDG"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(56413633-30d2-45c6-9752-a0bc640b43c4) is not present in table \"users\".","schema":"test_schema_w139_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768679525677,"env":"test","module":"user-credentials-repository","userId":"d8f5f910-d87e-4c41-980e-1a934fd032b8","msg":"User credentials created"}
{"level":30,"time":1768679525792,"env":"test","module":"email-queue","jobId":"67ac5136-5dc9-4496-b54b-0d7c7b702d64","to":"protected-test-V8xunzYwSJjs5obXayLM2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679525849,"env":"test","module":"auth-routes","userId":"d8f5f910-d87e-4c41-980e-1a934fd032b8","email":"protected-test-V8xunzYwSJjs5obXayLM2@example.com","msg":"User registered"}
{"level":30,"time":1768679526680,"env":"test","module":"user-credentials-repository","userId":"8d749d72-1b0b-477c-9ea4-7e48a788f055","msg":"User credentials created"}
{"level":30,"time":1768679526800,"env":"test","module":"email-queue","jobId":"5353d469-7263-45b5-bc9f-ac9e1c156818","to":"protected-test-iz_hsVa2uTKTet43PxZM-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679526862,"env":"test","module":"auth-routes","userId":"8d749d72-1b0b-477c-9ea4-7e48a788f055","email":"protected-test-iz_hsVa2uTKTet43PxZM-@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679527566,"env":"test","module":"user-credentials-repository","userId":"5de05733-ba76-46ab-83c2-d98ef1fd9097","msg":"User credentials created"}
{"level":30,"time":1768679527663,"env":"test","module":"email-queue","jobId":"133b8040-c5fe-4c9a-ab6c-6d8ffa52fcde","to":"protected-test-xTphw_Pas6B7UZj0HzR8G@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679527710,"env":"test","module":"auth-routes","userId":"5de05733-ba76-46ab-83c2-d98ef1fd9097","email":"protected-test-xTphw_Pas6B7UZj0HzR8G@example.com","msg":"User registered"}
{"level":30,"time":1768679528399,"env":"test","module":"user-credentials-repository","userId":"a5cbe03b-4409-4768-a92a-ebbd6a87c9ce","msg":"User credentials created"}
{"level":30,"time":1768679528489,"env":"test","module":"email-queue","jobId":"3dd33b62-db39-4450-8530-14c64cbaa94a","to":"protected-test-sgUhtTIbPX4b4nEOi-UAY@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679528536,"env":"test","module":"auth-routes","userId":"a5cbe03b-4409-4768-a92a-ebbd6a87c9ce","email":"protected-test-sgUhtTIbPX4b4nEOi-UAY@example.com","msg":"User registered"}
{"level":30,"time":1768679529337,"env":"test","module":"user-credentials-repository","userId":"41c5609b-523b-4ffb-9fce-3648d7fbe9d0","msg":"User credentials created"}
{"level":30,"time":1768679529452,"env":"test","module":"email-queue","jobId":"8cd94d68-1d44-4ce3-a487-d90415cf1b8a","to":"protected-test-BuFK8J9tWF2TAJhrPrC6N@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679529510,"env":"test","module":"auth-routes","userId":"41c5609b-523b-4ffb-9fce-3648d7fbe9d0","email":"protected-test-BuFK8J9tWF2TAJhrPrC6N@example.com","msg":"User registered"}
{"level":30,"time":1768679530316,"env":"test","module":"user-credentials-repository","userId":"704988b8-0b65-4062-b9b9-3375ec413e4d","msg":"User credentials created"}
{"level":30,"time":1768679530431,"env":"test","module":"email-queue","jobId":"71212228-04b6-4d35-a719-9b6114c9f081","to":"protected-test-HMDKwo2HC2dGcVmcMSePy@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679530487,"env":"test","module":"auth-routes","userId":"704988b8-0b65-4062-b9b9-3375ec413e4d","email":"protected-test-HMDKwo2HC2dGcVmcMSePy@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679531290,"env":"test","module":"user-credentials-repository","userId":"5691a044-6ddf-4f60-97fc-952c599ceb59","msg":"User credentials created"}
{"level":30,"time":1768679531378,"env":"test","module":"email-queue","jobId":"16720522-8deb-427a-9068-e3f93f28da25","to":"protected-test-0pff2sMC4LzT3Y4cYh9tr@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679531421,"env":"test","module":"auth-routes","userId":"5691a044-6ddf-4f60-97fc-952c599ceb59","email":"protected-test-0pff2sMC4LzT3Y4cYh9tr@example.com","msg":"User registered"}
{"level":30,"time":1768679532145,"env":"test","module":"user-credentials-repository","userId":"4d9be815-8a2b-41ad-8f18-a3a47abbe38e","msg":"User credentials created"}
{"level":30,"time":1768679532238,"env":"test","module":"email-queue","jobId":"dd63736e-5dbd-4647-a692-05ff35c1df9a","to":"protected-test-3R4zJ3h3SRlFtmHtbiyXV@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679532284,"env":"test","module":"auth-routes","userId":"4d9be815-8a2b-41ad-8f18-a3a47abbe38e","email":"protected-test-3R4zJ3h3SRlFtmHtbiyXV@example.com","msg":"User registered"}
{"level":30,"time":1768679532988,"env":"test","module":"user-credentials-repository","userId":"90555820-7573-4073-a62c-f3b92195e6dc","msg":"User credentials created"}
{"level":50,"time":1768679533041,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["90555820-7573-4073-a62c-f3b92195e6dc","4c687ac73dace6923920f5926dcad6be8714ea7c092cf631119811765edd18e4","2026-01-18T19:52:12.988Z"],"cause":{"length":382,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(90555820-7573-4073-a62c-f3b92195e6dc) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768679533410,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768679533411,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
DEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: f2bf9bc7-f6ce-4373-8ae1-52e7d2b21da9,10c376fe1abb8bab0dd63266e8e324f0c48ba961e05d1eeae193397e5dea24e6,2026-02-16T19:52:04.223Z,false,{"ip":"::1"},,::1,Location Unknown,2026-01-17T19:52:04.223Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
  query: 'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)',
  params: [
    'f2bf9bc7-f6ce-4373-8ae1-52e7d2b21da9',
    '10c376fe1abb8bab0dd63266e8e324f0c48ba961e05d1eeae193397e5dea24e6',
    '2026-02-16T19:52:04.223Z',
    false,
    '{"ip":"::1"}',
    null,
    '::1',
    'Location Unknown',
    '2026-01-17T19:52:04.223Z'
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
    length: 340,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(f2bf9bc7-f6ce-4373-8ae1-52e7d2b21da9) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w139_v3',
    table: 'refresh_tokens',
    column: undefined,
    dataType: undefined,
    constraint: 'refresh_tokens_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 23 failed | 1 skipped) 35704ms
       Î“Â£Ã´ should allow access with valid Bearer token  1421ms
       Î“Â£Ã´ should reject access without Authorization header  1320ms
       â”œÃ¹ should reject access with empty Bearer token 409ms
       â”œÃ¹ should reject access with malformed Authorization header 763ms
       Î“Â£Ã´ should reject access with wrong token type  1735ms
       â”œÃ¹ should allow POST with valid Bearer token 992ms
       â”œÃ¹ should reject POST without Bearer token 662ms
       â”œÃ¹ should reject POST with invalid token 749ms
       â”œÃ¹ should allow PUT with valid Bearer token 750ms
       Î“Â£Ã´ should reject PUT without Bearer token  1437ms
       Î“Â£Ã´ should allow DELETE with valid Bearer token  1310ms
       â”œÃ¹ should reject DELETE without Bearer token 504ms
       â”œÃ¹ should allow PATCH with valid Bearer token 852ms
       â”œÃ¹ should reject PATCH without Bearer token 809ms
       â”œÃ¹ should handle Bearer token with extra spaces 1618ms
       Î“Ã¥Ã´ should handle token with newlines
       â”œÃ¹ should handle very long invalid token 641ms
       Î“Â£Ã´ should handle empty Authorization header  1423ms
       Î“Â£Ã´ should handle Authorization header with only Bearer  1180ms
       Î“Â£Ã´ should handle multiple Authorization headers  1180ms
       â”œÃ¹ should reject token with SQL injection attempt 527ms
       Î“Â£Ã´ should reject token with XSS attempt  1474ms
       â”œÃ¹ should reject token with missing userId 1104ms
       â”œÃ¹ should reject token with non-existent userId 637ms
       â”œÃ¹ should not allow user to access another user's resources 1007ms
       â”œÃ¹ should inject userId into request context 1006ms
       â”œÃ¹ should inject tenantId into request context 837ms
       â”œÃ¹ should inject role into request context 831ms
       â”œÃ¹ should not apply general rate limiting to authenticated requests 981ms
       â”œÃ¹ should handle request with both Bearer token and cookies 1067ms
       â”œÃ¹ should prioritize Bearer token over cookie when both present 831ms
       â”œÃ¹ should allow unauthenticated access to optional auth routes 868ms
       â”œÃ¹ should enhance optional auth routes with user context when authenticated 709ms

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 23 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Error: expected 201 "Created", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:56:14
     54|             .post("/api/auth/register")
     55|             .send(testUser)
     56|             .expect(201);
       |              ^
     57| 
     58|         const userId = registerRes.body.user.id;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/23]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:84:14
     82|                 password: testUser.password,
     83|             })
     84|             .expect(200);
       |              ^
     85| 
     86|         userToken = loginRes.body.token;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/23]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 2dba08d8-c392-44d2-b877-ec4593a47e8d,owner,true,9a020adb-fcd9-413b-b9f4-d4ba549a80cd
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(2dba08d8-c392-44d2-b877-ec4593a47e8d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w139_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/23]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 2dba08d8-c392-44d2-b877-ec4593a47e8d,owner,true,e4504937-d3da-43d0-8985-9916d32a766a
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(2dba08d8-c392-44d2-b877-ec4593a47e8d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w139_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/23]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
Error: expected 200 "OK", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:84:14
     82|                 password: testUser.password,
     83|             })
     84|             .expect(200);
       |              ^
     85| 
     86|         userToken = loginRes.body.token;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/23]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 2dba08d8-c392-44d2-b877-ec4593a47e8d,owner,true,d8f5f910-d87e-4c41-980e-1a934fd032b8
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(2dba08d8-c392-44d2-b877-ec4593a47e8d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w139_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/23]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 2dba08d8-c392-44d2-b877-ec4593a47e8d,owner,true,8d749d72-1b0b-477c-9ea4-7e48a788f055
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(2dba08d8-c392-44d2-b877-ec4593a47e8d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w139_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/23]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 2dba08d8-c392-44d2-b877-ec4593a47e8d,owner,true,5de05733-ba76-46ab-83c2-d98ef1fd9097
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(2dba08d8-c392-44d2-b877-ec4593a47e8d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w139_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/23]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 2dba08d8-c392-44d2-b877-ec4593a47e8d,owner,true,a5cbe03b-4409-4768-a92a-ebbd6a87c9ce
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(2dba08d8-c392-44d2-b877-ec4593a47e8d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w139_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/23]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 2dba08d8-c392-44d2-b877-ec4593a47e8d,owner,true,41c5609b-523b-4ffb-9fce-3648d7fbe9d0
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(2dba08d8-c392-44d2-b877-ec4593a47e8d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w139_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/23]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 2dba08d8-c392-44d2-b877-ec4593a47e8d,owner,true,704988b8-0b65-4062-b9b9-3375ec413e4d
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(2dba08d8-c392-44d2-b877-ec4593a47e8d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w139_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/23]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 2dba08d8-c392-44d2-b877-ec4593a47e8d,owner,true,5691a044-6ddf-4f60-97fc-952c599ceb59
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(2dba08d8-c392-44d2-b877-ec4593a47e8d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w139_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[12/23]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 2dba08d8-c392-44d2-b877-ec4593a47e8d,owner,true,4d9be815-8a2b-41ad-8f18-a3a47abbe38e
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:60:9

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(2dba08d8-c392-44d2-b877-ec4593a47e8d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w139_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[13/23]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  23 failed | 9 passed | 1 skipped (33)
   Start at  13:47:44
   Duration  263.28s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x10 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768679567098,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768679593516,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768679593516,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w0_v3\",public on all connections"}
{"level":30,"time":1768679593553,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768679892559,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 600011ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
Error: Hook timed out in 300000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Î“Â¥Â» tests/setup.ts:114:1
    112| 
    113| // Global test hooks
    114| beforeAll(async () => {
       | ^
    115|   // Conditionally load jest-dom for UI tests (JSDOM environment)
    116|   if (typeof window !== 'undefined') {

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
Error: Hook timed out in 300000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Î“Â¥Â» tests/setup.ts:334:1
    332| });
    333| 
    334| afterAll(async () => {
       | ^
    335|   // Cleanup test database
    336|   console.log("â‰¡Æ’Âºâ•£ Cleaning up test environment...");

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:52:34
   Duration  634.59s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/helpers/schemaManager.ts x11 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768680389655,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768680394045,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768680394045,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w0_v3\",public on all connections"}
{"level":30,"time":1768680394135,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768680693100,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 600016ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
Error: Hook timed out in 300000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Î“Â¥Â» tests/setup.ts:114:1
    112| 
    113| // Global test hooks
    114| beforeAll(async () => {
       | ^
    115|   // Conditionally load jest-dom for UI tests (JSDOM environment)
    116|   if (typeof window !== 'undefined') {

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
Error: Hook timed out in 300000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Î“Â¥Â» tests/setup.ts:334:1
    332| });
    333| 
    334| afterAll(async () => {
       | ^
    335|   // Cleanup test database
    336|   console.log("â‰¡Æ’Âºâ•£ Cleaning up test environment...");

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:06:21
   Duration  611.25s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x12 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681267066,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681274124,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681274125,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w0_v3\",public on all connections"}
{"level":30,"time":1768681274217,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
Î“Ã…âŒ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681275793,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

{"level":30,"time":1768681275813,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768681275801,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681275802,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681275806,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681275807,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681275813,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681275813,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681275813,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681275813,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768681276354,"env":"test","module":"user-credentials-repository","userId":"3811ce03-7c6b-422b-9988-1340300dbc65","msg":"User credentials created"}
{"level":30,"time":1768681276452,"env":"test","module":"email-queue","jobId":"cf73f8a0-78c5-4b54-b139-7ff887396c5b","to":"test-8CtvgHwouHw5TwGESnCGK@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681276502,"env":"test","module":"auth-routes","userId":"3811ce03-7c6b-422b-9988-1340300dbc65","email":"test-8CtvgHwouHw5TwGESnCGK@example.com","msg":"User registered"}
{"level":30,"time":1768681277249,"env":"test","module":"user-credentials-repository","userId":"17c5ce55-b5d1-46a5-bb61-97d76044082a","msg":"User credentials created"}
{"level":30,"time":1768681277345,"env":"test","module":"email-queue","jobId":"975ca9fc-37b7-45d7-8bd1-ec2f01b8d14b","to":"protected-test-jmQkaI65kYIIl2x0vDk8d@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681277398,"env":"test","module":"auth-routes","userId":"17c5ce55-b5d1-46a5-bb61-97d76044082a","email":"protected-test-jmQkaI65kYIIl2x0vDk8d@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681278091,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["17c5ce55-b5d1-46a5-bb61-97d76044082a","bf8a134d69a5a99456cabb0b86d15d87dc615d620e877e6fc2795a9eedf8b8a1","2026-02-16T20:21:18.027Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T20:21:18.027Z"],"cause":{"length":327,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(17c5ce55-b5d1-46a5-bb61-97d76044082a) is not present in table \"users\".","schema":"public","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: 17c5ce55-b5d1-46a5-bb61-97d76044082a,bf8a134d69a5a99456cabb0b86d15d87dc615d620e877e6fc2795a9eedf8b8a1,2026-02-16T20:21:18.027Z,false,{"ip":"::1"},,::1,Location Unknown,2026-01-17T20:21:18.027Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
  query: 'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)',
  params: [
    '17c5ce55-b5d1-46a5-bb61-97d76044082a',
    'bf8a134d69a5a99456cabb0b86d15d87dc615d620e877e6fc2795a9eedf8b8a1',
    '2026-02-16T20:21:18.027Z',
    false,
    '{"ip":"::1"}',
    null,
    '::1',
    'Location Unknown',
    '2026-01-17T20:21:18.027Z'
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
    length: 327,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(17c5ce55-b5d1-46a5-bb61-97d76044082a) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'public',
    table: 'refresh_tokens',
    column: undefined,
    dataType: undefined,
    constraint: 'refresh_tokens_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":30,"time":1768681278981,"env":"test","module":"user-credentials-repository","userId":"df58c182-a722-4fb0-a2a8-fb639cf99f6a","msg":"User credentials created"}
{"level":30,"time":1768681279106,"env":"test","module":"email-queue","jobId":"3a63779c-290d-48fb-9163-f1279561a550","to":"protected-test-eOjCX6Y91vjYS7pTHORbt@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681279161,"env":"test","module":"auth-routes","userId":"df58c182-a722-4fb0-a2a8-fb639cf99f6a","email":"protected-test-eOjCX6Y91vjYS7pTHORbt@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681279902,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["df58c182-a722-4fb0-a2a8-fb639cf99f6a","7ea1ece8ec27003e234308503dd104067d91dcffb911e278e99a11b427d3c666","2026-02-16T20:21:19.840Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T20:21:19.840Z"],"cause":{"length":327,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(df58c182-a722-4fb0-a2a8-fb639cf99f6a) is not present in table \"users\".","schema":"public","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: df58c182-a722-4fb0-a2a8-fb639cf99f6a,7ea1ece8ec27003e234308503dd104067d91dcffb911e278e99a11b427d3c666,2026-02-16T20:21:19.840Z,false,{"ip":"::1"},,::1,Location Unknown,2026-01-17T20:21:19.840Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
  query: 'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)',
  params: [
    'df58c182-a722-4fb0-a2a8-fb639cf99f6a',
    '7ea1ece8ec27003e234308503dd104067d91dcffb911e278e99a11b427d3c666',
    '2026-02-16T20:21:19.840Z',
    false,
    '{"ip":"::1"}',
    null,
    '::1',
    'Location Unknown',
    '2026-01-17T20:21:19.840Z'
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
    length: 327,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(df58c182-a722-4fb0-a2a8-fb639cf99f6a) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'public',
    table: 'refresh_tokens',
    column: undefined,
    dataType: undefined,
    constraint: 'refresh_tokens_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":30,"time":1768681280760,"env":"test","module":"user-credentials-repository","userId":"0e7e83fc-9505-4806-a896-b72b6f2848af","msg":"User credentials created"}
{"level":30,"time":1768681280880,"env":"test","module":"email-queue","jobId":"b6046db9-f911-463d-9c56-b62929348265","to":"protected-test-QSoSSeU53_rCNKId0ky62@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681280942,"env":"test","module":"auth-routes","userId":"0e7e83fc-9505-4806-a896-b72b6f2848af","email":"protected-test-QSoSSeU53_rCNKId0ky62@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681281751,"env":"test","module":"auth-routes","userId":"0e7e83fc-9505-4806-a896-b72b6f2848af","msg":"User logged in successfully"}
{"level":30,"time":1768681281812,"env":"test","module":"audit-log-service","userId":"0e7e83fc-9505-4806-a896-b72b6f2848af","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681281819,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681282287,"env":"test","module":"user-credentials-repository","userId":"8b6676db-ec19-4e9a-b797-990086bfcb85","msg":"User credentials created"}
{"level":30,"time":1768681282408,"env":"test","module":"email-queue","jobId":"b199b200-a9f2-42ac-880a-7e13c7372c85","to":"protected-test-1PJ8k6gXUDz33k7QVqYcj@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681282464,"env":"test","module":"auth-routes","userId":"8b6676db-ec19-4e9a-b797-990086bfcb85","email":"protected-test-1PJ8k6gXUDz33k7QVqYcj@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681283233,"env":"test","module":"auth-routes","userId":"8b6676db-ec19-4e9a-b797-990086bfcb85","msg":"User logged in successfully"}
{"level":30,"time":1768681283289,"env":"test","module":"audit-log-service","userId":"8b6676db-ec19-4e9a-b797-990086bfcb85","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681283296,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681283770,"env":"test","module":"user-credentials-repository","userId":"627a61a6-333a-4b5b-9875-8ca2c80b993d","msg":"User credentials created"}
{"level":30,"time":1768681283891,"env":"test","module":"email-queue","jobId":"7aefafb2-05bc-40f8-9231-8c08f771de42","to":"protected-test-fxPeE6BkfVoT-Y0NR99Ru@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681283948,"env":"test","module":"auth-routes","userId":"627a61a6-333a-4b5b-9875-8ca2c80b993d","email":"protected-test-fxPeE6BkfVoT-Y0NR99Ru@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681284712,"env":"test","module":"auth-routes","userId":"627a61a6-333a-4b5b-9875-8ca2c80b993d","msg":"User logged in successfully"}
{"level":30,"time":1768681284774,"env":"test","module":"audit-log-service","userId":"627a61a6-333a-4b5b-9875-8ca2c80b993d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681284779,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768681284780,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681285330,"env":"test","module":"user-credentials-repository","userId":"d03dc8eb-cff8-41b7-86b9-a53894b54bbd","msg":"User credentials created"}
{"level":30,"time":1768681285447,"env":"test","module":"email-queue","jobId":"a06e0c97-8fee-474a-9e27-73e1b9f000a3","to":"protected-test-srUOszozg6bycHEjQ9JRa@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681285510,"env":"test","module":"auth-routes","userId":"d03dc8eb-cff8-41b7-86b9-a53894b54bbd","email":"protected-test-srUOszozg6bycHEjQ9JRa@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681286270,"env":"test","module":"auth-routes","userId":"d03dc8eb-cff8-41b7-86b9-a53894b54bbd","msg":"User logged in successfully"}
{"level":30,"time":1768681286331,"env":"test","module":"audit-log-service","userId":"d03dc8eb-cff8-41b7-86b9-a53894b54bbd","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681286844,"env":"test","module":"user-credentials-repository","userId":"c766cf3e-687f-48c4-b70f-048f9e09c016","msg":"User credentials created"}
{"level":30,"time":1768681286953,"env":"test","module":"email-queue","jobId":"2a367bb4-1b7b-4082-b5c9-2b1dbe7cf0fc","to":"protected-test-0x_FaJ_06yPPEz6Mh-o5j@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681287009,"env":"test","module":"auth-routes","userId":"c766cf3e-687f-48c4-b70f-048f9e09c016","email":"protected-test-0x_FaJ_06yPPEz6Mh-o5j@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681287748,"env":"test","module":"auth-routes","userId":"c766cf3e-687f-48c4-b70f-048f9e09c016","msg":"User logged in successfully"}
{"level":30,"time":1768681287806,"env":"test","module":"audit-log-service","userId":"c766cf3e-687f-48c4-b70f-048f9e09c016","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681287811,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681288245,"env":"test","module":"user-credentials-repository","userId":"590850a8-7ded-43a2-a8ac-3bcb6352ee14","msg":"User credentials created"}
{"level":30,"time":1768681288357,"env":"test","module":"email-queue","jobId":"7a1cba71-2f15-4366-a1d3-ab3731e72c24","to":"protected-test-0_gEDdGj2vzGp6g7gPWZp@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681288414,"env":"test","module":"auth-routes","userId":"590850a8-7ded-43a2-a8ac-3bcb6352ee14","email":"protected-test-0_gEDdGj2vzGp6g7gPWZp@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681289110,"env":"test","module":"auth-routes","userId":"590850a8-7ded-43a2-a8ac-3bcb6352ee14","msg":"User logged in successfully"}
{"level":30,"time":1768681289167,"env":"test","module":"audit-log-service","userId":"590850a8-7ded-43a2-a8ac-3bcb6352ee14","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681289171,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681289634,"env":"test","module":"user-credentials-repository","userId":"73a21ea2-b637-44bb-8dbe-2c9fb5048594","msg":"User credentials created"}
{"level":50,"time":1768681289699,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["73a21ea2-b637-44bb-8dbe-2c9fb5048594","c6c176eb2dc8f7bc2cc5940410f0b8a5b24668d9132ac31c647add77887cce97","2026-01-18T20:21:29.634Z"],"cause":{"length":371,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(73a21ea2-b637-44bb-8dbe-2c9fb5048594) is not present in table \"users\".","schema":"public","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681290472,"env":"test","module":"user-credentials-repository","userId":"46ea6e0b-b91d-4dfa-9c15-e4eb255934c2","msg":"User credentials created"}
{"level":30,"time":1768681290567,"env":"test","module":"email-queue","jobId":"b80be499-1fd7-4ea9-a638-7e488ee9fd98","to":"protected-test-b4N-aQKRR3740Hou_zuoJ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681290612,"env":"test","module":"auth-routes","userId":"46ea6e0b-b91d-4dfa-9c15-e4eb255934c2","email":"protected-test-b4N-aQKRR3740Hou_zuoJ@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681291301,"env":"test","module":"auth-routes","userId":"46ea6e0b-b91d-4dfa-9c15-e4eb255934c2","msg":"User logged in successfully"}
{"level":30,"time":1768681291347,"env":"test","module":"audit-log-service","userId":"46ea6e0b-b91d-4dfa-9c15-e4eb255934c2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681291353,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681291778,"env":"test","module":"user-credentials-repository","userId":"7750dcb1-0a14-4baa-ac3d-85ef1505ac75","msg":"User credentials created"}
{"level":30,"time":1768681291875,"env":"test","module":"email-queue","jobId":"5ebeb733-c47c-451b-9902-98f95dfe4068","to":"protected-test-JNucQze3KiXXrk8qh1J4D@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681291920,"env":"test","module":"auth-routes","userId":"7750dcb1-0a14-4baa-ac3d-85ef1505ac75","email":"protected-test-JNucQze3KiXXrk8qh1J4D@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681292578,"env":"test","module":"auth-routes","userId":"7750dcb1-0a14-4baa-ac3d-85ef1505ac75","msg":"User logged in successfully"}
{"level":30,"time":1768681292631,"env":"test","module":"audit-log-service","userId":"7750dcb1-0a14-4baa-ac3d-85ef1505ac75","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681293218,"env":"test","module":"user-credentials-repository","userId":"831a531a-c853-40d9-81ea-55e20de2df34","msg":"User credentials created"}
{"level":30,"time":1768681293311,"env":"test","module":"email-queue","jobId":"05727116-3f67-4881-875d-fec5082fe3aa","to":"protected-test-Lc6yx6O583d-MTyYFJXud@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681293363,"env":"test","module":"auth-routes","userId":"831a531a-c853-40d9-81ea-55e20de2df34","email":"protected-test-Lc6yx6O583d-MTyYFJXud@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681294038,"env":"test","module":"auth-routes","userId":"831a531a-c853-40d9-81ea-55e20de2df34","msg":"User logged in successfully"}
{"level":30,"time":1768681294082,"env":"test","module":"audit-log-service","userId":"831a531a-c853-40d9-81ea-55e20de2df34","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681294086,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681294515,"env":"test","module":"user-credentials-repository","userId":"0ad1b9f2-6f34-4f39-a813-45163dcb18eb","msg":"User credentials created"}
{"level":30,"time":1768681294607,"env":"test","module":"email-queue","jobId":"2a610ed5-ddb6-4cac-a423-89d5a5c6c60c","to":"protected-test-chbLeSWhPawMCImLohDnh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681294656,"env":"test","module":"auth-routes","userId":"0ad1b9f2-6f34-4f39-a813-45163dcb18eb","email":"protected-test-chbLeSWhPawMCImLohDnh@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681295291,"env":"test","module":"auth-routes","userId":"0ad1b9f2-6f34-4f39-a813-45163dcb18eb","msg":"User logged in successfully"}
{"level":30,"time":1768681295342,"env":"test","module":"audit-log-service","userId":"0ad1b9f2-6f34-4f39-a813-45163dcb18eb","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681296421,"env":"test","module":"user-credentials-repository","userId":"75382e71-0df2-4b35-bcb8-a3a7ad5576af","msg":"User credentials created"}
{"level":30,"time":1768681296519,"env":"test","module":"email-queue","jobId":"f2cd41d4-be78-4af7-9f14-354efeee67c0","to":"protected-test-4N7rDBn4YYaACSn5h2yDy@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681296563,"env":"test","module":"auth-routes","userId":"75382e71-0df2-4b35-bcb8-a3a7ad5576af","email":"protected-test-4N7rDBn4YYaACSn5h2yDy@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681297207,"env":"test","module":"auth-routes","userId":"75382e71-0df2-4b35-bcb8-a3a7ad5576af","msg":"User logged in successfully"}
{"level":30,"time":1768681297256,"env":"test","module":"audit-log-service","userId":"75382e71-0df2-4b35-bcb8-a3a7ad5576af","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681297263,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681297668,"env":"test","module":"user-credentials-repository","userId":"034a1c07-3c87-4ff6-af4d-315e77f98773","msg":"User credentials created"}
{"level":30,"time":1768681297767,"env":"test","module":"email-queue","jobId":"08a129d4-6482-405e-8e03-6f72e50ef6a2","to":"protected-test-gN4xev2gQMoihEfiHtIdA@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681297815,"env":"test","module":"auth-routes","userId":"034a1c07-3c87-4ff6-af4d-315e77f98773","email":"protected-test-gN4xev2gQMoihEfiHtIdA@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681298446,"env":"test","module":"auth-routes","userId":"034a1c07-3c87-4ff6-af4d-315e77f98773","msg":"User logged in successfully"}
{"level":30,"time":1768681298492,"env":"test","module":"audit-log-service","userId":"034a1c07-3c87-4ff6-af4d-315e77f98773","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681298499,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768681298499,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681298930,"env":"test","module":"user-credentials-repository","userId":"9ea08a00-0156-4f59-ab55-cc384f3d6818","msg":"User credentials created"}
{"level":30,"time":1768681299021,"env":"test","module":"email-queue","jobId":"086a58a6-2d77-46e0-80c4-0a0067980305","to":"protected-test-7l07CJZrzBzdbpSifAq-R@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681299074,"env":"test","module":"auth-routes","userId":"9ea08a00-0156-4f59-ab55-cc384f3d6818","email":"protected-test-7l07CJZrzBzdbpSifAq-R@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681299715,"env":"test","module":"auth-routes","userId":"9ea08a00-0156-4f59-ab55-cc384f3d6818","msg":"User logged in successfully"}
{"level":30,"time":1768681299763,"env":"test","module":"audit-log-service","userId":"9ea08a00-0156-4f59-ab55-cc384f3d6818","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681299768,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681300179,"env":"test","module":"user-credentials-repository","userId":"829a1526-9bfa-481a-b229-46240c0650b6","msg":"User credentials created"}
{"level":30,"time":1768681300274,"env":"test","module":"email-queue","jobId":"c4a09585-62b4-4101-96ce-3b5cd9e790bd","to":"protected-test-yWfQK4nmM1vijZJZuQqw-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681300323,"env":"test","module":"auth-routes","userId":"829a1526-9bfa-481a-b229-46240c0650b6","email":"protected-test-yWfQK4nmM1vijZJZuQqw-@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681301064,"env":"test","module":"auth-routes","userId":"829a1526-9bfa-481a-b229-46240c0650b6","msg":"User logged in successfully"}
{"level":30,"time":1768681301133,"env":"test","module":"audit-log-service","userId":"829a1526-9bfa-481a-b229-46240c0650b6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681301139,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681301539,"env":"test","module":"user-credentials-repository","userId":"de2ec945-7abf-4231-96a7-6cecfb66c484","msg":"User credentials created"}
{"level":30,"time":1768681301637,"env":"test","module":"email-queue","jobId":"9b403d5d-b997-485b-8f8c-3f1a1246f8de","to":"protected-test-Gx0tVrg0d2C_qLXMGAUuL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681301689,"env":"test","module":"auth-routes","userId":"de2ec945-7abf-4231-96a7-6cecfb66c484","email":"protected-test-Gx0tVrg0d2C_qLXMGAUuL@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681302327,"env":"test","module":"auth-routes","userId":"de2ec945-7abf-4231-96a7-6cecfb66c484","msg":"User logged in successfully"}
{"level":30,"time":1768681302378,"env":"test","module":"audit-log-service","userId":"de2ec945-7abf-4231-96a7-6cecfb66c484","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681302383,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681302793,"env":"test","module":"user-credentials-repository","userId":"33559839-f8de-4c46-a4b6-1449f3fca0bc","msg":"User credentials created"}
{"level":30,"time":1768681302898,"env":"test","module":"email-queue","jobId":"9cd2b763-8d48-4663-abd0-87e9e6741549","to":"protected-test-HV_f4xS8FSmdF60kd17p7@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681302944,"env":"test","module":"auth-routes","userId":"33559839-f8de-4c46-a4b6-1449f3fca0bc","email":"protected-test-HV_f4xS8FSmdF60kd17p7@example.com","msg":"User registered"}
{"level":30,"time":1768681303559,"env":"test","module":"auth-routes","userId":"33559839-f8de-4c46-a4b6-1449f3fca0bc","msg":"User logged in successfully"}
{"level":30,"time":1768681303608,"env":"test","module":"audit-log-service","userId":"33559839-f8de-4c46-a4b6-1449f3fca0bc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681303613,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681303992,"env":"test","module":"user-credentials-repository","userId":"524575a1-d2f2-4cb8-ab45-50d6fce8c8ad","msg":"User credentials created"}
{"level":30,"time":1768681304087,"env":"test","module":"email-queue","jobId":"20eeb554-2b52-45dc-8e47-2eda5519cab4","to":"protected-test-CqGECod2nEsvPW0zjL1Fq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681304136,"env":"test","module":"auth-routes","userId":"524575a1-d2f2-4cb8-ab45-50d6fce8c8ad","email":"protected-test-CqGECod2nEsvPW0zjL1Fq@example.com","msg":"User registered"}
{"level":30,"time":1768681304759,"env":"test","module":"auth-routes","userId":"524575a1-d2f2-4cb8-ab45-50d6fce8c8ad","msg":"User logged in successfully"}
{"level":30,"time":1768681304807,"env":"test","module":"audit-log-service","userId":"524575a1-d2f2-4cb8-ab45-50d6fce8c8ad","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681304811,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681305192,"env":"test","module":"user-credentials-repository","userId":"972deefd-72b4-478e-86ad-ab1f7fa01d3c","msg":"User credentials created"}
{"level":30,"time":1768681305289,"env":"test","module":"email-queue","jobId":"acd56e5b-77d2-4046-8cba-356158b5a1e8","to":"protected-test-8NQcMr7-gw0yg3EJO3Pv3@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681305336,"env":"test","module":"auth-routes","userId":"972deefd-72b4-478e-86ad-ab1f7fa01d3c","email":"protected-test-8NQcMr7-gw0yg3EJO3Pv3@example.com","msg":"User registered"}
{"level":30,"time":1768681305941,"env":"test","module":"auth-routes","userId":"972deefd-72b4-478e-86ad-ab1f7fa01d3c","msg":"User logged in successfully"}
{"level":30,"time":1768681305987,"env":"test","module":"audit-log-service","userId":"972deefd-72b4-478e-86ad-ab1f7fa01d3c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681305990,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681306369,"env":"test","module":"user-credentials-repository","userId":"7f6eafbb-6163-4ddd-b3dd-f0b974bb3e21","msg":"User credentials created"}
{"level":30,"time":1768681306470,"env":"test","module":"email-queue","jobId":"c2dc3edf-77a0-46ee-a781-57340f28c935","to":"protected-test-Ty3PlFP9eeWkHOuaLF04j@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681306514,"env":"test","module":"auth-routes","userId":"7f6eafbb-6163-4ddd-b3dd-f0b974bb3e21","email":"protected-test-Ty3PlFP9eeWkHOuaLF04j@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681307111,"env":"test","module":"auth-routes","userId":"7f6eafbb-6163-4ddd-b3dd-f0b974bb3e21","msg":"User logged in successfully"}
{"level":30,"time":1768681307156,"env":"test","module":"audit-log-service","userId":"7f6eafbb-6163-4ddd-b3dd-f0b974bb3e21","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681307541,"env":"test","module":"user-credentials-repository","userId":"2702b398-d341-4101-bb1d-f7f75f0d5f01","msg":"User credentials created"}
{"level":30,"time":1768681307634,"env":"test","module":"email-queue","jobId":"3533df01-4bd9-41e4-ba45-e410d6594650","to":"protected-test-QIzSue6bqM7cTSwlP1jIF@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681307682,"env":"test","module":"auth-routes","userId":"2702b398-d341-4101-bb1d-f7f75f0d5f01","email":"protected-test-QIzSue6bqM7cTSwlP1jIF@example.com","msg":"User registered"}
{"level":30,"time":1768681308269,"env":"test","module":"auth-routes","userId":"2702b398-d341-4101-bb1d-f7f75f0d5f01","msg":"User logged in successfully"}
{"level":30,"time":1768681308318,"env":"test","module":"audit-log-service","userId":"2702b398-d341-4101-bb1d-f7f75f0d5f01","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681308790,"env":"test","module":"user-credentials-repository","userId":"beac97c0-b219-4c67-b6d0-173b9265dd63","msg":"User credentials created"}
{"level":30,"time":1768681308888,"env":"test","module":"email-queue","jobId":"a3c01b4f-c36d-459d-94e4-f742396a3ed6","to":"protected-test-AWINnqBD_a6X9CjizySBg@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681308936,"env":"test","module":"auth-routes","userId":"beac97c0-b219-4c67-b6d0-173b9265dd63","email":"protected-test-AWINnqBD_a6X9CjizySBg@example.com","msg":"User registered"}
{"level":30,"time":1768681309530,"env":"test","module":"auth-routes","userId":"beac97c0-b219-4c67-b6d0-173b9265dd63","msg":"User logged in successfully"}
{"level":30,"time":1768681309577,"env":"test","module":"audit-log-service","userId":"beac97c0-b219-4c67-b6d0-173b9265dd63","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681309971,"env":"test","module":"user-credentials-repository","userId":"23a7474b-534d-46d2-9e53-4c636e8e137b","msg":"User credentials created"}
{"level":30,"time":1768681310072,"env":"test","module":"email-queue","jobId":"d0f3ff8e-bb7f-44f9-9d28-25cc23bbff65","to":"user2-_yIj4OB-TlU9qCUYT1hB4@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681310121,"env":"test","module":"auth-routes","userId":"23a7474b-534d-46d2-9e53-4c636e8e137b","email":"user2-_yIj4OB-TlU9qCUYT1hB4@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681310701,"env":"test","module":"auth-routes","userId":"23a7474b-534d-46d2-9e53-4c636e8e137b","msg":"User logged in successfully"}
{"level":30,"time":1768681310747,"env":"test","module":"audit-log-service","userId":"23a7474b-534d-46d2-9e53-4c636e8e137b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681310809,"env":"test","module":"rbac-middleware","userId":"23a7474b-534d-46d2-9e53-4c636e8e137b","userRole":"viewer","permission":"project:delete","path":"/a693ca5b-dc00-4215-9825-648dd57a2694","msg":"Permission denied"}
{"level":30,"time":1768681311187,"env":"test","module":"user-credentials-repository","userId":"5ce3714b-a498-4a87-9ef1-06eb8eed6114","msg":"User credentials created"}
{"level":30,"time":1768681311279,"env":"test","module":"email-queue","jobId":"58fad76e-25e7-4886-9fbc-7f7a1075b5ae","to":"protected-test-dW_P9nXfFxFPPwzlGFoAf@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681311330,"env":"test","module":"auth-routes","userId":"5ce3714b-a498-4a87-9ef1-06eb8eed6114","email":"protected-test-dW_P9nXfFxFPPwzlGFoAf@example.com","msg":"User registered"}
{"level":30,"time":1768681311950,"env":"test","module":"auth-routes","userId":"5ce3714b-a498-4a87-9ef1-06eb8eed6114","msg":"User logged in successfully"}
{"level":30,"time":1768681311995,"env":"test","module":"audit-log-service","userId":"5ce3714b-a498-4a87-9ef1-06eb8eed6114","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681312431,"env":"test","module":"user-credentials-repository","userId":"6e5ee89c-8c76-4430-b143-637e997b4f05","msg":"User credentials created"}
{"level":30,"time":1768681312549,"env":"test","module":"email-queue","jobId":"6c566ad2-39a6-499a-a4f7-dde7d59c1fdb","to":"protected-test-a6ceBp6X7LxpU8QeA3H0P@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681312594,"env":"test","module":"auth-routes","userId":"6e5ee89c-8c76-4430-b143-637e997b4f05","email":"protected-test-a6ceBp6X7LxpU8QeA3H0P@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681313222,"env":"test","module":"auth-routes","userId":"6e5ee89c-8c76-4430-b143-637e997b4f05","msg":"User logged in successfully"}
{"level":30,"time":1768681313272,"env":"test","module":"audit-log-service","userId":"6e5ee89c-8c76-4430-b143-637e997b4f05","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681313707,"env":"test","module":"user-credentials-repository","userId":"3cbb3402-423a-4f37-8737-734e161ea0d2","msg":"User credentials created"}
{"level":30,"time":1768681313796,"env":"test","module":"email-queue","jobId":"2aa842ed-bffd-4996-891c-3c608e169794","to":"protected-test-CQ5WEm0OKnzP67gubauAd@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681313845,"env":"test","module":"auth-routes","userId":"3cbb3402-423a-4f37-8737-734e161ea0d2","email":"protected-test-CQ5WEm0OKnzP67gubauAd@example.com","msg":"User registered"}
{"level":30,"time":1768681314486,"env":"test","module":"auth-routes","userId":"3cbb3402-423a-4f37-8737-734e161ea0d2","msg":"User logged in successfully"}
{"level":30,"time":1768681314530,"env":"test","module":"audit-log-service","userId":"3cbb3402-423a-4f37-8737-734e161ea0d2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681314955,"env":"test","module":"user-credentials-repository","userId":"eb895786-0475-4c2e-a251-daad0d05d24d","msg":"User credentials created"}
{"level":30,"time":1768681315052,"env":"test","module":"email-queue","jobId":"e1917604-1c68-497e-9c1d-5fe2b542f19d","to":"protected-test-rLS-mUfP9s0Nz_ztKaqf_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681315096,"env":"test","module":"auth-routes","userId":"eb895786-0475-4c2e-a251-daad0d05d24d","email":"protected-test-rLS-mUfP9s0Nz_ztKaqf_@example.com","msg":"User registered"}
{"level":30,"time":1768681315703,"env":"test","module":"auth-routes","userId":"eb895786-0475-4c2e-a251-daad0d05d24d","msg":"User logged in successfully"}
{"level":30,"time":1768681315747,"env":"test","module":"audit-log-service","userId":"eb895786-0475-4c2e-a251-daad0d05d24d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681316674,"env":"test","module":"user-credentials-repository","userId":"1ec28d22-089f-462b-b3f8-df09b24d309c","msg":"User credentials created"}
{"level":30,"time":1768681316787,"env":"test","module":"email-queue","jobId":"28d73073-8660-4e5c-8d1c-b100280b0a1b","to":"protected-test-o_GyE5B3bzAZtxMG5RCKV@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681316850,"env":"test","module":"auth-routes","userId":"1ec28d22-089f-462b-b3f8-df09b24d309c","email":"protected-test-o_GyE5B3bzAZtxMG5RCKV@example.com","msg":"User registered"}
{"level":30,"time":1768681317573,"env":"test","module":"auth-routes","userId":"1ec28d22-089f-462b-b3f8-df09b24d309c","msg":"User logged in successfully"}
{"level":30,"time":1768681317629,"env":"test","module":"audit-log-service","userId":"1ec28d22-089f-462b-b3f8-df09b24d309c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681318249,"env":"test","module":"auth-routes","userId":"1ec28d22-089f-462b-b3f8-df09b24d309c","msg":"User logged in successfully"}
{"level":30,"time":1768681318306,"env":"test","module":"audit-log-service","userId":"1ec28d22-089f-462b-b3f8-df09b24d309c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681318832,"env":"test","module":"user-credentials-repository","userId":"42e44885-3831-464c-96de-f9a8cbbed133","msg":"User credentials created"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681318947,"env":"test","module":"email-queue","jobId":"835e9900-6714-4e7e-a88c-5e8f34dce479","to":"protected-test-08LYPyoff2MjPL_p4LWid@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681319003,"env":"test","module":"auth-routes","userId":"42e44885-3831-464c-96de-f9a8cbbed133","email":"protected-test-08LYPyoff2MjPL_p4LWid@example.com","msg":"User registered"}
{"level":30,"time":1768681319812,"env":"test","module":"auth-routes","userId":"42e44885-3831-464c-96de-f9a8cbbed133","msg":"User logged in successfully"}
{"level":30,"time":1768681319870,"env":"test","module":"audit-log-service","userId":"42e44885-3831-464c-96de-f9a8cbbed133","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681320053,"env":"test","module":"auth-routes","userId":"42e44885-3831-464c-96de-f9a8cbbed133","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768681320176,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1768681320619,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["95c8a067-b081-460e-9702-7def25c99e7e","$2b$12$CDZjvhS/7OHml4mrcLNQj.u3AWk7JV4XQbPy0q2QxcglGiGkAEfG."],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(95c8a067-b081-460e-9702-7def25c99e7e) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"95c8a067-b081-460e-9702-7def25c99e7e","msg":"Failed to create user credentials"}
{"level":50,"time":1768681320619,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["95c8a067-b081-460e-9702-7def25c99e7e","$2b$12$CDZjvhS/7OHml4mrcLNQj.u3AWk7JV4XQbPy0q2QxcglGiGkAEfG."],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(95c8a067-b081-460e-9702-7def25c99e7e) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681321081,"env":"test","module":"user-credentials-repository","userId":"ea5d2ee4-5bed-4800-9869-3dd9ae43acb6","msg":"User credentials created"}
{"level":30,"time":1768681321203,"env":"test","module":"email-queue","jobId":"46d609c2-e6d5-44b2-9eab-9ef423e93766","to":"protected-test-Rpk3yNhKbnbH1rxoedbV5@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681321259,"env":"test","module":"auth-routes","userId":"ea5d2ee4-5bed-4800-9869-3dd9ae43acb6","email":"protected-test-Rpk3yNhKbnbH1rxoedbV5@example.com","msg":"User registered"}
{"level":50,"time":1768681321439,"env":"test","module":"auth-routes","email":"protected-test-Rpk3yNhKbnbH1rxoedbV5@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768681321557,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768681321682,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681321683,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:76:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
DEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 6 failed | 1 skipped) 48593ms
       â”œÃ¹ should allow access with valid Bearer token 1305ms
       â”œÃ¹ should reject access without Authorization header 1802ms
       Î“Â£Ã´ should reject access with empty Bearer token  1916ms
       Î“Â£Ã´ should reject access with malformed Authorization header  1475ms
       Î“Â£Ã´ should reject access with wrong token type  1484ms
       Î“Â£Ã´ should allow POST with valid Bearer token  1617ms
       Î“Â£Ã´ should reject POST without Bearer token  1415ms
       Î“Â£Ã´ should reject POST with invalid token  1359ms
       â”œÃ¹ should allow PUT with valid Bearer token 529ms
       Î“Â£Ã´ should reject PUT without Bearer token  1653ms
       Î“Â£Ã´ should allow DELETE with valid Bearer token  1435ms
       Î“Â£Ã´ should reject DELETE without Bearer token  1297ms
       Î“Â£Ã´ should allow PATCH with valid Bearer token  1939ms
       Î“Â£Ã´ should reject PATCH without Bearer token  1238ms
       Î“Â£Ã´ should handle Bearer token with extra spaces  1236ms
       Î“Ã¥Ã´ should handle token with newlines
       Î“Â£Ã´ should handle very long invalid token  1269ms
       Î“Â£Ã´ should handle empty Authorization header  1370ms
       Î“Â£Ã´ should handle Authorization header with only Bearer  1244ms
       Î“Â£Ã´ should handle multiple Authorization headers  1232ms
       Î“Â£Ã´ should reject token with SQL injection attempt  1196ms
       Î“Â£Ã´ should reject token with XSS attempt  1179ms
       Î“Â£Ã´ should reject token with missing userId  1172ms
       Î“Â£Ã´ should reject token with non-existent userId  1257ms
       Î“Â£Ã´ should not allow user to access another user's resources  2390ms
       Î“Â£Ã´ should inject userId into request context  1236ms
       Î“Â£Ã´ should inject tenantId into request context  1281ms
       Î“Â£Ã´ should inject role into request context  1254ms
       Î“Â£Ã´ should not apply general rate limiting to authenticated requests  1683ms
       Î“Â£Ã´ should handle request with both Bearer token and cookies  2104ms
       â”œÃ¹ should prioritize Bearer token over cookie when both present 1809ms
       â”œÃ¹ should allow unauthenticated access to optional auth routes 442ms
       â”œÃ¹ should enhance optional auth routes with user context when authenticated 939ms

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 6 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
Error: expected 200 "OK", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:84:14
     82|                 password: testUser.password,
     83|             })
     84|             .expect(200);
       |              ^
     85| 
     86|         userToken = loginRes.body.token;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/6]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
Error: expected 201 "Created", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:56:14
     54|             .post("/api/auth/register")
     55|             .send(testUser)
     56|             .expect(201);
       |              ^
     57| 
     58|         const userId = registerRes.body.user.id;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/6]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:448:18
    446|                     password: testUser.password,
    447|                 })
    448|                 .expect(200);
       |                  ^
    449| 
    450|             const user2 = {
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/6]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:84:14
     82|                 password: testUser.password,
     83|             })
     84|             .expect(200);
       |              ^
     85| 
     86|         userToken = loginRes.body.token;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/6]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  6 failed | 26 passed | 1 skipped (33)
   Start at  14:20:48
   Duration  67.36s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x13 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681467714,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681472087,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681472088,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w0_v3\",public on all connections"}
{"level":30,"time":1768681472140,"env":"test","msg":"DB: Wrapped execute() to set search_path=\"test_schema_w0_v3\",public"}
{"level":30,"time":1768681472140,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Database initialized. Current schema: test_schema_w0_v3
Î“Ã…âŒ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681474544,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681474562,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768681474552,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681474553,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681474557,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681474557,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681474561,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681474561,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681474562,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681474562,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768681475010,"env":"test","module":"user-credentials-repository","userId":"dd12557b-ac0b-4fcd-aa39-cf4eb1992d2e","msg":"User credentials created"}
{"level":30,"time":1768681475108,"env":"test","module":"email-queue","jobId":"8daeacf8-2ae8-4261-b63e-13134a1153bf","to":"test-ZH82c3ZRCb4QAtW_LmChN@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681475162,"env":"test","module":"auth-routes","userId":"dd12557b-ac0b-4fcd-aa39-cf4eb1992d2e","email":"test-ZH82c3ZRCb4QAtW_LmChN@example.com","msg":"User registered"}
{"level":30,"time":1768681475787,"env":"test","module":"user-credentials-repository","userId":"5bb265c9-bd9b-412f-8461-d16e06ed0bb2","msg":"User credentials created"}
{"level":30,"time":1768681475879,"env":"test","module":"email-queue","jobId":"d66c2a54-948e-47b4-941f-4ae40a42e7d9","to":"protected-test-q1pHKV-bfqi608kIN673D@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681475923,"env":"test","module":"auth-routes","userId":"5bb265c9-bd9b-412f-8461-d16e06ed0bb2","email":"protected-test-q1pHKV-bfqi608kIN673D@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681476531,"env":"test","module":"auth-routes","userId":"5bb265c9-bd9b-412f-8461-d16e06ed0bb2","msg":"User logged in successfully"}
{"level":30,"time":1768681476582,"env":"test","module":"audit-log-service","userId":"5bb265c9-bd9b-412f-8461-d16e06ed0bb2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681477002,"env":"test","module":"user-credentials-repository","userId":"ecf5101c-fad8-4247-b6a8-b923de92cd48","msg":"User credentials created"}
{"level":30,"time":1768681477099,"env":"test","module":"email-queue","jobId":"15baca9d-2c3f-40f6-a8d7-f56085fdd76c","to":"protected-test-H1ytz8Ez0e5SfidTaRED_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768681477185,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["ecf5101c-fad8-4247-b6a8-b923de92cd48","facfe44ac76d446515ad6cacb91fd9d3fe0dc06d8bd822802464c35aefcbf936","2026-02-16T20:24:37.099Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T20:24:37.099Z"],"cause":{"length":339,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(ecf5101c-fad8-4247-b6a8-b923de92cd48) is not present in table \"users\".","schema":"test_schema_w20_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681477887,"env":"test","module":"user-credentials-repository","userId":"45f90ede-930e-4e2d-b6fe-348635e9e54a","msg":"User credentials created"}
{"level":30,"time":1768681477978,"env":"test","module":"email-queue","jobId":"6cd99d1e-fe9e-4329-adb0-ad1ace8b31c6","to":"protected-test-IR1Hn6o4hIqb5dZJpP7r_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681478049,"env":"test","module":"auth-routes","userId":"45f90ede-930e-4e2d-b6fe-348635e9e54a","email":"protected-test-IR1Hn6o4hIqb5dZJpP7r_@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681478657,"env":"test","module":"auth-routes","userId":"45f90ede-930e-4e2d-b6fe-348635e9e54a","msg":"User logged in successfully"}
{"level":30,"time":1768681478705,"env":"test","module":"audit-log-service","userId":"45f90ede-930e-4e2d-b6fe-348635e9e54a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681478710,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681479093,"env":"test","module":"user-credentials-repository","userId":"31916d4f-8c4f-469a-bf61-11e6b770185f","msg":"User credentials created"}
{"level":30,"time":1768681479181,"env":"test","module":"email-queue","jobId":"f72a598a-d49f-48ca-8b1b-8b804381e456","to":"protected-test-xrW69JgEJx0FncaQQVp0b@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681479225,"env":"test","module":"auth-routes","userId":"31916d4f-8c4f-469a-bf61-11e6b770185f","email":"protected-test-xrW69JgEJx0FncaQQVp0b@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681479865,"env":"test","module":"auth-routes","userId":"31916d4f-8c4f-469a-bf61-11e6b770185f","msg":"User logged in successfully"}
{"level":30,"time":1768681479914,"env":"test","module":"audit-log-service","userId":"31916d4f-8c4f-469a-bf61-11e6b770185f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681479918,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681480290,"env":"test","module":"user-credentials-repository","userId":"0c743d85-cdb3-459e-afdd-80b2dfac70ae","msg":"User credentials created"}
{"level":30,"time":1768681480383,"env":"test","module":"email-queue","jobId":"4cba1d93-ca24-40ab-8539-0d872abd34e2","to":"protected-test-_X6AdXXTQVVuOCovmVW6G@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681480428,"env":"test","module":"auth-routes","userId":"0c743d85-cdb3-459e-afdd-80b2dfac70ae","email":"protected-test-_X6AdXXTQVVuOCovmVW6G@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681481016,"env":"test","module":"auth-routes","userId":"0c743d85-cdb3-459e-afdd-80b2dfac70ae","msg":"User logged in successfully"}
{"level":30,"time":1768681481060,"env":"test","module":"audit-log-service","userId":"0c743d85-cdb3-459e-afdd-80b2dfac70ae","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681481066,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768681481066,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681481434,"env":"test","module":"user-credentials-repository","userId":"05467921-746f-4a86-9e00-b1967991a9de","msg":"User credentials created"}
{"level":30,"time":1768681481527,"env":"test","module":"email-queue","jobId":"bebe6ab0-20d1-494e-aa86-ee2daf7453d0","to":"protected-test-Nku-6rUXQC_2wkcyBtlP5@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681481578,"env":"test","module":"auth-routes","userId":"05467921-746f-4a86-9e00-b1967991a9de","email":"protected-test-Nku-6rUXQC_2wkcyBtlP5@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681482168,"env":"test","module":"auth-routes","userId":"05467921-746f-4a86-9e00-b1967991a9de","msg":"User logged in successfully"}
{"level":30,"time":1768681482216,"env":"test","module":"audit-log-service","userId":"05467921-746f-4a86-9e00-b1967991a9de","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681482659,"env":"test","module":"user-credentials-repository","userId":"b548f8bf-6c90-4a5f-9757-e73b1dfae61b","msg":"User credentials created"}
{"level":30,"time":1768681482747,"env":"test","module":"email-queue","jobId":"e9b04d88-49fb-4790-8b7f-5ac82b42f27f","to":"protected-test-DEBNbiJKYJ4rm3OqYK4x3@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681482791,"env":"test","module":"auth-routes","userId":"b548f8bf-6c90-4a5f-9757-e73b1dfae61b","email":"protected-test-DEBNbiJKYJ4rm3OqYK4x3@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681483387,"env":"test","module":"auth-routes","userId":"b548f8bf-6c90-4a5f-9757-e73b1dfae61b","msg":"User logged in successfully"}
{"level":30,"time":1768681483432,"env":"test","module":"audit-log-service","userId":"b548f8bf-6c90-4a5f-9757-e73b1dfae61b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681483437,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681483812,"env":"test","module":"user-credentials-repository","userId":"2009abce-e38f-4bb8-90f3-ea25c7e442ff","msg":"User credentials created"}
{"level":30,"time":1768681483903,"env":"test","module":"email-queue","jobId":"4f563aa5-76c3-4faf-a69c-adce8c56582c","to":"protected-test-EOAbXnwtTcNaZypLB7t8I@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681483951,"env":"test","module":"auth-routes","userId":"2009abce-e38f-4bb8-90f3-ea25c7e442ff","email":"protected-test-EOAbXnwtTcNaZypLB7t8I@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681484555,"env":"test","module":"auth-routes","userId":"2009abce-e38f-4bb8-90f3-ea25c7e442ff","msg":"User logged in successfully"}
{"level":30,"time":1768681484605,"env":"test","module":"audit-log-service","userId":"2009abce-e38f-4bb8-90f3-ea25c7e442ff","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681484609,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681484985,"env":"test","module":"user-credentials-repository","userId":"fce88cae-f055-485c-9803-717150e9718f","msg":"User credentials created"}
{"level":30,"time":1768681485079,"env":"test","module":"email-queue","jobId":"b13e9dac-5a4a-4331-8300-cb841ed5bd81","to":"protected-test-fMBD3oF8b6bQt1wXNPAJo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681485124,"env":"test","module":"auth-routes","userId":"fce88cae-f055-485c-9803-717150e9718f","email":"protected-test-fMBD3oF8b6bQt1wXNPAJo@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681485726,"env":"test","module":"auth-routes","userId":"fce88cae-f055-485c-9803-717150e9718f","msg":"User logged in successfully"}
{"level":30,"time":1768681485771,"env":"test","module":"audit-log-service","userId":"fce88cae-f055-485c-9803-717150e9718f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[DEBUG] BaseRepository.update users: id=fce88cae-f055-485c-9803-717150e9718f, updates={"defaultMode":"advanced","updatedAt":"2026-01-17T20:24:45.871Z"}
{"level":30,"time":1768681486295,"env":"test","module":"user-credentials-repository","userId":"4bd64e94-929a-453d-b27f-15245ed394fa","msg":"User credentials created"}
{"level":30,"time":1768681486390,"env":"test","module":"email-queue","jobId":"9b2c1702-6849-4f78-a3de-0abf44bb4460","to":"protected-test-JnR0JNNDc9Uu4b1jeoSYb@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681486437,"env":"test","module":"auth-routes","userId":"4bd64e94-929a-453d-b27f-15245ed394fa","email":"protected-test-JnR0JNNDc9Uu4b1jeoSYb@example.com","msg":"User registered"}
{"level":30,"time":1768681487036,"env":"test","module":"auth-routes","userId":"4bd64e94-929a-453d-b27f-15245ed394fa","msg":"User logged in successfully"}
{"level":30,"time":1768681487085,"env":"test","module":"audit-log-service","userId":"4bd64e94-929a-453d-b27f-15245ed394fa","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681487089,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681487468,"env":"test","module":"user-credentials-repository","userId":"c0ad5fc2-ad81-477f-8f0b-3b829e61e094","msg":"User credentials created"}
{"level":30,"time":1768681487563,"env":"test","module":"email-queue","jobId":"ba2554ef-757e-48f2-b758-e332fecdc319","to":"protected-test-dr0ELvBdmvtdC3zMkzjBo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681487608,"env":"test","module":"auth-routes","userId":"c0ad5fc2-ad81-477f-8f0b-3b829e61e094","email":"protected-test-dr0ELvBdmvtdC3zMkzjBo@example.com","msg":"User registered"}
{"level":30,"time":1768681488197,"env":"test","module":"auth-routes","userId":"c0ad5fc2-ad81-477f-8f0b-3b829e61e094","msg":"User logged in successfully"}
{"level":30,"time":1768681488249,"env":"test","module":"audit-log-service","userId":"c0ad5fc2-ad81-477f-8f0b-3b829e61e094","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681488782,"env":"test","module":"user-credentials-repository","userId":"520160f0-930b-4bb6-8e56-6f97b0ecdaf1","msg":"User credentials created"}
{"level":30,"time":1768681488882,"env":"test","module":"email-queue","jobId":"d41c6d80-b1d5-4500-83a8-c28151520937","to":"protected-test-5AyCFIONcnniyf8aHfmVH@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681488929,"env":"test","module":"auth-routes","userId":"520160f0-930b-4bb6-8e56-6f97b0ecdaf1","email":"protected-test-5AyCFIONcnniyf8aHfmVH@example.com","msg":"User registered"}
{"level":30,"time":1768681489526,"env":"test","module":"auth-routes","userId":"520160f0-930b-4bb6-8e56-6f97b0ecdaf1","msg":"User logged in successfully"}
{"level":30,"time":1768681489574,"env":"test","module":"audit-log-service","userId":"520160f0-930b-4bb6-8e56-6f97b0ecdaf1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681489577,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681489945,"env":"test","module":"user-credentials-repository","userId":"6a868de5-6eeb-4d27-bc41-6e51d1ae0042","msg":"User credentials created"}
{"level":30,"time":1768681490036,"env":"test","module":"email-queue","jobId":"d32d0c8b-524c-4a4a-b583-c6930f429a7e","to":"protected-test-i4XY7lOD6udxoLvveZFU_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681490081,"env":"test","module":"auth-routes","userId":"6a868de5-6eeb-4d27-bc41-6e51d1ae0042","email":"protected-test-i4XY7lOD6udxoLvveZFU_@example.com","msg":"User registered"}
{"level":30,"time":1768681490679,"env":"test","module":"auth-routes","userId":"6a868de5-6eeb-4d27-bc41-6e51d1ae0042","msg":"User logged in successfully"}
{"level":30,"time":1768681490729,"env":"test","module":"audit-log-service","userId":"6a868de5-6eeb-4d27-bc41-6e51d1ae0042","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681491745,"env":"test","module":"user-credentials-repository","userId":"1df2c926-2bc3-4fb8-8fdd-7ac22d54c46b","msg":"User credentials created"}
{"level":30,"time":1768681491843,"env":"test","module":"email-queue","jobId":"9965cd67-a135-48e3-94e0-bfeee8dcebe4","to":"protected-test-RdrIFJpZN5CuICBCdxXel@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681491887,"env":"test","module":"auth-routes","userId":"1df2c926-2bc3-4fb8-8fdd-7ac22d54c46b","email":"protected-test-RdrIFJpZN5CuICBCdxXel@example.com","msg":"User registered"}
{"level":30,"time":1768681492561,"env":"test","module":"auth-routes","userId":"1df2c926-2bc3-4fb8-8fdd-7ac22d54c46b","msg":"User logged in successfully"}
{"level":30,"time":1768681492606,"env":"test","module":"audit-log-service","userId":"1df2c926-2bc3-4fb8-8fdd-7ac22d54c46b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681492611,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681493044,"env":"test","module":"user-credentials-repository","userId":"af76163d-8d03-4c4c-930c-c71868137911","msg":"User credentials created"}
{"level":30,"time":1768681493136,"env":"test","module":"email-queue","jobId":"b960a102-5430-4745-b81b-c160397fe67b","to":"protected-test-_i7qsTHcaJYOFQaJRrsYh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681493183,"env":"test","module":"auth-routes","userId":"af76163d-8d03-4c4c-930c-c71868137911","email":"protected-test-_i7qsTHcaJYOFQaJRrsYh@example.com","msg":"User registered"}
{"level":30,"time":1768681493838,"env":"test","module":"auth-routes","userId":"af76163d-8d03-4c4c-930c-c71868137911","msg":"User logged in successfully"}
{"level":50,"time":1768681493921,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"af76163d-8d03-4c4c-930c-c71868137911","login_success","security","af76163d-8d03-4c4c-930c-c71868137911","security","af76163d-8d03-4c4c-930c-c71868137911","{\"metadata\":{\"timestamp\":\"2026-01-17T20:24:53.838Z\"}}","::1",null,"2026-01-17T20:24:53.838Z"],"cause":{"length":311,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(af76163d-8d03-4c4c-930c-c71868137911) is not present in table \"users\".","schema":"public","table":"audit_logs","constraint":"audit_logs_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"af76163d-8d03-4c4c-930c-c71868137911","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768681493933,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"af76163d-8d03-4c4c-930c-c71868137911","login_success","security","af76163d-8d03-4c4c-930c-c71868137911","security","af76163d-8d03-4c4c-930c-c71868137911","{\"metadata\":{\"timestamp\":\"2026-01-17T20:24:53.838Z\"}}","::1",null,"2026-01-17T20:24:53.838Z"],"cause":{"length":311,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(af76163d-8d03-4c4c-930c-c71868137911) is not present in table \"users\".","schema":"public","table":"audit_logs","constraint":"audit_logs_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
{"level":30,"time":1768681494657,"env":"test","module":"user-credentials-repository","userId":"c3c3500c-7402-4887-a0ff-98bb25765a72","msg":"User credentials created"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681494751,"env":"test","module":"email-queue","jobId":"c8a479ae-d4d0-4e74-8ff3-5e16d8b0b297","to":"protected-test-pdE0xuTTRf6oTVICJ1mmP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681494802,"env":"test","module":"auth-routes","userId":"c3c3500c-7402-4887-a0ff-98bb25765a72","email":"protected-test-pdE0xuTTRf6oTVICJ1mmP@example.com","msg":"User registered"}
{"level":30,"time":1768681495412,"env":"test","module":"auth-routes","userId":"c3c3500c-7402-4887-a0ff-98bb25765a72","msg":"User logged in successfully"}
{"level":30,"time":1768681495457,"env":"test","module":"audit-log-service","userId":"c3c3500c-7402-4887-a0ff-98bb25765a72","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681495462,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681495837,"env":"test","module":"user-credentials-repository","userId":"f08d86d1-59e7-46f9-93ca-6e50f07a40e2","msg":"User credentials created"}
{"level":30,"time":1768681495928,"env":"test","module":"email-queue","jobId":"c1f843f3-7501-41ff-87a6-8a8defe9ec74","to":"protected-test-qxyY4SHHRXXbJT8_N3HaH@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681495977,"env":"test","module":"auth-routes","userId":"f08d86d1-59e7-46f9-93ca-6e50f07a40e2","email":"protected-test-qxyY4SHHRXXbJT8_N3HaH@example.com","msg":"User registered"}
{"level":30,"time":1768681496632,"env":"test","module":"auth-routes","userId":"f08d86d1-59e7-46f9-93ca-6e50f07a40e2","msg":"User logged in successfully"}
{"level":30,"time":1768681496679,"env":"test","module":"audit-log-service","userId":"f08d86d1-59e7-46f9-93ca-6e50f07a40e2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681496684,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681497070,"env":"test","module":"user-credentials-repository","userId":"76b20334-e368-482d-8908-68f12d848cdf","msg":"User credentials created"}
{"level":30,"time":1768681497164,"env":"test","module":"email-queue","jobId":"631d745a-a3ec-463f-87f8-71838eb79c90","to":"protected-test-anFWQjqH8vuDqWhV-X2UO@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681497208,"env":"test","module":"auth-routes","userId":"76b20334-e368-482d-8908-68f12d848cdf","email":"protected-test-anFWQjqH8vuDqWhV-X2UO@example.com","msg":"User registered"}
{"level":30,"time":1768681497848,"env":"test","module":"auth-routes","userId":"76b20334-e368-482d-8908-68f12d848cdf","msg":"User logged in successfully"}
{"level":30,"time":1768681497895,"env":"test","module":"audit-log-service","userId":"76b20334-e368-482d-8908-68f12d848cdf","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681497899,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681498270,"env":"test","module":"user-credentials-repository","userId":"543fdd39-8282-41a2-a3e3-f844b1efe9f8","msg":"User credentials created"}
{"level":30,"time":1768681498362,"env":"test","module":"email-queue","jobId":"b7b10be5-c079-4108-8300-98cc7ed1e464","to":"protected-test-OTkJngI112Rqxokp1p2UV@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681498407,"env":"test","module":"auth-routes","userId":"543fdd39-8282-41a2-a3e3-f844b1efe9f8","email":"protected-test-OTkJngI112Rqxokp1p2UV@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681499040,"env":"test","module":"auth-routes","userId":"543fdd39-8282-41a2-a3e3-f844b1efe9f8","msg":"User logged in successfully"}
{"level":30,"time":1768681499085,"env":"test","module":"audit-log-service","userId":"543fdd39-8282-41a2-a3e3-f844b1efe9f8","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681499089,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681499477,"env":"test","module":"user-credentials-repository","userId":"506dfe95-7133-4514-872a-84d783629f9d","msg":"User credentials created"}
{"level":30,"time":1768681499571,"env":"test","module":"email-queue","jobId":"945ff003-cbba-4bf7-9189-a01d70792688","to":"protected-test--RHM2QEEA1qQ0gXkxZLGu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681499618,"env":"test","module":"auth-routes","userId":"506dfe95-7133-4514-872a-84d783629f9d","email":"protected-test--RHM2QEEA1qQ0gXkxZLGu@example.com","msg":"User registered"}
{"level":30,"time":1768681500282,"env":"test","module":"auth-routes","userId":"506dfe95-7133-4514-872a-84d783629f9d","msg":"User logged in successfully"}
{"level":30,"time":1768681500329,"env":"test","module":"audit-log-service","userId":"506dfe95-7133-4514-872a-84d783629f9d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681500334,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681500794,"env":"test","module":"user-credentials-repository","userId":"fa452202-64f6-4353-b2f9-d245407cd460","msg":"User credentials created"}
{"level":30,"time":1768681500887,"env":"test","module":"email-queue","jobId":"81b06f0e-b78a-4a2c-8067-a63a6409b0ad","to":"protected-test-vG8wZEc0UDNwaek1t1dgE@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681500933,"env":"test","module":"auth-routes","userId":"fa452202-64f6-4353-b2f9-d245407cd460","email":"protected-test-vG8wZEc0UDNwaek1t1dgE@example.com","msg":"User registered"}
{"level":30,"time":1768681501597,"env":"test","module":"auth-routes","userId":"fa452202-64f6-4353-b2f9-d245407cd460","msg":"User logged in successfully"}
{"level":30,"time":1768681501642,"env":"test","module":"audit-log-service","userId":"fa452202-64f6-4353-b2f9-d245407cd460","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681501646,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681502028,"env":"test","module":"user-credentials-repository","userId":"b05879ca-40b9-4afa-95db-4cb6db6d82ef","msg":"User credentials created"}
{"level":30,"time":1768681502123,"env":"test","module":"email-queue","jobId":"5799f3cf-6438-4071-bcf9-236606a85290","to":"protected-test-Z86C_SFgQY0mfJJyAmu-0@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681502169,"env":"test","module":"auth-routes","userId":"b05879ca-40b9-4afa-95db-4cb6db6d82ef","email":"protected-test-Z86C_SFgQY0mfJJyAmu-0@example.com","msg":"User registered"}
{"level":30,"time":1768681502986,"env":"test","module":"auth-routes","userId":"b05879ca-40b9-4afa-95db-4cb6db6d82ef","msg":"User logged in successfully"}
{"level":30,"time":1768681503030,"env":"test","module":"audit-log-service","userId":"b05879ca-40b9-4afa-95db-4cb6db6d82ef","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681503445,"env":"test","module":"user-credentials-repository","userId":"b6c49947-e21f-42f0-8247-4c73e3a58680","msg":"User credentials created"}
{"level":30,"time":1768681503537,"env":"test","module":"email-queue","jobId":"cf67dd65-1440-4af8-8cec-f8d384cbd64d","to":"protected-test-6rcvLnVIGTUurMaYICMP5@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681503581,"env":"test","module":"auth-routes","userId":"b6c49947-e21f-42f0-8247-4c73e3a58680","email":"protected-test-6rcvLnVIGTUurMaYICMP5@example.com","msg":"User registered"}
{"level":30,"time":1768681504225,"env":"test","module":"auth-routes","userId":"b6c49947-e21f-42f0-8247-4c73e3a58680","msg":"User logged in successfully"}
{"level":30,"time":1768681504271,"env":"test","module":"audit-log-service","userId":"b6c49947-e21f-42f0-8247-4c73e3a58680","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681504807,"env":"test","module":"user-credentials-repository","userId":"55951413-f400-4396-9dfe-2b031ecd9207","msg":"User credentials created"}
{"level":30,"time":1768681504900,"env":"test","module":"email-queue","jobId":"647dfc55-3547-4b13-aa4f-d96209d4a72f","to":"protected-test-kYbFAoWq4BRBDHWfzpxoA@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681504948,"env":"test","module":"auth-routes","userId":"55951413-f400-4396-9dfe-2b031ecd9207","email":"protected-test-kYbFAoWq4BRBDHWfzpxoA@example.com","msg":"User registered"}
{"level":30,"time":1768681505617,"env":"test","module":"auth-routes","userId":"55951413-f400-4396-9dfe-2b031ecd9207","msg":"User logged in successfully"}
{"level":30,"time":1768681505663,"env":"test","module":"audit-log-service","userId":"55951413-f400-4396-9dfe-2b031ecd9207","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681506059,"env":"test","module":"user-credentials-repository","userId":"268d2ff2-e324-40ae-b667-4929b03dcd85","msg":"User credentials created"}
{"level":30,"time":1768681506158,"env":"test","module":"email-queue","jobId":"abba07e1-3521-465b-866e-3dd35803e12c","to":"user2-z6C63TlxMqu250IeU39-g@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681506231,"env":"test","module":"auth-routes","userId":"268d2ff2-e324-40ae-b667-4929b03dcd85","email":"user2-z6C63TlxMqu250IeU39-g@example.com","msg":"User registered"}
{"level":30,"time":1768681506839,"env":"test","module":"auth-routes","userId":"268d2ff2-e324-40ae-b667-4929b03dcd85","msg":"User logged in successfully"}
{"level":30,"time":1768681506888,"env":"test","module":"audit-log-service","userId":"268d2ff2-e324-40ae-b667-4929b03dcd85","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681506946,"env":"test","module":"rbac-middleware","userId":"268d2ff2-e324-40ae-b667-4929b03dcd85","userRole":"viewer","permission":"project:delete","path":"/5e5f64b5-becf-45a8-9750-676ac18b2af4","msg":"Permission denied"}
{"level":30,"time":1768681507355,"env":"test","module":"user-credentials-repository","userId":"800e7c5d-700c-4bbe-94a1-0a862e256e39","msg":"User credentials created"}
{"level":50,"time":1768681507429,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["800e7c5d-700c-4bbe-94a1-0a862e256e39","f48513be233d19c0e8d9632f1bd02f8cd03835279624a83631394859d6462ab8","2026-01-18T20:25:07.355Z"],"cause":{"length":383,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(800e7c5d-700c-4bbe-94a1-0a862e256e39) is not present in table \"users\".","schema":"test_schema_w14_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768681508203,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8fcc7f84-2245-4901-a9e2-165e39d9efca","$2b$12$pUU0ch6vbUStJBYoTBYZ6.1X4dUrPmz7JPLGlHNsLuUxKcFrYarpS"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8fcc7f84-2245-4901-a9e2-165e39d9efca) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"8fcc7f84-2245-4901-a9e2-165e39d9efca","msg":"Failed to create user credentials"}
{"level":50,"time":1768681508203,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8fcc7f84-2245-4901-a9e2-165e39d9efca","$2b$12$pUU0ch6vbUStJBYoTBYZ6.1X4dUrPmz7JPLGlHNsLuUxKcFrYarpS"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8fcc7f84-2245-4901-a9e2-165e39d9efca) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681508941,"env":"test","module":"user-credentials-repository","userId":"235e4432-401d-4666-9a96-a9a41db60045","msg":"User credentials created"}
{"level":30,"time":1768681509038,"env":"test","module":"email-queue","jobId":"b155e1b8-162b-4c05-91b5-3db45321cc93","to":"protected-test-s3afc-NduIMdlBN4ACYC2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768681509087,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["235e4432-401d-4666-9a96-a9a41db60045","e58808ebf941b1dace936e97daa1bc5b51294a9e77615f179313a07637e377b3","2026-02-16T20:25:09.039Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T20:25:09.039Z"],"cause":{"length":338,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(235e4432-401d-4666-9a96-a9a41db60045) is not present in table \"users\".","schema":"test_schema_w5_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
DEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681509932,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["968cdcf2-baca-4b18-98f3-47d8a04ea7af","$2b$12$3L7iLY4ZUSHYMdiDKEYoGunTlzEqNcoBSee1/5Htl/faYCNqA2XcC"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(968cdcf2-baca-4b18-98f3-47d8a04ea7af) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"968cdcf2-baca-4b18-98f3-47d8a04ea7af","msg":"Failed to create user credentials"}
{"level":50,"time":1768681509932,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["968cdcf2-baca-4b18-98f3-47d8a04ea7af","$2b$12$3L7iLY4ZUSHYMdiDKEYoGunTlzEqNcoBSee1/5Htl/faYCNqA2XcC"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(968cdcf2-baca-4b18-98f3-47d8a04ea7af) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681510812,"env":"test","module":"user-credentials-repository","userId":"c7f35ab0-cd76-457a-b535-881bf678ceff","msg":"User credentials created"}
{"level":50,"time":1768681510886,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["c7f35ab0-cd76-457a-b535-881bf678ceff","ca37a85ccfd2d1d4716505de1bd2c96a862b9500d1fd74c68db8869990f37a31","2026-01-18T20:25:10.812Z"],"cause":{"length":382,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c7f35ab0-cd76-457a-b535-881bf678ceff) is not present in table \"users\".","schema":"test_schema_w3_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
AUDIT LOG ERROR: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,af76163d-8d03-4c4c-930c-c71868137911,login_success,security,af76163d-8d03-4c4c-930c-c71868137911,security,af76163d-8d03-4c4c-930c-c71868137911,{"metadata":{"timestamp":"2026-01-17T20:24:53.838Z"}},::1,,2026-01-17T20:24:53.838Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"',
  params: [
    null,
    null,
    'af76163d-8d03-4c4c-930c-c71868137911',
    'login_success',
    'security',
    'af76163d-8d03-4c4c-930c-c71868137911',
    'security',
    'af76163d-8d03-4c4c-930c-c71868137911',
    '{"metadata":{"timestamp":"2026-01-17T20:24:53.838Z"}}',
    '::1',
    null,
    '2026-01-17T20:24:53.838Z'
  ],
  cause: error: insert or update on table "audit_logs" violates foreign key constraint "audit_logs_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
    length: 311,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(af76163d-8d03-4c4c-930c-c71868137911) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'public',
    table: 'audit_logs',
    column: undefined,
    dataType: undefined,
    constraint: 'audit_logs_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":50,"time":1768681511703,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["03fb29be-e264-450b-8386-2e89f514a90b","$2b$12$Op4CFBUVTYXMv7gsAYE1Xei4SbETMCrJkhEoSC7jhxQL1kpmKoL2K"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(03fb29be-e264-450b-8386-2e89f514a90b) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"03fb29be-e264-450b-8386-2e89f514a90b","msg":"Failed to create user credentials"}
{"level":50,"time":1768681511703,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["03fb29be-e264-450b-8386-2e89f514a90b","$2b$12$Op4CFBUVTYXMv7gsAYE1Xei4SbETMCrJkhEoSC7jhxQL1kpmKoL2K"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(03fb29be-e264-450b-8386-2e89f514a90b) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768681512577,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b14c0ee0-977b-4cd5-bc21-64052bb0b826","$2b$12$QvquTwr7XmvK4StXPFi2quftpAP4pE5ZTmoxn4HjowC/e2nBd/guG"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b14c0ee0-977b-4cd5-bc21-64052bb0b826) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"b14c0ee0-977b-4cd5-bc21-64052bb0b826","msg":"Failed to create user credentials"}
{"level":50,"time":1768681512577,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b14c0ee0-977b-4cd5-bc21-64052bb0b826","$2b$12$QvquTwr7XmvK4StXPFi2quftpAP4pE5ZTmoxn4HjowC/e2nBd/guG"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b14c0ee0-977b-4cd5-bc21-64052bb0b826) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681513336,"env":"test","module":"user-credentials-repository","userId":"f49d50a1-431b-4739-864b-48b417aada5b","msg":"User credentials created"}
{"level":50,"time":1768681513414,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["f49d50a1-431b-4739-864b-48b417aada5b","2936c17bacb202789efd0bd691187b61f04c461d31c2d4fc668231c2106a0c3d","2026-01-18T20:25:13.336Z"],"cause":{"length":382,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f49d50a1-431b-4739-864b-48b417aada5b) is not present in table \"users\".","schema":"test_schema_w6_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,af76163d-8d03-4c4c-930c-c71868137911,login_success,security,af76163d-8d03-4c4c-930c-c71868137911,security,af76163d-8d03-4c4c-930c-c71868137911,{"metadata":{"timestamp":"2026-01-17T20:24:53.838Z"}},::1,,2026-01-17T20:24:53.838Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"',
  params: [
    null,
    null,
    'af76163d-8d03-4c4c-930c-c71868137911',
    'login_success',
    'security',
    'af76163d-8d03-4c4c-930c-c71868137911',
    'security',
    'af76163d-8d03-4c4c-930c-c71868137911',
    '{"metadata":{"timestamp":"2026-01-17T20:24:53.838Z"}}',
    '::1',
    null,
    '2026-01-17T20:24:53.838Z'
  ],
  cause: error: insert or update on table "audit_logs" violates foreign key constraint "audit_logs_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
    length: 311,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(af76163d-8d03-4c4c-930c-c71868137911) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'public',
    table: 'audit_logs',
    column: undefined,
    dataType: undefined,
    constraint: 'audit_logs_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":30,"time":1768681513996,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681513996,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Cleanup error: DrizzleQueryError: Failed query: delete from "tenants" where "tenants"."id" = $1
params: d152085c-e3c6-4693-8c98-0723b5c076b0
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at Object.cleanup (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:173:11)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:41:9 {
  query: 'delete from "tenants" where "tenants"."id" = $1',
  params: [ 'd152085c-e3c6-4693-8c98-0723b5c076b0' ],
  cause: error: update or delete on table "users" violates foreign key constraint "audit_logs_user_id_users_id_fk" on table "audit_logs"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at Object.cleanup (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:173:11)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:41:9 {
    length: 346,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (id)=(5bb265c9-bd9b-412f-8461-d16e06ed0bb2) is still referenced from table "audit_logs".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w0_v3',
    table: 'audit_logs',
    column: undefined,
    dataType: undefined,
    constraint: 'audit_logs_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2612',
    routine: 'ri_ReportViolation'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 10 failed | 1 skipped) 42840ms
       Î“Â£Ã´ should allow access with valid Bearer token  1218ms
       â”œÃ¹ should reject access without Authorization header 556ms
       Î“Â£Ã´ should reject access with empty Bearer token  1523ms
       Î“Â£Ã´ should reject access with malformed Authorization header  1207ms
       Î“Â£Ã´ should reject access with wrong token type  1148ms
       Î“Â£Ã´ should allow POST with valid Bearer token  1199ms
       Î“Â£Ã´ should reject POST without Bearer token  1171ms
       Î“Â£Ã´ should reject POST with invalid token  1172ms
       Î“Â£Ã´ should allow PUT with valid Bearer token  1309ms
       Î“Â£Ã´ should reject PUT without Bearer token  1171ms
       Î“Â£Ã´ should allow DELETE with valid Bearer token  1317ms
       Î“Â£Ã´ should reject DELETE without Bearer token  1170ms
       Î“Â£Ã´ should allow PATCH with valid Bearer token  1760ms
       Î“Â£Ã´ should reject PATCH without Bearer token  1274ms
       â”œÃ¹ should handle Bearer token with extra spaces 1325ms
       Î“Ã¥Ã´ should handle token with newlines
       Î“Â£Ã´ should handle very long invalid token  1526ms
       Î“Â£Ã´ should handle empty Authorization header  1222ms
       Î“Â£Ã´ should handle Authorization header with only Bearer  1215ms
       Î“Â£Ã´ should handle multiple Authorization headers  1191ms
       Î“Â£Ã´ should reject token with SQL injection attempt  1245ms
       Î“Â£Ã´ should reject token with XSS attempt  1312ms
       Î“Â£Ã´ should reject token with missing userId  1390ms
       Î“Â£Ã´ should reject token with non-existent userId  1334ms
       Î“Â£Ã´ should not allow user to access another user's resources  2576ms
       â”œÃ¹ should inject userId into request context 484ms
       â”œÃ¹ should inject tenantId into request context 775ms
       â”œÃ¹ should inject role into request context 884ms
       â”œÃ¹ should not apply general rate limiting to authenticated requests 844ms
       â”œÃ¹ should handle request with both Bearer token and cookies 954ms
       â”œÃ¹ should prioritize Bearer token over cookie when both present 818ms
       â”œÃ¹ should allow unauthenticated access to optional auth routes 874ms
       â”œÃ¹ should enhance optional auth routes with user context when authenticated 837ms

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 10 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Error: expected 201 "Created", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:56:14
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/10]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
Error: expected 200 "OK", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:84:14
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/10]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  10 failed | 22 passed | 1 skipped (33)
   Start at  14:24:19
   Duration  53.73s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x14 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681688299,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stderr | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Failed to create schema test_schema_w0_v3: error: Too many connections attempts
    at Parser.parseErrorMessage (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:285:98)
    at Parser.handlePacket (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:122:29)
    at Parser.parse (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:35:38)
    at TLSSocket.<anonymous> (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\index.js:11:42)
    at TLSSocket.emit (node:events:508:28)
    at addChunk (node:internal/streams/readable:559:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
    at TLSSocket.Readable.push (node:internal/streams/readable:390:5)
    at TLSWrap.onStreamRead (node:internal/stream_base_commons:189:23) {
  length: 50,
  severity: 'ERROR',
  code: 'XX000',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: undefined,
  line: undefined,
  routine: undefined
}

stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): error: Too many connections attempts
    at Parser.parseErrorMessage (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:285:98)
    at Parser.handlePacket (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:122:29)
    at Parser.parse (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:35:38)
    at TLSSocket.<anonymous> (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\index.js:11:42)
    at TLSSocket.emit (node:events:508:28)
    at addChunk (node:internal/streams/readable:559:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
    at TLSSocket.Readable.push (node:internal/streams/readable:390:5)
    at TLSWrap.onStreamRead (node:internal/stream_base_commons:189:23) {
  length: 50,
  severity: 'ERROR',
  code: 'XX000',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: undefined,
  line: undefined,
  routine: undefined
}

{"level":30,"time":1768681693677,"env":"test","msg":"DB: initializing... Local"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

{"level":30,"time":1768681693864,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681693989,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768681693868,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681693878,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681693879,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681693884,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681693885,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681693988,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681693988,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681693988,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681693988,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant e29XzUxTMzt7fI8ZjYll1,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant e29XzUxTMzt7fI8ZjYll1', 'pro' ],
  cause: error: Too many connections attempts
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 50,
    severity: 'ERROR',
    code: 'XX000',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1030ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant e29XzUxTMzt7fI8ZjYll1,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: Too many connections attempts
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 50, severity: 'ERROR', code: 'XX000', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:27:08
   Duration  60.42s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x15 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681704572,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681709186,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681709187,"env":"test","msg":"DB: Using test schema \"test_schema_w0_v3\" (via PGOPTIONS)"}
{"level":30,"time":1768681709259,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:196:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:196:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681709666,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681709689,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768681709675,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681709678,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681709683,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681709684,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681709689,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681709689,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681709689,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681709689,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 4KSt1ZDts35-9RLz-YSt3,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant 4KSt1ZDts35-9RLz-YSt3', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768681710084,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768681710084,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1764ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 4KSt1ZDts35-9RLz-YSt3,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:28:14
   Duration  14.80s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x16 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681927712,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768681941970,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681941971,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681942265,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681942567,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681942585,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768681942575,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681942575,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681942579,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681942579,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681942584,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681942584,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681942585,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681942585,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768681942887,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681942887,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:196:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:196:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant UKG6I2v6X_7orcEVnfwrw,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant UKG6I2v6X_7orcEVnfwrw', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1829ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant UKG6I2v6X_7orcEVnfwrw,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:31:53
   Duration  25.49s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x17 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681993943,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Î“Â£Ã  OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_v3 (Reused: true)
â‰¡Æ’Ã¶Âº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Ã´Ã¨ Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681997500,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681997500,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768681997544,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681997916,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681997933,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
â‰¡Æ’Ã´Ãœ API Documentation available at /api-docs

{"level":30,"time":1768681997924,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681997925,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681997929,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681997929,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681997933,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681997933,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681997933,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681997933,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant MWcBel5WDh5sbr16CxuwR,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant MWcBel5WDh5sbr16CxuwR', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768681998233,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
â‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768681998234,"env":"test","msg":"DB: pool closed."}
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1655ms
       Î“Ã¥Ã´ should allow access with valid Bearer token
       Î“Ã¥Ã´ should reject access without Authorization header
       Î“Ã¥Ã´ should reject access with empty Bearer token
       Î“Ã¥Ã´ should reject access with malformed Authorization header
       Î“Ã¥Ã´ should reject access with wrong token type
       Î“Ã¥Ã´ should allow POST with valid Bearer token
       Î“Ã¥Ã´ should reject POST without Bearer token
       Î“Ã¥Ã´ should reject POST with invalid token
       Î“Ã¥Ã´ should allow PUT with valid Bearer token
       Î“Ã¥Ã´ should reject PUT without Bearer token
       Î“Ã¥Ã´ should allow DELETE with valid Bearer token
       Î“Ã¥Ã´ should reject DELETE without Bearer token
       Î“Ã¥Ã´ should allow PATCH with valid Bearer token
       Î“Ã¥Ã´ should reject PATCH without Bearer token
       Î“Ã¥Ã´ should handle Bearer token with extra spaces
       Î“Ã¥Ã´ should handle token with newlines
       Î“Ã¥Ã´ should handle very long invalid token
       Î“Ã¥Ã´ should handle empty Authorization header
       Î“Ã¥Ã´ should handle Authorization header with only Bearer
       Î“Ã¥Ã´ should handle multiple Authorization headers
       Î“Ã¥Ã´ should reject token with SQL injection attempt
       Î“Ã¥Ã´ should reject token with XSS attempt
       Î“Ã¥Ã´ should reject token with missing userId
       Î“Ã¥Ã´ should reject token with non-existent userId
       Î“Ã¥Ã´ should not allow user to access another user's resources
       Î“Ã¥Ã´ should inject userId into request context
       Î“Ã¥Ã´ should inject tenantId into request context
       Î“Ã¥Ã´ should inject role into request context
       Î“Ã¥Ã´ should not apply general rate limiting to authenticated requests
       Î“Ã¥Ã´ should handle request with both Bearer token and cookies
       Î“Ã¥Ã´ should prioritize Bearer token over cookie when both present
       Î“Ã¥Ã´ should allow unauthenticated access to optional auth routes
       Î“Ã¥Ã´ should enhance optional auth routes with user context when authenticated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant MWcBel5WDh5sbr16CxuwR,pro
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Î“Â¥Â» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Î“Â¥Â» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:31:15

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:32:38
   Duration  36.12s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
