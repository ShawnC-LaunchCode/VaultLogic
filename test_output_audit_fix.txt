npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

> ezbuildr@1.0.0 test
> cross-env VITEST_INTEGRATION=true vitest run --coverage


[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m
      [2mCoverage enabled with [22m[33mv8[39m

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w11
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w11,public

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w11 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w11%2Cpublic

{"level":30,"time":1768515444518,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515444561,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w7
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w7,public

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w7 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w7%2Cpublic

{"level":30,"time":1768515445088,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515445137,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w8
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w8,public

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w11, public

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w8 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w8%2Cpublic

{"level":30,"time":1768515445190,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w11
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768515445244,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w140.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w140.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w10
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w10,public

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w10 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w10%2Cpublic

{"level":30,"time":1768515445441,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w9
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w9,public

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w7, public

{"level":30,"time":1768515445493,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w9 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w9%2Cpublic

{"level":30,"time":1768515445513,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w7
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w12
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w12,public

{"level":30,"time":1768515445565,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w11.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w11.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w12 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w12%2Cpublic

{"level":30,"time":1768515445589,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w8, public

{"level":30,"time":1768515445639,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w8
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w7.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w7.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w10, public

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w10
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w9, public

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w14
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w14,public

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w8.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w8.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w9
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w14 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w14%2Cpublic

{"level":30,"time":1768515445968,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w12, public

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":30,"time":1768515446025,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w12
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768515446055,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768515446055,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768515446058,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768515446065,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768515446064,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768515446063,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768515446063,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w10.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w10.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w14, public

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w14
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w9.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w12.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w9.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w12.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w6
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w6,public

{"level":50,"time":1768515446534,"env":"test","module":"auth","err":{"type":"TypeError","message":"Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')","stack":"TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')\n    at getTableColumns (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/utils.js:109:15)\n    at PgSelectBuilder.from (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/query-builders/select.js:62:16)\n    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)\n    at SystemStatsRepository.incrementUsersCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:103:16)\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:95:37)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"userId":"google-user-123","msg":"Failed to upsert user during authentication"}
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w0
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0,public

{"level":50,"time":1768515446535,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w4
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w4,public

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w3,public

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w5
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w5,public

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w2
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w2,public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w1
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w1,public

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w6 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w6%2Cpublic

{"level":30,"time":1768515446566,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w0 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0%2Cpublic

{"level":30,"time":1768515446588,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w4 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w4%2Cpublic

{"level":30,"time":1768515446595,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515446600,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w2 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w2%2Cpublic

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w5 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w5%2Cpublic

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w3 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w3%2Cpublic

{"level":30,"time":1768515446602,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515446602,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w1 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w1%2Cpublic

{"level":30,"time":1768515446602,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515446603,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515446605,"env":"test","workflowId":"ccb5a79b-48c4-4395-a384-2015ca1c0979","userId":"28a31680-4a42-4cf1-aae5-12e7f188b527","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":50,"time":1768515446635,"env":"test","error":{},"msg":"Failed to create connection:"}
{"level":30,"time":1768515446640,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515446644,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515446651,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515446651,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515446653,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515446651,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768515446702,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"ccb5a79b-48c4-4395-a384-2015ca1c0979","msg":"AI model call failed"}
{"level":50,"time":1768515446724,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":50,"time":1768515446725,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google authentication failed"}
{"level":40,"time":1768515446772,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768515446772,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google token verification failed"}
{"level":50,"time":1768515446772,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google authentication failed"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w6, public

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w6
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w2, public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w1, public

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w5, public

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w4, public

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w3, public

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w0, public

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w2
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w1
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w5
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w3
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w4
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w0
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":40,"time":1768515447159,"env":"test","msg":"Failed to parse legacy string condition: \"trigger == \", defaulting to visible"}
{"level":40,"time":1768515447159,"env":"test","msg":"Failed to parse legacy string condition: \"trigger == \", defaulting to visible"}
{"level":30,"time":1768515447197,"env":"test","workflowId":"4547c096-dd35-4ad6-9005-c95b592ac2da","userId":"28a31680-4a42-4cf1-aae5-12e7f188b527","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768515447224,"env":"test","module":"auth","email":"existing@example.com","msg":"OAuth2 login successful"}
{"level":50,"time":1768515447299,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"4547c096-dd35-4ad6-9005-c95b592ac2da","msg":"AI model call failed"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w13
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w13,public

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w13 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w13%2Cpublic

{"level":30,"time":1768515447498,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768515447504,"env":"test","error":{},"msg":"Failed to create connection:"}
{"level":30,"time":1768515447537,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515447556,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515447556,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/regression-REG-1.test.ts [2m([22m[2m8 tests[22m[2m | [22m[31m5 failed[39m[2m)[22m[33m 3442[2mms[22m[39m
[31m       [31m√ó[31m should block Next when required visible question is empty[39m[32m 58[2mms[22m[39m
[31m       [31m√ó[31m should NOT block Next when required question is hidden[39m[33m 334[2mms[22m[39m
[31m       [31m√ó[31m should block when required becomes visible and is empty[39m[33m 350[2mms[22m[39m
[31m       [31m√ó[31m should skip hidden required page entirely[39m[33m 333[2mms[22m[39m
[31m       [31m√ó[31m should enforce required on visible page[39m[33m 343[2mms[22m[39m
       [32m‚úì[39m should evaluate visibility consistently across modes[32m 2[2mms[22m[39m
       [32m‚úì[39m should handle malformed visibility expression gracefully[32m 2[2mms[22m[39m
       [32m‚úì[39m should handle missing variable in visibility expression[32m 0[2mms[22m[39m
{"level":30,"time":1768515447631,"env":"test","module":"auth","email":"refresh@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768515447664,"env":"test","module":"user-credentials-repository","userId":"ZgCENEfBd32JvAFLYrOVq","msg":"User credentials created"}
{"level":30,"time":1768515447719,"env":"test","module":"user-credentials-repository","userId":"dXhiWVV79xY3_ZsI5k3Gl","msg":"User credentials created"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould complete full MFA setup flow
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515447749,"env":"test","workflowId":"c69deb1f-4efb-4c9e-b8fb-bc113a9aa5dd","userId":"28a31680-4a42-4cf1-aae5-12e7f188b527","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768515447750,"env":"test","module":"user-credentials-repository","userId":"11dae503-9fdd-43a7-82c2-76539c4ca2bb","msg":"User credentials created"}
{"level":30,"time":1768515447750,"env":"test","module":"user-credentials-repository","userId":"256fea7d-8fc8-47e9-a7d8-c1d9744aa2d7","msg":"User credentials created"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515447804,"env":"test","module":"auth-service","tokenHash":"b24cd95c85f1098ff0dae7879d7b90ec21ed2d20d817be8e7798797ff0541af1","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for 792d53a1639c10ddf1e9023fb354c636

{"level":50,"time":1768515447844,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"c69deb1f-4efb-4c9e-b8fb-bc113a9aa5dd","msg":"AI model call failed"}
{"level":30,"time":1768515447852,"env":"test","module":"email-queue","jobId":"016def14-ad51-472b-9660-d4cca07ee3b6","to":"test-1768515447340-5pjn2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768515447853,"env":"test","module":"email-queue","jobId":"40352b72-de49-43b9-acea-7d333c1d5ef2","to":"test-1768515447348-06izs@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768515447860,"env":"test","module":"auth-routes","userId":"ZgCENEfBd32JvAFLYrOVq","sessionCount":2,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w13, public

{"level":30,"time":1768515447904,"env":"test","module":"auth-routes","userId":"11dae503-9fdd-43a7-82c2-76539c4ca2bb","email":"test-1768515447340-5pjn2@example.com","msg":"User registered"}
{"level":30,"time":1768515447905,"env":"test","module":"auth-routes","userId":"256fea7d-8fc8-47e9-a7d8-c1d9744aa2d7","email":"test-1768515447348-06izs@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w13
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration ‚Üí Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w5.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w6.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w1.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w4.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w0.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w2.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w5.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w6.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515448037,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515448037,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515448041,"env":"test","module":"auth","email":"idtoken@example.com","msg":"OAuth2 login successful"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w1.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [31m‚ùØ[39m tests/integration/externalSends.test.ts [2m([22m[2m2 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 2507[2mms[22m[39m
[31m     [31m√ó[31m PREVIEW MODE: Should simulate send and NOT call fetch[39m[32m 51[2mms[22m[39m
[31m     [31m√ó[31m LIVE MODE: Should call fetch with mapped payload[39m[33m 332[2mms[22m[39m
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w4.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515448156,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515448157,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w0.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515448213,"env":"test","module":"user-credentials-repository","userId":"1Wzfk3sJ-0auZPIQWma-V","msg":"User credentials created"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [31m‚ùØ[39m tests/integration/auth/oauth2.callback.test.ts [2m([22m[2m16 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 3019[2mms[22m[39m
[31m       [31m√ó[31m should initiate OAuth2 3-legged flow and generate authorization URL[39m[32m 146[2mms[22m[39m
       [32m‚úì[39m should include optional scope in authorization URL[32m 94[2mms[22m[39m
       [32m‚úì[39m should validate valid OAuth2 state token[32m 93[2mms[22m[39m
       [32m‚úì[39m should reject invalid OAuth2 state token[32m 90[2mms[22m[39m
       [32m‚úì[39m should reject expired OAuth2 state token[32m 92[2mms[22m[39m
       [32m‚úì[39m should clean up OAuth2 state after use[32m 89[2mms[22m[39m
       [32m‚úì[39m should handle callback with missing state parameter[32m 97[2mms[22m[39m
       [32m‚úì[39m should handle callback with missing code parameter[32m 94[2mms[22m[39m
       [32m‚úì[39m should handle OAuth2 provider error responses[32m 92[2mms[22m[39m
[31m       [31m√ó[31m should track OAuth2 connection status[39m[32m 109[2mms[22m[39m
       [32m‚úì[39m should store OAuth2 state in connection metadata[32m 96[2mms[22m[39m
       [32m‚úì[39m should use cryptographically secure random state[32m 105[2mms[22m[39m
       [32m‚úì[39m should prevent state reuse after validation[32m 94[2mms[22m[39m
       [32m‚úì[39m should include PKCE support metadata in state record[32m 97[2mms[22m[39m
       [32m‚úì[39m should validate redirect URI matches allowed URIs[32m 93[2mms[22m[39m
       [32m‚úì[39m should encode redirect URI in authorization URL[32m 101[2mms[22m[39m
{"level":30,"time":1768515448238,"env":"test","module":"auth-routes","userId":"f07f60b9f29b92e585c22cd4ef8b5584","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w2.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515448291,"env":"test","module":"auth-routes","userId":"a327393309ae47fecf8be4ea1228a4e4","msg":"User logged in successfully"}
{"level":50,"time":1768515448291,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"f07f60b9f29b92e585c22cd4ef8b5584","login_success","security","f07f60b9f29b92e585c22cd4ef8b5584","security","f07f60b9f29b92e585c22cd4ef8b5584","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:28.238Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:28.239Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"f07f60b9f29b92e585c22cd4ef8b5584","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould complete full MFA setup flow
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,f07f60b9f29b92e585c22cd4ef8b5584,login_success,security,f07f60b9f29b92e585c22cd4ef8b5584,security,f07f60b9f29b92e585c22cd4ef8b5584,{"metadata":{"timestamp":"2026-01-15T22:17:28.238Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:28.239Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'f07f60b9f29b92e585c22cd4ef8b5584'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'f07f60b9f29b92e585c22cd4ef8b5584'[39m,
    [32m'security'[39m,
    [32m'f07f60b9f29b92e585c22cd4ef8b5584'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:28.238Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:28.239Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515448291,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"f07f60b9f29b92e585c22cd4ef8b5584","login_success","security","f07f60b9f29b92e585c22cd4ef8b5584","security","f07f60b9f29b92e585c22cd4ef8b5584","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:28.238Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:28.239Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":40,"time":1768515448306,"env":"test","module":"auth-routes","userId":"11dae503-9fdd-43a7-82c2-76539c4ca2bb","email":"test-1768515447340-5pjn2@example.com","msg":"Login blocked: email not verified"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration ‚Üí Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mLogin Failed DEBUG: EmailNotVerifiedError: Please verify your email before logging in. Check your inbox for the verification link.
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:90:11)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_006'[39m,
  statusCode: [33m403[39m,
  isOperational: [33mtrue[39m
}

{"level":30,"time":1768515448315,"env":"test","module":"auth-routes","userId":"1Wzfk3sJ-0auZPIQWma-V","sessionCount":1,"msg":"Listed active sessions"}
{"level":50,"time":1768515448306,"env":"test","module":"auth-routes","error":{"name":"EmailNotVerifiedError","code":"AUTH_006","statusCode":403,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1768515448342,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"a327393309ae47fecf8be4ea1228a4e4","login_success","security","a327393309ae47fecf8be4ea1228a4e4","security","a327393309ae47fecf8be4ea1228a4e4","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:28.291Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:17:28.291Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"a327393309ae47fecf8be4ea1228a4e4","eventType":"login_success","msg":"Failed to log security event"}
{"level":30,"time":1768515448348,"env":"test","workflowId":"cfcec794-bfc7-42a2-a8d2-0f1479b71cfe","userId":"28a31680-4a42-4cf1-aae5-12e7f188b527","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,a327393309ae47fecf8be4ea1228a4e4,login_success,security,a327393309ae47fecf8be4ea1228a4e4,security,a327393309ae47fecf8be4ea1228a4e4,{"metadata":{"timestamp":"2026-01-15T22:17:28.291Z"}},::ffff:127.0.0.1,Mozilla/5.0 (Windows NT 10.0; Win64; x64),2026-01-15T22:17:28.291Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'a327393309ae47fecf8be4ea1228a4e4'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'a327393309ae47fecf8be4ea1228a4e4'[39m,
    [32m'security'[39m,
    [32m'a327393309ae47fecf8be4ea1228a4e4'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:28.291Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [32m'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'[39m,
    [32m'2026-01-15T22:17:28.291Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515448342,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"a327393309ae47fecf8be4ea1228a4e4","login_success","security","a327393309ae47fecf8be4ea1228a4e4","security","a327393309ae47fecf8be4ea1228a4e4","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:28.291Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:17:28.291Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration ‚Üí Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515448376,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515448376,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515448387,"env":"test","module":"user-credentials-repository","userId":"xFhginiLdb2QTwRB-Ig2P","msg":"User credentials created"}
 [31m‚ùØ[39m tests/integration/variableSafety.test.ts [2m([22m[2m4 tests[22m[2m | [22m[31m4 failed[39m[2m)[22m[33m 3371[2mms[22m[39m
[31m     [31m√ó[31m REPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided[39m[32m 198[2mms[22m[39m
[31m     [31m√ó[31m ScriptEngine resolves alias 'input_variable' when aliasMap is provided[39m[33m 488[2mms[22m[39m
[31m     [31m√ó[31m REPRO: BlockRunner fails to resolve alias in CreateRecordConfig[39m[33m 487[2mms[22m[39m
[31m     [31m√ó[31m BlockRunner logic resolves alias with aliasMap[39m[33m 493[2mms[22m[39m
{"level":30,"time":1768515448431,"env":"test","module":"auth","email":"minimal@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768515448439,"env":"test","module":"auth-service","tokenHash":"a1a8e8360e13c9f80ab21e5c0abda1ac8f839a14018b89e304c2565c6f9a932a","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768515448442,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"cfcec794-bfc7-42a2-a8d2-0f1479b71cfe","msg":"AI model call failed"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

{"level":50,"time":1768515448527,"env":"test","module":"auth","err":{"type":"Error","message":"Token verification failed","stack":"Error: Token verification failed\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:431:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":40,"time":1768515448578,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768515448578,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":30,"time":1768515448607,"env":"test","module":"auth-routes","userId":"792d53a1639c10ddf1e9023fb354c636","msg":"Login requires MFA verification"}
{"level":50,"time":1768515448624,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token payload","stack":"Error: Invalid token payload\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:88:26)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":30,"time":1768515448659,"env":"test","module":"user-credentials-repository","userId":"qlufS77jB-o2h677vzJCr","msg":"User credentials created"}
{"level":30,"time":1768515448678,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515448678,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515448718,"env":"test","module":"mfa-service","userId":"792d53a1639c10ddf1e9023fb354c636","msg":"TOTP verification successful"}
 [31m‚ùØ[39m tests/integration/auth/oauth2.google.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 3591[2mms[22m[39m
[31m       [31m√ó[31m should successfully authenticate with valid Google ID token[39m[32m 245[2mms[22m[39m
       [32m‚úì[39m should return 400 when ID token is missing[32m 70[2mms[22m[39m
       [32m‚úì[39m should return 403 when Origin header is invalid[32m 53[2mms[22m[39m
       [32m‚úì[39m should return 401 when Google token verification fails[32m 55[2mms[22m[39m
       [32m‚úì[39m should return 401 when email is not verified by Google[32m 46[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update existing user on subsequent logins [33m 503[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create refresh token record in database [33m 408[2mms[22m[39m
       [33m[2m‚úì[22m[39m should support both "token" and "idToken" fields [33m 359[2mms[22m[39m
       [32m‚úì[39m should respect rate limiting[32m 49[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle missing profile information gracefully [33m 341[2mms[22m[39m
       [32m‚úì[39m should verify valid Google ID token[32m 45[2mms[22m[39m
       [32m‚úì[39m should throw error when token verification fails[32m 50[2mms[22m[39m
       [32m‚úì[39m should throw error when email is not verified[32m 49[2mms[22m[39m
       [32m‚úì[39m should throw error when payload is null[32m 45[2mms[22m[39m
{"level":30,"time":1768515448761,"env":"test","module":"auth-routes","userId":"qlufS77jB-o2h677vzJCr","sessionCount":0,"msg":"Listed active sessions"}
{"level":30,"time":1768515448772,"env":"test","module":"auth-routes","userId":"792d53a1639c10ddf1e9023fb354c636","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

{"level":30,"time":1768515448856,"env":"test","module":"auth-routes","userId":"11dae503-9fdd-43a7-82c2-76539c4ca2bb","msg":"User logged in successfully"}
{"level":30,"time":1768515448898,"env":"test","workflowId":"d762f253-8d1a-4132-85bd-8cdb0669f8ba","userId":"28a31680-4a42-4cf1-aae5-12e7f188b527","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":50,"time":1768515448903,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"11dae503-9fdd-43a7-82c2-76539c4ca2bb","login_success","security","11dae503-9fdd-43a7-82c2-76539c4ca2bb","security","11dae503-9fdd-43a7-82c2-76539c4ca2bb","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:28.856Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:28.857Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"11dae503-9fdd-43a7-82c2-76539c4ca2bb","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration ‚Üí Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,11dae503-9fdd-43a7-82c2-76539c4ca2bb,login_success,security,11dae503-9fdd-43a7-82c2-76539c4ca2bb,security,11dae503-9fdd-43a7-82c2-76539c4ca2bb,{"metadata":{"timestamp":"2026-01-15T22:17:28.856Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:28.857Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'11dae503-9fdd-43a7-82c2-76539c4ca2bb'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'11dae503-9fdd-43a7-82c2-76539c4ca2bb'[39m,
    [32m'security'[39m,
    [32m'11dae503-9fdd-43a7-82c2-76539c4ca2bb'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:28.856Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:28.857Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515448904,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"11dae503-9fdd-43a7-82c2-76539c4ca2bb","login_success","security","11dae503-9fdd-43a7-82c2-76539c4ca2bb","security","11dae503-9fdd-43a7-82c2-76539c4ca2bb","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:28.856Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:28.857Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768515448939,"env":"test","module":"auth-routes","userId":"792d53a1639c10ddf1e9023fb354c636","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768515448961,"env":"test","module":"user-credentials-repository","userId":"776e9501-8b56-4519-9319-175740e0c50c","msg":"User credentials created"}
{"level":50,"time":1768515448992,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"d762f253-8d1a-4132-85bd-8cdb0669f8ba","msg":"AI model call failed"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w16
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w16,public

{"level":30,"time":1768515449058,"env":"test","module":"user-credentials-repository","userId":"JQiN6eNVmiL0co6so38XV","msg":"User credentials created"}
{"level":30,"time":1768515449059,"env":"test","module":"email-queue","jobId":"0fce8054-272a-4c4e-8af8-4d5c0d15f61c","to":"test-1768515448567-jygr4f@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w16 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w16%2Cpublic

{"level":30,"time":1768515449090,"env":"test","module":"user-credentials-repository","userId":"iL93iRvFvwDI1dIFsOh8I","msg":"User credentials created"}
{"level":30,"time":1768515449110,"env":"test","module":"auth-routes","userId":"776e9501-8b56-4519-9319-175740e0c50c","email":"test-1768515448567-jygr4f@example.com","msg":"User registered"}
{"level":30,"time":1768515449132,"env":"test","module":"auth-routes","userId":"a327393309ae47fecf8be4ea1228a4e4","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

{"level":50,"time":1768515449182,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"a327393309ae47fecf8be4ea1228a4e4","login_success","security","a327393309ae47fecf8be4ea1228a4e4","security","a327393309ae47fecf8be4ea1228a4e4","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:29.132Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)","2026-01-15T22:17:29.132Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"a327393309ae47fecf8be4ea1228a4e4","eventType":"login_success","msg":"Failed to log security event"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w15
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w15,public

[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,a327393309ae47fecf8be4ea1228a4e4,login_success,security,a327393309ae47fecf8be4ea1228a4e4,security,a327393309ae47fecf8be4ea1228a4e4,{"metadata":{"timestamp":"2026-01-15T22:17:29.132Z"}},::ffff:127.0.0.1,Mozilla/5.0 (iPhone; CPU iPhone OS 14_0),2026-01-15T22:17:29.132Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'a327393309ae47fecf8be4ea1228a4e4'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'a327393309ae47fecf8be4ea1228a4e4'[39m,
    [32m'security'[39m,
    [32m'a327393309ae47fecf8be4ea1228a4e4'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:29.132Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [32m'Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)'[39m,
    [32m'2026-01-15T22:17:29.132Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515449182,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"a327393309ae47fecf8be4ea1228a4e4","login_success","security","a327393309ae47fecf8be4ea1228a4e4","security","a327393309ae47fecf8be4ea1228a4e4","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:29.132Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)","2026-01-15T22:17:29.132Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515449193,"env":"test","module":"auth-routes","userId":"iL93iRvFvwDI1dIFsOh8I","sessionCount":0,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w15 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w15%2Cpublic

{"level":30,"time":1768515449233,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515449281,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515449435,"env":"test","workflowId":"41cf683d-d8e1-4b0d-981b-3f737ce23b93","userId":"28a31680-4a42-4cf1-aae5-12e7f188b527","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768515449443,"env":"test","module":"user-credentials-repository","userId":"0QKkMVBXgUkVgFlpcCn_s","msg":"User credentials created"}
{"level":30,"time":1768515449499,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","plainTokenLen":19,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768515449531,"env":"test","module":"user-credentials-repository","userId":"6dHycPgNG7329vdVP8Q7m","msg":"User credentials created"}
{"level":50,"time":1768515449537,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"41cf683d-d8e1-4b0d-981b-3f737ce23b93","msg":"AI model call failed"}
{"level":40,"time":1768515449544,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","msg":"Security: Unknown refresh token used (Not Found in DB)"}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould reject invalid TOTP code during setup
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w15, public

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w15
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768515449702,"env":"test","module":"auth-routes","userId":"6dHycPgNG7329vdVP8Q7m","sessionCount":1,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w13.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w13.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515449729,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515449771,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515449859,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515449859,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w17
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w17,public

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w18
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w18,public

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w17 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w17%2Cpublic

{"level":30,"time":1768515449957,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515449975,"env":"test","module":"auth-routes","userId":"a327393309ae47fecf8be4ea1228a4e4","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w18 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w18%2Cpublic

{"level":30,"time":1768515449994,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515450000,"env":"test","msg":"DB: initialized flag set."}
 [31m‚ùØ[39m tests/integration/dataBlocks.test.ts [2m([22m[2m2 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 2788[2mms[22m[39m
[31m     [31m√ó[31m should write data to DataVault via WriteBlock[39m[32m 110[2mms[22m[39m
[31m     [31m√ó[31m should query data from DataVault via QueryBlock and use in Logic[39m[33m 327[2mms[22m[39m
{"level":50,"time":1768515450023,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"a327393309ae47fecf8be4ea1228a4e4","login_success","security","a327393309ae47fecf8be4ea1228a4e4","security","a327393309ae47fecf8be4ea1228a4e4","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:29.975Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)","2026-01-15T22:17:29.975Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"a327393309ae47fecf8be4ea1228a4e4","eventType":"login_success","msg":"Failed to log security event"}
{"level":30,"time":1768515450024,"env":"test","module":"user-credentials-repository","userId":"5-GudegS4yczXCRuAs3kC","msg":"User credentials created"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,a327393309ae47fecf8be4ea1228a4e4,login_success,security,a327393309ae47fecf8be4ea1228a4e4,security,a327393309ae47fecf8be4ea1228a4e4,{"metadata":{"timestamp":"2026-01-15T22:17:29.975Z"}},::ffff:127.0.0.1,Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7),2026-01-15T22:17:29.975Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'a327393309ae47fecf8be4ea1228a4e4'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'a327393309ae47fecf8be4ea1228a4e4'[39m,
    [32m'security'[39m,
    [32m'a327393309ae47fecf8be4ea1228a4e4'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:29.975Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [32m'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)'[39m,
    [32m'2026-01-15T22:17:29.975Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515450024,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"a327393309ae47fecf8be4ea1228a4e4","login_success","security","a327393309ae47fecf8be4ea1228a4e4","security","a327393309ae47fecf8be4ea1228a4e4","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:29.975Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)","2026-01-15T22:17:29.975Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515450029,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768515450036,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for ed84edefb36b10fa1a9bd3466c3f5cf9

{"level":30,"time":1768515450068,"env":"test","module":"auth-routes","userId":"08306e93a82e0b6a6029b1f90ee32b9b","msg":"User logged in successfully"}
{"level":30,"time":1768515450104,"env":"test","module":"auth-service","allTokensCount":5613,"sampleToken":"2b484d683e217a5794883c3321285a69f23da26d5e0f749725f993d77b121982","msg":"DEBUG: Tokens in DB"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w16, public

{"level":50,"time":1768515450117,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"08306e93a82e0b6a6029b1f90ee32b9b","login_success","security","08306e93a82e0b6a6029b1f90ee32b9b","security","08306e93a82e0b6a6029b1f90ee32b9b","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:30.069Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:30.069Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"08306e93a82e0b6a6029b1f90ee32b9b","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould reject invalid TOTP code during setup
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,08306e93a82e0b6a6029b1f90ee32b9b,login_success,security,08306e93a82e0b6a6029b1f90ee32b9b,security,08306e93a82e0b6a6029b1f90ee32b9b,{"metadata":{"timestamp":"2026-01-15T22:17:30.069Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:30.069Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'08306e93a82e0b6a6029b1f90ee32b9b'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'08306e93a82e0b6a6029b1f90ee32b9b'[39m,
    [32m'security'[39m,
    [32m'08306e93a82e0b6a6029b1f90ee32b9b'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:30.069Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:30.069Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515450117,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"08306e93a82e0b6a6029b1f90ee32b9b","login_success","security","08306e93a82e0b6a6029b1f90ee32b9b","security","08306e93a82e0b6a6029b1f90ee32b9b","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:30.069Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:30.069Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515450124,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768515450128,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768515450132,"env":"test","module":"auth-routes","userId":"5-GudegS4yczXCRuAs3kC","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768515450138,"env":"test","workflowId":"a97dbfa5-66bf-4704-8848-848f4896338b","userId":"28a31680-4a42-4cf1-aae5-12e7f188b527","sectionsCount":1,"stepsCount":1,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w16
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768515450183,"env":"test","module":"user-credentials-repository","userId":"81050cb6-b497-4b03-9014-d15ce6fc50e0","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w15.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w15.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768515450238,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"a97dbfa5-66bf-4704-8848-848f4896338b","msg":"AI model call failed"}
{"level":30,"time":1768515450294,"env":"test","module":"email-queue","jobId":"3ec67c0c-2efa-47e0-91e2-5807b893ac06","to":"test-1768515449806-xmqtq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768515450342,"env":"test","module":"auth-routes","userId":"81050cb6-b497-4b03-9014-d15ce6fc50e0","email":"test-1768515449806-xmqtq@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w17, public

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w18, public

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w17
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w18
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768515450436,"env":"test","module":"user-credentials-repository","userId":"8ZuFwdPLJh7Ah1yWyekMT","msg":"User credentials created"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w16.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w16.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515450461,"env":"test","module":"user-credentials-repository","userId":"kjwqot1DQcsfYyA2ytrBQ","msg":"User credentials created"}
{"level":50,"time":1768515450464,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768515450464,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"step.create","sectionRef":"temp-section-1","type":"short_text","title":"Field 1","alias":"field1"},"msg":"Failed to apply operation"}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w16.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w16.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768515450480,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"document.bindFields","id":"template-123","bindings":{"client_name":"nonExistentAlias"}},"msg":"Failed to apply operation"}
{"level":30,"time":1768515450483,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515450484,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/unit/services/WorkflowPatchService.test.ts [2m([22m[2m21 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 1829[2mms[22m[39m
       [32m‚úì[39m should resolve section tempId to real UUID when creating step[32m 11[2mms[22m[39m
       [32m‚úì[39m should handle multi-level tempId references[32m 2[2mms[22m[39m
       [32m‚úì[39m should reject duplicate step alias on create[32m 1[2mms[22m[39m
       [32m‚úì[39m should allow same alias on update of same step[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject duplicate alias on update to different step[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject completely unknown operation[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject malformed operation (missing required fields)[32m 0[2mms[22m[39m
       [32m‚úì[39m should reject unsafe DataVault operations (dropTable)[32m 0[2mms[22m[39m
       [32m‚úì[39m should reject unsafe DataVault operations (dropColumn)[32m 0[2mms[22m[39m
       [32m‚úì[39m should reject unsafe DataVault operations (deleteRows)[32m 0[2mms[22m[39m
       [32m‚úì[39m should reject unsafe DataVault operations (updateRowData)[32m 0[2mms[22m[39m
       [32m‚úì[39m should allow safe DataVault operations (createTable, addColumns)[32m 1[2mms[22m[39m
       [32m‚úì[39m should rollback all ops if any op fails[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should clear tempId mappings between batch calls[39m[32m 10[2mms[22m[39m
       [32m‚úì[39m should create visibility rule on step[32m 2[2mms[22m[39m
       [32m‚úì[39m should parse complex condition expressions[32m 1[2mms[22m[39m
       [32m‚úì[39m should attach document to workflow (document.add)[32m 2[2mms[22m[39m
       [32m‚úì[39m should bind document fields to workflow variables (document.bindFields)[32m 2[2mms[22m[39m
[31m       [31m√ó[31m should reject binding to non-existent step alias[39m[32m 1[2mms[22m[39m
       [32m‚úì[39m should create DataVault table with columns (datavault.createTable)[32m 1[2mms[22m[39m
       [32m‚úì[39m should create writeback mapping (datavault.createWritebackMapping)[32m 1[2mms[22m[39m
{"level":30,"time":1768515450546,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","plainTokenLen":17,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768515450553,"env":"test","module":"auth-routes","email":"test-1768515449809-lxseyk@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":40,"time":1768515450590,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768515450607,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515450608,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768515450657,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

 [31m‚ùØ[39m tests/integration/ai/workflowEdit.test.ts [2m([22m[2m8 tests[22m[2m | [22m[31m7 failed[39m[2m)[22m[33m 5894[2mms[22m[39m
[31m     [31m√ó[31m should create draft version on successful AI edit[39m[33m 604[2mms[22m[39m
[31m     [31m√ó[31m should enforce draft mode (revert active workflow to draft)[39m[33m 592[2mms[22m[39m
[31m     [31m√ó[31m should not create version when no changes detected (checksum match)[39m[33m 546[2mms[22m[39m
     [32m‚úì[39m should reject unauthorized access[32m 56[2mms[22m[39m
[31m     [31m√ó[31m should reject unsafe DataVault operations[39m[33m 541[2mms[22m[39m
[31m     [31m√ó[31m should handle multi-operation edits with tempId resolution[39m[33m 550[2mms[22m[39m
[31m     [31m√ó[31m should create BEFORE and AFTER snapshots[39m[33m 545[2mms[22m[39m
[31m     [31m√ó[31m should rollback on validation failure[39m[33m 701[2mms[22m[39m
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515450709,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515450709,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould login with valid credentials
[22m[39mDEBUG: LOGIN HANDLER HIT

 [31m‚ùØ[39m tests/integration/workflow_versioning.test.ts [2m([22m[2m3 tests[22m[2m | [22m[33m3 skipped[39m[2m)[22m[33m 1902[2mms[22m[39m
     [2m[90m‚Üì[39m[22m should diff two versions correctly
     [2m[90m‚Üì[39m[22m should create a version and populate changelog
     [2m[90m‚Üì[39m[22m should track execution lineage via snapshot
{"level":30,"time":1768515450776,"env":"test","module":"auth-routes","userId":"ed84edefb36b10fa1a9bd3466c3f5cf9","msg":"Login requires MFA verification"}
{"level":30,"time":1768515450780,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515450781,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515450790,"env":"test","module":"user-credentials-repository","userId":"PN6fMb3qNZCoxCSprbpaE","msg":"User credentials created"}
 [31m‚ùØ[39m tests/integration/analytics_preservation.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 1223[2mms[22m[39m
[31m     [31m√ó[31m should preserve lifetime user count when a user is deleted[39m[32m 7[2mms[22m[39m
{"level":30,"time":1768515450879,"env":"test","module":"mfa-service","userId":"ed84edefb36b10fa1a9bd3466c3f5cf9","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768515450900,"env":"test","module":"auth-service","allTokensCount":5620,"sampleToken":"2b484d683e217a5794883c3321285a69f23da26d5e0f749725f993d77b121982","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768515450928,"env":"test","module":"auth-routes","userId":"ed84edefb36b10fa1a9bd3466c3f5cf9","msg":"MFA login successful"}
{"level":30,"time":1768515450979,"env":"test","module":"auth-routes","userId":"PN6fMb3qNZCoxCSprbpaE","sessionId":"5199d1d8-3e12-47f1-b83f-77eee8de8b0a","msg":"Session revoked"}
{"level":50,"time":1768515451062,"env":"test","module":"auth-routes","email":"test-1768515449809-lxseyk@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768515451091,"env":"test","module":"auth-routes","userId":"ed84edefb36b10fa1a9bd3466c3f5cf9","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":50,"time":1768515451161,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768515451232,"env":"test","module":"auth-routes","userId":"a6b798436991c7418864a05b92580deb","msg":"User logged in successfully"}
{"level":30,"time":1768515451252,"env":"test","module":"user-credentials-repository","userId":"RGzQ3JX0VvLYTH_F7jpAD","msg":"User credentials created"}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

{"level":50,"time":1768515451283,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"a6b798436991c7418864a05b92580deb","login_success","security","a6b798436991c7418864a05b92580deb","security","a6b798436991c7418864a05b92580deb","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:31.233Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:31.233Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"a6b798436991c7418864a05b92580deb","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould login with valid credentials
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,a6b798436991c7418864a05b92580deb,login_success,security,a6b798436991c7418864a05b92580deb,security,a6b798436991c7418864a05b92580deb,{"metadata":{"timestamp":"2026-01-15T22:17:31.233Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:31.233Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'a6b798436991c7418864a05b92580deb'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'a6b798436991c7418864a05b92580deb'[39m,
    [32m'security'[39m,
    [32m'a6b798436991c7418864a05b92580deb'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:31.233Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:31.233Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515451283,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"a6b798436991c7418864a05b92580deb","login_success","security","a6b798436991c7418864a05b92580deb","security","a6b798436991c7418864a05b92580deb","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:31.233Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:31.233Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515451355,"env":"test","module":"auth-service","tokenHash":"1df150f76d8f8b58abfe5c93f389754f3fa7807a0382ba854dc464cc90c4d4d8","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768515451370,"env":"test","module":"user-credentials-repository","userId":"ejcdxvF5BpcS6g4ym5WlF","msg":"User credentials created"}
{"level":40,"time":1768515451406,"env":"test","module":"auth-service","userId":"RGzQ3JX0VvLYTH_F7jpAD","tokenHash":"1df150f76d8f8b58abfe5c93f389754f3fa7807a0382ba854dc464cc90c4d4d8","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768515451410,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515451410,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/collections.e2e.test.ts [2m([22m[2m22 tests[22m[2m | [22m[33m22 skipped[39m[2m)[22m[33m 1898[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should create a collection
       [2m[90m‚Üì[39m[22m should list collections
       [2m[90m‚Üì[39m[22m should get a collection by ID
       [2m[90m‚Üì[39m[22m should update a collection
       [2m[90m‚Üì[39m[22m should create text field
       [2m[90m‚Üì[39m[22m should create email field
       [2m[90m‚Üì[39m[22m should create number field
       [2m[90m‚Üì[39m[22m should create select field with options
       [2m[90m‚Üì[39m[22m should create boolean field
       [2m[90m‚Üì[39m[22m should list all fields
       [2m[90m‚Üì[39m[22m should update field
       [2m[90m‚Üì[39m[22m should create a record
       [2m[90m‚Üì[39m[22m should create multiple records
       [2m[90m‚Üì[39m[22m should list records with pagination
       [2m[90m‚Üì[39m[22m should get a single record
       [2m[90m‚Üì[39m[22m should update a record
       [2m[90m‚Üì[39m[22m should find records by filters
       [2m[90m‚Üì[39m[22m should delete a record
       [2m[90m‚Üì[39m[22m should list collections with stats
       [2m[90m‚Üì[39m[22m should enforce required fields
       [2m[90m‚Üì[39m[22m should validate field types
       [2m[90m‚Üì[39m[22m should delete collection (cascade fields and records)
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould not allow MFA setup if already enabled
[22m[39m[TEST UTILS] MFA Secret verified for 76b8a276994360215a3ce4853c2d197a

{"level":50,"time":1768515451559,"env":"test","module":"auth-routes","email":"test-1768515449809-lxseyk@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768515451660,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515451722,"env":"test","module":"user-credentials-repository","userId":"vgdaSUHKTyBtv7rFGl60q","msg":"User credentials created"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould not allow MFA setup if already enabled
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515451820,"env":"test","module":"auth-routes","userId":"5f367a613e7a6b30c974a0e93d20757b","msg":"User logged in successfully"}
{"level":30,"time":1768515451836,"env":"test","module":"user-credentials-repository","userId":"CSmiNeB39OyT6Ynl_2XhK","msg":"User credentials created"}
{"level":50,"time":1768515451917,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"5f367a613e7a6b30c974a0e93d20757b","login_success","security","5f367a613e7a6b30c974a0e93d20757b","security","5f367a613e7a6b30c974a0e93d20757b","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:31.820Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:31.820Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"5f367a613e7a6b30c974a0e93d20757b","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,5f367a613e7a6b30c974a0e93d20757b,login_success,security,5f367a613e7a6b30c974a0e93d20757b,security,5f367a613e7a6b30c974a0e93d20757b,{"metadata":{"timestamp":"2026-01-15T22:17:31.820Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:31.820Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'5f367a613e7a6b30c974a0e93d20757b'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'5f367a613e7a6b30c974a0e93d20757b'[39m,
    [32m'security'[39m,
    [32m'5f367a613e7a6b30c974a0e93d20757b'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:31.820Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:31.820Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515451918,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"5f367a613e7a6b30c974a0e93d20757b","login_success","security","5f367a613e7a6b30c974a0e93d20757b","security","5f367a613e7a6b30c974a0e93d20757b","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:31.820Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:31.820Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515451945,"env":"test","module":"auth-service","tokenHash":"ef625afa1f38932f21f8c8e8d6c0b5f5c0794e316c3f2f234ee8b1b2b44b58d0","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768515451994,"env":"test","module":"auth-service","tokenHash":"ef625afa1f38932f21f8c8e8d6c0b5f5c0794e316c3f2f234ee8b1b2b44b58d0","msg":"Security: Unknown refresh token used (Not Found in DB)"}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768515452134,"env":"test","module":"auth-routes","email":"test-1768515449809-lxseyk@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for 6026c353eb2fc15b3013920f4ef6e765

{"level":30,"time":1768515452230,"env":"test","module":"user-credentials-repository","userId":"2MoVbeplDBcm_4B4cdUW1","msg":"User credentials created"}
{"level":50,"time":1768515452237,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515452311,"env":"test","module":"auth-routes","userId":"76b8a276994360215a3ce4853c2d197a","msg":"Login requires MFA verification"}
{"level":30,"time":1768515452325,"env":"test","module":"auth-service","allTokensCount":5620,"sampleToken":"2b484d683e217a5794883c3321285a69f23da26d5e0f749725f993d77b121982","msg":"DEBUG: Tokens in DB"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768515452623,"env":"test","module":"auth-routes","email":"test-1768515449809-lxseyk@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for invalid password
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515452687,"env":"test","module":"user-credentials-repository","userId":"aDvtZdcH5RApMFRVc8H1j","msg":"User credentials created"}
{"level":30,"time":1768515452738,"env":"test","module":"auth-service","tokenHash":"27436dcfeb0678887cdde3890ea4214606d65853d229608d44cb88b09982a259","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768515452773,"env":"test","module":"user-credentials-repository","userId":"miuuqKqqmjJQOOZHbiq3N","msg":"User credentials created"}
{"level":50,"time":1768515452777,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768515452780,"env":"test","module":"auth-routes","userId":"5f367a613e7a6b30c974a0e93d20757b","msg":"User logged in successfully"}
{"level":40,"time":1768515452817,"env":"test","module":"account-lockout","userId":"72cf467a02963f3e3c49c99536c7c88e","email":"test-1768515449809-lxseyk@example.com","lockedUntil":"2026-01-15T22:32:32.767Z","msg":"Account locked due to too many failed attempts"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768515452817,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768515452829,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"5f367a613e7a6b30c974a0e93d20757b","login_success","security","5f367a613e7a6b30c974a0e93d20757b","security","5f367a613e7a6b30c974a0e93d20757b","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:32.780Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:32.781Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"5f367a613e7a6b30c974a0e93d20757b","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,5f367a613e7a6b30c974a0e93d20757b,login_success,security,5f367a613e7a6b30c974a0e93d20757b,security,5f367a613e7a6b30c974a0e93d20757b,{"metadata":{"timestamp":"2026-01-15T22:17:32.780Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:32.781Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'5f367a613e7a6b30c974a0e93d20757b'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'5f367a613e7a6b30c974a0e93d20757b'[39m,
    [32m'security'[39m,
    [32m'5f367a613e7a6b30c974a0e93d20757b'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:32.780Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:32.781Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515452830,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"5f367a613e7a6b30c974a0e93d20757b","login_success","security","5f367a613e7a6b30c974a0e93d20757b","security","5f367a613e7a6b30c974a0e93d20757b","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:32.780Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:32.781Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515452838,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768515452915,"env":"test","module":"auth-routes","userId":"72cf467a02963f3e3c49c99536c7c88e","email":"test-1768515449809-lxseyk@example.com","msg":"Login blocked: account locked"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: AccountLockedError: Account is locked until 2026-01-15T22:32:32.767Z
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:62:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_005'[39m,
  statusCode: [33m423[39m,
  isOperational: [33mtrue[39m,
  lockedUntil: [35m2026-01-15T22:32:32.767Z[39m,
  remainingMinutes: [33m15[39m
}

{"level":50,"time":1768515452915,"env":"test","module":"auth-routes","error":{"name":"AccountLockedError","code":"AUTH_005","statusCode":423,"isOperational":true,"lockedUntil":"2026-01-15T22:32:32.767Z","remainingMinutes":15},"msg":"Login failed"}
{"level":30,"time":1768515453025,"env":"test","module":"auth-routes","userId":"6026c353eb2fc15b3013920f4ef6e765","msg":"Login requires MFA verification"}
{"level":50,"time":1768515453040,"env":"test","module":"auth-routes","email":"test-1768515452231-b55ub4@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

{"level":30,"time":1768515453126,"env":"test","module":"user-credentials-repository","userId":"ARhUngVaIUyH-boyxya9D","msg":"User credentials created"}
{"level":50,"time":1768515453138,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768515453138,"env":"test","module":"mfa-service","userId":"6026c353eb2fc15b3013920f4ef6e765","msg":"TOTP verification successful"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for invalid password
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515453187,"env":"test","module":"auth-routes","userId":"6026c353eb2fc15b3013920f4ef6e765","msg":"MFA login successful"}
[90mstderr[2m | tests/integration/api.projects.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould generate unique backup codes
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515453338,"env":"test","module":"user-credentials-repository","userId":"_NDm4UveYjBLjZPQJs8kE","msg":"User credentials created"}
{"level":30,"time":1768515453338,"env":"test","module":"auth-routes","userId":"6026c353eb2fc15b3013920f4ef6e765","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstderr[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768515453403,"env":"test","module":"auth-service","tokenHash":"4d7aa9a0c482f055684a52b320588db0d9c1de6c1781f92355331919d95fa232","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768515453404,"env":"test","module":"auth-service","tokenHash":"4d7aa9a0c482f055684a52b320588db0d9c1de6c1781f92355331919d95fa232","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstderr[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768515453593,"env":"test","module":"auth-routes","userId":"6026c353eb2fc15b3013920f4ef6e765","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Trusted device expiry updated"}
{"level":30,"time":1768515453592,"env":"test","module":"auth-routes","userId":"ARhUngVaIUyH-boyxya9D","msg":"All other sessions revoked"}
{"level":50,"time":1768515453638,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"ARhUngVaIUyH-boyxya9D","all_sessions_revoked","security","ARhUngVaIUyH-boyxya9D","security","ARhUngVaIUyH-boyxya9D",null,"::ffff:127.0.0.1",null,"2026-01-15T22:17:33.593Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"ARhUngVaIUyH-boyxya9D","eventType":"all_sessions_revoked","msg":"Failed to log security event"}
{"level":50,"time":1768515453638,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"ARhUngVaIUyH-boyxya9D","all_sessions_revoked","security","ARhUngVaIUyH-boyxya9D","security","ARhUngVaIUyH-boyxya9D",null,"::ffff:127.0.0.1",null,"2026-01-15T22:17:33.593Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Error revoking all sessions"}
[90mstderr[2m | tests/integration/api.snapshots.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

{"level":40,"time":1768515453754,"env":"test","module":"auth-service","userId":"_NDm4UveYjBLjZPQJs8kE","tokenHash":"4d7aa9a0c482f055684a52b320588db0d9c1de6c1781f92355331919d95fa232","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":50,"time":1768515453771,"env":"test","module":"auth-routes","email":"nonexistent@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":30,"time":1768515453791,"env":"test","module":"auth-routes","userId":"d9d63612684308af0ca7e4a4e0e9993b","msg":"User logged in successfully"}
{"level":50,"time":1768515453834,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"d9d63612684308af0ca7e4a4e0e9993b","login_success","security","d9d63612684308af0ca7e4a4e0e9993b","security","d9d63612684308af0ca7e4a4e0e9993b","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:33.791Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:33.791Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"d9d63612684308af0ca7e4a4e0e9993b","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould generate unique backup codes
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,d9d63612684308af0ca7e4a4e0e9993b,login_success,security,d9d63612684308af0ca7e4a4e0e9993b,security,d9d63612684308af0ca7e4a4e0e9993b,{"metadata":{"timestamp":"2026-01-15T22:17:33.791Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:33.791Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'd9d63612684308af0ca7e4a4e0e9993b'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'd9d63612684308af0ca7e4a4e0e9993b'[39m,
    [32m'security'[39m,
    [32m'd9d63612684308af0ca7e4a4e0e9993b'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:33.791Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:33.791Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515453834,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"d9d63612684308af0ca7e4a4e0e9993b","login_success","security","d9d63612684308af0ca7e4a4e0e9993b","security","d9d63612684308af0ca7e4a4e0e9993b","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:33.791Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:33.791Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515453842,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768515453910,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768515454010,"env":"test","module":"user-credentials-repository","userId":"tTPYFE-RuaFRUDfGIGaQD","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515454154,"env":"test","module":"user-credentials-repository","userId":"q28DRRUS8zleaN18zGwU6","msg":"User credentials created"}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768515454207,"env":"test","module":"auth-service","tokenHash":"0eb790f5f1676c0718b11c83e11f9b480af5b4b3fec7f9eb91d65b4e9a23e7a3","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768515454217,"env":"test","module":"auth-routes","userId":"tTPYFE-RuaFRUDfGIGaQD","msg":"All other sessions revoked"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768515454237,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768515454266,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"tTPYFE-RuaFRUDfGIGaQD","all_sessions_revoked","security","tTPYFE-RuaFRUDfGIGaQD","security","tTPYFE-RuaFRUDfGIGaQD",null,"::ffff:127.0.0.1",null,"2026-01-15T22:17:34.217Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"tTPYFE-RuaFRUDfGIGaQD","eventType":"all_sessions_revoked","msg":"Failed to log security event"}
{"level":50,"time":1768515454266,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"tTPYFE-RuaFRUDfGIGaQD","all_sessions_revoked","security","tTPYFE-RuaFRUDfGIGaQD","security","tTPYFE-RuaFRUDfGIGaQD",null,"::ffff:127.0.0.1",null,"2026-01-15T22:17:34.217Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Error revoking all sessions"}
{"level":30,"time":1768515454342,"env":"test","module":"user-credentials-repository","userId":"aefbc8f1-c4d8-4a09-b40d-99240779d06e","msg":"User credentials created"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768515454440,"env":"test","module":"email-queue","jobId":"81bd4f43-20ac-4592-a794-7e9bdfbceb25","to":"test-1768515453913-uy81g@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":50,"time":1768515454471,"env":"test","module":"auth-routes","email":"test-1768515453680-otdoer@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768515454491,"env":"test","module":"auth-routes","userId":"aefbc8f1-c4d8-4a09-b40d-99240779d06e","email":"test-1768515453913-uy81g@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/api.workflows.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":50,"time":1768515454575,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515454604,"env":"test","module":"auth-routes","userId":"185cd69d839c6dd29d48439f12875480","msg":"User logged in successfully"}
{"level":30,"time":1768515454622,"env":"test","module":"user-credentials-repository","userId":"-JpsjzTZ2KDby3gwiuwPR","msg":"User credentials created"}
{"level":50,"time":1768515454655,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"185cd69d839c6dd29d48439f12875480","login_success","security","185cd69d839c6dd29d48439f12875480","security","185cd69d839c6dd29d48439f12875480","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:34.604Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:34.604Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"185cd69d839c6dd29d48439f12875480","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768515454655,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"185cd69d839c6dd29d48439f12875480","login_success","security","185cd69d839c6dd29d48439f12875480","security","185cd69d839c6dd29d48439f12875480","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:34.604Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:34.604Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,185cd69d839c6dd29d48439f12875480,login_success,security,185cd69d839c6dd29d48439f12875480,security,185cd69d839c6dd29d48439f12875480,{"metadata":{"timestamp":"2026-01-15T22:17:34.604Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:34.604Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'185cd69d839c6dd29d48439f12875480'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'185cd69d839c6dd29d48439f12875480'[39m,
    [32m'security'[39m,
    [32m'185cd69d839c6dd29d48439f12875480'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:34.604Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:34.604Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515454738,"env":"test","module":"user-credentials-repository","userId":"oJYQ3q7026NpjOz4S52ku","msg":"User credentials created"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 5faac49b2d6f77f4732045fd03b24de2

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515454794,"env":"test","module":"auth-service","tokenHash":"6d5539286b722fa1aa4db56ce0f427af0e779ea56154ef0eb2c8b7056269257b","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768515454883,"env":"test","module":"auth-routes","userId":"aefbc8f1-c4d8-4a09-b40d-99240779d06e","email":"test-1768515453913-uy81g@example.com","msg":"Login blocked: email not verified"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mLogin Failed DEBUG: EmailNotVerifiedError: Please verify your email before logging in. Check your inbox for the verification link.
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:90:11)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_006'[39m,
  statusCode: [33m403[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768515454884,"env":"test","module":"auth-routes","error":{"name":"EmailNotVerifiedError","code":"AUTH_006","statusCode":403,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts[2m > [22m[2mDataVault Autonumber Integration Tests
[22m[39mError cleaning up table: Error: Table not found
    at DatavaultTablesService.verifyTenantOwnership (C:/Users/scoot/poll/VaultLogic/server/services/DatavaultTablesService.ts:152:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at DatavaultTablesService.deleteTable (C:/Users/scoot/poll/VaultLogic/server/services/DatavaultTablesService.ts:290:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/datavault.autonumber.test.ts:91:9

{"level":30,"time":1768515454962,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515454963,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768515454973,"env":"test","module":"auth-routes","email":"test-1768515453680-otdoer@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768515454984,"env":"test","module":"user-credentials-repository","userId":"iHYSXgXh83dnA2ZWTBEGj","msg":"User credentials created"}
{"level":50,"time":1768515454989,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
 [31m‚ùØ[39m tests/integration/datavault.autonumber.test.ts [2m([22m[2m5 tests[22m[2m | [22m[31m5 failed[39m[2m)[22m[33m 10326[2mms[22m[39m
[31m     [31m√ó[31m should generate basic autonumber without prefix[39m[33m 357[2mms[22m[39m
[31m     [31m√ó[31m should generate autonumber with prefix[39m[33m 336[2mms[22m[39m
[31m     [31m√ó[31m should generate autonumber with yearly reset format[39m[33m 334[2mms[22m[39m
[31m     [31m√ó[31m should be atomic and prevent race conditions[39m[33m 345[2mms[22m[39m
[31m     [31m√ó[31m should prevent manual updates to autonumber values[39m[33m 339[2mms[22m[39m
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768515455091,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould store hashed backup codes
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould record failed login attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768515455357,"env":"test","module":"user-credentials-repository","userId":"s5Q3EWttfQrZWC5ykaXKR","msg":"User credentials created"}
{"level":30,"time":1768515455363,"env":"test","module":"user-credentials-repository","userId":"V2cArO6r7KFRmROdRD2x-","msg":"User credentials created"}
{"level":30,"time":1768515455406,"env":"test","module":"auth-service","tokenHash":"9d7fa44be4ff2e4b0bbe3b2cb671d2ab91a1c05a747cad7f5973a3887df1afe7","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768515455464,"env":"test","module":"auth-routes","userId":"V2cArO6r7KFRmROdRD2x-","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515455471,"env":"test","module":"auth-routes","userId":"185cd69d839c6dd29d48439f12875480","msg":"User logged in successfully"}
{"level":50,"time":1768515455519,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"185cd69d839c6dd29d48439f12875480","login_success","security","185cd69d839c6dd29d48439f12875480","security","185cd69d839c6dd29d48439f12875480","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:35.471Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:35.471Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"185cd69d839c6dd29d48439f12875480","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768515455519,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"185cd69d839c6dd29d48439f12875480","login_success","security","185cd69d839c6dd29d48439f12875480","security","185cd69d839c6dd29d48439f12875480","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:35.471Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:35.471Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,185cd69d839c6dd29d48439f12875480,login_success,security,185cd69d839c6dd29d48439f12875480,security,185cd69d839c6dd29d48439f12875480,{"metadata":{"timestamp":"2026-01-15T22:17:35.471Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:35.471Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'185cd69d839c6dd29d48439f12875480'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'185cd69d839c6dd29d48439f12875480'[39m,
    [32m'security'[39m,
    [32m'185cd69d839c6dd29d48439f12875480'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:35.471Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:35.471Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515455537,"env":"test","module":"auth-routes","userId":"5faac49b2d6f77f4732045fd03b24de2","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768515455632,"env":"test","module":"mfa-service","userId":"5faac49b2d6f77f4732045fd03b24de2","msg":"TOTP verification successful"}
{"level":30,"time":1768515455639,"env":"test","module":"auth-routes","userId":"80286efec92b35b4bc79bda211fbfc9d","msg":"User logged in successfully"}
{"level":30,"time":1768515455652,"env":"test","module":"auth-routes","userId":"f8dbb37f2812d7db656ac000b8dbb4a6","msg":"User logged in successfully"}
{"level":50,"time":1768515455682,"env":"test","module":"auth-routes","email":"test-1768515454888-hekie@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768515455683,"env":"test","module":"auth-routes","userId":"5faac49b2d6f77f4732045fd03b24de2","msg":"MFA login successful"}
{"level":50,"time":1768515455691,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"80286efec92b35b4bc79bda211fbfc9d","login_success","security","80286efec92b35b4bc79bda211fbfc9d","security","80286efec92b35b4bc79bda211fbfc9d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:35.639Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:35.639Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"80286efec92b35b4bc79bda211fbfc9d","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould store hashed backup codes
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,80286efec92b35b4bc79bda211fbfc9d,login_success,security,80286efec92b35b4bc79bda211fbfc9d,security,80286efec92b35b4bc79bda211fbfc9d,{"metadata":{"timestamp":"2026-01-15T22:17:35.639Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:35.639Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'80286efec92b35b4bc79bda211fbfc9d'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'80286efec92b35b4bc79bda211fbfc9d'[39m,
    [32m'security'[39m,
    [32m'80286efec92b35b4bc79bda211fbfc9d'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:35.639Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:35.639Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515455691,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"80286efec92b35b4bc79bda211fbfc9d","login_success","security","80286efec92b35b4bc79bda211fbfc9d","security","80286efec92b35b4bc79bda211fbfc9d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:35.639Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:35.639Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515455697,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"f8dbb37f2812d7db656ac000b8dbb4a6","login_success","security","f8dbb37f2812d7db656ac000b8dbb4a6","security","f8dbb37f2812d7db656ac000b8dbb4a6","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:35.652Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:35.652Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"f8dbb37f2812d7db656ac000b8dbb4a6","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768515455698,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,f8dbb37f2812d7db656ac000b8dbb4a6,login_success,security,f8dbb37f2812d7db656ac000b8dbb4a6,security,f8dbb37f2812d7db656ac000b8dbb4a6,{"metadata":{"timestamp":"2026-01-15T22:17:35.652Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:35.652Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'f8dbb37f2812d7db656ac000b8dbb4a6'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'f8dbb37f2812d7db656ac000b8dbb4a6'[39m,
    [32m'security'[39m,
    [32m'f8dbb37f2812d7db656ac000b8dbb4a6'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:35.652Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:35.652Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515455697,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"f8dbb37f2812d7db656ac000b8dbb4a6","login_success","security","f8dbb37f2812d7db656ac000b8dbb4a6","security","f8dbb37f2812d7db656ac000b8dbb4a6","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:35.652Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:35.652Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515455776,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould record failed login attempt
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":30,"time":1768515455834,"env":"test","module":"auth-routes","userId":"5faac49b2d6f77f4732045fd03b24de2","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515455854,"env":"test","module":"user-credentials-repository","userId":"G0m7YLhOJATViyquuAj6l","msg":"User credentials created"}
{"level":30,"time":1768515455927,"env":"test","module":"user-credentials-repository","userId":"lpjA7pT5bAzb5xdncwN3n","msg":"User credentials created"}
{"level":50,"time":1768515455935,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768515455958,"env":"test","module":"auth-routes","userId":"G0m7YLhOJATViyquuAj6l","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22m[2mOAuth2 Token Refresh Flow[2m > [22m[2mRefresh Token Lifecycle[2m > [22m[2mshould create refresh token on login
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768515456105,"env":"test","module":"auth-routes","userId":"G0m7YLhOJATViyquuAj6l","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Trusted device expiry updated"}
[90mstderr[2m | tests/integration/intake.workflow.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768515456310,"env":"test","module":"auth-routes","userId":"5faac49b2d6f77f4732045fd03b24de2","msg":"Login requires MFA verification"}
[90mstderr[2m | tests/integration/js_helpers.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768515456404,"env":"test","module":"mfa-service","userId":"5faac49b2d6f77f4732045fd03b24de2","msg":"TOTP verification successful"}
{"level":30,"time":1768515456448,"env":"test","module":"auth-routes","userId":"5faac49b2d6f77f4732045fd03b24de2","msg":"MFA login successful"}
{"level":30,"time":1768515456490,"env":"test","module":"user-credentials-repository","userId":"Idl0SnccImtnn7TPgQEHo","msg":"User credentials created"}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515456521,"env":"test","module":"auth-routes","userId":"lpjA7pT5bAzb5xdncwN3n","msg":"User logged in successfully"}
{"level":50,"time":1768515456566,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"lpjA7pT5bAzb5xdncwN3n","login_success","security","lpjA7pT5bAzb5xdncwN3n","security","lpjA7pT5bAzb5xdncwN3n","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:36.522Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:36.522Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"lpjA7pT5bAzb5xdncwN3n","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22m[2mOAuth2 Token Refresh Flow[2m > [22m[2mRefresh Token Lifecycle[2m > [22m[2mshould create refresh token on login
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,lpjA7pT5bAzb5xdncwN3n,login_success,security,lpjA7pT5bAzb5xdncwN3n,security,lpjA7pT5bAzb5xdncwN3n,{"metadata":{"timestamp":"2026-01-15T22:17:36.522Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:36.522Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'lpjA7pT5bAzb5xdncwN3n'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'lpjA7pT5bAzb5xdncwN3n'[39m,
    [32m'security'[39m,
    [32m'lpjA7pT5bAzb5xdncwN3n'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:36.522Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:36.522Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515456567,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"lpjA7pT5bAzb5xdncwN3n","login_success","security","lpjA7pT5bAzb5xdncwN3n","security","lpjA7pT5bAzb5xdncwN3n","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:36.522Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:36.522Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515456597,"env":"test","module":"auth-routes","userId":"5faac49b2d6f77f4732045fd03b24de2","deviceFingerprint":"091366faa1882b5c8dc1cba02126615a77a378274bbfd3375e821aa38bdd1b4f","msg":"Device marked as trusted"}
{"level":30,"time":1768515456603,"env":"test","module":"auth-routes","userId":"Idl0SnccImtnn7TPgQEHo","deviceCount":2,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstderr[2m | tests/unit/debug_import.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstderr[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return requiresMfa=true for MFA-enabled users
[22m[39m[TEST UTILS] MFA Secret verified for f95e508d9162e1ac7181d957387338d6

{"level":30,"time":1768515456953,"env":"test","module":"user-credentials-repository","userId":"g_F-atkXyJ_9S7eSH_qch","msg":"User credentials created"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515456960,"env":"test","module":"user-credentials-repository","userId":"CCqKFMu3dXK9XGhcaj9N-","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515457063,"env":"test","module":"auth-routes","userId":"CCqKFMu3dXK9XGhcaj9N-","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768515457090,"env":"test","module":"auth-routes","userId":"5faac49b2d6f77f4732045fd03b24de2","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould require MFA for enabled users
[22m[39m[TEST UTILS] MFA Secret verified for 5a783969b0eec2a14d4e7bd515eec4be

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return requiresMfa=true for MFA-enabled users
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515457187,"env":"test","module":"mfa-service","userId":"5faac49b2d6f77f4732045fd03b24de2","msg":"TOTP verification successful"}
{"level":30,"time":1768515457237,"env":"test","module":"auth-routes","userId":"5faac49b2d6f77f4732045fd03b24de2","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768515457334,"env":"test","module":"auth-routes","userId":"5faac49b2d6f77f4732045fd03b24de2","deviceCount":2,"msg":"Listed trusted devices"}
{"level":30,"time":1768515457407,"env":"test","module":"user-credentials-repository","userId":"OyB40yOgnAZZmg4Kxfcuj","msg":"User credentials created"}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768515457462,"env":"test","module":"auth-routes","userId":"4d930e91dd5129367cf796d1fa8917d8","msg":"User logged in successfully"}
{"level":50,"time":1768515457516,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"4d930e91dd5129367cf796d1fa8917d8","login_success","security","4d930e91dd5129367cf796d1fa8917d8","security","4d930e91dd5129367cf796d1fa8917d8","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:37.463Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:37.463Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"4d930e91dd5129367cf796d1fa8917d8","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,4d930e91dd5129367cf796d1fa8917d8,login_success,security,4d930e91dd5129367cf796d1fa8917d8,security,4d930e91dd5129367cf796d1fa8917d8,{"metadata":{"timestamp":"2026-01-15T22:17:37.463Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:37.463Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'4d930e91dd5129367cf796d1fa8917d8'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'4d930e91dd5129367cf796d1fa8917d8'[39m,
    [32m'security'[39m,
    [32m'4d930e91dd5129367cf796d1fa8917d8'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:37.463Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:37.463Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515457516,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"4d930e91dd5129367cf796d1fa8917d8","login_success","security","4d930e91dd5129367cf796d1fa8917d8","security","4d930e91dd5129367cf796d1fa8917d8","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:37.463Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:37.463Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768515457522,"env":"test","module":"user-credentials-repository","userId":"oN9hc1Uli4znnbjr-C9ZU","msg":"User credentials created"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould require MFA for enabled users
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515457569,"env":"test","module":"auth-routes","userId":"OyB40yOgnAZZmg4Kxfcuj","deviceId":"c5ae1d70-900e-48dd-810a-546c4d92f919","msg":"Trusted device revoked"}
{"level":30,"time":1768515457569,"env":"test","module":"auth-routes","userId":"468300f10b13e7101a98a10e08acba16","msg":"User logged in successfully"}
{"level":50,"time":1768515457616,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"468300f10b13e7101a98a10e08acba16","login_success","security","468300f10b13e7101a98a10e08acba16","security","468300f10b13e7101a98a10e08acba16","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:37.569Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:37.569Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"468300f10b13e7101a98a10e08acba16","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,468300f10b13e7101a98a10e08acba16,login_success,security,468300f10b13e7101a98a10e08acba16,security,468300f10b13e7101a98a10e08acba16,{"metadata":{"timestamp":"2026-01-15T22:17:37.569Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:37.569Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'468300f10b13e7101a98a10e08acba16'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'468300f10b13e7101a98a10e08acba16'[39m,
    [32m'security'[39m,
    [32m'468300f10b13e7101a98a10e08acba16'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:37.569Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:37.569Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515457617,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"468300f10b13e7101a98a10e08acba16","login_success","security","468300f10b13e7101a98a10e08acba16","security","468300f10b13e7101a98a10e08acba16","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:37.569Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:37.569Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768515457624,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768515457671,"env":"test","module":"auth-routes","userId":"f95e508d9162e1ac7181d957387338d6","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768515457939,"env":"test","module":"user-credentials-repository","userId":"I2jCBPFecMl32qUSaq4m2","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515458041,"env":"test","module":"auth-routes","userId":"5a783969b0eec2a14d4e7bd515eec4be","msg":"Login requires MFA verification"}
{"level":30,"time":1768515458065,"env":"test","module":"user-credentials-repository","userId":"HpJhBkSjCSXbotbz2Y3GT","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 349190e4532c2196ce63887db9d9f375

[90mstderr[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768515458437,"env":"test","module":"user-credentials-repository","userId":"x7TmZN2RwaozdVB-5lH5W","msg":"User credentials created"}
{"level":30,"time":1768515458450,"env":"test","module":"auth-routes","userId":"4d930e91dd5129367cf796d1fa8917d8","msg":"User logged in successfully"}
{"level":50,"time":1768515458495,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"4d930e91dd5129367cf796d1fa8917d8","login_success","security","4d930e91dd5129367cf796d1fa8917d8","security","4d930e91dd5129367cf796d1fa8917d8","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:38.451Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:38.451Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"4d930e91dd5129367cf796d1fa8917d8","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,4d930e91dd5129367cf796d1fa8917d8,login_success,security,4d930e91dd5129367cf796d1fa8917d8,security,4d930e91dd5129367cf796d1fa8917d8,{"metadata":{"timestamp":"2026-01-15T22:17:38.451Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:38.451Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'4d930e91dd5129367cf796d1fa8917d8'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'4d930e91dd5129367cf796d1fa8917d8'[39m,
    [32m'security'[39m,
    [32m'4d930e91dd5129367cf796d1fa8917d8'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:38.451Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:38.451Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515458496,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"4d930e91dd5129367cf796d1fa8917d8","login_success","security","4d930e91dd5129367cf796d1fa8917d8","security","4d930e91dd5129367cf796d1fa8917d8","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:38.451Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:38.451Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768515458524,"env":"test","module":"user-credentials-repository","userId":"_ewAATrWMKQf1dH_6ftBj","msg":"User credentials created"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515458892,"env":"test","module":"user-credentials-repository","userId":"KtVNR0NC3b0HevFcowyYD","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould login with backup code when TOTP unavailable
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w40
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w40,public

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w38
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w38,public

{"level":50,"time":1768515459044,"env":"test","module":"auth-routes","email":"test-1768515458250-c8amzl@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w40 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w40%2Cpublic

{"level":30,"time":1768515459049,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w38 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w38%2Cpublic

{"level":30,"time":1768515459079,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515459091,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould complete MFA login with valid TOTP
[22m[39m[TEST UTILS] MFA Secret verified for 480c338f62a0882921c03d3229382af2

{"level":30,"time":1768515459109,"env":"test","module":"user-credentials-repository","userId":"HPV20fZzSDKB6Fk3OOOWB","msg":"User credentials created"}
{"level":30,"time":1768515459124,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":50,"time":1768515459140,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515459200,"env":"test","module":"auth-routes","userId":"349190e4532c2196ce63887db9d9f375","msg":"Login requires MFA verification"}
[90mstderr[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768515459297,"env":"test","module":"mfa-service","userId":"349190e4532c2196ce63887db9d9f375","msg":"TOTP verification successful"}
{"level":30,"time":1768515459328,"env":"test","module":"user-credentials-repository","userId":"qTN3U6wxzMs_vUIfrJGRF","msg":"User credentials created"}
{"level":30,"time":1768515459347,"env":"test","module":"auth-routes","userId":"349190e4532c2196ce63887db9d9f375","msg":"MFA login successful"}
[90mstderr[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w41
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w41,public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould complete MFA login with valid TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515459395,"env":"test","module":"auth-routes","userId":"4d930e91dd5129367cf796d1fa8917d8","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w41 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w41%2Cpublic

{"level":30,"time":1768515459419,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768515459441,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"4d930e91dd5129367cf796d1fa8917d8","login_success","security","4d930e91dd5129367cf796d1fa8917d8","security","4d930e91dd5129367cf796d1fa8917d8","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:39.395Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:39.395Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"4d930e91dd5129367cf796d1fa8917d8","eventType":"login_success","msg":"Failed to log security event"}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w40, public

[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,4d930e91dd5129367cf796d1fa8917d8,login_success,security,4d930e91dd5129367cf796d1fa8917d8,security,4d930e91dd5129367cf796d1fa8917d8,{"metadata":{"timestamp":"2026-01-15T22:17:39.395Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:39.395Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'4d930e91dd5129367cf796d1fa8917d8'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'4d930e91dd5129367cf796d1fa8917d8'[39m,
    [32m'security'[39m,
    [32m'4d930e91dd5129367cf796d1fa8917d8'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:39.395Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:39.395Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515459441,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"4d930e91dd5129367cf796d1fa8917d8","login_success","security","4d930e91dd5129367cf796d1fa8917d8","security","4d930e91dd5129367cf796d1fa8917d8","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:39.395Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:39.395Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515459447,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768515459449,"env":"test","module":"auth-routes","userId":"b39f09f856632d044a22406b68771caf","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w38, public

{"level":30,"time":1768515459468,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w40
‚è© Schema reused, skipping migrations.

{"level":50,"time":1768515459499,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"b39f09f856632d044a22406b68771caf","login_success","security","b39f09f856632d044a22406b68771caf","security","b39f09f856632d044a22406b68771caf","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:39.450Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:39.450Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"b39f09f856632d044a22406b68771caf","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768515459500,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"b39f09f856632d044a22406b68771caf","login_success","security","b39f09f856632d044a22406b68771caf","security","b39f09f856632d044a22406b68771caf","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:39.450Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:39.450Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768515459501,"env":"test","module":"auth-routes","userId":"349190e4532c2196ce63887db9d9f375","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould login with backup code when TOTP unavailable
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,b39f09f856632d044a22406b68771caf,login_success,security,b39f09f856632d044a22406b68771caf,security,b39f09f856632d044a22406b68771caf,{"metadata":{"timestamp":"2026-01-15T22:17:39.450Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:39.450Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'b39f09f856632d044a22406b68771caf'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'b39f09f856632d044a22406b68771caf'[39m,
    [32m'security'[39m,
    [32m'b39f09f856632d044a22406b68771caf'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:39.450Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:39.450Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w39
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w39,public

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w38
‚è© Schema reused, skipping migrations.

{"level":50,"time":1768515459507,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768515459521,"env":"test","module":"auth-routes","email":"test-1768515458250-c8amzl@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768515459533,"env":"test","module":"auth-service","tokenHash":"234fb7172bd80b8255058f8718136d2960c144751948192f7220c2bc513f2294","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w17.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w18.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w17.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w39 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w39%2Cpublic

{"level":30,"time":1768515459553,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w17.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w18.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w17.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w18.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515459597,"env":"test","module":"auth-routes","userId":"349190e4532c2196ce63887db9d9f375","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768515459599,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w18.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768515459618,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768515459770,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515459771,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w41, public

{"level":30,"time":1768515459854,"env":"test","module":"auth-routes","userId":"480c338f62a0882921c03d3229382af2","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w41
‚è© Schema reused, skipping migrations.

 [31m‚ùØ[39m tests/integration/auth/oauth2.sessions.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 13616[2mms[22m[39m
       [33m[2m‚úì[22m[39m should list all active sessions for current user [33m 541[2mms[22m[39m
       [33m[2m‚úì[22m[39m should mark current session as current [33m 447[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return empty array when user has no active sessions [33m 447[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not include expired sessions [33m 430[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not include revoked sessions [33m 509[2mms[22m[39m
       [33m[2m‚úì[22m[39m should parse device name from user agent [33m 430[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for unauthenticated request [33m 333[2mms[22m[39m
       [33m[2m‚úì[22m[39m should revoke a specific session [33m 559[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 404 for non-existent session [33m 351[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent revoking current session [33m 497[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent revoking another user's session [33m 558[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for unauthenticated request [33m 346[2mms[22m[39m
[31m       [31m√ó[31m should revoke all sessions except current[39m[33m 871[2mms[22m[39m
[31m       [31m√ó[31m should revoke all trusted devices[39m[33m 619[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 400 when no active session found [33m 360[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for unauthenticated request [33m 362[2mms[22m[39m
         [33m[2m‚úì[22m[39m should mark current device as trusted [33m 521[2mms[22m[39m
         [33m[2m‚úì[22m[39m should update existing trusted device expiry [33m 645[2mms[22m[39m
         [33m[2m‚úì[22m[39m should list all trusted devices [33m 449[2mms[22m[39m
         [33m[2m‚úì[22m[39m should not include revoked devices [33m 460[2mms[22m[39m
         [33m[2m‚úì[22m[39m should revoke a trusted device [33m 551[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return 404 for non-existent device [33m 456[2mms[22m[39m
       [33m[2m‚úì[22m[39m should track IP address for sessions [33m 455[2mms[22m[39m
       [33m[2m‚úì[22m[39m should track user agent for sessions [33m 458[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update lastUsedAt on token refresh [33m 783[2mms[22m[39m
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w40.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w38.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w40.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w39, public

{"level":30,"time":1768515459957,"env":"test","module":"mfa-service","userId":"480c338f62a0882921c03d3229382af2","msg":"TOTP verification successful"}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w38.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w42
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w42,public

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w39
‚è© Schema reused, skipping migrations.

{"level":50,"time":1768515459993,"env":"test","module":"auth-routes","email":"test-1768515458250-c8amzl@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768515460001,"env":"test","module":"auth-routes","userId":"480c338f62a0882921c03d3229382af2","msg":"MFA login successful"}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w42 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w42%2Cpublic

{"level":30,"time":1768515460034,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":30,"time":1768515460082,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768515460090,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w42, public

{"level":50,"time":1768515460461,"env":"test","module":"auth-routes","email":"test-1768515458250-c8amzl@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w42
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w41.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w39.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w41.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w43
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w43,public

{"level":50,"time":1768515460550,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mcreateOrganization[2m > [22m[2mshould create organization and auto-create admin membership
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,a8fed0ef-34e8-49dc-8eb2-57ea847115cf,{"after":{"name":"Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'a8fed0ef-34e8-49dc-8eb2-57ea847115cf'[39m,
    [32m'{"after":{"name":"Test Org Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:74:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w39.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w43 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w43%2Cpublic

{"level":30,"time":1768515460577,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould create placeholder user for non-existent email
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,2f222351-9617-4259-97e6-133e619c13f5,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'2f222351-9617-4259-97e6-133e619c13f5'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for b84a452e527113e84a8eb8cfa1114521

{"level":30,"time":1768515460625,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w44
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w44,public

{"level":50,"time":1768515460932,"env":"test","module":"auth-routes","email":"test-1768515458250-c8amzl@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould transfer user-owned project to org
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,d1ce5fa6-7049-4b4c-af10-8d44d23172d1,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'd1ce5fa6-7049-4b4c-af10-8d44d23172d1'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w44 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w44%2Cpublic

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w43, public

{"level":30,"time":1768515461022,"env":"test","module":"email-queue","jobId":"0512ab8f-35ea-4545-a5d5-7fad3a32b38f","to":"test-1768515460452-6rvyts@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768515461022,"env":"test","module":"auth-service","email":"test-1768515460452-6rvyts@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w43
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w42.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w42.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould reject invalid TOTP during login
[22m[39m[TEST UTILS] MFA Secret verified for 4372452a3c8ab074dedced2e210f0944

{"level":30,"time":1768515461125,"env":"test","module":"email-queue","jobId":"fde90cf1-47bf-482b-94bd-9ef6e1652d11","to":"newuser_1768515458508@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":40,"time":1768515461132,"env":"test","module":"account-lockout","userId":"674279944a0056402150c01359ba612a","email":"test-1768515458250-c8amzl@example.com","lockedUntil":"2026-01-15T22:32:41.082Z","msg":"Account locked due to too many failed attempts"}
{"level":50,"time":1768515461133,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould create placeholder user for non-existent email
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,2f222351-9617-4259-97e6-133e619c13f5,{"after":{"invitedEmail":"newuser_1768515458508@test.com","token":"7ab09982a05296bd7944a18f3bdb557fc7966c03bd5bb8297510795d564ae1ee"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'2f222351-9617-4259-97e6-133e619c13f5'[39m,
    [32m'{"after":{"invitedEmail":"newuser_1768515458508@test.com","token":"7ab09982a05296bd7944a18f3bdb557fc7966c03bd5bb8297510795d564ae1ee"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:81:28
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":40,"time":1768515461238,"env":"test","module":"auth-routes","userId":"674279944a0056402150c01359ba612a","email":"test-1768515458250-c8amzl@example.com","msg":"Login blocked: account locked"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: AccountLockedError: Account is locked until 2026-01-15T22:32:41.082Z
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:62:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_005'[39m,
  statusCode: [33m423[39m,
  isOperational: [33mtrue[39m,
  lockedUntil: [35m2026-01-15T22:32:41.082Z[39m,
  remainingMinutes: [33m15[39m
}

{"level":50,"time":1768515461239,"env":"test","module":"auth-routes","error":{"name":"AccountLockedError","code":"AUTH_005","statusCode":423,"isOperational":true,"lockedUntil":"2026-01-15T22:32:41.082Z","remainingMinutes":15},"msg":"Login failed"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould transfer user-owned project to org
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:97:30
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

{"level":30,"time":1768515461322,"env":"test","module":"email-queue","jobId":"916a4b89-75ee-483d-99af-e7ccdac0fd3a","to":"test-1768515460452-6rvyts@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768515461322,"env":"test","module":"auth-service","email":"test-1768515460452-6rvyts@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w44, public

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w45
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w45,public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould reject invalid TOTP during login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515461378,"env":"test","module":"auth-routes","userId":"b84a452e527113e84a8eb8cfa1114521","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w44
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w45 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w45%2Cpublic

{"level":30,"time":1768515461402,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515461434,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w43.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w43.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515461475,"env":"test","module":"mfa-service","userId":"b84a452e527113e84a8eb8cfa1114521","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w46
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w46,public

{"level":30,"time":1768515461512,"env":"test","module":"auth-routes","userId":"16bd0940be6ab2dfa4a701f6840686b3","msg":"User logged in successfully"}
{"level":30,"time":1768515461525,"env":"test","module":"auth-routes","userId":"b84a452e527113e84a8eb8cfa1114521","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w46 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w46%2Cpublic

{"level":30,"time":1768515461545,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768515461560,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"16bd0940be6ab2dfa4a701f6840686b3","login_success","security","16bd0940be6ab2dfa4a701f6840686b3","security","16bd0940be6ab2dfa4a701f6840686b3","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:41.512Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:41.512Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"16bd0940be6ab2dfa4a701f6840686b3","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,16bd0940be6ab2dfa4a701f6840686b3,login_success,security,16bd0940be6ab2dfa4a701f6840686b3,security,16bd0940be6ab2dfa4a701f6840686b3,{"metadata":{"timestamp":"2026-01-15T22:17:41.512Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:41.512Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'16bd0940be6ab2dfa4a701f6840686b3'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'16bd0940be6ab2dfa4a701f6840686b3'[39m,
    [32m'security'[39m,
    [32m'16bd0940be6ab2dfa4a701f6840686b3'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:41.512Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:41.512Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515461560,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"16bd0940be6ab2dfa4a701f6840686b3","login_success","security","16bd0940be6ab2dfa4a701f6840686b3","security","16bd0940be6ab2dfa4a701f6840686b3","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:41.512Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:41.512Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mgetUserOrganizations[2m > [22m[2mshould return all organizations for user
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,fcf05071-5a59-4631-b360-0d5dc266c77a,{"after":{"name":"User Org Test Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'fcf05071-5a59-4631-b360-0d5dc266c77a'[39m,
    [32m'{"after":{"name":"User Org Test Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:100:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515461584,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515461673,"env":"test","module":"auth-routes","userId":"b84a452e527113e84a8eb8cfa1114521","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768515461686,"env":"test","module":"user-credentials-repository","userId":"2915414f24ca67056b7a99cafe8173f1","msg":"User password updated"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w45, public

{"level":30,"time":1768515461823,"env":"test","module":"auth-routes","userId":"b84a452e527113e84a8eb8cfa1114521","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768515461830,"env":"test","module":"auth-routes","userId":"4372452a3c8ab074dedced2e210f0944","msg":"Login requires MFA verification"}
{"level":50,"time":1768515461831,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"2915414f24ca67056b7a99cafe8173f1","password_reset","security","2915414f24ca67056b7a99cafe8173f1","security","2915414f24ca67056b7a99cafe8173f1","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:41.783Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:41.783Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"2915414f24ca67056b7a99cafe8173f1","eventType":"password_reset","msg":"Failed to log security event"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w45
‚è© Schema reused, skipping migrations.

{"level":50,"time":1768515461831,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"2915414f24ca67056b7a99cafe8173f1","password_reset","security","2915414f24ca67056b7a99cafe8173f1","security","2915414f24ca67056b7a99cafe8173f1","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:41.783Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:41.783Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Reset password error"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w44.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w44.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w46, public

{"level":40,"time":1768515461928,"env":"test","module":"mfa-service","userId":"4372452a3c8ab074dedced2e210f0944","msg":"TOTP verification failed"}
{"level":40,"time":1768515461928,"env":"test","module":"auth-routes","userId":"4372452a3c8ab074dedced2e210f0944","msg":"MFA verification failed during login"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,4bab9d49-04b0-4fdc-93ec-56a8d15a11ff,organization.create,organization,11fde38e-557c-4df3-b0b6-5ca13429b60e,{"after":{"name":"Test Org Audit","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:58:17 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'4bab9d49-04b0-4fdc-93ec-56a8d15a11ff'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'11fde38e-557c-4df3-b0b6-5ca13429b60e'[39m,
    [32m'{"after":{"name":"Test Org Audit","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:58:17 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w46
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w45.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w45.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/logout[2m > [22m[2mshould logout and clear refresh token cookie
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #1: Project transfer cascades runs ownership[2m > [22m[2mshould cascade ownership to workflow runs when project is transferred
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:124:24
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

{"level":30,"time":1768515462301,"env":"test","module":"auth-routes","userId":"16bd0940be6ab2dfa4a701f6840686b3","msg":"User logged in successfully"}
{"level":50,"time":1768515462360,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"16bd0940be6ab2dfa4a701f6840686b3","login_success","security","16bd0940be6ab2dfa4a701f6840686b3","security","16bd0940be6ab2dfa4a701f6840686b3","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:42.301Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:42.301Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"16bd0940be6ab2dfa4a701f6840686b3","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,16bd0940be6ab2dfa4a701f6840686b3,login_success,security,16bd0940be6ab2dfa4a701f6840686b3,security,16bd0940be6ab2dfa4a701f6840686b3,{"metadata":{"timestamp":"2026-01-15T22:17:42.301Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:42.301Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'16bd0940be6ab2dfa4a701f6840686b3'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'16bd0940be6ab2dfa4a701f6840686b3'[39m,
    [32m'security'[39m,
    [32m'16bd0940be6ab2dfa4a701f6840686b3'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:42.301Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:42.301Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515462360,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"16bd0940be6ab2dfa4a701f6840686b3","login_success","security","16bd0940be6ab2dfa4a701f6840686b3","security","16bd0940be6ab2dfa4a701f6840686b3","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:42.301Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:42.301Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould create invite for existing user without creating placeholder
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,5a9439a5-c291-410e-832c-8b37c75dc96d,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'5a9439a5-c291-410e-832c-8b37c75dc96d'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515462607,"env":"test","module":"auth-routes","userId":"274f5c8682ba63a703377b843e079633","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,48daf121-fb44-4add-b775-de7b51c1879f,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'48daf121-fb44-4add-b775-de7b51c1879f'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515462657,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"274f5c8682ba63a703377b843e079633","login_success","security","274f5c8682ba63a703377b843e079633","security","274f5c8682ba63a703377b843e079633","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:42.607Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:42.607Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"274f5c8682ba63a703377b843e079633","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/logout[2m > [22m[2mshould logout and clear refresh token cookie
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,274f5c8682ba63a703377b843e079633,login_success,security,274f5c8682ba63a703377b843e079633,security,274f5c8682ba63a703377b843e079633,{"metadata":{"timestamp":"2026-01-15T22:17:42.607Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:42.607Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'274f5c8682ba63a703377b843e079633'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'274f5c8682ba63a703377b843e079633'[39m,
    [32m'security'[39m,
    [32m'274f5c8682ba63a703377b843e079633'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:42.607Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:42.607Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515462657,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"274f5c8682ba63a703377b843e079633","login_success","security","274f5c8682ba63a703377b843e079633","security","274f5c8682ba63a703377b843e079633","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:42.607Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:42.607Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768515463039,"env":"test","module":"email-queue","jobId":"acb26378-9368-4481-b50a-65d3074f6679","to":"existing_1768515458508@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mComplete Organization Workflow[2m > [22m[2mStep 1: Create organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,200448ea-af70-4d8a-8773-572e1816bef3,organization.create,organization,36a4d9dc-b98c-407f-ab72-a5f447034783,{"after":{"name":"Test Organization","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'200448ea-af70-4d8a-8773-572e1816bef3'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'36a4d9dc-b98c-407f-ab72-a5f447034783'[39m,
    [32m'{"after":{"name":"Test Organization","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:92:19
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould invalidate all sessions after password reset
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould create invite for existing user without creating placeholder
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,5a9439a5-c291-410e-832c-8b37c75dc96d,{"after":{"invitedEmail":"existing_1768515458508@test.com","token":"fd00d700b10bd1ad02824cbbaf8e11eab0917f209108790b1f2294fb14f23e8a"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'5a9439a5-c291-410e-832c-8b37c75dc96d'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768515458508@test.com","token":"fd00d700b10bd1ad02824cbbaf8e11eab0917f209108790b1f2294fb14f23e8a"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:100:28
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515463139,"env":"test","module":"auth-routes","userId":"83b0d180425bc798b734d0cdec7e3f00","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for 837685b9004bc49e8b5e0b68c99b4d81

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould accept TOTP codes within 60-second window
[22m[39m[TEST UTILS] MFA Secret verified for 043a8930c540bf539bcaa9b61b9a4216

{"level":50,"time":1768515463192,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"83b0d180425bc798b734d0cdec7e3f00","login_success","security","83b0d180425bc798b734d0cdec7e3f00","security","83b0d180425bc798b734d0cdec7e3f00","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:43.140Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:43.140Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"83b0d180425bc798b734d0cdec7e3f00","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,83b0d180425bc798b734d0cdec7e3f00,login_success,security,83b0d180425bc798b734d0cdec7e3f00,security,83b0d180425bc798b734d0cdec7e3f00,{"metadata":{"timestamp":"2026-01-15T22:17:43.140Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:43.140Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'83b0d180425bc798b734d0cdec7e3f00'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'83b0d180425bc798b734d0cdec7e3f00'[39m,
    [32m'security'[39m,
    [32m'83b0d180425bc798b734d0cdec7e3f00'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:43.140Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:43.140Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515463192,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"83b0d180425bc798b734d0cdec7e3f00","login_success","security","83b0d180425bc798b734d0cdec7e3f00","security","83b0d180425bc798b734d0cdec7e3f00","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:43.140Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:43.140Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515463198,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mupdateOrganization[2m > [22m[2mshould allow admin to update organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,d6124a0d-d17b-4053-b87f-ca37227106d3,{"after":{"name":"Original Name Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'd6124a0d-d17b-4053-b87f-ca37227106d3'[39m,
    [32m'{"after":{"name":"Original Name Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:122:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,95a3a69b-777a-4f88-b481-8a92891e189d,{"after":{"name":"Other Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'95a3a69b-777a-4f88-b481-8a92891e189d'[39m,
    [32m'{"after":{"name":"Other Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:131:30
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould accept TOTP codes within 60-second window
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515463594,"env":"test","module":"email-queue","jobId":"105358cb-3b5c-475f-91c6-0ada831a2f87","to":"audit-user2@test.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
{"level":30,"time":1768515463594,"env":"test","module":"auth-routes","userId":"1b307a36161c4cd69a493d7bd05d8b45","msg":"User logged in successfully"}
{"level":30,"time":1768515463635,"env":"test","module":"email-queue","jobId":"b688c52e-76e9-4607-9b32-e79043fe2f99","to":"org-member@test.com","subject":"You've been invited to join Test Organization","msg":"Email added to queue"}
{"level":50,"time":1768515463644,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"1b307a36161c4cd69a493d7bd05d8b45","login_success","security","1b307a36161c4cd69a493d7bd05d8b45","security","1b307a36161c4cd69a493d7bd05d8b45","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:43.595Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:43.595Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"1b307a36161c4cd69a493d7bd05d8b45","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould invalidate all sessions after password reset
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,1b307a36161c4cd69a493d7bd05d8b45,login_success,security,1b307a36161c4cd69a493d7bd05d8b45,security,1b307a36161c4cd69a493d7bd05d8b45,{"metadata":{"timestamp":"2026-01-15T22:17:43.595Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:43.595Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'1b307a36161c4cd69a493d7bd05d8b45'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'1b307a36161c4cd69a493d7bd05d8b45'[39m,
    [32m'security'[39m,
    [32m'1b307a36161c4cd69a493d7bd05d8b45'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:43.595Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:43.595Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515463644,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"1b307a36161c4cd69a493d7bd05d8b45","login_success","security","1b307a36161c4cd69a493d7bd05d8b45","security","1b307a36161c4cd69a493d7bd05d8b45","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:43.595Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:43.595Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #2: Invite acceptance race condition[2m > [22m[2mshould prevent double-acceptance via transaction
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,4bab9d49-04b0-4fdc-93ec-56a8d15a11ff,organization.invite_send,organization,11fde38e-557c-4df3-b0b6-5ca13429b60e,{"after":{"invitedEmail":"audit-user2@test.com","token":"52766f5022ebeeff63a92f6cf5810b73d8c34c65db546b0bf266c8cbe0e8e171"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'4bab9d49-04b0-4fdc-93ec-56a8d15a11ff'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'11fde38e-557c-4df3-b0b6-5ca13429b60e'[39m,
    [32m'{"after":{"invitedEmail":"audit-user2@test.com","token":"52766f5022ebeeff63a92f6cf5810b73d8c34c65db546b0bf266c8cbe0e8e171"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:164:22
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mComplete Organization Workflow[2m > [22m[2mStep 2: Invite member via email
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,200448ea-af70-4d8a-8773-572e1816bef3,organization.invite_send,organization,36a4d9dc-b98c-407f-ab72-a5f447034783,{"after":{"invitedEmail":"org-member@test.com","token":"775d22b1cbcd03667c52164f2acbd5dce7bc74bf2730edb80c4fb50db43353fe"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'200448ea-af70-4d8a-8773-572e1816bef3'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'36a4d9dc-b98c-407f-ab72-a5f447034783'[39m,
    [32m'{"after":{"invitedEmail":"org-member@test.com","token":"775d22b1cbcd03667c52164f2acbd5dce7bc74bf2730edb80c4fb50db43353fe"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:117:22
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515463894,"env":"test","module":"auth-routes","userId":"837685b9004bc49e8b5e0b68c99b4d81","msg":"Login requires MFA verification"}
{"level":30,"time":1768515463903,"env":"test","module":"auth-routes","userId":"043a8930c540bf539bcaa9b61b9a4216","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould refresh access token with valid refresh token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515463990,"env":"test","module":"mfa-service","userId":"837685b9004bc49e8b5e0b68c99b4d81","msg":"TOTP verification successful"}
{"level":30,"time":1768515464003,"env":"test","module":"mfa-service","userId":"043a8930c540bf539bcaa9b61b9a4216","msg":"TOTP verification successful"}
{"level":30,"time":1768515464036,"env":"test","module":"auth-routes","userId":"837685b9004bc49e8b5e0b68c99b4d81","msg":"MFA login successful"}
{"level":30,"time":1768515464056,"env":"test","module":"auth-routes","userId":"043a8930c540bf539bcaa9b61b9a4216","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould accept TOTP codes within 60-second window
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515464131,"env":"test","module":"email-queue","jobId":"03964ef5-08fb-43d6-8271-a44fc46e3c47","to":"test-1768515462719-0wtt6g@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768515464131,"env":"test","module":"auth-service","email":"test-1768515462719-0wtt6g@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768515464185,"env":"test","module":"auth-routes","userId":"837685b9004bc49e8b5e0b68c99b4d81","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mupdateOrganization[2m > [22m[2mshould deny non-admin from updating organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,f5af5f77-e7a1-4605-9a3e-afe68c88862c,{"after":{"name":"Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'f5af5f77-e7a1-4605-9a3e-afe68c88862c'[39m,
    [32m'{"after":{"name":"Test Org Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:139:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515464329,"env":"test","module":"auth-routes","userId":"837685b9004bc49e8b5e0b68c99b4d81","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768515464399,"env":"test","module":"auth-routes","userId":"0543d9a67de5bf5f53bc9e5469619110","msg":"User logged in successfully"}
{"level":30,"time":1768515464405,"env":"test","module":"user-credentials-repository","userId":"F56wzothiVbGqYohbN3i2","msg":"User credentials created"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #2: Invite acceptance race condition[2m > [22m[2mshould prevent double-acceptance via transaction
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,e1819239-2715-4760-bf5b-7c40a89f3373,organization.invite_accept,organization,11fde38e-557c-4df3-b0b6-5ca13429b60e,{"after":{"email":"audit-user2@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'e1819239-2715-4760-bf5b-7c40a89f3373'[39m,
    [32m'organization.invite_accept'[39m,
    [32m'organization'[39m,
    [32m'11fde38e-557c-4df3-b0b6-5ca13429b60e'[39m,
    [32m'{"after":{"email":"audit-user2@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:171:7
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould prevent duplicate pending invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,f096b9c4-ac7f-44a5-9b6d-d83ea777ea83,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'f096b9c4-ac7f-44a5-9b6d-d83ea777ea83'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515464442,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"0543d9a67de5bf5f53bc9e5469619110","login_success","security","0543d9a67de5bf5f53bc9e5469619110","security","0543d9a67de5bf5f53bc9e5469619110","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:44.399Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:44.399Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"0543d9a67de5bf5f53bc9e5469619110","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould refresh access token with valid refresh token
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,0543d9a67de5bf5f53bc9e5469619110,login_success,security,0543d9a67de5bf5f53bc9e5469619110,security,0543d9a67de5bf5f53bc9e5469619110,{"metadata":{"timestamp":"2026-01-15T22:17:44.399Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:44.399Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'0543d9a67de5bf5f53bc9e5469619110'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'0543d9a67de5bf5f53bc9e5469619110'[39m,
    [32m'security'[39m,
    [32m'0543d9a67de5bf5f53bc9e5469619110'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:44.399Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:44.399Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515464442,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"0543d9a67de5bf5f53bc9e5469619110","login_success","security","0543d9a67de5bf5f53bc9e5469619110","security","0543d9a67de5bf5f53bc9e5469619110","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:44.399Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:44.399Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768515464446,"env":"test","module":"auth-service","tokenHash":"4e83d586ae65c92d9e5f5680c0ed64c97b0d42d28a5fd582b58bb4ec450e2917","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768515464493,"env":"test","module":"user-credentials-repository","userId":"1b307a36161c4cd69a493d7bd05d8b45","msg":"User password updated"}
[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mComplete Organization Workflow[2m > [22m[2mStep 3: Accept invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,e654da23-84c2-4a6f-afa4-fc8301635752,organization.invite_accept,organization,36a4d9dc-b98c-407f-ab72-a5f447034783,{"after":{"email":"org-member@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'e654da23-84c2-4a6f-afa4-fc8301635752'[39m,
    [32m'organization.invite_accept'[39m,
    [32m'organization'[39m,
    [32m'36a4d9dc-b98c-407f-ab72-a5f447034783'[39m,
    [32m'{"after":{"email":"org-member@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:141:22
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515464518,"env":"test","module":"auth-routes","userId":"043a8930c540bf539bcaa9b61b9a4216","msg":"Login requires MFA verification"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould allow org member to transfer org-owned project to another org they belong to
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,a9c95b8a-08ec-4acd-9c74-3558f69e20c6,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'a9c95b8a-08ec-4acd-9c74-3558f69e20c6'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515464626,"env":"test","module":"mfa-service","userId":"043a8930c540bf539bcaa9b61b9a4216","msg":"TOTP verification successful"}
{"level":50,"time":1768515464643,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"1b307a36161c4cd69a493d7bd05d8b45","password_reset","security","1b307a36161c4cd69a493d7bd05d8b45","security","1b307a36161c4cd69a493d7bd05d8b45","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:44.593Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:44.593Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"1b307a36161c4cd69a493d7bd05d8b45","eventType":"password_reset","msg":"Failed to log security event"}
{"level":50,"time":1768515464643,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"1b307a36161c4cd69a493d7bd05d8b45","password_reset","security","1b307a36161c4cd69a493d7bd05d8b45","security","1b307a36161c4cd69a493d7bd05d8b45","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:44.593Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:44.593Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Reset password error"}
{"level":50,"time":1768515464648,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768515464670,"env":"test","module":"auth-routes","userId":"043a8930c540bf539bcaa9b61b9a4216","msg":"MFA login successful"}
{"level":50,"time":1768515464695,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768515464863,"env":"test","module":"user-credentials-repository","userId":"9C4ZanUVflaS-MIRdhx6p","msg":"User credentials created"}
{"level":30,"time":1768515464912,"env":"test","module":"auth-service","tokenHash":"3aee94700bb20f7fffd28a24aeda5fc6dedf91ebeff328e570ba89c7f8bd3c69","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768515464970,"env":"test","module":"email-queue","jobId":"37904bcd-e445-4eae-bce1-2a2477d3bcb8","to":"newuser_1768515458508@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mComplete Organization Workflow[2m > [22m[2mStep 4: Create workflow owned by user
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:167:24
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould prevent duplicate pending invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,f096b9c4-ac7f-44a5-9b6d-d83ea777ea83,{"after":{"invitedEmail":"newuser_1768515458508@test.com","token":"e2826392b90721f4864d73fc65af44637fc01fd1a81ba34238a7d849c6f68713"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'f096b9c4-ac7f-44a5-9b6d-d83ea777ea83'[39m,
    [32m'{"after":{"invitedEmail":"newuser_1768515458508@test.com","token":"e2826392b90721f4864d73fc65af44637fc01fd1a81ba34238a7d849c6f68713"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:119:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515465106,"env":"test","module":"auth-service","tokenHash":"3aee94700bb20f7fffd28a24aeda5fc6dedf91ebeff328e570ba89c7f8bd3c69","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768515465152,"env":"test","module":"auth-service","userId":"9C4ZanUVflaS-MIRdhx6p","tokenHash":"3aee94700bb20f7fffd28a24aeda5fc6dedf91ebeff328e570ba89c7f8bd3c69","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768515465245,"env":"test","module":"email-queue","jobId":"5f3178bd-cb9b-4c0a-8659-aa61750f8d27","to":"email-test@example.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mgetOrganizationMembers[2m > [22m[2mshould return all members of organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,87d21ce4-4515-42a8-a882-dc9f152bf2de,{"after":{"name":"Members Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'87d21ce4-4515-42a8-a882-dc9f152bf2de'[39m,
    [32m'{"after":{"name":"Members Test Org Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:160:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 48fc89361f0dfb3fde01d7ac54813ec8

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #3: Invite email failure rollback[2m > [22m[2mshould not create invite if email fails
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,4bab9d49-04b0-4fdc-93ec-56a8d15a11ff,organization.invite_send,organization,11fde38e-557c-4df3-b0b6-5ca13429b60e,{"after":{"invitedEmail":"email-test@example.com","token":"17ea9fbf95af5f7f59031a0e19a8f156240db03828582351520dec438467e3e4"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'4bab9d49-04b0-4fdc-93ec-56a8d15a11ff'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'11fde38e-557c-4df3-b0b6-5ca13429b60e'[39m,
    [32m'{"after":{"invitedEmail":"email-test@example.com","token":"17ea9fbf95af5f7f59031a0e19a8f156240db03828582351520dec438467e3e4"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:192:22
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould allow org member to transfer org-owned project to another org they belong to
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,18271d89-2f87-4513-9df9-daa6fdd6c76c,{"after":{"name":"Second Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'18271d89-2f87-4513-9df9-daa6fdd6c76c'[39m,
    [32m'{"after":{"name":"Second Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:154:26
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515465510,"env":"test","module":"user-credentials-repository","userId":"ruXfq_y4V0MPMr2GaR5vc","msg":"User credentials created"}
{"level":30,"time":1768515465517,"env":"test","module":"auth-routes","userId":"fccfca214907e9e4d9d8d243e3c977f1","msg":"User logged in successfully"}
{"level":50,"time":1768515465567,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"fccfca214907e9e4d9d8d243e3c977f1","login_success","security","fccfca214907e9e4d9d8d243e3c977f1","security","fccfca214907e9e4d9d8d243e3c977f1","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:45.517Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:45.517Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"fccfca214907e9e4d9d8d243e3c977f1","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,fccfca214907e9e4d9d8d243e3c977f1,login_success,security,fccfca214907e9e4d9d8d243e3c977f1,security,fccfca214907e9e4d9d8d243e3c977f1,{"metadata":{"timestamp":"2026-01-15T22:17:45.517Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:45.517Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'fccfca214907e9e4d9d8d243e3c977f1'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'fccfca214907e9e4d9d8d243e3c977f1'[39m,
    [32m'security'[39m,
    [32m'fccfca214907e9e4d9d8d243e3c977f1'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:45.517Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:45.517Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515465568,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"fccfca214907e9e4d9d8d243e3c977f1","login_success","security","fccfca214907e9e4d9d8d243e3c977f1","security","fccfca214907e9e4d9d8d243e3c977f1","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:45.517Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:45.517Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould login with valid backup code
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515465848,"env":"test","workflowId":"48a2aa56-81a2-4b3a-b6ab-dfaa8deed0ba","userId":"e654da23-84c2-4a6f-afa4-fc8301635752","sectionsCount":1,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould rotate refresh token after use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515465997,"env":"test","module":"user-credentials-repository","userId":"Lf4Qfz2d5am6Cy1FISo-u","msg":"User credentials created"}
{"level":30,"time":1768515466052,"env":"test","module":"auth-service","tokenHash":"18ec61f975deb8afa5ffe5ce9b0c97b77ad482630f35b8558d1a152378164277","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768515466073,"env":"test","module":"auth-routes","userId":"feae161edae080d346774a05bf390eaf","msg":"User logged in successfully"}
{"level":30,"time":1768515466078,"env":"test","module":"auth-routes","userId":"48fc89361f0dfb3fde01d7ac54813ec8","msg":"Login requires MFA verification"}
{"level":50,"time":1768515466121,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"feae161edae080d346774a05bf390eaf","login_success","security","feae161edae080d346774a05bf390eaf","security","feae161edae080d346774a05bf390eaf","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:46.074Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:46.074Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"feae161edae080d346774a05bf390eaf","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould login with valid backup code
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,feae161edae080d346774a05bf390eaf,login_success,security,feae161edae080d346774a05bf390eaf,security,feae161edae080d346774a05bf390eaf,{"metadata":{"timestamp":"2026-01-15T22:17:46.074Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:46.074Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'feae161edae080d346774a05bf390eaf'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'feae161edae080d346774a05bf390eaf'[39m,
    [32m'security'[39m,
    [32m'feae161edae080d346774a05bf390eaf'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:46.074Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:46.074Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515466121,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"feae161edae080d346774a05bf390eaf","login_success","security","feae161edae080d346774a05bf390eaf","security","feae161edae080d346774a05bf390eaf","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:46.074Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:46.074Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515466126,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768515466154,"env":"test","module":"email-queue","jobId":"bdef1ef4-2a95-4cd0-b5f4-8d641fa7bca0","to":"expired-test@example.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
{"level":30,"time":1768515466171,"env":"test","module":"mfa-service","userId":"48fc89361f0dfb3fde01d7ac54813ec8","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on each use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515466222,"env":"test","module":"auth-routes","userId":"48fc89361f0dfb3fde01d7ac54813ec8","msg":"MFA login successful"}
{"level":30,"time":1768515466248,"env":"test","workflowId":"48a2aa56-81a2-4b3a-b6ab-dfaa8deed0ba","userId":"200448ea-af70-4d8a-8773-572e1816bef3","sectionsCount":1,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #5: Expired invites[2m > [22m[2mshould allow re-invite after invite expires
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,4bab9d49-04b0-4fdc-93ec-56a8d15a11ff,organization.invite_send,organization,11fde38e-557c-4df3-b0b6-5ca13429b60e,{"after":{"invitedEmail":"expired-test@example.com","token":"9fdf709824db00b229898dd3acc97263ddc35de5391bb1b5199e6bddbf62f1e2"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'4bab9d49-04b0-4fdc-93ec-56a8d15a11ff'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'11fde38e-557c-4df3-b0b6-5ca13429b60e'[39m,
    [32m'{"after":{"invitedEmail":"expired-test@example.com","token":"9fdf709824db00b229898dd3acc97263ddc35de5391bb1b5199e6bddbf62f1e2"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:215:23
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515466280,"env":"test","error":{"error":{"code":"INTERNAL_ERROR","message":""}},"msg":"Failed to render template"}
{"level":30,"time":1768515466338,"env":"test","module":"auth-routes","userId":"fccfca214907e9e4d9d8d243e3c977f1","msg":"User logged in successfully"}
{"level":30,"time":1768515466344,"env":"test","module":"auth-routes","userId":"738b298c131a199123e82dfd13fcc231","msg":"User logged in successfully"}
{"level":30,"time":1768515466366,"env":"test","module":"auth-routes","userId":"48fc89361f0dfb3fde01d7ac54813ec8","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mpromoteMember[2m > [22m[2mshould allow admin to promote member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,a1bf459a-edcd-4020-b54b-6946a82ba95a,{"after":{"name":"Promote Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'a1bf459a-edcd-4020-b54b-6946a82ba95a'[39m,
    [32m'{"after":{"name":"Promote Test Org Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:179:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515466386,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"fccfca214907e9e4d9d8d243e3c977f1","login_success","security","fccfca214907e9e4d9d8d243e3c977f1","security","fccfca214907e9e4d9d8d243e3c977f1","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:46.338Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:46.338Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"fccfca214907e9e4d9d8d243e3c977f1","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,fccfca214907e9e4d9d8d243e3c977f1,login_success,security,fccfca214907e9e4d9d8d243e3c977f1,security,fccfca214907e9e4d9d8d243e3c977f1,{"metadata":{"timestamp":"2026-01-15T22:17:46.338Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:46.338Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'fccfca214907e9e4d9d8d243e3c977f1'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'fccfca214907e9e4d9d8d243e3c977f1'[39m,
    [32m'security'[39m,
    [32m'fccfca214907e9e4d9d8d243e3c977f1'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:46.338Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:46.338Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515466387,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"fccfca214907e9e4d9d8d243e3c977f1","login_success","security","fccfca214907e9e4d9d8d243e3c977f1","security","fccfca214907e9e4d9d8d243e3c977f1","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:46.338Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:46.338Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515466391,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"738b298c131a199123e82dfd13fcc231","login_success","security","738b298c131a199123e82dfd13fcc231","security","738b298c131a199123e82dfd13fcc231","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:46.344Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:46.344Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"738b298c131a199123e82dfd13fcc231","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768515466391,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould rotate refresh token after use
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,738b298c131a199123e82dfd13fcc231,login_success,security,738b298c131a199123e82dfd13fcc231,security,738b298c131a199123e82dfd13fcc231,{"metadata":{"timestamp":"2026-01-15T22:17:46.344Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:46.344Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'738b298c131a199123e82dfd13fcc231'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'738b298c131a199123e82dfd13fcc231'[39m,
    [32m'security'[39m,
    [32m'738b298c131a199123e82dfd13fcc231'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:46.344Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:46.344Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515466391,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"738b298c131a199123e82dfd13fcc231","login_success","security","738b298c131a199123e82dfd13fcc231","security","738b298c131a199123e82dfd13fcc231","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:46.344Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:46.344Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768515466396,"env":"test","module":"auth-service","tokenHash":"d79beea30431cf8ef2a0e00126d5d43cc571b2cc7ea95d37716fd2aa764c3142","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768515466459,"env":"test","module":"auth-routes","userId":"48fc89361f0dfb3fde01d7ac54813ec8","deviceCount":1,"msg":"Listed trusted devices"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould prevent inviting existing members
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,e16649a1-ad2e-43a1-bf52-f19e45adfef1,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'e16649a1-ad2e-43a1-bf52-f19e45adfef1'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515466554,"env":"test","module":"user-credentials-repository","userId":"MPocFnRavl559mzC3_ujb","msg":"User credentials created"}
{"level":30,"time":1768515466605,"env":"test","module":"auth-routes","userId":"48fc89361f0dfb3fde01d7ac54813ec8","deviceId":"fb174b60-3a0b-41a3-ba81-4bfd6047e077","msg":"Trusted device revoked"}
{"level":30,"time":1768515466607,"env":"test","module":"auth-service","tokenHash":"70a405e0a561bf91a248f9a04d024b8713cfee5da6205797487819eb161ee4ab","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768515466661,"env":"test","module":"auth-routes","userId":"911c12aa7c3e0843d7c09390d9cfea17","msg":"User logged in successfully"}
{"level":50,"time":1768515466706,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"911c12aa7c3e0843d7c09390d9cfea17","login_success","security","911c12aa7c3e0843d7c09390d9cfea17","security","911c12aa7c3e0843d7c09390d9cfea17","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:46.661Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:46.661Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"911c12aa7c3e0843d7c09390d9cfea17","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on each use
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,911c12aa7c3e0843d7c09390d9cfea17,login_success,security,911c12aa7c3e0843d7c09390d9cfea17,security,911c12aa7c3e0843d7c09390d9cfea17,{"metadata":{"timestamp":"2026-01-15T22:17:46.661Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:46.661Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'911c12aa7c3e0843d7c09390d9cfea17'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'911c12aa7c3e0843d7c09390d9cfea17'[39m,
    [32m'security'[39m,
    [32m'911c12aa7c3e0843d7c09390d9cfea17'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:46.661Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:46.661Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515466706,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"911c12aa7c3e0843d7c09390d9cfea17","login_success","security","911c12aa7c3e0843d7c09390d9cfea17","security","911c12aa7c3e0843d7c09390d9cfea17","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:46.661Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:46.661Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768515466712,"env":"test","module":"auth-service","tokenHash":"c25655a6e42baa3bc2838fdc664aab214ec7a1efeaa3665d35eba73ad6f1471c","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768515466748,"env":"test","module":"auth-routes","userId":"48fc89361f0dfb3fde01d7ac54813ec8","deviceCount":0,"msg":"Listed trusted devices"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mpromoteMember[2m > [22m[2mshould allow admin to promote member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.member_promote,organization,a1bf459a-edcd-4020-b54b-6946a82ba95a,{"after":{"userId":"00000000-0000-0000-0000-000000000012","newRole":"admin"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.member_promote'[39m,
    [32m'organization'[39m,
    [32m'a1bf459a-edcd-4020-b54b-6946a82ba95a'[39m,
    [32m'{"after":{"userId":"00000000-0000-0000-0000-000000000012","newRole":"admin"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.promoteMember (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:248:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:186:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould detach workflow from project when transferring to different owner
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,a065548c-3f79-4be0-9ba5-c5ce75508b8d,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'a065548c-3f79-4be0-9ba5-c5ce75508b8d'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515466881,"env":"test","module":"auth-service","tokenHash":"d79beea30431cf8ef2a0e00126d5d43cc571b2cc7ea95d37716fd2aa764c3142","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768515466926,"env":"test","module":"auth-service","userId":"738b298c131a199123e82dfd13fcc231","tokenHash":"d79beea30431cf8ef2a0e00126d5d43cc571b2cc7ea95d37716fd2aa764c3142","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768515467076,"env":"test","module":"email-queue","jobId":"72e01b20-ec5c-4b66-9bc6-c6b3f4ac5e10","to":"expired-test@example.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
{"level":30,"time":1768515467103,"env":"test","module":"user-credentials-repository","userId":"cXrkZQUpNidhPagZZ59SI","msg":"User credentials created"}
{"level":30,"time":1768515467156,"env":"test","module":"auth-service","tokenHash":"eb3092332033f7a6507a8f10fb0f06b70b7ca3e6e277bc2d89da63cd2b4acdcd","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould detach workflow from project when transferring to different owner
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:187:30
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #5: Expired invites[2m > [22m[2mshould allow re-invite after invite expires
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,4bab9d49-04b0-4fdc-93ec-56a8d15a11ff,organization.invite_send,organization,11fde38e-557c-4df3-b0b6-5ca13429b60e,{"after":{"invitedEmail":"expired-test@example.com","token":"638d4a8731ffc55a72bc3d2da53321fc434383d66ea4db7d37f690e97de2b12b"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'4bab9d49-04b0-4fdc-93ec-56a8d15a11ff'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'11fde38e-557c-4df3-b0b6-5ca13429b60e'[39m,
    [32m'{"after":{"invitedEmail":"expired-test@example.com","token":"638d4a8731ffc55a72bc3d2da53321fc434383d66ea4db7d37f690e97de2b12b"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:224:23
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515467198,"env":"test","module":"auth-service","tokenHash":"4b5f03f373fba30f53d67ce16265abb6baf16389cd63f59ae88fe473199eef3b","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768515467397,"env":"test","module":"auth-service","tokenHash":"1f5c0a828ad77ca299636f91e4677223eea0d17555c0375e81bd61cbbb74cc5c","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mComplete Organization Workflow[2m > [22m[2mStep 14: Remove member from org
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,200448ea-af70-4d8a-8773-572e1816bef3,organization.member_remove,organization,36a4d9dc-b98c-407f-ab72-a5f447034783,{"after":{"removedUserId":"e654da23-84c2-4a6f-afa4-fc8301635752"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'200448ea-af70-4d8a-8773-572e1816bef3'[39m,
    [32m'organization.member_remove'[39m,
    [32m'organization'[39m,
    [32m'36a4d9dc-b98c-407f-ab72-a5f447034783'[39m,
    [32m'{"after":{"removedUserId":"e654da23-84c2-4a6f-afa4-fc8301635752"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.removeMember (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:343:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:285:7
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould mark backup code as used
[22m[39m[TEST UTILS] MFA Secret verified for 979c550f03a6c82b0592486bbf5085f9

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking current session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515467642,"env":"test","module":"user-credentials-repository","userId":"kqovKsXNXQQBiLBcMFEpF","msg":"User credentials created"}
{"level":30,"time":1768515467697,"env":"test","module":"auth-service","tokenHash":"dd315ba62c3287f5bcfc50ad9d98b2706447d7b50ef7ca37c4576e3117a71865","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for 7b2553c55c34aa3c203036246956165d

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould require admin access to create invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,02b4667a-4c32-4656-a7ae-34c02b186547,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'02b4667a-4c32-4656-a7ae-34c02b186547'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515468070,"env":"test","module":"auth-routes","userId":"61a9b09ba46a8a8346e26736d5aae0c4","msg":"User logged in successfully"}
{"level":30,"time":1768515468106,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515468107,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768515468119,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"61a9b09ba46a8a8346e26736d5aae0c4","login_success","security","61a9b09ba46a8a8346e26736d5aae0c4","security","61a9b09ba46a8a8346e26736d5aae0c4","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:48.070Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:48.070Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"61a9b09ba46a8a8346e26736d5aae0c4","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking current session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,61a9b09ba46a8a8346e26736d5aae0c4,login_success,security,61a9b09ba46a8a8346e26736d5aae0c4,security,61a9b09ba46a8a8346e26736d5aae0c4,{"metadata":{"timestamp":"2026-01-15T22:17:48.070Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:48.070Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'61a9b09ba46a8a8346e26736d5aae0c4'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'61a9b09ba46a8a8346e26736d5aae0c4'[39m,
    [32m'security'[39m,
    [32m'61a9b09ba46a8a8346e26736d5aae0c4'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:48.070Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:48.070Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515468119,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"61a9b09ba46a8a8346e26736d5aae0c4","login_success","security","61a9b09ba46a8a8346e26736d5aae0c4","security","61a9b09ba46a8a8346e26736d5aae0c4","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:48.070Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:48.070Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515468123,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
 [31m‚ùØ[39m tests/integration/auth/oauth2.token-refresh.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 21951[2mms[22m[39m
       [33m[2m‚úì[22m[39m should refresh access token with valid refresh token [33m 653[2mms[22m[39m
       [33m[2m‚úì[22m[39m should rotate refresh token after use [33m 685[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 when refresh token is missing [33m 377[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for invalid refresh token [33m 1005[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for expired refresh token [33m 790[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for revoked refresh token [33m 554[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 when user is not found [33m 869[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update refresh token metadata on rotation [33m 660[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle concurrent refresh token requests (token reuse detection) [33m 819[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set secure cookie in production [33m 590[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set proper cookie attributes [33m 600[2mms[22m[39m
       [33m[2m‚úì[22m[39m should include user role information in response [33m 601[2mms[22m[39m
[31m       [31m√ó[31m should create refresh token on login[39m[33m 991[2mms[22m[39m
       [33m[2m‚úì[22m[39m should revoke refresh token on logout [33m 521[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle logout without refresh token gracefully [33m 469[2mms[22m[39m
       [33m[2m‚úì[22m[39m should support multiple active refresh tokens per user [33m 602[2mms[22m[39m
       [33m[2m‚úì[22m[39m should revoke all user tokens on password reset [33m 583[2mms[22m[39m
       [33m[2m‚úì[22m[39m should use cryptographically strong random tokens [33m 5333[2mms[22m[39m
       [33m[2m‚úì[22m[39m should hash refresh tokens before storing in database [33m 456[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent refresh token reuse after rotation [33m 650[2mms[22m[39m
       [33m[2m‚úì[22m[39m should validate token ownership [33m 456[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set HttpOnly flag to prevent XSS [33m 585[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set SameSite=Strict to prevent CSRF [33m 556[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set proper cookie path [33m 539[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set appropriate expiry (30 days) [33m 549[2mms[22m[39m
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #7: Delete organization[2m > [22m[2mshould allow last admin to delete empty organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,4bab9d49-04b0-4fdc-93ec-56a8d15a11ff,organization.create,organization,370704cf-4898-404b-bdd5-593ca30acdbc,{"after":{"name":"Delete Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'4bab9d49-04b0-4fdc-93ec-56a8d15a11ff'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'370704cf-4898-404b-bdd5-593ca30acdbc'[39m,
    [32m'{"after":{"name":"Delete Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:244:19
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515468347,"env":"test","workflowId":"48a2aa56-81a2-4b3a-b6ab-dfaa8deed0ba","userId":"e654da23-84c2-4a6f-afa4-fc8301635752","sectionsCount":1,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mdemoteMember[2m > [22m[2mshould allow admin to demote other admin
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,050d4602-3a10-4925-a2ef-82548a975f39,{"after":{"name":"Demote Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'050d4602-3a10-4925-a2ef-82548a975f39'[39m,
    [32m'{"after":{"name":"Demote Test Org Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:197:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515468428,"env":"test","module":"email-queue","jobId":"107ca93c-ad5e-4685-84b6-d6dba1a6a8bc","to":"test-1768515467870-c1kov@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768515468428,"env":"test","module":"auth-service","email":"test-1768515467870-c1kov@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould keep workflow in project when transferring to same owner
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,339c63c6-c99f-4fcb-be45-309a8d9f602a,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'339c63c6-c99f-4fcb-be45-309a8d9f602a'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515468485,"env":"test","module":"auth-routes","userId":"7b2553c55c34aa3c203036246956165d","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect and prevent refresh token reuse (token theft)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515468581,"env":"test","module":"mfa-service","userId":"7b2553c55c34aa3c203036246956165d","msg":"TOTP verification successful"}
{"level":30,"time":1768515468629,"env":"test","module":"auth-routes","userId":"7b2553c55c34aa3c203036246956165d","msg":"MFA login successful"}
{"level":30,"time":1768515468812,"env":"test","module":"email-queue","jobId":"d2e279e6-612e-4a76-9e35-707260bf5fea","to":"duplicate@test.com","subject":"You've been invited to join Test Organization","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould set expiry to 7 days from now
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,8ac11435-62bf-4dce-a5a4-0eaf9bc3523f,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'8ac11435-62bf-4dce-a5a4-0eaf9bc3523f'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould prevent backup code reuse
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mdemoteMember[2m > [22m[2mshould allow admin to demote other admin
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.member_demote,organization,050d4602-3a10-4925-a2ef-82548a975f39,{"after":{"userId":"00000000-0000-0000-0000-000000000012","newRole":"member"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.member_demote'[39m,
    [32m'organization'[39m,
    [32m'050d4602-3a10-4925-a2ef-82548a975f39'[39m,
    [32m'{"after":{"userId":"00000000-0000-0000-0000-000000000012","newRole":"member"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.demoteMember (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:296:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:204:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould keep workflow in project when transferring to same owner
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:215:30
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mEdge Cases and Security[2m > [22m[2mCannot invite same email twice (pending invite exists)
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,200448ea-af70-4d8a-8773-572e1816bef3,organization.invite_send,organization,36a4d9dc-b98c-407f-ab72-a5f447034783,{"after":{"invitedEmail":"duplicate@test.com","token":"0aa3d5eb47471e7fabec1bddff7f4110f86e2d5a38110e84e9fabc38931cb8d1"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'200448ea-af70-4d8a-8773-572e1816bef3'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'36a4d9dc-b98c-407f-ab72-a5f447034783'[39m,
    [32m'{"after":{"invitedEmail":"duplicate@test.com","token":"0aa3d5eb47471e7fabec1bddff7f4110f86e2d5a38110e84e9fabc38931cb8d1"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:323:23
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515468999,"env":"test","module":"auth-routes","userId":"15618f6c1b2c3d23853033833919b723","msg":"User logged in successfully"}
{"level":50,"time":1768515469052,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"15618f6c1b2c3d23853033833919b723","login_success","security","15618f6c1b2c3d23853033833919b723","security","15618f6c1b2c3d23853033833919b723","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:48.999Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:48.999Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"15618f6c1b2c3d23853033833919b723","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect and prevent refresh token reuse (token theft)
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,15618f6c1b2c3d23853033833919b723,login_success,security,15618f6c1b2c3d23853033833919b723,security,15618f6c1b2c3d23853033833919b723,{"metadata":{"timestamp":"2026-01-15T22:17:48.999Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:48.999Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'15618f6c1b2c3d23853033833919b723'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'15618f6c1b2c3d23853033833919b723'[39m,
    [32m'security'[39m,
    [32m'15618f6c1b2c3d23853033833919b723'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:48.999Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:48.999Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515469052,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"15618f6c1b2c3d23853033833919b723","login_success","security","15618f6c1b2c3d23853033833919b723","security","15618f6c1b2c3d23853033833919b723","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:48.999Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:48.999Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768515469057,"env":"test","module":"auth-service","tokenHash":"66a19f5c486734c4b0e4e6365c8bc731ec656b237dbb64fc40020ad2fe5cc245","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #7: Delete organization[2m > [22m[2mshould prevent deletion if org owns assets
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,4bab9d49-04b0-4fdc-93ec-56a8d15a11ff,organization.create,organization,4d785a78-8a49-4982-b15c-397a259b9e6d,{"after":{"name":"Has Assets Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'4bab9d49-04b0-4fdc-93ec-56a8d15a11ff'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'4d785a78-8a49-4982-b15c-397a259b9e6d'[39m,
    [32m'{"after":{"name":"Has Assets Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:262:19
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515469310,"env":"test","module":"auth-routes","userId":"fdd963102a8a12809444d33e4a39b945","msg":"User logged in successfully"}
{"level":50,"time":1768515469362,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"fdd963102a8a12809444d33e4a39b945","login_success","security","fdd963102a8a12809444d33e4a39b945","security","fdd963102a8a12809444d33e4a39b945","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:49.310Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:49.310Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"fdd963102a8a12809444d33e4a39b945","eventType":"login_success","msg":"Failed to log security event"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould return 404 for non-existent session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould prevent backup code reuse
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,fdd963102a8a12809444d33e4a39b945,login_success,security,fdd963102a8a12809444d33e4a39b945,security,fdd963102a8a12809444d33e4a39b945,{"metadata":{"timestamp":"2026-01-15T22:17:49.310Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:49.310Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'fdd963102a8a12809444d33e4a39b945'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'fdd963102a8a12809444d33e4a39b945'[39m,
    [32m'security'[39m,
    [32m'fdd963102a8a12809444d33e4a39b945'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:49.310Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:49.310Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515469362,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"fdd963102a8a12809444d33e4a39b945","login_success","security","fdd963102a8a12809444d33e4a39b945","security","fdd963102a8a12809444d33e4a39b945","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:49.310Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:49.310Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #7: Delete organization[2m > [22m[2mshould prevent deletion if org owns assets
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:267:24
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

{"level":50,"time":1768515469371,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768515469377,"env":"test","module":"email-queue","jobId":"b585fe7a-0e3f-4605-b8af-297c74ebe2ef","to":"newuser_1768515458508@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould set expiry to 7 days from now
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,8ac11435-62bf-4dce-a5a4-0eaf9bc3523f,{"after":{"invitedEmail":"newuser_1768515458508@test.com","token":"f9cd34caf8a93ffe1dd967af60504f10d5142c4d88eb42ba999186211fa04fd3"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'8ac11435-62bf-4dce-a5a4-0eaf9bc3523f'[39m,
    [32m'{"after":{"invitedEmail":"newuser_1768515458508@test.com","token":"f9cd34caf8a93ffe1dd967af60504f10d5142c4d88eb42ba999186211fa04fd3"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:143:28
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515469533,"env":"test","module":"auth-service","tokenHash":"66a19f5c486734c4b0e4e6365c8bc731ec656b237dbb64fc40020ad2fe5cc245","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w47
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w47,public

{"level":30,"time":1768515469579,"env":"test","module":"email-queue","jobId":"6f96da46-5c39-4382-8040-ec95e09f7af1","to":"test-1768515469021-2jorvw@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":40,"time":1768515469579,"env":"test","module":"auth-service","userId":"15618f6c1b2c3d23853033833919b723","tokenHash":"66a19f5c486734c4b0e4e6365c8bc731ec656b237dbb64fc40020ad2fe5cc245","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768515469579,"env":"test","module":"auth-service","email":"test-1768515469021-2jorvw@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768515469616,"env":"test","module":"email-queue","jobId":"afa7a07e-a7ed-4287-a289-8d96e6aa717d","to":"expired@test.com","subject":"You've been invited to join Test Organization","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w47 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w47%2Cpublic

[90mstderr[2m | tests/unit/services/AuthService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17[90m)[39m
    at Object.get [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:144:34
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m {
  codeFrame: [32m'vi.mock(import("../../../server/db"), async (importOriginal) => {\n'[39m +
    [32m'  const actual = await importOriginal()\n'[39m +
    [32m'  return {\n'[39m +
    [32m'    ...actual,\n'[39m +
    [32m'    // your mocked methods\n'[39m +
    [32m'  }\n'[39m +
    [32m'})'[39m
}

[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mEdge Cases and Security[2m > [22m[2mCannot accept expired invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,200448ea-af70-4d8a-8773-572e1816bef3,organization.invite_send,organization,36a4d9dc-b98c-407f-ab72-a5f447034783,{"after":{"invitedEmail":"expired@test.com","token":"db32da72f9acb476c81a8c494377d7a4ddf3a4c0670cb790e219c7384810950b"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'200448ea-af70-4d8a-8773-572e1816bef3'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'36a4d9dc-b98c-407f-ab72-a5f447034783'[39m,
    [32m'{"after":{"invitedEmail":"expired@test.com","token":"db32da72f9acb476c81a8c494377d7a4ddf3a4c0670cb790e219c7384810950b"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:348:22
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for b93ec3b771e921eeb0fde766633cbb48

{"level":30,"time":1768515469824,"env":"test","module":"auth-routes","userId":"273ee005f96ae56c899ba702c927f10e","msg":"User logged in successfully"}
{"level":50,"time":1768515469868,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"273ee005f96ae56c899ba702c927f10e","login_success","security","273ee005f96ae56c899ba702c927f10e","security","273ee005f96ae56c899ba702c927f10e","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:49.824Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:49.824Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"273ee005f96ae56c899ba702c927f10e","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould return 404 for non-existent session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,273ee005f96ae56c899ba702c927f10e,login_success,security,273ee005f96ae56c899ba702c927f10e,security,273ee005f96ae56c899ba702c927f10e,{"metadata":{"timestamp":"2026-01-15T22:17:49.824Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:49.824Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'273ee005f96ae56c899ba702c927f10e'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'273ee005f96ae56c899ba702c927f10e'[39m,
    [32m'security'[39m,
    [32m'273ee005f96ae56c899ba702c927f10e'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:49.824Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:49.824Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515469869,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"273ee005f96ae56c899ba702c927f10e","login_success","security","273ee005f96ae56c899ba702c927f10e","security","273ee005f96ae56c899ba702c927f10e","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:49.824Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:49.824Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515469873,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768515469938,"env":"test","module":"user-credentials-repository","userId":"3a165de1558f133f230ff96a065f7c0e","msg":"User password updated"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould prevent non-member from transferring org workflow
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,fc397fa9-e216-4720-9cd4-d57876e8ed0e,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'fc397fa9-e216-4720-9cd4-d57876e8ed0e'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mdemoteMember[2m > [22m[2mshould prevent self-demotion
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,cb33b808-02c0-44d1-a88d-1a071b0f7046,{"after":{"name":"Self Demote Test Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'cb33b808-02c0-44d1-a88d-1a071b0f7046'[39m,
    [32m'{"after":{"name":"Self Demote Test Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:213:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515470075,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"3a165de1558f133f230ff96a065f7c0e","password_reset","security","3a165de1558f133f230ff96a065f7c0e","security","3a165de1558f133f230ff96a065f7c0e","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:50.025Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:50.025Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"3a165de1558f133f230ff96a065f7c0e","eventType":"password_reset","msg":"Failed to log security event"}
{"level":50,"time":1768515470075,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"3a165de1558f133f230ff96a065f7c0e","password_reset","security","3a165de1558f133f230ff96a065f7c0e","security","3a165de1558f133f230ff96a065f7c0e","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:50.025Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:50.025Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Reset password error"}
{"level":30,"time":1768515470237,"env":"test","module":"email-queue","jobId":"cacd0895-7f34-4c02-85d3-32a316adbdcb","to":"placeholder-test@example.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #8: Placeholder user cleanup[2m > [22m[2mshould cleanup placeholder user when invite is revoked
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,4bab9d49-04b0-4fdc-93ec-56a8d15a11ff,organization.invite_send,organization,11fde38e-557c-4df3-b0b6-5ca13429b60e,{"after":{"invitedEmail":"placeholder-test@example.com","token":"70b0b2b1091305965ac10d508ea51bc8a913b88007e78975f0f031a509956f7b"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'4bab9d49-04b0-4fdc-93ec-56a8d15a11ff'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'11fde38e-557c-4df3-b0b6-5ca13429b60e'[39m,
    [32m'{"after":{"invitedEmail":"placeholder-test@example.com","token":"70b0b2b1091305965ac10d508ea51bc8a913b88007e78975f0f031a509956f7b"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:295:22
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould prevent non-member from transferring org workflow
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:236:30
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for c22a37e7e584866eea9db785fc695af5

[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mEdge Cases and Security[2m > [22m[2mCannot transfer workflow to org user is not a member of
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,ce26655c-33c4-401f-8743-dc221f97f8cd,organization.create,organization,2d75995a-f9e4-49ac-9a69-d74f2bf0a1fc,{"after":{"name":"Other Organization","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'ce26655c-33c4-401f-8743-dc221f97f8cd'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'2d75995a-f9e4-49ac-9a69-d74f2bf0a1fc'[39m,
    [32m'{"after":{"name":"Other Organization","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:373:20
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould accept invite and create membership
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,fe2d8e01-5004-435e-a4cf-534b3e10283d,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'fe2d8e01-5004-435e-a4cf-534b3e10283d'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould try TOTP before backup code
[22m[39m[TEST UTILS] MFA Secret verified for 66307e755ff6b89ea5b619f745c9bcac

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #8: Placeholder user cleanup[2m > [22m[2mshould cleanup placeholder user when invite is revoked
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: e5d007e9-20b3-4f1a-901c-e12be6bbb60d,4bab9d49-04b0-4fdc-93ec-56a8d15a11ff,organization.invite_revoke,organization,11fde38e-557c-4df3-b0b6-5ca13429b60e,{"after":{"inviteId":"7455a04a-4243-4c30-a190-bc5b01e95f93","email":"placeholder-test@example.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [32m'e5d007e9-20b3-4f1a-901c-e12be6bbb60d'[39m,
    [32m'4bab9d49-04b0-4fdc-93ec-56a8d15a11ff'[39m,
    [32m'organization.invite_revoke'[39m,
    [32m'organization'[39m,
    [32m'11fde38e-557c-4df3-b0b6-5ca13429b60e'[39m,
    [32m'{"after":{"inviteId":"7455a04a-4243-4c30-a190-bc5b01e95f93","email":"placeholder-test@example.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.revokeInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:840:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:305:7
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould try TOTP before backup code
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515471159,"env":"test","module":"auth-routes","userId":"b93ec3b771e921eeb0fde766633cbb48","msg":"Login requires MFA verification"}
{"level":30,"time":1768515471159,"env":"test","module":"auth-routes","userId":"b606afb0852dd1539b36157bb73d97b8","msg":"User logged in successfully"}
{"level":30,"time":1768515471190,"env":"test","module":"email-queue","jobId":"f11b1097-4206-4845-ac55-67591625695e","to":"existing_1768515458508@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":50,"time":1768515471202,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"b606afb0852dd1539b36157bb73d97b8","login_success","security","b606afb0852dd1539b36157bb73d97b8","security","b606afb0852dd1539b36157bb73d97b8","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:51.159Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:17:51.159Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"b606afb0852dd1539b36157bb73d97b8","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,b606afb0852dd1539b36157bb73d97b8,login_success,security,b606afb0852dd1539b36157bb73d97b8,security,b606afb0852dd1539b36157bb73d97b8,{"metadata":{"timestamp":"2026-01-15T22:17:51.159Z"}},::ffff:127.0.0.1,Mozilla/5.0 (Windows NT 10.0; Win64; x64),2026-01-15T22:17:51.159Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'b606afb0852dd1539b36157bb73d97b8'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'b606afb0852dd1539b36157bb73d97b8'[39m,
    [32m'security'[39m,
    [32m'b606afb0852dd1539b36157bb73d97b8'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:51.159Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [32m'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'[39m,
    [32m'2026-01-15T22:17:51.159Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515471202,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"b606afb0852dd1539b36157bb73d97b8","login_success","security","b606afb0852dd1539b36157bb73d97b8","security","b606afb0852dd1539b36157bb73d97b8","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:51.159Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:17:51.159Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515471254,"env":"test","module":"mfa-service","userId":"b93ec3b771e921eeb0fde766633cbb48","msg":"TOTP verification successful"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould accept invite and create membership
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,fe2d8e01-5004-435e-a4cf-534b3e10283d,{"after":{"invitedEmail":"existing_1768515458508@test.com","token":"e17ce9b0eec4a29d3a55294a982dcb85be088a0255c69c177d0ccb9f4aea1b15"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'fe2d8e01-5004-435e-a4cf-534b3e10283d'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768515458508@test.com","token":"e17ce9b0eec4a29d3a55294a982dcb85be088a0255c69c177d0ccb9f4aea1b15"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:165:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515471299,"env":"test","module":"auth-routes","userId":"b93ec3b771e921eeb0fde766633cbb48","msg":"MFA login successful"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mremoveMember[2m > [22m[2mshould allow admin to remove member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,596373e3-8f77-462f-bde5-78099229abab,{"after":{"name":"Remove Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'596373e3-8f77-462f-bde5-78099229abab'[39m,
    [32m'{"after":{"name":"Remove Test Org Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:227:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #8: Placeholder user cleanup[2m > [22m[2mshould cleanup placeholder user when invite is revoked
[22m[39mCleaned up placeholder user 4a4b502c-041b-4b74-abbb-34cfc6abb12f (no pending invites or memberships)

{"level":30,"time":1768515471441,"env":"test","module":"auth-routes","userId":"b93ec3b771e921eeb0fde766633cbb48","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768515471455,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515471455,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/organizations-workflow.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 10338[2mms[22m[39m
       [33m[2m‚úì[22m[39m Step 1: Create organization [33m 822[2mms[22m[39m
       [33m[2m‚úì[22m[39m Step 2: Invite member via email [33m 888[2mms[22m[39m
       [33m[2m‚úì[22m[39m Step 3: Accept invite [33m 808[2mms[22m[39m
       [33m[2m‚úì[22m[39m Step 6: Org member (user2) can access workflow [33m 527[2mms[22m[39m
       [33m[2m‚úì[22m[39m Step 16: Re-add member and verify access restored [33m 666[2mms[22m[39m
       [33m[2m‚úì[22m[39m Cannot invite same email twice (pending invite exists) [33m 794[2mms[22m[39m
       [33m[2m‚úì[22m[39m Cannot accept expired invite [33m 717[2mms[22m[39m
       [33m[2m‚úì[22m[39m Cannot transfer workflow to org user is not a member of [33m 1018[2mms[22m[39m
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking other user's session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515471535,"env":"test","module":"auth-routes","userId":"66307e755ff6b89ea5b619f745c9bcac","msg":"Login requires MFA verification"}
{"level":30,"time":1768515471536,"env":"test","module":"auth-routes","userId":"b93ec3b771e921eeb0fde766633cbb48","deviceCount":1,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515471542,"env":"test","module":"email-queue","jobId":"69570a9e-b748-499b-b7f2-bfc38425f6f1","to":"test-1768515470992-mc6qfi@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768515471543,"env":"test","module":"auth-service","email":"test-1768515470992-mc6qfi@example.com","msg":"Password reset email sent"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould transfer database ownership
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,31216592-8a3b-4de6-a221-0bfa450901c1,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'31216592-8a3b-4de6-a221-0bfa450901c1'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515471626,"env":"test","module":"mfa-service","userId":"66307e755ff6b89ea5b619f745c9bcac","msg":"TOTP verification successful"}
{"level":30,"time":1768515471672,"env":"test","module":"auth-routes","userId":"66307e755ff6b89ea5b619f745c9bcac","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mremoveMember[2m > [22m[2mshould allow admin to remove member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.member_remove,organization,596373e3-8f77-462f-bde5-78099229abab,{"after":{"removedUserId":"00000000-0000-0000-0000-000000000012"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.member_remove'[39m,
    [32m'organization'[39m,
    [32m'596373e3-8f77-462f-bde5-78099229abab'[39m,
    [32m'{"after":{"removedUserId":"00000000-0000-0000-0000-000000000012"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.removeMember (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:343:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:234:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #9: Transfer validation order[2m > [22m[2mshould fail fast on non-existent org
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:324:24
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

{"level":30,"time":1768515471947,"env":"test","module":"auth-routes","userId":"b606afb0852dd1539b36157bb73d97b8","msg":"User logged in successfully"}
{"level":30,"time":1768515471954,"env":"test","module":"auth-routes","userId":"d6efa9efb0bc88a7d5fc861f137e35f9","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould accept invite and create membership
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000022,organization.invite_accept,organization,fe2d8e01-5004-435e-a4cf-534b3e10283d,{"after":{"email":"existing_1768515458508@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000022'[39m,
    [32m'organization.invite_accept'[39m,
    [32m'organization'[39m,
    [32m'fe2d8e01-5004-435e-a4cf-534b3e10283d'[39m,
    [32m'{"after":{"email":"existing_1768515458508@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:171:28
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515471984,"env":"test","module":"auth-routes","userId":"c22a37e7e584866eea9db785fc695af5","msg":"Login requires MFA verification"}
{"level":50,"time":1768515471990,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"b606afb0852dd1539b36157bb73d97b8","login_success","security","b606afb0852dd1539b36157bb73d97b8","security","b606afb0852dd1539b36157bb73d97b8","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:51.948Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)","2026-01-15T22:17:51.948Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"b606afb0852dd1539b36157bb73d97b8","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,b606afb0852dd1539b36157bb73d97b8,login_success,security,b606afb0852dd1539b36157bb73d97b8,security,b606afb0852dd1539b36157bb73d97b8,{"metadata":{"timestamp":"2026-01-15T22:17:51.948Z"}},::ffff:127.0.0.1,Mozilla/5.0 (iPhone; CPU iPhone OS 14_0),2026-01-15T22:17:51.948Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'b606afb0852dd1539b36157bb73d97b8'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'b606afb0852dd1539b36157bb73d97b8'[39m,
    [32m'security'[39m,
    [32m'b606afb0852dd1539b36157bb73d97b8'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:51.948Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [32m'Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)'[39m,
    [32m'2026-01-15T22:17:51.948Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515471990,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"b606afb0852dd1539b36157bb73d97b8","login_success","security","b606afb0852dd1539b36157bb73d97b8","security","b606afb0852dd1539b36157bb73d97b8","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:51.948Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)","2026-01-15T22:17:51.948Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515471996,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768515472002,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"d6efa9efb0bc88a7d5fc861f137e35f9","login_success","security","d6efa9efb0bc88a7d5fc861f137e35f9","security","d6efa9efb0bc88a7d5fc861f137e35f9","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:51.954Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:51.954Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"d6efa9efb0bc88a7d5fc861f137e35f9","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking other user's session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,d6efa9efb0bc88a7d5fc861f137e35f9,login_success,security,d6efa9efb0bc88a7d5fc861f137e35f9,security,d6efa9efb0bc88a7d5fc861f137e35f9,{"metadata":{"timestamp":"2026-01-15T22:17:51.954Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:51.954Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'd6efa9efb0bc88a7d5fc861f137e35f9'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'd6efa9efb0bc88a7d5fc861f137e35f9'[39m,
    [32m'security'[39m,
    [32m'd6efa9efb0bc88a7d5fc861f137e35f9'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:51.954Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:51.954Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515472002,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"d6efa9efb0bc88a7d5fc861f137e35f9","login_success","security","d6efa9efb0bc88a7d5fc861f137e35f9","security","d6efa9efb0bc88a7d5fc861f137e35f9","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:51.954Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:51.954Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking other user's session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515472082,"env":"test","module":"mfa-service","userId":"c22a37e7e584866eea9db785fc695af5","msg":"TOTP verification successful"}
{"level":30,"time":1768515472127,"env":"test","module":"auth-routes","userId":"c22a37e7e584866eea9db785fc695af5","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515472366,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515472366,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/engine/templateNode.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 11390[2mms[22m[39m
       [33m[2m‚úì[22m[39m should resolve template by key from workflowTemplates mapping [33m 711[2mms[22m[39m
       [33m[2m‚úì[22m[39m should throw error if template key not found [33m 563[2mms[22m[39m
       [33m[2m‚úì[22m[39m should store output in runOutputs table [33m 705[2mms[22m[39m
       [33m[2m‚úì[22m[39m should resolve template by templateId directly [33m 564[2mms[22m[39m
       [33m[2m‚úì[22m[39m should throw error if templateId not found [33m 544[2mms[22m[39m
       [33m[2m‚úì[22m[39m should use docxRenderer2 by default (v2 engine) [33m 610[2mms[22m[39m
       [33m[2m‚úì[22m[39m should use legacy engine when engine="legacy" [33m 547[2mms[22m[39m
       [33m[2m‚úì[22m[39m should generate PDF when toPdf=true [33m 701[2mms[22m[39m
       [33m[2m‚úì[22m[39m should default to DOCX when toPdf=false [33m 788[2mms[22m[39m
       [33m[2m‚úì[22m[39m should skip execution when condition evaluates to false [33m 512[2mms[22m[39m
       [33m[2m‚úì[22m[39m should execute when condition evaluates to true [33m 549[2mms[22m[39m
       [33m[2m‚úì[22m[39m should resolve simple bindings [33m 549[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle binding resolution errors gracefully [33m 492[2mms[22m[39m
       [33m[2m‚úì[22m[39m should record failed output in runOutputs table [33m 802[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not throw errors (should return error in result) [33m 545[2mms[22m[39m
       [33m[2m‚úì[22m[39m should deny access to templates from different tenant [33m 534[2mms[22m[39m
       [33m[2m‚úì[22m[39m should require either templateKey or templateId [33m 512[2mms[22m[39m
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/PdfQueueService.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 11879[2mms[22m[39m
       [33m[2m‚úì[22m[39m should enqueue a PDF conversion job [33m 680[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create output with empty storagePath initially [33m 649[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return job status for pending job [33m 646[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return null for non-existent job [33m 586[2mms[22m[39m
       [33m[2m‚úì[22m[39m should parse attempt count from error field [33m 652[2mms[22m[39m
       [33m[2m‚úì[22m[39m should convert DOCX to PDF immediately [33m 691[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle conversion errors gracefully [33m 638[2mms[22m[39m
       [33m[2m‚úì[22m[39m should start and stop service [33m 839[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not start if already running [33m 541[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle stop when not running [33m 529[2mms[22m[39m
       [33m[2m‚úì[22m[39m should process pending jobs when queue is processed [33m 947[2mms[22m[39m
       [33m[2m‚úì[22m[39m should process multiple jobs in batch [33m 1172[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle missing DOCX output gracefully [33m 733[2mms[22m[39m
       [33m[2m‚úì[22m[39m should support enqueue within transaction [33m 722[2mms[22m[39m
       [33m[2m‚úì[22m[39m should support convertImmediate within transaction [33m 711[2mms[22m[39m
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mGET /api/auth/me[2m > [22m[2mshould return current user for valid token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return MFA status for user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515472643,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515472644,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/organizations-audit-fixes.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 12493[2mms[22m[39m
       [33m[2m‚úì[22m[39m should cascade ownership to workflow runs when project is transferred [33m 1096[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent double-acceptance via transaction [33m 1656[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not create invite if email fails [33m 917[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow re-invite after invite expires [33m 1884[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow last admin to delete empty organization [33m 1062[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent deletion if org owns assets [33m 1105[2mms[22m[39m
       [33m[2m‚úì[22m[39m should cleanup placeholder user when invite is revoked [33m 1915[2mms[22m[39m
       [33m[2m‚úì[22m[39m should fail fast on non-existent org [33m 345[2mms[22m[39m
{"level":30,"time":1768515472762,"env":"test","module":"auth-routes","userId":"e085498c01407aed0e4e1415e132f37c","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

{"level":50,"time":1768515472813,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"e085498c01407aed0e4e1415e132f37c","login_success","security","e085498c01407aed0e4e1415e132f37c","security","e085498c01407aed0e4e1415e132f37c","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:52.762Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:52.762Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"e085498c01407aed0e4e1415e132f37c","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking other user's session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,e085498c01407aed0e4e1415e132f37c,login_success,security,e085498c01407aed0e4e1415e132f37c,security,e085498c01407aed0e4e1415e132f37c,{"metadata":{"timestamp":"2026-01-15T22:17:52.762Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:52.762Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'e085498c01407aed0e4e1415e132f37c'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'e085498c01407aed0e4e1415e132f37c'[39m,
    [32m'security'[39m,
    [32m'e085498c01407aed0e4e1415e132f37c'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:52.762Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:52.762Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515472813,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"e085498c01407aed0e4e1415e132f37c","login_success","security","e085498c01407aed0e4e1415e132f37c","security","e085498c01407aed0e4e1415e132f37c","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:52.762Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:52.762Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515472820,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould allow org member to transfer org database
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,aee29819-64e4-402c-b9c4-a9e130579c84,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'aee29819-64e4-402c-b9c4-a9e130579c84'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mremoveMember[2m > [22m[2mshould prevent self-removal
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,64c51a98-3dd0-4999-9774-21962434ec28,{"after":{"name":"Self Remove Test Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'64c51a98-3dd0-4999-9774-21962434ec28'[39m,
    [32m'{"after":{"name":"Self Remove Test Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:243:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768515473039,"env":"test","module":"auth-routes","userId":"50c988faa7a272841a2200c80723712f","msg":"User logged in successfully"}
{"level":30,"time":1768515473049,"env":"test","module":"auth-routes","userId":"154f69fe4e31ae5a5241728d8e010d67","msg":"User logged in successfully"}
{"level":50,"time":1768515473085,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"50c988faa7a272841a2200c80723712f","login_success","security","50c988faa7a272841a2200c80723712f","security","50c988faa7a272841a2200c80723712f","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:53.039Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:53.039Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"50c988faa7a272841a2200c80723712f","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return MFA status for user
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,50c988faa7a272841a2200c80723712f,login_success,security,50c988faa7a272841a2200c80723712f,security,50c988faa7a272841a2200c80723712f,{"metadata":{"timestamp":"2026-01-15T22:17:53.039Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:53.039Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'50c988faa7a272841a2200c80723712f'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'50c988faa7a272841a2200c80723712f'[39m,
    [32m'security'[39m,
    [32m'50c988faa7a272841a2200c80723712f'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:53.039Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:53.039Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515473086,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"50c988faa7a272841a2200c80723712f","login_success","security","50c988faa7a272841a2200c80723712f","security","50c988faa7a272841a2200c80723712f","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:53.039Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:53.039Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515473092,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768515473099,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"154f69fe4e31ae5a5241728d8e010d67","login_success","security","154f69fe4e31ae5a5241728d8e010d67","security","154f69fe4e31ae5a5241728d8e010d67","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:53.049Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:53.049Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"154f69fe4e31ae5a5241728d8e010d67","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mGET /api/auth/me[2m > [22m[2mshould return current user for valid token
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,154f69fe4e31ae5a5241728d8e010d67,login_success,security,154f69fe4e31ae5a5241728d8e010d67,security,154f69fe4e31ae5a5241728d8e010d67,{"metadata":{"timestamp":"2026-01-15T22:17:53.049Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:53.049Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'154f69fe4e31ae5a5241728d8e010d67'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'154f69fe4e31ae5a5241728d8e010d67'[39m,
    [32m'security'[39m,
    [32m'154f69fe4e31ae5a5241728d8e010d67'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:53.049Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:53.049Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515473099,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"154f69fe4e31ae5a5241728d8e010d67","login_success","security","154f69fe4e31ae5a5241728d8e010d67","security","154f69fe4e31ae5a5241728d8e010d67","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:53.049Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:53.049Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515473106,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould convert placeholder user to real user on accept
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,bdba6ef7-309b-421a-99a4-eff05a5a1b60,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'bdba6ef7-309b-421a-99a4-eff05a5a1b60'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w48
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w48,public

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w48 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w48%2Cpublic

{"level":30,"time":1768515473532,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515473570,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768515473715,"env":"test","module":"auth-routes","userId":"885bc013fc11358be8e51eb182630e2d","msg":"User logged in successfully"}
{"level":30,"time":1768515473716,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515473716,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/repositories/WorkflowTemplateRepository.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 14110[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create a workflow template mapping [33m 619[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create non-primary mapping by default [33m 603[2mms[22m[39m
       [33m[2m‚úì[22m[39m should find all templates for a workflow version [33m 703[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return empty array for version with no templates [33m 608[2mms[22m[39m
       [33m[2m‚úì[22m[39m should order by createdAt desc (newest first) [33m 706[2mms[22m[39m
       [33m[2m‚úì[22m[39m should find mapping by workflow version and key [33m 632[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return undefined for non-existent key [33m 586[2mms[22m[39m
       [33m[2m‚úì[22m[39m should find primary template for workflow version [33m 899[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return undefined when no primary template exists [33m 630[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set a template as primary and unset others [33m 838[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle setting primary when none existed before [33m 841[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not delete mapping if workflow version does not match [33m 800[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return true if key exists in workflow version [33m 642[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return false if key does not exist [33m 595[2mms[22m[39m
       [33m[2m‚úì[22m[39m should exclude specified id when checking existence [33m 649[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return true if key exists on different mapping [33m 686[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update mapping fields [33m 633[2mms[22m[39m
       [33m[2m‚úì[22m[39m should find mapping by id [33m 639[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return undefined for non-existent id [33m 590[2mms[22m[39m
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w50
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w50,public

{"level":50,"time":1768515473760,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"885bc013fc11358be8e51eb182630e2d","login_success","security","885bc013fc11358be8e51eb182630e2d","security","885bc013fc11358be8e51eb182630e2d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:53.715Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:53.715Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"885bc013fc11358be8e51eb182630e2d","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768515473760,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"885bc013fc11358be8e51eb182630e2d","login_success","security","885bc013fc11358be8e51eb182630e2d","security","885bc013fc11358be8e51eb182630e2d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:53.715Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:53.715Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,885bc013fc11358be8e51eb182630e2d,login_success,security,885bc013fc11358be8e51eb182630e2d,security,885bc013fc11358be8e51eb182630e2d,{"metadata":{"timestamp":"2026-01-15T22:17:53.715Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:53.715Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'885bc013fc11358be8e51eb182630e2d'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'885bc013fc11358be8e51eb182630e2d'[39m,
    [32m'security'[39m,
    [32m'885bc013fc11358be8e51eb182630e2d'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:53.715Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:53.715Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w50 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w50%2Cpublic

{"level":30,"time":1768515473802,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515473843,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for 4ff8362ed97bc90d0424c3bad8d72bc5

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w48, public

{"level":30,"time":1768515473918,"env":"test","module":"email-queue","jobId":"bfedf7e5-1b5f-48d2-9879-5b32bbd3a8bc","to":"newuser_1768515458508@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/services/AuthService.test.ts[2m > [22m[2mAuthService[2m > [22m[2mJWT Token Management[2m > [22m[2mverifyToken()[2m > [22m[2mshould throw error for invalid token signature
[22m[39mDEBUG: verifyToken threw: Invalid or malformed token InvalidTokenError

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w48
‚è© Schema reused, skipping migrations.

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mleaveOrganization[2m > [22m[2mshould allow member to leave organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,58b3cda7-343f-4476-9e3a-3db61a26de66,{"after":{"name":"Leave Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'58b3cda7-343f-4476-9e3a-3db61a26de66'[39m,
    [32m'{"after":{"name":"Leave Test Org Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:257:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w46.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w46.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould convert placeholder user to real user on accept
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,bdba6ef7-309b-421a-99a4-eff05a5a1b60,{"after":{"invitedEmail":"newuser_1768515458508@test.com","token":"8f0366ba29d23223d2f63e4e1b6f28e0ff52b6314dcc233742cc32aa8be53513"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'bdba6ef7-309b-421a-99a4-eff05a5a1b60'[39m,
    [32m'{"after":{"invitedEmail":"newuser_1768515458508@test.com","token":"8f0366ba29d23223d2f63e4e1b6f28e0ff52b6314dcc233742cc32aa8be53513"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:194:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515474025,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768515474030,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w50, public

{"level":30,"time":1768515474189,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768515474193,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768515474220,"env":"test","module":"auth-service","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w50
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768515474222,"env":"test","module":"auth-service","tokenHash":"9206c2394794b8fc97fcd896f95e40028ab7a15c10279446c23fbdd4b4ae7a1e","plainTokenLen":13,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768515474222,"env":"test","module":"auth-service","tokenHash":"9206c2394794b8fc97fcd896f95e40028ab7a15c10279446c23fbdd4b4ae7a1e","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768515474222,"env":"test","module":"auth-service","allTokensCount":0,"msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768515474224,"env":"test","module":"auth-service","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768515474225,"env":"test","module":"auth-service","userId":"user-123","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768515474229,"env":"test","module":"auth-service","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768515474229,"env":"test","module":"auth-service","userId":"user-123","msg":"Security: Expired refresh token used"}
{"level":30,"time":1768515474235,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
{"level":30,"time":1768515474236,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
{"level":30,"time":1768515474238,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
{"level":30,"time":1768515474239,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,fcab8182-4cb8-4b92-8440-f1ef474615bc,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'fcab8182-4cb8-4b92-8440-f1ef474615bc'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w48.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w48.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return backup codes count for MFA users
[22m[39m[TEST UTILS] MFA Secret verified for 07d939b69113588c951706ec5c7df767

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould complete MFA login with valid TOTP code
[22m[39m[TEST UTILS] MFA Secret verified for 76728325b968b47adb26e825898ed0db

{"level":30,"time":1768515474528,"env":"test","module":"auth-routes","userId":"885bc013fc11358be8e51eb182630e2d","msg":"User logged in successfully"}
{"level":50,"time":1768515474583,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"885bc013fc11358be8e51eb182630e2d","login_success","security","885bc013fc11358be8e51eb182630e2d","security","885bc013fc11358be8e51eb182630e2d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:54.528Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:54.528Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"885bc013fc11358be8e51eb182630e2d","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,885bc013fc11358be8e51eb182630e2d,login_success,security,885bc013fc11358be8e51eb182630e2d,security,885bc013fc11358be8e51eb182630e2d,{"metadata":{"timestamp":"2026-01-15T22:17:54.528Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:54.528Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'885bc013fc11358be8e51eb182630e2d'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'885bc013fc11358be8e51eb182630e2d'[39m,
    [32m'security'[39m,
    [32m'885bc013fc11358be8e51eb182630e2d'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:54.528Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:54.528Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515474583,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"885bc013fc11358be8e51eb182630e2d","login_success","security","885bc013fc11358be8e51eb182630e2d","security","885bc013fc11358be8e51eb182630e2d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:54.528Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:54.528Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515474588,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768515474598,"env":"test","module":"auth-routes","userId":"4ff8362ed97bc90d0424c3bad8d72bc5","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515474696,"env":"test","module":"mfa-service","userId":"4ff8362ed97bc90d0424c3bad8d72bc5","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return backup codes count for MFA users
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515474743,"env":"test","module":"auth-routes","userId":"4ff8362ed97bc90d0424c3bad8d72bc5","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould complete MFA login with valid TOTP code
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould convert placeholder user to real user on accept
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,7a35138a-6d80-4e25-a888-a4ed7a583b52,organization.invite_accept,organization,bdba6ef7-309b-421a-99a4-eff05a5a1b60,{"after":{"email":"newuser_1768515458508@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'7a35138a-6d80-4e25-a888-a4ed7a583b52'[39m,
    [32m'organization.invite_accept'[39m,
    [32m'organization'[39m,
    [32m'bdba6ef7-309b-421a-99a4-eff05a5a1b60'[39m,
    [32m'{"after":{"email":"newuser_1768515458508@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:204:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w51
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w51,public

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w51 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w51%2Cpublic

{"level":30,"time":1768515474884,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515474899,"env":"test","module":"auth-routes","userId":"4ff8362ed97bc90d0424c3bad8d72bc5","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515474931,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000032,organization.create,organization,8a38fe4a-a4d3-4152-bc30-7dae5cdbc6b9,{"after":{"name":"Other Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000032'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'8a38fe4a-a4d3-4152-bc30-7dae5cdbc6b9'[39m,
    [32m'{"after":{"name":"Other Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:328:30
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515475067,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515475068,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/WorkflowTemplateService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 16115[2mms[22m[39m
       [33m[2m‚úì[22m[39m should throw error if template belongs to different project [33m 585[2mms[22m[39m
       [33m[2m‚úì[22m[39m should automatically unset other primaries when setting new primary [33m 987[2mms[22m[39m
         [33m[2m‚úì[22m[39m should list all templates for workflow version [33m 921[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return empty array for version with no templates [33m 507[2mms[22m[39m
         [33m[2m‚úì[22m[39m should get template mapping by id and version [33m 656[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if mapping not found [33m 514[2mms[22m[39m
         [33m[2m‚úì[22m[39m should get template by key [33m 667[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if key not found [33m 488[2mms[22m[39m
         [33m[2m‚úì[22m[39m should get primary template for workflow version [33m 1017[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return null when no primary template exists [33m 575[2mms[22m[39m
         [33m[2m‚úì[22m[39m should update mapping key [33m 747[2mms[22m[39m
         [33m[2m‚úì[22m[39m should update isPrimary flag [33m 734[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if new key already exists [33m 757[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if mapping not found [33m 512[2mms[22m[39m
         [33m[2m‚úì[22m[39m should unset other primaries when setting isPrimary to true [33m 974[2mms[22m[39m
         [33m[2m‚úì[22m[39m should detach template from workflow version [33m 686[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if mapping not found [33m 487[2mms[22m[39m
         [33m[2m‚úì[22m[39m should set template as primary [33m 929[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if mapping not found [33m 521[2mms[22m[39m
         [33m[2m‚úì[22m[39m should support operations within a transaction [33m 732[2mms[22m[39m
         [33m[2m‚úì[22m[39m should rollback on transaction error [33m 866[2mms[22m[39m
{"level":30,"time":1768515475101,"env":"test","module":"auth-routes","userId":"c4cbb4b009774571970544cf7c3f0d95","msg":"User logged in successfully"}
{"level":50,"time":1768515475156,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"c4cbb4b009774571970544cf7c3f0d95","login_success","security","c4cbb4b009774571970544cf7c3f0d95","security","c4cbb4b009774571970544cf7c3f0d95","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:55.101Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:55.101Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"c4cbb4b009774571970544cf7c3f0d95","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,c4cbb4b009774571970544cf7c3f0d95,login_success,security,c4cbb4b009774571970544cf7c3f0d95,security,c4cbb4b009774571970544cf7c3f0d95,{"metadata":{"timestamp":"2026-01-15T22:17:55.101Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:55.101Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'c4cbb4b009774571970544cf7c3f0d95'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'c4cbb4b009774571970544cf7c3f0d95'[39m,
    [32m'security'[39m,
    [32m'c4cbb4b009774571970544cf7c3f0d95'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:55.101Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:55.101Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515475156,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"c4cbb4b009774571970544cf7c3f0d95","login_success","security","c4cbb4b009774571970544cf7c3f0d95","security","c4cbb4b009774571970544cf7c3f0d95","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:55.101Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:55.101Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515475173,"env":"test","module":"auth-routes","userId":"07d939b69113588c951706ec5c7df767","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w49
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w49,public

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w49 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w49%2Cpublic

{"level":30,"time":1768515475263,"env":"test","module":"auth-routes","userId":"76728325b968b47adb26e825898ed0db","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w51, public

{"level":30,"time":1768515475321,"env":"test","module":"mfa-service","userId":"07d939b69113588c951706ec5c7df767","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w51
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768515475364,"env":"test","module":"mfa-service","userId":"76728325b968b47adb26e825898ed0db","msg":"TOTP verification successful"}
{"level":30,"time":1768515475372,"env":"test","module":"auth-routes","userId":"07d939b69113588c951706ec5c7df767","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w50.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w50.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515475411,"env":"test","module":"auth-routes","userId":"4ff8362ed97bc90d0424c3bad8d72bc5","msg":"Login from trusted device - MFA skipped"}
{"level":30,"time":1768515475411,"env":"test","module":"auth-routes","userId":"76728325b968b47adb26e825898ed0db","msg":"MFA login successful"}
{"level":30,"time":1768515475439,"env":"test","module":"writeback-execution-service","runId":"4074234b-15b2-43fd-881a-1c7acde8e105","workflowId":"835b53bb-963e-4612-8b1c-9675ad0a7e41","msg":"Executing writeback mappings for completed run"}
{"level":30,"time":1768515475456,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515475457,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515475463,"env":"test","module":"auth-routes","userId":"4ff8362ed97bc90d0424c3bad8d72bc5","msg":"User logged in successfully"}
{"level":30,"time":1768515475489,"env":"test","module":"writeback-execution-service","runId":"4074234b-15b2-43fd-881a-1c7acde8e105","workflowId":"835b53bb-963e-4612-8b1c-9675ad0a7e41","mappingCount":1,"msg":"Found writeback mappings"}
{"level":50,"time":1768515475514,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"4ff8362ed97bc90d0424c3bad8d72bc5","login_success","security","4ff8362ed97bc90d0424c3bad8d72bc5","security","4ff8362ed97bc90d0424c3bad8d72bc5","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:55.463Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:17:55.463Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"4ff8362ed97bc90d0424c3bad8d72bc5","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,4ff8362ed97bc90d0424c3bad8d72bc5,login_success,security,4ff8362ed97bc90d0424c3bad8d72bc5,security,4ff8362ed97bc90d0424c3bad8d72bc5,{"metadata":{"timestamp":"2026-01-15T22:17:55.463Z"}},192.168.1.100,Mozilla/5.0 (Windows NT 10.0; Win64; x64),2026-01-15T22:17:55.463Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'4ff8362ed97bc90d0424c3bad8d72bc5'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'4ff8362ed97bc90d0424c3bad8d72bc5'[39m,
    [32m'security'[39m,
    [32m'4ff8362ed97bc90d0424c3bad8d72bc5'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:55.463Z"}}'[39m,
    [32m'192.168.1.100'[39m,
    [32m'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'[39m,
    [32m'2026-01-15T22:17:55.463Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515475514,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"4ff8362ed97bc90d0424c3bad8d72bc5","login_success","security","4ff8362ed97bc90d0424c3bad8d72bc5","security","4ff8362ed97bc90d0424c3bad8d72bc5","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:55.463Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:17:55.463Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
 [31m‚ùØ[39m tests/integration/auth.flows.real.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m6 failed[39m[2m)[22m[33m 29292[2mms[22m[39m
[31m       [31m√ó[31m should complete registration, verify email, then login[39m[33m 2469[2mms[22m[39m
       [33m[2m‚úì[22m[39m should lock account after 5 failed attempts, then unlock after waiting [33m 3871[2mms[22m[39m
       [33m[2m‚úì[22m[39m should record all login attempts [33m 2949[2mms[22m[39m
[31m       [31m√ó[31m should complete MFA setup and login with TOTP[39m[33m 1895[2mms[22m[39m
[31m       [31m√ó[31m should login with backup code when TOTP unavailable[39m[33m 1927[2mms[22m[39m
[31m       [31m√ó[31m should complete full password reset flow[39m[33m 2267[2mms[22m[39m
       [33m[2m‚úì[22m[39m should invalidate all sessions after password reset [33m 2887[2mms[22m[39m
       [33m[2m‚úì[22m[39m should rotate refresh token on each use [33m 2581[2mms[22m[39m
       [33m[2m‚úì[22m[39m should detect and prevent refresh token reuse (token theft) [33m 2142[2mms[22m[39m
[31m       [31m√ó[31m should list all active sessions[39m[33m 2544[2mms[22m[39m
[31m       [31m√ó[31m should revoke specific session[39m[33m 2584[2mms[22m[39m
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mleaveOrganization[2m > [22m[2mshould allow admin to leave organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,3900dcb7-d6c7-40bf-a3aa-2f6750ff5b7a,{"after":{"name":"Admin Leave Test Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'3900dcb7-d6c7-40bf-a3aa-2f6750ff5b7a'[39m,
    [32m'{"after":{"name":"Admin Leave Test Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:272:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515475696,"env":"test","module":"writeback-execution-service","runId":"4074234b-15b2-43fd-881a-1c7acde8e105","workflowId":"835b53bb-963e-4612-8b1c-9675ad0a7e41","mappingId":"9a25915a-8624-4898-b191-b3b309a25f65","tableId":"9681a6a7-6e3f-4931-96ba-4c3ffe6333ca","msg":"Executing writeback mapping"}
{"level":30,"time":1768515475920,"env":"test","module":"auth-routes","userId":"c4cbb4b009774571970544cf7c3f0d95","msg":"User logged in successfully"}
{"level":50,"time":1768515475966,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"c4cbb4b009774571970544cf7c3f0d95","login_success","security","c4cbb4b009774571970544cf7c3f0d95","security","c4cbb4b009774571970544cf7c3f0d95","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:55.921Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:55.921Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"c4cbb4b009774571970544cf7c3f0d95","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,c4cbb4b009774571970544cf7c3f0d95,login_success,security,c4cbb4b009774571970544cf7c3f0d95,security,c4cbb4b009774571970544cf7c3f0d95,{"metadata":{"timestamp":"2026-01-15T22:17:55.921Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:55.921Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'c4cbb4b009774571970544cf7c3f0d95'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'c4cbb4b009774571970544cf7c3f0d95'[39m,
    [32m'security'[39m,
    [32m'c4cbb4b009774571970544cf7c3f0d95'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:55.921Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:55.921Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515475966,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"c4cbb4b009774571970544cf7c3f0d95","login_success","security","c4cbb4b009774571970544cf7c3f0d95","security","c4cbb4b009774571970544cf7c3f0d95","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:55.921Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:55.921Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/analytics_service.test.ts[2m > [22m[2mAnalytics Service Integration
[22m[39mMANUAL PATCH: Applied FK fix for workflow_run_events AND workflow_run_metrics

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject expired invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,4bd8b1d1-9e37-4932-a775-e6267ad287b7,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'4bd8b1d1-9e37-4932-a775-e6267ad287b7'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515476100,"env":"test","module":"writeback-execution-service","runId":"4074234b-15b2-43fd-881a-1c7acde8e105","workflowId":"835b53bb-963e-4612-8b1c-9675ad0a7e41","mappingId":"9a25915a-8624-4898-b191-b3b309a25f65","columnCount":3,"msg":"Successfully created DataVault row"}
{"level":30,"time":1768515476100,"env":"test","module":"writeback-execution-service","runId":"4074234b-15b2-43fd-881a-1c7acde8e105","workflowId":"835b53bb-963e-4612-8b1c-9675ad0a7e41","rowsCreated":1,"errorCount":0,"msg":"Writeback execution completed"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w52
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w52,public

{"level":30,"time":1768515476122,"env":"test","module":"auth-service","tokenHash":"744732937aaee43fc013b26a749277558c94e91baabb69caa8113f0d76cfee9f","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768515476124,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515476130,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w52 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w52%2Cpublic

{"level":30,"time":1768515476169,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mTransfer Validation[2m > [22m[2mshould only allow transfer to self when targetOwnerType is user
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,8efcaf96-186a-4b75-948b-d14a2108a82b,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'8efcaf96-186a-4b75-948b-d14a2108a82b'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515476223,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515476224,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/organizationService.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 17627[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create organization and auto-create admin membership [33m 921[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return all organizations for user [33m 1073[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return empty array for user with no memberships [33m 371[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to update organization [33m 1348[2mms[22m[39m
       [33m[2m‚úì[22m[39m should deny non-admin from updating organization [33m 989[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return all members of organization [33m 1127[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to promote member [33m 1648[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to demote other admin [33m 2053[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent self-demotion [33m 967[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to remove member [33m 1923[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent self-removal [33m 976[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow member to leave organization [33m 1286[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to leave organization [33m 1711[2mms[22m[39m
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould reject invalid MFA code
[22m[39m[TEST UTILS] MFA Secret verified for 5634b94c12f348564f3fa6b665449dce

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w49, public

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w49
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768515476548,"env":"test","module":"email-queue","jobId":"4ca768ff-c8fb-4008-b55d-226657d19fcb","to":"existing_1768515458508@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould disable MFA with password verification
[22m[39m[TEST UTILS] MFA Secret verified for 45444962d5eab4cca9a56bb36ce36fff

{"level":30,"time":1768515476573,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w51.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w51.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject expired invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,4bd8b1d1-9e37-4932-a775-e6267ad287b7,{"after":{"invitedEmail":"existing_1768515458508@test.com","token":"d0ed29f0c3586bb86779d0c83b52da38a671aa3e206ab039326e1db1230e5c75"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'4bd8b1d1-9e37-4932-a775-e6267ad287b7'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768515458508@test.com","token":"d0ed29f0c3586bb86779d0c83b52da38a671aa3e206ab039326e1db1230e5c75"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:216:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515476750,"env":"test","module":"auth-routes","userId":"c4cbb4b009774571970544cf7c3f0d95","msg":"User logged in successfully"}
{"level":50,"time":1768515476796,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"c4cbb4b009774571970544cf7c3f0d95","login_success","security","c4cbb4b009774571970544cf7c3f0d95","security","c4cbb4b009774571970544cf7c3f0d95","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:56.751Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:56.751Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"c4cbb4b009774571970544cf7c3f0d95","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768515476797,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"c4cbb4b009774571970544cf7c3f0d95","login_success","security","c4cbb4b009774571970544cf7c3f0d95","security","c4cbb4b009774571970544cf7c3f0d95","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:56.751Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:56.751Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,c4cbb4b009774571970544cf7c3f0d95,login_success,security,c4cbb4b009774571970544cf7c3f0d95,security,c4cbb4b009774571970544cf7c3f0d95,{"metadata":{"timestamp":"2026-01-15T22:17:56.751Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:56.751Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'c4cbb4b009774571970544cf7c3f0d95'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'c4cbb4b009774571970544cf7c3f0d95'[39m,
    [32m'security'[39m,
    [32m'c4cbb4b009774571970544cf7c3f0d95'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:56.751Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:56.751Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515476833,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould disable MFA with password verification
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768515476861,"env":"test","module":"mfa-service","userId":"5634b94c12f348564f3fa6b665449dce","msg":"TOTP verification failed"}
{"level":40,"time":1768515476861,"env":"test","module":"auth-routes","userId":"5634b94c12f348564f3fa6b665449dce","msg":"MFA verification failed during login"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for 14c4c622c4a610bea53677de106fa364

{"level":30,"time":1768515476903,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768515477059,"env":"test","module":"writeback-execution-service","runId":"6e669797-f9a2-433f-92d7-502aa0fc2718","workflowId":"835b53bb-963e-4612-8b1c-9675ad0a7e41","msg":"Executing writeback mappings for completed run"}
{"level":30,"time":1768515477108,"env":"test","module":"writeback-execution-service","runId":"6e669797-f9a2-433f-92d7-502aa0fc2718","workflowId":"835b53bb-963e-4612-8b1c-9675ad0a7e41","mappingCount":1,"msg":"Found writeback mappings"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w52, public

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w52
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768515477297,"env":"test","module":"writeback-execution-service","runId":"6e669797-f9a2-433f-92d7-502aa0fc2718","workflowId":"835b53bb-963e-4612-8b1c-9675ad0a7e41","mappingId":"9a25915a-8624-4898-b191-b3b309a25f65","tableId":"9681a6a7-6e3f-4931-96ba-4c3ffe6333ca","msg":"Executing writeback mapping"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w49.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w49.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515477360,"env":"test","module":"auth-routes","userId":"45444962d5eab4cca9a56bb36ce36fff","msg":"Login requires MFA verification"}
{"level":30,"time":1768515477369,"env":"test","module":"writeback-execution-service","runId":"3fbb821a-3b7b-4f42-a3e8-1595030d3fcc","workflowId":"72b5efc7-a6dd-413e-8b77-26ac332b8d85","msg":"Executing writeback mappings for completed run"}
 [32m‚úì[39m tests/unit/services/AuthService.test.ts [2m([22m[2m113 tests[22m[2m)[22m[33m 8154[2mms[22m[39m
         [33m[2m‚úì[22m[39m should generate different hashes for same password [33m 429[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return true for correct password [33m 431[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return false for incorrect password [33m 423[2mms[22m[39m
         [33m[2m‚úì[22m[39m should be case-sensitive [33m 426[2mms[22m[39m
         [33m[2m‚úì[22m[39m should handle empty password comparison [33m 441[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error for expired token [33m 1105[2mms[22m[39m
         [33m[2m‚úì[22m[39m should handle password with special characters [33m 498[2mms[22m[39m
         [33m[2m‚úì[22m[39m should handle password with newlines and tabs [33m 442[2mms[22m[39m
         [33m[2m‚úì[22m[39m should reject password with null bytes (if validation exists) [33m 466[2mms[22m[39m
         [33m[2m‚úì[22m[39m should support complete password reset workflow [33m 448[2mms[22m[39m
         [33m[2m‚úì[22m[39m should compare password in reasonable time (< 500ms) [33m 499[2mms[22m[39m
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mTransfer Validation[2m > [22m[2mshould allow transfer from user to self (org member transferring org asset to themselves)
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,54fceb18-7ca0-4228-9529-2461ec4bde96,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'54fceb18-7ca0-4228-9529-2461ec4bde96'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515477420,"env":"test","runId":"3fbb821a-3b7b-4f42-a3e8-1595030d3fcc","service":"DocumentGenerationService","msg":"Starting document generation for run"}
{"level":30,"time":1768515477430,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515477430,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515477462,"env":"test","module":"mfa-service","userId":"45444962d5eab4cca9a56bb36ce36fff","msg":"TOTP verification successful"}
{"level":30,"time":1768515477509,"env":"test","module":"auth-routes","userId":"45444962d5eab4cca9a56bb36ce36fff","msg":"MFA login successful"}
{"level":40,"time":1768515477523,"env":"test","runId":"3fbb821a-3b7b-4f42-a3e8-1595030d3fcc","service":"DocumentGenerationService","allSections":[],"runId":"3fbb821a-3b7b-4f42-a3e8-1595030d3fcc","msg":"No Final Documents sections found, skipping generation. This might cause the frontend to hang."}
{"level":30,"time":1768515477524,"env":"test","runId":"3fbb821a-3b7b-4f42-a3e8-1595030d3fcc","msg":"Documents generated successfully"}
 [31m‚ùØ[39m tests/integration/auth.routes.real.test.ts [2m([22m[2m26 tests[22m[2m | [22m[31m3 failed[39m[2m)[22m[33m 31263[2mms[22m[39m
       [33m[2m‚úì[22m[39m should register a new user successfully [33m 1205[2mms[22m[39m
       [32m‚úì[39m should return 400 for invalid email format[32m 8[2mms[22m[39m
       [32m‚úì[39m should return 400 for weak password[32m 8[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 409 for duplicate email [33m 1239[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set httpOnly refresh token cookie [33m 538[2mms[22m[39m
[31m       [31m√ó[31m should login with valid credentials[39m[33m 1887[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for invalid password [33m 1486[2mms[22m[39m
       [32m‚úì[39m should return 401 for non-existent user[32m 195[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 403 for unverified email [33m 975[2mms[22m[39m
       [33m[2m‚úì[22m[39m should record failed login attempt [33m 1499[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return requiresMfa=true for MFA-enabled users [33m 1862[2mms[22m[39m
       [33m[2m‚úì[22m[39m should lock account after 5 failed attempts [33m 3564[2mms[22m[39m
       [33m[2m‚úì[22m[39m should logout and clear refresh token cookie [33m 1790[2mms[22m[39m
       [33m[2m‚úì[22m[39m should refresh access token with valid refresh token [33m 1904[2mms[22m[39m
       [32m‚úì[39m should return 401 for missing refresh token[32m 3[2mms[22m[39m
       [33m[2m‚úì[22m[39m should rotate refresh token after use [33m 2358[2mms[22m[39m
       [33m[2m‚úì[22m[39m should send password reset email for existing user [33m 1098[2mms[22m[39m
       [32m‚úì[39m should not reveal if email exists (security)[32m 52[2mms[22m[39m
[31m       [31m√ó[31m should reset password with valid token[39m[33m 1920[2mms[22m[39m
       [32m‚úì[39m should return 400 for invalid token[32m 51[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 400 for weak new password [33m 1204[2mms[22m[39m
[31m       [31m√ó[31m should return current user for valid token[39m[33m 1826[2mms[22m[39m
       [32m‚úì[39m should return 401 for missing token[32m 5[2mms[22m[39m
       [32m‚úì[39m should return 401 for invalid token[32m 5[2mms[22m[39m
         [33m[2m‚úì[22m[39m should complete MFA login with valid TOTP code [33m 1966[2mms[22m[39m
         [33m[2m‚úì[22m[39m should reject invalid MFA code [33m 1431[2mms[22m[39m
{"level":30,"time":1768515477584,"env":"test","module":"auth-routes","userId":"c4cbb4b009774571970544cf7c3f0d95","msg":"User logged in successfully"}
{"level":50,"time":1768515477633,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"c4cbb4b009774571970544cf7c3f0d95","login_success","security","c4cbb4b009774571970544cf7c3f0d95","security","c4cbb4b009774571970544cf7c3f0d95","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:57.584Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:57.584Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"c4cbb4b009774571970544cf7c3f0d95","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,c4cbb4b009774571970544cf7c3f0d95,login_success,security,c4cbb4b009774571970544cf7c3f0d95,security,c4cbb4b009774571970544cf7c3f0d95,{"metadata":{"timestamp":"2026-01-15T22:17:57.584Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:57.584Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'c4cbb4b009774571970544cf7c3f0d95'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'c4cbb4b009774571970544cf7c3f0d95'[39m,
    [32m'security'[39m,
    [32m'c4cbb4b009774571970544cf7c3f0d95'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:57.584Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:57.584Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515477633,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"c4cbb4b009774571970544cf7c3f0d95","login_success","security","c4cbb4b009774571970544cf7c3f0d95","security","c4cbb4b009774571970544cf7c3f0d95","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:57.584Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:57.584Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515477641,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768515477686,"env":"test","module":"auth-routes","userId":"14c4c622c4a610bea53677de106fa364","msg":"Login requires MFA verification"}
{"level":30,"time":1768515477698,"env":"test","module":"writeback-execution-service","runId":"6e669797-f9a2-433f-92d7-502aa0fc2718","workflowId":"835b53bb-963e-4612-8b1c-9675ad0a7e41","mappingId":"9a25915a-8624-4898-b191-b3b309a25f65","columnCount":3,"msg":"Successfully created DataVault row"}
{"level":30,"time":1768515477698,"env":"test","module":"writeback-execution-service","runId":"6e669797-f9a2-433f-92d7-502aa0fc2718","workflowId":"835b53bb-963e-4612-8b1c-9675ad0a7e41","rowsCreated":1,"errorCount":0,"msg":"Writeback execution completed"}
{"level":30,"time":1768515477698,"env":"test","runId":"6e669797-f9a2-433f-92d7-502aa0fc2718","rowsCreated":1,"msg":"DataVault writeback completed"}
{"level":30,"time":1768515477698,"env":"test","runId":"6e669797-f9a2-433f-92d7-502aa0fc2718","service":"DocumentGenerationService","msg":"Starting document generation for run"}
{"level":30,"time":1768515477788,"env":"test","module":"mfa-service","userId":"14c4c622c4a610bea53677de106fa364","msg":"TOTP verification successful"}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w53
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w53,public

{"level":40,"time":1768515477794,"env":"test","runId":"6e669797-f9a2-433f-92d7-502aa0fc2718","service":"DocumentGenerationService","allSections":[{"id":"d289cdd9-71a5-4e60-997a-ce1e37ade02e","config":{}}],"runId":"6e669797-f9a2-433f-92d7-502aa0fc2718","msg":"No Final Documents sections found, skipping generation. This might cause the frontend to hang."}
{"level":30,"time":1768515477794,"env":"test","runId":"6e669797-f9a2-433f-92d7-502aa0fc2718","msg":"Documents generated successfully"}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w53 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w53%2Cpublic

{"level":30,"time":1768515477839,"env":"test","module":"auth-routes","userId":"14c4c622c4a610bea53677de106fa364","msg":"MFA login successful"}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768515477990,"env":"test","module":"auth-routes","userId":"14c4c622c4a610bea53677de106fa364","deviceFingerprint":"10fa3aea039bf6fec7b6bcb982cbed1cc6ab844dd3c0879bec32baefb2997b52","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject already accepted invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,f4f44271-1c74-4009-9dc0-8ee681faf7ee,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'f4f44271-1c74-4009-9dc0-8ee681faf7ee'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515478069,"env":"test","module":"mfa-service","userId":"45444962d5eab4cca9a56bb36ce36fff","msg":"MFA disabled"}
{"level":30,"time":1768515478069,"env":"test","module":"auth-routes","userId":"45444962d5eab4cca9a56bb36ce36fff","msg":"MFA disabled by user"}
{"level":50,"time":1768515478093,"env":"test","error":{"query":"insert into \"workflow_run_events\" (\"id\", \"run_id\", \"version_id\", \"workflow_id\", \"block_id\", \"page_id\", \"type\", \"timestamp\", \"payload\", \"is_preview\") values (default, $1, $2, $3, default, default, $4, $5, $6, $7)","params":["6e669797-f9a2-433f-92d7-502aa0fc2718","draft","835b53bb-963e-4612-8b1c-9675ad0a7e41","workflow.complete","2026-01-15T22:17:58.039Z","{\"durationMs\":1178,\"stepCount\":2}",false],"cause":{"length":137,"name":"error","severity":"ERROR","code":"22P02","where":"unnamed portal parameter $2 = '...'","file":"uuid.c","line":"138","routine":"string_to_uuid"}},"input":{"runId":"6e669797-f9a2-433f-92d7-502aa0fc2718","workflowId":"835b53bb-963e-4612-8b1c-9675ad0a7e41","versionId":"draft","type":"workflow.complete","timestamp":"2026-01-15T22:17:58.039Z","isPreview":false,"payload":{"durationMs":1178,"stepCount":2}},"msg":"Failed to record analytics event"}
{"level":50,"time":1768515478119,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"45444962d5eab4cca9a56bb36ce36fff","mfa_disabled","security","45444962d5eab4cca9a56bb36ce36fff","security","45444962d5eab4cca9a56bb36ce36fff","{\"metadata\":{\"mfaMethod\":\"totp\",\"timestamp\":\"2026-01-15T22:17:58.070Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:58.070Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"45444962d5eab4cca9a56bb36ce36fff","eventType":"mfa_disabled","msg":"Failed to log security event"}
{"level":50,"time":1768515478119,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"45444962d5eab4cca9a56bb36ce36fff","mfa_disabled","security","45444962d5eab4cca9a56bb36ce36fff","security","45444962d5eab4cca9a56bb36ce36fff","{\"metadata\":{\"mfaMethod\":\"totp\",\"timestamp\":\"2026-01-15T22:17:58.070Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:58.070Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"MFA disable error"}
{"level":30,"time":1768515478228,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515478229,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/transferOwnership.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 19142[2mms[22m[39m
       [33m[2m‚úì[22m[39m should transfer user-owned project to org [33m 1715[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent transfer to org if user is not a member [33m 1894[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow org member to transfer org-owned project to another org they belong to [33m 2306[2mms[22m[39m
       [33m[2m‚úì[22m[39m should detach workflow from project when transferring to different owner [33m 1660[2mms[22m[39m
       [33m[2m‚úì[22m[39m should keep workflow in project when transferring to same owner [33m 1555[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent non-member from transferring org workflow [33m 1541[2mms[22m[39m
       [33m[2m‚úì[22m[39m should transfer database ownership [33m 1288[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow org member to transfer org database [33m 1390[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent transfer to org if user is not a member [33m 1903[2mms[22m[39m
       [33m[2m‚úì[22m[39m should only allow transfer to self when targetOwnerType is user [33m 1222[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow transfer from user to self (org member transferring org asset to themselves) [33m 1459[2mms[22m[39m
{"level":30,"time":1768515478502,"env":"test","module":"auth-routes","userId":"14c4c622c4a610bea53677de106fa364","msg":"Login requires MFA verification"}
{"level":30,"time":1768515478547,"env":"test","module":"email-queue","jobId":"67cbe5d6-bb49-4728-a2a9-fa882202fb13","to":"existing_1768515458508@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject already accepted invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,f4f44271-1c74-4009-9dc0-8ee681faf7ee,{"after":{"invitedEmail":"existing_1768515458508@test.com","token":"84f232f0fc11c07499de70e96b6c19e1625ca10cc9b0955291742216cf5e8e4f"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'f4f44271-1c74-4009-9dc0-8ee681faf7ee'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768515458508@test.com","token":"84f232f0fc11c07499de70e96b6c19e1625ca10cc9b0955291742216cf5e8e4f"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:241:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w54
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w54,public

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515478752,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515478753,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515478783,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/integration/ownershipAccess.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 5381[2mms[22m[39m
       [33m[2m‚úì[22m[39m should deny access to user-owned asset by non-owner [33m 499[2mms[22m[39m
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w54 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w54%2Cpublic

{"level":30,"time":1768515478832,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768515479155,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515479155,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515479171,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515479172,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w53, public

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w53
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w55
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w55,public

 [32m‚úì[39m tests/integration/analytics_service.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 4693[2mms[22m[39m
     [33m[2m‚úì[22m[39m should generate events and metrics on run completion [33m 2833[2mms[22m[39m
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w52.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w52.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w55 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w55%2Cpublic

 [32m‚úì[39m tests/ui/runs.components.test.tsx [2m([22m[2m19 tests[22m[2m)[22m[33m 4382[2mms[22m[39m
       [33m[2m‚úì[22m[39m should show download options for successful runs [33m 912[2mms[22m[39m
       [33m[2m‚úì[22m[39m should call onChange when status filter changes [33m 494[2mms[22m[39m
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject already accepted invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000022,organization.invite_accept,organization,f4f44271-1c74-4009-9dc0-8ee681faf7ee,{"after":{"email":"existing_1768515458508@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000022'[39m,
    [32m'organization.invite_accept'[39m,
    [32m'organization'[39m,
    [32m'f4f44271-1c74-4009-9dc0-8ee681faf7ee'[39m,
    [32m'{"after":{"email":"existing_1768515458508@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:248:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mError Handling[2m > [22m[2mreverts value on save error
[22m[39mFailed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:206:36
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

{"level":30,"time":1768515479460,"env":"test","module":"auth-routes","userId":"f76bd6b35f4e840fb025170e0994502e","msg":"User logged in successfully"}
{"level":50,"time":1768515479511,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"f76bd6b35f4e840fb025170e0994502e","login_success","security","f76bd6b35f4e840fb025170e0994502e","security","f76bd6b35f4e840fb025170e0994502e","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:59.461Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:59.461Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"f76bd6b35f4e840fb025170e0994502e","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,f76bd6b35f4e840fb025170e0994502e,login_success,security,f76bd6b35f4e840fb025170e0994502e,security,f76bd6b35f4e840fb025170e0994502e,{"metadata":{"timestamp":"2026-01-15T22:17:59.461Z"}},::ffff:127.0.0.1,,2026-01-15T22:17:59.461Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'f76bd6b35f4e840fb025170e0994502e'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'f76bd6b35f4e840fb025170e0994502e'[39m,
    [32m'security'[39m,
    [32m'f76bd6b35f4e840fb025170e0994502e'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:17:59.461Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:17:59.461Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515479512,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"f76bd6b35f4e840fb025170e0994502e","login_success","security","f76bd6b35f4e840fb025170e0994502e","security","f76bd6b35f4e840fb025170e0994502e","{\"metadata\":{\"timestamp\":\"2026-01-15T22:17:59.461Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:17:59.461Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould require correct password to disable MFA
[22m[39m[TEST UTILS] MFA Secret verified for c21891f7a94f542f83cd6ce4150a4463

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 3ec14c728277238809ac07dde915de72

[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mError Handling[2m > [22m[2mdisplays error indicator on save failure
[22m[39mFailed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:222:36
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515479730,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515479768,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515479769,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515479825,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

 [32m‚úì[39m tests/integration/workflows/runtime-pipelines.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 6652[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create DataVault row on workflow completion [33m 904[2mms[22m[39m
       [33m[2m‚úì[22m[39m should execute writebacks via RunService.completeRun() [33m 2400[2mms[22m[39m
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould require correct password to disable MFA
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mBoolean Type (Checkbox)[2m > [22m[2mshows loading spinner when saving checkbox
[22m[39mWarning: An update to EditableCell inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at EditableCell (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/EditableCell.tsx:12:25)

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w54, public

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w54
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515480238,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w56
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w56,public

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w53.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w53.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w56 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w56%2Cpublic

{"level":30,"time":1768515480306,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515480340,"env":"test","module":"auth-routes","userId":"f76bd6b35f4e840fb025170e0994502e","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

{"level":50,"time":1768515480387,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"f76bd6b35f4e840fb025170e0994502e","login_success","security","f76bd6b35f4e840fb025170e0994502e","security","f76bd6b35f4e840fb025170e0994502e","{\"metadata\":{\"timestamp\":\"2026-01-15T22:18:00.341Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:18:00.341Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"f76bd6b35f4e840fb025170e0994502e","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,f76bd6b35f4e840fb025170e0994502e,login_success,security,f76bd6b35f4e840fb025170e0994502e,security,f76bd6b35f4e840fb025170e0994502e,{"metadata":{"timestamp":"2026-01-15T22:18:00.341Z"}},::ffff:127.0.0.1,,2026-01-15T22:18:00.341Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'f76bd6b35f4e840fb025170e0994502e'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'f76bd6b35f4e840fb025170e0994502e'[39m,
    [32m'security'[39m,
    [32m'f76bd6b35f4e840fb025170e0994502e'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:18:00.341Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:18:00.341Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515480387,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"f76bd6b35f4e840fb025170e0994502e","login_success","security","f76bd6b35f4e840fb025170e0994502e","security","f76bd6b35f4e840fb025170e0994502e","{\"metadata\":{\"timestamp\":\"2026-01-15T22:18:00.341Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:18:00.341Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768515480393,"env":"test","module":"auth-routes","userId":"c21891f7a94f542f83cd6ce4150a4463","msg":"Login requires MFA verification"}
{"level":50,"time":1768515480395,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768515480400,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768515480441,"env":"test","module":"auth-routes","userId":"3ec14c728277238809ac07dde915de72","msg":"Login requires MFA verification"}
{"level":30,"time":1768515480499,"env":"test","module":"mfa-service","userId":"c21891f7a94f542f83cd6ce4150a4463","msg":"TOTP verification successful"}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w60
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w60,public

{"level":30,"time":1768515480512,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515480513,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515480547,"env":"test","module":"mfa-service","userId":"3ec14c728277238809ac07dde915de72","msg":"TOTP verification successful"}
{"level":30,"time":1768515480546,"env":"test","module":"auth-routes","userId":"c21891f7a94f542f83cd6ce4150a4463","msg":"MFA login successful"}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w60 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w60%2Cpublic

{"level":30,"time":1768515480601,"env":"test","module":"auth-routes","userId":"3ec14c728277238809ac07dde915de72","msg":"MFA login successful"}
 [32m‚úì[39m tests/ui/datavault/EditableCell.test.tsx [2m([22m[2m29 tests[22m[2m)[22m[33m 4834[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w55, public

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w55
‚è© Schema reused, skipping migrations.

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould verify email matches invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,5784676a-d40e-4744-b665-2aadb806e56f,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'5784676a-d40e-4744-b665-2aadb806e56f'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515480748,"env":"test","module":"auth-routes","userId":"3ec14c728277238809ac07dde915de72","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w54.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w54.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w57
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w57,public

{"level":30,"time":1768515480979,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515480980,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w57 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w57%2Cpublic

 [32m‚úì[39m tests/unit/collab.client.test.tsx [2m([22m[2m17 tests[22m[2m)[22m[33m 3613[2mms[22m[39m
     [33m[2m‚úì[22m[39m should add a comment [33m 434[2mms[22m[39m
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768515481211,"env":"test","module":"email-queue","jobId":"c0e86a0e-3cc6-40d8-ab6a-6864c477b4c6","to":"existing_1768515458508@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515481286,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould verify email matches invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,5784676a-d40e-4744-b665-2aadb806e56f,{"after":{"invitedEmail":"existing_1768515458508@test.com","token":"2c0cee065bc08b83c280a21260ec072a55d42cb30961994b66a328c3edd94440"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'5784676a-d40e-4744-b665-2aadb806e56f'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768515458508@test.com","token":"2c0cee065bc08b83c280a21260ec072a55d42cb30961994b66a328c3edd94440"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:257:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515481370,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515481461,"env":"test","module":"auth-routes","userId":"3ec14c728277238809ac07dde915de72","msg":"Login from trusted device - MFA skipped"}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515481488,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515481512,"env":"test","module":"auth-routes","userId":"3ec14c728277238809ac07dde915de72","msg":"User logged in successfully"}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768515481551,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768515481560,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"3ec14c728277238809ac07dde915de72","login_success","security","3ec14c728277238809ac07dde915de72","security","3ec14c728277238809ac07dde915de72","{\"metadata\":{\"timestamp\":\"2026-01-15T22:18:01.512Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:18:01.512Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"3ec14c728277238809ac07dde915de72","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,3ec14c728277238809ac07dde915de72,login_success,security,3ec14c728277238809ac07dde915de72,security,3ec14c728277238809ac07dde915de72,{"metadata":{"timestamp":"2026-01-15T22:18:01.512Z"}},192.168.1.100,Mozilla/5.0 (Windows NT 10.0; Win64; x64),2026-01-15T22:18:01.512Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'3ec14c728277238809ac07dde915de72'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'3ec14c728277238809ac07dde915de72'[39m,
    [32m'security'[39m,
    [32m'3ec14c728277238809ac07dde915de72'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:18:01.512Z"}}'[39m,
    [32m'192.168.1.100'[39m,
    [32m'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'[39m,
    [32m'2026-01-15T22:18:01.512Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515481560,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"3ec14c728277238809ac07dde915de72","login_success","security","3ec14c728277238809ac07dde915de72","security","3ec14c728277238809ac07dde915de72","{\"metadata\":{\"timestamp\":\"2026-01-15T22:18:01.512Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:18:01.512Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w58
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w58,public

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w56, public

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w58 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w58%2Cpublic

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould return 400 if no active session found
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w56
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w55.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w55.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w60, public

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w60
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w56.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w56.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515482018,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould regenerate backup codes
[22m[39m[TEST UTILS] MFA Secret verified for 0655ca2a29fe5c5eeae42064a74484cb

{"level":30,"time":1768515482095,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould validate expression after debounce
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768515482144,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768515482145,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515482222,"env":"test","module":"auth-routes","userId":"924482940d2debff722fdc5744a8f67b","msg":"User logged in successfully"}
 [32m‚úì[39m tests/ui/datavault/TableCard.test.tsx [2m([22m[2m8 tests[22m[2m)[22m[33m 3364[2mms[22m[39m
     [33m[2m‚úì[22m[39m should call onDelete when delete button is clicked [33m 936[2mms[22m[39m
{"level":50,"time":1768515482268,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"924482940d2debff722fdc5744a8f67b","login_success","security","924482940d2debff722fdc5744a8f67b","security","924482940d2debff722fdc5744a8f67b","{\"metadata\":{\"timestamp\":\"2026-01-15T22:18:02.222Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:18:02.222Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"924482940d2debff722fdc5744a8f67b","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould return 400 if no active session found
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,924482940d2debff722fdc5744a8f67b,login_success,security,924482940d2debff722fdc5744a8f67b,security,924482940d2debff722fdc5744a8f67b,{"metadata":{"timestamp":"2026-01-15T22:18:02.222Z"}},::ffff:127.0.0.1,,2026-01-15T22:18:02.222Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'924482940d2debff722fdc5744a8f67b'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'924482940d2debff722fdc5744a8f67b'[39m,
    [32m'security'[39m,
    [32m'924482940d2debff722fdc5744a8f67b'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:18:02.222Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:18:02.222Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":50,"time":1768515482269,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"924482940d2debff722fdc5744a8f67b","login_success","security","924482940d2debff722fdc5744a8f67b","security","924482940d2debff722fdc5744a8f67b","{\"metadata\":{\"timestamp\":\"2026-01-15T22:18:02.222Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:18:02.222Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515482278,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w59
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w59,public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould regenerate backup codes
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mValidation Result DEBUG: {"ok":false,"errors":[{"message":"Unknown identifier: unknown_var","start":{"line":0,"col":0},"end":{"line":0,"col":11}}]}
IsValid DEBUG: [33mfalse[39m

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould debounce validation calls
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w59 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w59%2Cpublic

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w57, public

{"level":40,"time":1768515482456,"env":"test","error":{},"msg":"PDF conversion failed"}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w61
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w61,public

{"level":30,"time":1768515482472,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515482473,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w57
‚è© Schema reused, skipping migrations.

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould not validate when workflowId or nodeId is missing
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould not validate when workflowId or nodeId is missing
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768515482511,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w61 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w61%2Cpublic

{"level":30,"time":1768515482512,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/docxRenderer.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 2437[2mms[22m[39m
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w60.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w60.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515482584,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515482585,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515482604,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

 [31m‚ùØ[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 36346[2mms[22m[39m
       [33m[2m‚úì[22m[39m should trust current device [33m 2233[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set trust expiry to 30 days [33m 2091[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update expiry if device already trusted [33m 2575[2mms[22m[39m
       [32m‚úì[39m should require authentication[32m 7[2mms[22m[39m
       [33m[2m‚úì[22m[39m should list all trusted devices [33m 3657[2mms[22m[39m
       [33m[2m‚úì[22m[39m should mark current device [33m 2256[2mms[22m[39m
       [33m[2m‚úì[22m[39m should exclude revoked devices [33m 2544[2mms[22m[39m
       [33m[2m‚úì[22m[39m should exclude expired devices [33m 2199[2mms[22m[39m
       [33m[2m‚úì[22m[39m should revoke specific device [33m 2416[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 404 for non-existent device [33m 1936[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent revoking other user's device [33m 4183[2mms[22m[39m
[31m       [31m√ó[31m should skip MFA for trusted device[39m[33m 2971[2mms[22m[39m
       [33m[2m‚úì[22m[39m should require MFA for untrusted device [33m 2677[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update lastUsedAt on trusted device login [33m 3432[2mms[22m[39m
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject invalid token
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,cdc61ea6-c6b4-4ee3-9fea-75d7ff5a67fd,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'cdc61ea6-c6b4-4ee3-9fea-75d7ff5a67fd'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould validate helper functions in expressions
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768515482656,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/unit/components/datavault/TableGridView.test.tsx [2m([22m[2m9 tests[22m[2m)[22m[33m 4271[2mms[22m[39m
     [33m[2m‚úì[22m[39m loads table schema and rows [33m 427[2mms[22m[39m
     [33m[2m‚úì[22m[39m enters edit mode on double click [33m 439[2mms[22m[39m
     [33m[2m‚úì[22m[39m updates cell value on blur [33m 552[2mms[22m[39m
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould validate complex expressions with multiple helpers
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768515482877,"env":"test","module":"auth-routes","userId":"0655ca2a29fe5c5eeae42064a74484cb","msg":"Login requires MFA verification"}
[90mstderr[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx[2m > [22m[2mTableGridView - Drag & Drop[2m > [22m[2mrenders DndContext wrapper
[22m[39mWarning: validateDOMNesting(...): <th> cannot appear as a child of <div>.
    at th
    at SortableColumnHeader (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/SortableColumnHeader.tsx:12:33)
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
Warning: validateDOMNesting(...): <div> cannot appear as a child of <tr>.
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould handle syntax errors
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768515482976,"env":"test","module":"mfa-service","userId":"0655ca2a29fe5c5eeae42064a74484cb","msg":"TOTP verification successful"}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w58, public

{"level":30,"time":1768515483022,"env":"test","module":"auth-routes","userId":"0655ca2a29fe5c5eeae42064a74484cb","msg":"MFA login successful"}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w58
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w62
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w62,public

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w62 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w62%2Cpublic

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w57.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w57.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression Editor component behavior[2m > [22m[2mshould update validation when expression changes
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w64
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w64,public

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w64 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w64%2Cpublic

{"level":30,"time":1768515483205,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w63
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w63,public

{"level":30,"time":1768515483255,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression Editor component behavior[2m > [22m[2mshould update validation when expression changes
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w63 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w63%2Cpublic

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515483373,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515483382,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515483383,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515483397,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515483411,"env":"test","module":"mfa-service","userId":"0655ca2a29fe5c5eeae42064a74484cb","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768515483411,"env":"test","module":"mfa-service","userId":"0655ca2a29fe5c5eeae42064a74484cb","msg":"Regenerated backup codes"}
{"level":30,"time":1768515483411,"env":"test","module":"auth-routes","userId":"0655ca2a29fe5c5eeae42064a74484cb","msg":"Backup codes regenerated"}
{"level":30,"time":1768515483448,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/ui/expression-editor.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 3582[2mms[22m[39m
{"level":30,"time":1768515483458,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w64, public

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w64
‚è© Schema reused, skipping migrations.

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould return pending invites for user email
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,d3185c18-1da2-4e86-a446-9d4f5f42710c,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'd3185c18-1da2-4e86-a446-9d4f5f42710c'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w58.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w58.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w61, public

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w59, public

{"level":30,"time":1768515483824,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515483824,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w61
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w59
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w68
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w68,public

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w64.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w64.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w64.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w64.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w68 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w68%2Cpublic

 [32m‚úì[39m tests/unit/components/datavault/TableGridViewDragDrop.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 3280[2mms[22m[39m
     [33m[2m‚úì[22m[39m displays columns in order based on orderIndex [33m 434[2mms[22m[39m
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

{"level":30,"time":1768515484063,"env":"test","module":"auth-routes","userId":"1bb1242ec74f496a64771e715a9b3ba9","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515484105,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768515484113,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"1bb1242ec74f496a64771e715a9b3ba9","login_success","security","1bb1242ec74f496a64771e715a9b3ba9","security","1bb1242ec74f496a64771e715a9b3ba9","{\"metadata\":{\"timestamp\":\"2026-01-15T22:18:04.063Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:18:04.063Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"1bb1242ec74f496a64771e715a9b3ba9","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all trusted devices
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,1bb1242ec74f496a64771e715a9b3ba9,login_success,security,1bb1242ec74f496a64771e715a9b3ba9,security,1bb1242ec74f496a64771e715a9b3ba9,{"metadata":{"timestamp":"2026-01-15T22:18:04.063Z"}},::ffff:127.0.0.1,,2026-01-15T22:18:04.063Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'1bb1242ec74f496a64771e715a9b3ba9'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'1bb1242ec74f496a64771e715a9b3ba9'[39m,
    [32m'security'[39m,
    [32m'1bb1242ec74f496a64771e715a9b3ba9'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:18:04.063Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:18:04.063Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515484113,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"1bb1242ec74f496a64771e715a9b3ba9","login_success","security","1bb1242ec74f496a64771e715a9b3ba9","security","1bb1242ec74f496a64771e715a9b3ba9","{\"metadata\":{\"timestamp\":\"2026-01-15T22:18:04.063Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:18:04.063Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515484123,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768515484129,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/dynamic_options_workflow.test.ts[2m > [22m[2mDynamic Options Integration Flow
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/dynamic_options_workflow.test.ts:41:26

{"level":30,"time":1768515484150,"env":"test","module":"email-queue","jobId":"984a4c64-28b4-4e7e-b1e6-cf0a37669436","to":"existing_1768515458508@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515484154,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515484157,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515484206,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould return pending invites for user email
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,d3185c18-1da2-4e86-a446-9d4f5f42710c,{"after":{"invitedEmail":"existing_1768515458508@test.com","token":"2313fe9a6821bbebc2da3d286c112e96861d30166c0095960f62ec4fbbfdfa20"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'd3185c18-1da2-4e86-a446-9d4f5f42710c'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768515458508@test.com","token":"2313fe9a6821bbebc2da3d286c112e96861d30166c0095960f62ec4fbbfdfa20"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:278:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515484277,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515484277,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515484329,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515484330,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

 [32m‚úì[39m tests/unit/components/datavault/CellRenderer.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 3079[2mms[22m[39m
     [33m[2m‚úì[22m[39m renders boolean value as Yes/No [33m 523[2mms[22m[39m
 [32m‚úì[39m tests/ui/datavault/TemplateCard.test.tsx [2m([22m[2m6 tests[22m[2m)[22m[33m 2304[2mms[22m[39m
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould return error if MFA not enabled
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w62, public

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w63, public

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w62
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w63
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w59.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w61.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w59.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w59.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w61.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w59.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w61.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w61.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w69
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w69,public

{"level":30,"time":1768515484794,"env":"test","blockId":"2cb6ceec-6e84-4382-990f-4abaa3d8cc42","virtualStepId":"2d1a43c7-4fb0-4ac6-9d67-25a27e5fc926","outputVar":"userList","msg":"Created read table block with virtual step"}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w69 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w69%2Cpublic

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515484839,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515484896,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

{"level":30,"time":1768515484913,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

{"level":30,"time":1768515484914,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515484925,"env":"test","module":"auth-routes","userId":"f254b4eb2a2caf4e4538d6a0700dc0f1","msg":"User logged in successfully"}
{"level":50,"time":1768515484976,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"f254b4eb2a2caf4e4538d6a0700dc0f1","login_success","security","f254b4eb2a2caf4e4538d6a0700dc0f1","security","f254b4eb2a2caf4e4538d6a0700dc0f1","{\"metadata\":{\"timestamp\":\"2026-01-15T22:18:04.926Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:18:04.926Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"f254b4eb2a2caf4e4538d6a0700dc0f1","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould return error if MFA not enabled
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,f254b4eb2a2caf4e4538d6a0700dc0f1,login_success,security,f254b4eb2a2caf4e4538d6a0700dc0f1,security,f254b4eb2a2caf4e4538d6a0700dc0f1,{"metadata":{"timestamp":"2026-01-15T22:18:04.926Z"}},::ffff:127.0.0.1,,2026-01-15T22:18:04.926Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'f254b4eb2a2caf4e4538d6a0700dc0f1'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'f254b4eb2a2caf4e4538d6a0700dc0f1'[39m,
    [32m'security'[39m,
    [32m'f254b4eb2a2caf4e4538d6a0700dc0f1'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:18:04.926Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:18:04.926Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515484976,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"f254b4eb2a2caf4e4538d6a0700dc0f1","login_success","security","f254b4eb2a2caf4e4538d6a0700dc0f1","security","f254b4eb2a2caf4e4538d6a0700dc0f1","{\"metadata\":{\"timestamp\":\"2026-01-15T22:18:04.926Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:18:04.926Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515484983,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w70
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w70,public

 [32m‚úì[39m tests/ui/datavault/DatabaseSettingsPage.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 2990[2mms[22m[39m
     [33m[2m‚úì[22m[39m should render database settings page with breadcrumbs [33m 371[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w70 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w70%2Cpublic

{"level":30,"time":1768515485037,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
{"level":30,"time":1768515485037,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768515485040,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768515485078,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515485080,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515485097,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515485147,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
{"level":30,"time":1768515485147,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768515485148,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":40,"time":1768515485156,"env":"test","module":"metrics-routes","ip":"::ffff:127.0.0.1","msg":"Unauthorized metrics access attempt"}
 [32m‚úì[39m tests/unit/components/datavault/SortableColumnHeader.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 2505[2mms[22m[39m
{"level":30,"time":1768515485168,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515485169,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515485170,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515485204,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515485205,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w65
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w65,public

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w68, public

 [32m‚úì[39m tests/integration/dynamic_options_workflow.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 2452[2mms[22m[39m
     [33m[2m‚úì[22m[39m should successfully configure a workflow with Read Table -> Dynamic Choice [33m 700[2mms[22m[39m
 [32m‚úì[39m tests/integration/metrics.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 2328[2mms[22m[39m
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w65 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w65%2Cpublic

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w68
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w62.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w63.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w62.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w67
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w67,public

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w71
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w71,public

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w63.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w67 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w67%2Cpublic

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w71 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w71%2Cpublic

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould handle user with single session gracefully
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w66
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w66,public

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w66 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w66%2Cpublic

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return expired invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,06537efe-ea2b-4f25-8d60-a5efa06cee1d,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'06537efe-ea2b-4f25-8d60-a5efa06cee1d'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515485634,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515485635,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/engine/Performance.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2178[2mms[22m[39m
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515485703,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768515485765,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w72
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w72,public

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w72 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w72%2Cpublic

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w73
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w73,public

{"level":30,"time":1768515485954,"env":"test","module":"auth-routes","userId":"a99b06fba4c958254dcd02e417df9918","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w73 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w73%2Cpublic

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515485995,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768515485998,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"a99b06fba4c958254dcd02e417df9918","login_success","security","a99b06fba4c958254dcd02e417df9918","security","a99b06fba4c958254dcd02e417df9918","{\"metadata\":{\"timestamp\":\"2026-01-15T22:18:05.954Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:18:05.954Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"a99b06fba4c958254dcd02e417df9918","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould handle user with single session gracefully
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,a99b06fba4c958254dcd02e417df9918,login_success,security,a99b06fba4c958254dcd02e417df9918,security,a99b06fba4c958254dcd02e417df9918,{"metadata":{"timestamp":"2026-01-15T22:18:05.954Z"}},::ffff:127.0.0.1,,2026-01-15T22:18:05.954Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'a99b06fba4c958254dcd02e417df9918'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'a99b06fba4c958254dcd02e417df9918'[39m,
    [32m'security'[39m,
    [32m'a99b06fba4c958254dcd02e417df9918'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:18:05.954Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:18:05.954Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515485998,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"a99b06fba4c958254dcd02e417df9918","login_success","security","a99b06fba4c958254dcd02e417df9918","security","a99b06fba4c958254dcd02e417df9918","{\"metadata\":{\"timestamp\":\"2026-01-15T22:18:05.954Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:18:05.954Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515486007,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768515486060,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515486093,"env":"test","module":"email-queue","jobId":"116d2314-bae0-48b7-847b-da3f18eecaf9","to":"existing_1768515458508@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w69, public

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return expired invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,06537efe-ea2b-4f25-8d60-a5efa06cee1d,{"after":{"invitedEmail":"existing_1768515458508@test.com","token":"a3731848648090017ed7ad405aae006360c30d011bb39122ddb62a18b6b7efeb"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'06537efe-ea2b-4f25-8d60-a5efa06cee1d'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768515458508@test.com","token":"a3731848648090017ed7ad405aae006360c30d011bb39122ddb62a18b6b7efeb"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:294:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w69
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w68.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w68.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w75
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w75,public

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515486298,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w75 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w75%2Cpublic

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768515486348,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515486360,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mTenant-Level MFA Enforcement[2m > [22m[2mshould enforce MFA for tenant users when required by tenant
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w70, public

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515486425,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515486427,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w70
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768515486482,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w69.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w69.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515486535,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515486536,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/HelperLibrary.test.ts [2m([22m[2m60 tests[22m[2m)[22m[33m 2169[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515486587,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w76
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w76,public

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w74
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w74,public

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w76 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w76%2Cpublic

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w74 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w74%2Cpublic

{"level":30,"time":1768515486640,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w65, public

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w65
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515486760,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515486760,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515486760,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w71, public

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w70.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w70.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/shared/validation/Validator.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 2161[2mms[22m[39m
{"level":30,"time":1768515486810,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515486812,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w77
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w77,public

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w71
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w67, public

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w77 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w77%2Cpublic

{"level":30,"time":1768515486871,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w67
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768515486916,"env":"test","module":"auth-routes","userId":"cb54cad6510a5c5ae878f07c8c06701d","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w65.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w65.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w66, public

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w66
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w67.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w71.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w67.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515487123,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515487139,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515487140,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w71.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w72, public

 [32m‚úì[39m tests/unit/services/docxHelpers.test.ts [2m([22m[2m39 tests[22m[2m)[22m[33m 2184[2mms[22m[39m
{"level":30,"time":1768515487185,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515487189,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515487190,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w73, public

{"level":30,"time":1768515487220,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w72
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768515487222,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/ui/blocks/SendDataToTableBlockEditor.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 2400[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w73
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w66.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w66.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould include device metadata in sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

 [32m‚úì[39m tests/ui/common/Breadcrumbs.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 2429[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w66.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w66.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515487404,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515487426,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515487459,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515487480,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515487532,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515487533,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w75, public

{"level":30,"time":1768515487547,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515487548,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515487579,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return accepted invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,e1aedbe5-6e91-49b7-889e-3344422aa5de,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'e1aedbe5-6e91-49b7-889e-3344422aa5de'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515487580,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/docxRenderer2.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 2117[2mms[22m[39m
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w75
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w78
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w78,public

 [32m‚úì[39m tests/ui/datavault/ColumnTypeIcon.test.tsx [2m([22m[2m27 tests[22m[2m)[22m[33m 2471[2mms[22m[39m
 [32m‚úì[39m tests/unit/utils/conditionalLogic-simple.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2065[2mms[22m[39m
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w72.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w73.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w72.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w78 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w78%2Cpublic

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w73.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w79
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w79,public

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515487736,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515487776,"env":"test","module":"auth-routes","userId":"b545e9388df77f61376a572f3e8f4fbd","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w79 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w79%2Cpublic

{"level":30,"time":1768515487795,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w76, public

{"level":50,"time":1768515487824,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"b545e9388df77f61376a572f3e8f4fbd","login_success","security","b545e9388df77f61376a572f3e8f4fbd","security","b545e9388df77f61376a572f3e8f4fbd","{\"metadata\":{\"timestamp\":\"2026-01-15T22:18:07.776Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/96.0","2026-01-15T22:18:07.776Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"b545e9388df77f61376a572f3e8f4fbd","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould include device metadata in sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,b545e9388df77f61376a572f3e8f4fbd,login_success,security,b545e9388df77f61376a572f3e8f4fbd,security,b545e9388df77f61376a572f3e8f4fbd,{"metadata":{"timestamp":"2026-01-15T22:18:07.776Z"}},192.168.1.100,Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/96.0,2026-01-15T22:18:07.776Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'b545e9388df77f61376a572f3e8f4fbd'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'b545e9388df77f61376a572f3e8f4fbd'[39m,
    [32m'security'[39m,
    [32m'b545e9388df77f61376a572f3e8f4fbd'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:18:07.776Z"}}'[39m,
    [32m'192.168.1.100'[39m,
    [32m'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/96.0'[39m,
    [32m'2026-01-15T22:18:07.776Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515487824,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"b545e9388df77f61376a572f3e8f4fbd","login_success","security","b545e9388df77f61376a572f3e8f4fbd","security","b545e9388df77f61376a572f3e8f4fbd","{\"metadata\":{\"timestamp\":\"2026-01-15T22:18:07.776Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/96.0","2026-01-15T22:18:07.776Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515487833,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w74, public

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w76
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w74
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w75.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w75.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w75.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w75.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515487973,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515487974,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

 [32m‚úì[39m tests/unit/listPipeline.semantics.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 2125[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

{"level":30,"time":1768515488077,"env":"test","module":"email-queue","jobId":"79281754-86e4-4f38-99a8-7712167e8abc","to":"existing_1768515458508@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w80
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w80,public

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

{"level":30,"time":1768515488122,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515488122,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w80 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w80%2Cpublic

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w77, public

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w81
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w81,public

{"level":30,"time":1768515488156,"env":"test","module":"workflow-quality-validator","overall":99,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"issuesCount":1,"passed":true,"msg":"Workflow quality validation completed"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return accepted invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,e1aedbe5-6e91-49b7-889e-3344422aa5de,{"after":{"invitedEmail":"existing_1768515458508@test.com","token":"7bb17729991abfbaabdbe5871989378c5d8389e7700434374de9613ca2353c9c"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'e1aedbe5-6e91-49b7-889e-3344422aa5de'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768515458508@test.com","token":"7bb17729991abfbaabdbe5871989378c5d8389e7700434374de9613ca2353c9c"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:312:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":40,"time":1768515488187,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w82
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w82,public

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w77
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w81 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w81%2Cpublic

{"level":30,"time":1768515488156,"env":"test","module":"ai-service","duration":7,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":99,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":1,"msg":"AI workflow generation succeeded"}
{"level":50,"time":1768515488161,"env":"test","module":"ai-service","error":{"code":"VALIDATION_ERROR","troubleshooting":"üîß Troubleshooting Steps:\n1. The AI response structure doesn't match our expected format\n2. This may indicate:\n   - A breaking change in the AI model behavior\n   - The model is struggling with the complexity of the request\n3. Try simplifying your workflow or request\n4. If this persists, please report this issue with the workflow details"},"duration":1,"msg":"AI workflow generation failed"}
{"level":50,"time":1768515488166,"env":"test","module":"ai-service","error":{"code":"VALIDATION_ERROR","troubleshooting":"üîß Troubleshooting Steps:\n1. The AI response structure doesn't match our expected format\n2. This may indicate:\n   - A breaking change in the AI model behavior\n   - The model is struggling with the complexity of the request\n3. Try simplifying your workflow or request\n4. If this persists, please report this issue with the workflow details"},"duration":1,"msg":"AI workflow generation failed"}
{"level":50,"time":1768515488170,"env":"test","module":"ai-service","error":{"code":"VALIDATION_ERROR","troubleshooting":"üîß Troubleshooting Steps:\n1. The AI response structure doesn't match our expected format\n2. This may indicate:\n   - A breaking change in the AI model behavior\n   - The model is struggling with the complexity of the request\n3. Try simplifying your workflow or request\n4. If this persists, please report this issue with the workflow details"},"duration":1,"msg":"AI workflow generation failed"}
{"level":40,"time":1768515488175,"env":"test","module":"ai-service","attempt":0,"retryAfter":1000,"error":"Rate limit exceeded","msg":"Retrying AI request..."}
{"level":40,"time":1768515488175,"env":"test","module":"ai-service","attempt":1,"retryAfter":2000,"error":"Rate limit exceeded","msg":"Retrying AI request..."}
{"level":40,"time":1768515488176,"env":"test","module":"ai-service","attempt":2,"retryAfter":4000,"error":"Rate limit exceeded","msg":"Retrying AI request..."}
{"level":50,"time":1768515488176,"env":"test","module":"ai-service","event":"ai_request_failed","provider":"openai","model":"gpt-4-turbo-preview","taskType":"workflow_generation","errorType":"RATE_LIMIT","durationMs":1,"attempts":4,"msg":"AI request failed: rate limit"}
{"level":50,"time":1768515488176,"env":"test","module":"ai-service","error":{"code":"RATE_LIMIT","details":{"originalError":"Rate limit exceeded","retryAfterSeconds":60},"troubleshooting":"üîß Troubleshooting Steps:\n1. You've hit the AI provider's rate limit\n2. Solutions:\n   - Wait 60 seconds and try again\n   - Check your API key quota at your provider's dashboard\n   - Consider upgrading your API plan for higher limits\n   - If using free tier, you may need to wait until limits reset"},"duration":1,"msg":"AI workflow generation failed"}
{"level":50,"time":1768515488180,"env":"test","module":"ai-service","error":{},"duration":0,"msg":"AI workflow generation failed"}
{"level":30,"time":1768515488188,"env":"test","module":"workflow-quality-validator","overall":100,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"issuesCount":0,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768515488188,"env":"test","module":"ai-service","duration":0,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":100,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":0,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768515488192,"env":"test","module":"workflow-quality-validator","overall":96,"breakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"issuesCount":2,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768515488192,"env":"test","module":"ai-service","duration":1,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":96,"qualityBreakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"qualityPassed":true,"issuesCount":2,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768515488197,"env":"test","module":"ai-service","duration":1,"suggestionsCount":1,"msg":"AI binding suggestion succeeded"}
{"level":30,"time":1768515488198,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515488198,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":40,"time":1768515488193,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768515488198,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768515488202,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768515488205,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":30,"time":1768515488215,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515488215,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w82 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w82%2Cpublic

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w74.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w76.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w74.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/ai.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 1992[2mms[22m[39m
 [31m‚ùØ[39m tests/integration/mfa.flow.real.test.ts [2m([22m[2m20 tests[22m[2m | [22m[31m9 failed[39m[2m)[22m[33m 41957[2mms[22m[39m
[31m       [31m√ó[31m should complete full MFA setup flow[39m[33m 1876[2mms[22m[39m
[31m       [31m√ó[31m should reject invalid TOTP code during setup[39m[33m 1795[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not allow MFA setup if already enabled [33m 1895[2mms[22m[39m
[31m       [31m√ó[31m should generate unique backup codes[39m[33m 1850[2mms[22m[39m
[31m       [31m√ó[31m should store hashed backup codes[39m[33m 1893[2mms[22m[39m
       [33m[2m‚úì[22m[39m should require MFA for enabled users [33m 1964[2mms[22m[39m
       [33m[2m‚úì[22m[39m should complete MFA login with valid TOTP [33m 1981[2mms[22m[39m
       [33m[2m‚úì[22m[39m should reject invalid TOTP during login [33m 2111[2mms[22m[39m
       [33m[2m‚úì[22m[39m should accept TOTP codes within 60-second window [33m 2548[2mms[22m[39m
[31m       [31m√ó[31m should login with valid backup code[39m[33m 1853[2mms[22m[39m
       [33m[2m‚úì[22m[39m should mark backup code as used [33m 1385[2mms[22m[39m
[31m       [31m√ó[31m should prevent backup code reuse[39m[33m 1905[2mms[22m[39m
       [33m[2m‚úì[22m[39m should try TOTP before backup code [33m 1826[2mms[22m[39m
[31m       [31m√ó[31m should return MFA status for user[39m[33m 1747[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return backup codes count for MFA users [33m 2127[2mms[22m[39m
[31m       [31m√ó[31m should disable MFA with password verification[39m[33m 2939[2mms[22m[39m
       [33m[2m‚úì[22m[39m should require correct password to disable MFA [33m 2576[2mms[22m[39m
       [33m[2m‚úì[22m[39m should regenerate backup codes [33m 2419[2mms[22m[39m
[31m       [31m√ó[31m should return error if MFA not enabled[39m[33m 1828[2mms[22m[39m
       [33m[2m‚úì[22m[39m should enforce MFA for tenant users when required by tenant [33m 2271[2mms[22m[39m
 [32m‚úì[39m tests/unit/isolatedVmBridge.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 2037[2mms[22m[39m
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w76.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w83
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w83,public

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w83 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w83%2Cpublic

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515488481,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768515488543,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515488544,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w84
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w84,public

{"level":30,"time":1768515488564,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w85
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w85,public

 [32m‚úì[39m tests/ui/builder.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 2120[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w84 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w84%2Cpublic

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w85 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w85%2Cpublic

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515488630,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515488685,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return accepted invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000022,organization.invite_accept,organization,e1aedbe5-6e91-49b7-889e-3344422aa5de,{"after":{"email":"existing_1768515458508@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000022'[39m,
    [32m'organization.invite_accept'[39m,
    [32m'organization'[39m,
    [32m'e1aedbe5-6e91-49b7-889e-3344422aa5de'[39m,
    [32m'{"after":{"email":"existing_1768515458508@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:318:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w78, public

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w78
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w79, public

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w77.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w77.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w79
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w86
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w86,public

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould not expose sensitive token data
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w86 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w86%2Cpublic

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515489216,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515489273,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515489325,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515489326,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515489351,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

 [32m‚úì[39m tests/unit/services/TemplateAnalysisService.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 2111[2mms[22m[39m
{"level":30,"time":1768515489370,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w89
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w89,public

{"level":30,"time":1768515489408,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515489409,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515489414,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w89 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w89%2Cpublic

{"level":30,"time":1768515489437,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/unit/utils/conditionalLogic.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 2091[2mms[22m[39m
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w88
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w88,public

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w88 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w88%2Cpublic

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w87
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w87,public

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515489530,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w80, public

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515489545,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w87 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w87%2Cpublic

{"level":30,"time":1768515489583,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w80
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768515489599,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w81, public

{"level":30,"time":1768515489622,"env":"test","module":"auth-routes","userId":"22ebd2e62248f91c3b748417891fe3ef","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w90
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w90,public

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w78.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w79.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w78.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768515489671,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"22ebd2e62248f91c3b748417891fe3ef","login_success","security","22ebd2e62248f91c3b748417891fe3ef","security","22ebd2e62248f91c3b748417891fe3ef","{\"metadata\":{\"timestamp\":\"2026-01-15T22:18:09.622Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:18:09.622Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"22ebd2e62248f91c3b748417891fe3ef","eventType":"login_success","msg":"Failed to log security event"}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w81
‚è© Schema reused, skipping migrations.

[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould not expose sensitive token data
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,22ebd2e62248f91c3b748417891fe3ef,login_success,security,22ebd2e62248f91c3b748417891fe3ef,security,22ebd2e62248f91c3b748417891fe3ef,{"metadata":{"timestamp":"2026-01-15T22:18:09.622Z"}},::ffff:127.0.0.1,,2026-01-15T22:18:09.622Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'22ebd2e62248f91c3b748417891fe3ef'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'22ebd2e62248f91c3b748417891fe3ef'[39m,
    [32m'security'[39m,
    [32m'22ebd2e62248f91c3b748417891fe3ef'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:18:09.622Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:18:09.622Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515489671,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"22ebd2e62248f91c3b748417891fe3ef","login_success","security","22ebd2e62248f91c3b748417891fe3ef","security","22ebd2e62248f91c3b748417891fe3ef","{\"metadata\":{\"timestamp\":\"2026-01-15T22:18:09.622Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:18:09.622Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515489678,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w90 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w90%2Cpublic

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w79.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w79.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w79.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w83, public

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w82, public

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w83
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w82
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w80.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w81.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w80.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w80.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w81.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w80.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w85, public

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w81.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w81.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w84, public

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w85
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768515489981,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/BlockRunner.validate.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 2246[2mms[22m[39m
{"level":30,"time":1768515489982,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515489989,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w84
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mDEBUG: Existing functions: []

 [32m‚úì[39m tests/unit/client/list-choice-options.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 2223[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w82.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w83.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w82.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515490051,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w83.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515490169,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515490171,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/unit/client/choice-utils.test.ts[2m > [22m[2mchoice-utils[2m > [22m[2mhandles missing content gracefully
[22m[39m[generateOptionsFromList] Invalid list data: [1mnull[22m

{"level":30,"time":1768515490202,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515490203,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/session.management.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 2126[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515490215,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould allow admin to revoke invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,6963d242-8dd6-4c1f-adc0-edd95b4ba4f6,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'6963d242-8dd6-4c1f-adc0-edd95b4ba4f6'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

 [32m‚úì[39m tests/unit/client/choice-utils.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 2397[2mms[22m[39m
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515490251,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515490269,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515490269,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515490271,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515490304,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515490304,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/ui/blocks/SendDataBlockEditorRouting.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 2137[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w92
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w92,public

{"level":30,"time":1768515490354,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w92 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w92%2Cpublic

[90mstderr[2m | tests/unit/shared/conditionEvaluator.test.ts[2m > [22m[2mconditionEvaluator[2m > [22m[2mComparison operators[2m > [22m[2mUnknown operator[2m > [22m[2mshould default to true and log warning
[22m[39mUnknown operator: unknown_operator

{"level":30,"time":1768515490378,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515490379,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w86, public

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

 [32m‚úì[39m tests/unit/shared/conditionEvaluator.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 2237[2mms[22m[39m
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w86
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w84.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w85.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w84.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515490489,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w91
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w91,public

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w85.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w91 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w91%2Cpublic

{"level":30,"time":1768515490560,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w89, public

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w88, public

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w89
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w87, public

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w88
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w86.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w86.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515490724,"env":"test","module":"email-queue","jobId":"00bb251b-a434-4ac6-b17f-696cf5ef5fd7","to":"existing_1768515458508@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w87
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w86.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w86.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768515490780,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515490780,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould allow admin to revoke invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,6963d242-8dd6-4c1f-adc0-edd95b4ba4f6,{"after":{"invitedEmail":"existing_1768515458508@test.com","token":"b2f3db5ba9a98f591f08658282f09ffc6ea1371c6cf4548679a9ede3b282ccbd"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'6963d242-8dd6-4c1f-adc0-edd95b4ba4f6'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768515458508@test.com","token":"b2f3db5ba9a98f591f08658282f09ffc6ea1371c6cf4548679a9ede3b282ccbd"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:328:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

 [32m‚úì[39m tests/integration/mfa.flow.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 2129[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w94
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w94,public

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w90, public

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w93
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w93,public

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w94 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w94%2Cpublic

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w90
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould track session activity timestamps
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w93 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w93%2Cpublic

{"level":30,"time":1768515490995,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515490995,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w87.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w88.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w89.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w87.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515491012,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515491013,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/utils/encryption.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 2040[2mms[22m[39m
{"level":50,"time":1768515491047,"env":"test","status":401,"statusText":"Unauthorized","error":"Invalid client credentials","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
 [32m‚úì[39m tests/unit/services/RunExecutionCoordinator.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 1981[2mms[22m[39m
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w88.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768515491048,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768515491050,"env":"test","data":{"token_type":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768515491050,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768515491051,"env":"test","data":{"access_token":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768515491051,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768515491052,"env":"test","error":"Network error: ECONNREFUSED","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w95
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w95,public

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w89.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w95 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w95%2Cpublic

{"level":50,"time":1768515491158,"env":"test","error":"Invalid credentials","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w96
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w96,public

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515491171,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768515491159,"env":"test","error":"ECONNREFUSED","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768515491160,"env":"test","status":400,"statusText":"Bad Request","error":"Invalid grant_type","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768515491161,"env":"test","error":"OAuth2 token request failed: 400 Bad Request","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768515491161,"env":"test","status":401,"statusText":"Unauthorized","error":"Client authentication failed","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768515491161,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768515491162,"env":"test","status":403,"statusText":"Forbidden","error":"Access denied","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768515491162,"env":"test","error":"OAuth2 token request failed: 403 Forbidden","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768515491162,"env":"test","status":500,"statusText":"Internal Server Error","error":"Server error","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768515491162,"env":"test","error":"OAuth2 token request failed: 500 Internal Server Error","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768515491163,"env":"test","error":"Unexpected token in JSON","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768515491163,"env":"test","error":"Request timeout","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":30,"time":1768515491165,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515491165,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w96 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w96%2Cpublic

 [32m‚úì[39m tests/integration/auth/oauth2.client-credentials.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 2077[2mms[22m[39m
{"level":30,"time":1768515491238,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w97
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w97,public

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w98
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w98,public

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w97 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w97%2Cpublic

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w98 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w98%2Cpublic

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515491346,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould allow admin to revoke invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: 00000000-0000-0000-0000-000000000098,00000000-0000-0000-0000-000000000021,organization.invite_revoke,organization,6963d242-8dd6-4c1f-adc0-edd95b4ba4f6,{"after":{"inviteId":"fc9f8ac4-c32d-4cd7-a199-59d1a9791d18","email":"existing_1768515458508@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [32m'00000000-0000-0000-0000-000000000098'[39m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_revoke'[39m,
    [32m'organization'[39m,
    [32m'6963d242-8dd6-4c1f-adc0-edd95b4ba4f6'[39m,
    [32m'{"after":{"inviteId":"fc9f8ac4-c32d-4cd7-a199-59d1a9791d18","email":"existing_1768515458508@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.revokeInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:840:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:334:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515491372,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515491373,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515491399,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/unit/engine.expr.test.ts [2m([22m[2m26 tests[22m[2m)[22m[33m 2135[2mms[22m[39m
{"level":30,"time":1768515491458,"env":"test","module":"auth-routes","userId":"3d6066fc49698c7c7c8f9f98661f9e81","msg":"User logged in successfully"}
{"level":50,"time":1768515491508,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"3d6066fc49698c7c7c8f9f98661f9e81","login_success","security","3d6066fc49698c7c7c8f9f98661f9e81","security","3d6066fc49698c7c7c8f9f98661f9e81","{\"metadata\":{\"timestamp\":\"2026-01-15T22:18:11.458Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:18:11.458Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"3d6066fc49698c7c7c8f9f98661f9e81","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould track session activity timestamps
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,3d6066fc49698c7c7c8f9f98661f9e81,login_success,security,3d6066fc49698c7c7c8f9f98661f9e81,security,3d6066fc49698c7c7c8f9f98661f9e81,{"metadata":{"timestamp":"2026-01-15T22:18:11.458Z"}},::ffff:127.0.0.1,,2026-01-15T22:18:11.458Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [1mnull[22m,
    [1mnull[22m,
    [32m'3d6066fc49698c7c7c8f9f98661f9e81'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'3d6066fc49698c7c7c8f9f98661f9e81'[39m,
    [32m'security'[39m,
    [32m'3d6066fc49698c7c7c8f9f98661f9e81'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T22:18:11.458Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T22:18:11.458Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768515491508,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"3d6066fc49698c7c7c8f9f98661f9e81","login_success","security","3d6066fc49698c7c7c8f9f98661f9e81","security","3d6066fc49698c7c7c8f9f98661f9e81","{\"metadata\":{\"timestamp\":\"2026-01-15T22:18:11.458Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:18:11.458Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768515491515,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w92, public

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w92
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w90.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w90.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w99
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w99,public

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w99 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w99%2Cpublic

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w91, public

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w91
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515491810,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w92.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w92.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515491854,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515491861,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515491904,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515491932,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515491933,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

 [32m‚úì[39m tests/unit/shared/validation/stepConfigSchemas.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 2012[2mms[22m[39m
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515491980,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515492029,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515492094,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515492105,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515492120,"env":"test","warnings":["Python code does not call emit(). Script will not produce output."],"msg":"Script validation warnings"}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w100
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w100,public

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515492122,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515492123,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w101
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w101,public

{"level":30,"time":1768515492147,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515492152,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515492156,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w100 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w100%2Cpublic

 [32m‚úì[39m tests/unit/ScriptEngine.test.ts [2m([22m[2m26 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[33m 2004[2mms[22m[39m
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w101 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w101%2Cpublic

{"level":30,"time":1768515492217,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w93, public

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w102
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w102,public

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w94, public

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w93
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w102 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w102%2Cpublic

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w94
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w91.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w91.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w103
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w103,public

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w91.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w91.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w95, public

{"level":30,"time":1768515492394,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515492394,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w103 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w103%2Cpublic

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w95
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w93.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w94.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w93.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w96, public

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515492496,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w97, public

 [31m‚ùØ[39m tests/integration/session.management.real.test.ts [2m([22m[2m18 tests[22m[2m | [22m[31m16 failed[39m[2m)[22m[33m 46229[2mms[22m[39m
[31m       [31m√ó[31m should list all active sessions for current user[39m[33m 3550[2mms[22m[39m
[31m       [31m√ó[31m should mark current session correctly[39m[33m 2808[2mms[22m[39m
[31m       [31m√ó[31m should exclude revoked sessions[39m[33m 2786[2mms[22m[39m
[31m       [31m√ó[31m should order sessions by last used (most recent first)[39m[33m 3790[2mms[22m[39m
[31m       [31m√ó[31m should filter sessions by current user only[39m[33m 4384[2mms[22m[39m
       [32m‚úì[39m should return 401 for unauthenticated request[32m 8[2mms[22m[39m
[31m       [31m√ó[31m should revoke specific session[39m[33m 2546[2mms[22m[39m
[31m       [31m√ó[31m should prevent revoking current session[39m[33m 1740[2mms[22m[39m
[31m       [31m√ó[31m should return 404 for non-existent session[39m[33m 1820[2mms[22m[39m
[31m       [31m√ó[31m should prevent revoking other user's session[39m[33m 3449[2mms[22m[39m
[31m       [31m√ó[31m should revoke all other sessions[39m[33m 4298[2mms[22m[39m
[31m       [31m√ó[31m should keep current session active[39m[33m 2733[2mms[22m[39m
[31m       [31m√ó[31m should return 400 if no active session found[39m[33m 1893[2mms[22m[39m
       [33m[2m‚úì[22m[39m should revoke all trusted devices [33m 1892[2mms[22m[39m
[31m       [31m√ó[31m should handle user with single session gracefully[39m[33m 1838[2mms[22m[39m
[31m       [31m√ó[31m should include device metadata in sessions[39m[33m 1808[2mms[22m[39m
[31m       [31m√ó[31m should not expose sensitive token data[39m[33m 1850[2mms[22m[39m
[31m       [31m√ó[31m should track session activity timestamps[39m[33m 1827[2mms[22m[39m
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w94.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w96
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w97
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768515492553,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w98, public

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768515492572,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515492573,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mDEBUG: Existing functions: []

 [32m‚úì[39m tests/unit/captcha.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 2040[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w98
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768515492618,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515492618,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/workflows/validation.test.ts [2m([22m[2m66 tests[22m[2m)[22m[33m 2108[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w95.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w95.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould prevent accepting revoked invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,1fba91d2-95ba-4070-88d0-4003ddc475d3,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'1fba91d2-95ba-4070-88d0-4003ddc475d3'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w104
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w104,public

{"level":30,"time":1768515492795,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515492796,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w104 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w104%2Cpublic

{"level":30,"time":1768515492834,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515492835,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/workflow/QueryBlock.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2093[2mms[22m[39m
{"level":40,"time":1768515492843,"env":"test","module":"rbac-middleware","path":"/api/workflows","permission":"workflow:create","msg":"Unauthenticated user attempted to access protected resource"}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":40,"time":1768515492847,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permission":"workflow:create","path":"/api/workflows","msg":"Permission denied"}
{"level":40,"time":1768515492848,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"permission":"workflow:view","path":"/api/workflows","msg":"Permission denied"}
{"level":40,"time":1768515492849,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permissions":["workflow:create","workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (none of required permissions)"}
{"level":40,"time":1768515492851,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","permissions":["workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (missing some required permissions)"}
{"level":40,"time":1768515492852,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder"],"path":"/api/admin","msg":"Role check failed"}
{"level":40,"time":1768515492853,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"requiredRoles":["owner"],"path":"/api/admin","msg":"Role check failed"}
{"level":40,"time":1768515492853,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","requiredRoles":["owner"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768515492854,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"runner","requiredRoles":["owner","builder"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768515492856,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder","runner"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768515492859,"env":"test","module":"rbac-middleware","path":"/api/test","permission":"workflow:view","msg":"Unauthenticated user attempted to access protected resource"}
{"level":40,"time":1768515492859,"env":"test","module":"rbac-middleware","userId":"user-123","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
{"level":40,"time":1768515492860,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"invalid-role","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
{"level":30,"time":1768515492860,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515492861,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/shared/validation/PageValidator.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2074[2mms[22m[39m
 [32m‚úì[39m tests/unit/middleware/rbac.test.ts [2m([22m[2m44 tests[22m[2m)[22m[33m 2008[2mms[22m[39m
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w99, public

{"level":30,"time":1768515492929,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515492930,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w99
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/unit/utils/variableResolver.test.ts [2m([22m[2m20 tests[22m[2m)[22m[33m 2018[2mms[22m[39m
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515492980,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515492987,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w97.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w96.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w98.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w97.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w105
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w105,public

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

{"level":30,"time":1768515493041,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w96.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w105 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w105%2Cpublic

{"level":30,"time":1768515493061,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w98.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515493110,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768515493218,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515493265,"env":"test","module":"email-queue","jobId":"09a95fad-ce89-46aa-ad37-642fc03bf830","to":"existing_1768515458508@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515493268,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515493318,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould prevent accepting revoked invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,1fba91d2-95ba-4070-88d0-4003ddc475d3,{"after":{"invitedEmail":"existing_1768515458508@test.com","token":"142da6e13ffaf5b815b4c95f0e588122f5f44df2320cbd977197d93ea7e91020"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'1fba91d2-95ba-4070-88d0-4003ddc475d3'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768515458508@test.com","token":"142da6e13ffaf5b815b4c95f0e588122f5f44df2320cbd977197d93ea7e91020"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:344:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515493369,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515493370,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w101, public

 [32m‚úì[39m tests/integration/auth.routes.test.ts [2m([22m[2m41 tests[22m[2m)[22m[33m 2088[2mms[22m[39m
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w100, public

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w101
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w100
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w99.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w99.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w99.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w99.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w102, public

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w102
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w106
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w106,public

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w107
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w107,public

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w103, public

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w108
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w108,public

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w106 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w106%2Cpublic

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w100.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w101.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w100.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w103
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768515493707,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w107 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w107%2Cpublic

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w108 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w108%2Cpublic

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w101.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515493748,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w101.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w101.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768515493768,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768515493769,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating skipIf condition"}
{"level":30,"time":1768515493771,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515493772,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515493800,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515493801,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/intakeNavigation.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2017[2mms[22m[39m
[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

 [32m‚úì[39m tests/integration/conditions/conditionEvaluation.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 2074[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515493845,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould prevent accepting revoked invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: 00000000-0000-0000-0000-000000000098,00000000-0000-0000-0000-000000000021,organization.invite_revoke,organization,1fba91d2-95ba-4070-88d0-4003ddc475d3,{"after":{"inviteId":"85afa0e6-6c00-46c7-98b4-b64c0e98e940","email":"existing_1768515458508@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [32m'00000000-0000-0000-0000-000000000098'[39m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_revoke'[39m,
    [32m'organization'[39m,
    [32m'1fba91d2-95ba-4070-88d0-4003ddc475d3'[39m,
    [32m'{"after":{"inviteId":"85afa0e6-6c00-46c7-98b4-b64c0e98e940","email":"existing_1768515458508@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.revokeInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:840:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:350:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768515493895,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w111
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w111,public

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w109
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w109,public

{"level":30,"time":1768515493976,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w110
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w110,public

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515493976,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w111 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w111%2Cpublic

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w109 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w109%2Cpublic

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w112
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w112,public

{"level":30,"time":1768515494011,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/WorkflowChangeAnalyzer.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 2141[2mms[22m[39m
{"level":30,"time":1768515494011,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w110 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w110%2Cpublic

 [32m‚úì[39m tests/integration/api.ai.test.ts [2m([22m[2m32 tests[22m[2m)[22m[33m 2052[2mms[22m[39m
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w112 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w112%2Cpublic

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w104, public

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w104
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w102.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w103.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w102.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w103.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w105, public

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w105
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w104.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w104.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515494478,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515494478,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515494484,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515494502,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/integration/intake.portal.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 2093[2mms[22m[39m
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515494531,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515494538,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515494535,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515494539,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515494557,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768515494588,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/unit/shared/workflowLogic.test.ts[2m > [22m[2mworkflowLogic[2m > [22m[2mevaluateRules[2m > [22m[2mOperators[2m > [22m[2mUnknown operator[2m > [22m[2mshould return false and log warning for unknown operator
[22m[39mUnknown operator: unknown_operator

 [32m‚úì[39m tests/integration/organizationInvites.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 36018[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create placeholder user for non-existent email [33m 1956[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create invite for existing user without creating placeholder [33m 1895[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent duplicate pending invites [33m 2131[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent inviting existing members [33m 1291[2mms[22m[39m
       [33m[2m‚úì[22m[39m should require admin access to create invite [33m 993[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set expiry to 7 days from now [33m 1899[2mms[22m[39m
       [33m[2m‚úì[22m[39m should accept invite and create membership [33m 2614[2mms[22m[39m
       [33m[2m‚úì[22m[39m should convert placeholder user to real user on accept [33m 2728[2mms[22m[39m
       [33m[2m‚úì[22m[39m should reject expired invite [33m 1962[2mms[22m[39m
       [33m[2m‚úì[22m[39m should reject already accepted invite [33m 2647[2mms[22m[39m
       [33m[2m‚úì[22m[39m should verify email matches invite [33m 1953[2mms[22m[39m
       [33m[2m‚úì[22m[39m should reject invalid token [33m 1043[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return pending invites for user email [33m 1893[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not return expired invites [33m 1973[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not return accepted invites [33m 2670[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to revoke invite [33m 2541[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent accepting revoked invite [33m 2507[2mms[22m[39m
{"level":30,"time":1768515494601,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515494602,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

 [32m‚úì[39m tests/unit/shared/workflowLogic.test.ts [2m([22m[2m65 tests[22m[2m)[22m[33m 1982[2mms[22m[39m
[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w115
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w115,public

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w115 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w115%2Cpublic

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515494855,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515494857,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w107, public

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515494906,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515494909,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515494918,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w108, public

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w106, public

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w107
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515494948,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515494962,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w108
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w106
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w105.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w105.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515494998,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w105.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w105.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w105.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w105.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w113
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w113,public

{"level":40,"time":1768515495247,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w109, public

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w111, public

{"level":30,"time":1768515495276,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"sectionCount":0,"msg":"Attempting single-shot workflow revision"}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768515495268,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768515495271,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768515495271,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768515495272,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768515495272,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768515495273,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768515495275,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768515495276,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768515495277,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768515495277,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768515495277,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768515495278,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
{"level":30,"time":1768515495279,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515495280,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w113 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w113%2Cpublic

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":30,"time":1768515495287,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515495288,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515495277,"env":"test","module":"gemini-provider","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":812,"responseTokens":66,"durationMs":0,"estimatedCostUSD":0.00010760000000000001,"msg":"Gemini request succeeded"}
{"level":30,"time":1768515495281,"env":"test","module":"ai-service","duration":5,"workflowId":"123","changeCount":1,"msg":"AI workflow revision succeeded"}
{"level":30,"time":1768515495284,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"sectionCount":0,"msg":"Attempting single-shot workflow revision"}
{"level":30,"time":1768515495284,"env":"test","module":"gemini-provider","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":812,"responseTokens":45,"durationMs":0,"estimatedCostUSD":0.00009920000000000001,"msg":"Gemini request succeeded"}
{"level":30,"time":1768515495285,"env":"test","module":"ai-service","duration":1,"workflowId":"123","changeCount":0,"msg":"AI workflow revision succeeded"}
{"level":30,"time":1768515495285,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"sectionCount":0,"msg":"Attempting single-shot workflow revision"}
{"level":30,"time":1768515495286,"env":"test","module":"gemini-provider","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":811,"responseTokens":4,"durationMs":1,"estimatedCostUSD":0.0000827,"msg":"Gemini request succeeded"}
{"level":40,"time":1768515495286,"env":"test","module":"ai-provider","lastChar":"N","last50":"I am not JSON","msg":"Response does not end with closing brace/bracket"}
{"level":50,"time":1768515495286,"env":"test","module":"ai-service","responseLength":13,"estimatedTokens":4,"responseSuffix":"I am not JSON","msg":"Detected truncated AI response - workflow too large for single-shot revision"}
{"level":50,"time":1768515495286,"env":"test","module":"ai-service","error":{"code":"RESPONSE_TRUNCATED","estimatedTokens":4,"responseLength":13},"duration":1,"msg":"AI workflow revision failed"}
{"level":40,"time":1768515495286,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"actualOutputTokens":4,"responseLength":13,"msg":"Single-shot revision truncated - automatically retrying with chunking"}
{"level":30,"time":1768515495287,"env":"test","module":"gemini-provider","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":811,"responseTokens":4,"durationMs":0,"estimatedCostUSD":0.0000827,"msg":"Gemini request succeeded"}
{"level":40,"time":1768515495287,"env":"test","module":"ai-provider","lastChar":"N","last50":"I am not JSON","msg":"Response does not end with closing brace/bracket"}
{"level":50,"time":1768515495287,"env":"test","module":"ai-service","responseLength":13,"estimatedTokens":4,"responseSuffix":"I am not JSON","msg":"Detected truncated AI response - workflow too large for single-shot revision"}
{"level":50,"time":1768515495287,"env":"test","module":"ai-service","error":{"code":"RESPONSE_TRUNCATED","estimatedTokens":4,"responseLength":13},"duration":0,"msg":"AI workflow revision failed"}
{"level":50,"time":1768515495287,"env":"test","module":"ai-service","duration":2,"error":{"code":"RESPONSE_TRUNCATED","estimatedTokens":4,"responseLength":13},"msg":"AI workflow revision failed"}
{"level":30,"time":1768515495289,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515495290,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w109
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w112, public

 [32m‚úì[39m tests/unit/middleware/auth.middleware.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 2033[2mms[22m[39m
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w111
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/unit/services/AIService.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2004[2mms[22m[39m
 [32m‚úì[39m tests/unit/WorkflowOptimizationService.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 2077[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w110, public

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w107.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w108.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w106.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w107.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w112
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w107.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w108.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w106.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w107.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w110
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w108.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w108.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w106.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w108.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w108.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w108.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w106.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w108.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w106.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w106.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w106.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w106.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515495708,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515495709,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mMOCK SETUP DONE. Mock questions: [
  {
    id: [32m'q1'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q1'[39m,
    order: [33m0[39m,
    isVirtual: [33mfalse[39m,
    alias: [32m'show'[39m,
    visibleIf: [1mnull[22m
  },
  {
    id: [32m'q2'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q2'[39m,
    order: [33m1[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: { op: [32m'equals'[39m, left: [36m[Object][39m, right: [36m[Object][39m }
  },
  {
    id: [32m'q3'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q3'[39m,
    order: [33m2[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: [1mnull[22m
  }
]
Calling getVisibleQuestionCount...

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mCOUNT RESULT: [33m0[39m
Mock called times: [33m1[39m
Mock last call args: [ [ [32m'section1'[39m ] ]

{"level":50,"time":1768515495721,"env":"test","module":"intake-question-visibility","error":{},"questionId":"q1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515495723,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515495723,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515495723,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515495724,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/repeater.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 2139[2mms[22m[39m
{"level":30,"time":1768515495752,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515495753,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/intakeQuestionVisibility.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 2098[2mms[22m[39m
 [32m‚úì[39m tests/unit/workflows/conditionTruthTable.test.ts [2m([22m[2m51 tests[22m[2m)[22m[33m 2162[2mms[22m[39m
 [32m‚úì[39m tests/unit/utils/pagination.test.ts [2m([22m[2m24 tests[22m[2m)[22m[33m 2166[2mms[22m[39m
{"level":30,"time":1768515495856,"env":"test","workflowId":"123e4567-e89b-12d3-a456-426614174000","userId":"user-123","sectionsCount":2,"stepsCount":0,"logicRulesCount":1,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/WorkflowService.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 1517[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return workflow if user is the creator [33m 1041[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w116
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w116,public

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w117
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w117,public

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w116 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w116%2Cpublic

{"level":30,"time":1768515495994,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w117 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w117%2Cpublic

{"level":30,"time":1768515496038,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515496046,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515496090,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w116, public

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w117, public

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w116
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w117
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w119
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w119,public

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w109.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w110.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w112.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w111.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w109.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w109.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w110.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w112.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w111.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w109.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w119 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w119%2Cpublic

{"level":30,"time":1768515496556,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w110.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w110.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515496606,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w112.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w112.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w111.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w111.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/MfaService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 1882[2mms[22m[39m
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515496919,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts[2m > [22m[2mDatavaultColumnsService[2m > [22m[2mgetColumns[2m > [22m[2mshould throw 404 if table not found
[22m[39m[DEBUG] Table not found: 660e8400-e29b-41d4-a716-446655440001

{"level":30,"time":1768515496920,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/services/BrandingService.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 1352[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w119, public

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w119
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768515497033,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515497033,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w117.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w116.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w117.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/services/DatavaultColumnsService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1487[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w116.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768515497412,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515497412,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

 [32m‚úì[39m tests/unit/services/CollectionFieldService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 1302[2mms[22m[39m
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w122
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w122,public

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w122 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w122%2Cpublic

{"level":30,"time":1768515497581,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515497627,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w124
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w124,public

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w124 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w124%2Cpublic

{"level":30,"time":1768515497766,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768515497817,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w126
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w126,public

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w126 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w126%2Cpublic

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w125
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w125,public

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w121
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w121,public

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515497938,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w128
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w128,public

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w122, public

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w125 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w125%2Cpublic

{"level":30,"time":1768515497982,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w121 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w121%2Cpublic

{"level":30,"time":1768515497989,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515498013,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w128 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w128%2Cpublic

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w122
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768515498034,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515498043,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515498058,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w119.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w119.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768515498116,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w124, public

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w124
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w122.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w122.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515498337,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515498338,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w126, public

 [32m‚úì[39m tests/unit/services/CollectionService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1254[2mms[22m[39m
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w125, public

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w121, public

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w126
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w125
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w128, public

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w121
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w124.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w124.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w127
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w127,public

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w120
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w120,public

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w124.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w124.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w124.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w124.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w128
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w118
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w118,public

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w127 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w127%2Cpublic

{"level":30,"time":1768515498523,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w120 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w120%2Cpublic

{"level":30,"time":1768515498539,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w118 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w118%2Cpublic

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515498557,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515498559,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515498558,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515498574,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515498587,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/unit/services/DatavaultTablesService.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 1268[2mms[22m[39m
{"level":30,"time":1768515498612,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515498763,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768515498763,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515498764,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515498770,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515498771,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515498796,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","msg":"AI workflow revision job enqueued"}
 [32m‚úì[39m tests/unit/schema/collections.test.ts [2m([22m[2m34 tests[22m[2m)[22m[33m 1326[2mms[22m[39m
 [32m‚úì[39m tests/unit/lib/queries/QueryRunner.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 1252[2mms[22m[39m
{"level":30,"time":1768515498809,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w129
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w129,public

{"level":50,"time":1768515498816,"env":"test","module":"ai-controller","error":{"issues":[{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["workflowId"]},{"code":"invalid_type","expected":"object","received":"undefined","path":["currentWorkflow"],"message":"Required"},{"code":"invalid_type","expected":"string","received":"undefined","path":["userInstruction"],"message":"Required"}],"name":"ZodError"},"msg":"Failed to enqueue AI revision job"}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515498820,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515498821,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515498825,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515498826,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w129 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w129%2Cpublic

{"level":30,"time":1768515498862,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/unit/api.ai.revise.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 1276[2mms[22m[39m
 [32m‚úì[39m tests/unit/schema/documentEngine.test.ts [2m([22m[2m33 tests[22m[2m)[22m[33m 1258[2mms[22m[39m
{"level":30,"time":1768515498915,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w127, public

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w120, public

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w118, public

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w123
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w123,public

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w127
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w120
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w118
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w123 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w123%2Cpublic

{"level":30,"time":1768515499019,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w121.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w125.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w128.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w126.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w121.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w121.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w125.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w128.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w126.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w121.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w121.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w125.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w128.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w126.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w121.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w130
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w130,public

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w125.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515499075,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w125.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w125.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ListTools.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w130 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w130%2Cpublic

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w128.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515499118,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w128.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w128.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w126.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515499171,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w126.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w126.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w131
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w131,public

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w129, public

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w131 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w131%2Cpublic

{"level":30,"time":1768515499258,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w129
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768515499311,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w118.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w120.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w127.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w118.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w120.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515499413,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515499413,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w127.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w123, public

[90mstderr[2m | tests/unit/debugging/Lineage.test.ts[2m > [22m[2mDebug & Lineage[2m > [22m[2mshould generate execution trace with lineage
[22m[39m[DEBUG Question] Node q1 executed. Key: userName, Value: Alice. Context keys: 3

{"level":30,"time":1768515499453,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515499454,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould skip question when condition is false
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute question when condition is true
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: true. Context keys: 4

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute question when condition is true
[22m[39m[DEBUG Question] Node q2 executed. Key: code, Value: ABC123. Context keys: 5

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould skip compute node when condition is false
[22m[39m[DEBUG Question] Node q1 executed. Key: amount, Value: 0. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute compute node when condition is true
[22m[39m[DEBUG Question] Node q1 executed. Key: amount, Value: 100. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould handle complex workflow with multiple conditions
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 4

 [32m‚úì[39m tests/integration/branding.routes.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 1346[2mms[22m[39m
[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould handle complex workflow with multiple conditions
[22m[39m[DEBUG Question] Node q3 executed. Key: amount, Value: 1000. Context keys: 5

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w123
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w130, public

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mDebug Mode[2m > [22m[2mshould return trace when debug is enabled
[22m[39m[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mDebug Mode[2m > [22m[2mshould not return trace when debug is disabled
[22m[39m[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

{"level":30,"time":1768515499534,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515499534,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w129.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w129.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w130
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/unit/debugging/Lineage.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 1365[2mms[22m[39m
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w131, public

 [32m‚úì[39m tests/unit/engine.run-conditions.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 1422[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515499680,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515499681,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w131
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/unit/services/DocumentTemplateService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1272[2mms[22m[39m
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w123.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w130.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w123.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w130.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515499804,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515499804,"env":"test","msg":"DB: pool closed."}
{"level":40,"time":1768515499879,"env":"test","sourceListVar":"nonexistent_list","inputKey":"nonexistent_list","msg":"Input list not found, treating as empty array"}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515499881,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515499881,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/workflow/PreviewExecution.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1263[2mms[22m[39m
 [32m‚úì[39m tests/ListTools.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 1202[2mms[22m[39m
{"level":30,"time":1768515499992,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768515500059,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515500060,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/RecordService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1238[2mms[22m[39m
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w133
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w133,public

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w133 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w133%2Cpublic

{"level":30,"time":1768515500224,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768515500277,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w133, public

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w133
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w136
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w136,public

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w131.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w131.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w138
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w138,public

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w136 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w136%2Cpublic

{"level":30,"time":1768515500754,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w138 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w138%2Cpublic

{"level":30,"time":1768515500781,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w135
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w135,public

{"level":30,"time":1768515500809,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w137
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w137,public

{"level":30,"time":1768515500835,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w135 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w135%2Cpublic

{"level":30,"time":1768515500842,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w137 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w137%2Cpublic

{"level":30,"time":1768515500865,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515500891,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515500917,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768515500986,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515500986,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/repositories/DatavaultColumnsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 1210[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w134
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w134,public

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w134 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w134%2Cpublic

{"level":30,"time":1768515501143,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w136, public

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w138, public

{"level":30,"time":1768515501193,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w136
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w135, public

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w138
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w137, public

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w133.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w133.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w135
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w133.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w133.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w137
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

{"level":30,"time":1768515501526,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515501526,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w134, public

{"level":30,"time":1768515501555,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515501555,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/repositories/DatavaultTablesRepository.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 1240[2mms[22m[39m
{"level":30,"time":1768515501579,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515501580,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w139
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w139,public

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w145
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w145,public

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w134
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/unit/repositories/DocumentTemplateRepository.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 1212[2mms[22m[39m
{"level":30,"time":1768515501613,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768515501614,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w139 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w139%2Cpublic

{"level":30,"time":1768515501629,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/unit/services/StepService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1194[2mms[22m[39m
[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w145 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w145%2Cpublic

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w135.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w137.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w136.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w138.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w135.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/DataSourceService.test.ts [2m([22m[2m9 tests[22m[2m)[22m[33m 1220[2mms[22m[39m
 [32m‚úì[39m tests/unit/services/Guardrail.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 457[2mms[22m[39m
[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w142
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w142,public

{"level":30,"time":1768515501678,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w137.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w142 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w142%2Cpublic

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w136.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w138.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w143
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w143,public

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w143 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w143%2Cpublic

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

 [32m‚úì[39m tests/unit/services/PortalAuthService.test.ts [2m([22m[2m42 tests[22m[2m)[22m[33m 595[2mms[22m[39m
[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w132
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w132,public

 [32m‚úì[39m tests/unit/services/EmailTemplateMetadataService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 474[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w132 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w132%2Cpublic

{"level":30,"time":1768515501999,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w139, public

{"level":30,"time":1768515502048,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515502049,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768515502051,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w139
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/integration/datavault.api-tokens.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 1359[2mms[22m[39m
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w134.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w134.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w144
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w144,public

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w144 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w144%2Cpublic

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":40,"time":1768515502318,"env":"test","hookId":"hook-1","hookName":"Hook 1","error":"Test error","msg":"LifecycleHookService: Hook execution failed"}
[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768515502323,"env":"test","error":{},"workflowId":"workflow-1","runId":"run-1","phase":"beforePage","msg":"LifecycleHookService: Failed to execute hooks for phase"}
{"level":30,"time":1768515502326,"env":"test","hookId":"hook-1","workflowId":"workflow-1","phase":"beforePage","msg":"LifecycleHookService: Created lifecycle hook"}
{"level":30,"time":1768515502333,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Updated lifecycle hook"}
{"level":30,"time":1768515502337,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Deleted lifecycle hook"}
{"level":30,"time":1768515502386,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515502387,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/LifecycleHookService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 481[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w132, public

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

 [32m‚úì[39m tests/services/EmailTemplateMetadataService.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 1202[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w132
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w139.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w139.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w149
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w149,public

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w149 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w149%2Cpublic

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w150
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w150,public

[90mstderr[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17[90m)[39m
    at Object.get [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:144:34
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m {
  codeFrame: [32m'vi.mock(import("../../../server/db"), async (importOriginal) => {\n'[39m +
    [32m'  const actual = await importOriginal()\n'[39m +
    [32m'  return {\n'[39m +
    [32m'    ...actual,\n'[39m +
    [32m'    // your mocked methods\n'[39m +
    [32m'  }\n'[39m +
    [32m'})'[39m
}

{"level":30,"time":1768515502689,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[{"columnId":"col-first","value":"{{ firstName }}"},{"columnId":"col-last","value":"Doe"},{"columnId":"col-age","value":"{{ age }}"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768515502699,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[]},"tableId":"table-users","preview":true,"msg":"Starting write execution"}
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515502699,"env":"test","module":"write-runner","operation":"write_preview_simulated","values":{},"msg":"Simulating write in preview mode"}
{"level":30,"time":1768515502701,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"test@example.com","columnMappings":[{"columnId":"col-status","value":"Active"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":30,"time":1768515502702,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":50,"time":1768515502703,"env":"test","module":"write-runner","error":{},"config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"msg":"Write execution failed"}
 [32m‚úì[39m tests/unit/writes/WriteRunner.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 470[2mms[22m[39m
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w150 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w150%2Cpublic

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":30,"time":1768515502741,"env":"test","msg":"External Send Completed","destination":"My Webhook","success":true,"status":200}
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515502749,"env":"test","msg":"Simulating External Send","destination":"Test","payload":{}}
{"level":30,"time":1768515502755,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515502756,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/external/ExternalSendRunner.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 508[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w146
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w146,public

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w146 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w146%2Cpublic

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

 [32m‚úì[39m tests/integration/datavault.row-notes.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 1204[2mms[22m[39m
 [32m‚úì[39m tests/unit/services/AccountLockoutService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 497[2mms[22m[39m
[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w147
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w147,public

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w148
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w148,public

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w147 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w147%2Cpublic

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w148 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w148%2Cpublic

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/BrandingService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 477[2mms[22m[39m
 [32m‚úì[39m tests/unit/repositories/DatavaultRowsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 474[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w151
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w151,public

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w151 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w151%2Cpublic

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w140
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w140,public

 [32m‚úì[39m tests/unit/services/DatavaultRowsService.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 470[2mms[22m[39m
[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w152
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w152,public

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w140 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w140%2Cpublic

{"level":30,"time":1768515503810,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w153
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w153,public

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w152 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w152%2Cpublic

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515503849,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/unit/engine/FinalBlockSnapshot.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 436[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w153 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w153%2Cpublic

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/AuditLogService.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 453[2mms[22m[39m
[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w114
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w114,public

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w114 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w114%2Cpublic

{"level":30,"time":1768515504006,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515504043,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w154
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w154,public

 [2m[90m‚Üì[39m[22m tests/unit/collab.server.test.ts [2m([22m[2m14 tests[22m[2m | [22m[33m14 skipped[39m[2m)[22m
[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w154 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w154%2Cpublic

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/DatavaultReferenceColumns.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 436[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w140, public

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w140
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w132.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w132.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515504340,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w114, public

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w114
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w140.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w140.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515504519,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515504520,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/datavault.routes.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 1140[2mms[22m[39m
{"level":30,"time":1768515504689,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts[2m > [22m[2mPersonalization API Integration Tests
[22m[39müìö API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768515504695,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768515504696,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768515504699,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768515505112,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515505112,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/api.ai.personalization.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1534[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w141
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w141,public

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w141 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w141%2Cpublic

{"level":30,"time":1768515505744,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768515505770,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w141, public

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w141
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w114.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w114.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768515506417,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768515506439,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts[2m > [22m[2mAI Document Assistant API Integration Tests
[22m[39müìö API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768515506427,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768515506428,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768515506433,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768515506439,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768515506439,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768515506439,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768515506439,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":40,"time":1768515506464,"env":"test","error":{},"msg":"Deterministic DOCX extraction failed"}
{"level":30,"time":1768515506503,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768515506503,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/api.ai.doc.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 1155[2mms[22m[39m

[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m[1m[41m Failed Suites 21 [49m[22m[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m

[41m[1m FAIL [22m[49m tests/integration/api.dataSources.native.test.ts[2m [ tests/integration/api.dataSources.native.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.expression-validation.test.ts[2m [ tests/integration/api.expression-validation.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.projects.test.ts[2m [ tests/integration/api.projects.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.runs.docx.test.ts[2m [ tests/integration/api.runs.docx.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.runs.graph.test.ts[2m [ tests/integration/api.runs.graph.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.snapshots.test.ts[2m [ tests/integration/api.snapshots.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.templates-runs.test.ts[2m [ tests/integration/api.templates-runs.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.workflows.test.ts[2m [ tests/integration/api.workflows.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/datavault-v4-regression.test.ts[2m [ tests/integration/datavault-v4-regression.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/datavault.permissions.test.ts[2m [ tests/integration/datavault.permissions.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/intake.workflow.test.ts[2m [ tests/integration/intake.workflow.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/js_helpers.test.ts[2m [ tests/integration/js_helpers.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/lifecycle-hooks-execution.test.ts[2m [ tests/integration/lifecycle-hooks-execution.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m [ tests/integration/auth/auth.middleware.integration.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/auth/jwt.authentication.test.ts[2m [ tests/integration/auth/jwt.authentication.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/auth/protected.routes.test.ts[2m [ tests/integration/auth/protected.routes.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/auth/session.management.integration.test.ts[2m [ tests/integration/auth/session.management.integration.test.ts ][22m
[31m[1mTypeError[22m: () => ({
      getGenerativeModel: __vite_ssr_import_0__.vi.fn().mockReturnValue({
        generateContent: __v...<omitted>...}) is not a constructor[39m
[36m [2m‚ùØ[22m new DocumentAIAssistService server/lib/ai/DocumentAIAssistService.ts:[2m43:26[22m[39m
    [90m 41| [39m        [35mconst[39m apiKey [33m=[39m process[33m.[39menv[33m.[39m[33mGEMINI_API_KEY[39m[33m;[39m
    [90m 42| [39m        [35mif[39m (apiKey) {
    [90m 43| [39m            [35mthis[39m[33m.[39mgenAI [33m=[39m [35mnew[39m [33mGoogleGenerativeAI[39m(apiKey)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m 44| [39m            const model = process.env.GEMINI_MODEL || "gemini-2.0-flas‚Ä¶
    [90m 45| [39m            [35mthis[39m[33m.[39mmodel [33m=[39m [35mthis[39m[33m.[39mgenAI[33m.[39m[34mgetGenerativeModel[39m({ model })[33m;[39m
[90m [2m‚ùØ[22m server/lib/ai/DocumentAIAssistService.ts:[2m258:40[22m[39m
[90m [2m‚ùØ[22m server/routes/ai.doc.routes.ts:[2m5:1[22m[39m
[90m [2m‚ùØ[22m server/routes/index.ts:[2m9:1[22m[39m
[90m [2m‚ùØ[22m server/routes.ts:[2m11:1[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[1/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, default, $7, $8, $9, default, default, $10, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: test-user-collections-e2e,test-collections-e2e@example.com,Collections E2E Test User,Collections,E2E Test User,e9f05225-0ddb-40e2-a9d4-1d8e8d5cd22a,owner,local,easy,[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m34:20[22m[39m
    [90m 32| [39m
    [90m 33| [39m    [90m// Create test user[39m
    [90m 34| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 35| [39m      id[33m:[39m [32m'test-user-collections-e2e'[39m[33m,[39m
    [90m 36| [39m      email[33m:[39m [32m'test-collections-e2e@example.com'[39m[33m,[39m

[31m[1mCaused by: error[22m: duplicate key value violates unique constraint "users_pkey"[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m34:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 204, severity: 'ERROR', code: '23505', detail: 'Key (id)=(test-user-collections-e2e) already exists.', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_pkey', file: 'nbtinsert.c', routine: '_bt_check_unique' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[2/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/workflow_versioning.test.ts[2m > [22mWorkflow Versioning & Lineage
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, default, $2, $3, default, default, default, default, default, default, default, default, default, default, default, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Versioning Test Workflow,f0fc6da1-2423-4b51-8725-9030434a08fb,f0fc6da1-2423-4b51-8725-9030434a08fb[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/workflow_versioning.test.ts:[2m48:28[22m[39m
    [90m 46| [39m
    [90m 47| [39m        [90m// Create Workflow[39m
    [90m 48| [39m        [35mconst[39m [workflow] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m                           [31m^[39m
    [90m 49| [39m
    [90m 50| [39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/workflow_versioning.test.ts:[2m48:28[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 474, severity: 'ERROR', code: '23502', detail: 'Failing row contains (8772531f-bf11-42b4-adce-274d38051a1f, Versioning Test Workflow, null, f0fc6da1-2423-4b51-8725-9030434a08fb, null, 2026-01-15 22:17:31.263562, 2026-01-15 22:17:31.263562, f0fc6da1-2423-4b51-8725-9030434a08fb, null, null, null, null, null, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[3/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/api.ai.logic.test.ts[2m [ tests/unit/api.ai.logic.test.ts ][22m
[41m[1m FAIL [22m[49m tests/unit/debug_import.test.ts[2m [ tests/unit/debug_import.test.ts ][22m
[31m[1mTypeError[22m: () => ({
      getGenerativeModel: __vite_ssr_import_0__.vi.fn().mockReturnValue({
        generateContent: __v...<omitted>...}) is not a constructor[39m
[36m [2m‚ùØ[22m new GeminiService server/services/geminiService.ts:[2m27:18[22m[39m
    [90m 25| [39m    }
    [90m 26| [39m
    [90m 27| [39m    [35mthis[39m[33m.[39mgenAI [33m=[39m [35mnew[39m [33mGoogleGenerativeAI[39m(apiKey)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m 28| [39m    // Use configurable Gemini model from env, fallback to gemini-2.0-‚Ä¶
    [90m 29| [39m    [35mconst[39m model [33m=[39m process[33m.[39menv[33m.[39m[33mGEMINI_MODEL[39m [33m||[39m [32m"gemini-2.0-flash"[39m[33m;[39m
[90m [2m‚ùØ[22m server/services/geminiService.ts:[2m299:30[22m[39m
[90m [2m‚ùØ[22m server/controllers/AiController.ts:[2m16:1[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[4/90]‚éØ[22m[39m


[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m[1m[41m Failed Tests 69 [49m[22m[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m

[41m[1m FAIL [22m[49m tests/integration/analytics_preservation.test.ts[2m > [22mAnalytics Preservation[2m > [22mshould preserve lifetime user count when a user is deleted
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')[39m
[90m [2m‚ùØ[22m getTableColumns node_modules/drizzle-orm/utils.js:[2m109:15[22m[39m
[90m [2m‚ùØ[22m PgSelectBuilder.from node_modules/drizzle-orm/pg-core/query-builders/select.js:[2m62:16[22m[39m
[36m [2m‚ùØ[22m SystemStatsRepository.getOrInitialize server/repositories/SystemStatsRepository.ts:[2m18:35[22m[39m
    [90m 16| [39m   */[39m
    [90m 17| [39m  [35masync[39m [34mgetOrInitialize[39m()[33m:[39m [33mPromise[39m[33m<[39m[33mSystemStats[39m[33m>[39m {
    [90m 18| [39m    let stats = await db.select().from(systemStats).where(eq(systemSta‚Ä¶
    [90m   | [39m                                  [31m^[39m
    [90m 19| [39m
    [90m 20| [39m    [35mif[39m (stats[33m.[39mlength [33m===[39m [34m0[39m) {
[90m [2m‚ùØ[22m SystemStatsRepository.getStats server/repositories/SystemStatsRepository.ts:[2m133:17[22m[39m
[90m [2m‚ùØ[22m tests/integration/analytics_preservation.test.ts:[2m18:58[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[5/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mComplete Registration ‚Üí Login Flow[2m > [22mshould complete registration, verify email, then login
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m97:36[22m[39m
    [90m 95| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password })[33m;[39m
    [90m 96| [39m
    [90m 97| [39m      [34mexpect[39m(loginAttempt2[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m 98| [39m      [34mexpect[39m(loginAttempt2[33m.[39mbody[33m.[39mtoken)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m 99| [39m      [34mexpect[39m(loginAttempt2[33m.[39mbody[33m.[39muser[33m.[39memailVerified)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[6/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mMFA Enrollment and Login Flow[2m > [22mshould complete MFA setup and login with TOTP
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m197:36[22m[39m
    [90m195| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m196| [39m
    [90m197| [39m      [34mexpect[39m(setupResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m198| [39m      [34mexpect[39m(setupResponse[33m.[39mbody[33m.[39mqrCodeDataUrl)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m199| [39m      [34mexpect[39m(setupResponse[33m.[39mbody[33m.[39mbackupCodes)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[7/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mMFA Enrollment and Login Flow[2m > [22mshould login with backup code when TOTP unavailable
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'secret')[39m
[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m279:52[22m[39m
    [90m277| [39m      })[33m;[39m
    [90m278| [39m
    [90m279| [39m      [35mconst[39m totpCode [33m=[39m [34mgenerateTotpCode[39m(mfaSecret[33m![39m[33m.[39msecret)[33m;[39m
    [90m   | [39m                                                   [31m^[39m
    [90m280| [39m
    [90m281| [39m      [35mawait[39m [34mrequest[39m(app)

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[8/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mPassword Reset Flow[2m > [22mshould complete full password reset flow
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m364:36[22m[39m
    [90m362| [39m        })[33m;[39m
    [90m363| [39m
    [90m364| [39m      [34mexpect[39m(resetResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m365| [39m
    [90m366| [39m      [90m// Step 4: Verify old password no longer works[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[9/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mSession Management Flow[2m > [22mshould list all active sessions
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m528:39[22m[39m
    [90m526| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m527| [39m
    [90m528| [39m      [34mexpect[39m(sessionsResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                      [31m^[39m
    [90m529| [39m      [34mexpect[39m(sessionsResponse[33m.[39mbody[33m.[39msessions)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m530| [39m      expect(sessionsResponse.body.sessions.length).toBeGreaterThanOrE‚Ä¶

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[10/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mSession Management Flow[2m > [22mshould revoke specific session
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m554:40[22m[39m
    [90m552| [39m
    [90m553| [39m      [35mconst[39m sessions [33m=[39m sessionsResponse[33m.[39mbody[33m.[39msessions[33m;[39m
    [90m554| [39m      [35mconst[39m sessionToRevoke [33m=[39m sessions[33m.[39m[34mfind[39m((s[33m:[39m any) [33m=>[39m [33m![39ms[33m.[39mcurrent)[33m;[39m
    [90m   | [39m                                       [31m^[39m
    [90m555| [39m
    [90m556| [39m      [90m// Revoke first session[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[11/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould login with valid credentials
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m171:31[22m[39m
    [90m169| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password })[33m;[39m
    [90m170| [39m
    [90m171| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m172| [39m      [34mexpect[39m((response[33m.[39mbody)[33m.[39mmessage)[33m.[39m[34mtoBe[39m([32m"Login successful"[39m)[33m;[39m
    [90m173| [39m      [34mexpect[39m((response[33m.[39mbody)[33m.[39mtoken)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[12/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/reset-password[2m > [22mshould reset password with valid token
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m439:31[22m[39m
    [90m437| [39m        })[33m;[39m
    [90m438| [39m
    [90m439| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m440| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"Password updated"[39m)[33m;[39m
    [90m441| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[13/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mGET /api/auth/me[2m > [22mshould return current user for valid token
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m500:31[22m[39m
    [90m498| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m499| [39m
    [90m500| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m501| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39memail)[33m.[39m[34mtoBe[39m(email)[33m;[39m
    [90m502| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mid)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[14/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/dataBlocks.test.ts[2m > [22mData Block Integration Tests[2m > [22mshould write data to DataVault via WriteBlock
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, default, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Write Block Workflow,5e102910-9cbd-489d-930c-9993ca141252,5e102910-9cbd-489d-930c-9993ca141252,8463b886-0715-4a4c-a920-8ddfcb286d8e[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/dataBlocks.test.ts:[2m113:28[22m[39m
    [90m111| [39m        projectId [33m=[39m project[33m.[39mid[33m;[39m
    [90m112| [39m
    [90m113| [39m        [35mconst[39m [workflow] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m                           [31m^[39m
    [90m114| [39m            projectId[33m:[39m projectId[33m,[39m
    [90m115| [39m            title[33m:[39m [32m'Write Block Workflow'[39m[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/dataBlocks.test.ts:[2m113:28[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 502, severity: 'ERROR', code: '23502', detail: 'Failing row contains (8d01a412-8948-4775-950f-584824b4dc74, Write Block Workflow, null, 5e102910-9cbd-489d-930c-9993ca141252, null, 2026-01-15 22:17:30.197524, 2026-01-15 22:17:30.197524, 5e102910-9cbd-489d-930c-9993ca141252, 8463b886-0715-4a4c-a920-8ddfcb286d8e, null, null, null, null, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[15/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/dataBlocks.test.ts[2m > [22mData Block Integration Tests[2m > [22mshould query data from DataVault via QueryBlock and use in Logic
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, default, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Query Block Workflow,5e102910-9cbd-489d-930c-9993ca141252,5e102910-9cbd-489d-930c-9993ca141252,8463b886-0715-4a4c-a920-8ddfcb286d8e[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/dataBlocks.test.ts:[2m194:28[22m[39m
    [90m192| [39m    it('should query data from DataVault via QueryBlock and use in Log‚Ä¶
    [90m193| [39m        [90m// 1. Create Workflow & Query[39m
    [90m194| [39m        [35mconst[39m [workflow] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m                           [31m^[39m
    [90m195| [39m            projectId[33m:[39m projectId[33m,[39m
    [90m196| [39m            title[33m:[39m [32m'Query Block Workflow'[39m[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/dataBlocks.test.ts:[2m194:28[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 502, severity: 'ERROR', code: '23502', detail: 'Failing row contains (00becd3b-cff0-4c75-ab02-096f90ec812e, Query Block Workflow, null, 5e102910-9cbd-489d-930c-9993ca141252, null, 2026-01-15 22:17:30.530439, 2026-01-15 22:17:30.530439, 5e102910-9cbd-489d-930c-9993ca141252, 8463b886-0715-4a4c-a920-8ddfcb286d8e, null, null, null, null, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[16/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.autonumber.test.ts[2m > [22mDataVault Autonumber Integration Tests[2m > [22mshould generate basic autonumber without prefix
[31m[1mError[22m: Failed query: SELECT datavault_get_next_autonumber(
        $1::UUID,
        $2::UUID,
        $3::UUID,
        'default'::TEXT,
        $4::INTEGER,
        $5::TEXT,
        $6::TEXT
      ) as next_value
params: 15f19932-cda8-4294-a8e2-851fe4a1a2ad,20c9ca67-238d-4554-a773-5c68062204fa,d8e1bc6d-5118-4af6-8551-a379438c8126,4,,[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
    [90m440| [39m    [90m// Call the database function with all parameters[39m
    [90m441| [39m    // SQL Signature: (tenant, table, column, context_key, min_digits,‚Ä¶
    [90m442| [39m    [35mconst[39m res [33m=[39m [35mawait[39m database[33m.[39m[34mexecute[39m(
    [90m   | [39m                [31m^[39m
    [90m443| [39m      sql[32m`SELECT datavault_get_next_autonumber(
    [90m444| [39m        [39m[36m${[39mtenantId[36m}[39m[32m::UUID,
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m101:18[22m[39m

[31m[1mCaused by: error[22m: function datavault_get_next_autonumber(uuid, uuid, uuid, text, integer, text, text) does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m101:18[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 266, severity: 'ERROR', code: '42883', detail: undefined, hint: 'No function matches the given name and argument types. You might need to add explicit type casts.', position: '8', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_func.c', routine: 'ParseFuncOrColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[17/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.autonumber.test.ts[2m > [22mDataVault Autonumber Integration Tests[2m > [22mshould generate autonumber with prefix
[31m[1mError[22m: Failed query: SELECT datavault_get_next_autonumber(
        $1::UUID,
        $2::UUID,
        $3::UUID,
        'default'::TEXT,
        $4::INTEGER,
        $5::TEXT,
        $6::TEXT
      ) as next_value
params: 15f19932-cda8-4294-a8e2-851fe4a1a2ad,20c9ca67-238d-4554-a773-5c68062204fa,d8e1bc6d-5118-4af6-8551-a379438c8126,4,,[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
    [90m440| [39m    [90m// Call the database function with all parameters[39m
    [90m441| [39m    // SQL Signature: (tenant, table, column, context_key, min_digits,‚Ä¶
    [90m442| [39m    [35mconst[39m res [33m=[39m [35mawait[39m database[33m.[39m[34mexecute[39m(
    [90m   | [39m                [31m^[39m
    [90m443| [39m      sql[32m`SELECT datavault_get_next_autonumber(
    [90m444| [39m        [39m[36m${[39mtenantId[36m}[39m[32m::UUID,
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m126:18[22m[39m

[31m[1mCaused by: error[22m: function datavault_get_next_autonumber(uuid, uuid, uuid, text, integer, text, text) does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m126:18[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 266, severity: 'ERROR', code: '42883', detail: undefined, hint: 'No function matches the given name and argument types. You might need to add explicit type casts.', position: '8', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_func.c', routine: 'ParseFuncOrColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[18/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.autonumber.test.ts[2m > [22mDataVault Autonumber Integration Tests[2m > [22mshould generate autonumber with yearly reset format
[31m[1mError[22m: Failed query: SELECT datavault_get_next_autonumber(
        $1::UUID,
        $2::UUID,
        $3::UUID,
        'default'::TEXT,
        $4::INTEGER,
        $5::TEXT,
        $6::TEXT
      ) as next_value
params: 15f19932-cda8-4294-a8e2-851fe4a1a2ad,20c9ca67-238d-4554-a773-5c68062204fa,d8e1bc6d-5118-4af6-8551-a379438c8126,4,,[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
    [90m440| [39m    [90m// Call the database function with all parameters[39m
    [90m441| [39m    // SQL Signature: (tenant, table, column, context_key, min_digits,‚Ä¶
    [90m442| [39m    [35mconst[39m res [33m=[39m [35mawait[39m database[33m.[39m[34mexecute[39m(
    [90m   | [39m                [31m^[39m
    [90m443| [39m      sql[32m`SELECT datavault_get_next_autonumber(
    [90m444| [39m        [39m[36m${[39mtenantId[36m}[39m[32m::UUID,
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m150:18[22m[39m

[31m[1mCaused by: error[22m: function datavault_get_next_autonumber(uuid, uuid, uuid, text, integer, text, text) does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m150:18[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 266, severity: 'ERROR', code: '42883', detail: undefined, hint: 'No function matches the given name and argument types. You might need to add explicit type casts.', position: '8', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_func.c', routine: 'ParseFuncOrColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[19/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.autonumber.test.ts[2m > [22mDataVault Autonumber Integration Tests[2m > [22mshould be atomic and prevent race conditions
[31m[1mError[22m: Failed query: SELECT datavault_get_next_autonumber(
        $1::UUID,
        $2::UUID,
        $3::UUID,
        'default'::TEXT,
        $4::INTEGER,
        $5::TEXT,
        $6::TEXT
      ) as next_value
params: 15f19932-cda8-4294-a8e2-851fe4a1a2ad,20c9ca67-238d-4554-a773-5c68062204fa,d8e1bc6d-5118-4af6-8551-a379438c8126,4,,[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
    [90m440| [39m    [90m// Call the database function with all parameters[39m
    [90m441| [39m    // SQL Signature: (tenant, table, column, context_key, min_digits,‚Ä¶
    [90m442| [39m    [35mconst[39m res [33m=[39m [35mawait[39m database[33m.[39m[34mexecute[39m(
    [90m   | [39m                [31m^[39m
    [90m443| [39m      sql[32m`SELECT datavault_get_next_autonumber(
    [90m444| [39m        [39m[36m${[39mtenantId[36m}[39m[32m::UUID,
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m177:18[22m[39m

[31m[1mCaused by: error[22m: function datavault_get_next_autonumber(uuid, uuid, uuid, text, integer, text, text) does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m177:18[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 266, severity: 'ERROR', code: '42883', detail: undefined, hint: 'No function matches the given name and argument types. You might need to add explicit type casts.', position: '8', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_func.c', routine: 'ParseFuncOrColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[20/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.autonumber.test.ts[2m > [22mDataVault Autonumber Integration Tests[2m > [22mshould prevent manual updates to autonumber values
[31m[1mError[22m: Failed query: SELECT datavault_get_next_autonumber(
        $1::UUID,
        $2::UUID,
        $3::UUID,
        'default'::TEXT,
        $4::INTEGER,
        $5::TEXT,
        $6::TEXT
      ) as next_value
params: 15f19932-cda8-4294-a8e2-851fe4a1a2ad,20c9ca67-238d-4554-a773-5c68062204fa,d8e1bc6d-5118-4af6-8551-a379438c8126,4,,[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
    [90m440| [39m    [90m// Call the database function with all parameters[39m
    [90m441| [39m    // SQL Signature: (tenant, table, column, context_key, min_digits,‚Ä¶
    [90m442| [39m    [35mconst[39m res [33m=[39m [35mawait[39m database[33m.[39m[34mexecute[39m(
    [90m   | [39m                [31m^[39m
    [90m443| [39m      sql[32m`SELECT datavault_get_next_autonumber(
    [90m444| [39m        [39m[36m${[39mtenantId[36m}[39m[32m::UUID,
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m189:17[22m[39m

[31m[1mCaused by: error[22m: function datavault_get_next_autonumber(uuid, uuid, uuid, text, integer, text, text) does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m189:17[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 266, severity: 'ERROR', code: '42883', detail: undefined, hint: 'No function matches the given name and argument types. You might need to add explicit type casts.', position: '8', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_func.c', routine: 'ParseFuncOrColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[21/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/externalSends.test.ts[2m > [22mExternal Send Block Integration[2m > [22mPREVIEW MODE: Should simulate send and NOT call fetch
[41m[1m FAIL [22m[49m tests/integration/externalSends.test.ts[2m > [22mExternal Send Block Integration[2m > [22mLIVE MODE: Should call fetch with mapped payload
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, default, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Send Workflow,26daed2f-9b65-47c2-a6ff-a7230878987b,26daed2f-9b65-47c2-a6ff-a7230878987b,624804aa-81b0-4a9b-9ed1-05de7bd99b49[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/externalSends.test.ts:[2m90:28[22m[39m
    [90m 88| [39m
    [90m 89| [39m        [90m// 4. Setup Workflow & Version & Section[39m
    [90m 90| [39m        [35mconst[39m [workflow] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m                           [31m^[39m
    [90m 91| [39m            projectId[33m,[39m
    [90m 92| [39m            title[33m:[39m [32m'Send Workflow'[39m[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/externalSends.test.ts:[2m90:28[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 495, severity: 'ERROR', code: '23502', detail: 'Failing row contains (76c16ff0-06de-456d-a9bb-8babce72f419, Send Workflow, null, 26daed2f-9b65-47c2-a6ff-a7230878987b, null, 2026-01-15 22:17:28.374982, 2026-01-15 22:17:28.374982, 26daed2f-9b65-47c2-a6ff-a7230878987b, 624804aa-81b0-4a9b-9ed1-05de7bd99b49, null, null, null, null, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould complete full MFA setup flow
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'mfaEnabled')[39m
[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m68:40[22m[39m
    [90m 66| [39m
    [90m 67| [39m      [35mconst[39m token [33m=[39m (loginResponse[33m.[39mbody)[33m.[39mtoken[33m;[39m
    [90m 68| [39m      [34mexpect[39m((loginResponse[33m.[39mbody)[33m.[39muser[33m.[39mmfaEnabled)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m   | [39m                                       [31m^[39m
    [90m 69| [39m
    [90m 70| [39m      [90m// Step 2: Setup MFA[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[23/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould reject invalid TOTP code during setup
[31m[1mAssertionError[22m: expected 401 to be 400 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 400[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m145:37[22m[39m
    [90m143| [39m        [33m.[39m[34msend[39m({ token[33m:[39m [32m"000000"[39m })[33m;[39m [90m// Invalid code[39m
    [90m144| [39m
    [90m145| [39m      [34mexpect[39m(verifyResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m400[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m146| [39m      [34mexpect[39m(verifyResponse[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"Invalid"[39m)[33m;[39m
    [90m147| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[24/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould generate unique backup codes
[31m[1mAssertionError[22m: expected +0 to be 10 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 10[39m
[31m+ 0[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m186:32[22m[39m
    [90m184| [39m      [90m// All codes should be unique[39m
    [90m185| [39m      [35mconst[39m uniqueCodes [33m=[39m [35mnew[39m [33mSet[39m(backupCodes)[33m;[39m
    [90m186| [39m      [34mexpect[39m(uniqueCodes[33m.[39msize)[33m.[39m[34mtoBe[39m([34m10[39m)[33m;[39m
    [90m   | [39m                               [31m^[39m
    [90m187| [39m    })[33m;[39m
    [90m188| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[25/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould store hashed backup codes
[31m[1mAssertionError[22m: expected [] to have a length of 10 but got +0[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 10[39m
[31m+ 0[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m208:27[22m[39m
    [90m206| [39m      })[33m;[39m
    [90m207| [39m
    [90m208| [39m      [34mexpect[39m(storedCodes)[33m.[39m[34mtoHaveLength[39m([34m10[39m)[33m;[39m
    [90m   | [39m                          [31m^[39m
    [90m209| [39m
    [90m210| [39m      [90m// Hashes should not match plain codes[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[26/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould login with valid backup code
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'secret')[39m
[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m341:52[22m[39m
    [90m339| [39m      })[33m;[39m
    [90m340| [39m
    [90m341| [39m      [35mconst[39m totpCode [33m=[39m [34mgenerateTotpCode[39m(mfaSecret[33m![39m[33m.[39msecret)[33m;[39m
    [90m   | [39m                                                   [31m^[39m
    [90m342| [39m
    [90m343| [39m      [35mawait[39m [34mrequest[39m(app)

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[27/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould prevent backup code reuse
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'secret')[39m
[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m413:52[22m[39m
    [90m411| [39m      })[33m;[39m
    [90m412| [39m
    [90m413| [39m      [35mconst[39m totpCode [33m=[39m [34mgenerateTotpCode[39m(mfaSecret[33m![39m[33m.[39msecret)[33m;[39m
    [90m   | [39m                                                   [31m^[39m
    [90m414| [39m
    [90m415| [39m      [35mawait[39m [34mrequest[39m(app)

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[28/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Status[2m > [22mshould return MFA status for user
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m486:37[22m[39m
    [90m484| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mloginResponse[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m485| [39m
    [90m486| [39m      [34mexpect[39m(statusResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m487| [39m      [34mexpect[39m(statusResponse[33m.[39mbody[33m.[39mmfaEnabled)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m488| [39m      [34mexpect[39m(statusResponse[33m.[39mbody[33m.[39mbackupCodesRemaining)[33m.[39m[34mtoBe[39m([34m0[39m)[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[29/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Disable Flow[2m > [22mshould disable MFA with password verification
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m552:38[22m[39m
    [90m550| [39m        [33m.[39m[34msend[39m({ password })[33m;[39m
    [90m551| [39m
    [90m552| [39m      [34mexpect[39m(disableResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                     [31m^[39m
    [90m553| [39m
    [90m554| [39m      [90m// Verify MFA is disabled[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[30/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Regeneration[2m > [22mshould return error if MFA not enabled
[31m[1mAssertionError[22m: expected 401 to be 400 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 400[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m657:31[22m[39m
    [90m655| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mloginResponse[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m656| [39m
    [90m657| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m400[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m658| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"not enabled"[39m)[33m;[39m
    [90m659| [39m    })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[31/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m1. Required + Show/Hide (Questions)[2m > [22mshould block Next when required visible question is empty
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 031a8a99-2e60-40db-96b9-59f88e7733bd,Required Question Test,f9404e37-6c64-452b-a961-19190d6688eb,f9404e37-6c64-452b-a961-19190d6688eb,068eefdb-bac3-4824-b1ab-3a491b6b39a0,534f1a7e-9386-410c-9618-9ee8ca0318dc[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m
    [90m 98| [39m            workflowVersionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 99| [39m
    [90m100| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m101| [39m                id[33m:[39m workflowId[33m,[39m
    [90m102| [39m                projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 536, severity: 'ERROR', code: '23502', detail: 'Failing row contains (031a8a99-2e60-40db-96b9-59f88e7733bd, Required Question Test, null, f9404e37-6c64-452b-a961-19190d6688eb, null, 2026-01-15 22:17:26.869389, 2026-01-15 22:17:26.869389, f9404e37-6c64-452b-a961-19190d6688eb, 068eefdb-bac3-4824-b1ab-3a491b6b39a0, null, null, null, 534f1a7e-9386-410c-9618-9ee8ca0318dc, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[32/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m1. Required + Show/Hide (Questions)[2m > [22mshould NOT block Next when required question is hidden
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 69ef9906-b701-424d-9aac-87c4399d53a3,Required Question Test,f9404e37-6c64-452b-a961-19190d6688eb,f9404e37-6c64-452b-a961-19190d6688eb,068eefdb-bac3-4824-b1ab-3a491b6b39a0,31f61e55-4315-4df2-bae3-3e83533a79fa[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m
    [90m 98| [39m            workflowVersionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 99| [39m
    [90m100| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m101| [39m                id[33m:[39m workflowId[33m,[39m
    [90m102| [39m                projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 536, severity: 'ERROR', code: '23502', detail: 'Failing row contains (69ef9906-b701-424d-9aac-87c4399d53a3, Required Question Test, null, f9404e37-6c64-452b-a961-19190d6688eb, null, 2026-01-15 22:17:27.210566, 2026-01-15 22:17:27.210566, f9404e37-6c64-452b-a961-19190d6688eb, 068eefdb-bac3-4824-b1ab-3a491b6b39a0, null, null, null, 31f61e55-4315-4df2-bae3-3e83533a79fa, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[33/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m1. Required + Show/Hide (Questions)[2m > [22mshould block when required becomes visible and is empty
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 05d4b9ba-609b-4cc3-9ecf-04088adc47f3,Required Question Test,f9404e37-6c64-452b-a961-19190d6688eb,f9404e37-6c64-452b-a961-19190d6688eb,068eefdb-bac3-4824-b1ab-3a491b6b39a0,f98a8d96-6262-4ecb-aea0-618afbec8bfd[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m
    [90m 98| [39m            workflowVersionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 99| [39m
    [90m100| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m101| [39m                id[33m:[39m workflowId[33m,[39m
    [90m102| [39m                projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 536, severity: 'ERROR', code: '23502', detail: 'Failing row contains (05d4b9ba-609b-4cc3-9ecf-04088adc47f3, Required Question Test, null, f9404e37-6c64-452b-a961-19190d6688eb, null, 2026-01-15 22:17:27.561801, 2026-01-15 22:17:27.561801, f9404e37-6c64-452b-a961-19190d6688eb, 068eefdb-bac3-4824-b1ab-3a491b6b39a0, null, null, null, f98a8d96-6262-4ecb-aea0-618afbec8bfd, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[34/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m2. Required + Show/Hide (Pages)[2m > [22mshould skip hidden required page entirely
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 1f4bb879-cddf-4762-b8ae-0fae4d7b26d4,Page Visibility Test,f9404e37-6c64-452b-a961-19190d6688eb,f9404e37-6c64-452b-a961-19190d6688eb,068eefdb-bac3-4824-b1ab-3a491b6b39a0,6e469af8-afe7-4f44-b651-826719c3713a[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m272:13[22m[39m
    [90m270| [39m            workflowVersionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m271| [39m
    [90m272| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m273| [39m                id[33m:[39m workflowId[33m,[39m
    [90m274| [39m                projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m272:13[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 534, severity: 'ERROR', code: '23502', detail: 'Failing row contains (1f4bb879-cddf-4762-b8ae-0fae4d7b26d4, Page Visibility Test, null, f9404e37-6c64-452b-a961-19190d6688eb, null, 2026-01-15 22:17:27.895308, 2026-01-15 22:17:27.895308, f9404e37-6c64-452b-a961-19190d6688eb, 068eefdb-bac3-4824-b1ab-3a491b6b39a0, null, null, null, 6e469af8-afe7-4f44-b651-826719c3713a, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[35/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m2. Required + Show/Hide (Pages)[2m > [22mshould enforce required on visible page
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: d7753656-73a0-4aee-9c8d-2f97fa3574c0,Page Required Test,f9404e37-6c64-452b-a961-19190d6688eb,f9404e37-6c64-452b-a961-19190d6688eb,068eefdb-bac3-4824-b1ab-3a491b6b39a0,801f9edd-ef7f-4326-928b-326962236634[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m357:13[22m[39m
    [90m355| [39m            workflowVersionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m356| [39m
    [90m357| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m358| [39m                id[33m:[39m workflowId[33m,[39m
    [90m359| [39m                projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m357:13[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 532, severity: 'ERROR', code: '23502', detail: 'Failing row contains (d7753656-73a0-4aee-9c8d-2f97fa3574c0, Page Required Test, null, f9404e37-6c64-452b-a961-19190d6688eb, null, 2026-01-15 22:17:28.236967, 2026-01-15 22:17:28.236967, f9404e37-6c64-452b-a961-19190d6688eb, 068eefdb-bac3-4824-b1ab-3a491b6b39a0, null, null, null, 801f9edd-ef7f-4326-928b-326962236634, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[36/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould list all active sessions for current user
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m86:31[22m[39m
    [90m 84| [39m        [33m.[39m[35mset[39m([32m"Cookie"[39m[33m,[39m cookie[33m![39m)[33m;[39m
    [90m 85| [39m
    [90m 86| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m 87| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39msessions)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m 88| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39msessions[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m3[39m)[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[37/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould mark current session correctly
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'filter')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m128:40[22m[39m
    [90m126| [39m
    [90m127| [39m      [35mconst[39m sessions [33m=[39m response[33m.[39mbody[33m.[39msessions[33m;[39m
    [90m128| [39m      [35mconst[39m currentSessions [33m=[39m sessions[33m.[39m[34mfilter[39m((s[33m:[39m any) [33m=>[39m s[33m.[39mcurrent)[33m;[39m
    [90m   | [39m                                       [31m^[39m
    [90m129| [39m
    [90m130| [39m      [90m// Only one should be current[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[38/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould exclude revoked sessions
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'length')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m163:37[22m[39m
    [90m161| [39m
    [90m162| [39m      [90m// Should only show 1 session (non-revoked)[39m
    [90m163| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39msessions[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m1[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m164| [39m    })[33m;[39m
    [90m165| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould order sessions by last used (most recent first)
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'length')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m190:36[22m[39m
    [90m188| [39m
    [90m189| [39m      [90m// Should be ordered by lastUsedAt descending[39m
    [90m190| [39m      [35mfor[39m ([35mlet[39m i [33m=[39m [34m1[39m[33m;[39m i [33m<[39m sessions[33m.[39mlength[33m;[39m i[33m++[39m) {
    [90m   | [39m                                   [31m^[39m
    [90m191| [39m        [35mconst[39m prev [33m=[39m [35mnew[39m [33mDate[39m(sessions[i [33m-[39m [34m1[39m][33m.[39mlastUsedAt)[33m;[39m
    [90m192| [39m        [35mconst[39m curr [33m=[39m [35mnew[39m [33mDate[39m(sessions[i][33m.[39mlastUsedAt)[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[40/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould filter sessions by current user only
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'length')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m222:37[22m[39m
    [90m220| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39muser1Login[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m221| [39m
    [90m222| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39msessions[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m2[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m223| [39m    })[33m;[39m
    [90m224| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[41/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould revoke specific session
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m254:40[22m[39m
    [90m252| [39m
    [90m253| [39m      [35mconst[39m sessions [33m=[39m sessionsResponse[33m.[39mbody[33m.[39msessions[33m;[39m
    [90m254| [39m      [35mconst[39m sessionToRevoke [33m=[39m sessions[33m.[39m[34mfind[39m((s[33m:[39m any) [33m=>[39m [33m![39ms[33m.[39mcurrent)[33m;[39m
    [90m   | [39m                                       [31m^[39m
    [90m255| [39m
    [90m256| [39m      [90m// Revoke non-current session[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[42/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould prevent revoking current session
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m297:61[22m[39m
    [90m295| [39m        [33m.[39m[35mset[39m([32m"Cookie"[39m[33m,[39m cookie[33m![39m)[33m;[39m
    [90m296| [39m
    [90m297| [39m      [35mconst[39m currentSession [33m=[39m sessionsResponse[33m.[39mbody[33m.[39msessions[33m.[39m[34mfind[39m(
    [90m   | [39m                                                            [31m^[39m
    [90m298| [39m        (s[33m:[39m any) [33m=>[39m s[33m.[39mcurrent
    [90m299| [39m      )[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[43/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould return 404 for non-existent session
[31m[1mAssertionError[22m: expected 401 to be 404 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 404[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m323:31[22m[39m
    [90m321| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mlogin[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m322| [39m
    [90m323| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m404[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m324| [39m    })[33m;[39m
    [90m325| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[44/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould prevent revoking other user's session
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m347:49[22m[39m
    [90m345| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39muser1Login[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m346| [39m
    [90m347| [39m      [35mconst[39m user1SessionId [33m=[39m user1Sessions[33m.[39mbody[33m.[39msessions[[34m0[39m][33m.[39mid[33m;[39m
    [90m   | [39m                                                [31m^[39m
    [90m348| [39m
    [90m349| [39m      [90m// Try to revoke user 1's session as user 2[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[45/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould revoke all other sessions
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m382:31[22m[39m
    [90m380| [39m        [33m.[39m[35mset[39m([32m"Cookie"[39m[33m,[39m cookie[33m![39m)[33m;[39m
    [90m381| [39m
    [90m382| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m383| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"all other devices"[39m)[33m;[39m
    [90m384| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[46/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould keep current session active
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m419:33[22m[39m
    [90m417| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m418| [39m
    [90m419| [39m      [34mexpect[39m(meResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                [31m^[39m
    [90m420| [39m
    [90m421| [39m      [90m// Should be able to refresh with current token[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[47/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould return 400 if no active session found
[31m[1mAssertionError[22m: expected 401 to be 400 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 400[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m444:31[22m[39m
    [90m442| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m443| [39m
    [90m444| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m400[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m445| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"No active session"[39m)[33m;[39m
    [90m446| [39m    })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[48/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould handle user with single session gracefully
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m498:31[22m[39m
    [90m496| [39m        [33m.[39m[35mset[39m([32m"Cookie"[39m[33m,[39m cookie[33m![39m)[33m;[39m
    [90m497| [39m
    [90m498| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m499| [39m
    [90m500| [39m      [90m// Current session should still exist[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[49/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould include device metadata in sessions
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m526:37[22m[39m
    [90m524| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m525| [39m
    [90m526| [39m      [35mconst[39m session [33m=[39m response[33m.[39mbody[33m.[39msessions[[34m0[39m][33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m527| [39m
    [90m528| [39m      [34mexpect[39m(session[33m.[39mdeviceName)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[50/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould not expose sensitive token data
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m544:37[22m[39m
    [90m542| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mlogin[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m543| [39m
    [90m544| [39m      [35mconst[39m session [33m=[39m response[33m.[39mbody[33m.[39msessions[[34m0[39m][33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m545| [39m
    [90m546| [39m      [90m// Should NOT include token hash or metadata[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[51/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould track session activity timestamps
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m563:37[22m[39m
    [90m561| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mlogin[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m562| [39m
    [90m563| [39m      [35mconst[39m session [33m=[39m response[33m.[39mbody[33m.[39msessions[[34m0[39m][33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m564| [39m
    [90m565| [39m      [34mexpect[39m(session[33m.[39mcreatedAt)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[52/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDevice Trust with MFA Login[2m > [22mshould skip MFA for trusted device
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m491:42[22m[39m
    [90m489| [39m
    [90m490| [39m      [90m// Should not require MFA[39m
    [90m491| [39m      [34mexpect[39m(secondLoginResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                         [31m^[39m
    [90m492| [39m      [34mexpect[39m(secondLoginResponse[33m.[39mbody[33m.[39mrequiresMfa)[33m.[39m[34mtoBeUndefined[39m()[33m;[39m
    [90m493| [39m      [34mexpect[39m(secondLoginResponse[33m.[39mbody[33m.[39mtoken)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[53/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mREPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: aeb11bbd-7920-4d8b-ac53-9cb3fe2d4438,Safety Workflow,ce1146c5-e7b1-444c-afe0-ce52a61bc8e1,ce1146c5-e7b1-444c-afe0-ce52a61bc8e1,21fd30ce-c711-40e4-b1aa-8fd434458b20,43ce1ea7-d8b5-4692-8bf4-e9d45cb01220[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m
    [90m 73| [39m        workflowId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 74| [39m        versionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 75| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(workflowsSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 76| [39m            id[33m:[39m workflowId[33m,[39m
    [90m 77| [39m            projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 529, severity: 'ERROR', code: '23502', detail: 'Failing row contains (aeb11bbd-7920-4d8b-ac53-9cb3fe2d4438, Safety Workflow, null, ce1146c5-e7b1-444c-afe0-ce52a61bc8e1, null, 2026-01-15 22:17:27.441061, 2026-01-15 22:17:27.441061, ce1146c5-e7b1-444c-afe0-ce52a61bc8e1, 21fd30ce-c711-40e4-b1aa-8fd434458b20, null, null, null, 43ce1ea7-d8b5-4692-8bf4-e9d45cb01220, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[54/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mScriptEngine resolves alias 'input_variable' when aliasMap is provided
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 98aa0cd7-a13a-40ab-a36a-53467ec7547f,Safety Workflow,724d3083-a952-497b-b59b-c7f52f97559d,724d3083-a952-497b-b59b-c7f52f97559d,7ac1b488-426d-47a7-971c-7797cd6de214,fce5a552-f8ab-4b4b-9229-0fc7e9f18bc7[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m
    [90m 73| [39m        workflowId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 74| [39m        versionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 75| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(workflowsSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 76| [39m            id[33m:[39m workflowId[33m,[39m
    [90m 77| [39m            projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 529, severity: 'ERROR', code: '23502', detail: 'Failing row contains (98aa0cd7-a13a-40ab-a36a-53467ec7547f, Safety Workflow, null, 724d3083-a952-497b-b59b-c7f52f97559d, null, 2026-01-15 22:17:27.933757, 2026-01-15 22:17:27.933757, 724d3083-a952-497b-b59b-c7f52f97559d, 7ac1b488-426d-47a7-971c-7797cd6de214, null, null, null, fce5a552-f8ab-4b4b-9229-0fc7e9f18bc7, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[55/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mREPRO: BlockRunner fails to resolve alias in CreateRecordConfig
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: a7ace110-b475-41b2-8bb1-4e6a9ac1dea0,Safety Workflow,bf930a90-bc57-42df-8854-7c550b6cb058,bf930a90-bc57-42df-8854-7c550b6cb058,2bd99803-428b-41ac-aece-dd2c77684622,c2d9d107-2d42-420d-a7b4-cbbc5d2b6b0d[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m
    [90m 73| [39m        workflowId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 74| [39m        versionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 75| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(workflowsSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 76| [39m            id[33m:[39m workflowId[33m,[39m
    [90m 77| [39m            projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 529, severity: 'ERROR', code: '23502', detail: 'Failing row contains (a7ace110-b475-41b2-8bb1-4e6a9ac1dea0, Safety Workflow, null, bf930a90-bc57-42df-8854-7c550b6cb058, null, 2026-01-15 22:17:28.420708, 2026-01-15 22:17:28.420708, bf930a90-bc57-42df-8854-7c550b6cb058, 2bd99803-428b-41ac-aece-dd2c77684622, null, null, null, c2d9d107-2d42-420d-a7b4-cbbc5d2b6b0d, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[56/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mBlockRunner logic resolves alias with aliasMap
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 1dcf91ca-d53e-46bb-93d2-2989690062da,Safety Workflow,151a3be7-1fbd-46d5-b7bc-1f886854ba8d,151a3be7-1fbd-46d5-b7bc-1f886854ba8d,ce0beef8-6872-4164-866f-8032b61a284e,747227df-3378-4ab5-b443-6c71b268622a[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m
    [90m 73| [39m        workflowId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 74| [39m        versionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 75| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(workflowsSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 76| [39m            id[33m:[39m workflowId[33m,[39m
    [90m 77| [39m            projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 529, severity: 'ERROR', code: '23502', detail: 'Failing row contains (1dcf91ca-d53e-46bb-93d2-2989690062da, Safety Workflow, null, 151a3be7-1fbd-46d5-b7bc-1f886854ba8d, null, 2026-01-15 22:17:28.914158, 2026-01-15 22:17:28.914158, 151a3be7-1fbd-46d5-b7bc-1f886854ba8d, ce0beef8-6872-4164-866f-8032b61a284e, null, null, null, 747227df-3378-4ab5-b443-6c71b268622a, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[57/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould create draft version on successful AI edit
[31m[1mError[22m: expected 200 "OK", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m183:8[22m[39m
    [90m181| [39m      })
    [90m182| [39m
    [90m183| [39m      [33m.[39m[34mexpect[39m([34m200[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m184| [39m
    [90m185| [39m    [34mexpect[39m(response[33m.[39mbody[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[58/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould enforce draft mode (revert active workflow to draft)
[31m[1mError[22m: expected 200 "OK", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m223:8[22m[39m
    [90m221| [39m        userMessage[33m:[39m [32m'Add a phone number field'[39m[33m,[39m
    [90m222| [39m      })
    [90m223| [39m      [33m.[39m[34mexpect[39m([34m200[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m224| [39m
    [90m225| [39m    [90m// Verify workflow is now draft[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[59/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould not create version when no changes detected (checksum match)
[31m[1mError[22m: expected 200 "OK", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m240:8[22m[39m
    [90m238| [39m        userMessage[33m:[39m [32m'Add contact section'[39m[33m,[39m
    [90m239| [39m      })
    [90m240| [39m      [33m.[39m[34mexpect[39m([34m200[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m241| [39m
    [90m242| [39m    [35mconst[39m versionId1 [33m=[39m response1[33m.[39mbody[33m.[39mdata[33m.[39mversionId[33m;[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[60/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould reject unsafe DataVault operations
[31m[1mError[22m: expected 400 "Bad Request", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m323:8[22m[39m
    [90m321| [39m        userMessage[33m:[39m [32m'Delete all data'[39m[33m,[39m
    [90m322| [39m      })
    [90m323| [39m      [33m.[39m[34mexpect[39m([34m400[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m324| [39m
    [90m325| [39m    [34mexpect[39m(response[33m.[39mbody[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[61/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould handle multi-operation edits with tempId resolution
[31m[1mError[22m: expected 200 "OK", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m394:8[22m[39m
    [90m392| [39m        userMessage: 'Add emergency contact section with name and phon‚Ä¶
    [90m393| [39m      })
    [90m394| [39m      [33m.[39m[34mexpect[39m([34m200[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m395| [39m
    [90m396| [39m    [34mexpect[39m(response[33m.[39mbody[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[62/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould create BEFORE and AFTER snapshots
[31m[1mError[22m: expected 200 "OK", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m431:8[22m[39m
    [90m429| [39m        userMessage[33m:[39m [32m'Add a simple field'[39m[33m,[39m
    [90m430| [39m      })
    [90m431| [39m      [33m.[39m[34mexpect[39m([34m200[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m432| [39m
    [90m433| [39m    [35mconst[39m versionId [33m=[39m response[33m.[39mbody[33m.[39mdata[33m.[39mversionId[33m;[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[63/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould rollback on validation failure
[31m[1mError[22m: expected 400 "Bad Request", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m500:8[22m[39m
    [90m498| [39m        userMessage[33m:[39m [32m'Add backup email field'[39m[33m,[39m
    [90m499| [39m      })
    [90m500| [39m      [33m.[39m[34mexpect[39m([34m400[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m501| [39m
    [90m502| [39m    [34mexpect[39m(response[33m.[39mbody[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[64/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Authorization Flow Initiation[2m > [22mshould initiate OAuth2 3-legged flow and generate authorization URL
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth/oauth2.callback.test.ts:[2m125:37[22m[39m
    [90m123| [39m        })[33m;[39m
    [90m124| [39m
    [90m125| [39m      [34mexpect[39m(createResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m126| [39m      testConnectionId [33m=[39m createResponse[33m.[39mbody[33m.[39mid[33m;[39m
    [90m127| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[65/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Connection Status[2m > [22mshould track OAuth2 connection status
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth/oauth2.callback.test.ts:[2m309:37[22m[39m
    [90m307| [39m        })[33m;[39m
    [90m308| [39m
    [90m309| [39m      [34mexpect[39m(createResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m310| [39m      [35mconst[39m connectionId [33m=[39m createResponse[33m.[39mbody[33m.[39mid[33m;[39m
    [90m311| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[66/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould successfully authenticate with valid Google ID token
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/auth/oauth2.google.test.ts:[2m91:31[22m[39m
    [90m 89| [39m
    [90m 90| [39m      [90m// Verify response[39m
    [90m 91| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m 92| [39m      [34mexpect[39m(response[33m.[39mbody)[33m.[39m[34mtoMatchObject[39m({
    [90m 93| [39m        message[33m:[39m [32m'Authentication successful'[39m[33m,[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[67/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould revoke all sessions except current
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m326:31[22m[39m
    [90m324| [39m        [33m.[39m[35mset[39m([32m'Cookie'[39m[33m,[39m [32m`refresh_token=[39m[36m${[39mcurrentToken[36m}[39m[32m`[39m)[33m;[39m
    [90m325| [39m
    [90m326| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m327| [39m      expect(response.body.message).toBe('Logged out from all other de‚Ä¶
    [90m328| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[68/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould revoke all trusted devices
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m368:31[22m[39m
    [90m366| [39m        [33m.[39m[35mset[39m([32m'Cookie'[39m[33m,[39m [32m`refresh_token=[39m[36m${[39mcurrentToken[36m}[39m[32m`[39m)[33m;[39m
    [90m367| [39m
    [90m368| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m369| [39m
    [90m370| [39m      [90m// Verify all trusted devices are revoked[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[69/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould create refresh token on login
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m322:31[22m[39m
    [90m320| [39m        })[33m;[39m
    [90m321| [39m
    [90m322| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m323| [39m
    [90m324| [39m      [90m// Verify refresh token cookie is set[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[70/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowPatchService.test.ts[2m > [22mWorkflowPatchService[2m > [22mOperation Application[2m > [22mshould clear tempId mappings between batch calls
[31m[1mError[22m: Invalid section ID: temp-section-1[39m
[36m [2m‚ùØ[22m Object.<anonymous> tests/unit/services/WorkflowPatchService.test.ts:[2m599:17[22m[39m
    [90m597| [39m      mockStepRepoCreate[33m.[39m[34mmockImplementation[39m([35masync[39m (data[33m:[39m any) [33m=>[39m {
    [90m598| [39m        [35mif[39m (data[33m.[39msectionId[33m?.[39m[34mstartsWith[39m([32m'temp-'[39m)) {
    [90m599| [39m          [35mthrow[39m [35mnew[39m [33mError[39m([32m`Invalid section ID: [39m[36m${[39mdata[33m.[39msectionId[36m}[39m[32m`[39m)[33m;[39m
    [90m   | [39m                [31m^[39m
    [90m600| [39m        }
    [90m601| [39m        [35mreturn[39m { id[33m:[39m [32m'step-1'[39m }[33m;[39m
[90m [2m‚ùØ[22m WorkflowPatchService.applyOp server/services/WorkflowPatchService.ts:[2m255:48[22m[39m
[90m [2m‚ùØ[22m WorkflowPatchService.applyOps server/services/WorkflowPatchService.ts:[2m134:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowPatchService.test.ts:[2m619:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[71/90]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowPatchService.test.ts[2m > [22mWorkflowPatchService[2m > [22mDocument Operations[2m > [22mshould reject binding to non-existent step alias
[31m[1mError[22m: Step alias 'nonExistentAlias' not found in workflow. Please create the step first.[39m
[36m [2m‚ùØ[22m WorkflowPatchService.applyOp server/services/WorkflowPatchService.ts:[2m487:19[22m[39m
    [90m485| [39m        [35mfor[39m ([35mconst[39m stepAlias [35mof[39m [33mObject[39m[33m.[39m[34mvalues[39m(op[33m.[39mbindings)) {
    [90m486| [39m          [35mif[39m ([33m![39mvalidAliases[33m.[39m[34mhas[39m(stepAlias)) {
    [90m487| [39m            [35mthrow[39m [35mnew[39m [33mError[39m(
    [90m   | [39m                  [31m^[39m
    [90m488| [39m              `Step alias '${stepAlias}' not found in workflow. Please‚Ä¶
    [90m489| [39m            )[33m;[39m
[90m [2m‚ùØ[22m WorkflowPatchService.applyOps server/services/WorkflowPatchService.ts:[2m134:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowPatchService.test.ts:[2m872:22[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[72/90]‚éØ[22m[39m


[2m Test Files [22m [1m[31m38 failed[39m[22m[2m | [22m[1m[32m117 passed[39m[22m[2m | [22m[33m1 skipped[39m[90m (156)[39m
[2m      Tests [22m [1m[31m69 failed[39m[22m[2m | [22m[1m[32m2270 passed[39m[22m[2m | [22m[33m43 skipped[39m[90m (2382)[39m
[2m   Start at [22m 16:17:21
[2m   Duration [22m 71.72s[2m (transform 28.10s, setup 18.78s, import 148.69s, tests 627.90s, environment 19.07s)[22m

