npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

> ezbuildr@1.0.0 test
> cross-env VITEST_INTEGRATION=true vitest run --coverage tests/integration/auth/ --reporter=verbose


[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m
      [2mCoverage enabled with [22m[33mv8[39m

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w8
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w8,public

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w8 (Reused: true)

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mðŸ“Š Schema test_schema_w8 has 0 tables - running migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w8%2Cpublic

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768539383816,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768539383868,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w8, public

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w8
ðŸ”„ Running test migrations (manual file mode due to broken journal)...

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w1
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w1,public

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w2
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w2,public

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w1 (Reused: true)

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w2 (Reused: true)

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mðŸ“Š Schema test_schema_w1 has 0 tables - running migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w1%2Cpublic

{"level":30,"time":1768539385004,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mðŸ“Š Schema test_schema_w2 has 0 tables - running migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w2%2Cpublic

{"level":30,"time":1768539385038,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768539385056,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768539385091,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768539385292,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768539385292,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstderr[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstderr[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstderr[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstderr[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w1, public

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w1
ðŸ”„ Running test migrations (manual file mode due to broken journal)...

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâœ… Applied 2 migration files.

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w2, public

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w0.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w0.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w2
ðŸ”„ Running test migrations (manual file mode due to broken journal)...

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

{"level":50,"time":1768539385756,"env":"test","status":401,"statusText":"Unauthorized","error":"Invalid client credentials","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w7
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w7,public

{"level":50,"time":1768539385757,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768539385759,"env":"test","data":{"token_type":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768539385759,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768539385760,"env":"test","data":{"access_token":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768539385760,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768539385761,"env":"test","error":"Network error: ECONNREFUSED","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w0
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0,public

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w7 (Reused: true)

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w0 (Reused: true)

 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mToken Fetching[2m > [22mshould fetch OAuth2 access token with client credentials[32m 7[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mToken Fetching[2m > [22mshould handle token request without scope[32m 0[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mToken Fetching[2m > [22mshould throw error when token request fails[32m 3[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mToken Fetching[2m > [22mshould throw error when access_token is missing from response[32m 1[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mToken Fetching[2m > [22mshould throw error when token_type is missing from response[32m 1[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mToken Fetching[2m > [22mshould default expires_in to 3600 when not provided[32m 0[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mToken Fetching[2m > [22mshould handle network errors gracefully[32m 1[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mToken Caching[2m > [22mshould cache OAuth2 tokens to avoid redundant requests[32m 1[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mToken Caching[2m > [22mshould use different cache keys for different configs[32m 0[2mms[22m[39m
{"level":50,"time":1768539385865,"env":"test","error":"Invalid credentials","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":50,"time":1768539385865,"env":"test","error":"ECONNREFUSED","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768539385867,"env":"test","status":400,"statusText":"Bad Request","error":"Invalid grant_type","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768539385867,"env":"test","error":"OAuth2 token request failed: 400 Bad Request","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768539385867,"env":"test","status":401,"statusText":"Unauthorized","error":"Client authentication failed","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768539385867,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768539385867,"env":"test","status":403,"statusText":"Forbidden","error":"Access denied","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768539385867,"env":"test","error":"OAuth2 token request failed: 403 Forbidden","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768539385868,"env":"test","status":500,"statusText":"Internal Server Error","error":"Server error","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768539385868,"env":"test","error":"OAuth2 token request failed: 500 Internal Server Error","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768539385868,"env":"test","error":"Unexpected token in JSON","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768539385868,"env":"test","error":"Request timeout","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":30,"time":1768539385869,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768539385870,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mToken Caching[2m > [22mshould refresh token when cache expires[32m 100[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mToken Caching[2m > [22mshould return cached token with remaining lifetime[32m 1[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mToken Caching[2m > [22mshould invalidate specific cached token[32m 0[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mToken Caching[2m > [22mshould clear all cached tokens[32m 0[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mToken Caching[2m > [22mshould respect 30-second expiry buffer[32m 0[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mCredential Testing[2m > [22mshould return true for valid credentials[32m 0[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mCredential Testing[2m > [22mshould return false for invalid credentials[32m 0[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mCredential Testing[2m > [22mshould return false when token URL is unreachable[32m 0[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mCache Key Generation[2m > [22mshould generate unique cache keys for different tenants[32m 0[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mCache Key Generation[2m > [22mshould generate unique cache keys for different projects[32m 0[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mCache Key Generation[2m > [22mshould generate unique cache keys for different scopes[32m 0[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mCache Key Generation[2m > [22mshould use same cache key for identical configs[32m 0[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mError Handling[2m > [22mshould handle 400 Bad Request[32m 0[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mError Handling[2m > [22mshould handle 401 Unauthorized[32m 0[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mError Handling[2m > [22mshould handle 403 Forbidden[32m 0[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mError Handling[2m > [22mshould handle 500 Internal Server Error[32m 0[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mError Handling[2m > [22mshould handle malformed JSON response[32m 0[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mError Handling[2m > [22mshould handle timeout errors[32m 0[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mScope Handling[2m > [22mshould include scope in token request when provided[32m 0[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts[2m > [22mOAuth2 Client Credentials Flow[2m > [22mScope Handling[2m > [22mshould handle space-separated scopes[32m 0[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mðŸ“Š Schema test_schema_w0 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0%2Cpublic

{"level":30,"time":1768539386239,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mðŸ“Š Schema test_schema_w7 has 0 tables - running migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w7%2Cpublic

{"level":30,"time":1768539386243,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768539386274,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768539386283,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w0, public

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w7, public

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâœ… Applied 2 migration files.

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w0
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w8.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w8.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w7
ðŸ”„ Running test migrations (manual file mode due to broken journal)...

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m   Applying 0000_mushy_thing.sql...

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w8.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w8.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâœ… Applied 2 migration files.

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w1.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w1.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768539387233,"env":"test","module":"auth","err":{"type":"TypeError","message":"Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')","stack":"TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')\n    at getTableColumns (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/utils.js:109:15)\n    at PgSelectBuilder.from (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/query-builders/select.js:62:16)\n    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)\n    at SystemStatsRepository.incrementUsersCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:103:16)\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:95:37)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"userId":"google-user-123","msg":"Failed to upsert user during authentication"}
{"level":50,"time":1768539387235,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
 [31mÃ—[39m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould successfully authenticate with valid Google ID token[32m 260[2mms[22m[39m
[31m   â†’ expected 401 to be 200 // Object.is equality[39m
 [32mâœ“[39m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould return 400 when ID token is missing[32m 75[2mms[22m[39m
{"level":30,"time":1768539387383,"env":"test","module":"user-credentials-repository","userId":"ATOhKWX9ddQdlPTt7NR9s","msg":"User credentials created"}
{"level":50,"time":1768539387384,"env":"test","error":{},"msg":"Failed to create connection:"}
{"level":50,"time":1768539387420,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":50,"time":1768539387421,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google authentication failed"}
 [32mâœ“[39m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould return 403 when Origin header is invalid[32m 48[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould return 401 when Google token verification fails[32m 49[2mms[22m[39m
{"level":30,"time":1768539387472,"env":"test","module":"auth-service","tokenHash":"a9fb7358bb9924256d77386cc6931625825f8daed6af49961e4651cf70c5125f","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768539387473,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768539387473,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google token verification failed"}
{"level":50,"time":1768539387474,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google authentication failed"}
 [31mÃ—[39m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Authorization Flow Initiation[2m > [22mshould initiate OAuth2 3-legged flow and generate authorization URL[32m 144[2mms[22m[39m
[31m   â†’ expected 500 to be 201 // Object.is equality[39m
 [32mâœ“[39m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould return 401 when email is not verified by Google[32m 53[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Authorization Flow Initiation[2m > [22mshould include optional scope in authorization URL[32m 95[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 State Validation[2m > [22mshould validate valid OAuth2 state token[32m 94[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 State Validation[2m > [22mshould reject invalid OAuth2 state token[32m 95[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould refresh access token with valid refresh token[33m 645[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m   Applying 0001_fix_collection_schema.sql...

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâœ… Applied 2 migration files.

 [32mâœ“[39m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 State Validation[2m > [22mshould reject expired OAuth2 state token[32m 94[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 State Validation[2m > [22mshould clean up OAuth2 state after use[32m 92[2mms[22m[39m
{"level":30,"time":1768539387907,"env":"test","module":"auth","email":"existing@example.com","msg":"OAuth2 login successful"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w0.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w2.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w0.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w2.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768539388027,"env":"test","module":"user-credentials-repository","userId":"zoI7AwzsPwPBQVE1xDSqC","msg":"User credentials created"}
 [32mâœ“[39m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould update existing user on subsequent logins[33m 479[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Callback Error Handling[2m > [22mshould handle callback with missing state parameter[32m 93[2mms[22m[39m
{"level":30,"time":1768539388082,"env":"test","module":"auth-service","tokenHash":"ca0ddc9ca678fb2e668b9429eb317af998b55abc1da02d18146f876410ac6e61","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768539388146,"env":"test","module":"auth","err":{"type":"TypeError","message":"Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')","stack":"TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')\n    at getTableColumns (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/utils.js:109:15)\n    at PgSelectBuilder.from (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/query-builders/select.js:62:16)\n    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)\n    at SystemStatsRepository.incrementUsersCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:103:16)\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:95:37)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"userId":"google-user-refresh","msg":"Failed to upsert user during authentication"}
{"level":50,"time":1768539388146,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
 [31mÃ—[39m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould create refresh token record in database[32m 194[2mms[22m[39m
[31m   â†’ expected 401 to be 200 // Object.is equality[39m
 [32mâœ“[39m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Callback Error Handling[2m > [22mshould handle callback with missing code parameter[32m 97[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Callback Error Handling[2m > [22mshould handle OAuth2 provider error responses[32m 96[2mms[22m[39m
{"level":50,"time":1768539388256,"env":"test","error":{},"msg":"Failed to create connection:"}
{"level":50,"time":1768539388334,"env":"test","module":"auth","err":{"type":"TypeError","message":"Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')","stack":"TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')\n    at getTableColumns (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/utils.js:109:15)\n    at PgSelectBuilder.from (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/query-builders/select.js:62:16)\n    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)\n    at SystemStatsRepository.incrementUsersCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:103:16)\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:95:37)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"userId":"google-user-idtoken","msg":"Failed to upsert user during authentication"}
{"level":50,"time":1768539388334,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
 [31mÃ—[39m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Connection Status[2m > [22mshould track OAuth2 connection status[32m 101[2mms[22m[39m
[31m   â†’ expected 500 to be 201 // Object.is equality[39m
 [32mâœ“[39m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Connection Status[2m > [22mshould store OAuth2 state in connection metadata[32m 93[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould rotate refresh token after use[33m 676[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Security[2m > [22mshould use cryptographically secure random state[32m 100[2mms[22m[39m
{"level":50,"time":1768539388568,"env":"test","module":"auth","err":{"type":"TypeError","message":"Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')","stack":"TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')\n    at getTableColumns (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/utils.js:109:15)\n    at PgSelectBuilder.from (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/query-builders/select.js:62:16)\n    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)\n    at SystemStatsRepository.incrementUsersCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:103:16)\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:95:37)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"userId":"google-user-minimal","msg":"Failed to upsert user during authentication"}
{"level":50,"time":1768539388568,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
 [31mÃ—[39m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould support both "token" and "idToken" fields[32m 188[2mms[22m[39m
[31m   â†’ expected 401 to be 200 // Object.is equality[39m
 [32mâœ“[39m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould respect rate limiting[32m 45[2mms[22m[39m
{"level":30,"time":1768539388619,"env":"test","module":"user-credentials-repository","userId":"3CzyPrDMGQHa7sa_vo7Rg","msg":"User credentials created"}
{"level":50,"time":1768539388661,"env":"test","module":"auth","err":{"type":"Error","message":"Token verification failed","stack":"Error: Token verification failed\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:431:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
 [31mÃ—[39m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould handle missing profile information gracefully[32m 190[2mms[22m[39m
[31m   â†’ expected 401 to be 200 // Object.is equality[39m
 [32mâœ“[39m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mGoogle Token Verification[2m > [22mshould verify valid Google ID token[32m 45[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mGoogle Token Verification[2m > [22mshould throw error when token verification fails[32m 46[2mms[22m[39m
{"level":30,"time":1768539388706,"env":"test","module":"user-credentials-repository","userId":"uw6QgxbIXUqzxSYd59nHr","msg":"User credentials created"}
{"level":40,"time":1768539388707,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768539388707,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
 [32mâœ“[39m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Security[2m > [22mshould prevent state reuse after validation[32m 95[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Security[2m > [22mshould include PKCE support metadata in state record[32m 95[2mms[22m[39m
{"level":50,"time":1768539388757,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token payload","stack":"Error: Invalid token payload\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:88:26)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
 [32mâœ“[39m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mGoogle Token Verification[2m > [22mshould throw error when email is not verified[32m 45[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mGoogle Token Verification[2m > [22mshould throw error when payload is null[32m 49[2mms[22m[39m
{"level":30,"time":1768539388814,"env":"test","module":"auth-routes","userId":"3CzyPrDMGQHa7sa_vo7Rg","sessionCount":2,"msg":"Listed active sessions"}
{"level":30,"time":1768539388819,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768539388820,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Redirect URI Validation[2m > [22mshould validate redirect URI matches allowed URIs[32m 95[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 when refresh token is missing[33m 381[2mms[22m[39m
{"level":30,"time":1768539388898,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768539388899,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould list all active sessions for current user[33m 547[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Redirect URI Validation[2m > [22mshould encode redirect URI in authorization URL[32m 102[2mms[22m[39m
{"level":30,"time":1768539389084,"env":"test","module":"user-credentials-repository","userId":"eypCcOvSy-N9mneIJhBXt","msg":"User credentials created"}
{"level":30,"time":1768539389134,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","plainTokenLen":19,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768539389144,"env":"test","module":"user-credentials-repository","userId":"HDWpWbFZJ1Su-3AG-IehC","msg":"User credentials created"}
{"level":40,"time":1768539389181,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768539389248,"env":"test","module":"auth-routes","userId":"HDWpWbFZJ1Su-3AG-IehC","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768539389271,"env":"test","module":"auth-service","allTokensCount":23,"sampleToken":"b7ce0524e89189a24526f703a9bf6d00e53977248f685b9f2e825658127c1162","msg":"DEBUG: Tokens in DB"}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould mark current session as current[33m 426[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 for invalid refresh token[33m 515[2mms[22m[39m
{"level":30,"time":1768539389574,"env":"test","module":"user-credentials-repository","userId":"WVsVStzfMIFJLGeUSKHxh","msg":"User credentials created"}
{"level":30,"time":1768539389595,"env":"test","module":"user-credentials-repository","userId":"QnQ_j_d8bxNiv3vVa4aVd","msg":"User credentials created"}
{"level":30,"time":1768539389680,"env":"test","module":"auth-routes","userId":"WVsVStzfMIFJLGeUSKHxh","sessionCount":0,"msg":"Listed active sessions"}
{"level":30,"time":1768539389702,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","plainTokenLen":17,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768539389753,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768539389844,"env":"test","module":"auth-service","allTokensCount":25,"sampleToken":"b7ce0524e89189a24526f703a9bf6d00e53977248f685b9f2e825658127c1162","msg":"DEBUG: Tokens in DB"}
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 for expired refresh token[33m 571[2mms[22m[39m
{"level":30,"time":1768539390017,"env":"test","module":"user-credentials-repository","userId":"r9x8-Jnww095vWyCT9qz8","msg":"User credentials created"}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould return empty array when user has no active sessions[33m 432[2mms[22m[39m
{"level":30,"time":1768539390118,"env":"test","module":"auth-routes","userId":"r9x8-Jnww095vWyCT9qz8","sessionCount":0,"msg":"Listed active sessions"}
{"level":30,"time":1768539390166,"env":"test","module":"user-credentials-repository","userId":"t2YDi0oDeutDqWjApbQQh","msg":"User credentials created"}
{"level":30,"time":1768539390267,"env":"test","module":"auth-service","tokenHash":"1904fa22c26be848ff1d6efd956eaa8cb81c3c8fce56e230fef3ad7e68cb79a9","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768539390320,"env":"test","module":"auth-service","userId":"t2YDi0oDeutDqWjApbQQh","tokenHash":"1904fa22c26be848ff1d6efd956eaa8cb81c3c8fce56e230fef3ad7e68cb79a9","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768539390443,"env":"test","module":"user-credentials-repository","userId":"06U2eUuKC8b0mMWQDQSWj","msg":"User credentials created"}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould not include expired sessions[33m 437[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 for revoked refresh token[33m 523[2mms[22m[39m
{"level":30,"time":1768539390594,"env":"test","module":"auth-routes","userId":"06U2eUuKC8b0mMWQDQSWj","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768539390684,"env":"test","module":"user-credentials-repository","userId":"1okftMMuzDWym4kV6wFLF","msg":"User credentials created"}
{"level":30,"time":1768539390804,"env":"test","module":"auth-service","tokenHash":"e5bf2ca73f92330ff9e8c0d87a40069744899639247a6d065ef56194f9ede67f","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768539390851,"env":"test","module":"auth-service","tokenHash":"e5bf2ca73f92330ff9e8c0d87a40069744899639247a6d065ef56194f9ede67f","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768539390919,"env":"test","module":"user-credentials-repository","userId":"ZZnUv0ZfuBIcxWvsmOA0l","msg":"User credentials created"}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould not include revoked sessions[33m 476[2mms[22m[39m
{"level":30,"time":1768539390942,"env":"test","module":"auth-service","allTokensCount":26,"sampleToken":"b7ce0524e89189a24526f703a9bf6d00e53977248f685b9f2e825658127c1162","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768539391019,"env":"test","module":"auth-routes","userId":"ZZnUv0ZfuBIcxWvsmOA0l","sessionCount":1,"msg":"Listed active sessions"}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould parse device name from user agent[33m 426[2mms[22m[39m
{"level":30,"time":1768539391262,"env":"test","module":"user-credentials-repository","userId":"qVgBzZYZO8LomMDOJ0foG","msg":"User credentials created"}
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 when user is not found[33m 575[2mms[22m[39m
{"level":30,"time":1768539391323,"env":"test","module":"auth-service","tokenHash":"7bc7458809f9ac3ea054aaeca2dba495e9877fb6f71948fead490f98fb26908a","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768539391360,"env":"test","module":"user-credentials-repository","userId":"6Hw16-V_dc3x8kce5-Htv","msg":"User credentials created"}
{"level":50,"time":1768539391365,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould return 401 for unauthenticated request[33m 347[2mms[22m[39m
{"level":30,"time":1768539391684,"env":"test","module":"user-credentials-repository","userId":"0stBaNZozNND9MKtgvvVg","msg":"User credentials created"}
{"level":30,"time":1768539391875,"env":"test","module":"auth-routes","userId":"0stBaNZozNND9MKtgvvVg","sessionId":"743ec8df-e40e-42af-abd4-8bf8f663d3bb","msg":"Session revoked"}
{"level":30,"time":1768539391887,"env":"test","module":"user-credentials-repository","userId":"vo3lkPTboeBPJhlW8Vf1C","msg":"User credentials created"}
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould update refresh token metadata on rotation[33m 623[2mms[22m[39m
{"level":30,"time":1768539391938,"env":"test","module":"auth-service","tokenHash":"bdf19c2d6ca937c4400ae08470373e936aed6a9d7b8be14f3fad42225935bf1b","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768539391939,"env":"test","module":"auth-service","tokenHash":"bdf19c2d6ca937c4400ae08470373e936aed6a9d7b8be14f3fad42225935bf1b","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould revoke a specific session[33m 555[2mms[22m[39m
{"level":30,"time":1768539392250,"env":"test","module":"user-credentials-repository","userId":"OgMBKJAB7McJ-hCrWYyt2","msg":"User credentials created"}
{"level":40,"time":1768539392288,"env":"test","module":"auth-service","userId":"vo3lkPTboeBPJhlW8Vf1C","tokenHash":"bdf19c2d6ca937c4400ae08470373e936aed6a9d7b8be14f3fad42225935bf1b","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould return 404 for non-existent session[33m 331[2mms[22m[39m
{"level":30,"time":1768539392570,"env":"test","module":"user-credentials-repository","userId":"uSWbkJxonQp0sl2mn7Z2e","msg":"User credentials created"}
{"level":30,"time":1768539392661,"env":"test","module":"user-credentials-repository","userId":"LWxZEs3j3b7XrLME1C573","msg":"User credentials created"}
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould handle concurrent refresh token requests (token reuse detection)[33m 770[2mms[22m[39m
{"level":30,"time":1768539392719,"env":"test","module":"auth-service","tokenHash":"671a06d9c3c30c3cc285483f52af0b9285c70231c632ee4757fdf24fdef8e23f","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768539393049,"env":"test","module":"user-credentials-repository","userId":"56gR-GyVfvEIYXslaudds","msg":"User credentials created"}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould prevent revoking current session[33m 468[2mms[22m[39m
{"level":30,"time":1768539393230,"env":"test","module":"user-credentials-repository","userId":"JjQ02cymIt83TnhOl675k","msg":"User credentials created"}
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould set secure cookie in production[33m 576[2mms[22m[39m
{"level":30,"time":1768539393280,"env":"test","module":"auth-service","tokenHash":"22f458da2ca40fa98ec16f0f0809be7544c5fd602b58b8eec6251b31e27f9ddd","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould prevent revoking another user's session[33m 531[2mms[22m[39m
{"level":30,"time":1768539393578,"env":"test","module":"user-credentials-repository","userId":"0E3KZfJjtC8qy1khrXshm","msg":"User credentials created"}
{"level":50,"time":1768539393580,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould return 401 for unauthenticated request[33m 328[2mms[22m[39m
{"level":30,"time":1768539393792,"env":"test","module":"user-credentials-repository","userId":"Se27rtivJ7k5kXPs5dNHq","msg":"User credentials created"}
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould set proper cookie attributes[33m 562[2mms[22m[39m
{"level":30,"time":1768539393845,"env":"test","module":"auth-service","tokenHash":"d6cbd5cb00bc9b66871e2ed6c4a797749c46bb6644252c25656490ee302fc945","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768539393898,"env":"test","module":"user-credentials-repository","userId":"l87wrYpUUzfCww2YN-mWL","msg":"User credentials created"}
{"level":30,"time":1768539394359,"env":"test","module":"auth-routes","userId":"l87wrYpUUzfCww2YN-mWL","msg":"All other sessions revoked"}
{"level":30,"time":1768539394366,"env":"test","module":"user-credentials-repository","userId":"GmzSGnoKouZdSltLI_01D","msg":"User credentials created"}
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould include user role information in response[33m 566[2mms[22m[39m
{"level":30,"time":1768539394414,"env":"test","module":"audit-log-service","userId":"l87wrYpUUzfCww2YN-mWL","eventType":"all_sessions_revoked","ipAddress":"::ffff:127.0.0.1","hasMetadata":false,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22m[2mOAuth2 Token Refresh Flow[2m > [22m[2mRefresh Token Lifecycle[2m > [22m[2mshould create refresh token on login
[22m[39mDEBUG: LOGIN HANDLER HIT

 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould revoke all sessions except current[33m 886[2mms[22m[39m
{"level":30,"time":1768539394793,"env":"test","module":"user-credentials-repository","userId":"h-MLEn_ScKg5L8n68TrdY","msg":"User credentials created"}
{"level":30,"time":1768539394949,"env":"test","module":"auth-routes","userId":"GmzSGnoKouZdSltLI_01D","msg":"User logged in successfully"}
{"level":30,"time":1768539394988,"env":"test","module":"auth-routes","userId":"h-MLEn_ScKg5L8n68TrdY","msg":"All other sessions revoked"}
{"level":30,"time":1768539394998,"env":"test","module":"audit-log-service","userId":"GmzSGnoKouZdSltLI_01D","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768539395038,"env":"test","module":"audit-log-service","userId":"h-MLEn_ScKg5L8n68TrdY","eventType":"all_sessions_revoked","ipAddress":"::ffff:127.0.0.1","hasMetadata":false,"msg":"Security event logged"}
{"level":30,"time":1768539395368,"env":"test","module":"user-credentials-repository","userId":"Y9fYe_0KAMiJ7taPMTF-Q","msg":"User credentials created"}
{"level":30,"time":1768539395407,"env":"test","module":"user-credentials-repository","userId":"FjtSgqELRCCsM-5TpZuWp","msg":"User credentials created"}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould revoke all trusted devices[33m 620[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould create refresh token on login[33m 1004[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould return 400 when no active session found[33m 324[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould revoke refresh token on logout[33m 469[2mms[22m[39m
{"level":30,"time":1768539395730,"env":"test","module":"user-credentials-repository","userId":"qThucSyD9Kx9R0ZRInHfa","msg":"User credentials created"}
{"level":50,"time":1768539395733,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768539395834,"env":"test","module":"user-credentials-repository","userId":"BIx_9k_p7PStSCo7n8X_S","msg":"User credentials created"}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould return 401 for unauthenticated request[33m 324[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould handle logout without refresh token gracefully[33m 372[2mms[22m[39m
{"level":30,"time":1768539396054,"env":"test","module":"user-credentials-repository","userId":"V6Hr0b17sVzhbtCa_dOB5","msg":"User credentials created"}
{"level":30,"time":1768539396159,"env":"test","module":"auth-routes","userId":"V6Hr0b17sVzhbtCa_dOB5","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":30,"time":1768539396202,"env":"test","module":"user-credentials-repository","userId":"npnR62EX2T4uBNvIV_2XO","msg":"User credentials created"}
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould support multiple active refresh tokens per user[33m 512[2mms[22m[39m
{"level":30,"time":1768539396531,"env":"test","module":"user-credentials-repository","userId":"PIb1XxvFhgOp6c0XHGzB7","msg":"User credentials created"}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mPOST /api/auth/trust-device[2m > [22mshould mark current device as trusted[33m 478[2mms[22m[39m
{"level":30,"time":1768539396636,"env":"test","module":"auth-routes","userId":"PIb1XxvFhgOp6c0XHGzB7","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":30,"time":1768539396721,"env":"test","module":"user-credentials-repository","userId":"bdHgSbE00ofLlrvjT6eMk","msg":"User credentials created"}
{"level":30,"time":1768539396780,"env":"test","module":"auth-routes","userId":"PIb1XxvFhgOp6c0XHGzB7","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Trusted device expiry updated"}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mPOST /api/auth/trust-device[2m > [22mshould update existing trusted device expiry[33m 616[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould revoke all user tokens on password reset[33m 561[2mms[22m[39m
{"level":30,"time":1768539397163,"env":"test","module":"user-credentials-repository","userId":"k6O1VQD-0GQVc22sK59v6","msg":"User credentials created"}
{"level":30,"time":1768539397267,"env":"test","module":"auth-routes","userId":"k6O1VQD-0GQVc22sK59v6","deviceCount":2,"msg":"Listed trusted devices"}
{"level":30,"time":1768539397286,"env":"test","module":"user-credentials-repository","userId":"1g_oIV7fFvYWJm0KgeXSl","msg":"User credentials created"}
{"level":30,"time":1768539397588,"env":"test","module":"user-credentials-repository","userId":"KxXw8ke7h5Xz-_rVStB71","msg":"User credentials created"}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould list all trusted devices[33m 440[2mms[22m[39m
{"level":30,"time":1768539397694,"env":"test","module":"auth-routes","userId":"KxXw8ke7h5Xz-_rVStB71","deviceCount":0,"msg":"Listed trusted devices"}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould not include revoked devices[33m 426[2mms[22m[39m
{"level":30,"time":1768539398023,"env":"test","module":"user-credentials-repository","userId":"lZZ_7npAu9FZ6rMUrKhXu","msg":"User credentials created"}
{"level":30,"time":1768539398174,"env":"test","module":"auth-routes","userId":"lZZ_7npAu9FZ6rMUrKhXu","deviceId":"822634fc-4f21-4770-a76b-813409a0445d","msg":"Trusted device revoked"}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould revoke a trusted device[33m 527[2mms[22m[39m
{"level":30,"time":1768539398542,"env":"test","module":"user-credentials-repository","userId":"1XTV9KcJ7PjCXVvMGHVyh","msg":"User credentials created"}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould return 404 for non-existent device[33m 323[2mms[22m[39m
{"level":30,"time":1768539398867,"env":"test","module":"user-credentials-repository","userId":"uTAMfwd2QccomkAvTJudP","msg":"User credentials created"}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mSession Metadata Tracking[2m > [22mshould track IP address for sessions[33m 416[2mms[22m[39m
{"level":30,"time":1768539399280,"env":"test","module":"user-credentials-repository","userId":"AZ41kk4lgN6tcmKbc_AZW","msg":"User credentials created"}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mSession Metadata Tracking[2m > [22mshould track user agent for sessions[33m 414[2mms[22m[39m
{"level":30,"time":1768539399698,"env":"test","module":"user-credentials-repository","userId":"v_hm8H2mHCDOnv4JgZXXw","msg":"User credentials created"}
{"level":30,"time":1768539399896,"env":"test","module":"auth-service","tokenHash":"bf40b6a613f97518c893162821fbea2198d612e5b4031d68873e967b682e8ae4","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768539400143,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768539400144,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mSession Metadata Tracking[2m > [22mshould update lastUsedAt on token refresh[33m 767[2mms[22m[39m
{"level":30,"time":1768539402518,"env":"test","module":"user-credentials-repository","userId":"isUvTgAbSJ_5abJjmJQSm","msg":"User credentials created"}
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould use cryptographically strong random tokens[33m 5230[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould hash refresh tokens before storing in database[33m 471[2mms[22m[39m
{"level":30,"time":1768539402980,"env":"test","module":"user-credentials-repository","userId":"GIfkiw55eQcmHfL_j7ZQE","msg":"User credentials created"}
{"level":30,"time":1768539403032,"env":"test","module":"auth-service","tokenHash":"a1a6b9bb17a2c7198eebd18a12f50a616493b355871c979ea9172897d32b4512","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768539403244,"env":"test","module":"auth-service","tokenHash":"a1a6b9bb17a2c7198eebd18a12f50a616493b355871c979ea9172897d32b4512","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768539403298,"env":"test","module":"auth-service","userId":"GIfkiw55eQcmHfL_j7ZQE","tokenHash":"a1a6b9bb17a2c7198eebd18a12f50a616493b355871c979ea9172897d32b4512","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768539403675,"env":"test","module":"user-credentials-repository","userId":"dwFyN8VPY3d1fod04_97E","msg":"User credentials created"}
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould prevent refresh token reuse after rotation[33m 689[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould validate token ownership[33m 469[2mms[22m[39m
{"level":30,"time":1768539404139,"env":"test","module":"user-credentials-repository","userId":"7Jd9l4iyeaAEkHqmCcxC2","msg":"User credentials created"}
{"level":30,"time":1768539404190,"env":"test","module":"auth-service","tokenHash":"8baafcd67ad2cd09a7daa8b6c4a66e3d58995914b986507946b5244c82298f41","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set HttpOnly flag to prevent XSS[33m 567[2mms[22m[39m
{"level":30,"time":1768539404704,"env":"test","module":"user-credentials-repository","userId":"gtNNt8r9xJzsyz2MeemTS","msg":"User credentials created"}
{"level":30,"time":1768539404757,"env":"test","module":"auth-service","tokenHash":"098583f04e838ca0565f1d44b2ed14d09027b260b19edd9010a6ececadff4c8c","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set SameSite=Strict to prevent CSRF[33m 571[2mms[22m[39m
{"level":30,"time":1768539405264,"env":"test","module":"user-credentials-repository","userId":"fqsxpaK14guYXRrjE8JfF","msg":"User credentials created"}
{"level":30,"time":1768539405316,"env":"test","module":"auth-service","tokenHash":"5ce6b00c4587ebb7bd80fbb28052b41e764a7dec5bb8f429f4736509170387c9","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set proper cookie path[33m 553[2mms[22m[39m
{"level":30,"time":1768539405830,"env":"test","module":"user-credentials-repository","userId":"MTUpzrrDpgB8nXOiV9sFy","msg":"User credentials created"}
{"level":30,"time":1768539405886,"env":"test","module":"auth-service","tokenHash":"727592e754a23fec53e217766dd18c0f136089e902b1cfc3f07b58c8aa021c84","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set appropriate expiry (30 days)[33m 609[2mms[22m[39m
{"level":30,"time":1768539406301,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768539406301,"env":"test","msg":"DB: pool closed."}

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Suites 4 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m [ tests/integration/auth/auth.middleware.integration.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/auth/jwt.authentication.test.ts[2m [ tests/integration/auth/jwt.authentication.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/auth/protected.routes.test.ts[2m [ tests/integration/auth/protected.routes.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/auth/session.management.integration.test.ts[2m [ tests/integration/auth/session.management.integration.test.ts ][22m
[31m[1mTypeError[22m: () => ({
      getGenerativeModel: __vite_ssr_import_0__.vi.fn().mockReturnValue({
        generateContent: __v...<omitted>...}) is not a constructor[39m
[36m [2mâ¯[22m new DocumentAIAssistService server/lib/ai/DocumentAIAssistService.ts:[2m43:26[22m[39m
    [90m 41| [39m        [35mconst[39m apiKey [33m=[39m process[33m.[39menv[33m.[39m[33mGEMINI_API_KEY[39m[33m;[39m
    [90m 42| [39m        [35mif[39m (apiKey) {
    [90m 43| [39m            [35mthis[39m[33m.[39mgenAI [33m=[39m [35mnew[39m [33mGoogleGenerativeAI[39m(apiKey)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m 44| [39m            const model = process.env.GEMINI_MODEL || "gemini-2.0-flasâ€¦
    [90m 45| [39m            [35mthis[39m[33m.[39mmodel [33m=[39m [35mthis[39m[33m.[39mgenAI[33m.[39m[34mgetGenerativeModel[39m({ model })[33m;[39m
[90m [2mâ¯[22m server/lib/ai/DocumentAIAssistService.ts:[2m258:40[22m[39m
[90m [2mâ¯[22m server/routes/ai.doc.routes.ts:[2m5:1[22m[39m
[90m [2mâ¯[22m server/routes/index.ts:[2m9:1[22m[39m
[90m [2mâ¯[22m server/routes.ts:[2m11:1[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/10]âŽ¯[22m[39m


[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Tests 6 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Authorization Flow Initiation[2m > [22mshould initiate OAuth2 3-legged flow and generate authorization URL
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.callback.test.ts:[2m125:37[22m[39m
    [90m123| [39m        })[33m;[39m
    [90m124| [39m
    [90m125| [39m      [34mexpect[39m(createResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m126| [39m      testConnectionId [33m=[39m createResponse[33m.[39mbody[33m.[39mid[33m;[39m
    [90m127| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[2/10]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Connection Status[2m > [22mshould track OAuth2 connection status
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.callback.test.ts:[2m309:37[22m[39m
    [90m307| [39m        })[33m;[39m
    [90m308| [39m
    [90m309| [39m      [34mexpect[39m(createResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m310| [39m      [35mconst[39m connectionId [33m=[39m createResponse[33m.[39mbody[33m.[39mid[33m;[39m
    [90m311| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[3/10]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould successfully authenticate with valid Google ID token
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m91:31[22m[39m
    [90m 89| [39m
    [90m 90| [39m      [90m// Verify response[39m
    [90m 91| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m 92| [39m      [34mexpect[39m(response[33m.[39mbody)[33m.[39m[34mtoMatchObject[39m({
    [90m 93| [39m        message[33m:[39m [32m'Authentication successful'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[4/10]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould create refresh token record in database
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m297:31[22m[39m
    [90m295| [39m        })[33m;[39m
    [90m296| [39m
    [90m297| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m298| [39m
    [90m299| [39m      [90m// Verify refresh token exists in database[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[5/10]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould support both "token" and "idToken" fields
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m332:31[22m[39m
    [90m330| [39m        })[33m;[39m
    [90m331| [39m
    [90m332| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m333| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoBe[39m([32m'Authentication successful'[39m)[33m;[39m
    [90m334| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[6/10]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould handle missing profile information gracefully
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m395:31[22m[39m
    [90m393| [39m        })[33m;[39m
    [90m394| [39m
    [90m395| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m396| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39muser)[33m.[39m[34mtoMatchObject[39m({
    [90m397| [39m        email[33m:[39m [32m'minimal@example.com'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[7/10]âŽ¯[22m[39m


[2m Test Files [22m [1m[31m6 failed[39m[22m[2m | [22m[1m[32m3 passed[39m[22m[90m (9)[39m
[2m      Tests [22m [1m[31m6 failed[39m[22m[2m | [22m[1m[32m103 passed[39m[22m[90m (109)[39m
[2m   Start at [22m 22:56:21
[2m   Duration [22m 33.55s[2m (transform 7.29s, setup 1.90s, import 12.06s, tests 48.71s, environment 2ms)[22m

