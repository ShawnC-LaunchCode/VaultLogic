npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

> ezbuildr@1.0.0 test
> cross-env VITEST_INTEGRATION=true vitest run --coverage


[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m
      [2mCoverage enabled with [22m[33mv8[39m

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w14_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w5_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w14_v3 (Reused: true)

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w5_v3 (Reused: true)

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mðŸ“Š Schema test_schema_w14_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681323685,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681323686,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w14_v3\",public on all connections"}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mðŸ“Š Schema test_schema_w5_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681323701,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681323702,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w5_v3\",public on all connections"}
{"level":30,"time":1768681323772,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681323824,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w5_v3, public

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w14_v3, public

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w14_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w1_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w0_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w1_v3 (Reused: true)

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w13_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w13_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mðŸ“Š Schema test_schema_w1_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681324811,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681324812,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w1_v3\",public on all connections"}
{"level":30,"time":1768681324866,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mðŸ“Š Schema test_schema_w13_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681324912,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681324913,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w13_v3\",public on all connections"}
{"level":30,"time":1768681324969,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w0_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w0_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w1_v3, public

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w13_v3, public

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w1_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w1_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w14_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w14_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould create placeholder user for non-existent email
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,f47bba8f-abb2-4e12-8e2a-53de0ec5c0ea,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'f47bba8f-abb2-4e12-8e2a-53de0ec5c0ea'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m521[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (3608d658-a710-46c5-bc5b-c885c5f48998, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, f47bba8f-abb2-4e12-8e2a-53de0ec5c0ea, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-17 20:22:06.923213, 2026-01-17 20:22:06.923213).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w13_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":30,"time":1768681326854,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768681326893,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768681326970,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768681326976,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mgetUserOrganizations[2m > [22m[2mshould return empty array for user with no memberships
[22m[39mCRITICAL: User lookup failed validation in beforeEach: [90mundefined[39m

{"level":30,"time":1768681327079,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768681327105,"env":"test","module":"email-queue","jobId":"087c9302-7525-4e21-ae46-f96c0b8a935b","to":"newuser_1768681322833@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":30,"time":1768681327110,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould create placeholder user for non-existent email
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,f47bba8f-abb2-4e12-8e2a-53de0ec5c0ea,{"after":{"invitedEmail":"newuser_1768681322833@test.com","token":"0cddd8908cd77ecc0b0922aefbcc7342736da6118630f9b55ada0eae213c7fdf"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'f47bba8f-abb2-4e12-8e2a-53de0ec5c0ea'[39m,
    [32m'{"after":{"invitedEmail":"newuser_1768681322833@test.com","token":"0cddd8908cd77ecc0b0922aefbcc7342736da6118630f9b55ada0eae213c7fdf"}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:81:28
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m541[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (ccab06b1-d377-4307-bddf-438ecbeb40c3, null, null, 00000000-0000-0000-0000-000000000021, organization.invite_send, null, null, organization, f47bba8f-abb2-4e12-8e2a-53de0ec5c0ea, {"after": {"token": "0cddd8908cd77ecc0b0922aefbcc7342736da611863..., null, null, null, 2026-01-17 20:22:07.657218, 2026-01-17 20:22:07.657218).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w13_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w4_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w6_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w8_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w8_v3 (Reused: true)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w6_v3 (Reused: true)

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w4_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w12_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w10_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w3_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w12_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w10_v3 (Reused: true)

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w3_v3 (Reused: true)

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould transfer user-owned project to org
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,873383f4-592d-4f18-9225-76d212542f9c,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'873383f4-592d-4f18-9225-76d212542f9c'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m522[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (19500918-644c-4379-8727-483e76360531, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 873383f4-592d-4f18-9225-76d212542f9c, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-17 20:22:08.116542, 2026-01-17 20:22:08.116542).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w5_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts[2m > [22m[2mDataVault Autonumber Integration Tests
[22m[39mError cleaning up table: Error: Table not found
    at DatavaultTablesService.verifyTenantOwnership (C:/Users/scoot/poll/VaultLogic/server/services/DatavaultTablesService.ts:152:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at DatavaultTablesService.deleteTable (C:/Users/scoot/poll/VaultLogic/server/services/DatavaultTablesService.ts:290:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/datavault.autonumber.test.ts:91:9

{"level":30,"time":1768681327852,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681327853,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/datavault.autonumber.test.ts [2m([22m[2m5 tests[22m[2m | [22m[33m5 skipped[39m[2m)[22m[33m 3949[2mms[22m[39m
     [2m[90mâ†“[39m[22m should generate basic autonumber without prefix
     [2m[90mâ†“[39m[22m should generate autonumber with prefix
     [2m[90mâ†“[39m[22m should generate autonumber with yearly reset format
     [2m[90mâ†“[39m[22m should be atomic and prevent race conditions
     [2m[90mâ†“[39m[22m should prevent manual updates to autonumber values
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mðŸ“Š Schema test_schema_w4_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681327990,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681327990,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w4_v3\",public on all connections"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mðŸ“Š Schema test_schema_w6_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681328020,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681328020,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w6_v3\",public on all connections"}
{"level":30,"time":1768681328056,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681328078,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mðŸ“Š Schema test_schema_w12_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681328121,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681328122,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w12_v3\",public on all connections"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mðŸ“Š Schema test_schema_w3_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681328147,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681328147,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w3_v3\",public on all connections"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mðŸ“Š Schema test_schema_w8_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681328156,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mðŸ“Š Schema test_schema_w10_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681328170,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681328186,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681328157,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w8_v3\",public on all connections"}
{"level":30,"time":1768681328212,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681328225,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681328170,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w10_v3\",public on all connections"}
{"level":30,"time":1768681328229,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w4_v3, public

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w6_v3, public

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w0_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w0_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w12_v3, public

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w10_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w3_v3, public

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w8_v3, public

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w10_v3, public

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w8_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w0_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w0_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w13_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w13_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w15_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w15_v3 (Reused: true)

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould prevent duplicate pending invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,0dd38510-506c-4f36-912e-fdaf93db37ca,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'0dd38510-506c-4f36-912e-fdaf93db37ca'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m518[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (e62487f7-2338-4f13-ae04-010f93de22d1, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, 0dd38510-506c-4f36-912e-fdaf93db37ca, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-17 20:22:10.62541, 2026-01-17 20:22:10.62541).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w0_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768681330286,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["3f6d7f37-ef8c-438d-bf15-2734ef38536f","$2b$12$G7Ddn9e57iw8P3V8rAwrJ.V.ysiYA5xgLkiEz.J6qIdoiMAbiPDHe"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(3f6d7f37-ef8c-438d-bf15-2734ef38536f) is not present in table \"users\".","schema":"test_schema_w5_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"3f6d7f37-ef8c-438d-bf15-2734ef38536f","msg":"Failed to create user credentials"}
{"level":50,"time":1768681330287,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["3f6d7f37-ef8c-438d-bf15-2734ef38536f","$2b$12$G7Ddn9e57iw8P3V8rAwrJ.V.ysiYA5xgLkiEz.J6qIdoiMAbiPDHe"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(3f6d7f37-ef8c-438d-bf15-2734ef38536f) is not present in table \"users\".","schema":"test_schema_w5_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould detach workflow from project when transferring to different owner
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,ad20ef52-7ac5-46c9-b846-198f663a7cef,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'ad20ef52-7ac5-46c9-b846-198f663a7cef'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m522[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (11e91312-d8da-4b16-b7ac-74f7073b0427, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, ad20ef52-7ac5-46c9-b846-198f663a7cef, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-17 20:22:10.821356, 2026-01-17 20:22:10.821356).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w3_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768681330378,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["767ba777-56dc-46e6-95ec-aab64af702ac","$2b$12$4xe8EqLjDz8M4gYYAplZd.3wJYfIBY4m5FxS8zZCGXgylbGNM/.du"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(767ba777-56dc-46e6-95ec-aab64af702ac) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"767ba777-56dc-46e6-95ec-aab64af702ac","msg":"Failed to create user credentials"}
{"level":50,"time":1768681330378,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["767ba777-56dc-46e6-95ec-aab64af702ac","$2b$12$4xe8EqLjDz8M4gYYAplZd.3wJYfIBY4m5FxS8zZCGXgylbGNM/.du"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(767ba777-56dc-46e6-95ec-aab64af702ac) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mðŸ“Š Schema test_schema_w15_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681330555,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681330556,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w15_v3\",public on all connections"}
{"level":30,"time":1768681330612,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mdemoteMember[2m > [22m[2mshould allow admin to demote other admin
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,9e5be8cf-c5cd-4788-8994-1b2af6315470,{"after":{"name":"Demote Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'9e5be8cf-c5cd-4788-8994-1b2af6315470'[39m,
    [32m'{"after":{"name":"Demote Test Org Int","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:197:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m525[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (6eabc95f-299d-4e54-89f7-6ba15e4e676d, null, null, 00000000-0000-0000-0000-000000000011, organization.create, null, null, organization, 9e5be8cf-c5cd-4788-8994-1b2af6315470, {"after": {"name": "Demote Test Org Int", "slug": null}}, null, null, null, 2026-01-17 20:22:11.161102, 2026-01-17 20:22:11.161102).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w13_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w15_v3, public

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w6_v3
â© Schema reused, skipping migrations.

{"level":50,"time":1768681331222,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["53b5cfdf-1016-4f8b-88b3-41f20a2be2c5","$2b$12$/ictdsX6YGgT4.pMREIUnOMuMVKhONFN.4wnSFVIQpVx32ILTVwLu"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(53b5cfdf-1016-4f8b-88b3-41f20a2be2c5) is not present in table \"users\".","schema":"test_schema_w15_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"53b5cfdf-1016-4f8b-88b3-41f20a2be2c5","msg":"Failed to create user credentials"}
{"level":50,"time":1768681331223,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["53b5cfdf-1016-4f8b-88b3-41f20a2be2c5","$2b$12$/ictdsX6YGgT4.pMREIUnOMuMVKhONFN.4wnSFVIQpVx32ILTVwLu"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(53b5cfdf-1016-4f8b-88b3-41f20a2be2c5) is not present in table \"users\".","schema":"test_schema_w15_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681331891,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould prevent non-member from transferring org workflow
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,0ce483cc-bd40-4e42-a929-893a73c322af,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'0ce483cc-bd40-4e42-a929-893a73c322af'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m523[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (0055288b-5b7b-43c4-8b38-485a2694069f, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 0ce483cc-bd40-4e42-a929-893a73c322af, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-17 20:22:12.378196, 2026-01-17 20:22:12.378196).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w14_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768681332021,"env":"test","module":"auth-routes","userId":"e88f7634e54a632d976252f80ce3dd67","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768681332075,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["aa3ecf43-2559-44d9-9fff-bfa895296d66","$2b$12$VvI4WbGVnV1vo2SZXbdpaulj3JhC8QTvaytHYl.Hq7eh7prH9zsSm"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(aa3ecf43-2559-44d9-9fff-bfa895296d66) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"aa3ecf43-2559-44d9-9fff-bfa895296d66","msg":"Failed to create user credentials"}
{"level":50,"time":1768681332075,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["aa3ecf43-2559-44d9-9fff-bfa895296d66","$2b$12$VvI4WbGVnV1vo2SZXbdpaulj3JhC8QTvaytHYl.Hq7eh7prH9zsSm"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(aa3ecf43-2559-44d9-9fff-bfa895296d66) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":50,"time":1768681332163,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:76:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w0_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w12_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w0_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w12_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681332291,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768681332322,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768681332323,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768681332341,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768681332374,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":50,"time":1768681332568,"env":"test","module":"auth-routes","email":"test-1768681331098-pv48z3l@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768681332701,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:85:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681332760,"env":"test","module":"auth-routes","email":"test-1768681331098-pv48z3l@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768681332798,"env":"test","module":"auth-routes","email":"test-1768681331826-b5yyx@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768681332844,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["9d527a7c-1684-4d21-be37-8f49f650d351","$2b$12$Y6hjqx/9mS8/4zMcOYZr0u6W4kyDSsjh5Hc5dKQMTRhWa5N1x4gz6"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(9d527a7c-1684-4d21-be37-8f49f650d351) is not present in table \"users\".","schema":"test_schema_w3_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"9d527a7c-1684-4d21-be37-8f49f650d351","msg":"Failed to create user credentials"}
{"level":50,"time":1768681332844,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["9d527a7c-1684-4d21-be37-8f49f650d351","$2b$12$Y6hjqx/9mS8/4zMcOYZr0u6W4kyDSsjh5Hc5dKQMTRhWa5N1x4gz6"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(9d527a7c-1684-4d21-be37-8f49f650d351) is not present in table \"users\".","schema":"test_schema_w3_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768681332883,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768681332942,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould transfer database ownership
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,bd338b75-bb0c-49b1-ab37-55f0e59d9869,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'bd338b75-bb0c-49b1-ab37-55f0e59d9869'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m523[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (fce6b3ec-e958-4a75-9f16-b4ace410df9d, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, bd338b75-bb0c-49b1-ab37-55f0e59d9869, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-17 20:22:13.498113, 2026-01-17 20:22:13.498113).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w13_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681333194,"env":"test","module":"auth-routes","email":"test-1768681331826-b5yyx@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768681333351,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681333518,"env":"test","module":"auth-routes","email":"test-1768681331826-b5yyx@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768681333642,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768681333649,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould login with valid credentials
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681333858,"env":"test","module":"auth-routes","email":"test-1768681332848-dlnvom@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould store hashed backup codes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681333974,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould login with valid credentials
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":30,"time":1768681334007,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681334008,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/organizationService.test.ts [2m([22m[2m13 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 11192[2mms[22m[39m
[31m       [31mÃ—[31m should create organization and auto-create admin membership[39m[33m 522[2mms[22m[39m
[31m       [31mÃ—[31m should return all organizations for user[39m[33m 591[2mms[22m[39m
[31m       [31mÃ—[31m should return empty array for user with no memberships[39m[32m 235[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to update organization[39m[33m 982[2mms[22m[39m
[31m       [31mÃ—[31m should deny non-admin from updating organization[39m[33m 615[2mms[22m[39m
[31m       [31mÃ—[31m should return all members of organization[39m[33m 587[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to promote member[39m[32m 147[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to demote other admin[39m[33m 1567[2mms[22m[39m
[31m       [31mÃ—[31m should prevent self-demotion[39m[33m 756[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to remove member[39m[33m 579[2mms[22m[39m
[31m       [31mÃ—[31m should prevent self-removal[39m[33m 540[2mms[22m[39m
[31m       [31mÃ—[31m should allow member to leave organization[39m[33m 618[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to leave organization[39m[33m 535[2mms[22m[39m
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681334130,"env":"test","module":"auth-routes","userId":"9f915e2eec3612ddb79c299b0095bdce","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768681334140,"env":"test","module":"auth-routes","email":"test-1768681333684-jsd9@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768681334230,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768681334238,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768681334284,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould store hashed backup codes
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:76:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768681334316,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject expired invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,8847b445-8dfd-4d92-8c8f-eaa256cdb687,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'8847b445-8dfd-4d92-8c8f-eaa256cdb687'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m521[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (6d52b2a6-30dc-4b18-ab92-a1e676db0f27, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, 8847b445-8dfd-4d92-8c8f-eaa256cdb687, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-17 20:22:15.034883, 2026-01-17 20:22:15.034883).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w19_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768681334804,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould allow org member to transfer org database
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,20510f5f-725a-42e5-9ee0-e92ceb32ea71,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'20510f5f-725a-42e5-9ee0-e92ceb32ea71'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m523[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (a15c9cf9-3058-49bb-a8b7-f146c20e972e, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 20510f5f-725a-42e5-9ee0-e92ceb32ea71, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-17 20:22:15.275235, 2026-01-17 20:22:15.275235).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w13_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":50,"time":1768681334993,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["fph711gIe78udv87x9LOA","$2b$12$CpxL08fUXCFWjoVax1Ug5u7Pqso1iaitC7wsa4vizLHYv2mkqym6."],"cause":{"length":332,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(fph711gIe78udv87x9LOA) is not present in table \"users\".","schema":"test_schema_w14_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"fph711gIe78udv87x9LOA","msg":"Failed to create user credentials"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681335576,"env":"test","module":"auth-routes","email":"nonexistent@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject already accepted invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,55726a3e-e980-4957-b2e1-fdb51fdd0607,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'55726a3e-e980-4957-b2e1-fdb51fdd0607'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (28e61d70-9cc7-4fa0-bf96-171b6e3ce259, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, 55726a3e-e980-4957-b2e1-fdb51fdd0607, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-17 20:22:16.138878, 2026-01-17 20:22:16.138878).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w4_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768681335699,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for 4740a09eaa4b3c6c00a97677e1ade9f3

{"level":50,"time":1768681336175,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["0dd56bf4-053b-41d1-bc33-0a8ef3f888e2","$2b$12$pShdK7IBSbuhgJCg8LgL3uTl2.tmow/pxhPadYZHe7sHIQJ1PeylW"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(0dd56bf4-053b-41d1-bc33-0a8ef3f888e2) is not present in table \"users\".","schema":"test_schema_w15_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"0dd56bf4-053b-41d1-bc33-0a8ef3f888e2","msg":"Failed to create user credentials"}
{"level":50,"time":1768681336176,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["0dd56bf4-053b-41d1-bc33-0a8ef3f888e2","$2b$12$pShdK7IBSbuhgJCg8LgL3uTl2.tmow/pxhPadYZHe7sHIQJ1PeylW"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(0dd56bf4-053b-41d1-bc33-0a8ef3f888e2) is not present in table \"users\".","schema":"test_schema_w15_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking current session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681336399,"env":"test","module":"auth-routes","email":"test-1768681335486-23cdw@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,3b0928f9-0741-400c-9da1-379961997148,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'3b0928f9-0741-400c-9da1-379961997148'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m522[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (65f5ac20-8dde-49c6-9bb3-83be2cf32aa8, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 3b0928f9-0741-400c-9da1-379961997148, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-17 20:22:16.920714, 2026-01-17 20:22:16.920714).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w3_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768681336499,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking current session
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768681336570,"env":"test","module":"auth-routes","email":"test-1768681335702-hnrpo@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768681336781,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mTransfer Validation[2m > [22m[2mshould only allow transfer to self when targetOwnerType is user
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,6e48ede1-8089-453c-9717-d11a707e82e8,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'6e48ede1-8089-453c-9717-d11a707e82e8'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m522[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (e3e1bcfc-ea56-46c6-bd1e-51307e1ee0be, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 6e48ede1-8089-453c-9717-d11a707e82e8, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-17 20:22:17.909098, 2026-01-17 20:22:17.909098).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w3_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould verify email matches invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,d9da71f5-09d1-4dbd-89f5-a180235ebd94,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'd9da71f5-09d1-4dbd-89f5-a180235ebd94'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (ae9e40cf-5f7c-4bb7-a349-67083e9a26f5, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, d9da71f5-09d1-4dbd-89f5-a180235ebd94, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-17 20:22:18.148724, 2026-01-17 20:22:18.148724).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w5_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mTransfer Validation[2m > [22m[2mshould allow transfer from user to self (org member transferring org asset to themselves)
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,0cd79e29-2530-49b9-bfae-a335e4d0a14f,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'0cd79e29-2530-49b9-bfae-a335e4d0a14f'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m523[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (a257774b-ede2-473f-8388-94bf85aff206, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 0cd79e29-2530-49b9-bfae-a335e4d0a14f, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-17 20:22:18.959949, 2026-01-17 20:22:18.959949).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w13_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":30,"time":1768681338779,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681338780,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/transferOwnership.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 14879[2mms[22m[39m
[31m       [31mÃ—[31m should transfer user-owned project to org[39m[33m 1758[2mms[22m[39m
[31m       [31mÃ—[31m should prevent transfer to org if user is not a member[39m[33m 304[2mms[22m[39m
[31m       [31mÃ—[31m should allow org member to transfer org-owned project to another org they belong to[39m[33m 641[2mms[22m[39m
[31m       [31mÃ—[31m should detach workflow from project when transferring to different owner[39m[33m 1195[2mms[22m[39m
[31m       [31mÃ—[31m should keep workflow in project when transferring to same owner[39m[33m 321[2mms[22m[39m
[31m       [31mÃ—[31m should prevent non-member from transferring org workflow[39m[33m 1173[2mms[22m[39m
[31m       [31mÃ—[31m should transfer database ownership[39m[33m 1654[2mms[22m[39m
[31m       [31mÃ—[31m should allow org member to transfer org database[39m[33m 1811[2mms[22m[39m
[31m       [31mÃ—[31m should prevent transfer to org if user is not a member[39m[33m 1082[2mms[22m[39m
[31m       [31mÃ—[31m should only allow transfer to self when targetOwnerType is user[39m[33m 981[2mms[22m[39m
[31m       [31mÃ—[31m should allow transfer from user to self (org member transferring org asset to themselves)[39m[33m 1093[2mms[22m[39m
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject invalid token
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,30afa369-fe8e-462e-82d4-31507daad05b,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'30afa369-fe8e-462e-82d4-31507daad05b'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m521[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (1df47929-b735-42ce-a94b-177d96601bff, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, 30afa369-fe8e-462e-82d4-31507daad05b, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-17 20:22:19.447048, 2026-01-17 20:22:19.447048).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w10_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w9_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w7_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w9_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w7_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w11_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w2_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w2_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w11_v3 (Reused: true)

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681339899,"env":"test","module":"auth-routes","email":"test-1768681338959-n1ka8p@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mðŸ“Š Schema test_schema_w9_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681339998,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681339999,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w9_v3\",public on all connections"}
{"level":50,"time":1768681340024,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mðŸ“Š Schema test_schema_w7_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681340040,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681340041,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w7_v3\",public on all connections"}
{"level":30,"time":1768681340053,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768681340096,"env":"test","module":"auth-routes","email":"test-1768681338959-n1ka8p@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":30,"time":1768681340100,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mðŸ“Š Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681340136,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681340136,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w0_v3\",public on all connections"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mðŸ“Š Schema test_schema_w2_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681340169,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681340170,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w2_v3\",public on all connections"}
{"level":30,"time":1768681340194,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768681340220,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":30,"time":1768681340225,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768681340227,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mðŸ“Š Schema test_schema_w11_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681340279,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681340280,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w11_v3\",public on all connections"}
{"level":30,"time":1768681340357,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w7_v3, public

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w7_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w9_v3, public

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w5_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w0_v3, public

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w17_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w2_v3, public

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w17_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w2_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w5_v3
â© Schema reused, skipping migrations.

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return expired invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,e94b7dda-dfa7-4898-8a69-cb6ddc424263,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'e94b7dda-dfa7-4898-8a69-cb6ddc424263'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m521[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (d4d9358a-f27f-43d2-9ab2-18303a8a3890, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, e94b7dda-dfa7-4898-8a69-cb6ddc424263, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-17 20:22:21.279329, 2026-01-17 20:22:21.279329).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w11_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w11_v3, public

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w11_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681340903,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768681341082,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681341082,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mðŸ“Š Schema test_schema_w17_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681341127,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681341128,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w17_v3\",public on all connections"}
{"level":30,"time":1768681341179,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681341184,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681341184,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/auth.flows.real.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 13980[2mms[22m[39m
[31m       [31mÃ—[31m should complete registration, verify email, then login[39m[33m 453[2mms[22m[39m
[31m       [31mÃ—[31m should lock account after 5 failed attempts, then unlock after waiting[39m[33m 790[2mms[22m[39m
[31m       [31mÃ—[31m should record all login attempts[39m[33m 2585[2mms[22m[39m
[31m       [31mÃ—[31m should complete MFA setup and login with TOTP[39m[33m 1185[2mms[22m[39m
[31m       [31mÃ—[31m should login with backup code when TOTP unavailable[39m[33m 427[2mms[22m[39m
[31m       [31mÃ—[31m should complete full password reset flow[39m[33m 821[2mms[22m[39m
[31m       [31mÃ—[31m should invalidate all sessions after password reset[39m[33m 665[2mms[22m[39m
[31m       [31mÃ—[31m should rotate refresh token on each use[39m[33m 764[2mms[22m[39m
[31m       [31mÃ—[31m should detect and prevent refresh token reuse (token theft)[39m[33m 697[2mms[22m[39m
[31m       [31mÃ—[31m should list all active sessions[39m[33m 714[2mms[22m[39m
[31m       [31mÃ—[31m should revoke specific session[39m[33m 2123[2mms[22m[39m
 [31mâ¯[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 14150[2mms[22m[39m
[31m       [31mÃ—[31m should trust current device[39m[33m 633[2mms[22m[39m
[31m       [31mÃ—[31m should set trust expiry to 30 days[39m[33m 675[2mms[22m[39m
[31m       [31mÃ—[31m should update expiry if device already trusted[39m[33m 685[2mms[22m[39m
       [32mâœ“[39m should require authentication[32m 31[2mms[22m[39m
[31m       [31mÃ—[31m should list all trusted devices[39m[33m 743[2mms[22m[39m
[31m       [31mÃ—[31m should mark current device[39m[33m 974[2mms[22m[39m
[31m       [31mÃ—[31m should exclude revoked devices[39m[33m 1017[2mms[22m[39m
[31m       [31mÃ—[31m should exclude expired devices[39m[33m 1559[2mms[22m[39m
[31m       [31mÃ—[31m should revoke specific device[39m[33m 794[2mms[22m[39m
[31m       [31mÃ—[31m should return 404 for non-existent device[39m[33m 980[2mms[22m[39m
[31m       [31mÃ—[31m should prevent revoking other user's device[39m[33m 972[2mms[22m[39m
[31m       [31mÃ—[31m should skip MFA for trusted device[39m[33m 712[2mms[22m[39m
[31m       [31mÃ—[31m should require MFA for untrusted device[39m[33m 795[2mms[22m[39m
[31m       [31mÃ—[31m should update lastUsedAt on trusted device login[39m[33m 733[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w12_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w12_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w12_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w12_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w15_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w15_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768681341578,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681341578,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w4_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w4_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w17_v3, public

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768681341680,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
 [31mâ¯[39m tests/integration/auth/oauth2.token-refresh.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m25 failed[39m[2m)[22m[33m 14390[2mms[22m[39m
[31m       [31mÃ—[31m should refresh access token with valid refresh token[39m[32m 71[2mms[22m[39m
[31m       [31mÃ—[31m should rotate refresh token after use[39m[33m 464[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 when refresh token is missing[39m[33m 421[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for invalid refresh token[39m[33m 467[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for expired refresh token[39m[33m 472[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for revoked refresh token[39m[33m 380[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 when user is not found[39m[33m 472[2mms[22m[39m
[31m       [31mÃ—[31m should update refresh token metadata on rotation[39m[33m 493[2mms[22m[39m
[31m       [31mÃ—[31m should handle concurrent refresh token requests (token reuse detection)[39m[33m 467[2mms[22m[39m
[31m       [31mÃ—[31m should set secure cookie in production[39m[33m 387[2mms[22m[39m
[31m       [31mÃ—[31m should set proper cookie attributes[39m[33m 730[2mms[22m[39m
[31m       [31mÃ—[31m should include user role information in response[39m[33m 386[2mms[22m[39m
[31m       [31mÃ—[31m should create refresh token on login[39m[33m 471[2mms[22m[39m
[31m       [31mÃ—[31m should revoke refresh token on logout[39m[33m 483[2mms[22m[39m
[31m       [31mÃ—[31m should handle logout without refresh token gracefully[39m[33m 387[2mms[22m[39m
[31m       [31mÃ—[31m should support multiple active refresh tokens per user[39m[33m 383[2mms[22m[39m
[31m       [31mÃ—[31m should revoke all user tokens on password reset[39m[33m 469[2mms[22m[39m
[31m       [31mÃ—[31m should use cryptographically strong random tokens[39m[33m 422[2mms[22m[39m
[31m       [31mÃ—[31m should hash refresh tokens before storing in database[39m[33m 481[2mms[22m[39m
[31m       [31mÃ—[31m should prevent refresh token reuse after rotation[39m[33m 377[2mms[22m[39m
[31m       [31mÃ—[31m should validate token ownership[39m[33m 409[2mms[22m[39m
[31m       [31mÃ—[31m should set HttpOnly flag to prevent XSS[39m[33m 385[2mms[22m[39m
[31m       [31mÃ—[31m should set SameSite=Strict to prevent CSRF[39m[33m 377[2mms[22m[39m
[31m       [31mÃ—[31m should set proper cookie path[39m[33m 529[2mms[22m[39m
[31m       [31mÃ—[31m should set appropriate expiry (30 days)[39m[33m 470[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w0_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681341707,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768681341691,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681341692,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681341700,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681341701,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681341706,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681341707,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681341707,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681341707,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768681341733,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681341758,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768681341744,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681341744,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681341751,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681341751,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681341757,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681341757,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681341758,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681341758,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768681341835,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768681341860,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts[2m > [22m[2mDataVault v4 Regression Tests
[22m[39mðŸ“š API Documentation available at /api-docs

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768681341846,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681341847,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681341852,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681341852,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681341859,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681341860,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681341860,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681341860,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768681341936,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681341961,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768681341948,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681341949,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681341954,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681341955,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681341961,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681341961,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681341961,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681341961,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768681341970,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681341971,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould handle user with single session gracefully
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681342179,"env":"test","module":"auth-routes","email":"test-1768681341254-kd2nb@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

 [31mâ¯[39m tests/integration/datavault-v4-regression.test.ts [2m([22m[2m23 tests[22m[2m | [22m[33m23 skipped[39m[2m)[22m[33m 2831[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create a select column with options
       [2m[90mâ†“[39m[22m should create a multiselect column with options
       [2m[90mâ†“[39m[22m should validate select value against options
       [2m[90mâ†“[39m[22m should validate multiselect values as array
       [2m[90mâ†“[39m[22m should create an autonumber column with sequence
       [2m[90mâ†“[39m[22m should format autonumber with prefix
       [2m[90mâ†“[39m[22m should create a note for a row
       [2m[90mâ†“[39m[22m should get all notes for a row
       [2m[90mâ†“[39m[22m should delete a note
       [2m[90mâ†“[39m[22m should not allow deleting notes by other users
       [2m[90mâ†“[39m[22m should create an API token
       [2m[90mâ†“[39m[22m should validate API token scopes
       [2m[90mâ†“[39m[22m should revoke (delete) an API token
       [2m[90mâ†“[39m[22m should deny access with expired token
       [2m[90mâ†“[39m[22m should grant table permission
       [2m[90mâ†“[39m[22m should list table permissions
       [2m[90mâ†“[39m[22m should update table permission role
       [2m[90mâ†“[39m[22m should revoke table permission
       [2m[90mâ†“[39m[22m should enforce RBAC - only owners can manage permissions
       [2m[90mâ†“[39m[22m should paginate rows efficiently
       [2m[90mâ†“[39m[22m should return user-friendly error for invalid column type
       [2m[90mâ†“[39m[22m should return user-friendly error for missing required fields
       [2m[90mâ†“[39m[22m should handle network errors gracefully
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768681342295,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681342297,"env":"test","module":"user-credentials-repository","userId":"50a1d325-b07b-4467-ac95-817c0bf51bab","msg":"User credentials created"}
{"level":50,"time":1768681342303,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["4a619fd6-30d4-41f9-8ea9-33c90c6809d6","$2b$12$tnYgQiaYReunUVkGZx9JdO2pBfsqF9iNXpu2.LYVSL3Jf7Ez8H95y"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(4a619fd6-30d4-41f9-8ea9-33c90c6809d6) is not present in table \"users\".","schema":"test_schema_w17_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"4a619fd6-30d4-41f9-8ea9-33c90c6809d6","msg":"Failed to create user credentials"}
{"level":50,"time":1768681342303,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["4a619fd6-30d4-41f9-8ea9-33c90c6809d6","$2b$12$tnYgQiaYReunUVkGZx9JdO2pBfsqF9iNXpu2.LYVSL3Jf7Ez8H95y"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(4a619fd6-30d4-41f9-8ea9-33c90c6809d6) is not present in table \"users\".","schema":"test_schema_w17_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/session.management.integration.test.ts:31:15

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681342321,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768681342318,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681342319,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":50,"time":1768681342327,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768681342306,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681342306,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681342314,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681342314,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681342320,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681342320,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681342320,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681342320,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould handle user with single session gracefully
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768681342404,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["50a1d325-b07b-4467-ac95-817c0bf51bab","fad67b7b0d4ad2f515b0bf87b52b6fd518d43d119d79ec94b088ad6987a29012","2026-01-18T20:22:22.298Z"],"cause":{"length":383,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(50a1d325-b07b-4467-ac95-817c0bf51bab) is not present in table \"users\".","schema":"test_schema_w17_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/auth.middleware.integration.test.ts:35:15

{"level":30,"time":1768681342419,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681342420,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768681342496,"env":"test","module":"user-credentials-repository","userId":"0993c946-1396-453b-8dc4-0e923098a00f","msg":"User credentials created"}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w0_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w5_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w0_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768681342572,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["0993c946-1396-453b-8dc4-0e923098a00f","0e2c09a5522b3629e7eda07cfc978be1a614e71f24de3d7c7a3f788186f328b2","2026-01-18T20:22:22.497Z"],"cause":{"length":383,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(0993c946-1396-453b-8dc4-0e923098a00f) is not present in table \"users\".","schema":"test_schema_w15_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

{"level":30,"time":1768681342590,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w5_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681342590,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/auth/session.management.integration.test.ts [2m([22m[2m18 tests[22m[2m | [22m[33m18 skipped[39m[2m)[22m[33m 3168[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create refresh token on login
       [2m[90mâ†“[39m[22m should track device metadata in session
       [2m[90mâ†“[39m[22m should create separate sessions for multiple device logins
       [2m[90mâ†“[39m[22m should list all active sessions for user
       [2m[90mâ†“[39m[22m should mark current session correctly
       [2m[90mâ†“[39m[22m should not include revoked sessions
       [2m[90mâ†“[39m[22m should order sessions by last used (most recent first)
       [2m[90mâ†“[39m[22m should require authentication
       [2m[90mâ†“[39m[22m should revoke specific session
       [2m[90mâ†“[39m[22m should prevent revoking current session
       [2m[90mâ†“[39m[22m should not allow revoking other users sessions
       [2m[90mâ†“[39m[22m should return 404 for non-existent session ID
       [2m[90mâ†“[39m[22m should revoke all sessions except current
       [2m[90mâ†“[39m[22m should revoke all trusted devices
       [2m[90mâ†“[39m[22m should require active session
       [2m[90mâ†“[39m[22m should reject refresh token after 30 days
       [2m[90mâ†“[39m[22m should handle multiple concurrent logins
       [2m[90mâ†“[39m[22m should handle concurrent token refreshes
 [31mâ¯[39m tests/integration/auth/auth.middleware.integration.test.ts [2m([22m[2m27 tests[22m[2m | [22m[33m27 skipped[39m[2m)[22m[33m 3247[2mms[22m[39m
       [2m[90mâ†“[39m[22m should allow access with valid JWT Bearer token
       [2m[90mâ†“[39m[22m should return 401 when no token provided
       [2m[90mâ†“[39m[22m should return 401 with invalid token
       [2m[90mâ†“[39m[22m should return 401 with expired token
       [2m[90mâ†“[39m[22m should proceed without authentication if no token provided
       [2m[90mâ†“[39m[22m should authenticate with JWT Bearer token
       [2m[90mâ†“[39m[22m should authenticate with refresh token cookie (GET only)
       [2m[90mâ†“[39m[22m should reject cookie auth for POST requests (mutation-strict)
       [2m[90mâ†“[39m[22m should reject cookie auth for PUT requests
       [2m[90mâ†“[39m[22m should reject cookie auth for DELETE requests
       [2m[90mâ†“[39m[22m should allow cookie auth for HEAD requests
       [2m[90mâ†“[39m[22m should prioritize JWT over cookie when both present
       [2m[90mâ†“[39m[22m should return 401 when no auth provided
       [2m[90mâ†“[39m[22m should return 401 when both JWT and cookie are invalid
       [2m[90mâ†“[39m[22m should authenticate with JWT if provided
       [2m[90mâ†“[39m[22m should authenticate with cookie if JWT not provided
       [2m[90mâ†“[39m[22m should proceed anonymously if no auth provided
       [2m[90mâ†“[39m[22m should proceed anonymously if both JWT and cookie are invalid
       [2m[90mâ†“[39m[22m should only allow safe methods for cookie auth
       [2m[90mâ†“[39m[22m should ignore cookies when Bearer token present
       [2m[90mâ†“[39m[22m should attach userId to request
       [2m[90mâ†“[39m[22m should attach userEmail to request
       [2m[90mâ†“[39m[22m should return consistent error format for missing token
       [2m[90mâ†“[39m[22m should return consistent error format for invalid token
       [2m[90mâ†“[39m[22m should return consistent error format for expired token
       [2m[90mâ†“[39m[22m should handle malformed JWT gracefully
       [2m[90mâ†“[39m[22m should handle JWT with wrong algorithm
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768681342996,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b651baf7-5efe-4d6b-8e5d-21eefd1b028f","$2b$12$/dVRlmdO39I8CTHSA/1WXujYafvAQIVcv/pzbQuAI.teESVa1AWHW"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b651baf7-5efe-4d6b-8e5d-21eefd1b028f) is not present in table \"users\".","schema":"test_schema_w15_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"b651baf7-5efe-4d6b-8e5d-21eefd1b028f","msg":"Failed to create user credentials"}
{"level":50,"time":1768681342996,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b651baf7-5efe-4d6b-8e5d-21eefd1b028f","$2b$12$/dVRlmdO39I8CTHSA/1WXujYafvAQIVcv/pzbQuAI.teESVa1AWHW"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b651baf7-5efe-4d6b-8e5d-21eefd1b028f) is not present in table \"users\".","schema":"test_schema_w15_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/jwt.authentication.test.ts:31:15

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681343012,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681343012,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/auth/protected.routes.test.ts [2m([22m[2m33 tests[22m[2m | [22m[33m33 skipped[39m[2m)[22m[33m 3308[2mms[22m[39m
       [2m[90mâ†“[39m[22m should allow access with valid Bearer token
       [2m[90mâ†“[39m[22m should reject access without Authorization header
       [2m[90mâ†“[39m[22m should reject access with empty Bearer token
       [2m[90mâ†“[39m[22m should reject access with malformed Authorization header
       [2m[90mâ†“[39m[22m should reject access with wrong token type
       [2m[90mâ†“[39m[22m should allow POST with valid Bearer token
       [2m[90mâ†“[39m[22m should reject POST without Bearer token
       [2m[90mâ†“[39m[22m should reject POST with invalid token
       [2m[90mâ†“[39m[22m should allow PUT with valid Bearer token
       [2m[90mâ†“[39m[22m should reject PUT without Bearer token
       [2m[90mâ†“[39m[22m should allow DELETE with valid Bearer token
       [2m[90mâ†“[39m[22m should reject DELETE without Bearer token
       [2m[90mâ†“[39m[22m should allow PATCH with valid Bearer token
       [2m[90mâ†“[39m[22m should reject PATCH without Bearer token
       [2m[90mâ†“[39m[22m should handle Bearer token with extra spaces
       [2m[90mâ†“[39m[22m should handle token with newlines
       [2m[90mâ†“[39m[22m should handle very long invalid token
       [2m[90mâ†“[39m[22m should handle empty Authorization header
       [2m[90mâ†“[39m[22m should handle Authorization header with only Bearer
       [2m[90mâ†“[39m[22m should handle multiple Authorization headers
       [2m[90mâ†“[39m[22m should reject token with SQL injection attempt
       [2m[90mâ†“[39m[22m should reject token with XSS attempt
       [2m[90mâ†“[39m[22m should reject token with missing userId
       [2m[90mâ†“[39m[22m should reject token with non-existent userId
       [2m[90mâ†“[39m[22m should not allow user to access another user's resources
       [2m[90mâ†“[39m[22m should inject userId into request context
       [2m[90mâ†“[39m[22m should inject tenantId into request context
       [2m[90mâ†“[39m[22m should inject role into request context
       [2m[90mâ†“[39m[22m should not apply general rate limiting to authenticated requests
       [2m[90mâ†“[39m[22m should handle request with both Bearer token and cookies
       [2m[90mâ†“[39m[22m should prioritize Bearer token over cookie when both present
       [2m[90mâ†“[39m[22m should allow unauthenticated access to optional auth routes
       [2m[90mâ†“[39m[22m should enhance optional auth routes with user context when authenticated
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

 [31mâ¯[39m tests/integration/auth/jwt.authentication.test.ts [2m([22m[2m27 tests[22m[2m | [22m[33m27 skipped[39m[2m)[22m[33m 3757[2mms[22m[39m
       [2m[90mâ†“[39m[22m should generate valid JWT token on successful login
       [2m[90mâ†“[39m[22m should include correct payload in JWT token
       [2m[90mâ†“[39m[22m should set JWT expiry to 15 minutes
       [2m[90mâ†“[39m[22m should accept valid JWT token on protected routes
       [2m[90mâ†“[39m[22m should reject request without authorization header
       [2m[90mâ†“[39m[22m should reject request with malformed token
       [2m[90mâ†“[39m[22m should accept request with missing Bearer prefix (lenient)
       [2m[90mâ†“[39m[22m should reject token with invalid signature
       [2m[90mâ†“[39m[22m should reject expired JWT token
       [2m[90mâ†“[39m[22m should return token_expired error code for expired tokens
       [2m[90mâ†“[39m[22m should authenticate with Bearer token in Authorization header
       [2m[90mâ†“[39m[22m should work with Bearer token on POST requests
       [2m[90mâ†“[39m[22m should work with Bearer token on PUT requests
       [2m[90mâ†“[39m[22m should work with Bearer token on DELETE requests
       [2m[90mâ†“[39m[22m should exchange valid session cookie for JWT token
       [2m[90mâ†“[39m[22m should reject token exchange without valid cookie
       [2m[90mâ†“[39m[22m should prefer Bearer token over cookie when both present
       [2m[90mâ†“[39m[22m should fall back to cookie if Bearer token is invalid
       [2m[90mâ†“[39m[22m should allow GET requests with cookie auth only
       [2m[90mâ†“[39m[22m should reject POST requests with cookie auth only (mutation-strict)
       [2m[90mâ†“[39m[22m should allow anonymous access to public workflows
       [2m[90mâ†“[39m[22m should attach user info if authenticated on optional auth routes
       [2m[90mâ†“[39m[22m should refresh access token using refresh token
       [2m[90mâ†“[39m[22m should rotate refresh token on use
       [2m[90mâ†“[39m[22m should detect token reuse and revoke all user tokens
       [2m[90mâ†“[39m[22m should revoke refresh token on logout
       [2m[90mâ†“[39m[22m should clear refresh token cookie on logout
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould include device metadata in sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould allow admin to revoke invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,d692045a-2392-430b-a1f6-88679e49ae13,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'd692045a-2392-430b-a1f6-88679e49ae13'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m516[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (b8aa9511-35a7-401e-b1e7-0f6b17501656, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, d692045a-2392-430b-a1f6-88679e49ae13, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-17 20:22:23.9591, 2026-01-17 20:22:23.9591).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w5_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768681343558,"env":"test","module":"auth-routes","email":"test-1768681343032-4mdpfs@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w18_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":50,"time":1768681343711,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1768681343720,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould include device metadata in sessions
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w18_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w16_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w16_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mðŸ“Š Schema test_schema_w18_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681344172,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681344173,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w18_v3\",public on all connections"}
{"level":30,"time":1768681344232,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould require correct password to disable MFA
[22m[39m[TEST UTILS] MFA Secret verified for c0b2add683b4c42d54398e8a603b6881

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mðŸ“Š Schema test_schema_w16_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681344467,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681344468,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w16_v3\",public on all connections"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681344567,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mGET /api/auth/me[2m > [22m[2mshould return current user for valid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681344663,"env":"test","module":"auth-routes","email":"test-1768681343673-cxygo8@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w18_v3, public

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w18_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould prevent accepting revoked invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,c115227a-c710-417a-bc5e-f24e865a79ca,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'c115227a-c710-417a-bc5e-f24e865a79ca'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m521[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (0a09de98-d4ab-4ff9-8032-7569b6641c10, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, c115227a-c710-417a-bc5e-f24e865a79ca, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-17 20:22:25.230618, 2026-01-17 20:22:25.230618).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w18_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768681344785,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mGET /api/auth/me[2m > [22m[2mshould return current user for valid token
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768681344793,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w16_v3, public

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w16_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681345154,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681345154,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w22_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [31mâ¯[39m tests/integration/organizationInvites.test.ts [2m([22m[2m17 tests[22m[2m | [22m[31m16 failed[39m[2m)[22m[33m 22317[2mms[22m[39m
[31m       [31mÃ—[31m should create placeholder user for non-existent email[39m[33m 2768[2mms[22m[39m
[31m       [31mÃ—[31m should create invite for existing user without creating placeholder[39m[33m 1073[2mms[22m[39m
[31m       [31mÃ—[31m should prevent duplicate pending invites[39m[33m 1166[2mms[22m[39m
[31m       [31mÃ—[31m should prevent inviting existing members[39m[33m 704[2mms[22m[39m
[31m       [31mÃ—[31m should require admin access to create invite[39m[33m 666[2mms[22m[39m
[31m       [31mÃ—[31m should set expiry to 7 days from now[39m[33m 720[2mms[22m[39m
[31m       [31mÃ—[31m should accept invite and create membership[39m[33m 609[2mms[22m[39m
[31m       [31mÃ—[31m should convert placeholder user to real user on accept[39m[33m 574[2mms[22m[39m
[31m       [31mÃ—[31m should reject expired invite[39m[33m 1109[2mms[22m[39m
[31m       [31mÃ—[31m should reject already accepted invite[39m[33m 1918[2mms[22m[39m
[31m       [31mÃ—[31m should verify email matches invite[39m[33m 1268[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject invalid token [33m 1305[2mms[22m[39m
[31m       [31mÃ—[31m should return pending invites for user email[39m[33m 531[2mms[22m[39m
[31m       [31mÃ—[31m should not return expired invites[39m[33m 1385[2mms[22m[39m
[31m       [31mÃ—[31m should not return accepted invites[39m[33m 1056[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to revoke invite[39m[33m 1609[2mms[22m[39m
[31m       [31mÃ—[31m should prevent accepting revoked invite[39m[33m 1224[2mms[22m[39m
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w22_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w21_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w21_v3 (Reused: true)

{"level":50,"time":1768681345502,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768681345508,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681345570,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681345570,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mðŸ“Š Schema test_schema_w22_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

 [31mâ¯[39m tests/integration/session.management.real.test.ts [2m([22m[2m18 tests[22m[2m | [22m[31m17 failed[39m[2m)[22m[33m 18536[2mms[22m[39m
[31m       [31mÃ—[31m should list all active sessions for current user[39m[33m 410[2mms[22m[39m
[31m       [31mÃ—[31m should mark current session correctly[39m[33m 714[2mms[22m[39m
[31m       [31mÃ—[31m should exclude revoked sessions[39m[33m 846[2mms[22m[39m
[31m       [31mÃ—[31m should order sessions by last used (most recent first)[39m[33m 2593[2mms[22m[39m
[31m       [31mÃ—[31m should filter sessions by current user only[39m[33m 379[2mms[22m[39m
       [32mâœ“[39m should return 401 for unauthenticated request[32m 10[2mms[22m[39m
[31m       [31mÃ—[31m should revoke specific session[39m[33m 677[2mms[22m[39m
[31m       [31mÃ—[31m should prevent revoking current session[39m[33m 1608[2mms[22m[39m
[31m       [31mÃ—[31m should return 404 for non-existent session[39m[33m 440[2mms[22m[39m
[31m       [31mÃ—[31m should prevent revoking other user's session[39m[33m 680[2mms[22m[39m
[31m       [31mÃ—[31m should revoke all other sessions[39m[33m 681[2mms[22m[39m
[31m       [31mÃ—[31m should keep current session active[39m[33m 805[2mms[22m[39m
[31m       [31mÃ—[31m should return 400 if no active session found[39m[33m 768[2mms[22m[39m
[31m       [31mÃ—[31m should revoke all trusted devices[39m[33m 784[2mms[22m[39m
[31m       [31mÃ—[31m should handle user with single session gracefully[39m[33m 1779[2mms[22m[39m
[31m       [31mÃ—[31m should include device metadata in sessions[39m[33m 1396[2mms[22m[39m
[31m       [31mÃ—[31m should not expose sensitive token data[39m[33m 361[2mms[22m[39m
[31m       [31mÃ—[31m should track session activity timestamps[39m[33m 782[2mms[22m[39m
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w17_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w17_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w17_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w17_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w25_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mðŸ“Š Schema test_schema_w21_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681345994,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681345995,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w21_v3\",public on all connections"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w25_v3 (Reused: true)

{"level":30,"time":1768681346051,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w24_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768681346101,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768681346123,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w24_v3 (Reused: true)

{"level":30,"time":1768681346149,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768681346135,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681346136,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681346142,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681346142,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681346149,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681346149,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681346149,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681346149,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w22_v3, public

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w22_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w21_v3, public

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mðŸ“Š Schema test_schema_w25_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681346538,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681346539,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w25_v3\",public on all connections"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mðŸ“Š Schema test_schema_w24_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681346571,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681346572,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w24_v3\",public on all connections"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w20_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w21_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681346596,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w20_v3 (Reused: true)

{"level":30,"time":1768681346637,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768681346697,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["cb616645-e9dc-4274-bb92-37e9e68364c1","$2b$12$AA8AScaKj8qo5U.7wC0PGOM7EoojUaASkBxw5q1.dTJvtxWq0AYxC"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(cb616645-e9dc-4274-bb92-37e9e68364c1) is not present in table \"users\".","schema":"test_schema_w3_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"cb616645-e9dc-4274-bb92-37e9e68364c1","msg":"Failed to create user credentials"}
{"level":50,"time":1768681346698,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["cb616645-e9dc-4274-bb92-37e9e68364c1","$2b$12$AA8AScaKj8qo5U.7wC0PGOM7EoojUaASkBxw5q1.dTJvtxWq0AYxC"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(cb616645-e9dc-4274-bb92-37e9e68364c1) is not present in table \"users\".","schema":"test_schema_w3_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at Module.setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.workflows.test.ts:42:11

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681346712,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681346713,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould reject invalid MFA code
[22m[39m[TEST UTILS] MFA Secret verified for 8a716e6f0b92a8b0f5dd083cac83d27e

{"level":30,"time":1768681346959,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681346960,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768681346964,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681346965,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

 [31mâ¯[39m tests/integration/api.workflows.test.ts [2m([22m[2m17 tests[22m[2m | [22m[33m17 skipped[39m[2m)[22m[33m 3268[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create a new draft workflow
       [2m[90mâ†“[39m[22m should reject without permission
       [2m[90mâ†“[39m[22m should list workflows
       [2m[90mâ†“[39m[22m should filter by status
       [2m[90mâ†“[39m[22m should search by name
       [2m[90mâ†“[39m[22m should update draft workflow
       [2m[90mâ†“[39m[22m should not allow editing published workflow
       [2m[90mâ†“[39m[22m should publish workflow
       [2m[90mâ†“[39m[22m should list workflow versions
       [2m[90mâ†“[39m[22m should move workflow to a project
       [2m[90mâ†“[39m[22m should move workflow to Main Folder (projectId = null)
       [2m[90mâ†“[39m[22m should reject move to non-existent project
       [2m[90mâ†“[39m[22m should reject move without authentication
       [2m[90mâ†“[39m[22m should reject move of workflow user does not own
       [2m[90mâ†“[39m[22m should reject move with invalid projectId format
       [2m[90mâ†“[39m[22m should reject move without projectId in body
       [2m[90mâ†“[39m[22m should reject move to project user does not have access to
 [31mâ¯[39m tests/unit/services/WorkflowTemplateService.test.ts [2m([22m[2m21 tests[22m[2m | [22m[31m21 failed[39m[2m)[22m[33m 17340[2mms[22m[39m
[31m       [31mÃ—[31m should throw error if template belongs to different project[39m[33m 580[2mms[22m[39m
[31m       [31mÃ—[31m should automatically unset other primaries when setting new primary[39m[33m 682[2mms[22m[39m
[31m         [31mÃ—[31m should list all templates for workflow version[39m[33m 767[2mms[22m[39m
[31m         [31mÃ—[31m should return empty array for version with no templates[39m[33m 749[2mms[22m[39m
[31m         [31mÃ—[31m should get template mapping by id and version[39m[33m 765[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if mapping not found[39m[33m 649[2mms[22m[39m
[31m         [31mÃ—[31m should get template by key[39m[33m 675[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if key not found[39m[33m 583[2mms[22m[39m
[31m         [31mÃ—[31m should get primary template for workflow version[39m[33m 697[2mms[22m[39m
[31m         [31mÃ—[31m should return null when no primary template exists[39m[33m 591[2mms[22m[39m
[31m         [31mÃ—[31m should update mapping key[39m[33m 695[2mms[22m[39m
[31m         [31mÃ—[31m should update isPrimary flag[39m[33m 862[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if new key already exists[39m[33m 606[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if mapping not found[39m[33m 666[2mms[22m[39m
[31m         [31mÃ—[31m should unset other primaries when setting isPrimary to true[39m[33m 892[2mms[22m[39m
[31m         [31mÃ—[31m should detach template from workflow version[39m[33m 993[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if mapping not found[39m[33m 621[2mms[22m[39m
[31m         [31mÃ—[31m should set template as primary[39m[33m 755[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if mapping not found[39m[33m 521[2mms[22m[39m
[31m         [31mÃ—[31m should support operations within a transaction[39m[33m 516[2mms[22m[39m
[31m         [31mÃ—[31m should rollback on transaction error[39m[33m 509[2mms[22m[39m
 [31mâ¯[39m tests/integration/organizations-audit-fixes.test.ts [2m([22m[2m8 tests[22m[2m | [22m[33m8 skipped[39m[2m)[22m[33m 3764[2mms[22m[39m
       [2m[90mâ†“[39m[22m should cascade ownership to workflow runs when project is transferred
       [2m[90mâ†“[39m[22m should prevent double-acceptance via transaction
       [2m[90mâ†“[39m[22m should not create invite if email fails
       [2m[90mâ†“[39m[22m should allow re-invite after invite expires
       [2m[90mâ†“[39m[22m should allow last admin to delete empty organization
       [2m[90mâ†“[39m[22m should prevent deletion if org owns assets
       [2m[90mâ†“[39m[22m should cleanup placeholder user when invite is revoked
       [2m[90mâ†“[39m[22m should fail fast on non-existent org
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w25_v3, public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681347083,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681347083,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w24_v3, public

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w21_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mðŸ“Š Schema test_schema_w20_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681347130,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681347131,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w20_v3\",public on all connections"}
{"level":30,"time":1768681347174,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681347174,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w25_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768681347193,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

 [31mâ¯[39m tests/integration/mfa.flow.real.test.ts [2m([22m[2m20 tests[22m[2m | [22m[31m20 failed[39m[2m)[22m[33m 19866[2mms[22m[39m
[31m       [31mÃ—[31m should complete full MFA setup flow[39m[33m 355[2mms[22m[39m
[31m       [31mÃ—[31m should reject invalid TOTP code during setup[39m[33m 863[2mms[22m[39m
[31m       [31mÃ—[31m should not allow MFA setup if already enabled[39m[33m 982[2mms[22m[39m
[31m       [31mÃ—[31m should generate unique backup codes[39m[33m 814[2mms[22m[39m
[31m       [31mÃ—[31m should store hashed backup codes[39m[33m 2160[2mms[22m[39m
[31m       [31mÃ—[31m should require MFA for enabled users[39m[33m 561[2mms[22m[39m
[31m       [31mÃ—[31m should complete MFA login with valid TOTP[39m[33m 914[2mms[22m[39m
[31m       [31mÃ—[31m should reject invalid TOTP during login[39m[33m 809[2mms[22m[39m
[31m       [31mÃ—[31m should accept TOTP codes within 60-second window[39m[33m 844[2mms[22m[39m
[31m       [31mÃ—[31m should login with valid backup code[39m[33m 673[2mms[22m[39m
[31m       [31mÃ—[31m should mark backup code as used[39m[33m 797[2mms[22m[39m
[31m       [31mÃ—[31m should prevent backup code reuse[39m[33m 700[2mms[22m[39m
[31m       [31mÃ—[31m should try TOTP before backup code[39m[33m 804[2mms[22m[39m
[31m       [31mÃ—[31m should return MFA status for user[39m[33m 754[2mms[22m[39m
[31m       [31mÃ—[31m should return backup codes count for MFA users[39m[33m 962[2mms[22m[39m
[31m       [31mÃ—[31m should disable MFA with password verification[39m[33m 434[2mms[22m[39m
[31m       [31mÃ—[31m should require correct password to disable MFA[39m[33m 1462[2mms[22m[39m
[31m       [31mÃ—[31m should regenerate backup codes[39m[33m 783[2mms[22m[39m
[31m       [31mÃ—[31m should return error if MFA not enabled[39m[33m 738[2mms[22m[39m
[31m       [31mÃ—[31m should enforce MFA for tenant users when required by tenant[39m[33m 764[2mms[22m[39m
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w15_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w15_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [31mâ¯[39m tests/integration/auth.routes.real.test.ts [2m([22m[2m26 tests[22m[2m | [22m[31m18 failed[39m[2m)[22m[33m 20063[2mms[22m[39m
[31m       [31mÃ—[31m should register a new user successfully[39m[33m 502[2mms[22m[39m
       [32mâœ“[39m should return 400 for invalid email format[32m 8[2mms[22m[39m
       [32mâœ“[39m should return 400 for weak password[32m 57[2mms[22m[39m
[31m       [31mÃ—[31m should return 409 for duplicate email[39m[33m 1614[2mms[22m[39m
[31m       [31mÃ—[31m should set httpOnly refresh token cookie[39m[33m 769[2mms[22m[39m
[31m       [31mÃ—[31m should login with valid credentials[39m[33m 1834[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for invalid password[39m[33m 409[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 for non-existent user [33m 610[2mms[22m[39m
[31m       [31mÃ—[31m should return 403 for unverified email[39m[33m 1083[2mms[22m[39m
[31m       [31mÃ—[31m should record failed login attempt[39m[33m 453[2mms[22m[39m
[31m       [31mÃ—[31m should return requiresMfa=true for MFA-enabled users[39m[33m 877[2mms[22m[39m
[31m       [31mÃ—[31m should lock account after 5 failed attempts[39m[33m 826[2mms[22m[39m
[31m       [31mÃ—[31m should logout and clear refresh token cookie[39m[33m 801[2mms[22m[39m
[31m       [31mÃ—[31m should refresh access token with valid refresh token[39m[33m 714[2mms[22m[39m
       [32mâœ“[39m should return 401 for missing refresh token[32m 6[2mms[22m[39m
[31m       [31mÃ—[31m should rotate refresh token after use[39m[33m 828[2mms[22m[39m
[31m       [31mÃ—[31m should send password reset email for existing user[39m[33m 735[2mms[22m[39m
       [33m[2mâœ“[22m[39m should not reveal if email exists (security) [33m 478[2mms[22m[39m
[31m       [31mÃ—[31m should reset password with valid token[39m[33m 426[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 400 for invalid token [33m 400[2mms[22m[39m
[31m       [31mÃ—[31m should return 400 for weak new password[39m[33m 343[2mms[22m[39m
[31m       [31mÃ—[31m should return current user for valid token[39m[33m 1826[2mms[22m[39m
       [32mâœ“[39m should return 401 for missing token[32m 6[2mms[22m[39m
       [32mâœ“[39m should return 401 for invalid token[32m 6[2mms[22m[39m
[31m         [31mÃ—[31m should complete MFA login with valid TOTP code[39m[33m 361[2mms[22m[39m
[31m         [31mÃ—[31m should reject invalid MFA code[39m[33m 1302[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w26_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w20_v3, public

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w21_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w21_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w26_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w25_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w25_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w25_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681347969,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681347969,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

 [32mâœ“[39m tests/integration/datavault.api-tokens.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 3017[2mms[22m[39m
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mðŸ“Š Schema test_schema_w26_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681348105,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681348106,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w26_v3\",public on all connections"}
{"level":30,"time":1768681348170,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681348248,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w20_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w20_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w26_v3, public

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w22_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768681348919,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681348919,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

 [31mâ¯[39m tests/integration/organizations-workflow.test.ts [2m([22m[2m23 tests[22m[2m | [22m[33m23 skipped[39m[2m)[22m[33m 3379[2mms[22m[39m
       [2m[90mâ†“[39m[22m Step 1: Create organization
       [2m[90mâ†“[39m[22m Step 2: Invite member via email
       [2m[90mâ†“[39m[22m Step 3: Accept invite
       [2m[90mâ†“[39m[22m Step 4: Create workflow owned by user
       [2m[90mâ†“[39m[22m Step 5: Transfer workflow to organization
       [2m[90mâ†“[39m[22m Step 6: Org member (user2) can access workflow
       [2m[90mâ†“[39m[22m Step 7: Org member (user2) can update workflow
       [2m[90mâ†“[39m[22m Step 8: Org admin (user1) can still access workflow after transfer
       [2m[90mâ†“[39m[22m Step 9: Non-member (user3) CANNOT access org workflow
       [2m[90mâ†“[39m[22m Step 10: Non-member (user3) CANNOT update org workflow
       [2m[90mâ†“[39m[22m Step 11: Non-member (user3) CANNOT transfer org workflow
       [2m[90mâ†“[39m[22m Step 12: Org member can see workflow in list
       [2m[90mâ†“[39m[22m Step 13: Non-member CANNOT see workflow in list
       [2m[90mâ†“[39m[22m Step 14: Remove member from org
       [2m[90mâ†“[39m[22m Step 15: Removed member (user2) can no longer access workflow
       [2m[90mâ†“[39m[22m Step 16: Re-add member and verify access restored
       [2m[90mâ†“[39m[22m Cannot invite same email twice (pending invite exists)
       [2m[90mâ†“[39m[22m Cannot accept expired invite
       [2m[90mâ†“[39m[22m Cannot transfer workflow to org user is not a member of
       [2m[90mâ†“[39m[22m Member cannot promote themselves to admin
       [2m[90mâ†“[39m[22m Member cannot remove admin
       [2m[90mâ†“[39m[22m Only members can view organization details
       [2m[90mâ†“[39m[22m Only members can view organization members list
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":50,"time":1768681349222,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["Hl7eeXhnmBFYFHRKXJBQR","$2b$12$4QRa0x6AaomNhBEL6GdDsuU.pzqmMxpcyXqf.RaIEVNhkgOjzN64u"],"cause":{"length":332,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(Hl7eeXhnmBFYFHRKXJBQR) is not present in table \"users\".","schema":"test_schema_w26_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"Hl7eeXhnmBFYFHRKXJBQR","msg":"Failed to create user credentials"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w30_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w30_v3 (Reused: true)

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w26_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w26_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mðŸ“Š Schema test_schema_w30_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstderr[2m | tests/unit/services/AuthService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17[90m)[39m
    at Object.get [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:176:34
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m {
  codeFrame: [32m'vi.mock(import("../../../server/db"), async (importOriginal) => {\n'[39m +
    [32m'  const actual = await importOriginal()\n'[39m +
    [32m'  return {\n'[39m +
    [32m'    ...actual,\n'[39m +
    [32m'    // your mocked methods\n'[39m +
    [32m'  }\n'[39m +
    [32m'})'[39m
}

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w32_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w32_v3 (Reused: true)

{"level":30,"time":1768681350266,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mðŸ“Š Schema test_schema_w32_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681350674,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681350675,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w32_v3\",public on all connections"}
{"level":30,"time":1768681350728,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w29_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w29_v3 (Reused: true)

{"level":30,"time":1768681350869,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681350870,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/ai/workflowEdit.test.ts [2m([22m[2m8 tests[22m[2m | [22m[33m8 skipped[39m[2m)[22m[33m 3719[2mms[22m[39m
     [2m[90mâ†“[39m[22m should create draft version on successful AI edit
     [2m[90mâ†“[39m[22m should enforce draft mode (revert active workflow to draft)
     [2m[90mâ†“[39m[22m should not create version when no changes detected (checksum match)
     [2m[90mâ†“[39m[22m should reject unauthorized access
     [2m[90mâ†“[39m[22m should reject unsafe DataVault operations
     [2m[90mâ†“[39m[22m should handle multi-operation edits with tempId resolution
     [2m[90mâ†“[39m[22m should create BEFORE and AFTER snapshots
     [2m[90mâ†“[39m[22m should rollback on validation failure
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w31_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w31_v3 (Reused: true)

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w34_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w34_v3 (Reused: true)

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w32_v3, public

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mðŸ“Š Schema test_schema_w29_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681351271,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681351272,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w29_v3\",public on all connections"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w32_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681351329,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w27_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w19_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w27_v3 (Reused: true)

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mðŸ“Š Schema test_schema_w31_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681351594,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681351595,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w31_v3\",public on all connections"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w19_v3 (Reused: true)

[90mstderr[2m | tests/unit/engine/templateNode.test.ts[2m > [22m[2mTemplate Node - Multi-Template Support[2m > [22m[2mLegacy Template ID Path (Backward Compatibility)[2m > [22m[2mshould resolve template by templateId directly
[22m[39mCleanup warning: DrizzleQueryError: Failed query: delete from "tenants" where "tenants"."id" in ($1)
params: d481c87f-ae48-442b-87fc-5ad059f7a64d
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at TestFactory.cleanup (C:/Users/scoot/poll/VaultLogic/tests/helpers/testFactory.ts:446:9)
    at C:/Users/scoot/poll/VaultLogic/tests/unit/engine/templateNode.test.ts:125:5 {
  query: [32m'delete from "tenants" where "tenants"."id" in ($1)'[39m,
  params: [ [32m'd481c87f-ae48-442b-87fc-5ad059f7a64d'[39m ],
  cause: error: update or delete on table "users" violates foreign key constraint "workflow_versions_created_by_users_id_fk" on table "workflow_versions"
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at TestFactory.cleanup (C:/Users/scoot/poll/VaultLogic/tests/helpers/testFactory.ts:446:9)
      at C:/Users/scoot/poll/VaultLogic/tests/unit/engine/templateNode.test.ts:125:5 {
    length: [33m388[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23503'[39m,
    detail: [32m'Key (id)=(91231484-d6e1-4b47-9ebb-72401fe11616) is still referenced from table "workflow_versions".'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w22_v3'[39m,
    table: [32m'workflow_versions'[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [32m'workflow_versions_created_by_users_id_fk'[39m,
    file: [32m'ri_triggers.c'[39m,
    line: [32m'2612'[39m,
    routine: [32m'ri_ReportViolation'[39m
  }
}

{"level":30,"time":1768681351652,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w29_v3, public

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mðŸ“Š Schema test_schema_w34_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681351715,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681351716,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w34_v3\",public on all connections"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w17_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681351767,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mðŸ“Š Schema test_schema_w27_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681351984,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681351985,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w27_v3\",public on all connections"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mðŸ“Š Schema test_schema_w19_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681352011,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681352012,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w19_v3\",public on all connections"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w31_v3, public

{"level":30,"time":1768681352042,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681352077,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w31_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w34_v3, public

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w12_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w22_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w22_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w27_v3, public

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w27_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w19_v3, public

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w27_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w27_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w31_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w23_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w23_v3 (Reused: true)

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w31_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w31_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681353321,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681353322,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/externalSends.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 3646[2mms[22m[39m
     [2m[90mâ†“[39m[22m PREVIEW MODE: Should simulate send and NOT call fetch
     [2m[90mâ†“[39m[22m LIVE MODE: Should call fetch with mapped payload
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w32_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w32_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mðŸ“Š Schema test_schema_w23_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681353544,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681353544,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w23_v3\",public on all connections"}
{"level":30,"time":1768681353553,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768681353553,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768681353599,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w29_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w29_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [31mâ¯[39m tests/integration/workflows/runtime-pipelines.test.ts [2m([22m[2m4 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[33m 3211[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create DataVault row on workflow completion
       [2m[90mâ†“[39m[22m should execute writebacks via RunService.completeRun()
       [2m[90mâ†“[39m[22m should skip document generation when visibleIf condition is false
       [2m[90mâ†“[39m[22m should generate document when visibleIf condition is true
[90mstderr[2m | tests/unit/engine/templateNode.test.ts[2m > [22m[2mTemplate Node - Multi-Template Support[2m > [22m[2mRendering Engine Selection[2m > [22m[2mshould use legacy engine when engine="legacy"
[22m[39mCleanup warning: DrizzleQueryError: Failed query: delete from "tenants" where "tenants"."id" in ($1)
params: d481c87f-ae48-442b-87fc-5ad059f7a64d
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at TestFactory.cleanup (C:/Users/scoot/poll/VaultLogic/tests/helpers/testFactory.ts:446:9)
    at C:/Users/scoot/poll/VaultLogic/tests/unit/engine/templateNode.test.ts:125:5 {
  query: [32m'delete from "tenants" where "tenants"."id" in ($1)'[39m,
  params: [ [32m'd481c87f-ae48-442b-87fc-5ad059f7a64d'[39m ],
  cause: error: update or delete on table "users" violates foreign key constraint "workflow_versions_created_by_users_id_fk" on table "workflow_versions"
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at TestFactory.cleanup (C:/Users/scoot/poll/VaultLogic/tests/helpers/testFactory.ts:446:9)
      at C:/Users/scoot/poll/VaultLogic/tests/unit/engine/templateNode.test.ts:125:5 {
    length: [33m388[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23503'[39m,
    detail: [32m'Key (id)=(91231484-d6e1-4b47-9ebb-72401fe11616) is still referenced from table "workflow_versions".'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w22_v3'[39m,
    table: [32m'workflow_versions'[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [32m'workflow_versions_created_by_users_id_fk'[39m,
    file: [32m'ri_triggers.c'[39m,
    line: [32m'2612'[39m,
    routine: [32m'ri_ReportViolation'[39m
  }
}

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768681353984,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39m[DEBUG] Database initialized.

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w23_v3, public

{"level":30,"time":1768681354011,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768681353996,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681353997,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681354004,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681354004,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681354011,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681354011,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681354011,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681354011,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w23_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681354225,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768681354569,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681354570,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768681354659,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["6564e81b-e80d-4e72-ae6d-5b3596df3257","$2b$12$xv2l4.4bYXNyx9JWPuD0QOgUEl4.zzUWeeNGw9jhEwHGWmgKdKKue"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(6564e81b-e80d-4e72-ae6d-5b3596df3257) is not present in table \"users\".","schema":"test_schema_w24_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"6564e81b-e80d-4e72-ae6d-5b3596df3257","msg":"Failed to create user credentials"}
[90mstdout[2m | tests/integration/analytics_service.test.ts[2m > [22m[2mAnalytics Service Integration
[22m[39mMANUAL PATCH: Applied FK fix for workflow_run_events AND workflow_run_metrics

{"level":50,"time":1768681354659,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["6564e81b-e80d-4e72-ae6d-5b3596df3257","$2b$12$xv2l4.4bYXNyx9JWPuD0QOgUEl4.zzUWeeNGw9jhEwHGWmgKdKKue"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(6564e81b-e80d-4e72-ae6d-5b3596df3257) is not present in table \"users\".","schema":"test_schema_w24_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/lifecycle-hooks-execution.test.ts:41:11

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681354674,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681354675,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/dataBlocks.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 3436[2mms[22m[39m
     [2m[90mâ†“[39m[22m should write data to DataVault via WriteBlock
     [2m[90mâ†“[39m[22m should query data from DataVault via QueryBlock and use in Logic
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681354814,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681354814,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/analytics_service.test.ts [2m([22m[2m1 test[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 4253[2mms[22m[39m
     [2m[90mâ†“[39m[22m should generate events and metrics on run completion
{"level":30,"time":1768681354954,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mâœ… Applied failsafe schema fixes

 [31mâ¯[39m tests/integration/lifecycle-hooks-execution.test.ts [2m([22m[2m15 tests[22m[2m | [22m[33m15 skipped[39m[2m)[22m[33m 3599[2mms[22m[39m
       [2m[90mâ†“[39m[22m should execute beforePage hook and capture console output
       [2m[90mâ†“[39m[22m should execute beforePage hook with mutation mode enabled
       [2m[90mâ†“[39m[22m should handle errors gracefully without breaking workflow
       [2m[90mâ†“[39m[22m should execute afterPage hook with user input data
       [2m[90mâ†“[39m[22m should execute Python afterPage hook
       [2m[90mâ†“[39m[22m should execute beforeFinalBlock hook before document generation
       [2m[90mâ†“[39m[22m should execute afterDocumentsGenerated hook for cleanup
       [2m[90mâ†“[39m[22m should timeout hook that exceeds timeoutMs limit
       [2m[90mâ†“[39m[22m should execute multiple hooks in correct order
       [2m[90mâ†“[39m[22m should list all hooks for a workflow
       [2m[90mâ†“[39m[22m should update a hook
       [2m[90mâ†“[39m[22m should delete a hook
       [2m[90mâ†“[39m[22m should test a hook with sample data
       [2m[90mâ†“[39m[22m should retrieve execution logs for a run
       [2m[90mâ†“[39m[22m should clear execution logs for a run
[90mstdout[2m | tests/unit/services/AuthService.test.ts[2m > [22m[2mAuthService[2m > [22m[2mJWT Token Management[2m > [22m[2mverifyToken()[2m > [22m[2mshould throw error for invalid token signature
[22m[39mDEBUG: verifyToken threw: Invalid or malformed token InvalidTokenError

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w22_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w20_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w22_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w20_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768681355476,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/unit/engine/templateNode.test.ts[2m > [22m[2mTemplate Node - Multi-Template Support[2m > [22m[2mPDF Generation[2m > [22m[2mshould default to DOCX when toPdf=false
[22m[39mCleanup warning: DrizzleQueryError: Failed query: delete from "tenants" where "tenants"."id" in ($1)
params: d481c87f-ae48-442b-87fc-5ad059f7a64d
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at TestFactory.cleanup (C:/Users/scoot/poll/VaultLogic/tests/helpers/testFactory.ts:446:9)
    at C:/Users/scoot/poll/VaultLogic/tests/unit/engine/templateNode.test.ts:125:5 {
  query: [32m'delete from "tenants" where "tenants"."id" in ($1)'[39m,
  params: [ [32m'd481c87f-ae48-442b-87fc-5ad059f7a64d'[39m ],
  cause: error: update or delete on table "users" violates foreign key constraint "workflow_versions_created_by_users_id_fk" on table "workflow_versions"
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at TestFactory.cleanup (C:/Users/scoot/poll/VaultLogic/tests/helpers/testFactory.ts:446:9)
      at C:/Users/scoot/poll/VaultLogic/tests/unit/engine/templateNode.test.ts:125:5 {
    length: [33m388[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23503'[39m,
    detail: [32m'Key (id)=(91231484-d6e1-4b47-9ebb-72401fe11616) is still referenced from table "workflow_versions".'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w22_v3'[39m,
    table: [32m'workflow_versions'[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [32m'workflow_versions_created_by_users_id_fk'[39m,
    file: [32m'ri_triggers.c'[39m,
    line: [32m'2612'[39m,
    routine: [32m'ri_ReportViolation'[39m
  }
}

{"level":30,"time":1768681355501,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768681355487,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681355488,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681355494,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681355495,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681355500,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681355500,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681355501,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681355501,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768681356111,"env":"test","module":"user-credentials-repository","userId":"6d1374d3-16be-4816-9784-ff4621c0db2f","msg":"User credentials created"}
{"level":30,"time":1768681356290,"env":"test","module":"email-queue","jobId":"3ca3b39c-4823-48cc-88ae-925df9c80628","to":"test-9HglCGNUHHz-u-jRrdTjR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768681356518,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["6d1374d3-16be-4816-9784-ff4621c0db2f","2abdf0eaed19c94b53c1b105cf0e82571af04c2b83ab3095a9448b6712bcddfe","2026-02-16T20:22:36.295Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T20:22:36.295Z"],"cause":{"length":339,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(6d1374d3-16be-4816-9784-ff4621c0db2f) is not present in table \"users\".","schema":"test_schema_w24_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/datavault.permissions.test.ts:22:11

{"level":30,"time":1768681356532,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681356532,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

 [31mâ¯[39m tests/integration/datavault.permissions.test.ts [2m([22m[2m22 tests[22m[2m | [22m[33m22 skipped[39m[2m)[22m[33m 4027[2mms[22m[39m
       [2m[90mâ†“[39m[22m should allow owner to read table
       [2m[90mâ†“[39m[22m should allow writer to read table
       [2m[90mâ†“[39m[22m should allow reader to read table
       [2m[90mâ†“[39m[22m should deny non-member from reading table
       [2m[90mâ†“[39m[22m should allow owner to update table
       [2m[90mâ†“[39m[22m should deny writer from updating table
       [2m[90mâ†“[39m[22m should deny reader from updating table
       [2m[90mâ†“[39m[22m should deny writer from deleting table
       [2m[90mâ†“[39m[22m should deny reader from deleting table
       [2m[90mâ†“[39m[22m should deny non-member from deleting table
       [2m[90mâ†“[39m[22m should allow owner to view permissions
       [2m[90mâ†“[39m[22m should deny writer from viewing permissions
       [2m[90mâ†“[39m[22m should deny reader from viewing permissions
       [2m[90mâ†“[39m[22m should allow owner to grant permissions
       [2m[90mâ†“[39m[22m should allow owner to update existing permission (upsert)
       [2m[90mâ†“[39m[22m should deny writer from granting permissions
       [2m[90mâ†“[39m[22m should prevent modifying table owner permissions
       [2m[90mâ†“[39m[22m should allow owner to revoke permissions
       [2m[90mâ†“[39m[22m should deny writer from revoking permissions
       [2m[90mâ†“[39m[22m should enforce owner includes write and read
       [2m[90mâ†“[39m[22m should enforce write includes read but not owner
       [2m[90mâ†“[39m[22m should enforce read is read-only
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w28_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w28_v3 (Reused: true)

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w40_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w40_v3 (Reused: true)

{"level":30,"time":1768681357785,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mðŸ“Š Schema test_schema_w28_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681357885,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681357886,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w28_v3\",public on all connections"}
{"level":30,"time":1768681357939,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mðŸ“Š Schema test_schema_w40_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681358141,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w33_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768681358142,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w40_v3\",public on all connections"}
{"level":30,"time":1768681358191,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w33_v3 (Reused: true)

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w37_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w37_v3 (Reused: true)

 [31mâ¯[39m tests/unit/services/AuthService.test.ts [2m([22m[2m113 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 9279[2mms[22m[39m
         [32mâœ“[39m should hash a password using bcrypt with 12 rounds[32m 274[2mms[22m[39m
         [33m[2mâœ“[22m[39m should generate different hashes for same password [33m 517[2mms[22m[39m
         [32mâœ“[39m should handle empty passwords[32m 245[2mms[22m[39m
         [32mâœ“[39m should handle long passwords[32m 246[2mms[22m[39m
         [32mâœ“[39m should handle unicode characters in password[32m 247[2mms[22m[39m
         [33m[2mâœ“[22m[39m should return true for correct password [33m 517[2mms[22m[39m
         [33m[2mâœ“[22m[39m should return false for incorrect password [33m 565[2mms[22m[39m
         [33m[2mâœ“[22m[39m should be case-sensitive [33m 501[2mms[22m[39m
         [33m[2mâœ“[22m[39m should handle empty password comparison [33m 483[2mms[22m[39m
         [32mâœ“[39m should accept valid email addresses[32m 2[2mms[22m[39m
         [32mâœ“[39m should reject emails longer than 254 characters (RFC 5321)[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails shorter than 3 characters[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails with consecutive dots[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails without @ symbol[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails without domain[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails with spaces[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails without TLD[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject null or undefined[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails with local part longer than 64 characters[32m 1[2mms[22m[39m
         [32mâœ“[39m should accept valid strong passwords[32m 32[2mms[22m[39m
         [32mâœ“[39m should reject passwords shorter than 8 characters[32m 2[2mms[22m[39m
         [32mâœ“[39m should reject passwords longer than 128 characters[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject weak passwords with zxcvbn score < 3[32m 7[2mms[22m[39m
         [32mâœ“[39m should provide helpful feedback for weak passwords[32m 3[2mms[22m[39m
         [32mâœ“[39m should reject password containing user's email[32m 4[2mms[22m[39m
         [32mâœ“[39m should reject password containing user's name[32m 4[2mms[22m[39m
         [32mâœ“[39m should accept strong password even with user inputs provided[32m 7[2mms[22m[39m
         [32mâœ“[39m should accept password with exactly 8 characters if strong enough[32m 2[2mms[22m[39m
         [32mâœ“[39m should accept password with exactly 128 characters if strong[32m 187[2mms[22m[39m
         [32mâœ“[39m should return score in result object[32m 5[2mms[22m[39m
         [32mâœ“[39m should create a valid JWT token for a user[32m 5[2mms[22m[39m
         [32mâœ“[39m should include userId, email, tenantId, and role in token payload[32m 3[2mms[22m[39m
         [32mâœ“[39m should set token expiry to 15 minutes by default[32m 2[2mms[22m[39m
         [32mâœ“[39m should throw error if JWT_SECRET is not configured[32m 2[2mms[22m[39m
         [32mâœ“[39m should handle null tenantId and role[32m 2[2mms[22m[39m
         [32mâœ“[39m should verify and decode a valid token[32m 12[2mms[22m[39m
         [33m[2mâœ“[22m[39m should throw error for expired token [33m 1108[2mms[22m[39m
         [32mâœ“[39m should throw error for invalid token signature[32m 3[2mms[22m[39m
         [32mâœ“[39m should throw error for malformed token[32m 2[2mms[22m[39m
         [32mâœ“[39m should throw error for invalid token[32m 2[2mms[22m[39m
         [32mâœ“[39m should extract token from Bearer authorization header[32m 1[2mms[22m[39m
         [32mâœ“[39m should return token if no Bearer prefix[32m 1[2mms[22m[39m
         [32mâœ“[39m should return null for undefined header[32m 1[2mms[22m[39m
         [32mâœ“[39m should return null for empty header[32m 1[2mms[22m[39m
         [32mâœ“[39m should handle Bearer with multiple spaces[32m 1[2mms[22m[39m
         [32mâœ“[39m should return true for JWT-like tokens[32m 2[2mms[22m[39m
         [32mâœ“[39m should return false for non-JWT tokens[32m 2[2mms[22m[39m
         [32mâœ“[39m should return false for empty token[32m 2[2mms[22m[39m
         [32mâœ“[39m should return false for null/undefined[32m 2[2mms[22m[39m
         [32mâœ“[39m should create a valid portal token for an email[32m 3[2mms[22m[39m
         [32mâœ“[39m should include email and portal flag in token payload[32m 3[2mms[22m[39m
         [32mâœ“[39m should set token expiry to 24 hours[32m 2[2mms[22m[39m
         [32mâœ“[39m should verify and decode a valid portal token[32m 2[2mms[22m[39m
         [32mâœ“[39m should throw error for non-portal token[32m 3[2mms[22m[39m
         [32mâœ“[39m should throw error for token without email[32m 2[2mms[22m[39m
         [32mâœ“[39m should throw error for expired portal token[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should generate password reset token for existing user[39m[33m 308[2mms[22m[39m
         [32mâœ“[39m should return null for non-existent user[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should invalidate previous reset tokens[39m[32m 3[2mms[22m[39m
         [32mâœ“[39m should return userId for valid token[32m 2[2mms[22m[39m
         [32mâœ“[39m should return null for invalid token[32m 3[2mms[22m[39m
         [32mâœ“[39m should return null for expired token[32m 2[2mms[22m[39m
         [32mâœ“[39m should return null for used token[32m 2[2mms[22m[39m
         [32mâœ“[39m should mark token as used[32m 2[2mms[22m[39m
         [32mâœ“[39m should generate verification token[32m 2[2mms[22m[39m
         [32mâœ“[39m should have 24 hour expiry[32m 8[2mms[22m[39m
         [32mâœ“[39m should verify email with valid token[32m 3[2mms[22m[39m
         [32mâœ“[39m should return false for invalid token[32m 2[2mms[22m[39m
         [32mâœ“[39m should return false for expired token[32m 2[2mms[22m[39m
         [32mâœ“[39m should delete token after successful verification[32m 2[2mms[22m[39m
         [32mâœ“[39m should create refresh token with 30-day expiry[32m 3[2mms[22m[39m
         [32mâœ“[39m should store device metadata[32m 2[2mms[22m[39m
         [32mâœ“[39m should return userId for valid token[32m 2[2mms[22m[39m
         [32mâœ“[39m should return null for revoked token[32m 2[2mms[22m[39m
         [32mâœ“[39m should return null for expired token[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should rotate valid token and return new one[39m[32m 3[2mms[22m[39m
[31m         [31mÃ—[31m should return null for unknown token[39m[32m 3[2mms[22m[39m
[31m         [31mÃ—[31m should revoke all tokens on reuse detection[39m[32m 4[2mms[22m[39m
[31m         [31mÃ—[31m should return null for expired token[39m[32m 2[2mms[22m[39m
         [32mâœ“[39m should revoke specific token[32m 2[2mms[22m[39m
         [32mâœ“[39m should revoke all tokens for user[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should cleanup expired refresh tokens[39m[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should cleanup expired password reset tokens[39m[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should cleanup expired email verification tokens[39m[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should cleanup old login attempts via accountLockoutService[39m[32m 2[2mms[22m[39m
         [32mâœ“[39m should use JWT_SECRET if provided[32m 2[2mms[22m[39m
         [32mâœ“[39m should warn if JWT_SECRET is less than 32 characters[32m 2[2mms[22m[39m
         [32mâœ“[39m should reject token with modified payload[32m 3[2mms[22m[39m
         [32mâœ“[39m should reject token with valid structure but invalid signature[32m 2[2mms[22m[39m
         [33m[2mâœ“[22m[39m should handle password with special characters [33m 519[2mms[22m[39m
         [32mâœ“[39m should handle password with only spaces[32m 252[2mms[22m[39m
         [33m[2mâœ“[22m[39m should handle password with newlines and tabs [33m 486[2mms[22m[39m
         [33m[2mâœ“[22m[39m should reject password with null bytes (if validation exists) [33m 554[2mms[22m[39m
         [32mâœ“[39m should reject email with unicode domain (security fix)[32m 2[2mms[22m[39m
         [32mâœ“[39m should reject email starting with dot (security fix)[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject email ending with dot before @ (security fix)[32m 1[2mms[22m[39m
         [32mâœ“[39m should handle email with plus addressing[32m 2[2mms[22m[39m
         [32mâœ“[39m should handle email with subdomain[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject email with invalid TLD (single char)[32m 1[2mms[22m[39m
         [32mâœ“[39m should accept email with numeric TLD[32m 2[2mms[22m[39m
         [32mâœ“[39m should prevent timing attacks on token validation[32m 3[2mms[22m[39m
[31m         [31mÃ—[31m should support full user authentication lifecycle[39m[32m 259[2mms[22m[39m
[31m         [31mÃ—[31m should support complete password reset workflow[39m[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should prevent reuse of password reset tokens[39m[32m 2[2mms[22m[39m
         [32mâœ“[39m should support multiple valid refresh tokens per user[32m 2[2mms[22m[39m
         [32mâœ“[39m should revoke all user tokens on security event[32m 2[2mms[22m[39m
         [32mâœ“[39m should handle database connection failures gracefully[32m 3[2mms[22m[39m
         [32mâœ“[39m should handle transaction failures[32m 2[2mms[22m[39m
         [32mâœ“[39m should throw error if JWT signing fails[32m 2[2mms[22m[39m
         [32mâœ“[39m should hash password in reasonable time (< 500ms)[32m 263[2mms[22m[39m
         [33m[2mâœ“[22m[39m should compare password in reasonable time (< 500ms) [33m 508[2mms[22m[39m
         [32mâœ“[39m should create JWT token in < 10ms[32m 2[2mms[22m[39m
         [32mâœ“[39m should verify JWT token in < 50ms[32m 6[2mms[22m[39m
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w28_v3, public

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w17_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w40_v3, public

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mðŸ“Š Schema test_schema_w33_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681358702,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681358703,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w33_v3\",public on all connections"}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w40_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681358795,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mðŸ“Š Schema test_schema_w37_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/ownershipAccess.test.ts[2m > [22m[2mOwnership Access Control[2m > [22m[2mcanCreateWithOwnership[2m > [22m[2mshould deny creating user-owned asset if ownerUuid does not match userId
[22m[39mSetup error: DrizzleQueryError: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict do nothing
params: 00000000-0000-0000-0000-000000000001,user1@test.com,User 1,00000000-0000-0000-0000-000000000099,00000000-0000-0000-0000-000000000002,user2@test.com,User 2,00000000-0000-0000-0000-000000000099
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:41:7 {
  query: [32m'insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict do nothing'[39m,
  params: [
    [32m'00000000-0000-0000-0000-000000000001'[39m,
    [32m'user1@test.com'[39m,
    [32m'User 1'[39m,
    [32m'00000000-0000-0000-0000-000000000099'[39m,
    [32m'00000000-0000-0000-0000-000000000002'[39m,
    [32m'user2@test.com'[39m,
    [32m'User 2'[39m,
    [32m'00000000-0000-0000-0000-000000000099'[39m
  ],
  cause: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:41:7 {
    length: [33m315[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23503'[39m,
    detail: [32m'Key (tenant_id)=(00000000-0000-0000-0000-000000000099) is not present in table "tenants".'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w28_v3'[39m,
    table: [32m'users'[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [32m'users_tenant_id_tenants_id_fk'[39m,
    file: [32m'ri_triggers.c'[39m,
    line: [32m'2599'[39m,
    routine: [32m'ri_ReportViolation'[39m
  }
}

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w33_v3, public

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w20_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w20_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w33_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681359421,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681359422,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/unit/repositories/WorkflowTemplateRepository.test.ts [2m([22m[2m19 tests[22m[2m | [22m[31m19 failed[39m[2m)[22m[33m 19140[2mms[22m[39m
[31m       [31mÃ—[31m should create a workflow template mapping[39m[33m 982[2mms[22m[39m
[31m       [31mÃ—[31m should create non-primary mapping by default[39m[33m 867[2mms[22m[39m
[31m       [31mÃ—[31m should find all templates for a workflow version[39m[33m 898[2mms[22m[39m
[31m       [31mÃ—[31m should return empty array for version with no templates[39m[33m 829[2mms[22m[39m
[31m       [31mÃ—[31m should order by createdAt desc (newest first)[39m[33m 759[2mms[22m[39m
[31m       [31mÃ—[31m should find mapping by workflow version and key[39m[33m 918[2mms[22m[39m
[31m       [31mÃ—[31m should return undefined for non-existent key[39m[33m 1323[2mms[22m[39m
[31m       [31mÃ—[31m should find primary template for workflow version[39m[33m 732[2mms[22m[39m
[31m       [31mÃ—[31m should return undefined when no primary template exists[39m[33m 868[2mms[22m[39m
[31m       [31mÃ—[31m should set a template as primary and unset others[39m[33m 850[2mms[22m[39m
[31m       [31mÃ—[31m should handle setting primary when none existed before[39m[33m 871[2mms[22m[39m
[31m       [31mÃ—[31m should not delete mapping if workflow version does not match[39m[33m 854[2mms[22m[39m
[31m       [31mÃ—[31m should return true if key exists in workflow version[39m[33m 763[2mms[22m[39m
[31m       [31mÃ—[31m should return false if key does not exist[39m[33m 803[2mms[22m[39m
[31m       [31mÃ—[31m should exclude specified id when checking existence[39m[33m 913[2mms[22m[39m
[31m       [31mÃ—[31m should return true if key exists on different mapping[39m[33m 923[2mms[22m[39m
[31m       [31mÃ—[31m should update mapping fields[39m[33m 691[2mms[22m[39m
[31m       [31mÃ—[31m should find mapping by id[39m[33m 895[2mms[22m[39m
[31m       [31mÃ—[31m should return undefined for non-existent id[39m[33m 808[2mms[22m[39m
{"level":30,"time":1768681359470,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681359470,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/auth/oauth2.sessions.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m25 failed[39m[2m)[22m[33m 13287[2mms[22m[39m
[31m       [31mÃ—[31m should list all active sessions for current user[39m[33m 395[2mms[22m[39m
[31m       [31mÃ—[31m should mark current session as current[39m[33m 510[2mms[22m[39m
[31m       [31mÃ—[31m should return empty array when user has no active sessions[39m[33m 466[2mms[22m[39m
[31m       [31mÃ—[31m should not include expired sessions[39m[33m 526[2mms[22m[39m
[31m       [31mÃ—[31m should not include revoked sessions[39m[33m 371[2mms[22m[39m
[31m       [31mÃ—[31m should parse device name from user agent[39m[33m 424[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for unauthenticated request[39m[33m 378[2mms[22m[39m
[31m       [31mÃ—[31m should revoke a specific session[39m[33m 384[2mms[22m[39m
[31m       [31mÃ—[31m should return 404 for non-existent session[39m[33m 375[2mms[22m[39m
[31m       [31mÃ—[31m should prevent revoking current session[39m[33m 510[2mms[22m[39m
[31m       [31mÃ—[31m should prevent revoking another user's session[39m[33m 377[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for unauthenticated request[39m[33m 388[2mms[22m[39m
[31m       [31mÃ—[31m should revoke all sessions except current[39m[33m 467[2mms[22m[39m
[31m       [31mÃ—[31m should revoke all trusted devices[39m[33m 406[2mms[22m[39m
[31m       [31mÃ—[31m should return 400 when no active session found[39m[33m 382[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for unauthenticated request[39m[33m 489[2mms[22m[39m
[31m         [31mÃ—[31m should mark current device as trusted[39m[33m 379[2mms[22m[39m
[31m         [31mÃ—[31m should update existing trusted device expiry[39m[33m 486[2mms[22m[39m
[31m         [31mÃ—[31m should list all trusted devices[39m[33m 376[2mms[22m[39m
[31m         [31mÃ—[31m should not include revoked devices[39m[33m 386[2mms[22m[39m
[31m         [31mÃ—[31m should revoke a trusted device[39m[33m 376[2mms[22m[39m
[31m         [31mÃ—[31m should return 404 for non-existent device[39m[33m 382[2mms[22m[39m
[31m       [31mÃ—[31m should track IP address for sessions[39m[33m 426[2mms[22m[39m
[31m       [31mÃ—[31m should track user agent for sessions[39m[33m 500[2mms[22m[39m
[31m       [31mÃ—[31m should update lastUsedAt on token refresh[39m[33m 470[2mms[22m[39m
[90mstdout[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

{"level":30,"time":1768681359597,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768681359622,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768681359608,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681359608,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681359615,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681359616,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681359622,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681359622,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681359622,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681359622,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w38_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w38_v3 (Reused: true)

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681360014,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w20_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w34_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w20_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681360210,"env":"test","module":"user-credentials-repository","userId":"6b435e9a-ed46-473c-957f-000a870565f4","msg":"User credentials created"}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

 [31mâ¯[39m tests/unit/services/PdfQueueService.test.ts [2m([22m[2m15 tests[22m[2m | [22m[31m15 failed[39m[2m)[22m[33m 15403[2mms[22m[39m
[31m       [31mÃ—[31m should enqueue a PDF conversion job[39m[33m 991[2mms[22m[39m
[31m       [31mÃ—[31m should create output with empty storagePath initially[39m[33m 864[2mms[22m[39m
[31m       [31mÃ—[31m should return job status for pending job[39m[33m 994[2mms[22m[39m
[31m       [31mÃ—[31m should return null for non-existent job[39m[33m 890[2mms[22m[39m
[31m       [31mÃ—[31m should parse attempt count from error field[39m[33m 962[2mms[22m[39m
[31m       [31mÃ—[31m should convert DOCX to PDF immediately[39m[33m 839[2mms[22m[39m
[31m       [31mÃ—[31m should handle conversion errors gracefully[39m[33m 861[2mms[22m[39m
[31m       [31mÃ—[31m should start and stop service[39m[33m 803[2mms[22m[39m
[31m       [31mÃ—[31m should not start if already running[39m[33m 747[2mms[22m[39m
[31m       [31mÃ—[31m should handle stop when not running[39m[33m 762[2mms[22m[39m
[31m       [31mÃ—[31m should process pending jobs when queue is processed[39m[33m 732[2mms[22m[39m
[31m       [31mÃ—[31m should process multiple jobs in batch[39m[33m 769[2mms[22m[39m
[31m       [31mÃ—[31m should handle missing DOCX output gracefully[39m[33m 688[2mms[22m[39m
[31m       [31mÃ—[31m should support enqueue within transaction[39m[33m 904[2mms[22m[39m
[31m       [31mÃ—[31m should support convertImmediate within transaction[39m[33m 790[2mms[22m[39m
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w34_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mðŸ“Š Schema test_schema_w38_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681360504,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681360505,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w37_v3\",public on all connections"}
[90mstdout[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768681360543,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681360561,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681360568,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768681360554,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681360554,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681360560,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681360561,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681360567,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681360567,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681360568,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681360568,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768681360583,"env":"test","module":"email-queue","jobId":"dc2597e7-e69b-432b-8a06-ac1c340a753d","to":"test-OqkRIBEnmmOBjBFTq3UVQ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w42_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w42_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w35_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768681360747,"env":"test","module":"auth-routes","userId":"6b435e9a-ed46-473c-957f-000a870565f4","email":"test-OqkRIBEnmmOBjBFTq3UVQ@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w35_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, default, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"
params: Test Tenant for Templates Org,ed3297f0-ae66-49e5-82e4-b08f6fa75df4
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at Module.setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:130:19)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.templates-runs.test.ts:59:11 {
  query: [32m'insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, default, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"'[39m,
  params: [
    [32m'Test Tenant for Templates Org'[39m,
    [32m'ed3297f0-ae66-49e5-82e4-b08f6fa75df4'[39m
  ],
  cause: error: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at Module.setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:130:19)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/api.templates-runs.test.ts:59:11 {
    length: [33m347[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23503'[39m,
    detail: [32m'Key (tenant_id)=(ed3297f0-ae66-49e5-82e4-b08f6fa75df4) is not present in table "tenants".'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w34_v3'[39m,
    table: [32m'organizations'[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [32m'organizations_tenant_id_tenants_id_fk'[39m,
    file: [32m'ri_triggers.c'[39m,
    line: [32m'2599'[39m,
    routine: [32m'ri_ReportViolation'[39m
  }
}

{"level":30,"time":1768681360887,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681360887,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mâœ… Enforced search_path: test_schema_w37_v3, public

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w37_v3
â© Schema reused, skipping migrations.

{"level":50,"time":1768681361088,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["4db3e9af-dd8a-45d7-b72a-fab363970a0b","$2b$12$KzBl.WfMxI9HkLZqeLsZiePwxzIXRjGmEquwBai7vF.26cVpZ/4v2"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(4db3e9af-dd8a-45d7-b72a-fab363970a0b) is not present in table \"users\".","schema":"test_schema_w24_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"4db3e9af-dd8a-45d7-b72a-fab363970a0b","msg":"Failed to create user credentials"}
{"level":50,"time":1768681361088,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["4db3e9af-dd8a-45d7-b72a-fab363970a0b","$2b$12$KzBl.WfMxI9HkLZqeLsZiePwxzIXRjGmEquwBai7vF.26cVpZ/4v2"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(4db3e9af-dd8a-45d7-b72a-fab363970a0b) is not present in table \"users\".","schema":"test_schema_w24_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/intake.workflow.test.ts:11:15

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mðŸ“Š Schema test_schema_w42_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681361104,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681361104,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768681361107,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681361108,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w42_v3\",public on all connections"}
{"level":30,"time":1768681361162,"env":"test","msg":"DB: initialized flag set."}
 [31mâ¯[39m tests/integration/api.templates-runs.test.ts [2m([22m[2m15 tests[22m[2m | [22m[33m15 skipped[39m[2m)[22m[33m 3920[2mms[22m[39m
         [2m[90mâ†“[39m[22m should create template with file upload
         [2m[90mâ†“[39m[22m should reject non-docx files
         [2m[90mâ†“[39m[22m should reject without file
         [2m[90mâ†“[39m[22m should list templates
         [2m[90mâ†“[39m[22m should get template by ID
         [2m[90mâ†“[39m[22m should extract placeholders
         [2m[90mâ†“[39m[22m should update template name
         [2m[90mâ†“[39m[22m should delete template
         [2m[90mâ†“[39m[22m should execute workflow
         [2m[90mâ†“[39m[22m should include logs in debug mode
         [2m[90mâ†“[39m[22m should reject without required permission
         [2m[90mâ†“[39m[22m should list runs
         [2m[90mâ†“[39m[22m should filter by workflowId
         [2m[90mâ†“[39m[22m should get run by ID
         [2m[90mâ†“[39m[22m should get run logs
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mðŸ“Š Schema test_schema_w35_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681361268,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681361269,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w35_v3\",public on all connections"}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681361299,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681361300,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768681361346,"env":"test","msg":"DB: initialized flag set."}
 [31mâ¯[39m tests/integration/ownershipAccess.test.ts [2m([22m[2m19 tests[22m[2m | [22m[31m4 failed[39m[2m)[22m[33m 10545[2mms[22m[39m
       [32mâœ“[39m should allow access to user-owned asset by owner[32m 260[2mms[22m[39m
       [32mâœ“[39m should deny access to user-owned asset by non-owner[32m 269[2mms[22m[39m
[31m       [31mÃ—[31m should allow access to org-owned asset by org member[39m[33m 817[2mms[22m[39m
       [32mâœ“[39m should deny access to org-owned asset by non-member[32m 241[2mms[22m[39m
       [32mâœ“[39m should allow access to null ownership (legacy data)[32m 246[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return true for org member [33m 322[2mms[22m[39m
       [32mâœ“[39m should return false for non-member[32m 237[2mms[22m[39m
[31m       [31mÃ—[31m should return true for org admin[39m[33m 493[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return true for org admin [33m 331[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return false for org member (non-admin) [33m 310[2mms[22m[39m
       [32mâœ“[39m should return false for non-member[32m 226[2mms[22m[39m
[31m       [31mÃ—[31m should return all org IDs for a user[39m[33m 705[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return empty array for user with no memberships [33m 307[2mms[22m[39m
       [32mâœ“[39m should allow creating user-owned asset if ownerUuid matches userId[32m 239[2mms[22m[39m
       [33m[2mâœ“[22m[39m should deny creating user-owned asset if ownerUuid does not match userId [33m 759[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow creating org-owned asset if user is member [33m 390[2mms[22m[39m
       [32mâœ“[39m should deny creating org-owned asset if user is not member[32m 288[2mms[22m[39m
[31m       [31mÃ—[31m should not allow member of org1 to access org2-owned assets[39m[33m 731[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow member of multiple orgs to access all their org assets [33m 441[2mms[22m[39m
 [31mâ¯[39m tests/integration/intake.workflow.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 3428[2mms[22m[39m
     [2m[90mâ†“[39m[22m should allow designating a workflow as Intake
     [2m[90mâ†“[39m[22m should allow linking a downstream workflow to an intake workflow
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681361539,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681361540,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w38_v3\",public on all connections"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w42_v3, public

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w40_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681361624,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w44_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w35_v3, public

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w44_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w35_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768681362009,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681362010,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768681362023,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w33_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w33_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [31mâ¯[39m tests/unit/engine/templateNode.test.ts [2m([22m[2m17 tests[22m[2m | [22m[31m17 failed[39m[2m)[22m[33m 16393[2mms[22m[39m
[31m       [31mÃ—[31m should resolve template by key from workflowTemplates mapping[39m[33m 569[2mms[22m[39m
[31m       [31mÃ—[31m should throw error if template key not found[39m[33m 861[2mms[22m[39m
[31m       [31mÃ—[31m should store output in runOutputs table[39m[33m 1119[2mms[22m[39m
[31m       [31mÃ—[31m should resolve template by templateId directly[39m[33m 787[2mms[22m[39m
[31m       [31mÃ—[31m should throw error if templateId not found[39m[33m 1034[2mms[22m[39m
[31m       [31mÃ—[31m should use docxRenderer2 by default (v2 engine)[39m[33m 647[2mms[22m[39m
[31m       [31mÃ—[31m should use legacy engine when engine="legacy"[39m[33m 549[2mms[22m[39m
[31m       [31mÃ—[31m should generate PDF when toPdf=true[39m[33m 1070[2mms[22m[39m
[31m       [31mÃ—[31m should default to DOCX when toPdf=false[39m[33m 555[2mms[22m[39m
[31m       [31mÃ—[31m should skip execution when condition evaluates to false[39m[33m 989[2mms[22m[39m
[31m       [31mÃ—[31m should execute when condition evaluates to true[39m[33m 1020[2mms[22m[39m
[31m       [31mÃ—[31m should resolve simple bindings[39m[33m 575[2mms[22m[39m
[31m       [31mÃ—[31m should handle binding resolution errors gracefully[39m[33m 647[2mms[22m[39m
[31m       [31mÃ—[31m should record failed output in runOutputs table[39m[33m 661[2mms[22m[39m
[31m       [31mÃ—[31m should not throw errors (should return error in result)[39m[33m 1089[2mms[22m[39m
[31m       [31mÃ—[31m should deny access to templates from different tenant[39m[33m 572[2mms[22m[39m
[31m       [31mÃ—[31m should require either templateKey or templateId[39m[33m 956[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mâœ… Enforced search_path: test_schema_w38_v3, public

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mðŸ“Š Schema test_schema_w44_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681362155,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681362156,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w44_v3\",public on all connections"}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w38_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681362205,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w37_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w37_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w43_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w43_v3 (Reused: true)

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w44_v3, public

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w40_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681362902,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681362928,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.projects.test.ts[2m > [22m[2mProjects API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768681362914,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681362915,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681362922,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681362922,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681362927,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681362927,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681362928,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681362928,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768681363039,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681363040,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w36_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [31mâ¯[39m tests/integration/variableSafety.test.ts [2m([22m[2m4 tests[22m[2m | [22m[31m4 failed[39m[2m)[22m[33m 5760[2mms[22m[39m
[31m     [31mÃ—[31m REPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided[39m[33m 419[2mms[22m[39m
[31m     [31mÃ—[31m ScriptEngine resolves alias 'input_variable' when aliasMap is provided[39m[33m 587[2mms[22m[39m
[31m     [31mÃ—[31m REPRO: BlockRunner fails to resolve alias in CreateRecordConfig[39m[33m 506[2mms[22m[39m
[31m     [31mÃ—[31m BlockRunner logic resolves alias with aliasMap[39m[33m 677[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mðŸ“Š Schema test_schema_w43_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681363126,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681363127,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w43_v3\",public on all connections"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w36_v3 (Reused: true)

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768681363186,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w40_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w35_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w40_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w35_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768681363389,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681363390,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

 [31mâ¯[39m tests/integration/collections.e2e.test.ts [2m([22m[2m22 tests[22m[2m | [22m[33m22 skipped[39m[2m)[22m[33m 3224[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create a collection
       [2m[90mâ†“[39m[22m should list collections
       [2m[90mâ†“[39m[22m should get a collection by ID
       [2m[90mâ†“[39m[22m should update a collection
       [2m[90mâ†“[39m[22m should create text field
       [2m[90mâ†“[39m[22m should create email field
       [2m[90mâ†“[39m[22m should create number field
       [2m[90mâ†“[39m[22m should create select field with options
       [2m[90mâ†“[39m[22m should create boolean field
       [2m[90mâ†“[39m[22m should list all fields
       [2m[90mâ†“[39m[22m should update field
       [2m[90mâ†“[39m[22m should create a record
       [2m[90mâ†“[39m[22m should create multiple records
       [2m[90mâ†“[39m[22m should list records with pagination
       [2m[90mâ†“[39m[22m should get a single record
       [2m[90mâ†“[39m[22m should update a record
       [2m[90mâ†“[39m[22m should find records by filters
       [2m[90mâ†“[39m[22m should delete a record
       [2m[90mâ†“[39m[22m should list collections with stats
       [2m[90mâ†“[39m[22m should enforce required fields
       [2m[90mâ†“[39m[22m should validate field types
       [2m[90mâ†“[39m[22m should delete collection (cascade fields and records)
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mðŸ“Š Schema test_schema_w36_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681363566,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681363567,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w36_v3\",public on all connections"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768681363601,"env":"test","module":"user-credentials-repository","userId":"b1e6ca3d-9d5e-4eef-9e9d-e364ba65761c","msg":"User credentials created"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681363649,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w43_v3, public

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w38_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w38_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w43_v3
â© Schema reused, skipping migrations.

{"level":50,"time":1768681363787,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["b1e6ca3d-9d5e-4eef-9e9d-e364ba65761c","8af5b9b89ff315278d9ec358c260f46991e22367940d3155dc4d210f056276f4","2026-01-18T20:22:43.602Z"],"cause":{"length":383,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b1e6ca3d-9d5e-4eef-9e9d-e364ba65761c) is not present in table \"users\".","schema":"test_schema_w43_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681363777,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w36_v3, public

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w43_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681364189,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681364190,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w49_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w49_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w48_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w48_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

 [31mâ¯[39m tests/integration/api.projects.test.ts [2m([22m[2m10 tests[22m[2m | [22m[33m10 skipped[39m[2m)[22m[33m 3940[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create a new project
       [2m[90mâ†“[39m[22m should reject without authentication
       [2m[90mâ†“[39m[22m should reject with invalid data
       [2m[90mâ†“[39m[22m should list projects for tenant
       [2m[90mâ†“[39m[22m should support pagination
       [2m[90mâ†“[39m[22m should get project by ID
       [2m[90mâ†“[39m[22m should return 404 for non-existent project
       [2m[90mâ†“[39m[22m should update project
       [2m[90mâ†“[39m[22m should soft-delete project
       [2m[90mâ†“[39m[22m should not allow cross-tenant access
[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mError Handling[2m > [22m[2mreverts value on save error
[22m[39mFailed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:206:36
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mðŸ“Š Schema test_schema_w49_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681364694,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681364695,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w49_v3\",public on all connections"}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w43_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w43_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681364747,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mðŸ“Š Schema test_schema_w48_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681364783,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681364784,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w48_v3\",public on all connections"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":30,"time":1768681364840,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mError Handling[2m > [22m[2mdisplays error indicator on save failure
[22m[39mFailed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:222:36
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w49_v3, public

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w49_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mBoolean Type (Checkbox)[2m > [22m[2mshows loading spinner when saving checkbox
[22m[39mWarning: An update to EditableCell inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at EditableCell (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/EditableCell.tsx:12:25)

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w39_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w48_v3, public

{"level":30,"time":1768681365350,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w39_v3 (Reused: true)

{"level":30,"time":1768681365378,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w48_v3
â© Schema reused, skipping migrations.

{"level":50,"time":1768681365382,"env":"test","module":"auth","msg":"No default tenant found in database"}
{"level":50,"time":1768681365382,"env":"test","module":"auth","err":{"type":"Error","message":"System not properly configured - no tenant found","stack":"Error: System not properly configured - no tenant found\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:52:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"userId":"google-user-123","msg":"Failed to upsert user during authentication"}
{"level":50,"time":1768681365383,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
{"level":30,"time":1768681365362,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681365363,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681365371,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681365372,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681365378,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681365378,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681365378,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681365378,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768681365607,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":50,"time":1768681365607,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google authentication failed"}
{"level":30,"time":1768681365632,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681365633,"env":"test","msg":"DB: pool closed."}
{"level":40,"time":1768681365678,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768681365678,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google token verification failed"}
{"level":50,"time":1768681365678,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google authentication failed"}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w46_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/ui/datavault/EditableCell.test.tsx [2m([22m[2m29 tests[22m[2m)[22m[33m 7757[2mms[22m[39m
       [33m[2mâœ“[22m[39m saves on blur [33m 400[2mms[22m[39m
       [33m[2mâœ“[22m[39m saves on Enter key press [33m 345[2mms[22m[39m
       [33m[2mâœ“[22m[39m cancels edit on Escape key press [33m 349[2mms[22m[39m
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w46_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mðŸ“Š Schema test_schema_w39_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681365778,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681365779,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w39_v3\",public on all connections"}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681365842,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":50,"time":1768681366112,"env":"test","module":"auth","err":{"type":"DrizzleQueryError","message":"Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-existing,existing@example.com,Updated,User,https://example.com/new-avatar.jpg,8b85e7d3-ecf9-4748-9651-82118cea7e8b,viewer,google,easy,true,,Updated,User,https://example.com/new-avatar.jpg,2026-01-17T20:22:46.022Z: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"","stack":"Error: Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-existing,existing@example.com,Updated,User,https://example.com/new-avatar.jpg,8b85e7d3-ecf9-4748-9651-82118cea7e8b,viewer,google,easy,true,,Updated,User,https://example.com/new-avatar.jpg,2026-01-17T20:22:46.022Z\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7\ncaused by: error: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"\n    at C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\pg-pool\\index.js:45:11\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7","query":"insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"","params":["google-user-existing","existing@example.com","Updated","User","https://example.com/new-avatar.jpg","8b85e7d3-ecf9-4748-9651-82118cea7e8b","viewer","google","easy",true,null,"Updated","User","https://example.com/new-avatar.jpg","2026-01-17T20:22:46.022Z"]},"userId":"google-user-existing","msg":"Failed to upsert user during authentication"}
{"level":50,"time":1768681366114,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w36_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w49_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w36_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mðŸ“Š Schema test_schema_w46_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w49_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681366243,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681366244,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w39_v3, public

[90mstderr[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests
[22m[39mCleanup error (non-fatal): DrizzleQueryError: Failed query: delete from "workflows" where  = $1
params: 8b85e7d3-ecf9-4748-9651-82118cea7e8b
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.runs.graph.test.ts:256:9 {
  query: [32m'delete from "workflows" where  = $1'[39m,
  params: [ [32m'8b85e7d3-ecf9-4748-9651-82118cea7e8b'[39m ],
  cause: error: syntax error at or near "="
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/api.runs.graph.test.ts:256:9 {
    length: [33m90[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42601'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'32'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'scan.l'[39m,
    line: [32m'1244'[39m,
    routine: [32m'scanner_yyerror'[39m
  }
}

{"level":30,"time":1768681366357,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681366357,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/ui/runs.components.test.tsx [2m([22m[2m19 tests[22m[2m)[22m[33m 6844[2mms[22m[39m
       [33m[2mâœ“[22m[39m should show download options for successful runs [33m 1150[2mms[22m[39m
       [33m[2mâœ“[22m[39m should call onChange when status filter changes [33m 461[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w39_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":40,"time":1768681366614,"env":"test","msg":"Failed to parse legacy string condition: \"trigger == \", defaulting to visible"}
{"level":40,"time":1768681366614,"env":"test","msg":"Failed to parse legacy string condition: \"trigger == \", defaulting to visible"}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w52_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [31mâ¯[39m tests/integration/api.runs.graph.test.ts [2m([22m[2m19 tests[22m[2m | [22m[33m19 skipped[39m[2m)[22m[33m 3651[2mms[22m[39m
       [2m[90mâ†“[39m[22m should list all runs with pagination
       [2m[90mâ†“[39m[22m should filter runs by status
       [2m[90mâ†“[39m[22m should filter runs by workflow
       [2m[90mâ†“[39m[22m should filter runs by project
       [2m[90mâ†“[39m[22m should filter runs by date range
       [2m[90mâ†“[39m[22m should search runs by query string
       [2m[90mâ†“[39m[22m should get run by ID with all details
       [2m[90mâ†“[39m[22m should return 404 for non-existent run
       [2m[90mâ†“[39m[22m should get logs for a run
       [2m[90mâ†“[39m[22m should re-run workflow with same inputs
       [2m[90mâ†“[39m[22m should re-run workflow with override inputs
       [2m[90mâ†“[39m[22m should return 404 for non-existent run
       [2m[90mâ†“[39m[22m should export runs to CSV
       [2m[90mâ†“[39m[22m should export runs with filters applied
       [2m[90mâ†“[39m[22m should compare two runs
       [2m[90mâ†“[39m[22m should identify changed input keys
       [2m[90mâ†“[39m[22m should return 404 if run A not found
       [2m[90mâ†“[39m[22m should return 404 if run B not found
       [2m[90mâ†“[39m[22m should enforce tenant isolation on runs list
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w52_v3 (Reused: true)

{"level":30,"time":1768681366964,"env":"test","module":"auth","email":"refresh@example.com","msg":"OAuth2 login successful"}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w41_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w41_v3 (Reused: true)

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w50_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768681367103,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mðŸ“Š Schema test_schema_w52_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681367135,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681367136,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w52_v3\",public on all connections"}
{"level":30,"time":1768681367147,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681367148,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w50_v3 (Reused: true)

 [31mâ¯[39m tests/integration/regression-REG-1.test.ts [2m([22m[2m8 tests[22m[2m | [22m[31m5 failed[39m[2m)[22m[33m 5838[2mms[22m[39m
[31m       [31mÃ—[31m should block Next when required visible question is empty[39m[32m 220[2mms[22m[39m
[31m       [31mÃ—[31m should NOT block Next when required question is hidden[39m[33m 444[2mms[22m[39m
[31m       [31mÃ—[31m should block when required becomes visible and is empty[39m[33m 540[2mms[22m[39m
[31m       [31mÃ—[31m should skip hidden required page entirely[39m[33m 392[2mms[22m[39m
[31m       [31mÃ—[31m should enforce required on visible page[39m[33m 507[2mms[22m[39m
       [32mâœ“[39m should evaluate visibility consistently across modes[32m 2[2mms[22m[39m
       [32mâœ“[39m should handle malformed visibility expression gracefully[32m 2[2mms[22m[39m
       [32mâœ“[39m should handle missing variable in visibility expression[32m 0[2mms[22m[39m
{"level":30,"time":1768681367190,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681367195,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681367196,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w46_v3\",public on all connections"}
{"level":30,"time":1768681367260,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768681367273,"env":"test","module":"auth","err":{"type":"DrizzleQueryError","message":"Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-idtoken,idtoken@example.com,,,,50f1bee8-2d46-46d8-aac5-26731243bfb1,viewer,google,easy,true,,,,,2026-01-17T20:22:47.197Z: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"","stack":"Error: Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-idtoken,idtoken@example.com,,,,50f1bee8-2d46-46d8-aac5-26731243bfb1,viewer,google,easy,true,,,,,2026-01-17T20:22:47.197Z\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7\ncaused by: error: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"\n    at C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\pg-pool\\index.js:45:11\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7","query":"insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"","params":["google-user-idtoken","idtoken@example.com",null,null,null,"50f1bee8-2d46-46d8-aac5-26731243bfb1","viewer","google","easy",true,null,null,null,null,"2026-01-17T20:22:47.197Z"]},"userId":"google-user-idtoken","msg":"Failed to upsert user during authentication"}
{"level":50,"time":1768681367273,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
{"level":30,"time":1768681367423,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681367423,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w39_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w44_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w39_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [31mâ¯[39m tests/integration/auth/oauth2.callback.test.ts [2m([22m[2m16 tests[22m[2m | [22m[33m16 skipped[39m[2m)[22m[33m 3516[2mms[22m[39m
       [2m[90mâ†“[39m[22m should initiate OAuth2 3-legged flow and generate authorization URL
       [2m[90mâ†“[39m[22m should include optional scope in authorization URL
       [2m[90mâ†“[39m[22m should validate valid OAuth2 state token
       [2m[90mâ†“[39m[22m should reject invalid OAuth2 state token
       [2m[90mâ†“[39m[22m should reject expired OAuth2 state token
       [2m[90mâ†“[39m[22m should clean up OAuth2 state after use
       [2m[90mâ†“[39m[22m should handle callback with missing state parameter
       [2m[90mâ†“[39m[22m should handle callback with missing code parameter
       [2m[90mâ†“[39m[22m should handle OAuth2 provider error responses
       [2m[90mâ†“[39m[22m should track OAuth2 connection status
       [2m[90mâ†“[39m[22m should store OAuth2 state in connection metadata
       [2m[90mâ†“[39m[22m should use cryptographically secure random state
       [2m[90mâ†“[39m[22m should prevent state reuse after validation
       [2m[90mâ†“[39m[22m should include PKCE support metadata in state record
       [2m[90mâ†“[39m[22m should validate redirect URI matches allowed URIs
       [2m[90mâ†“[39m[22m should encode redirect URI in authorization URL
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mðŸ“Š Schema test_schema_w41_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681367552,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681367553,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w41_v3\",public on all connections"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w44_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w52_v3, public

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w43_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mâœ… Enforced search_path: test_schema_w46_v3, public

{"level":30,"time":1768681367645,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mðŸ“Š Schema test_schema_w50_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w46_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

{"level":50,"time":1768681367890,"env":"test","module":"auth","err":{"type":"DrizzleQueryError","message":"Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-minimal,minimal@example.com,,,,2369bbc2-23a9-48e0-8727-367fdeecd235,viewer,google,easy,true,,,,,2026-01-17T20:22:47.816Z: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"","stack":"Error: Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-minimal,minimal@example.com,,,,2369bbc2-23a9-48e0-8727-367fdeecd235,viewer,google,easy,true,,,,,2026-01-17T20:22:47.816Z\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7\ncaused by: error: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"\n    at C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\pg-pool\\index.js:45:11\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7","query":"insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"","params":["google-user-minimal","minimal@example.com",null,null,null,"2369bbc2-23a9-48e0-8727-367fdeecd235","viewer","google","easy",true,null,null,null,null,"2026-01-17T20:22:47.816Z"]},"userId":"google-user-minimal","msg":"Failed to upsert user during authentication"}
{"level":50,"time":1768681367891,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
{"level":30,"time":1768681367942,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681367968,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts[2m > [22m[2mRuns API - DOCX Generation Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681367955,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681367956,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681367962,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681367962,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681367967,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681367967,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681367968,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681367968,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768681367971,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681367972,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/workflow_versioning.test.ts [2m([22m[2m3 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 4226[2mms[22m[39m
     [32mâœ“[39m should diff two versions correctly[32m 3[2mms[22m[39m
[31m     [31mÃ—[31m should create a version and populate changelog[39m[33m 427[2mms[22m[39m
[31m     [31mÃ—[31m should track execution lineage via snapshot[39m[33m 383[2mms[22m[39m
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w41_v3, public

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w52_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768681368283,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":50,"time":1768681368323,"env":"test","module":"auth","err":{"type":"Error","message":"Token verification failed","stack":"Error: Token verification failed\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:431:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":40,"time":1768681368369,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768681368369,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":50,"time":1768681368421,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token payload","stack":"Error: Invalid token payload\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:88:26)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w49_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w49_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681368469,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681368469,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/auth/oauth2.google.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m4 failed[39m[2m)[22m[33m 6374[2mms[22m[39m
[31m       [31mÃ—[31m should successfully authenticate with valid Google ID token[39m[32m 200[2mms[22m[39m
       [32mâœ“[39m should return 400 when ID token is missing[32m 71[2mms[22m[39m
       [32mâœ“[39m should return 403 when Origin header is invalid[32m 65[2mms[22m[39m
       [32mâœ“[39m should return 401 when Google token verification fails[32m 72[2mms[22m[39m
       [32mâœ“[39m should return 401 when email is not verified by Google[32m 72[2mms[22m[39m
[31m       [31mÃ—[31m should update existing user on subsequent logins[39m[33m 438[2mms[22m[39m
       [33m[2mâœ“[22m[39m should create refresh token record in database [33m 925[2mms[22m[39m
[31m       [31mÃ—[31m should support both "token" and "idToken" fields[39m[32m 234[2mms[22m[39m
       [33m[2mâœ“[22m[39m should respect rate limiting [33m 393[2mms[22m[39m
[31m       [31mÃ—[31m should handle missing profile information gracefully[39m[32m 225[2mms[22m[39m
       [33m[2mâœ“[22m[39m should verify valid Google ID token [33m 382[2mms[22m[39m
       [32mâœ“[39m should throw error when token verification fails[32m 49[2mms[22m[39m
       [32mâœ“[39m should throw error when email is not verified[32m 44[2mms[22m[39m
       [32mâœ“[39m should throw error when payload is null[32m 51[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w43_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w43_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681368770,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681368771,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w50_v3\",public on all connections"}
{"level":30,"time":1768681368837,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

{"level":50,"time":1768681368897,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["f80104d7-e8b3-4abd-b026-3bccd4047602","$2b$12$oKjgFpbuABFFfQWF3gKhWewV5SalBKS35qLUMeD41.aBw1zVZVOtW"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f80104d7-e8b3-4abd-b026-3bccd4047602) is not present in table \"users\".","schema":"test_schema_w41_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"f80104d7-e8b3-4abd-b026-3bccd4047602","msg":"Failed to create user credentials"}
{"level":50,"time":1768681368897,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["f80104d7-e8b3-4abd-b026-3bccd4047602","$2b$12$oKjgFpbuABFFfQWF3gKhWewV5SalBKS35qLUMeD41.aBw1zVZVOtW"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f80104d7-e8b3-4abd-b026-3bccd4047602) is not present in table \"users\".","schema":"test_schema_w41_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w46_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w46_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681369305,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681369306,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mâœ… Enforced search_path: test_schema_w50_v3, public

{"level":30,"time":1768681369371,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681369372,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w50_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39m[DEBUG] Database initialized.

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768681369432,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
 [31mâ¯[39m tests/integration/dynamic_options_workflow.test.ts [2m([22m[2m1 test[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 3086[2mms[22m[39m
     [2m[90mâ†“[39m[22m should successfully configure a workflow with Read Table -> Dynamic Choice
{"level":30,"time":1768681369457,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768681369443,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681369443,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681369450,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681369450,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681369457,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681369457,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681369457,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681369457,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
 [31mâ¯[39m tests/integration/api.runs.docx.test.ts [2m([22m[2m6 tests[22m[2m | [22m[33m6 skipped[39m[2m)[22m[33m 4471[2mms[22m[39m
       [2m[90mâ†“[39m[22m should execute workflow with template node and generate DOCX
       [2m[90mâ†“[39m[22m should handle missing template data gracefully
       [2m[90mâ†“[39m[22m should download DOCX output from successful run
       [2m[90mâ†“[39m[22m should return 404 for PDF when not generated
       [2m[90mâ†“[39m[22m should return 404 for non-existent run
       [2m[90mâ†“[39m[22m should extract placeholders from uploaded template
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w55_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w55_v3 (Reused: true)

{"level":30,"time":1768681370304,"env":"test","module":"user-credentials-repository","userId":"17801440-72ce-4ef5-9404-dd588f48bca6","msg":"User credentials created"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w45_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w45_v3 (Reused: true)

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w39_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w39_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

{"level":30,"time":1768681370576,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681370577,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768681370648,"env":"test","module":"email-queue","jobId":"f1364d04-72f7-4239-b76e-14712aa64fd4","to":"test-sY0-9Ia_i7Ed8IaA1Cl8n@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
 [32mâœ“[39m tests/ui/datavault/TableCard.test.tsx [2m([22m[2m8 tests[22m[2m)[22m[33m 5389[2mms[22m[39m
     [33m[2mâœ“[22m[39m should call onDelete when delete button is clicked [33m 1275[2mms[22m[39m
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mðŸ“Š Schema test_schema_w55_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

{"level":30,"time":1768681370768,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mðŸ“Š Schema test_schema_w45_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681370818,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould validate expression after debounce
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768681370819,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w45_v3\",public on all connections"}
{"level":30,"time":1768681370829,"env":"test","module":"auth-routes","userId":"17801440-72ce-4ef5-9404-dd588f48bca6","email":"test-sY0-9Ia_i7Ed8IaA1Cl8n@example.com","msg":"User registered"}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w61_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768681370916,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w61_v3 (Reused: true)

[90mstdout[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mValidation Result DEBUG: {"ok":false,"errors":[{"message":"Unknown identifier: unknown_var","start":{"line":0,"col":0},"end":{"line":0,"col":11}}]}
IsValid DEBUG: [33mfalse[39m

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould debounce validation calls
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w53_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mðŸ“Š Schema test_schema_w61_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w56_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w45_v3, public

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w53_v3 (Reused: true)

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould not validate when workflowId or nodeId is missing
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould not validate when workflowId or nodeId is missing
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w56_v3 (Reused: true)

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w45_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681371540,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681371540,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould validate helper functions in expressions
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould validate complex expressions with multiple helpers
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mðŸ“Š Schema test_schema_w53_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w57_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w47_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w57_v3 (Reused: true)

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w47_v3 (Reused: true)

 [31mâ¯[39m tests/integration/api.expression-validation.test.ts [2m([22m[2m10 tests[22m[2m | [22m[33m10 skipped[39m[2m)[22m[33m 5003[2mms[22m[39m
       [2m[90mâ†“[39m[22m should validate a correct expression with valid variables
       [2m[90mâ†“[39m[22m should validate expression with string concatenation
       [2m[90mâ†“[39m[22m should reject expression with invalid syntax
       [2m[90mâ†“[39m[22m should reject without authentication
       [2m[90mâ†“[39m[22m should reject missing required fields
       [2m[90mâ†“[39m[22m should return available variables for a node
       [2m[90mâ†“[39m[22m should reject without authentication
       [2m[90mâ†“[39m[22m should reject non-existent workflow
       [2m[90mâ†“[39m[22m should return list of helper functions with metadata
       [2m[90mâ†“[39m[22m should reject without authentication
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mðŸ“Š Schema test_schema_w56_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould handle syntax errors
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681372058,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681372059,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w55_v3\",public on all connections"}
{"level":30,"time":1768681372134,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression Editor component behavior[2m > [22m[2mshould update validation when expression changes
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression Editor component behavior[2m > [22m[2mshould update validation when expression changes
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w50_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w50_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681372382,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681372383,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w61_v3\",public on all connections"}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mðŸ“Š Schema test_schema_w47_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681372401,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681372402,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w47_v3\",public on all connections"}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mðŸ“Š Schema test_schema_w57_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768681372462,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681372463,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

{"level":30,"time":1768681372458,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681372518,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mâœ… Enforced search_path: test_schema_w55_v3, public

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w55_v3
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/ui/expression-editor.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 5872[2mms[22m[39m
       [33m[2mâœ“[22m[39m should update validation when expression changes [33m 309[2mms[22m[39m
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768681372593,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681372619,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768681372603,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681372604,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681372609,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681372611,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681372618,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681372618,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681372618,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681372618,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w61_v3, public

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w47_v3, public

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w61_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w47_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681373193,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681373194,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w53_v3\",public on all connections"}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681373206,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681373207,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w56_v3\",public on all connections"}
{"level":30,"time":1768681373272,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681373285,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w63_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":50,"time":1768681373376,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8cedae27-35b5-49b7-8985-707517d39b2c","$2b$12$fPtjbKOMUzlmjCpTTWucr.KYXbfibAhCZs4O0BPovIxm4GaZTEu3i"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8cedae27-35b5-49b7-8985-707517d39b2c) is not present in table \"users\".","schema":"test_schema_w47_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"8cedae27-35b5-49b7-8985-707517d39b2c","msg":"Failed to create user credentials"}
{"level":50,"time":1768681373376,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8cedae27-35b5-49b7-8985-707517d39b2c","$2b$12$fPtjbKOMUzlmjCpTTWucr.KYXbfibAhCZs4O0BPovIxm4GaZTEu3i"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8cedae27-35b5-49b7-8985-707517d39b2c) is not present in table \"users\".","schema":"test_schema_w47_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.dataSources.native.test.ts:20:15

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681373391,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681373391,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w63_v3 (Reused: true)

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w60_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681373570,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681373576,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w57_v3\",public on all connections"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w60_v3 (Reused: true)

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w45_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w45_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681373640,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mâœ… Enforced search_path: test_schema_w56_v3, public

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w56_v3
â© Schema reused, skipping migrations.

 [31mâ¯[39m tests/integration/api.dataSources.native.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 3421[2mms[22m[39m
     [2m[90mâ†“[39m[22m should list databases and databases' tables in the catalog
     [2m[90mâ†“[39m[22m should create a native_table data source
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mâœ… Enforced search_path: test_schema_w53_v3, public

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w53_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w55_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w55_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w59_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w54_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w58_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mðŸ“Š Schema test_schema_w63_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w59_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w54_v3 (Reused: true)

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681373991,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681373991,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w58_v3 (Reused: true)

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mâœ… Applied failsafe schema fixes

 [32mâœ“[39m tests/ui/blocks/SendDataToTableBlockEditor.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 4439[2mms[22m[39m
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w61_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w61_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mðŸ“Š Schema test_schema_w60_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mâœ… Enforced search_path: test_schema_w57_v3, public

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w51_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w57_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w51_v3 (Reused: true)

{"level":30,"time":1768681374212,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681374212,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/ui/blocks/SendDataBlockEditorRouting.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 3793[2mms[22m[39m
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mðŸ“Š Schema test_schema_w58_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681374431,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768681374458,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/js_helpers.test.ts[2m > [22m[2mDetailed Verification: JS Helper Availability
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768681374443,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681374444,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681374451,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681374452,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681374457,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681374457,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681374458,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681374458,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mðŸ“Š Schema test_schema_w59_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mðŸ“Š Schema test_schema_w54_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mðŸ“Š Schema test_schema_w51_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681374591,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681374592,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w51_v3\",public on all connections"}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768681374659,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w47_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w47_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w47_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w47_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681374975,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681374976,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w63_v3\",public on all connections"}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w53_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w56_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w53_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681375034,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681375035,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w60_v3\",public on all connections"}
{"level":30,"time":1768681375042,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w51_v3, public

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w56_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681375101,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w51_v3
â© Schema reused, skipping migrations.

{"level":50,"time":1768681375144,"env":"test","module":"runs-routes","message":"Workflow not found","stack":"Error: Workflow not found\n    at WorkflowService.verifyAccess (C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:82:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at RunService.createRun (C:/Users/scoot/poll/VaultLogic/server/services/RunService.ts:167:22)\n    at C:/Users/scoot/poll/VaultLogic/server/routes/runs.routes.ts:88:21","name":"Error","workflowId":"7932a55c-cff6-4d14-8196-74a96a5769c2","msg":"Error creating run"}
{"level":30,"time":1768681375158,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681375158,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768681375237,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681375238,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w66_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w65_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w66_v3 (Reused: true)

 [32mâœ“[39m tests/ui/datavault/ColumnTypeIcon.test.tsx [2m([22m[2m27 tests[22m[2m)[22m[33m 4346[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w65_v3 (Reused: true)

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681375459,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681375460,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w58_v3\",public on all connections"}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681375486,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681375487,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w59_v3\",public on all connections"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w60_v3, public

 [31mâ¯[39m tests/integration/js_helpers.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 3703[2mms[22m[39m
[31m     [31mÃ—[31m should execute a JS block that uses helper functions[39m[33m 343[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w67_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w63_v3, public

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w60_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w67_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w63_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681375576,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681375573,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681375617,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681375618,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681375626,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681375627,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w54_v3\",public on all connections"}
 [32mâœ“[39m tests/ui/datavault/TemplateCard.test.tsx [2m([22m[2m6 tests[22m[2m)[22m[33m 4226[2mms[22m[39m
{"level":30,"time":1768681375697,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mðŸ“Š Schema test_schema_w65_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768681375814,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681375815,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mðŸ“Š Schema test_schema_w66_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

 [32mâœ“[39m tests/ui/datavault/DatabaseSettingsPage.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 5044[2mms[22m[39m
     [33m[2mâœ“[22m[39m should render database settings page with breadcrumbs [33m 312[2mms[22m[39m
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mâœ… Enforced search_path: test_schema_w58_v3, public

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mðŸ“Š Schema test_schema_w67_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w58_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mâœ… Enforced search_path: test_schema_w59_v3, public

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mâœ… Enforced search_path: test_schema_w54_v3, public

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w57_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w57_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w59_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w54_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w51_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w51_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w51_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w51_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768681376441,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681376467,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.snapshots.test.ts[2m > [22m[2mStage 13: Workflow Snapshots & Versioning
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768681376452,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681376453,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681376459,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681376460,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681376466,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681376467,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681376467,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681376467,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681376688,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681376689,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w65_v3\",public on all connections"}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w68_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768681376742,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681376742,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w68_v3 (Reused: true)

{"level":30,"time":1768681376744,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681376752,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681376753,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w66_v3\",public on all connections"}
{"level":30,"time":1768681376779,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
 [32mâœ“[39m tests/integration/auth.routes.test.ts [2m([22m[2m41 tests[22m[2m)[22m[33m 3848[2mms[22m[39m
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w69_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768681376779,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768681376781,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w64_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768681376816,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
{"level":30,"time":1768681376820,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681376835,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681376836,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w67_v3\",public on all connections"}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w69_v3 (Reused: true)

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w64_v3 (Reused: true)

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768681376892,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w70_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768681376917,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
{"level":30,"time":1768681376917,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768681376918,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":40,"time":1768681376924,"env":"test","module":"metrics-routes","ip":"::ffff:127.0.0.1","msg":"Unauthorized metrics access attempt"}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768681376935,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681376936,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681376937,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w60_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w63_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w60_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w70_v3 (Reused: true)

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w60_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w63_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w60_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w63_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mâœ“[39m tests/integration/metrics.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 3815[2mms[22m[39m
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w63_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mðŸ“Š Schema test_schema_w68_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w65_v3, public

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mðŸ“Š Schema test_schema_w64_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w65_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w66_v3, public

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mðŸ“Š Schema test_schema_w69_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w67_v3, public

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mðŸ“Š Schema test_schema_w70_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w66_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w67_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768681377606,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstderr[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx[2m > [22m[2mTableGridView - Drag & Drop[2m > [22m[2mrenders DndContext wrapper
[22m[39mWarning: validateDOMNesting(...): <th> cannot appear as a child of <div>.
    at th
    at SortableColumnHeader (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/SortableColumnHeader.tsx:12:33)
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
Warning: validateDOMNesting(...): <div> cannot appear as a child of <tr>.
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w71_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w71_v3 (Reused: true)

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w73_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681378055,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681378056,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w68_v3\",public on all connections"}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w73_v3 (Reused: true)

{"level":30,"time":1768681378127,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w54_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w58_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w59_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w54_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w54_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w58_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w59_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w54_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w58_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mðŸ“Š Schema test_schema_w71_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681378323,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681378324,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w71_v3\",public on all connections"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w58_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w58_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w59_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w58_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681378345,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681378346,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w69_v3\",public on all connections"}
{"level":30,"time":1768681378350,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681378350,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w59_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681378362,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681378363,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w70_v3\",public on all connections"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w59_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681378380,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681378390,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681378391,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w64_v3\",public on all connections"}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w59_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681378412,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681378434,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681378455,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mðŸ“Š Schema test_schema_w73_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":30,"time":1768681378615,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681378616,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w68_v3, public

{"level":30,"time":1768681378655,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681378655,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/api.snapshots.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 4686[2mms[22m[39m
     [33m[2mâœ“[22m[39m should maintain immutability of runs across versions [33m 997[2mms[22m[39m
{"level":50,"time":1768681378679,"env":"test","status":401,"statusText":"Unauthorized","error":"Invalid client credentials","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w68_v3
â© Schema reused, skipping migrations.

{"level":50,"time":1768681378679,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768681378681,"env":"test","data":{"token_type":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768681378681,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768681378682,"env":"test","data":{"access_token":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768681378682,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768681378684,"env":"test","error":"Network error: ECONNREFUSED","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
 [32mâœ“[39m tests/unit/utils/conditionalLogic-simple.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3875[2mms[22m[39m
 [32mâœ“[39m tests/unit/components/datavault/TableGridViewDragDrop.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 5223[2mms[22m[39m
     [33m[2mâœ“[22m[39m displays columns in order based on orderIndex [33m 553[2mms[22m[39m
{"level":50,"time":1768681378789,"env":"test","error":"Invalid credentials","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
[90mstderr[2m | tests/unit/shared/conditionEvaluator.test.ts[2m > [22m[2mconditionEvaluator[2m > [22m[2mComparison operators[2m > [22m[2mUnknown operator[2m > [22m[2mshould default to true and log warning
[22m[39mUnknown operator: unknown_operator

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":50,"time":1768681378790,"env":"test","error":"ECONNREFUSED","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768681378792,"env":"test","status":400,"statusText":"Bad Request","error":"Invalid grant_type","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768681378792,"env":"test","error":"OAuth2 token request failed: 400 Bad Request","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768681378793,"env":"test","status":401,"statusText":"Unauthorized","error":"Client authentication failed","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768681378793,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768681378794,"env":"test","status":403,"statusText":"Forbidden","error":"Access denied","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768681378794,"env":"test","error":"OAuth2 token request failed: 403 Forbidden","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768681378795,"env":"test","status":500,"statusText":"Internal Server Error","error":"Server error","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768681378795,"env":"test","error":"OAuth2 token request failed: 500 Internal Server Error","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768681378795,"env":"test","error":"Unexpected token in JSON","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768681378796,"env":"test","error":"Request timeout","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":30,"time":1768681378797,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681378798,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w69_v3, public

{"level":30,"time":1768681378802,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681378802,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/shared/conditionEvaluator.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 4030[2mms[22m[39m
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w69_v3
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 3758[2mms[22m[39m
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w71_v3, public

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w70_v3, public

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w71_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681378924,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681378927,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mâœ… Enforced search_path: test_schema_w64_v3, public

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w70_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w64_v3
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/unit/collab.client.test.tsx [2m([22m[2m17 tests[22m[2m)[22m[33m 5406[2mms[22m[39m
     [33m[2mâœ“[22m[39m should add a comment [33m 460[2mms[22m[39m
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681379428,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681379429,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w73_v3\",public on all connections"}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768681379446,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681379447,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768681379490,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w65_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w66_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w67_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w65_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mâœ“[39m tests/unit/components/datavault/TableGridView.test.tsx [2m([22m[2m9 tests[22m[2m)[22m[33m 6051[2mms[22m[39m
     [33m[2mâœ“[22m[39m loads table schema and rows [33m 508[2mms[22m[39m
     [33m[2mâœ“[22m[39m enters edit mode on double click [33m 330[2mms[22m[39m
     [33m[2mâœ“[22m[39m updates cell value on blur [33m 526[2mms[22m[39m
     [33m[2mâœ“[22m[39m renders delete button for each row [33m 488[2mms[22m[39m
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w66_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w66_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w67_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w66_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w67_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w67_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w74_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w74_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w68_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w68_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w75_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w76_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w69_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w69_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w78_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w73_v3, public

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w75_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w77_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768681379989,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681379990,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w78_v3 (Reused: true)

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w76_v3 (Reused: true)

{"level":30,"time":1768681380013,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681380014,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w70_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w70_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w73_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w77_v3 (Reused: true)

 [32mâœ“[39m tests/integration/conditions/conditionEvaluation.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 3770[2mms[22m[39m
 [32mâœ“[39m tests/integration/session.management.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 3710[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w79_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w79_v3 (Reused: true)

{"level":30,"time":1768681380145,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681380145,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

 [32mâœ“[39m tests/integration/api.ai.test.ts [2m([22m[2m32 tests[22m[2m)[22m[33m 3684[2mms[22m[39m
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mðŸ“Š Schema test_schema_w74_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mðŸ“Š Schema test_schema_w75_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mðŸ“Š Schema test_schema_w76_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mðŸ“Š Schema test_schema_w78_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w62_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mðŸ“Š Schema test_schema_w79_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mðŸ“Š Schema test_schema_w77_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w62_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w72_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w72_v3 (Reused: true)

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w80_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768681380681,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681380681,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w80_v3 (Reused: true)

 [32mâœ“[39m tests/ui/common/Breadcrumbs.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 4303[2mms[22m[39m
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w81_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mðŸ“Š Schema test_schema_w62_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681380991,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681380992,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w62_v3\",public on all connections"}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w45_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w64_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w45_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w81_v3 (Reused: true)

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w64_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mðŸ“Š Schema test_schema_w80_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mðŸ“Š Schema test_schema_w72_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768681381176,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681381225,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681381226,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768681381240,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681381241,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681381245,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681381246,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w74_v3\",public on all connections"}
 [32mâœ“[39m tests/integration/analytics_preservation.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 3852[2mms[22m[39m
     [33m[2mâœ“[22m[39m should preserve lifetime user count when a user is deleted [33m 916[2mms[22m[39m
 [32mâœ“[39m tests/integration/mfa.flow.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 3680[2mms[22m[39m
{"level":30,"time":1768681381308,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mðŸ“Š Schema test_schema_w81_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681381551,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681381552,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w78_v3\",public on all connections"}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681381595,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681381596,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w75_v3\",public on all connections"}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w82_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768681381608,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w62_v3, public

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681381625,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681381626,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w76_v3\",public on all connections"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681381634,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681381635,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w77_v3\",public on all connections"}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681381638,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681381639,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w79_v3\",public on all connections"}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w82_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w62_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w83_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768681381685,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681381693,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681381687,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681381708,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w83_v3 (Reused: true)

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w74_v3, public

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w74_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681382035,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681382036,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w80_v3\",public on all connections"}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w76_v3, public

{"level":30,"time":1768681382090,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w75_v3, public

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w77_v3, public

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w78_v3, public

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w76_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w75_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w77_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mðŸ“Š Schema test_schema_w82_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w78_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w79_v3, public

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681382202,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681382203,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w72_v3\",public on all connections"}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w79_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mðŸ“Š Schema test_schema_w83_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681382266,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w84_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w84_v3 (Reused: true)

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681382409,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681382410,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w81_v3\",public on all connections"}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768681382464,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w86_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w80_v3, public

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w73_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w73_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w86_v3 (Reused: true)

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w80_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mâœ… Enforced search_path: test_schema_w72_v3, public

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w72_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w62_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w62_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681382800,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts[2m > [22m[2mPersonalization API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768681382810,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681382811,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681382817,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681382818,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mðŸ“Š Schema test_schema_w84_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w81_v3, public

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w74_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w74_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681382987,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681382988,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w82_v3\",public on all connections"}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w81_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681383011,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681383012,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mðŸ“Š Schema test_schema_w86_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681383042,"env":"test","msg":"DB: initialized flag set."}
 [32mâœ“[39m tests/ui/builder.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 3672[2mms[22m[39m
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681383142,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681383143,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w83_v3\",public on all connections"}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w76_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w76_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w76_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w76_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681383197,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w78_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w78_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681383299,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681383299,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mâœ… Applied failsafe schema fixes

 [32mâœ“[39m tests/unit/utils/conditionalLogic.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 3819[2mms[22m[39m
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681383373,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681383373,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w75_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w77_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w75_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mâœ“[39m tests/unit/services/repeater.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 3807[2mms[22m[39m
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w77_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w82_v3, public

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w82_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681383548,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681383549,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/intake.portal.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 4124[2mms[22m[39m
{"level":50,"time":1768681383591,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"step.create","sectionRef":"temp-section-1","type":"short_text","title":"Field 1","alias":"field1"},"msg":"Failed to apply operation"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":50,"time":1768681383601,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"document.bindFields","id":"template-123","bindings":{"client_name":"nonExistentAlias"}},"msg":"Failed to apply operation"}
{"level":30,"time":1768681383606,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681383606,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

 [32mâœ“[39m tests/unit/services/WorkflowPatchService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 3997[2mms[22m[39m
{"level":30,"time":1768681383676,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681383677,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w83_v3, public

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w79_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w80_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w79_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

 [32mâœ“[39m tests/unit/utils/encryption.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 3975[2mms[22m[39m
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681383742,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681383743,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w83_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w80_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681383797,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681383797,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/captcha.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 3568[2mms[22m[39m
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681383933,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681383934,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w84_v3\",public on all connections"}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681383951,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681383952,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w86_v3\",public on all connections"}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768681383998,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681384003,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w72_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w72_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

 [32mâœ“[39m tests/integration/api.ai.personalization.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3637[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w86_v3, public

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681384403,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681384403,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w86_v3
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/unit/utils/pagination.test.ts [2m([22m[2m24 tests[22m[2m)[22m[33m 3834[2mms[22m[39m
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w84_v3, public

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w81_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w81_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w87_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w84_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w87_v3 (Reused: true)

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w88_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w88_v3 (Reused: true)

{"level":40,"time":1768681384898,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
{"level":30,"time":1768681384919,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681384919,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w89_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":50,"time":1768681384914,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768681384917,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768681384918,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768681384919,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768681384919,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768681384920,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768681384923,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768681384925,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768681384926,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768681384927,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768681384927,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768681384930,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
{"level":30,"time":1768681384931,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681384932,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/WorkflowChangeAnalyzer.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 3725[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w89_v3 (Reused: true)

 [32mâœ“[39m tests/unit/middleware/auth.middleware.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 3735[2mms[22m[39m
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mðŸ“Š Schema test_schema_w87_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768681385019,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681385020,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w91_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w85_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w92_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w91_v3 (Reused: true)

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w90_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w85_v3 (Reused: true)

 [32mâœ“[39m tests/unit/components/datavault/CellRenderer.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 4854[2mms[22m[39m
     [33m[2mâœ“[22m[39m renders boolean value as Yes/No [33m 452[2mms[22m[39m
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w92_v3 (Reused: true)

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w90_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w93_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mðŸ“Š Schema test_schema_w88_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w93_v3 (Reused: true)

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w94_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mðŸ“Š Schema test_schema_w89_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w94_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w82_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w83_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w82_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w83_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w95_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mðŸ“Š Schema test_schema_w85_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mðŸ“Š Schema test_schema_w91_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w95_v3 (Reused: true)

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mðŸ“Š Schema test_schema_w92_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mðŸ“Š Schema test_schema_w90_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mðŸ“Š Schema test_schema_w93_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mðŸ“Š Schema test_schema_w94_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681385906,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681385907,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

 [32mâœ“[39m tests/unit/services/RunExecutionCoordinator.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 3821[2mms[22m[39m
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681386004,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681386005,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mðŸ“Š Schema test_schema_w95_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

 [32mâœ“[39m tests/unit/listPipeline.semantics.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 4122[2mms[22m[39m
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w96_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w97_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w96_v3 (Reused: true)

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w97_v3 (Reused: true)

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681386203,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681386204,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w87_v3\",public on all connections"}
{"level":30,"time":1768681386331,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681386410,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681386412,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w88_v3\",public on all connections"}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681386475,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681386476,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w89_v3\",public on all connections"}
{"level":30,"time":1768681386481,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681386557,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mðŸ“Š Schema test_schema_w96_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mðŸ“Š Schema test_schema_w97_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w98_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768681386678,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681386697,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w91_v3\",public on all connections"}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w98_v3 (Reused: true)

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681386790,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681386791,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w90_v3\",public on all connections"}
{"level":30,"time":1768681386791,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681386792,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w92_v3\",public on all connections"}
{"level":30,"time":1768681386813,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w87_v3, public

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681386844,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681386845,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w85_v3\",public on all connections"}
{"level":30,"time":1768681386852,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w87_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681386867,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681386902,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681386939,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681386940,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w93_v3\",public on all connections"}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w88_v3, public

{"level":30,"time":1768681386992,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w89_v3, public

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w88_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681387039,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681387040,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w94_v3\",public on all connections"}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w89_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681387093,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681387109,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681387110,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w95_v3\",public on all connections"}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mðŸ“Š Schema test_schema_w98_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768681387178,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w91_v3, public

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w92_v3, public

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w91_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w90_v3, public

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mâœ… Enforced search_path: test_schema_w85_v3, public

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w92_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w85_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w90_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681387456,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681387457,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w96_v3\",public on all connections"}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w93_v3, public

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w99_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681387492,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681387494,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w97_v3\",public on all connections"}
{"level":30,"time":1768681387501,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w99_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w93_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681387542,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w95_v3, public

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w100_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w94_v3, public

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w95_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w100_v3 (Reused: true)

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w94_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w84_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w86_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w84_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w86_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681387840,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681387841,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w98_v3\",public on all connections"}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768681387889,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w87_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w87_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w96_v3, public

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w97_v3, public

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w96_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mðŸ“Š Schema test_schema_w99_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w97_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681388111,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681388111,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/HelperLibrary.test.ts [2m([22m[2m60 tests[22m[2m)[22m[33m 4053[2mms[22m[39m
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mðŸ“Š Schema test_schema_w100_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

{"level":30,"time":1768681388242,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681388242,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/utils/variableResolver.test.ts [2m([22m[2m20 tests[22m[2m)[22m[33m 3711[2mms[22m[39m
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w98_v3, public

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w88_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w89_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w88_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w88_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w89_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w88_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w88_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w89_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w88_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w98_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681388426,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681388427,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w89_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w89_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mâœ“[39m tests/unit/shared/validation/PageValidator.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 4164[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w89_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w89_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w89_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w89_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w89_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w93_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w93_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w85_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w90_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w91_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w92_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w85_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w90_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mreviseWorkflow should delegate to revision service
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mWorkflow Generation[2m > [22m[2mgenerateWorkflow should return a generated workflow
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mWorkflow Suggestions[2m > [22m[2msuggestWorkflowImprovements should return suggestions
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mWorkflow Suggestions[2m > [22m[2msuggestTemplateBindings should return bindings
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mWorkflow Suggestions[2m > [22m[2msuggestValues should return values
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mLogic Analysis[2m > [22m[2mgenerateLogic should return logic rules
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mLogic Analysis[2m > [22m[2mdebugLogic should return issues
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mLogic Analysis[2m > [22m[2mvisualizeLogic should return graph data
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

{"level":30,"time":1768681388768,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681388768,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681388769,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w99_v3\",public on all connections"}
{"level":30,"time":1768681388769,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w91_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mâœ“[39m tests/unit/services/AIService.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 4013[2mms[22m[39m
{"level":30,"time":1768681388820,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681388830,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681388831,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/workflows/validation.test.ts [2m([22m[2m66 tests[22m[2m)[22m[33m 4251[2mms[22m[39m
{"level":40,"time":1768681388872,"env":"test","module":"rbac-middleware","path":"/api/workflows","permission":"workflow:create","msg":"Unauthenticated user attempted to access protected resource"}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":40,"time":1768681388876,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permission":"workflow:create","path":"/api/workflows","msg":"Permission denied"}
{"level":40,"time":1768681388878,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"permission":"workflow:view","path":"/api/workflows","msg":"Permission denied"}
{"level":40,"time":1768681388879,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permissions":["workflow:create","workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (none of required permissions)"}
{"level":40,"time":1768681388880,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","permissions":["workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (missing some required permissions)"}
{"level":40,"time":1768681388882,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder"],"path":"/api/admin","msg":"Role check failed"}
{"level":40,"time":1768681388883,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"requiredRoles":["owner"],"path":"/api/admin","msg":"Role check failed"}
{"level":40,"time":1768681388884,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","requiredRoles":["owner"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768681388885,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"runner","requiredRoles":["owner","builder"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768681388886,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder","runner"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768681388889,"env":"test","module":"rbac-middleware","path":"/api/test","permission":"workflow:view","msg":"Unauthenticated user attempted to access protected resource"}
{"level":40,"time":1768681388890,"env":"test","module":"rbac-middleware","userId":"user-123","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
{"level":40,"time":1768681388890,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"invalid-role","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
{"level":30,"time":1768681388891,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681388891,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w92_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768681388918,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681388918,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/middleware/rbac.test.ts [2m([22m[2m44 tests[22m[2m)[22m[33m 4261[2mms[22m[39m
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681388938,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681388939,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w100_v3\",public on all connections"}
 [32mâœ“[39m tests/unit/shared/validation/stepConfigSchemas.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 4282[2mms[22m[39m
{"level":30,"time":1768681388992,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768681389052,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681389052,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w95_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w95_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mâœ“[39m tests/unit/engine/Performance.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3958[2mms[22m[39m
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w94_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w95_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w94_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681389135,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681389136,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w95_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mâœ“[39m tests/unit/components/datavault/SortableColumnHeader.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 4628[2mms[22m[39m
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768681389276,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681389277,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w96_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w96_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w99_v3, public

 [32mâœ“[39m tests/unit/workflow/QueryBlock.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 4408[2mms[22m[39m
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w99_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w100_v3, public

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w100_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681389474,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681389475,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w101_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w103_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/unit/engine.expr.test.ts [2m([22m[2m26 tests[22m[2m)[22m[33m 3910[2mms[22m[39m
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681389533,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681389534,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w103_v3 (Reused: true)

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w101_v3 (Reused: true)

 [32mâœ“[39m tests/unit/WorkflowOptimizationService.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 3943[2mms[22m[39m
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":40,"time":1768681389636,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":40,"time":1768681389649,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768681389652,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768681389657,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768681389659,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":30,"time":1768681389667,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681389668,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

 [32mâœ“[39m tests/unit/isolatedVmBridge.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 3497[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w102_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w102_v3 (Reused: true)

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mðŸ“Š Schema test_schema_w101_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w104_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w104_v3 (Reused: true)

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mðŸ“Š Schema test_schema_w103_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w107_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w106_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w107_v3 (Reused: true)

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w106_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w97_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w98_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w97_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w97_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w98_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w97_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w109_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w105_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w98_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w98_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w109_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w110_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w105_v3 (Reused: true)

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w110_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mðŸ“Š Schema test_schema_w102_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mMOCK SETUP DONE. Mock questions: [
  {
    id: [32m'q1'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q1'[39m,
    order: [33m0[39m,
    isVirtual: [33mfalse[39m,
    alias: [32m'show'[39m,
    visibleIf: [1mnull[22m
  },
  {
    id: [32m'q2'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q2'[39m,
    order: [33m1[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: { op: [32m'equals'[39m, left: [36m[Object][39m, right: [36m[Object][39m }
  },
  {
    id: [32m'q3'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q3'[39m,
    order: [33m2[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: [1mnull[22m
  }
]
Calling getVisibleQuestionCount...

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mCOUNT RESULT: [33m0[39m
Mock called times: [33m1[39m
Mock last call args: [ [ [32m'section1'[39m ] ]

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mðŸ“Š Schema test_schema_w104_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":50,"time":1768681390590,"env":"test","module":"intake-question-visibility","error":{},"questionId":"q1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681390591,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681390592,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

 [32mâœ“[39m tests/unit/services/intakeQuestionVisibility.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 3462[2mms[22m[39m
{"level":30,"time":1768681390664,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681390664,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/TemplateAnalysisService.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 3582[2mms[22m[39m
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mðŸ“Š Schema test_schema_w107_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mðŸ“Š Schema test_schema_w109_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mðŸ“Š Schema test_schema_w106_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681390813,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681390814,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w101_v3\",public on all connections"}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w113_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w112_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mðŸ“Š Schema test_schema_w110_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681390866,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mðŸ“Š Schema test_schema_w105_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w113_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w112_v3 (Reused: true)

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681390993,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681390994,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w103_v3\",public on all connections"}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w108_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w108_v3 (Reused: true)

{"level":30,"time":1768681391082,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mðŸ“Š Schema test_schema_w113_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w101_v3, public

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681391292,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681391293,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w102_v3\",public on all connections"}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w101_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681391345,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mðŸ“Š Schema test_schema_w112_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w103_v3, public

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mðŸ“Š Schema test_schema_w108_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681391512,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681391513,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w108_v3\",public on all connections"}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w103_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w111_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768681391569,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w111_v3 (Reused: true)

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681391608,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681391609,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w104_v3\",public on all connections"}
{"level":30,"time":1768681391682,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681391751,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681391752,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w109_v3\",public on all connections"}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681391801,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681391802,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w106_v3\",public on all connections"}
{"level":30,"time":1768681391818,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681391827,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681391828,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w107_v3\",public on all connections"}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w102_v3, public

{"level":30,"time":1768681391857,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681391865,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681391866,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w110_v3\",public on all connections"}
{"level":30,"time":1768681391884,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w102_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681391896,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681391897,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w105_v3\",public on all connections"}
{"level":30,"time":1768681391942,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681391950,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w108_v3, public

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w104_v3, public

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w108_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w104_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ“Š Schema test_schema_w111_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681392127,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681392128,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w111_v3\",public on all connections"}
{"level":30,"time":1768681392181,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w109_v3, public

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w109_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w106_v3, public

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w106_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681392308,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681392309,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w112_v3\",public on all connections"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w100_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w99_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w100_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w105_v3, public

{"level":30,"time":1768681392373,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w107_v3, public

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w99_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w105_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w110_v3, public

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w107_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w110_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w111_v3, public

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w113_v3, public

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w111_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w112_v3, public

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w113_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681392794,"env":"test","warnings":["Python code does not call emit(). Script will not produce output."],"msg":"Script validation warnings"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681392797,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681392798,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w112_v3
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/unit/ScriptEngine.test.ts [2m([22m[2m26 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[33m 3772[2mms[22m[39m
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/unit/shared/workflowLogic.test.ts[2m > [22m[2mworkflowLogic[2m > [22m[2mevaluateRules[2m > [22m[2mOperators[2m > [22m[2mUnknown operator[2m > [22m[2mshould return false and log warning for unknown operator
[22m[39mUnknown operator: unknown_operator

{"level":30,"time":1768681392938,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681392939,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w101_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w103_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w101_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w101_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w103_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w101_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mâœ“[39m tests/unit/shared/workflowLogic.test.ts [2m([22m[2m65 tests[22m[2m)[22m[33m 3897[2mms[22m[39m
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w103_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w103_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w111_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w111_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681393297,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681393297,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

 [32mâœ“[39m tests/services/BrandingService.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 2669[2mms[22m[39m
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w102_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w104_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w106_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w109_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w102_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w104_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681393393,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681393393,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681393396,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681393396,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w104_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w106_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w109_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w104_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mâœ… Applied failsafe schema fixes

 [32mâœ“[39m tests/unit/shared/validation/Validator.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 3543[2mms[22m[39m
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w106_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681393457,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681393457,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w115_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w106_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mâœ“[39m tests/unit/services/docxRenderer2.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 4028[2mms[22m[39m
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w109_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w109_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w109_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/unit/client/choice-utils.test.ts[2m > [22m[2mchoice-utils[2m > [22m[2mhandles missing content gracefully
[22m[39m[generateOptionsFromList] Invalid list data: [1mnull[22m

{"level":30,"time":1768681393502,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681393503,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/workflows/conditionTruthTable.test.ts [2m([22m[2m51 tests[22m[2m)[22m[33m 3778[2mms[22m[39m
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w109_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w115_v3 (Reused: true)

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

 [32mâœ“[39m tests/unit/client/choice-utils.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 3871[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w48_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w105_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w107_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w110_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w48_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w48_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w105_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w107_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w110_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w48_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681393829,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681393830,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768681393869,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/docxHelpers.test.ts [2m([22m[2m39 tests[22m[2m)[22m[33m 3910[2mms[22m[39m
{"level":30,"time":1768681393873,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w105_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w105_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681393878,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681393879,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":50,"time":1768681393897,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w107_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w107_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mâœ“[39m tests/services/EmailTemplateMetadataService.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 2815[2mms[22m[39m
{"level":50,"time":1768681393898,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating skipIf condition"}
{"level":30,"time":1768681393899,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681393899,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/intakeNavigation.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 4127[2mms[22m[39m
 [32mâœ“[39m tests/unit/client/list-choice-options.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 4214[2mms[22m[39m
[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w110_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w110_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mðŸ“Š Schema test_schema_w115_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

 [32mâœ“[39m tests/unit/BlockRunner.validate.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 3994[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w116_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w116_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mðŸ“Š Schema test_schema_w116_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681395820,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681395821,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w116_v3\",public on all connections"}
{"level":30,"time":1768681395876,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w116_v3, public

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w116_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681396475,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681396476,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w115_v3\",public on all connections"}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w118_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w118_v3 (Reused: true)

{"level":30,"time":1768681396538,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mðŸ“Š Schema test_schema_w118_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w115_v3, public

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w115_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681397092,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681397093,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w118_v3\",public on all connections"}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681397154,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w121_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w119_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w121_v3 (Reused: true)

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w119_v3 (Reused: true)

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w113_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w112_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w113_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w112_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w118_v3, public

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w118_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mðŸ“Š Schema test_schema_w121_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681397692,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681397693,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w121_v3\",public on all connections"}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mðŸ“Š Schema test_schema_w119_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681397706,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681397707,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w119_v3\",public on all connections"}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w125_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":40,"time":1768681397742,"env":"test","sourceListVar":"nonexistent_list","inputKey":"nonexistent_list","msg":"Input list not found, treating as empty array"}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681397743,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681397744,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w124_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768681397779,"env":"test","msg":"DB: initialized flag set."}
 [32mâœ“[39m tests/ListTools.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 3087[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w125_v3 (Reused: true)

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768681397811,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w124_v3 (Reused: true)

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w116_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w116_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":40,"time":1768681398090,"env":"test","error":{},"msg":"PDF conversion failed"}
{"level":30,"time":1768681398157,"env":"test","module":"workflow-quality-validator","overall":99,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"issuesCount":1,"passed":true,"msg":"Workflow quality validation completed"}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w119_v3, public

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mðŸ“Š Schema test_schema_w125_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681398210,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681398211,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w125_v3\",public on all connections"}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w119_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681398157,"env":"test","module":"workflow-generation-service","duration":5,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":99,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":1,"msg":"AI workflow generation succeeded"}
{"level":50,"time":1768681398164,"env":"test","module":"workflow-generation-service","error":{"code":"VALIDATION_ERROR","message":"","retryable":false},"duration":2,"msg":"AI workflow generation failed"}
{"level":50,"time":1768681398169,"env":"test","module":"workflow-generation-service","error":{"code":"VALIDATION_ERROR","message":"","retryable":false},"duration":1,"msg":"AI workflow generation failed"}
{"level":50,"time":1768681398173,"env":"test","module":"workflow-generation-service","error":{"code":"VALIDATION_ERROR","message":"","retryable":false},"duration":1,"msg":"AI workflow generation failed"}
{"level":50,"time":1768681398176,"env":"test","module":"workflow-generation-service","error":{"status":429,"code":"rate_limit_exceeded"},"duration":0,"msg":"AI workflow generation failed"}
{"level":50,"time":1768681398222,"env":"test","module":"workflow-generation-service","error":{},"duration":0,"msg":"AI workflow generation failed"}
{"level":30,"time":1768681398259,"env":"test","module":"workflow-quality-validator","overall":100,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"issuesCount":0,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768681398259,"env":"test","module":"workflow-generation-service","duration":1,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":100,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":0,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768681398261,"env":"test","module":"workflow-quality-validator","overall":96,"breakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"issuesCount":2,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768681398261,"env":"test","module":"workflow-generation-service","duration":0,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":96,"qualityBreakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"qualityPassed":true,"issuesCount":2,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768681398265,"env":"test","module":"workflow-suggestion-service","duration":0,"suggestionsCount":1,"msg":"AI binding suggestion succeeded"}
{"level":30,"time":1768681398266,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681398267,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mðŸ“Š Schema test_schema_w124_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681398272,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w121_v3, public

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681398325,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681398326,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w124_v3\",public on all connections"}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681398335,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681398335,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/ai.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 5288[2mms[22m[39m
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w121_v3
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/unit/docxRenderer.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 7959[2mms[22m[39m
       [33m[2mâœ“[22m[39m should extract placeholders including formatters [33m 488[2mms[22m[39m
       [33m[2mâœ“[22m[39m should render a template with simple data [33m 1113[2mms[22m[39m
       [33m[2mâœ“[22m[39m should use formatters in templates [33m 671[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle missing data gracefully [33m 316[2mms[22m[39m
       [33m[2mâœ“[22m[39m should use custom output name [33m 432[2mms[22m[39m
       [33m[2mâœ“[22m[39m should attempt PDF conversion when requested [33m 344[2mms[22m[39m
{"level":30,"time":1768681398396,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w115_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w115_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768681398727,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681398727,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w125_v3, public

 [32mâœ“[39m tests/unit/schema/documentEngine.test.ts [2m([22m[2m33 tests[22m[2m)[22m[33m 2757[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w125_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w126_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w124_v3, public

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w126_v3 (Reused: true)

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w124_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w118_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w118_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mðŸ“Š Schema test_schema_w126_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681399340,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681399341,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w126_v3\",public on all connections"}
{"level":30,"time":1768681399359,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681399360,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w121_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w121_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mâœ“[39m tests/unit/repositories/DocumentTemplateRepository.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 2619[2mms[22m[39m
{"level":30,"time":1768681399446,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w123_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681399772,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681399773,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w123_v3 (Reused: true)

 [32mâœ“[39m tests/unit/services/DocumentTemplateService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 3030[2mms[22m[39m
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w125_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w125_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w125_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w125_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w126_v3, public

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w126_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768681400122,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681400123,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/schema/collections.test.ts [2m([22m[2m34 tests[22m[2m)[22m[33m 2834[2mms[22m[39m
{"level":30,"time":1768681400208,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681400209,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/CollectionService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 2968[2mms[22m[39m
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mðŸ“Š Schema test_schema_w123_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681400275,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681400276,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w123_v3\",public on all connections"}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w122_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768681400377,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w122_v3 (Reused: true)

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w128_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w128_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w123_v3, public

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mðŸ“Š Schema test_schema_w128_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681400917,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681400918,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w128_v3\",public on all connections"}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mðŸ“Š Schema test_schema_w122_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681400923,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681400924,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w122_v3\",public on all connections"}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w124_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w126_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w124_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w123_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w126_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681401005,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681401034,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768681401251,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w117_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768681401361,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681401361,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w117_v3 (Reused: true)

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w128_v3, public

 [32mâœ“[39m tests/integration/branding.routes.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 2870[2mms[22m[39m
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w128_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w122_v3, public

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w122_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mðŸ“Š Schema test_schema_w117_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681401776,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w123_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w123_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681401777,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w117_v3\",public on all connections"}
{"level":30,"time":1768681401839,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w120_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w120_v3 (Reused: true)

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould skip question when condition is false
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute question when condition is true
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: true. Context keys: 4

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute question when condition is true
[22m[39m[DEBUG Question] Node q2 executed. Key: code, Value: ABC123. Context keys: 5

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould skip compute node when condition is false
[22m[39m[DEBUG Question] Node q1 executed. Key: amount, Value: 0. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute compute node when condition is true
[22m[39m[DEBUG Question] Node q1 executed. Key: amount, Value: 100. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould handle complex workflow with multiple conditions
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 4

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould handle complex workflow with multiple conditions
[22m[39m[DEBUG Question] Node q3 executed. Key: amount, Value: 1000. Context keys: 5

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w128_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w128_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w117_v3, public

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mDebug Mode[2m > [22m[2mshould return trace when debug is enabled
[22m[39m[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mDebug Mode[2m > [22m[2mshould not return trace when debug is disabled
[22m[39m[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

{"level":30,"time":1768681402367,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681402367,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w117_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mðŸ“Š Schema test_schema_w120_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681402495,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681402496,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w120_v3\",public on all connections"}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w127_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681402550,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w127_v3 (Reused: true)

{"level":30,"time":1768681402593,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681402594,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/engine.run-conditions.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 3201[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/queries/QueryRunner.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 2587[2mms[22m[39m
[90mstderr[2m | tests/unit/debugging/Lineage.test.ts[2m > [22m[2mDebug & Lineage[2m > [22m[2mshould generate execution trace with lineage
[22m[39m[DEBUG Question] Node q1 executed. Key: userName, Value: Alice. Context keys: 3

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681402729,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681402730,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

 [32mâœ“[39m tests/unit/debugging/Lineage.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 2920[2mms[22m[39m
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mðŸ“Š Schema test_schema_w127_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681402967,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681402968,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w127_v3\",public on all connections"}
{"level":30,"time":1768681403059,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w120_v3, public

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w134_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w120_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w134_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w117_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w117_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w127_v3, public

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w122_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w133_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681403567,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681403568,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w133_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mðŸ“Š Schema test_schema_w134_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681403684,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681403685,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w134_v3\",public on all connections"}
 [32mâœ“[39m tests/integration/datavault.row-notes.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 2844[2mms[22m[39m
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681403778,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w120_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w120_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mðŸ“Š Schema test_schema_w133_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681404018,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681404019,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w133_v3\",public on all connections"}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w135_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w130_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w135_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w130_v3 (Reused: true)

{"level":30,"time":1768681404122,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w132_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w132_v3 (Reused: true)

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w134_v3, public

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w127_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w127_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681404313,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w136_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w134_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w136_v3 (Reused: true)

{"level":30,"time":1768681404314,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/datavault.routes.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 2712[2mms[22m[39m
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mðŸ“Š Schema test_schema_w130_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681404523,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681404524,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w130_v3\",public on all connections"}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mðŸ“Š Schema test_schema_w135_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681404529,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w133_v3, public

{"level":30,"time":1768681404530,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w135_v3\",public on all connections"}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w133_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681404580,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681404580,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

{"level":30,"time":1768681404637,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681404638,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/workflow/PreviewExecution.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2620[2mms[22m[39m
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mðŸ“Š Schema test_schema_w132_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681404786,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681404787,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w132_v3\",public on all connections"}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mðŸ“Š Schema test_schema_w136_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681404804,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681404805,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w136_v3\",public on all connections"}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w131_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768681404839,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w131_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681404920,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w135_v3, public

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w130_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w130_v3, public

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w133_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w134_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w134_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mðŸ“Š Schema test_schema_w131_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681405274,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681405276,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w131_v3\",public on all connections"}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w132_v3, public

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w129_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w52_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w129_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w137_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w137_v3 (Reused: true)

{"level":30,"time":1768681405404,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w136_v3, public

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w138_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w135_v3
â© Schema reused, skipping migrations.

[DEBUG] BaseRepository.update datavault_columns: id=770e8400-e29b-41d4-a716-446655440002, updates={"name":"Mobile Phone","required":true,"updatedAt":"2026-01-17T20:23:25.507Z"}
{"level":30,"time":1768681405511,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681405511,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w138_v3 (Reused: true)

 [32mâœ“[39m tests/unit/repositories/DatavaultColumnsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 2953[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w52_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w52_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mðŸ“Š Schema test_schema_w129_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681405767,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681405768,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w129_v3\",public on all connections"}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768681405824,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w131_v3, public

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w114_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w136_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w136_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w132_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w114_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mðŸ“Š Schema test_schema_w137_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681405903,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681405904,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w137_v3\",public on all connections"}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mðŸ“Š Schema test_schema_w138_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681405949,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681405950,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w138_v3\",public on all connections"}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts[2m > [22m[2mDatavaultColumnsService[2m > [22m[2mgetColumns[2m > [22m[2mshould throw 404 if table not found
[22m[39m[DEBUG] Table not found: 660e8400-e29b-41d4-a716-446655440001

{"level":30,"time":1768681405977,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681406035,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w141_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w131_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w131_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681406144,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681406145,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w141_v3 (Reused: true)

{"level":30,"time":1768681406181,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681406182,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/DatavaultColumnsService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 3005[2mms[22m[39m
 [32mâœ“[39m tests/unit/services/DatavaultTablesService.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 2736[2mms[22m[39m
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w129_v3, public

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w137_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w137_v3, public

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mðŸ“Š Schema test_schema_w114_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681406423,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681406423,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w114_v3\",public on all connections"}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w137_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681406477,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

{"level":30,"time":1768681406541,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681406542,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w140_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w138_v3, public

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mðŸ“Š Schema test_schema_w141_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w139_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w140_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w138_v3
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/unit/services/RecordService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2961[2mms[22m[39m
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w139_v3 (Reused: true)

[DEBUG] BaseRepository.update datavault_tables: id=660e8400-e29b-41d4-a716-446655440001, updates={"name":"Updated Table","description":"Updated description","updatedAt":"2026-01-17T20:23:26.665Z"}
{"level":30,"time":1768681406671,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681406672,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768681406693,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681406694,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/repositories/DatavaultTablesRepository.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 2794[2mms[22m[39m
 [32mâœ“[39m tests/unit/services/StepService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 3043[2mms[22m[39m
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w114_v3, public

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w129_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mðŸ“Š Schema test_schema_w140_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mðŸ“Š Schema test_schema_w139_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681407147,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681407148,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w139_v3\",public on all connections"}
[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768681407253,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681407285,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681407285,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w137_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w137_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mâœ“[39m tests/unit/debug_import.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 2901[2mms[22m[39m
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w114_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w114_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681407653,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681407654,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/DataSourceService.test.ts [2m([22m[2m9 tests[22m[2m)[22m[33m 2720[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mDEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

{"level":30,"time":1768681407780,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w139_v3, public

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w144_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768681407858,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","descriptionLength":26,"msg":"AI logic generation requested"}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w138_v3
â© Schema reused, skipping migrations.

{"level":30,"time":1768681407860,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","duration":4,"changeCount":0,"msg":"AI logic generation succeeded"}
{"level":30,"time":1768681407881,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w144_v3 (Reused: true)

{"level":30,"time":1768681407893,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w142_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768681407902,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681407904,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w142_v3 (Reused: true)

{"level":30,"time":1768681407983,"env":"test","workflowId":"123e4567-e89b-12d3-a456-426614174000","userId":"user-123","sectionsCount":2,"stepsCount":0,"logicRulesCount":1,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w138_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w138_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":30,"time":1768681408120,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681408120,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/CollectionFieldService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 3018[2mms[22m[39m
 [32mâœ“[39m tests/unit/api.ai.logic.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3059[2mms[22m[39m
 [32mâœ“[39m tests/unit/services/WorkflowService.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 2471[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return workflow if user is the creator [33m 1391[2mms[22m[39m
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mðŸ“Š Schema test_schema_w144_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstderr[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17[90m)[39m
    at Object.get [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:176:34
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m {
  codeFrame: [32m'vi.mock(import("../../../server/db"), async (importOriginal) => {\n'[39m +
    [32m'  const actual = await importOriginal()\n'[39m +
    [32m'  return {\n'[39m +
    [32m'    ...actual,\n'[39m +
    [32m'    // your mocked methods\n'[39m +
    [32m'  }\n'[39m +
    [32m'})'[39m
}

{"level":30,"time":1768681408310,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[{"columnId":"col-first","value":"{{ firstName }}"},{"columnId":"col-last","value":"Doe"},{"columnId":"col-age","value":"{{ age }}"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":30,"time":1768681408320,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[]},"tableId":"table-users","preview":true,"msg":"Starting write execution"}
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681408321,"env":"test","module":"write-runner","operation":"write_preview_simulated","values":{},"msg":"Simulating write in preview mode"}
{"level":30,"time":1768681408322,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"test@example.com","columnMappings":[{"columnId":"col-status","value":"Active"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":30,"time":1768681408323,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":50,"time":1768681408323,"env":"test","module":"write-runner","error":{},"config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"msg":"Write execution failed"}
{"level":30,"time":1768681408347,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
 [32mâœ“[39m tests/unit/writes/WriteRunner.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 1138[2mms[22m[39m
{"level":30,"time":1768681408369,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts[2m > [22m[2mAI Document Assistant API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768681408356,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681408357,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681408364,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681408364,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681408369,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681408369,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681408369,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681408369,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":40,"time":1768681408396,"env":"test","error":{},"msg":"Deterministic DOCX extraction failed"}
[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mðŸ“Š Schema test_schema_w142_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681408544,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681408545,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/MfaService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 2519[2mms[22m[39m
         [33m[2mâœ“[22m[39m should try multiple codes if first doesn't match [33m 361[2mms[22m[39m
[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mâœ… Applied failsafe schema fixes

 [32mâœ“[39m tests/unit/services/PortalAuthService.test.ts [2m([22m[2m42 tests[22m[2m)[22m[33m 1461[2mms[22m[39m
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mâœ“[39m tests/integration/api.ai.doc.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 3185[2mms[22m[39m
{"level":30,"time":1768681409234,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":30,"time":1768681409293,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","msg":"AI workflow revision job enqueued"}
{"level":30,"time":1768681409308,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":50,"time":1768681409352,"env":"test","module":"ai-controller","error":{"issues":[{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["workflowId"]},{"code":"invalid_type","expected":"object","received":"undefined","path":["currentWorkflow"],"message":"Required"},{"code":"invalid_type","expected":"string","received":"undefined","path":["userInstruction"],"message":"Required"}],"name":"ZodError"},"msg":"Failed to enqueue AI revision job"}
{"level":30,"time":1768681409356,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681409357,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

 [32mâœ“[39m tests/unit/api.ai.revise.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 3291[2mms[22m[39m
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w143_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w143_v3 (Reused: true)

[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w151_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mðŸ“Š Schema test_schema_w143_v3 has 0 tables - running migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":40,"time":1768681410449,"env":"test","hookId":"hook-1","hookName":"Hook 1","error":"Test error","msg":"LifecycleHookService: Hook execution failed"}
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w151_v3 (Reused: true)

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":50,"time":1768681410453,"env":"test","error":{},"workflowId":"workflow-1","runId":"run-1","phase":"beforePage","msg":"LifecycleHookService: Failed to execute hooks for phase"}
{"level":30,"time":1768681410462,"env":"test","hookId":"hook-1","workflowId":"workflow-1","phase":"beforePage","msg":"LifecycleHookService: Created lifecycle hook"}
{"level":30,"time":1768681410469,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Updated lifecycle hook"}
{"level":30,"time":1768681410471,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Deleted lifecycle hook"}
 [32mâœ“[39m tests/unit/LifecycleHookService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1142[2mms[22m[39m
[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w154_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mðŸ“Š Schema test_schema_w151_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w154_v3 (Reused: true)

{"level":30,"time":1768681410985,"env":"test","msg":"External Send Completed","destination":"My Webhook","success":true,"status":200}
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681410992,"env":"test","msg":"Simulating External Send","destination":"Test","payload":{}}
 [32mâœ“[39m tests/unit/external/ExternalSendRunner.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1220[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w148_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w145_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w145_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w148_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w146_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w146_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mðŸ“Š Schema test_schema_w154_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w152_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

 [32mâœ“[39m tests/unit/services/Guardrail.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1058[2mms[22m[39m
[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w147_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w152_v3 (Reused: true)

[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w149_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w147_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w149_v3 (Reused: true)

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w153_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w153_v3 (Reused: true)

 [2m[90mâ†“[39m[22m tests/unit/collab.server.test.ts [2m([22m[2m14 tests[22m[2m | [22m[33m14 skipped[39m[2m)[22m
[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mðŸ“Š Schema test_schema_w145_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mðŸ“Š Schema test_schema_w148_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mðŸ“Š Schema test_schema_w146_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w150_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/AuditLogService.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 1059[2mms[22m[39m
 [32mâœ“[39m tests/unit/services/AccountLockoutService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 1061[2mms[22m[39m
 [32mâœ“[39m tests/unit/services/BrandingService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 1054[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w150_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ“Š Schema test_schema_w147_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mðŸ“Š Schema test_schema_w149_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

 [32mâœ“[39m tests/unit/services/EmailTemplateMetadataService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 973[2mms[22m[39m
[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mðŸ“Š Schema test_schema_w152_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/DatavaultRowsService.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 1030[2mms[22m[39m
 [32mâœ“[39m tests/unit/engine/FinalBlockSnapshot.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1071[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mðŸ“Š Schema test_schema_w153_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/repositories/DatavaultRowsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 891[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mðŸ“Š Schema test_schema_w150_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/DatavaultReferenceColumns.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 975[2mms[22m[39m
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681416238,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":30,"time":1768681418111,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768681418111,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768681418174,"env":"test","msg":"Master key validated successfully"}
{"level":30,"time":1768681418175,"env":"test","provider":"gemini","model":"gemini-2.0-flash","msg":"AI Service configured and ready"}
{"level":30,"time":1768681418175,"env":"test","msg":"Initializing database..."}
{"level":30,"time":1768681418175,"env":"test","msg":"Database initialized."}
{"level":30,"time":1768681418175,"env":"test","module":"email-queue","intervalMs":5000,"msg":"Starting email queue worker"}
Sourcemap for "C:/Users/scoot/poll/VaultLogic/node_modules/node-cron/dist/esm/node-cron.js" points to missing source files
{"level":30,"time":1768681418270,"env":"test","module":"cron","msg":"Initializing cron jobs..."}
{"level":30,"time":1768681418318,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768681418296,"env":"test","module":"cron","msg":"Cron jobs initialized"}
{"level":30,"time":1768681418297,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681418306,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681418307,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681418312,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681418312,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681418317,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681418317,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681418318,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681418318,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768681418318,"env":"test","msg":"Loading Vite for development..."}
{"level":30,"time":1768681423071,"env":"test","source":"express","msg":"ðŸ“¦ vite.ts module loaded successfully"}
{"level":30,"time":1768681423072,"env":"test","msg":"Vite module loaded, calling setupVite..."}
{"level":30,"time":1768681423072,"env":"test","source":"express","msg":"ðŸ“ setupVite: Starting Vite setup..."}
{"level":30,"time":1768681423072,"env":"test","source":"express","msg":"ðŸ“ setupVite: Resolving Vite config..."}
{"level":30,"time":1768681423076,"env":"test","source":"express","msg":"ðŸ“ setupVite: Vite config resolved"}
{"level":30,"time":1768681423076,"env":"test","source":"express","msg":"ðŸ“ setupVite: Server options prepared, creating Vite server..."}
{"level":30,"time":1768681423129,"env":"test","source":"express","msg":"ðŸ“ setupVite: Vite server created successfully"}
{"level":30,"time":1768681423130,"env":"test","source":"express","msg":"ðŸ“ setupVite: Mounting Vite middlewares..."}
{"level":30,"time":1768681423130,"env":"test","source":"express","msg":"ðŸ“ setupVite: Vite middlewares mounted"}
{"level":30,"time":1768681423130,"env":"test","source":"express","msg":"ðŸ“ setupVite: Vite setup complete!"}
{"level":30,"time":1768681423130,"env":"test","msg":"Vite setup complete"}
{"level":50,"time":1768681423133,"env":"test","module":"collab-server","err":{"type":"Error","message":"listen EADDRINUSE: address already in use 0.0.0.0:5000","stack":"Error: listen EADDRINUSE: address already in use 0.0.0.0:5000\n    at Server.setupListenHandle [as _listen2] (node:net:1940:16)\n    at listenInCluster (node:net:1997:12)\n    at node:net:2206:7\n    at processTicksAndRejections (node:internal/process/task_queues:89:21)","code":"EADDRINUSE","errno":-4091,"syscall":"listen","address":"0.0.0.0","port":5000},"msg":"WebSocket Server Error"}
{"level":50,"time":1768681423176,"env":"test","module":"email-queue","error":{},"msg":"Error in email queue processor"}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w156_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w156_v3 (Reused: true)

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mðŸ“Š Schema test_schema_w156_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681424831,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681424832,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w156_v3\",public on all connections"}
{"level":30,"time":1768681424873,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mâœ… Enforced search_path: test_schema_w156_v3, public

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w156_v3
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w139_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w139_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681426634,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768681426635,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/api-docs.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 8458[2mms[22m[39m

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Suites 26 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m tests/integration/analytics_service.test.ts[2m > [22mAnalytics Service Integration
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, default, default, default, default, default, default, default, default, default)
params: user-s1LV1mZ5xDL0Pm5WtMc94,user-s1LV1mZ5xDL0Pm5WtMc94@test.com,a1db2b69-495e-4e1a-9f46-3e0b5f06551a,admin,owner[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/analytics_service.test.ts:[2m38:9[22m[39m
    [90m 36| [39m        tenantId [33m=[39m tenant[33m.[39mid[33m;[39m
    [90m 37| [39m        userId [33m=[39m [32m`user-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m`[39m[33m;[39m
    [90m 38| [39m        await db.insert(users).values({ id: userId, email: `${userId}@â€¦
    [90m   | [39m        [31m^[39m
    [90m 39| [39m        const [p] = await db.insert(projects).values({ title: "P", namâ€¦
    [90m 40| [39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/analytics_service.test.ts:[2m38:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(a1db2b69-495e-4e1a-9f46-3e0b5f06551a) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.dataSources.native.test.ts[2m > [22mData Sources API - Native Catalog
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/api.dataSources.native.test.ts:[2m20:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[2/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.dataSources.native.test.ts[2m > [22mData Sources API - Native Catalog
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/api.dataSources.native.test.ts:[2m30:19[22m[39m
    [90m 28| [39m
    [90m 29| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 30| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 31| [39m    })[33m;[39m
    [90m 32| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[3/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.expression-validation.test.ts[2m > [22mExpression Validation API Integration Tests
[31m[1mError[22m: expected 201 "Created", got 404 "Not Found"[39m
[36m [2mâ¯[22m tests/integration/api.expression-validation.test.ts:[2m70:8[22m[39m
    [90m 68| [39m        }[33m,[39m
    [90m 69| [39m      })
    [90m 70| [39m      [33m.[39m[34mexpect[39m([34m201[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m 71| [39m
    [90m 72| [39m    workflowId [33m=[39m workflowResponse[33m.[39mbody[33m.[39mid[33m;[39m
[90m [2mâ¯[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2mâ¯[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2mâ¯[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2mâ¯[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m156:7[22m[39m
[90m [2mâ¯[22m Test.Request.callback node_modules/superagent/lib/node/index.js:[2m857:3[22m[39m
[90m [2mâ¯[22m node_modules/superagent/lib/node/index.js:[2m1102:18[22m[39m
[90m [2mâ¯[22m IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:[2m21:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[4/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.projects.test.ts[2m > [22mProjects API Integration Tests
[31m[1mError[22m: expected 201 "Created", got 500 "Internal Server Error"[39m
[36m [2mâ¯[22m tests/integration/api.projects.test.ts:[2m66:8[22m[39m
    [90m 64| [39m        lastName[33m:[39m [32m"User"[39m[33m,[39m
    [90m 65| [39m      })
    [90m 66| [39m      [33m.[39m[34mexpect[39m([34m201[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m 67| [39m
    [90m 68| [39m    authToken [33m=[39m registerResponse[33m.[39mbody[33m.[39mtoken[33m;[39m
[90m [2mâ¯[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2mâ¯[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2mâ¯[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2mâ¯[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m156:7[22m[39m
[90m [2mâ¯[22m Test.Request.callback node_modules/superagent/lib/node/index.js:[2m857:3[22m[39m
[90m [2mâ¯[22m node_modules/superagent/lib/node/index.js:[2m1102:18[22m[39m
[90m [2mâ¯[22m IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:[2m21:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[5/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.runs.docx.test.ts[2m > [22mRuns API - DOCX Generation Integration Tests
[31m[1mError[22m: expected 201 "Created", got 500 "Internal Server Error"[39m
[36m [2mâ¯[22m tests/integration/api.runs.docx.test.ts:[2m113:8[22m[39m
    [90m111| [39m      [33m.[39m[34mpost[39m([32m'/api/auth/register'[39m)
    [90m112| [39m      [33m.[39m[34msend[39m({ email[33m,[39m password[33m:[39m [32m'TestPassword123!@#Strong'[39m })
    [90m113| [39m      [33m.[39m[34mexpect[39m([34m201[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m114| [39m
    [90m115| [39m    authToken [33m=[39m registerResponse[33m.[39mbody[33m.[39mtoken[33m;[39m
[90m [2mâ¯[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2mâ¯[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2mâ¯[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2mâ¯[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m156:7[22m[39m
[90m [2mâ¯[22m Test.Request.callback node_modules/superagent/lib/node/index.js:[2m857:3[22m[39m
[90m [2mâ¯[22m node_modules/superagent/lib/node/index.js:[2m1102:18[22m[39m
[90m [2mâ¯[22m IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:[2m21:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[6/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.runs.graph.test.ts[2m > [22mStage 8: Runs API Integration Tests
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "email" = $6, "tenant_id" = $7, "role" = $8, "tenant_role" = $9
params: test-user-runs-stage8,test-runs-stage8-iZxfYwZO83sc4AuC7hmA4@example.com,8b85e7d3-ecf9-4748-9651-82118cea7e8b,admin,owner,test-runs-stage8-iZxfYwZO83sc4AuC7hmA4@example.com,8b85e7d3-ecf9-4748-9651-82118cea7e8b,admin,owner[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/api.runs.graph.test.ts:[2m123:5[22m[39m
    [90m121| [39m    userId [33m=[39m [32m"test-user-runs-stage8"[39m[33m;[39m
    [90m122| [39m
    [90m123| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(schema[33m.[39musers)[33m.[39m[34mvalues[39m({
    [90m   | [39m    [31m^[39m
    [90m124| [39m      id[33m:[39m userId[33m,[39m
    [90m125| [39m      email[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/api.runs.graph.test.ts:[2m123:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(8b85e7d3-ecf9-4748-9651-82118cea7e8b) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w44_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[7/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.templates-runs.test.ts[2m > [22mTemplates and Runs API Integration Tests
[31m[1mError[22m: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, default, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"
params: Test Tenant for Templates Org,ed3297f0-ae66-49e5-82e4-b08f6fa75df4[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m Module.setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m130:19[22m[39m
    [90m128| [39m
    [90m129| [39m    [90m// Create organization for ACL testing[39m
    [90m130| [39m    [35mconst[39m [org] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(schema[33m.[39morganizations)[33m.[39m[34mvalues[39m({
    [90m   | [39m                  [31m^[39m
    [90m131| [39m      name[33m:[39m [32m`[39m[36m${[39mtenantName[36m}[39m[32m Org`[39m[33m,[39m
    [90m132| [39m      tenantId[33m:[39m tenantId[33m,[39m
[90m [2mâ¯[22m tests/integration/api.templates-runs.test.ts:[2m59:11[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m Module.setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m130:19[22m[39m
[90m [2mâ¯[22m tests/integration/api.templates-runs.test.ts:[2m59:11[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 347, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(ed3297f0-ae66-49e5-82e4-b08f6fa75df4) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w34_v3', table: 'organizations', dataType: undefined, constraint: 'organizations_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[8/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.templates-runs.test.ts[2m > [22mTemplates and Runs API Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/api.templates-runs.test.ts:[2m85:15[22m[39m
    [90m 83| [39m
    [90m 84| [39m  [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 85| [39m    [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m              [31m^[39m
    [90m 86| [39m  })[33m;[39m
    [90m 87| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[9/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.workflows.test.ts[2m > [22mWorkflows API Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m Module.setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/api.workflows.test.ts:[2m42:11[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[10/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.workflows.test.ts[2m > [22mWorkflows API Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/api.workflows.test.ts:[2m52:15[22m[39m
    [90m 50| [39m
    [90m 51| [39m  [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 52| [39m    [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m              [31m^[39m
    [90m 53| [39m  })[33m;[39m
    [90m 54| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[11/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: E2E Test Project,E2E Test Project,Project for collections E2E tests,test-user-collections-e2e,b32d592b-8d40-4bfc-afd3-d64bba51a63a,test-user-collections-e2e,test-user-collections-e2e[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m49:23[22m[39m
    [90m 47| [39m
    [90m 48| [39m    [90m// Create test project[39m
    [90m 49| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(projects)[33m.[39m[34mvalues[39m({
    [90m   | [39m                      [31m^[39m
    [90m 50| [39m      name[33m:[39m [32m'E2E Test Project'[39m[33m,[39m
    [90m 51| [39m      title[33m:[39m [32m'E2E Test Project'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m49:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 313, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(test-user-collections-e2e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w42_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[12/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/dataBlocks.test.ts[2m > [22mData Block Integration Tests
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 66454ccb-6689-47a6-9a6d-286fe401ea60,datablock-test@example.com,9afc1643-6caf-4df8-bd76-1656ff2f695e,admin,owner,google[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/dataBlocks.test.ts:[2m49:24[22m[39m
    [90m 47| [39m        tenantId [33m=[39m tenant[33m.[39mid[33m;[39m
    [90m 48| [39m
    [90m 49| [39m        [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                       [31m^[39m
    [90m 50| [39m            id[33m:[39m [34muuidv4[39m()[33m,[39m
    [90m 51| [39m            email[33m:[39m testEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/dataBlocks.test.ts:[2m49:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9afc1643-6caf-4df8-bd76-1656ff2f695e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w23_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[13/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault-v4-regression.test.ts[2m > [22mDataVault v4 Regression Tests
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $7, "role" = $8, "tenant_role" = $9
params: google-user-id,testuser@example.com,0ae27cd4-89c3-4f9f-bf7c-e71717a842c0,admin,owner,google,0ae27cd4-89c3-4f9f-bf7c-e71717a842c0,admin,owner[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/datavault-v4-regression.test.ts:[2m90:5[22m[39m
    [90m 88| [39m    [90m// Create test user manually with correct tenant and admin role[39m
    [90m 89| [39m    testUserId [33m=[39m [32m'google-user-id'[39m[33m;[39m
    [90m 90| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m    [31m^[39m
    [90m 91| [39m      id[33m:[39m testUserId[33m,[39m
    [90m 92| [39m      email[33m:[39m [32m'testuser@example.com'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/datavault-v4-regression.test.ts:[2m90:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(0ae27cd4-89c3-4f9f-bf7c-e71717a842c0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[14/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.autonumber.test.ts[2m > [22mDataVault Autonumber Integration Tests
[31m[1mError[22m: Failed query: insert into "datavault_columns" ("id", "table_id", "name", "slug", "type", "description", "width_px", "required", "is_primary_key", "is_unique", "order_index", "auto_number_start", "autonumber_prefix", "autonumber_padding", "autonumber_reset_policy", "reference_table_id", "reference_display_column_slug", "options", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, default, $5, default, $6, $7, default, $8, $9, $10, $11, $12, $13, default, default) returning "id", "table_id", "name", "slug", "type", "description", "width_px", "required", "is_primary_key", "is_unique", "order_index", "auto_number_start", "autonumber_prefix", "autonumber_padding", "autonumber_reset_policy", "reference_table_id", "reference_display_column_slug", "options", "created_at", "updated_at"
params: bfae0dc5-0050-42ea-91fc-488a1aa5d065,Case Number,case_number,autonumber,false,false,1,CASE,5,never,,,[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m DatavaultColumnsRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
    [90m 88| [39m    [35mconst[39m database [33m=[39m [35mthis[39m[33m.[39m[34mgetDb[39m(tx)[33m;[39m
    [90m 89| [39m
    [90m 90| [39m    [35mconst[39m [record] [33m=[39m [35mawait[39m database
    [90m   | [39m                     [31m^[39m
    [90m 91| [39m      [33m.[39m[34minsert[39m([35mthis[39m[33m.[39mtable [35mas[39m any)
    [90m 92| [39m      [33m.[39m[34mvalues[39m(data [35mas[39m any)
[90m [2mâ¯[22m tests/integration/datavault.autonumber.test.ts:[2m57:26[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "datavault_columns" violates foreign key constraint "datavault_columns_table_id_datavault_tables_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m DatavaultColumnsRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
[90m [2mâ¯[22m tests/integration/datavault.autonumber.test.ts:[2m57:26[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 386, severity: 'ERROR', code: '23503', detail: 'Key (table_id)=(bfae0dc5-0050-42ea-91fc-488a1aa5d065) is not present in table "datavault_tables".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'datavault_columns', dataType: undefined, constraint: 'datavault_columns_table_id_datavault_tables_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[15/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.permissions.test.ts[2m > [22mDataVault Table Permissions API (v4 Micro-Phase 6)
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/datavault.permissions.test.ts:[2m22:11[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[16/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.permissions.test.ts[2m > [22mDataVault Table Permissions API (v4 Micro-Phase 6)
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/datavault.permissions.test.ts:[2m66:15[22m[39m
    [90m 64| [39m
    [90m 65| [39m  [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 66| [39m    [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m              [31m^[39m
    [90m 67| [39m  })[33m;[39m
    [90m 68| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[17/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/dynamic_options_workflow.test.ts[2m > [22mDynamic Options Integration Flow
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values (default, $1, default, $2, $3, default, $4, $5, default, default, default, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: test-97046e41-89d4-4c90-9f04-b5430083ca68@example.com,Test,User,4f97d5e8-b196-410e-9c47-744c1208e103,admin[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/dynamic_options_workflow.test.ts:[2m30:24[22m[39m
    [90m 28| [39m        tenantId [33m=[39m tenant[33m.[39mid[33m;[39m
    [90m 29| [39m
    [90m 30| [39m        [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                       [31m^[39m
    [90m 31| [39m            email[33m:[39m [32m`test-[39m[36m${[39m[34muuidv4[39m()[36m}[39m[32m@example.com`[39m[33m,[39m
    [90m 32| [39m            firstName[33m:[39m [32m'Test'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/dynamic_options_workflow.test.ts:[2m30:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(4f97d5e8-b196-410e-9c47-744c1208e103) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w49_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[18/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/externalSends.test.ts[2m > [22mExternal Send Block Integration
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 168d07db-cbcd-455f-b8c9-2dc81cfea442,ext-test-1768681352763@example.com,cb0d203d-ffbf-4d9c-b385-1fea65dcbc5b,admin,owner,local[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/externalSends.test.ts:[2m38:24[22m[39m
    [90m 36| [39m        tenantId [33m=[39m tenant[33m.[39mid[33m;[39m
    [90m 37| [39m
    [90m 38| [39m        [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                       [31m^[39m
    [90m 39| [39m            id[33m:[39m [34muuidv4[39m()[33m,[39m
    [90m 40| [39m            email[33m:[39m [32m`ext-test-[39m[36m${[39m[33mDate[39m[33m.[39m[34mnow[39m()[36m}[39m[32m@example.com`[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/externalSends.test.ts:[2m38:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(cb0d203d-ffbf-4d9c-b385-1fea65dcbc5b) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w31_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[19/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/intake.workflow.test.ts[2m > [22mIntake Workflow Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/intake.workflow.test.ts:[2m11:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[20/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/intake.workflow.test.ts[2m > [22mIntake Workflow Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/intake.workflow.test.ts:[2m21:19[22m[39m
    [90m 19| [39m
    [90m 20| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 21| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 22| [39m    })[33m;[39m
    [90m 23| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[21/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/lifecycle-hooks-execution.test.ts[2m > [22mLifecycle Hooks Execution
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/lifecycle-hooks-execution.test.ts:[2m41:11[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/lifecycle-hooks-execution.test.ts[2m > [22mLifecycle Hooks Execution
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/lifecycle-hooks-execution.test.ts:[2m89:15[22m[39m
    [90m 87| [39m
    [90m 88| [39m  [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 89| [39m    [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m              [31m^[39m
    [90m 90| [39m  })[33m;[39m
    [90m 91| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[23/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-audit-fixes.test.ts[2m > [22mOrganization Audit Fixes
[31m[1mError[22m: User must belong to a tenant to create organizations[39m
[36m [2mâ¯[22m OrganizationService.createOrganization server/services/OrganizationService.ts:[2m49:13[22m[39m
    [90m 47| [39m
    [90m 48| [39m    [35mif[39m ([33m![39muser[33m?.[39mtenantId) {
    [90m 49| [39m      throw new Error('User must belong to a tenant to create organizaâ€¦
    [90m   | [39m            [31m^[39m
    [90m 50| [39m    }
    [90m 51| [39m
[90m [2mâ¯[22m tests/integration/organizations-audit-fixes.test.ts:[2m58:17[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[24/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default), ($9, $10, $11, default, default, default, $12, default, default, default, default, default, default, default, default, default, default, default) on conflict do nothing
params: 20387c6a-a769-4cd9-8cee-e5b065d48cc4,org-owner@test.com,Org Owner,f51de9ee-c72f-4a39-84ca-b4a309fd4947,365e6eca-a6c8-4ad3-93cd-e189adfe3ca3,org-member@test.com,Org Member,f51de9ee-c72f-4a39-84ca-b4a309fd4947,63e4847b-37db-4cfd-b9e8-a2d0e04b0072,non-member@test.com,Non Member,f51de9ee-c72f-4a39-84ca-b4a309fd4947[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizations-workflow.test.ts:[2m50:5[22m[39m
    [90m 48| [39m
    [90m 49| [39m    [90m// Create test users[39m
    [90m 50| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m    [31m^[39m
    [90m 51| [39m      {
    [90m 52| [39m        id[33m:[39m user1Id[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizations-workflow.test.ts:[2m50:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f51de9ee-c72f-4a39-84ca-b4a309fd4947) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[25/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for integration tests,5e3d492c-ceeb-461d-b533-e69981a7e9cf,089b606c-be04-4842-87e7-9862e0c3e88e,5e3d492c-ceeb-461d-b533-e69981a7e9cf,5e3d492c-ceeb-461d-b533-e69981a7e9cf[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/ai/workflowEdit.test.ts:[2m123:23[22m[39m
    [90m121| [39m
    [90m122| [39m    [90m// Create test project[39m
    [90m123| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(projects)[33m.[39m[34mvalues[39m({
    [90m   | [39m                      [31m^[39m
    [90m124| [39m      title[33m:[39m [32m'Test Project'[39m[33m,[39m
    [90m125| [39m      name[33m:[39m [32m'Test Project'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/ai/workflowEdit.test.ts:[2m123:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(5e3d492c-ceeb-461d-b533-e69981a7e9cf) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w22_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[26/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/auth/auth.middleware.integration.test.ts:[2m35:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[27/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/auth/auth.middleware.integration.test.ts:[2m45:19[22m[39m
    [90m 43| [39m
    [90m 44| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 45| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 46| [39m    })[33m;[39m
    [90m 47| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[28/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/jwt.authentication.test.ts[2m > [22mJWT Authentication Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/auth/jwt.authentication.test.ts:[2m31:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[29/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/jwt.authentication.test.ts[2m > [22mJWT Authentication Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/auth/jwt.authentication.test.ts:[2m40:19[22m[39m
    [90m 38| [39m
    [90m 39| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 40| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 41| [39m    })[33m;[39m
    [90m 42| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[30/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, default, $3, $4, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: OAuth Test Project,OAuth Test Project,-Co6WKohEDVzF05M3BVF9,eb391ba9-7f62-4f29-928e-ac178673fb4c,-Co6WKohEDVzF05M3BVF9,-Co6WKohEDVzF05M3BVF9[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.callback.test.ts:[2m80:23[22m[39m
    [90m 78| [39m    authToken [33m=[39m authService[33m.[39m[34mcreateToken[39m(user)[33m;[39m
    [90m 79| [39m
    [90m 80| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(projects)[33m.[39m[34mvalues[39m({
    [90m   | [39m                      [31m^[39m
    [90m 81| [39m      title[33m:[39m [32m'OAuth Test Project'[39m[33m,[39m
    [90m 82| [39m      name[33m:[39m [32m'OAuth Test Project'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.callback.test.ts:[2m80:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 309, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(-Co6WKohEDVzF05M3BVF9) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w39_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[31/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/protected.routes.test.ts[2m > [22mProtected Routes Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/auth/protected.routes.test.ts:[2m31:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[32/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/protected.routes.test.ts[2m > [22mProtected Routes Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/auth/protected.routes.test.ts:[2m41:19[22m[39m
    [90m 39| [39m
    [90m 40| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 41| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 42| [39m    })[33m;[39m
    [90m 43| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[33/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/session.management.integration.test.ts[2m > [22mSession Management Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/auth/session.management.integration.test.ts:[2m31:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[34/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/session.management.integration.test.ts[2m > [22mSession Management Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/auth/session.management.integration.test.ts:[2m40:19[22m[39m
    [90m 38| [39m
    [90m 39| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 40| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 41| [39m    })[33m;[39m
    [90m 42| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[35/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/workflows/runtime-pipelines.test.ts[2m > [22mRuntime Pipelines Integration Tests
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, default, default, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: A71EkIo3J32ICthYt_CxD,test-pipeline-user@example.com,a545a300-a891-4a35-ae0f-0949e3545f04,admin,owner[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/workflows/runtime-pipelines.test.ts:[2m75:20[22m[39m
    [90m 73| [39m
    [90m 74| [39m    [90m// Create test user[39m
    [90m 75| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 76| [39m      id[33m:[39m testUserId[33m,[39m
    [90m 77| [39m      email[33m:[39m [32m'test-pipeline-user@example.com'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/workflows/runtime-pipelines.test.ts:[2m75:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(a545a300-a891-4a35-ae0f-0949e3545f04) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[36/310]âŽ¯[22m[39m


[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Tests 274 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mComplete Registration â†’ Login Flow[2m > [22mshould complete registration, verify email, then login
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m73:39[22m[39m
    [90m 71| [39m        })[33m;[39m
    [90m 72| [39m
    [90m 73| [39m      [34mexpect[39m(registerResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                                      [31m^[39m
    [90m 74| [39m      [34mexpect[39m(registerResponse[33m.[39mbody[33m.[39muser[33m.[39memailVerified)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m 75| [39m      [34mtrackUser[39m(registerResponse[33m.[39mbody[33m.[39muser[33m.[39mid)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[37/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mAccount Lockout Flow[2m > [22mshould lock account after 5 failed attempts, then unlock after waiting
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 24509fb6006e5c5dcb9f0dbc04e91112,$2b$12$tuQWpjbl2rhqYF21n4QDRuGyOkYqs2zrZhQ/yURQoNPwxGQUB4JHm,2026-01-17T20:22:11.004Z,2026-01-17T20:22:11.004Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m105:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m105:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(24509fb6006e5c5dcb9f0dbc04e91112) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[38/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mAccount Lockout Flow[2m > [22mshould record all login attempts
[31m[1mAssertionError[22m: expected +0 to be 3 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 3[39m
[31m+ 0[39m

[36m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m174:31[22m[39m
    [90m172| [39m      })[33m;[39m
    [90m173| [39m
    [90m174| [39m      [34mexpect[39m(attempts[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m3[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m175| [39m      [34mexpect[39m(attempts[33m.[39m[34mfilter[39m(a [33m=>[39m [33m![39ma[33m.[39msuccessful)[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m2[39m)[33m;[39m
    [90m176| [39m      [34mexpect[39m(attempts[33m.[39m[34mfilter[39m(a [33m=>[39m a[33m.[39msuccessful)[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m1[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mMFA Enrollment and Login Flow[2m > [22mshould complete MFA setup and login with TOTP
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m197:36[22m[39m
    [90m195| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m196| [39m
    [90m197| [39m      [34mexpect[39m(setupResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m198| [39m      [34mexpect[39m(setupResponse[33m.[39mbody[33m.[39mqrCodeDataUrl)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m199| [39m      [34mexpect[39m(setupResponse[33m.[39mbody[33m.[39mbackupCodes)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[40/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mMFA Enrollment and Login Flow[2m > [22mshould login with backup code when TOTP unavailable
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 2470e0fa006613f24d23de478c1487e2,$2b$12$HYiWWvqpIurQ2MvtsC4Zk.39MX3bOOnCisNC3hrvNcLDc9cgo0lN.,2026-01-17T20:22:15.217Z,2026-01-17T20:22:15.217Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m253:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m253:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(2470e0fa006613f24d23de478c1487e2) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[41/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mPassword Reset Flow[2m > [22mshould complete full password reset flow
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 827dea92ebd6da2339c5ff5188b933d8,$2b$12$liPuRpe3z6vrjjwJDZBiKeh5zHeCoqO0AaJfdhkC3uX8YMyGlNnNa,2026-01-17T20:22:16.018Z,2026-01-17T20:22:16.018Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m324:56[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m324:56[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(827dea92ebd6da2339c5ff5188b933d8) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[42/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mPassword Reset Flow[2m > [22mshould invalidate all sessions after password reset
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: f1941f0a3b655acdce0227c9d0fa76b8,$2b$12$gJEvQq97.X10iv3zfOGbL.VPc0BKAKiQ8BEdSKUHr01oTlxuk7vkq,2026-01-17T20:22:16.731Z,2026-01-17T20:22:16.731Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m383:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m383:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(f1941f0a3b655acdce0227c9d0fa76b8) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[43/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mToken Refresh Flow[2m > [22mshould rotate refresh token on each use
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 482aa8417b2aefee7ad5ea80aa1898f7,$2b$12$Z8G7czeXOlxtODAevf406OwYR0wks3LF/13yL.DyDuULU.bJDdmAu,2026-01-17T20:22:17.449Z,2026-01-17T20:22:17.449Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m430:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m430:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(482aa8417b2aefee7ad5ea80aa1898f7) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w25_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[44/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mToken Refresh Flow[2m > [22mshould detect and prevent refresh token reuse (token theft)
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 5b814c10e538263b784ad2604bf63151,$2b$12$3jLvbt0OC76WE4xuo/hpNOZZsuGMg2DximEcmB60m3JK.mSAInFLe,2026-01-17T20:22:18.194Z,2026-01-17T20:22:18.194Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m464:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m464:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(5b814c10e538263b784ad2604bf63151) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[45/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mSession Management Flow[2m > [22mshould list all active sessions
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 7a8500ebb50d1fb8ce3449e33f1a7c0e,$2b$12$vXEl3JFMIp/Q1KJQW5CL7O5ZzcBgFN4jJJBpJTnBY0r6kZelvWVne,2026-01-17T20:22:18.865Z,2026-01-17T20:22:18.865Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m507:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m507:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(7a8500ebb50d1fb8ce3449e33f1a7c0e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[46/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mSession Management Flow[2m > [22mshould revoke specific session
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m554:40[22m[39m
    [90m552| [39m
    [90m553| [39m      [35mconst[39m sessions [33m=[39m sessionsResponse[33m.[39mbody[33m.[39msessions[33m;[39m
    [90m554| [39m      [35mconst[39m sessionToRevoke [33m=[39m sessions[33m.[39m[34mfind[39m((s[33m:[39m any) [33m=>[39m [33m![39ms[33m.[39mcurrent)[33m;[39m
    [90m   | [39m                                       [31m^[39m
    [90m555| [39m
    [90m556| [39m      [90m// Revoke first session[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[47/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/register[2m > [22mshould register a new user successfully
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m78:31[22m[39m
    [90m 76| [39m        })[33m;[39m
    [90m 77| [39m
    [90m 78| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m 79| [39m      expect((response.body).message).toContain("Registration successfâ€¦
    [90m 80| [39m      [34mexpect[39m((response[33m.[39mbody)[33m.[39mtoken)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[48/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/register[2m > [22mshould return 409 for duplicate email
[31m[1mAssertionError[22m: expected 500 to be 409 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 409[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m139:31[22m[39m
    [90m137| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password[33m,[39m firstName[33m:[39m [32m"Second"[39m })[33m;[39m
    [90m138| [39m
    [90m139| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m409[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m140| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"already exists"[39m)[33m;[39m
    [90m141| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[49/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/register[2m > [22mshould set httpOnly refresh token cookie
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m151:31[22m[39m
    [90m149| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password[33m,[39m firstName[33m:[39m [32m"Test"[39m })[33m;[39m
    [90m150| [39m
    [90m151| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m152| [39m      [34mexpect[39m(response[33m.[39mheaders[[32m'set-cookie'[39m])[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m153| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[50/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould login with valid credentials
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m171:31[22m[39m
    [90m169| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password })[33m;[39m
    [90m170| [39m
    [90m171| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m172| [39m      [34mexpect[39m((response[33m.[39mbody)[33m.[39mmessage)[33m.[39m[34mtoBe[39m([32m"Login successful"[39m)[33m;[39m
    [90m173| [39m      [34mexpect[39m((response[33m.[39mbody)[33m.[39mtoken)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[51/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould return 401 for invalid password
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 81fcd5363a3f3240e74292536cf2f3ce,$2b$12$AcuoBpnGBW1rWufs1.sliOasHJe820w8dPFXBWPNcW.rkAx3fFP0K,2026-01-17T20:22:15.034Z,2026-01-17T20:22:15.034Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m185:33[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m185:33[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(81fcd5363a3f3240e74292536cf2f3ce) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[52/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould return 403 for unverified email
[31m[1mAssertionError[22m: expected 401 to be 403 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 403[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m226:31[22m[39m
    [90m224| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password })[33m;[39m
    [90m225| [39m
    [90m226| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m403[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m227| [39m      expect(response.body.message || response.body.error).toBeDefinedâ€¦
    [90m228| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[53/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould record failed login attempt
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 3b7a96a1699582955dd01492ef458a83,$2b$12$eEBqy9WxQEGfkQFayubayuRDk63rVc9WBZS5mgo.cjIx4Bi6zfKBS,2026-01-17T20:22:17.190Z,2026-01-17T20:22:17.190Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m231:33[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m231:33[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(3b7a96a1699582955dd01492ef458a83) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[54/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould return requiresMfa=true for MFA-enabled users
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 471a20d44dff93446c284f8ec172116a,FARWKQRSFR4FOPZMMNSDORZSG5LWYMSQINTSMLRGOQ2S6Z3XPN4A,true,2026-01-17T20:22:18.015Z,2026-01-17T20:22:18.015Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m252:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m252:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 322, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(471a20d44dff93446c284f8ec172116a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[55/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould lock account after 5 failed attempts
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 56cce160e1004cb60b7d61a75abc9a99,$2b$12$0faN1gBDam98I0wIa3D0hufxMnHVBtCCHnDnLifOP5C.LhMg4/SI6,2026-01-17T20:22:18.849Z,2026-01-17T20:22:18.849Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m266:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m266:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(56cce160e1004cb60b7d61a75abc9a99) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[56/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/logout[2m > [22mshould logout and clear refresh token cookie
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 5b4d9a131f1c6fa48ecb392c024fe558,$2b$12$OUxmaJF68p.Z06L8qwFhAOLTEOtRQ2SKnTJWejBRu0asjcf4anIlS,2026-01-17T20:22:19.683Z,2026-01-17T20:22:19.683Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m295:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m295:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(5b4d9a131f1c6fa48ecb392c024fe558) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[57/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould refresh access token with valid refresh token
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: dd8d329a45237fbac20398976b52d3dd,$2b$12$9ev7Ky.GW7kILs.L8viwx.uaaLcUpGYnqP4.5.ibcHv94HAJVDdIS,2026-01-17T20:22:20.410Z,2026-01-17T20:22:20.410Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m325:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m325:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(dd8d329a45237fbac20398976b52d3dd) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[58/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould rotate refresh token after use
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 92bc28213e86c25ee47bd67fd0dae574,$2b$12$1r2cRm0TQ5I9nX6/udGff..okLLPVACdu/Hx3zQ5bKqzn85jZ.NFm,2026-01-17T20:22:21.187Z,2026-01-17T20:22:21.187Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m364:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m364:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(92bc28213e86c25ee47bd67fd0dae574) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[59/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/forgot-password[2m > [22mshould send password reset email for existing user
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 8911f6874bfb11f51d9eb969fba20461,$2b$12$r/Geo674Cs4c6zbsGp/pSObHYPFw..KgouXubV7pQw/iyc5QYJ/42,2026-01-17T20:22:21.955Z,2026-01-17T20:22:21.955Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m399:33[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m399:33[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(8911f6874bfb11f51d9eb969fba20461) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[60/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/reset-password[2m > [22mshould reset password with valid token
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 8b65b6e0926d4e89afe6d58dcc5f8746,$2b$12$LfLQbswqAqLM8ioLuVgCVuYUHNiR/QAk0m3hPa0ULCnQB0BDagIsK,2026-01-17T20:22:22.867Z,2026-01-17T20:22:22.867Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m423:56[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m423:56[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(8b65b6e0926d4e89afe6d58dcc5f8746) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[61/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/reset-password[2m > [22mshould return 400 for weak new password
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: c52c0079442423528495b931e186b48b,$2b$12$bc.sJViZ5bM4o38BEvDP9OJaFK6YsyGLpuOSDrwZ4IcPpFkGciFNa,2026-01-17T20:22:23.619Z,2026-01-17T20:22:23.619Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m469:33[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m469:33[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(c52c0079442423528495b931e186b48b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[62/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mGET /api/auth/me[2m > [22mshould return current user for valid token
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m500:31[22m[39m
    [90m498| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m499| [39m
    [90m500| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m501| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39memail)[33m.[39m[34mtoBe[39m(email)[33m;[39m
    [90m502| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mid)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[63/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mMFA Routes[2m > [22mPOST /api/auth/mfa/verify-login[2m > [22mshould complete MFA login with valid TOTP code
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: f74a0048edb114867f9f342ef4b2b16d,$2b$12$aXMl9Bf/sYj1g5gcEXeWAOqFiPyJJ0U3UWd1A5jJiwJscZBwZP37u,2026-01-17T20:22:25.814Z,2026-01-17T20:22:25.814Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m523:57[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m523:57[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(f74a0048edb114867f9f342ef4b2b16d) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[64/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mMFA Routes[2m > [22mPOST /api/auth/mfa/verify-login[2m > [22mshould reject invalid MFA code
[31m[1mError[22m: Failed query: insert into "mfa_backup_codes" ("id", "user_id", "code_hash", "used", "used_at", "created_at") values (default, $1, $2, $3, default, $4), (default, $5, $6, $7, default, $8), (default, $9, $10, $11, default, $12), (default, $13, $14, $15, default, $16), (default, $17, $18, $19, default, $20), (default, $21, $22, $23, default, $24), (default, $25, $26, $27, default, $28), (default, $29, $30, $31, default, $32), (default, $33, $34, $35, default, $36), (default, $37, $38, $39, default, $40)
params: 8a716e6f0b92a8b0f5dd083cac83d27e,$2b$10$baLjK7ogynJz94JGPGGQEekCPjzyez62ppvuIN2l8YNccXqEASbu6,false,2026-01-17T20:22:26.871Z,8a716e6f0b92a8b0f5dd083cac83d27e,$2b$10$k89jJjgv1pWAT/pKOfLsL.ZTSuP2L4AumtsC0srLwtgIo3EtNM9oG,false,2026-01-17T20:22:26.881Z,8a716e6f0b92a8b0f5dd083cac83d27e,$2b$10$L/hhi1taX2VaJp93e9rSDO1N6im1UGupKkFf9MBgmwouKMBYDmib.,false,2026-01-17T20:22:26.871Z,8a716e6f0b92a8b0f5dd083cac83d27e,$2b$10$dZEgXSPq3ffT3J8bwyxXfeF/3ZB9ZA4STH7zDaw/I8cu8loqTzOOG,false,2026-01-17T20:22:26.889Z,8a716e6f0b92a8b0f5dd083cac83d27e,$2b$10$NTu50FJil3WMs0YrtorUgu2PNlUP2XBKH1X33vCNR8qIqthETXTzS,false,2026-01-17T20:22:26.957Z,8a716e6f0b92a8b0f5dd083cac83d27e,$2b$10$mUqO1m2MUAFvNEPbISrez.DV36rOnFjxZcw8u21e85Cua2MXP1DFm,false,2026-01-17T20:22:26.957Z,8a716e6f0b92a8b0f5dd083cac83d27e,$2b$10$p14NJAb.hrfrxtOwNWjCkuoQPnIxRytwcH/iquzqrc15ciLe9rMV6,false,2026-01-17T20:22:26.957Z,8a716e6f0b92a8b0f5dd083cac83d27e,$2b$10$S1mmbB1pn.mrxoIM71qd/uQTASrGYANzhg6OdNgyJej4grM/zJ7wK,false,2026-01-17T20:22:26.988Z,8a716e6f0b92a8b0f5dd083cac83d27e,$2b$10$9MCGwjApweXBGNeWHvdq3Oyulu8mWnlFrrM8Z6CqYTH20G3RbD/h2,false,2026-01-17T20:22:27.006Z,8a716e6f0b92a8b0f5dd083cac83d27e,$2b$10$2X5Vyoj4FKVhv5TBiskqA.UFyMfVjm8sMxMe1RXAAsSPENUlHXKn2,false,2026-01-17T20:22:27.006Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m258:3[22m[39m
    [90m256| [39m  )[33m;[39m
    [90m257| [39m
    [90m258| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaBackupCodes)[33m.[39m[34mvalues[39m(hashedCodes)[33m;[39m
    [90m   | [39m  [31m^[39m
    [90m259| [39m
    [90m260| [39m  [35mreturn[39m {
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m549:28[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_backup_codes" violates foreign key constraint "mfa_backup_codes_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m258:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m549:28[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(8a716e6f0b92a8b0f5dd083cac83d27e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w25_v3', table: 'mfa_backup_codes', dataType: undefined, constraint: 'mfa_backup_codes_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[65/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/js_helpers.test.ts[2m > [22mDetailed Verification: JS Helper Availability[2m > [22mshould execute a JS block that uses helper functions
[31m[1mAssertionError[22m: expected 404 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 404[39m

[36m [2mâ¯[22m tests/integration/js_helpers.test.ts:[2m163:31[22m[39m
    [90m161| [39m        [90m// 3. Create a Run[39m
    [90m162| [39m        const runRes = await agent.post(`/api/workflows/${workflowId}/â€¦
    [90m163| [39m        [34mexpect[39m(runRes[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m [90m// 201 Created[39m
    [90m   | [39m                              [31m^[39m
    [90m164| [39m        [35mconst[39m runId [33m=[39m runRes[33m.[39mbody[33m.[39mdata[33m.[39mrunId[33m;[39m
    [90m165| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[66/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould complete full MFA setup flow
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 4eb997c96288f4b0c75300beaecb2776,$2b$12$FM3PlpDC8UoszI3YJFN7o.LuA5Sciyq2c1GU/EWq1WD2ib2Sfs5h6,2026-01-17T20:22:10.202Z,2026-01-17T20:22:10.202Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m59:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m59:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(4eb997c96288f4b0c75300beaecb2776) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[67/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould reject invalid TOTP code during setup
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 3d1a1d7c848b17a930a01950a81560c7,$2b$12$EnIBM2mEFZ3vOpCCirDNl.SIDbqf32ASybtlccSJpnNki02LytlVG,2026-01-17T20:22:11.012Z,2026-01-17T20:22:11.012Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m125:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m125:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(3d1a1d7c848b17a930a01950a81560c7) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[68/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould not allow MFA setup if already enabled
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: c6aab6b82a1d0682281e683155250874,INBEGVJXMFDVULSQEVICULRQOA3USNTDHQRVOPCSH4XXISSNEUXQ,true,2026-01-17T20:22:11.996Z,2026-01-17T20:22:11.996Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m157:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m157:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(c6aab6b82a1d0682281e683155250874) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[69/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould generate unique backup codes
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 11abb296c9e59e31829acd3238c8dfa5,$2b$12$yFT7POU5tpTcOcn9McMEROCf5WzGFrDfiD5sWXTWtTCjmf.aN/30e,2026-01-17T20:22:12.835Z,2026-01-17T20:22:12.835Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m171:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m171:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(11abb296c9e59e31829acd3238c8dfa5) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[70/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould store hashed backup codes
[31m[1mAssertionError[22m: expected [] to have a length of 10 but got +0[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 10[39m
[31m+ 0[39m

[36m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m208:27[22m[39m
    [90m206| [39m      })[33m;[39m
    [90m207| [39m
    [90m208| [39m      [34mexpect[39m(storedCodes)[33m.[39m[34mtoHaveLength[39m([34m10[39m)[33m;[39m
    [90m   | [39m                          [31m^[39m
    [90m209| [39m
    [90m210| [39m      [90m// Hashes should not match plain codes[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[71/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould require MFA for enabled users
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: ff10d5b89ffd0fe097ffe9462689aa5e,IEXC4RZOGQ2DYLSTMVQUM4LEPFATSVJ2KMWECSJUIJKDAUDEHFRQ,true,2026-01-17T20:22:15.554Z,2026-01-17T20:22:15.554Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m220:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m220:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 322, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(ff10d5b89ffd0fe097ffe9462689aa5e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[72/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould complete MFA login with valid TOTP
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 2346370d34573f55835e4bc03a07bff2,FJMF2VDUPJDDG3KKMM7C6TCLNNMEQ4LNENBUINDMIU4SKV26OZEQ,true,2026-01-17T20:22:16.478Z,2026-01-17T20:22:16.478Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m234:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m234:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(2346370d34573f55835e4bc03a07bff2) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[73/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould reject invalid TOTP during login
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 32a5f1956b0551dac3f936ddbaa50b5f,$2b$12$cKO5XBsFhs2Ro4Aqq22J0.Nkjkx8dHKcQKJXvq3gy/Kwe3/nS4Oyq,2026-01-17T20:22:17.275Z,2026-01-17T20:22:17.275Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m268:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m268:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(32a5f1956b0551dac3f936ddbaa50b5f) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[74/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould accept TOTP codes within 60-second window
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 9c1014a806cffdb908e2e818ce5aa623,FRPHKJKVOUSESTTTEZPDQXLBEVBV24C6K5EFUQSVIVEHQN2UGNVQ,true,2026-01-17T20:22:18.136Z,2026-01-17T20:22:18.136Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m286:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m286:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(9c1014a806cffdb908e2e818ce5aa623) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[75/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould login with valid backup code
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: e0958e2bae63ea4d6d0b33c836ddf4a0,$2b$12$1AHM5FE/Fhi.SI3IaYr7LeBxFgfi6uak94c60Fcg7/2ZJ0wl6CNkK,2026-01-17T20:22:18.838Z,2026-01-17T20:22:18.838Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m318:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m318:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(e0958e2bae63ea4d6d0b33c836ddf4a0) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[76/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould mark backup code as used
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: e1579663f2cd8abcb0618700f60d00f6,$2b$12$t58gCmbkNaRd4SnVwYzjiOLmLQLD3d3VeksrEbjEMdOu1QuGOy.8C,2026-01-17T20:22:19.576Z,2026-01-17T20:22:19.576Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m370:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m370:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(e1579663f2cd8abcb0618700f60d00f6) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[77/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould prevent backup code reuse
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: b103d153ba20bfba3160805071bba280,$2b$12$3izVZSX9wbMVDsl9zDmdbehR6q4P4Y.aE.7UNM1fGPqdVwV/nLYBm,2026-01-17T20:22:20.301Z,2026-01-17T20:22:20.301Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m390:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m390:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(b103d153ba20bfba3160805071bba280) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[78/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould try TOTP before backup code
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 914efe7d85b0fd88db6c322a9d030b15,$2b$12$MHEnHcB9o//SjPhc6fnASOsFFQfsjlBGwFoKNmTKXzLMEIGrAqU6C,2026-01-17T20:22:21.124Z,2026-01-17T20:22:21.124Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m452:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m452:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(914efe7d85b0fd88db6c322a9d030b15) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[79/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Status[2m > [22mshould return MFA status for user
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 934cb232369837ccc4aba7b63182ba67,$2b$12$ijAVFho0KGcXM89x/JA3HuaePCkklgiM96ns.UNIDrYTnWiKwSZ7m,2026-01-17T20:22:21.885Z,2026-01-17T20:22:21.885Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m475:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m475:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(934cb232369837ccc4aba7b63182ba67) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[80/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Status[2m > [22mshould return backup codes count for MFA users
[31m[1mError[22m: [TEST UTILS] MFA Secret verification failed for bd7fcee567f2f9e773fa91fd64de816e[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m228:22[22m[39m
    [90m226| [39m    where[33m:[39m [34meq[39m(mfaSecrets[33m.[39muserId[33m,[39m userData[33m.[39muserId)
    [90m227| [39m  })[33m;[39m
    [90m228| [39m  if (!check) {throw new Error(`[TEST UTILS] MFA Secret verification fâ€¦
    [90m   | [39m                     [31m^[39m
    [90m229| [39m  if (!check.enabled) {throw new Error(`[TEST UTILS] MFA Secret enableâ€¦
    [90m230| [39m  console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}â€¦
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m492:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[81/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Disable Flow[2m > [22mshould disable MFA with password verification
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 59e7e3b1e437891afbcded8e39dd813a,$2b$12$HqBLCjEst42LB4ZAgVR20.7LGYkr1Hqoz78TYZezklkWf57uBcJ/W,2026-01-17T20:22:23.277Z,2026-01-17T20:22:23.277Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m529:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m529:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(59e7e3b1e437891afbcded8e39dd813a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[82/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Disable Flow[2m > [22mshould require correct password to disable MFA
[31m[1mError[22m: Failed query: insert into "mfa_backup_codes" ("id", "user_id", "code_hash", "used", "used_at", "created_at") values (default, $1, $2, $3, default, $4), (default, $5, $6, $7, default, $8), (default, $9, $10, $11, default, $12), (default, $13, $14, $15, default, $16), (default, $17, $18, $19, default, $20), (default, $21, $22, $23, default, $24), (default, $25, $26, $27, default, $28), (default, $29, $30, $31, default, $32), (default, $33, $34, $35, default, $36), (default, $37, $38, $39, default, $40)
params: c0b2add683b4c42d54398e8a603b6881,$2b$10$s09fA7D3HY6rPM/nD7ubzeYuc0.3JxLTQis6126L.6FWj1YOTcXsC,false,2026-01-17T20:22:24.455Z,c0b2add683b4c42d54398e8a603b6881,$2b$10$GKCmA9Mjk8ZfS7AX.VNMmuL5FlT/uHVPk6XPCoz1p1wVflytSMJ8m,false,2026-01-17T20:22:24.456Z,c0b2add683b4c42d54398e8a603b6881,$2b$10$eSm8CELaaHyMrOVnCuKtxOw2uWLwUkTxkK1eKwxqFbHxpf3nOsBwy,false,2026-01-17T20:22:24.455Z,c0b2add683b4c42d54398e8a603b6881,$2b$10$EpUJcGvp7.4RgashaF2RYOkAqjcZ/nmYkEpI2XZxT82ggn1tlHCiu,false,2026-01-17T20:22:24.483Z,c0b2add683b4c42d54398e8a603b6881,$2b$10$BSfEBrLfegVxzkghevCHye4mXkNdtn/sNCpgzsGWzZO06QaO2SZ2O,false,2026-01-17T20:22:24.553Z,c0b2add683b4c42d54398e8a603b6881,$2b$10$ro79dpBYd5kohElhcGnebeQkrxqNCwMyjPFegE6xlQF.sHzTWPdfu,false,2026-01-17T20:22:24.553Z,c0b2add683b4c42d54398e8a603b6881,$2b$10$Ly01wN8EQP8qHGoKRr04N.uhGMOmiw6TEmP28sMnHvJm0LIkUVwnC,false,2026-01-17T20:22:24.553Z,c0b2add683b4c42d54398e8a603b6881,$2b$10$7GlN0OTEFLUPXTiqS5GqouKs8ZZQyPzrypV.0GFdUpSHyHg485MBO,false,2026-01-17T20:22:24.573Z,c0b2add683b4c42d54398e8a603b6881,$2b$10$YYrAyrJYfV7ASQG.i2Ime.sg7H5RfxFLPFU7iTg0QNh0nnRw/nB1G,false,2026-01-17T20:22:24.573Z,c0b2add683b4c42d54398e8a603b6881,$2b$10$ZryEjB.iplNmEVqCwaHLY.v.cggyKVZewlhU4HWpM4QrRjD.kHrv6,false,2026-01-17T20:22:24.606Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m258:3[22m[39m
    [90m256| [39m  )[33m;[39m
    [90m257| [39m
    [90m258| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaBackupCodes)[33m.[39m[34mvalues[39m(hashedCodes)[33m;[39m
    [90m   | [39m  [31m^[39m
    [90m259| [39m
    [90m260| [39m  [35mreturn[39m {
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m579:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_backup_codes" violates foreign key constraint "mfa_backup_codes_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m258:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m579:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(c0b2add683b4c42d54398e8a603b6881) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'mfa_backup_codes', dataType: undefined, constraint: 'mfa_backup_codes_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[83/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Regeneration[2m > [22mshould regenerate backup codes
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: c9e3f456a4b2a30398fa23fb98871653,$2b$12$AONCu41RawyiqjJk2ceFWuUs2rOTVX69iA3g3x484BYTJ.E5OHESG,2026-01-17T20:22:25.519Z,2026-01-17T20:22:25.519Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m613:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m613:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(c9e3f456a4b2a30398fa23fb98871653) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[84/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Regeneration[2m > [22mshould return error if MFA not enabled
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: d12bb91b0f30029d119c97745dcd8bac,$2b$12$7vzEW0PAvnuUeCcxbnPACegJV7Zel7HCihg47FCl1WJ5/314ctBNi,2026-01-17T20:22:26.205Z,2026-01-17T20:22:26.205Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m646:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m646:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(d12bb91b0f30029d119c97745dcd8bac) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w22_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[85/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mTenant-Level MFA Enforcement[2m > [22mshould enforce MFA for tenant users when required by tenant
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: cb938a0cc9a994940eb3ca3ecb959fb5,$2b$12$lG6jhr9Pcp67s9YLj.yAYe1y3e1vNo1rf2GaKJVxclbDDAnkkV9vi,2026-01-17T20:22:27.037Z,2026-01-17T20:22:27.037Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m673:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m673:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(cb938a0cc9a994940eb3ca3ecb959fb5) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w25_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[86/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould create placeholder user for non-existent email
[31m[1mAssertionError[22m: expected undefined to be defined[39m
[36m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m91:37[22m[39m
    [90m 89| [39m            })[33m;[39m
    [90m 90| [39m
    [90m 91| [39m            [34mexpect[39m(placeholderUser)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m 92| [39m            [34mexpect[39m(placeholderUser[33m?.[39misPlaceholder)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m 93| [39m            expect(placeholderUser?.placeholderEmail).toBe(newUserEmaiâ€¦

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[87/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould create invite for existing user without creating placeholder
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould set expiry to 7 days from now
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mgetPendingInvitesForUser[2m > [22mshould not return accepted invites
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default)
params: 00000000-0000-0000-0000-000000000021,admin@test.com,Admin User,00000000-0000-0000-0000-000000000098,00000000-0000-0000-0000-000000000022,existing_1768681322833@test.com,Existing User,00000000-0000-0000-0000-000000000098[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m46:9[22m[39m
    [90m 44| [39m        await db.delete(users).where(inArray(users.id, [adminUserId, eâ€¦
    [90m 45| [39m
    [90m 46| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 47| [39m            { id: adminUserId, email: 'admin@test.com', fullName: 'Admâ€¦
    [90m 48| [39m            { id: existingUserId, email: existingUserEmail, fullName: â€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m46:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(00000000-0000-0000-0000-000000000098) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[88/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould prevent duplicate pending invites
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m119:13[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[89/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould prevent inviting existing members
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould accept invite and create membership
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould convert placeholder user to real user on accept
[31m[1mError[22m: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, $3, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"
params: Invite Test Org,00000000-0000-0000-0000-000000000098,00000000-0000-0000-0000-000000000021[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
    [90m 52| [39m    [35mreturn[39m db[33m.[39m[34mtransaction[39m([35masync[39m (tx) [33m=>[39m {
    [90m 53| [39m      [90m// Create organization with tenant scoping[39m
    [90m 54| [39m      [35mconst[39m [org] [33m=[39m [35mawait[39m tx
    [90m   | [39m                    [31m^[39m
    [90m 55| [39m        [33m.[39m[34minsert[39m(organizations)
    [90m 56| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m53:21[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organizations" violates foreign key constraint "organizations_created_by_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m53:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 368, severity: 'ERROR', code: '23503', detail: 'Key (created_by_user_id)=(00000000-0000-0000-0000-000000000021) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'organizations', dataType: undefined, constraint: 'organizations_created_by_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[90/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould require admin access to create invite
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mgetPendingInvitesForUser[2m > [22mshould return pending invites for user email
[31m[1mError[22m: User must belong to a tenant to create organizations[39m
[36m [2mâ¯[22m OrganizationService.createOrganization server/services/OrganizationService.ts:[2m49:13[22m[39m
    [90m 47| [39m
    [90m 48| [39m    [35mif[39m ([33m![39muser[33m?.[39mtenantId) {
    [90m 49| [39m      throw new Error('User must belong to a tenant to create organizaâ€¦
    [90m   | [39m            [31m^[39m
    [90m 50| [39m    }
    [90m 51| [39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m53:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[91/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould reject expired invite
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m216:34[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[92/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould reject already accepted invite
[31m[1mError[22m: Failed query: insert into "organization_invites" ("id", "org_id", "invited_email", "invited_user_id", "invited_by_user_id", "token", "status", "created_at", "expires_at", "accepted_at", "email_sent_at", "email_failed", "email_error") values (default, $1, $2, $3, $4, $5, $6, default, $7, default, default, default, default) returning "id", "org_id", "invited_email", "invited_user_id", "invited_by_user_id", "token", "status", "created_at", "expires_at", "accepted_at", "email_sent_at", "email_failed", "email_error"
params: 55726a3e-e980-4957-b2e1-fdb51fdd0607,existing_1768681322833@test.com,01fa6686-109c-4d0c-9c09-d101541775ce,00000000-0000-0000-0000-000000000021,08402626353443aa470eb78cdf58996cf064104b557d2b7cb9c3d383e7325543,pending,2026-01-24T20:22:16.016Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m506:22[22m[39m
    [90m504| [39m
    [90m505| [39m    // Create invite (non-blocking email - invite created regardless oâ€¦
    [90m506| [39m    [35mconst[39m [invite] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(organizationInvites)[33m.[39m[34mvalues[39m({
    [90m   | [39m                     [31m^[39m
    [90m507| [39m      orgId[33m,[39m
    [90m508| [39m      invitedEmail[33m:[39m normalizedEmail[33m,[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m241:34[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organization_invites" violates foreign key constraint "organization_invites_org_id_organizations_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m506:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m241:34[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 384, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(55726a3e-e980-4957-b2e1-fdb51fdd0607) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'organization_invites', dataType: undefined, constraint: 'organization_invites_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[93/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould verify email matches invite
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m257:34[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[94/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mgetPendingInvitesForUser[2m > [22mshould not return expired invites
[31m[1mError[22m: Organization not found[39m
[36m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m449:13[22m[39m
    [90m447| [39m
    [90m448| [39m    [35mif[39m ([33m![39morg) {
    [90m449| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m'Organization not found'[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m450| [39m    }
    [90m451| [39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m294:34[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[95/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mrevokeInvite[2m > [22mshould allow admin to revoke invite
[31m[1mError[22m: Organization not found[39m
[36m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m449:13[22m[39m
    [90m447| [39m
    [90m448| [39m    [35mif[39m ([33m![39morg) {
    [90m449| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m'Organization not found'[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m450| [39m    }
    [90m451| [39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m328:34[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[96/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mrevokeInvite[2m > [22mshould prevent accepting revoked invite
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m344:34[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[97/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mcreateOrganization[2m > [22mshould create organization and auto-create admin membership
[31m[1mError[22m: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, $2, default, default, default, $3, $4, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"
params: Test Org Int,Test Description Int,6b9855e7-82ee-442a-90ff-6084b5cf3633,00000000-0000-0000-0000-000000000011[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
    [90m 52| [39m    [35mreturn[39m db[33m.[39m[34mtransaction[39m([35masync[39m (tx) [33m=>[39m {
    [90m 53| [39m      [90m// Create organization with tenant scoping[39m
    [90m 54| [39m      [35mconst[39m [org] [33m=[39m [35mawait[39m tx
    [90m   | [39m                    [31m^[39m
    [90m 55| [39m        [33m.[39m[34minsert[39m(organizations)
    [90m 56| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m74:25[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m74:25[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 347, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(6b9855e7-82ee-442a-90ff-6084b5cf3633) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'organizations', dataType: undefined, constraint: 'organizations_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[98/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mgetUserOrganizations[2m > [22mshould return all organizations for user
[31m[1mError[22m: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, $3, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"
params: User Org Test Int,604352bf-49ad-4443-819d-fed0b54b5006,00000000-0000-0000-0000-000000000011[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
    [90m 52| [39m    [35mreturn[39m db[33m.[39m[34mtransaction[39m([35masync[39m (tx) [33m=>[39m {
    [90m 53| [39m      [90m// Create organization with tenant scoping[39m
    [90m 54| [39m      [35mconst[39m [org] [33m=[39m [35mawait[39m tx
    [90m   | [39m                    [31m^[39m
    [90m 55| [39m        [33m.[39m[34minsert[39m(organizations)
    [90m 56| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m100:25[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m100:25[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 346, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(604352bf-49ad-4443-819d-fed0b54b5006) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'organizations', dataType: undefined, constraint: 'organizations_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[99/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mgetUserOrganizations[2m > [22mshould return empty array for user with no memberships
[31m[1mError[22m: Test setup failed: User 00000000-0000-0000-0000-000000000011 missing tenantId[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m54:19[22m[39m
    [90m 52| [39m        [35mif[39m ([33m![39muserCheck[33m?.[39mtenantId) {
    [90m 53| [39m            console.error('CRITICAL: User lookup failed validation in â€¦
    [90m 54| [39m            throw new Error(`Test setup failed: User ${testUserId1} miâ€¦
    [90m   | [39m                  [31m^[39m
    [90m 55| [39m        }
    [90m 56| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[100/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mupdateOrganization[2m > [22mshould allow admin to update organization
[31m[1mError[22m: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, $3, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"
params: Original Name Int,d283b13c-c3e8-4934-9c2f-9c8b70054b56,00000000-0000-0000-0000-000000000011[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
    [90m 52| [39m    [35mreturn[39m db[33m.[39m[34mtransaction[39m([35masync[39m (tx) [33m=>[39m {
    [90m 53| [39m      [90m// Create organization with tenant scoping[39m
    [90m 54| [39m      [35mconst[39m [org] [33m=[39m [35mawait[39m tx
    [90m   | [39m                    [31m^[39m
    [90m 55| [39m        [33m.[39m[34minsert[39m(organizations)
    [90m 56| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m122:25[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m122:25[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 346, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(d283b13c-c3e8-4934-9c2f-9c8b70054b56) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'organizations', dataType: undefined, constraint: 'organizations_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[101/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mupdateOrganization[2m > [22mshould deny non-admin from updating organization
[31m[1mError[22m: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, $3, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"
params: Test Org Int,d283b13c-c3e8-4934-9c2f-9c8b70054b56,00000000-0000-0000-0000-000000000011[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
    [90m 52| [39m    [35mreturn[39m db[33m.[39m[34mtransaction[39m([35masync[39m (tx) [33m=>[39m {
    [90m 53| [39m      [90m// Create organization with tenant scoping[39m
    [90m 54| [39m      [35mconst[39m [org] [33m=[39m [35mawait[39m tx
    [90m   | [39m                    [31m^[39m
    [90m 55| [39m        [33m.[39m[34minsert[39m(organizations)
    [90m 56| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m139:25[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m139:25[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 347, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(d283b13c-c3e8-4934-9c2f-9c8b70054b56) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'organizations', dataType: undefined, constraint: 'organizations_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[102/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mgetOrganizationMembers[2m > [22mshould return all members of organization
[31m[1mError[22m: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, $3, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"
params: Members Test Org Int,46757ca2-69d1-4263-b1b4-8244d5d8f7bb,00000000-0000-0000-0000-000000000011[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
    [90m 52| [39m    [35mreturn[39m db[33m.[39m[34mtransaction[39m([35masync[39m (tx) [33m=>[39m {
    [90m 53| [39m      [90m// Create organization with tenant scoping[39m
    [90m 54| [39m      [35mconst[39m [org] [33m=[39m [35mawait[39m tx
    [90m   | [39m                    [31m^[39m
    [90m 55| [39m        [33m.[39m[34minsert[39m(organizations)
    [90m 56| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m160:25[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m160:25[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 346, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(46757ca2-69d1-4263-b1b4-8244d5d8f7bb) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'organizations', dataType: undefined, constraint: 'organizations_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[103/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mpromoteMember[2m > [22mshould allow admin to promote member
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,428be25f-bd3e-491e-b2b0-ffe0d0ef9470,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,428be25f-bd3e-491e-b2b0-ffe0d0ef9470,428be25f-bd3e-491e-b2b0-ffe0d0ef9470[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(428be25f-bd3e-491e-b2b0-ffe0d0ef9470) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[104/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mdemoteMember[2m > [22mshould allow admin to demote other admin
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m410:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m203:13[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[105/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mdemoteMember[2m > [22mshould prevent self-demotion
[31m[1mError[22m: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, $3, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"
params: Self Demote Test Int,46757ca2-69d1-4263-b1b4-8244d5d8f7bb,00000000-0000-0000-0000-000000000011[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
    [90m 52| [39m    [35mreturn[39m db[33m.[39m[34mtransaction[39m([35masync[39m (tx) [33m=>[39m {
    [90m 53| [39m      [90m// Create organization with tenant scoping[39m
    [90m 54| [39m      [35mconst[39m [org] [33m=[39m [35mawait[39m tx
    [90m   | [39m                    [31m^[39m
    [90m 55| [39m        [33m.[39m[34minsert[39m(organizations)
    [90m 56| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m213:25[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m213:25[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 347, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(46757ca2-69d1-4263-b1b4-8244d5d8f7bb) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'organizations', dataType: undefined, constraint: 'organizations_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[106/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mremoveMember[2m > [22mshould allow admin to remove member
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,4bad680b-dcf9-4160-8a79-f8d53d6aa774,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,4bad680b-dcf9-4160-8a79-f8d53d6aa774,4bad680b-dcf9-4160-8a79-f8d53d6aa774[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(4bad680b-dcf9-4160-8a79-f8d53d6aa774) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[107/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mremoveMember[2m > [22mshould prevent self-removal
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,4703f441-5c5d-474f-bdff-7c5f0775eb33,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,4703f441-5c5d-474f-bdff-7c5f0775eb33,4703f441-5c5d-474f-bdff-7c5f0775eb33[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(4703f441-5c5d-474f-bdff-7c5f0775eb33) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[108/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mleaveOrganization[2m > [22mshould allow member to leave organization
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,1a352d4e-2c86-4f8d-aa3f-51a7304813f8,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,1a352d4e-2c86-4f8d-aa3f-51a7304813f8,1a352d4e-2c86-4f8d-aa3f-51a7304813f8[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1a352d4e-2c86-4f8d-aa3f-51a7304813f8) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[109/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mleaveOrganization[2m > [22mshould allow admin to leave organization
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,96509b1e-d21f-4033-9f7c-72477f76aed6,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,96509b1e-d21f-4033-9f7c-72477f76aed6,96509b1e-d21f-4033-9f7c-72477f76aed6[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(96509b1e-d21f-4033-9f7c-72477f76aed6) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[110/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mcanAccessAsset[2m > [22mshould allow access to org-owned asset by org member
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 10000000-0000-0000-0000-000000000001,00000000-0000-0000-0000-000000000001,member[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m80:7[22m[39m
    [90m 78| [39m    it('should allow access to org-owned asset by org member', async (â€¦
    [90m 79| [39m      [90m// Create membership[39m
    [90m 80| [39m      [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m({
    [90m   | [39m      [31m^[39m
    [90m 81| [39m        orgId[33m:[39m orgId1[33m,[39m
    [90m 82| [39m        userId[33m:[39m userId1[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m80:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 379, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(00000000-0000-0000-0000-000000000001) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w23_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[111/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22misOrgMember[2m > [22mshould return true for org admin
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m126:24[22m[39m
    [90m124| [39m
    [90m125| [39m      [35mconst[39m isMember [33m=[39m [35mawait[39m [34misOrgMember[39m(userId1[33m,[39m orgId1)[33m;[39m
    [90m126| [39m      [34mexpect[39m(isMember)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m127| [39m    })[33m;[39m
    [90m128| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[112/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mgetUserOrgIds[2m > [22mshould return all org IDs for a user
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default), (default, $4, $5, $6, default)
params: 10000000-0000-0000-0000-000000000001,00000000-0000-0000-0000-000000000001,member,10000000-0000-0000-0000-000000000002,00000000-0000-0000-0000-000000000001,admin[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m161:7[22m[39m
    [90m159| [39m  [34mdescribe[39m([32m'getUserOrgIds'[39m[33m,[39m () [33m=>[39m {
    [90m160| [39m    [34mit[39m([32m'should return all org IDs for a user'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m161| [39m      [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m([
    [90m   | [39m      [31m^[39m
    [90m162| [39m        { orgId[33m:[39m orgId1[33m,[39m userId[33m:[39m userId1[33m,[39m role[33m:[39m [32m'member'[39m }[33m,[39m
    [90m163| [39m        { orgId[33m:[39m orgId2[33m,[39m userId[33m:[39m userId1[33m,[39m role[33m:[39m [32m'admin'[39m }[33m,[39m

[31m[1mCaused by: error[22m: duplicate key value violates unique constraint "org_membership_unique_idx"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m161:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23505', detail: 'Key (org_id, user_id)=(10000000-0000-0000-0000-000000000001, 00000000-0000-0000-0000-000000000001) already exists.', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w22_v3', table: 'organization_memberships', dataType: undefined, constraint: 'org_membership_unique_idx', file: 'nbtinsert.c', routine: '_bt_check_unique' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[113/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mCross-org Access Control[2m > [22mshould not allow member of org1 to access org2-owned assets
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 10000000-0000-0000-0000-000000000001,00000000-0000-0000-0000-000000000001,member[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m208:7[22m[39m
    [90m206| [39m  [34mdescribe[39m([32m'Cross-org Access Control'[39m[33m,[39m () [33m=>[39m {
    [90m207| [39m    it('should not allow member of org1 to access org2-owned assets', â€¦
    [90m208| [39m      [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m({
    [90m   | [39m      [31m^[39m
    [90m209| [39m        orgId[33m:[39m orgId1[33m,[39m
    [90m210| [39m        userId[33m:[39m userId1[33m,[39m

[31m[1mCaused by: error[22m: duplicate key value violates unique constraint "org_membership_unique_idx"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m208:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23505', detail: 'Key (org_id, user_id)=(10000000-0000-0000-0000-000000000001, 00000000-0000-0000-0000-000000000001) already exists.', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w22_v3', table: 'organization_memberships', dataType: undefined, constraint: 'org_membership_unique_idx', file: 'nbtinsert.c', routine: '_bt_check_unique' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[114/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m1. Required + Show/Hide (Questions)[2m > [22mshould block Next when required visible question is empty
[31m[1mError[22m: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values ($1, $2, default, $3, default, $4, default, default, default, default, $5, default, default, default, default)
params: f42cbc63-1aad-4cb3-8851-6f5f6d3850e4,90486206-7c4e-4622-941e-f46518b58518,1,{},c408e90d-a27d-4c45-8b6d-001ce4835828[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m110:13[22m[39m
    [90m108| [39m            })[33m;[39m
    [90m109| [39m
    [90m110| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflowVersions)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m111| [39m                id[33m:[39m workflowVersionId[33m,[39m
    [90m112| [39m                workflowId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m110:13[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 375, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(90486206-7c4e-4622-941e-f46518b58518) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w36_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[115/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m1. Required + Show/Hide (Questions)[2m > [22mshould NOT block Next when required question is hidden
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 34ce3963-5d1e-46e8-81f0-47d05442e6a9,Required Question Test,c408e90d-a27d-4c45-8b6d-001ce4835828,c408e90d-a27d-4c45-8b6d-001ce4835828,b354499e-f01d-4d16-8e0e-fb28f87a3643,ff8e85b6-d7e8-47d3-88bc-8ee3399ae5d2[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m
    [90m 98| [39m            workflowVersionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 99| [39m
    [90m100| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m101| [39m                id[33m:[39m workflowId[33m,[39m
    [90m102| [39m                projectId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(c408e90d-a27d-4c45-8b6d-001ce4835828) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w49_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[116/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m1. Required + Show/Hide (Questions)[2m > [22mshould block when required becomes visible and is empty
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: cd79464e-1bb9-44c4-ad1d-c8b7e04fd68c,Required Question Test,c408e90d-a27d-4c45-8b6d-001ce4835828,c408e90d-a27d-4c45-8b6d-001ce4835828,b354499e-f01d-4d16-8e0e-fb28f87a3643,aece44ad-dfbc-403a-8e48-9f8f2e9fa276[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m
    [90m 98| [39m            workflowVersionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 99| [39m
    [90m100| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m101| [39m                id[33m:[39m workflowId[33m,[39m
    [90m102| [39m                projectId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(c408e90d-a27d-4c45-8b6d-001ce4835828) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w44_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[117/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m2. Required + Show/Hide (Pages)[2m > [22mshould skip hidden required page entirely
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: d3c13e51-833f-473d-86ff-4d9c8346d370,Page Visibility Test,c408e90d-a27d-4c45-8b6d-001ce4835828,c408e90d-a27d-4c45-8b6d-001ce4835828,b354499e-f01d-4d16-8e0e-fb28f87a3643,fc7d7086-1bdc-436c-88ef-b710382b12fa[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m272:13[22m[39m
    [90m270| [39m            workflowVersionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m271| [39m
    [90m272| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m273| [39m                id[33m:[39m workflowId[33m,[39m
    [90m274| [39m                projectId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m272:13[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(c408e90d-a27d-4c45-8b6d-001ce4835828) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w44_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[118/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m2. Required + Show/Hide (Pages)[2m > [22mshould enforce required on visible page
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 07c77b75-ee4c-49b2-bb75-c2b5d5a29bf9,Page Required Test,c408e90d-a27d-4c45-8b6d-001ce4835828,c408e90d-a27d-4c45-8b6d-001ce4835828,b354499e-f01d-4d16-8e0e-fb28f87a3643,2a5bdc17-46b0-442f-84d1-d8e99ca77e16[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m357:13[22m[39m
    [90m355| [39m            workflowVersionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m356| [39m
    [90m357| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m358| [39m                id[33m:[39m workflowId[33m,[39m
    [90m359| [39m                projectId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m357:13[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(c408e90d-a27d-4c45-8b6d-001ce4835828) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w44_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[119/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould list all active sessions for current user
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: cac927be663d966cde4c8e018cb13c9f,$2b$12$D5JbhlgreRk.hIPnda3fpuOSqXXYIQTPmEC7SX3zhzKgpeyq8EH8u,2026-01-17T20:22:10.159Z,2026-01-17T20:22:10.159Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m57:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m57:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(cac927be663d966cde4c8e018cb13c9f) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[120/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould mark current session correctly
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 617d1e69cade3e1f0f5c53294a5a01a0,$2b$12$uTEZ40EOkLZoFDRtBNUzyuhxiBhHTBWKHpowF1FF31tFMfMH.0BDy,2026-01-17T20:22:10.902Z,2026-01-17T20:22:10.902Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m105:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m105:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(617d1e69cade3e1f0f5c53294a5a01a0) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[121/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould exclude revoked sessions
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: c381817abde881e7de01a54f839e0116,$2b$12$p5C196INWaKYG6trJL0oseB1.kosxFTIRB0i.B9kM64e6NctRrjEC,2026-01-17T20:22:11.735Z,2026-01-17T20:22:11.735Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m135:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m135:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(c381817abde881e7de01a54f839e0116) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[122/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould order sessions by last used (most recent first)
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'length')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m190:36[22m[39m
    [90m188| [39m
    [90m189| [39m      [90m// Should be ordered by lastUsedAt descending[39m
    [90m190| [39m      [35mfor[39m ([35mlet[39m i [33m=[39m [34m1[39m[33m;[39m i [33m<[39m sessions[33m.[39mlength[33m;[39m i[33m++[39m) {
    [90m   | [39m                                   [31m^[39m
    [90m191| [39m        [35mconst[39m prev [33m=[39m [35mnew[39m [33mDate[39m(sessions[i [33m-[39m [34m1[39m][33m.[39mlastUsedAt)[33m;[39m
    [90m192| [39m        [35mconst[39m curr [33m=[39m [35mnew[39m [33mDate[39m(sessions[i][33m.[39mlastUsedAt)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[123/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould filter sessions by current user only
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 74f5060bf3986e0d7ec26da4e48cfc2b,$2b$12$dPkfDDtOH3MiaF4J9MiNweBG4eo4uOWK/OLUTotQTUNrFI3s.GZnm,2026-01-17T20:22:14.710Z,2026-01-17T20:22:14.710Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m198:21[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m198:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(74f5060bf3986e0d7ec26da4e48cfc2b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[124/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould revoke specific session
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: dfa9e3d6535a024100d76ff3bab9b456,$2b$12$UDiA.ff7zOyDZd8q1SWAQOp2TMYT/CHrBVdouYxuKKMxPOD80Uim2,2026-01-17T20:22:15.439Z,2026-01-17T20:22:15.439Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m234:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m234:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(dfa9e3d6535a024100d76ff3bab9b456) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[125/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould prevent revoking current session
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m289:30[22m[39m
    [90m287| [39m      [35mconst[39m token [33m=[39m login[33m.[39mbody[33m.[39mtoken[33m;[39m
    [90m288| [39m      [35mconst[39m cookies [33m=[39m (login[33m.[39mheaders [35mas[39m any)[[32m"set-cookie"[39m] [35mas[39m string[][33m;[39m
    [90m289| [39m      const cookie = cookies.find((c) => c.startsWith("refresh_token="â€¦
    [90m   | [39m                             [31m^[39m
    [90m290| [39m
    [90m291| [39m      [90m// Get sessions[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[126/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould return 404 for non-existent session
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 382bffc79b6f409f05898c523516cc82,$2b$12$7RoyczCSiCKiF1dLJuV8Nuw1XFitZGW9mUV2p1tzrJFQmHAG.b6ei,2026-01-17T20:22:17.451Z,2026-01-17T20:22:17.451Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m312:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m312:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(382bffc79b6f409f05898c523516cc82) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[127/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould prevent revoking other user's session
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: c7bfc10c918bc8a7825951d3d97c2fd3,$2b$12$JbBjOxYV8IP8g90LTVoW7.xqSYKzuhUbL99w6LDKJ7ptroDgVtG66,2026-01-17T20:22:18.165Z,2026-01-17T20:22:18.165Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m327:21[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m327:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(c7bfc10c918bc8a7825951d3d97c2fd3) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[128/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould revoke all other sessions
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: a84c1a89b52e911e887cebadd3af1829,$2b$12$ygLo.t.8Cw0GthfelPZ9peNFx1JszuBgT5sDQnRkSh/SECPc0hMeG,2026-01-17T20:22:18.844Z,2026-01-17T20:22:18.844Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m360:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m360:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(a84c1a89b52e911e887cebadd3af1829) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[129/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould keep current session active
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 14663c1be9b2747ba79ec3a0ac4be175,$2b$12$9SPpTr6xAfLogRYIohcCUeTgboPPHeBFiA5YQIs6L4e/iRVTStgdq,2026-01-17T20:22:19.613Z,2026-01-17T20:22:19.613Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m394:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m394:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(14663c1be9b2747ba79ec3a0ac4be175) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[130/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould return 400 if no active session found
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 6ea50a1473c30b4802996e3777f01bd7,$2b$12$Sed95wfGxH55pS0IonAQbufoRdIM/82WwldDuYhNSJ2QJ8s9p7/9O,2026-01-17T20:22:20.411Z,2026-01-17T20:22:20.411Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m430:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m430:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(6ea50a1473c30b4802996e3777f01bd7) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[131/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould revoke all trusted devices
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 70858edc99cda4fa0f00df1f2c6e8966,$2b$12$Za./wuRcfeHUvxMP5PcV9egWoImQKhn6rMEooQm6vBCp.jeDKW0ma,2026-01-17T20:22:21.193Z,2026-01-17T20:22:21.193Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m449:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m449:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(70858edc99cda4fa0f00df1f2c6e8966) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[132/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould handle user with single session gracefully
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m490:30[22m[39m
    [90m488| [39m      [35mconst[39m token [33m=[39m login[33m.[39mbody[33m.[39mtoken[33m;[39m
    [90m489| [39m      [35mconst[39m cookies [33m=[39m (login[33m.[39mheaders [35mas[39m any)[[32m"set-cookie"[39m] [35mas[39m string[][33m;[39m
    [90m490| [39m      const cookie = cookies.find((c) => c.startsWith("refresh_token="â€¦
    [90m   | [39m                             [31m^[39m
    [90m491| [39m
    [90m492| [39m      [90m// Revoke all (but only one exists)[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[133/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould include device metadata in sessions
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m526:37[22m[39m
    [90m524| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m525| [39m
    [90m526| [39m      [35mconst[39m session [33m=[39m response[33m.[39mbody[33m.[39msessions[[34m0[39m][33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m527| [39m
    [90m528| [39m      [34mexpect[39m(session[33m.[39mdeviceName)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[134/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould not expose sensitive token data
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: fe52d72b11595095d1387cd6f047edbf,$2b$12$a4YDV4cRJCpdqg3ncWIzkurTa76CRRV5WIol/Ao4ccLTVhFz8.kDG,2026-01-17T20:22:24.729Z,2026-01-17T20:22:24.729Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m533:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m533:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(fe52d72b11595095d1387cd6f047edbf) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[135/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould track session activity timestamps
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: d29203c930594bd2c6e68896fd931931,$2b$12$ZBSEgV4l1IPOHp1hrMI12uDlldRxbamKMJupILZvhXIHKPz02VysG,2026-01-17T20:22:25.507Z,2026-01-17T20:22:25.507Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m552:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m552:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(d29203c930594bd2c6e68896fd931931) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[136/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mProject Transfer[2m > [22mshould transfer user-owned project to org
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 873383f4-592d-4f18-9225-76d212542f9c,00000000-0000-0000-0000-000000000032,member[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m420:5[22m[39m
    [90m418| [39m
    [90m419| [39m    [90m// Add membership[39m
    [90m420| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m({
    [90m   | [39m    [31m^[39m
    [90m421| [39m      orgId[33m,[39m
    [90m422| [39m      userId[33m:[39m targetUserId[33m,[39m
[90m [2mâ¯[22m tests/integration/transferOwnership.test.ts:[2m64:9[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m420:5[22m[39m
[90m [2mâ¯[22m tests/integration/transferOwnership.test.ts:[2m64:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 399, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(873383f4-592d-4f18-9225-76d212542f9c) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[137/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mProject Transfer[2m > [22mshould prevent transfer to org if user is not a member
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mWorkflow Transfer[2m > [22mshould keep workflow in project when transferring to same owner
[31m[1mError[22m: User must belong to a tenant to create organizations[39m
[36m [2mâ¯[22m OrganizationService.createOrganization server/services/OrganizationService.ts:[2m49:13[22m[39m
    [90m 47| [39m
    [90m 48| [39m    [35mif[39m ([33m![39muser[33m?.[39mtenantId) {
    [90m 49| [39m      throw new Error('User must belong to a tenant to create organizaâ€¦
    [90m   | [39m            [31m^[39m
    [90m 50| [39m    }
    [90m 51| [39m
[90m [2mâ¯[22m tests/integration/transferOwnership.test.ts:[2m57:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[138/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mProject Transfer[2m > [22mshould allow org member to transfer org-owned project to another org they belong to
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000031,transfer1@test.com,Transfer User 1,00000000-0000-0000-0000-000000000099,00000000-0000-0000-0000-000000000032,transfer2@test.com,Transfer User 2,00000000-0000-0000-0000-000000000099,00000000-0000-0000-0000-000000000099[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/transferOwnership.test.ts:[2m48:9[22m[39m
    [90m 46| [39m
    [90m 47| [39m        [90m// Create test users[39m
    [90m 48| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 49| [39m            { id: userId1, email: 'transfer1@test.com', fullName: 'Traâ€¦
    [90m 50| [39m            { id: userId2, email: 'transfer2@test.com', fullName: 'Traâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/transferOwnership.test.ts:[2m48:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(00000000-0000-0000-0000-000000000099) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[139/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mWorkflow Transfer[2m > [22mshould detach workflow from project when transferring to different owner
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mWorkflow Transfer[2m > [22mshould prevent non-member from transferring org workflow
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mDatabase Transfer[2m > [22mshould prevent transfer to org if user is not a member
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mTransfer Validation[2m > [22mshould only allow transfer to self when targetOwnerType is user
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mTransfer Validation[2m > [22mshould allow transfer from user to self (org member transferring org asset to themselves)
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m410:5[22m[39m
[90m [2mâ¯[22m tests/integration/transferOwnership.test.ts:[2m64:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[140/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mDatabase Transfer[2m > [22mshould transfer database ownership
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: bd338b75-bb0c-49b1-ab37-55f0e59d9869,00000000-0000-0000-0000-000000000032,member[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m420:5[22m[39m
    [90m418| [39m
    [90m419| [39m    [90m// Add membership[39m
    [90m420| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m({
    [90m   | [39m    [31m^[39m
    [90m421| [39m      orgId[33m,[39m
    [90m422| [39m      userId[33m:[39m targetUserId[33m,[39m
[90m [2mâ¯[22m tests/integration/transferOwnership.test.ts:[2m64:9[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m420:5[22m[39m
[90m [2mâ¯[22m tests/integration/transferOwnership.test.ts:[2m64:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 400, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(bd338b75-bb0c-49b1-ab37-55f0e59d9869) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[141/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mDatabase Transfer[2m > [22mshould allow org member to transfer org database
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 20510f5f-725a-42e5-9ee0-e92ceb32ea71,00000000-0000-0000-0000-000000000032,member[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m420:5[22m[39m
    [90m418| [39m
    [90m419| [39m    [90m// Add membership[39m
    [90m420| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m({
    [90m   | [39m    [31m^[39m
    [90m421| [39m      orgId[33m,[39m
    [90m422| [39m      userId[33m:[39m targetUserId[33m,[39m
[90m [2mâ¯[22m tests/integration/transferOwnership.test.ts:[2m64:9[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m420:5[22m[39m
[90m [2mâ¯[22m tests/integration/transferOwnership.test.ts:[2m64:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 400, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(20510f5f-725a-42e5-9ee0-e92ceb32ea71) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[142/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mPOST /api/auth/trust-device[2m > [22mshould trust current device
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 2a3332580e9071cb3efd0f3833861e4e,MQ5HGYJXPJ4CYPB2EVUS66BKNB4TG2LOKJXVMLCHLJKGQ32GHZRQ,true,2026-01-17T20:22:10.341Z,2026-01-17T20:22:10.341Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m58:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m58:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(2a3332580e9071cb3efd0f3833861e4e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[143/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mPOST /api/auth/trust-device[2m > [22mshould set trust expiry to 30 days
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: c6d59c724019fc2258946feaec490560,$2b$12$8O/vfdlUrEYD75NOCjeGJ.Qzgto7Y2QWNOH3Ic.tHLBj430xkOJIK,2026-01-17T20:22:11.139Z,2026-01-17T20:22:11.139Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m97:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m97:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(c6d59c724019fc2258946feaec490560) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[144/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mPOST /api/auth/trust-device[2m > [22mshould update expiry if device already trusted
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 597fe9e01ad345709722b8cc714b04e3,$2b$12$CnvTTZjhk.Ow2rgnQAfNHehyxwLBJfujBpcQ74M28V93iHdindALG,2026-01-17T20:22:11.823Z,2026-01-17T20:22:11.823Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m124:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m124:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(597fe9e01ad345709722b8cc714b04e3) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[145/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould list all trusted devices
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 2f3db0b212f34b70a51d8573a67f2ca0,$2b$12$ur26SCL7oTd3Stf8K0nlAOnr0wLT5XAGlC4fa2cMaxTbnQ2NR7Qsu,2026-01-17T20:22:12.600Z,2026-01-17T20:22:12.600Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m183:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m183:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(2f3db0b212f34b70a51d8573a67f2ca0) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[146/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould mark current device
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 87242350e162e39c9f91e034cb7ec50a,GAUG2ZCCFJ3D6TKBIVCUMUBFPF3XWI3IKVLDWL2KKRNFOXS5KV3Q,true,2026-01-17T20:22:13.527Z,2026-01-17T20:22:13.527Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m240:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m240:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(87242350e162e39c9f91e034cb7ec50a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[147/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould exclude revoked devices
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 6072b8688306f805ad62c33d7a215ef7,$2b$12$izEIZRaqS8XrzR0gvVrip.Od60EiCvJavMZTVR/USP1F1Qqy4hUVK,2026-01-17T20:22:14.577Z,2026-01-17T20:22:14.577Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m272:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m272:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(6072b8688306f805ad62c33d7a215ef7) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[148/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould exclude expired devices
[31m[1mError[22m: Failed query: insert into "mfa_backup_codes" ("id", "user_id", "code_hash", "used", "used_at", "created_at") values (default, $1, $2, $3, default, $4), (default, $5, $6, $7, default, $8), (default, $9, $10, $11, default, $12), (default, $13, $14, $15, default, $16), (default, $17, $18, $19, default, $20), (default, $21, $22, $23, default, $24), (default, $25, $26, $27, default, $28), (default, $29, $30, $31, default, $32), (default, $33, $34, $35, default, $36), (default, $37, $38, $39, default, $40)
params: 4740a09eaa4b3c6c00a97677e1ade9f3,$2b$10$/VhHVA8PBUdjXsILxQukUuPqdL/npmb3kGHRvtV7dOHlDQ1hfTek2,false,2026-01-17T20:22:15.823Z,4740a09eaa4b3c6c00a97677e1ade9f3,$2b$10$R2QLc9YwvjsPZvJ8pArbK.4OP1eniPo70uOuIix3Z972nCw8CrI1q,false,2026-01-17T20:22:15.823Z,4740a09eaa4b3c6c00a97677e1ade9f3,$2b$10$IlvKaY4rTWHAOi.NcDULJ.q5EBXjJZYaoooGP3QpMkRq5GkneFc/u,false,2026-01-17T20:22:15.835Z,4740a09eaa4b3c6c00a97677e1ade9f3,$2b$10$X8YeOMz8vMogoA85lkRjd.XlwGqQl64mGYSniFcWXKbhvSI43R2GO,false,2026-01-17T20:22:15.832Z,4740a09eaa4b3c6c00a97677e1ade9f3,$2b$10$mUH0798f6GI0y/r5a1khRuja0GK9yOp0gBwZUagZi5dRBQymHbLgy,false,2026-01-17T20:22:15.931Z,4740a09eaa4b3c6c00a97677e1ade9f3,$2b$10$yFeiqtSte213YhiWG/eEAuAWvGbrAJMty8xA9jvObnpcNaftw7DmK,false,2026-01-17T20:22:15.931Z,4740a09eaa4b3c6c00a97677e1ade9f3,$2b$10$Xtuhy3ueNgBIXenpaxnDJe0pdgQ.45lI/ysTeN7UeQccyZvvWy.vC,false,2026-01-17T20:22:15.931Z,4740a09eaa4b3c6c00a97677e1ade9f3,$2b$10$2pCkLR/RRJzvUWAlgArr3uE5RguhguQ0Qnm.7bcfSP0G1LIWHYDAO,false,2026-01-17T20:22:15.931Z,4740a09eaa4b3c6c00a97677e1ade9f3,$2b$10$6XQxBu/UFgDUrcq3d0BfwOyPmz5aXu9cI9k1F.jTZENt.BtKIYIQy,false,2026-01-17T20:22:16.024Z,4740a09eaa4b3c6c00a97677e1ade9f3,$2b$10$isERgDXHJ137IGPFDR4v7e0W.TF81eZMFPfhsom0tZboPxDD8JQLK,false,2026-01-17T20:22:16.024Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m258:3[22m[39m
    [90m256| [39m  )[33m;[39m
    [90m257| [39m
    [90m258| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaBackupCodes)[33m.[39m[34mvalues[39m(hashedCodes)[33m;[39m
    [90m   | [39m  [31m^[39m
    [90m259| [39m
    [90m260| [39m  [35mreturn[39m {
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m305:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_backup_codes" violates foreign key constraint "mfa_backup_codes_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m258:3[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m305:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(4740a09eaa4b3c6c00a97677e1ade9f3) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'mfa_backup_codes', dataType: undefined, constraint: 'mfa_backup_codes_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[149/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould revoke specific device
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 08ded7fc49686cf3a92845f43e4ac014,$2b$12$LV5HRJYTcQFl3KNBPATdPuEAUzY05mssW.HavPQIunMEucwKNPcI2,2026-01-17T20:22:16.920Z,2026-01-17T20:22:16.920Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m341:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m341:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(08ded7fc49686cf3a92845f43e4ac014) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[150/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould return 404 for non-existent device
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: a19108295f9f5161c057808c97eaf871,MNFGSQ2GLN5XA5L3H5IFEPSDPJGVOSCBGASFWJRGLI7TK5CSEVGA,true,2026-01-17T20:22:17.804Z,2026-01-17T20:22:17.804Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m391:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m391:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(a19108295f9f5161c057808c97eaf871) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[151/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould prevent revoking other user's device
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 46e32e55fe7d96b660bca2eaba966585,LJ4EEZ3ZMJEX23TIONZDCL2HFFHWKPRUGVGUMZKNF4UXMNRBOBIA,true,2026-01-17T20:22:18.848Z,2026-01-17T20:22:18.848Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m410:21[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m410:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 322, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(46e32e55fe7d96b660bca2eaba966585) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[152/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDevice Trust with MFA Login[2m > [22mshould skip MFA for trusted device
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 89516b3f75b8f7d5206aec619acac4ac,$2b$12$XsyxK83alkiUAqplBbxnh.TDbsvLMJ3rtzGWzHcgWxO3WcMtzuxmy,2026-01-17T20:22:19.580Z,2026-01-17T20:22:19.580Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m459:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m459:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(89516b3f75b8f7d5206aec619acac4ac) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[153/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDevice Trust with MFA Login[2m > [22mshould require MFA for untrusted device
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 7c84b61afa1862a8f230856a3f55c7ee,$2b$12$I1unbv4V5zqUg2XC7GMyl.Quxz2Ts1bOXbPUlXng.0FOIkTCwI7Tu,2026-01-17T20:22:20.391Z,2026-01-17T20:22:20.391Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m497:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m497:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(7c84b61afa1862a8f230856a3f55c7ee) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[154/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDevice Trust with MFA Login[2m > [22mshould update lastUsedAt on trusted device login
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: b33fc724e2469c95e0857f6cff8b7436,$2b$12$BmSauzkdAT.9pCllQ6WbOOT9OeIDxme/81nHhDgFA6iC2FsJ5Sf6a,2026-01-17T20:22:21.136Z,2026-01-17T20:22:21.136Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m528:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m528:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(b33fc724e2469c95e0857f6cff8b7436) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[155/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mREPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 3608e8ae-02fc-4d6b-879e-4fb070e3e5dd,Safety Workflow,d985f944-b8f7-468a-97a1-be186e35807f,d985f944-b8f7-468a-97a1-be186e35807f,c0246a21-2166-407a-8a5f-18363d71d95a,cf6edae2-fcc2-45a7-ab4a-568830503e28[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m
    [90m 73| [39m        workflowId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 74| [39m        versionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 75| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(workflowsSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 76| [39m            id[33m:[39m workflowId[33m,[39m
    [90m 77| [39m            projectId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(d985f944-b8f7-468a-97a1-be186e35807f) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w22_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[156/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mScriptEngine resolves alias 'input_variable' when aliasMap is provided
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default)
params: 36e53b53-9b0d-47db-a822-efa1e457e9a9,safety - f538340f-ded3-4cb2-b00a-b53da8f7278e @example.com,6b71ffd0-5037-49a8-91f9-1bfd47e774d7,admin,owner,local[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m
    [90m 49| [39m
    [90m 50| [39m        userId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 51| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(usersSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 52| [39m            id[33m:[39m userId[33m,[39m
    [90m 53| [39m            email[33m:[39m [32m`safety - [39m[36m${[39m[34muuidv4[39m()[36m}[39m[32m @example.com`[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(6b71ffd0-5037-49a8-91f9-1bfd47e774d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w22_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[157/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mREPRO: BlockRunner fails to resolve alias in CreateRecordConfig
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default)
params: 2edeaeeb-81e9-44bd-8fb1-53aaa1ffef7d,safety - d1da48a8-5d77-4d5f-9e24-b22eaf2e0554 @example.com,19abec7d-ab99-4731-b7e6-49592f259448,admin,owner,local[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m
    [90m 49| [39m
    [90m 50| [39m        userId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 51| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(usersSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 52| [39m            id[33m:[39m userId[33m,[39m
    [90m 53| [39m            email[33m:[39m [32m`safety - [39m[36m${[39m[34muuidv4[39m()[36m}[39m[32m @example.com`[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(19abec7d-ab99-4731-b7e6-49592f259448) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w40_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[158/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mBlockRunner logic resolves alias with aliasMap
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, default, $4, $5, $6, $7, default, default, default, default, default, default)
params: d88af177-924e-4790-b1c4-557f8fd63484,Safety Project,Safety Project,f9edfda5-cdbf-4638-94f5-dca3b5154a63,6d28024e-dc85-4dbe-8fa2-bd684c748a82,f9edfda5-cdbf-4638-94f5-dca3b5154a63,f9edfda5-cdbf-4638-94f5-dca3b5154a63[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m63:9[22m[39m
    [90m 61| [39m        [90m// 2. Setup Project & Workflow[39m
    [90m 62| [39m        projectId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 63| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(projectsSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 64| [39m            id[33m:[39m projectId[33m,[39m
    [90m 65| [39m            name[33m:[39m [32m"Safety Project"[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m63:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(f9edfda5-cdbf-4638-94f5-dca3b5154a63) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w42_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[159/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/workflow_versioning.test.ts[2m > [22mWorkflow Versioning & Lineage[2m > [22mshould create a version and populate changelog
[31m[1mError[22m: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default)
params: 376db6ea-090a-4e13-8297-04afe2a8aa65,publish,workflow_version,c865647e-f96d-4031-909d-fc8f631d93c7,{"notes":"Initial version","checksum":"1a9e59ad8ac8d8ccaa360880d6023a7d8a50e1c8317f85dfc0d66a6313f807e2","versionNumber":1,"validationWarnings":[],"forced":false,"changelog":null}[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m VersionService.publishVersion server/services/VersionService.ts:[2m342:5[22m[39m
    [90m340| [39m
    [90m341| [39m    [90m// Log audit event[39m
    [90m342| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(schema[33m.[39mauditLogs)[33m.[39m[34mvalues[39m({
    [90m   | [39m    [31m^[39m
    [90m343| [39m      userId[33m:[39m userId[33m,[39m
    [90m344| [39m      entityType[33m:[39m [32m'workflow_version'[39m[33m,[39m
[90m [2mâ¯[22m tests/integration/workflow_versioning.test.ts:[2m108:20[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "audit_logs" violates foreign key constraint "audit_logs_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m VersionService.publishVersion server/services/VersionService.ts:[2m342:5[22m[39m
[90m [2mâ¯[22m tests/integration/workflow_versioning.test.ts:[2m108:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(376db6ea-090a-4e13-8297-04afe2a8aa65) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w39_v3', table: 'audit_logs', dataType: undefined, constraint: 'audit_logs_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[160/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/workflow_versioning.test.ts[2m > [22mWorkflow Versioning & Lineage[2m > [22mshould track execution lineage via snapshot
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'id')[39m
[36m [2mâ¯[22m tests/integration/workflow_versioning.test.ts:[2m130:143[22m[39m
    [90m128| [39m
    [90m129| [39m        [90m// Create Snapshot[39m
    [90m130| [39m        const snapshot = await snapshotService.createSnapshot(workflowâ€¦
    [90m   | [39m                                                                                                                                              [31m^[39m
    [90m131| [39m
    [90m132| [39m        [34mexpect[39m(snapshot[33m.[39mworkflowVersionId)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[161/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould successfully authenticate with valid Google ID token
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m91:31[22m[39m
    [90m 89| [39m
    [90m 90| [39m      [90m// Verify response[39m
    [90m 91| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m 92| [39m      [34mexpect[39m(response[33m.[39mbody)[33m.[39m[34mtoMatchObject[39m({
    [90m 93| [39m        message[33m:[39m [32m'Authentication successful'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[162/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould update existing user on subsequent logins
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m257:31[22m[39m
    [90m255| [39m        })[33m;[39m
    [90m256| [39m
    [90m257| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m258| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39muser)[33m.[39m[34mtoMatchObject[39m({
    [90m259| [39m        firstName[33m:[39m [32m'Updated'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[163/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould support both "token" and "idToken" fields
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m332:31[22m[39m
    [90m330| [39m        })[33m;[39m
    [90m331| [39m
    [90m332| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m333| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoBe[39m([32m'Authentication successful'[39m)[33m;[39m
    [90m334| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[164/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould handle missing profile information gracefully
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m395:31[22m[39m
    [90m393| [39m        })[33m;[39m
    [90m394| [39m
    [90m395| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m396| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39muser)[33m.[39m[34mtoMatchObject[39m({
    [90m397| [39m        email[33m:[39m [32m'minimal@example.com'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[165/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould list all active sessions for current user
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, default, default) returning "id", "user_id", "password_hash", "created_at", "updated_at"
params: Hl7eeXhnmBFYFHRKXJBQR,$2b$12$4QRa0x6AaomNhBEL6GdDsuU.pzqmMxpcyXqf.RaIEVNhkgOjzN64u[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
    [90m 40| [39m
    [90m 41| [39m    [35mtry[39m {
    [90m 42| [39m      [35mconst[39m [credentials] [33m=[39m [35mawait[39m database
    [90m   | [39m                            [31m^[39m
    [90m 43| [39m        [33m.[39m[34minsert[39m(userCredentials)
    [90m 44| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m70:5[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
[90m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m70:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 332, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(Hl7eeXhnmBFYFHRKXJBQR) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[166/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould mark current session as current
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: eNfbhFyeleFxlied12t9d,session-test-vcemx6Y8C9fMNmXf8eflr@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w22_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[167/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould return empty array when user has no active sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: PJwFoGXAopS47q7pKY2OZ,session-test-fQMwpQq1VIHhvqHrxdASW@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[168/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould not include expired sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: K7UuEMffMsl_-dfs49xuJ,session-test-GbptO9FQ3iwPd9XPUZgTH@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[169/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould not include revoked sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: K8Hy3Wt8iQMvPb2oWppzB,session-test-PukDCoaH-DJTmA7GMFYv2@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[170/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould parse device name from user agent
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: ZjZznb224R-Vhst2-opeQ,session-test-ezDQLsg5q7-tcEJlPp0ga@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w32_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[171/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould return 401 for unauthenticated request
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: nrtQtwf1EvmSoXauowyeN,session-test-72WemLlCOe-JNeDqR_nkc@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[172/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould revoke a specific session
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: PAt8xaoE8WjLGO09TQS7u,session-test-OXk8vlL6YZQLm8VLyDu0U@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[173/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould return 404 for non-existent session
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 8m--8P7ICKSOkQ6DN3V9Z,session-test-iJ8JlG5Rwdv4vpOmrlyn_@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[174/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould prevent revoking current session
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: ytz_7I-C8vxeooT6q8h6a,session-test-CkTByEAMrE-R9U2oXplZG@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[175/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould prevent revoking another user's session
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: ERsbhWWgy05e6wPSFhOb7,session-test-L8Jc744cKj36-nI-qtaUV@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[176/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould return 401 for unauthenticated request
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 7LRRarKcebGmMiaLDjz6X,session-test-FZy5D3e7Tm0DjnkdB_QVX@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[177/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould revoke all sessions except current
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: Y8AyjyjOXnc1P1uMVLucm,session-test-_TuM8QVd5xufO3ZTgq14o@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[178/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould revoke all trusted devices
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: BE4JYBOO-TabKpG8U1_6n,session-test-oGbThhwgo43UrYjXUCWhC@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w23_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[179/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould return 400 when no active session found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: UVtVIfPn-X_uA9LertZ5T,session-test-4P-52izZSaH3cOC2nggDV@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[180/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould return 401 for unauthenticated request
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: nWDmRJn92xY8QIVelC10c,session-test-Q98_5VhXnp7Hn5QTAbvKG@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[181/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mPOST /api/auth/trust-device[2m > [22mshould mark current device as trusted
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 3foC5CHuBNcSM3H3MuVZs,session-test-VGjOr4D48WzinNh29kkEN@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[182/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mPOST /api/auth/trust-device[2m > [22mshould update existing trusted device expiry
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: fwT8Bj1LIhcNQQ_883Z5E,session-test-5ScYfySsTrXRt93LSpiCh@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[183/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould list all trusted devices
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: JC6dDPbS0AxSDLV3o_GkA,session-test-lxTGm7YvgZTMzzWJGKE-D@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[184/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould not include revoked devices
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: ScPSPSFycEacPIBeO9VbM,session-test-nOVH1NPcmAXvuFhtY_diW@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[185/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould revoke a trusted device
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: URv8Gez5ehPCauz3c1lvU,session-test-khMYsnQa7maUgWWDNDEuK@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w22_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[186/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould return 404 for non-existent device
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 3TM7fTyRtWI6ubwV4bHRe,session-test-B64GNQP_YLNXiTb5nEdl3@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[187/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mSession Metadata Tracking[2m > [22mshould track IP address for sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: cakXWS6_jny8Cj4IqUDaI,session-test-qYL892RvqH6TnG65fxgyn@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[188/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mSession Metadata Tracking[2m > [22mshould track user agent for sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: rdPRlIr0FngMeStjdEEqj,session-test-90blc54BXY4vEh3VvyQGK@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w40_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[189/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mSession Metadata Tracking[2m > [22mshould update lastUsedAt on token refresh
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: xp0dlNGtY71-Ox_sI0tL9,session-test-Mjp4Q75uI_bQweRqJi-V1@example.com,Session Test,Session,Test,01121843-6265-4f8b-8c70-8e95ceabc17d,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(01121843-6265-4f8b-8c70-8e95ceabc17d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[190/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould refresh access token with valid refresh token
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: TT2RTA2lDw72cLscf9ByM,refresh-test-t4KXsaHcbwUBZP-wBfrsH@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[191/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould rotate refresh token after use
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: m87jEjb2Nr5mW-DWPsyal,refresh-test-A7ZUl8ZVns-PAKSr9QTsT@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[192/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 when refresh token is missing
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: ZGp_4uWiHj_k-q69QFLS8,refresh-test-8ErY9n53gjJxaPo99D6go@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[193/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 for invalid refresh token
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: asQgXFzErggS5WksjR6Uv,refresh-test-Jg6aZi1BGjsHKC-612U_0@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[194/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 for expired refresh token
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: t1YWQ9hAsd58OplyAKkHV,refresh-test-hRhw5PuETpCMkR5x5_Xo1@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[195/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 for revoked refresh token
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: rWyLqDrK4ZvU6xfXI9ssJ,refresh-test-8f-fu0UvJ6oQ4tKXlA0V8@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[196/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 when user is not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: Kgm40RYGR8-dLTIWTEAO_,refresh-test-5EDtI3YXMEPb0I9velImv@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[197/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould update refresh token metadata on rotation
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: ujxfT9T0zqIUVpLsDntON,refresh-test-evg_doB-8g2A_ZQHqlZVp@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[198/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould handle concurrent refresh token requests (token reuse detection)
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: G2iAIEQu_XEBai465Gusb,refresh-test-wlwIx8n7hdBwepSnXpNvi@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[199/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould set secure cookie in production
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: mG0LRWW_F5DLV57wSI3Hh,refresh-test-ypAG5pvWiXmVRAfdeObH6@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[200/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould set proper cookie attributes
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, default, default) returning "id", "user_id", "password_hash", "created_at", "updated_at"
params: fph711gIe78udv87x9LOA,$2b$12$CpxL08fUXCFWjoVax1Ug5u7Pqso1iaitC7wsa4vizLHYv2mkqym6.[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
    [90m 40| [39m
    [90m 41| [39m    [35mtry[39m {
    [90m 42| [39m      [35mconst[39m [credentials] [33m=[39m [35mawait[39m database
    [90m   | [39m                            [31m^[39m
    [90m 43| [39m        [33m.[39m[34minsert[39m(userCredentials)
    [90m 44| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m72:5[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
[90m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m72:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 332, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(fph711gIe78udv87x9LOA) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[201/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould include user role information in response
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: LzhlgJu-VvMoPYHJ5K-SU,refresh-test-RxZ4zVvSj-Z-Gn0e5XqDs@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[202/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould create refresh token on login
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: hCnxuWa47xIo10aDRCvnL,refresh-test-YrSW6BiwSnlQAWZgFcTXn@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[203/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould revoke refresh token on logout
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 0uKyGn-Qg2Xq-KV56jnnA,refresh-test-eaNADGWSL6lsk9Mz5_9i3@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[204/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould handle logout without refresh token gracefully
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: ouhSG2kdrMHid9gyrSDaq,refresh-test-ZQkdCN_1oOSQkEbB8MXx0@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[205/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould support multiple active refresh tokens per user
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: EWeL4Cr8Ji6LK6gktWfki,refresh-test-VEw5GYUsrl5EG0ZLiCLIH@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[206/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould revoke all user tokens on password reset
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: LZVISPD2irMWc44F2MY42,refresh-test-Q5m8zNhOA6WBbjy6IHsfH@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[207/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould use cryptographically strong random tokens
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: eTFhKXtvblIi_wdnw4EZi,refresh-test-mAAPE_HnKgVuSk6rhbiEh@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[208/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould hash refresh tokens before storing in database
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: VQI1UapEL7j1Xxh5pXpGc,refresh-test-EQitoj7xLmtvilUtYa-m7@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[209/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould prevent refresh token reuse after rotation
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 8xeOl4u8vJe7LlLUe_4Ky,refresh-test-x-ReK-hwaMfaoCElGRoIx@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[210/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould validate token ownership
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 89aRwqlaOBB8kG7SsmS-q,refresh-test-Eru4yF2av9bGPoHtK39TV@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[211/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set HttpOnly flag to prevent XSS
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: dskZ9r2o7Y1Pg68Fmdl-q,refresh-test-EMOCjTg6xSYqKGcE-ee3l@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[212/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set SameSite=Strict to prevent CSRF
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: Zx0eXMAcCKqeYBnD_kuyi,refresh-test-LQfBQOrP354qSRPDLBl9z@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[213/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set proper cookie path
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: iYyUzHcyPhyomZWpyI-IV,refresh-test-R0mI7ab0X0_EGLvjR5tGd@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[214/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set appropriate expiry (30 days)
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: N6u5sZ9s-w94DuD2D-rNr,refresh-test-z8yva8WQUxWJ0nNQNrhmU@example.com,Refresh Test,Refresh,Test,22c17d31-7de0-4bc9-9752-a33c1cbfd648,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(22c17d31-7de0-4bc9-9752-a33c1cbfd648) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[215/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTemplate Key Resolution (New Path)[2m > [22mshould resolve template by key from workflowTemplates mapping
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 02353ec4-a9a7-4ab4-a941-d3c50f09316e,test-1768681348391@example.com,Test User,Test,User,25229c7c-f9ec-49e1-ad31-f2606ef4f212,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(25229c7c-f9ec-49e1-ad31-f2606ef4f212) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[216/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTemplate Key Resolution (New Path)[2m > [22mshould throw error if template key not found
[31m[1mError[22m: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values ($1, $2, default, $3, default, $4, default, $5, default, default, $6, default, default, default, default) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: 94aaccfa-8d02-486c-b4ad-79a1e5ea9564,0657bf2a-edc9-4e15-a91c-63bbf0fb9482,1,{},"Initial version",da153295-7ac0-4add-8dca-af7a2e790848[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m166:23[22m[39m
    [90m164| [39m      [33m.[39m[34mreturning[39m()[33m;[39m
    [90m165| [39m
    [90m166| [39m    [35mconst[39m [version] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m167| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflowVersions)
    [90m168| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m87:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m166:23[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m87:35[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 375, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(0657bf2a-edc9-4e15-a91c-63bbf0fb9482) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[217/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTemplate Key Resolution (New Path)[2m > [22mshould store output in runOutputs table
[31m[1mError[22m: Failed query: insert into "templates" ("id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, default, default, default, default, $7, default, default) returning "id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at"
params: 24a97c9d-439c-48fe-ae7a-2066cae238a8,73b80ae4-b0e5-4967-b909-913d09c86b80,Schedule A,Schedule A annex,template2.docx,docx,91231484-d6e1-4b47-9ebb-72401fe11616[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTemplate tests/helpers/testFactory.ts:[2m235:24[22m[39m
    [90m233| [39m    overrides[33m?[39m[33m:[39m [33mPartial[39m[33m<[39m[35mtypeof[39m schema[33m.[39mtemplates[33m.[39m$inferInsert[33m>[39m
    [90m234| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestTemplate[39m[33m>[39m {
    [90m235| [39m    [35mconst[39m [template] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m236| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mtemplates)
    [90m237| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m108:37[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "templates" violates foreign key constraint "templates_project_id_projects_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTemplate tests/helpers/testFactory.ts:[2m235:24[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m108:37[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 337, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(73b80ae4-b0e5-4967-b909-913d09c86b80) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'templates', dataType: undefined, constraint: 'templates_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[218/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mLegacy Template ID Path (Backward Compatibility)[2m > [22mshould resolve template by templateId directly
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: fff66198-8893-498e-b4a3-257efc0cfdab,Test Project,Test Project,Test project for integration tests,bbad5c57-f377-45c4-b1d0-2262a46c076c,baedcb7a-070f-44e6-bd7e-f4f7b297778c,bbad5c57-f377-45c4-b1d0-2262a46c076c,bbad5c57-f377-45c4-b1d0-2262a46c076c[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(bbad5c57-f377-45c4-b1d0-2262a46c076c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[219/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mLegacy Template ID Path (Backward Compatibility)[2m > [22mshould throw error if templateId not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 68ebe2f6-1cf9-41c4-8971-8a4d8121c2a4,test-1768681352071@example.com,Test User,Test,User,e42de254-69df-4300-9e84-5ad9dc7d78ab,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(e42de254-69df-4300-9e84-5ad9dc7d78ab) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w22_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[220/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mRendering Engine Selection[2m > [22mshould use docxRenderer2 by default (v2 engine)
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: efe60d5c-b51a-4279-933e-1140b17bb4f9,test-1768681352786@example.com,Test User,Test,User,a5a427ff-c100-4ddd-8da5-8e38633d017d,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(a5a427ff-c100-4ddd-8da5-8e38633d017d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[221/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mRendering Engine Selection[2m > [22mshould use legacy engine when engine="legacy"
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 367d7bca-af4b-40ba-b1e4-c6d090b79c8c,test-1768681353378@example.com,Test User,Test,User,24f7c262-2300-4b7a-8a86-97dc063c2856,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(24f7c262-2300-4b7a-8a86-97dc063c2856) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w32_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[222/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mPDF Generation[2m > [22mshould generate PDF when toPdf=true
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 5b5bd318-cd73-4a66-a7b0-684f286ec8e2,test-1768681354354@example.com,Test User,Test,User,8d69b71a-7cee-488f-8e78-bc2bf389b0d0,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(8d69b71a-7cee-488f-8e78-bc2bf389b0d0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[223/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mPDF Generation[2m > [22mshould default to DOCX when toPdf=false
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 0ce371ed-e093-4023-9782-dbdf585fc93f,test-1768681355001@example.com,Test User,Test,User,6276e623-d24c-443a-bf46-48f2c62a9400,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(6276e623-d24c-443a-bf46-48f2c62a9400) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w34_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[224/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mConditional Execution[2m > [22mshould skip execution when condition evaluates to false
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: cfcc177a-6042-465e-a379-499780ae73c8,test-1768681356001@example.com,Test User,Test,User,1d416054-f5d6-4016-ab5e-ca4ee742730f,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1d416054-f5d6-4016-ab5e-ca4ee742730f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[225/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mConditional Execution[2m > [22mshould execute when condition evaluates to true
[31m[1mError[22m: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values ($1, $2, default, $3, default, $4, default, $5, default, default, $6, default, default, default, default) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: 903a7383-7d55-4232-bb31-e6c035a6c114,7c9854e6-51c4-471e-8fe4-ae445d44021b,1,{},"Initial version",9f7d0f15-6650-434a-95e2-82d321555c99[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m166:23[22m[39m
    [90m164| [39m      [33m.[39m[34mreturning[39m()[33m;[39m
    [90m165| [39m
    [90m166| [39m    [35mconst[39m [version] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m167| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflowVersions)
    [90m168| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m87:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m166:23[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m87:35[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 375, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(7c9854e6-51c4-471e-8fe4-ae445d44021b) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[226/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mBinding Resolution[2m > [22mshould resolve simple bindings
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: fce513c7-0697-4c3e-9b81-7a79fccac1c9,test-1768681357597@example.com,Test User,Test,User,742f31ae-2400-404c-bc3b-5ee8ce729d68,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(742f31ae-2400-404c-bc3b-5ee8ce729d68) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[227/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mBinding Resolution[2m > [22mshould handle binding resolution errors gracefully
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: c6a8f9c7-1d9a-46ff-b85d-4f8b83ec1f99,Test Project,Test Project,Test project for integration tests,16d22bbc-5863-413d-939b-c439064565fa,27ebdba0-abc7-499a-a2cf-d14eba516ff9,16d22bbc-5863-413d-939b-c439064565fa,16d22bbc-5863-413d-939b-c439064565fa[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(16d22bbc-5863-413d-939b-c439064565fa) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w22_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[228/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mError Handling[2m > [22mshould record failed output in runOutputs table
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: 2bed31bb-8d82-4e4a-b4dc-00365fa148a3,Test Project,Test Project,Test project for integration tests,5aba596e-ebe3-4deb-9fe0-ff65be38e349,4fa26123-9395-422e-ab8d-585839630eca,5aba596e-ebe3-4deb-9fe0-ff65be38e349,5aba596e-ebe3-4deb-9fe0-ff65be38e349[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(5aba596e-ebe3-4deb-9fe0-ff65be38e349) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w40_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[229/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mError Handling[2m > [22mshould not throw errors (should return error in result)
[31m[1mError[22m: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values ($1, $2, default, $3, default, $4, default, $5, default, default, $6, default, default, default, default) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: a9e8f7bf-5c1a-436e-bb1b-16a8d5d49eae,e7010ff8-9c2b-488a-9f3a-c2e2a3d3f93d,1,{},"Initial version",37dbcdb1-8c17-4bb9-b713-a3b170346f9e[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m166:23[22m[39m
    [90m164| [39m      [33m.[39m[34mreturning[39m()[33m;[39m
    [90m165| [39m
    [90m166| [39m    [35mconst[39m [version] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m167| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflowVersions)
    [90m168| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m87:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m166:23[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m87:35[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 375, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(e7010ff8-9c2b-488a-9f3a-c2e2a3d3f93d) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w34_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[230/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTenant Access Control[2m > [22mshould deny access to templates from different tenant
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: e5401c0f-94b5-46b2-bd12-464354976fd6,test-1768681360569@example.com,Test User,Test,User,247bb723-4c51-4050-90ed-cea1af940d62,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(247bb723-4c51-4050-90ed-cea1af940d62) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w33_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[231/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mValidation[2m > [22mshould require either templateKey or templateId
[31m[1mError[22m: Failed query: insert into "templates" ("id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, default, default, default, default, $7, default, default) returning "id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at"
params: 9b5b27d2-7285-4263-a189-953dc6a6889c,16efbdb9-d0f6-4ada-abe7-ba6d7b1e2af8,Schedule A,Schedule A annex,template2.docx,docx,9c6b78ea-1826-477c-a48d-37d1851b31f3[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTemplate tests/helpers/testFactory.ts:[2m235:24[22m[39m
    [90m233| [39m    overrides[33m?[39m[33m:[39m [33mPartial[39m[33m<[39m[35mtypeof[39m schema[33m.[39mtemplates[33m.[39m$inferInsert[33m>[39m
    [90m234| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestTemplate[39m[33m>[39m {
    [90m235| [39m    [35mconst[39m [template] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m236| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mtemplates)
    [90m237| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m108:37[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "templates" violates foreign key constraint "templates_project_id_projects_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTemplate tests/helpers/testFactory.ts:[2m235:24[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m108:37[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 337, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(16efbdb9-d0f6-4ada-abe7-ba6d7b1e2af8) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w40_v3', table: 'templates', dataType: undefined, constraint: 'templates_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[232/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mcreate[2m > [22mshould create a workflow template mapping
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,9d0add12-3bc7-4c5f-b4af-a68043f1912a,9d0add12-3bc7-4c5f-b4af-a68043f1912a,fbf40d6a-79aa-47e5-ab95-8004e6f28585,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m
    [90m 50| [39m
    [90m 51| [39m    [90m// Create test workflow[39m
    [90m 52| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m 53| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m 54| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(9d0add12-3bc7-4c5f-b4af-a68043f1912a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[233/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mcreate[2m > [22mshould create non-primary mapping by default
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,0c833a28-ec94-44e5-830a-80dbc7530e0c,0c833a28-ec94-44e5-830a-80dbc7530e0c,0c833a28-ec94-44e5-830a-80dbc7530e0c[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(0c833a28-ec94-44e5-830a-80dbc7530e0c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[234/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionId[2m > [22mshould find all templates for a workflow version
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,ca7bb127-39bb-47d0-8235-dca32a7a3213,ca7bb127-39bb-47d0-8235-dca32a7a3213,18ead536-4a22-49c1-9cb8-24ac4667138a,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m
    [90m 50| [39m
    [90m 51| [39m    [90m// Create test workflow[39m
    [90m 52| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m 53| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m 54| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(ca7bb127-39bb-47d0-8235-dca32a7a3213) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[235/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionId[2m > [22mshould return empty array for version with no templates
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,80020a18-54ac-4d0f-b50e-63771039f0a2,80020a18-54ac-4d0f-b50e-63771039f0a2,80020a18-54ac-4d0f-b50e-63771039f0a2[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(80020a18-54ac-4d0f-b50e-63771039f0a2) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[236/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionId[2m > [22mshould order by createdAt desc (newest first)
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,ab9fd77b-4439-4c39-bd7c-d467fbe8ea8d,ab9fd77b-4439-4c39-bd7c-d467fbe8ea8d,ab9fd77b-4439-4c39-bd7c-d467fbe8ea8d[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(ab9fd77b-4439-4c39-bd7c-d467fbe8ea8d) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[237/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionAndKey[2m > [22mshould find mapping by workflow version and key
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,53bd0104-0af9-4539-a76b-fbae43837f9c,53bd0104-0af9-4539-a76b-fbae43837f9c,53bd0104-0af9-4539-a76b-fbae43837f9c[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(53bd0104-0af9-4539-a76b-fbae43837f9c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w21_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[238/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionAndKey[2m > [22mshould return undefined for non-existent key
[31m[1mError[22m: Failed query: insert into "templates" ("id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, default, default, default, default, default, default) returning "id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at"
params: 8c2eb702-dd96-4942-ad0a-b684b857680d,Template 2,Second test template,/uploads/template2.docx,docx[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m92:25[22m[39m
    [90m 90| [39m    testTemplateId1 [33m=[39m template1[33m.[39mid[33m;[39m
    [90m 91| [39m
    [90m 92| [39m    [35mconst[39m [template2] [33m=[39m [35mawait[39m db
    [90m   | [39m                        [31m^[39m
    [90m 93| [39m      [33m.[39m[34minsert[39m(templates)
    [90m 94| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "templates" violates foreign key constraint "templates_project_id_projects_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m92:25[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 337, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(8c2eb702-dd96-4942-ad0a-b684b857680d) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'templates', dataType: undefined, constraint: 'templates_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[239/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindPrimaryByWorkflowVersionId[2m > [22mshould find primary template for workflow version
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,56861b2f-37ee-4775-9e27-62e2fb9240fb,56861b2f-37ee-4775-9e27-62e2fb9240fb,56861b2f-37ee-4775-9e27-62e2fb9240fb[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(56861b2f-37ee-4775-9e27-62e2fb9240fb) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w22_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[240/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindPrimaryByWorkflowVersionId[2m > [22mshould return undefined when no primary template exists
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,f3ab6d65-4946-4d4e-baeb-4c1a5ebb66c8,f3ab6d65-4946-4d4e-baeb-4c1a5ebb66c8,f3ab6d65-4946-4d4e-baeb-4c1a5ebb66c8[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(f3ab6d65-4946-4d4e-baeb-4c1a5ebb66c8) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[241/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22msetPrimary[2m > [22mshould set a template as primary and unset others
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,93dcc56f-e98e-4b70-84e8-c06b7893f5f8,93dcc56f-e98e-4b70-84e8-c06b7893f5f8,842c86cd-84b4-46e0-a121-8c808f4bfbc3,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m
    [90m 50| [39m
    [90m 51| [39m    [90m// Create test workflow[39m
    [90m 52| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m 53| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m 54| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(93dcc56f-e98e-4b70-84e8-c06b7893f5f8) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w32_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[242/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22msetPrimary[2m > [22mshould handle setting primary when none existed before
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,752e8937-b771-48e7-8648-41c7ef76e08c,752e8937-b771-48e7-8648-41c7ef76e08c,752e8937-b771-48e7-8648-41c7ef76e08c[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(752e8937-b771-48e7-8648-41c7ef76e08c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w22_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[243/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22msetPrimary[2m > [22mshould not delete mapping if workflow version does not match
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,3a5e1519-17c0-48b3-9b1c-7a3b552a285a,3a5e1519-17c0-48b3-9b1c-7a3b552a285a,3a5e1519-17c0-48b3-9b1c-7a3b552a285a[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(3a5e1519-17c0-48b3-9b1c-7a3b552a285a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[244/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould return true if key exists in workflow version
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,29a33f99-d249-42ec-b247-11a6cc119a07,29a33f99-d249-42ec-b247-11a6cc119a07,29a33f99-d249-42ec-b247-11a6cc119a07[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(29a33f99-d249-42ec-b247-11a6cc119a07) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w22_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[245/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould return false if key does not exist
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,8adb0dff-31e2-41bb-80a2-c06c86d8cfa4,8adb0dff-31e2-41bb-80a2-c06c86d8cfa4,8adb0dff-31e2-41bb-80a2-c06c86d8cfa4[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(8adb0dff-31e2-41bb-80a2-c06c86d8cfa4) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w32_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[246/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould exclude specified id when checking existence
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,df592d27-05fc-4854-802d-e92330ece882,df592d27-05fc-4854-802d-e92330ece882,fd3b44ae-8bd5-4053-8817-ef5bc36b3b9f,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m
    [90m 50| [39m
    [90m 51| [39m    [90m// Create test workflow[39m
    [90m 52| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m 53| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m 54| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(df592d27-05fc-4854-802d-e92330ece882) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w22_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[247/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould return true if key exists on different mapping
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,f4c2ef7e-0caa-4a48-900c-eddac40f8e51,f4c2ef7e-0caa-4a48-900c-eddac40f8e51,8454969d-6e70-4e37-bcf8-f0de02f27972,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m
    [90m 50| [39m
    [90m 51| [39m    [90m// Create test workflow[39m
    [90m 52| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m 53| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m 54| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(f4c2ef7e-0caa-4a48-900c-eddac40f8e51) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[248/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mupdate[2m > [22mshould update mapping fields
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,9e4c4408-30db-4164-9090-d44a47c27b49,9e4c4408-30db-4164-9090-d44a47c27b49,9e4c4408-30db-4164-9090-d44a47c27b49[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(9e4c4408-30db-4164-9090-d44a47c27b49) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[249/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindById[2m > [22mshould find mapping by id
[31m[1mError[22m: Failed query: insert into "templates" ("id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, default, default, default, default, default, default) returning "id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at"
params: deea82fd-700a-481a-8962-ff0dd1c1a893,Template 2,Second test template,/uploads/template2.docx,docx[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m92:25[22m[39m
    [90m 90| [39m    testTemplateId1 [33m=[39m template1[33m.[39mid[33m;[39m
    [90m 91| [39m
    [90m 92| [39m    [35mconst[39m [template2] [33m=[39m [35mawait[39m db
    [90m   | [39m                        [31m^[39m
    [90m 93| [39m      [33m.[39m[34minsert[39m(templates)
    [90m 94| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "templates" violates foreign key constraint "templates_project_id_projects_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m92:25[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 337, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(deea82fd-700a-481a-8962-ff0dd1c1a893) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'templates', dataType: undefined, constraint: 'templates_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[250/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindById[2m > [22mshould return undefined for non-existent id
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,c06f454b-27f9-43a3-bb8a-6b13da4baf6f,c06f454b-27f9-43a3-bb8a-6b13da4baf6f,c06f454b-27f9-43a3-bb8a-6b13da4baf6f[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(c06f454b-27f9-43a3-bb8a-6b13da4baf6f) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[251/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mPassword Reset[2m > [22mgeneratePasswordResetToken()[2m > [22mshould generate password reset token for existing user
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.generatePasswordResetToken server/services/AuthService.ts:[2m508:9[22m[39m
    [90m506| [39m
    [90m507| [39m        [35mawait[39m [34msendPasswordResetEmail[39m(email[33m,[39m plainToken)[33m;[39m
    [90m508| [39m        log[33m.[39m[34minfo[39m({ email }[33m,[39m [32m'Password reset email sent'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m509| [39m
    [90m510| [39m        [35mreturn[39m plainToken[33m;[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m671:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[252/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mPassword Reset[2m > [22mgeneratePasswordResetToken()[2m > [22mshould invalidate previous reset tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.generatePasswordResetToken server/services/AuthService.ts:[2m508:9[22m[39m
    [90m506| [39m
    [90m507| [39m        [35mawait[39m [34msendPasswordResetEmail[39m(email[33m,[39m plainToken)[33m;[39m
    [90m508| [39m        log[33m.[39m[34minfo[39m({ email }[33m,[39m [32m'Password reset email sent'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m509| [39m
    [90m510| [39m        [35mreturn[39m plainToken[33m;[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m695:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[253/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mRefresh Token Management[2m > [22mrotateRefreshToken()[2m > [22mshould rotate valid token and return new one
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBâ€¦
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m901:42[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[254/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mRefresh Token Management[2m > [22mrotateRefreshToken()[2m > [22mshould return null for unknown token
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBâ€¦
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m914:42[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[255/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mRefresh Token Management[2m > [22mrotateRefreshToken()[2m > [22mshould revoke all tokens on reuse detection
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBâ€¦
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m933:42[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[256/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mRefresh Token Management[2m > [22mrotateRefreshToken()[2m > [22mshould return null for expired token
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBâ€¦
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m950:42[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[257/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mToken Cleanup[2m > [22mcleanupExpiredTokens()[2m > [22mshould cleanup expired refresh tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.cleanupExpiredTokens server/services/AuthService.ts:[2m593:9[22m[39m
    [90m591| [39m        [35mawait[39m accountLockoutService[33m.[39m[34mcleanupOldAttempts[39m()[33m;[39m
    [90m592| [39m
    [90m593| [39m        log[33m.[39m[34minfo[39m([32m'Cleaned up expired tokens and old login attempts'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m594| [39m    }
    [90m595| [39m}
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m977:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[258/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mToken Cleanup[2m > [22mcleanupExpiredTokens()[2m > [22mshould cleanup expired password reset tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.cleanupExpiredTokens server/services/AuthService.ts:[2m593:9[22m[39m
    [90m591| [39m        [35mawait[39m accountLockoutService[33m.[39m[34mcleanupOldAttempts[39m()[33m;[39m
    [90m592| [39m
    [90m593| [39m        log[33m.[39m[34minfo[39m([32m'Cleaned up expired tokens and old login attempts'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m594| [39m    }
    [90m595| [39m}
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m982:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[259/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mToken Cleanup[2m > [22mcleanupExpiredTokens()[2m > [22mshould cleanup expired email verification tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.cleanupExpiredTokens server/services/AuthService.ts:[2m593:9[22m[39m
    [90m591| [39m        [35mawait[39m accountLockoutService[33m.[39m[34mcleanupOldAttempts[39m()[33m;[39m
    [90m592| [39m
    [90m593| [39m        log[33m.[39m[34minfo[39m([32m'Cleaned up expired tokens and old login attempts'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m594| [39m    }
    [90m595| [39m}
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m987:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[260/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mToken Cleanup[2m > [22mcleanupExpiredTokens()[2m > [22mshould cleanup old login attempts via accountLockoutService
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.cleanupExpiredTokens server/services/AuthService.ts:[2m593:9[22m[39m
    [90m591| [39m        [35mawait[39m accountLockoutService[33m.[39m[34mcleanupOldAttempts[39m()[33m;[39m
    [90m592| [39m
    [90m593| [39m        log[33m.[39m[34minfo[39m([32m'Cleaned up expired tokens and old login attempts'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m594| [39m    }
    [90m595| [39m}
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m993:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[261/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mIntegration Scenarios[2m > [22mComplete Authentication Flow[2m > [22mshould support full user authentication lifecycle
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBâ€¦
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m1239:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[262/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mIntegration Scenarios[2m > [22mPassword Reset Flow[2m > [22mshould support complete password reset workflow
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.generatePasswordResetToken server/services/AuthService.ts:[2m508:9[22m[39m
    [90m506| [39m
    [90m507| [39m        [35mawait[39m [34msendPasswordResetEmail[39m(email[33m,[39m plainToken)[33m;[39m
    [90m508| [39m        log[33m.[39m[34minfo[39m({ email }[33m,[39m [32m'Password reset email sent'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m509| [39m
    [90m510| [39m        [35mreturn[39m plainToken[33m;[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m1259:28[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[263/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mIntegration Scenarios[2m > [22mPassword Reset Flow[2m > [22mshould prevent reuse of password reset tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.generatePasswordResetToken server/services/AuthService.ts:[2m508:9[22m[39m
    [90m506| [39m
    [90m507| [39m        [35mawait[39m [34msendPasswordResetEmail[39m(email[33m,[39m plainToken)[33m;[39m
    [90m508| [39m        log[33m.[39m[34minfo[39m({ email }[33m,[39m [32m'Password reset email sent'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m509| [39m
    [90m510| [39m        [35mreturn[39m plainToken[33m;[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m1296:28[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[264/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22menqueue[2m > [22mshould enqueue a PDF conversion job
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,4406a0b1-418a-49f0-b26d-67137f02f4b8,e936df84-4cb2-479b-9b6e-0a6040d4affa,4406a0b1-418a-49f0-b26d-67137f02f4b8,4406a0b1-418a-49f0-b26d-67137f02f4b8[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(4406a0b1-418a-49f0-b26d-67137f02f4b8) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[265/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22menqueue[2m > [22mshould create output with empty storagePath initially
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,becf4d9d-1f2a-420b-93c8-5a634f346e02,f17cff89-0387-4f01-af1b-166b194d066d,becf4d9d-1f2a-420b-93c8-5a634f346e02,becf4d9d-1f2a-420b-93c8-5a634f346e02[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(becf4d9d-1f2a-420b-93c8-5a634f346e02) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w25_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[266/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mgetJobStatus[2m > [22mshould return job status for pending job
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,57669f8e-90ee-4c85-9c48-de73a03b9334,f29eae69-f9ab-4d9a-972e-0415037522d0,57669f8e-90ee-4c85-9c48-de73a03b9334,57669f8e-90ee-4c85-9c48-de73a03b9334[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(57669f8e-90ee-4c85-9c48-de73a03b9334) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[267/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mgetJobStatus[2m > [22mshould return null for non-existent job
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,88a8799b-e440-45c8-9219-4992ad800dca,d8b2d654-4797-4849-b836-e3b52233d677,88a8799b-e440-45c8-9219-4992ad800dca,88a8799b-e440-45c8-9219-4992ad800dca[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(88a8799b-e440-45c8-9219-4992ad800dca) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[268/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mgetJobStatus[2m > [22mshould parse attempt count from error field
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,67e6fda5-a236-436f-9428-f66b2cf30b3c,8ba58416-0d00-4f6a-a186-daa996b934da,67e6fda5-a236-436f-9428-f66b2cf30b3c,67e6fda5-a236-436f-9428-f66b2cf30b3c[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(67e6fda5-a236-436f-9428-f66b2cf30b3c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w32_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[269/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mconvertImmediate[2m > [22mshould convert DOCX to PDF immediately
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,839c8a31-caa6-433e-85e3-ac27cd6602de,a40ab6b6-4c06-40e0-b473-390b4463d9a4,839c8a31-caa6-433e-85e3-ac27cd6602de,839c8a31-caa6-433e-85e3-ac27cd6602de[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(839c8a31-caa6-433e-85e3-ac27cd6602de) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[270/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mconvertImmediate[2m > [22mshould handle conversion errors gracefully
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,c12ab09d-2730-44a5-88d4-a0fd454eacd8,edc8c807-dff0-47a5-b1d5-d229a8602c33,c12ab09d-2730-44a5-88d4-a0fd454eacd8,c12ab09d-2730-44a5-88d4-a0fd454eacd8[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(c12ab09d-2730-44a5-88d4-a0fd454eacd8) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w29_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[271/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mService Lifecycle[2m > [22mshould start and stop service
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,6666e5cf-b19a-403c-b56e-6723d6bf737b,1402c2c6-484d-4b7e-ad69-0eabd9264871,6666e5cf-b19a-403c-b56e-6723d6bf737b,6666e5cf-b19a-403c-b56e-6723d6bf737b[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(6666e5cf-b19a-403c-b56e-6723d6bf737b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[272/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mService Lifecycle[2m > [22mshould not start if already running
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,1b32e8cc-b9cb-4d76-8730-e16c0038fdad,0d4e6a11-9cf6-4280-8fd6-b25c5d1c40bd,1b32e8cc-b9cb-4d76-8730-e16c0038fdad,1b32e8cc-b9cb-4d76-8730-e16c0038fdad[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(1b32e8cc-b9cb-4d76-8730-e16c0038fdad) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[273/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mService Lifecycle[2m > [22mshould handle stop when not running
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,13749497-fe16-450b-827c-6ca1162fffd4,4ae29904-fb3b-4f09-ab17-85d84634606b,13749497-fe16-450b-827c-6ca1162fffd4,13749497-fe16-450b-827c-6ca1162fffd4[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(13749497-fe16-450b-827c-6ca1162fffd4) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[274/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mQueue Processing[2m > [22mshould process pending jobs when queue is processed
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,5c48b622-40c0-4bde-9996-4a6d333b93af,aec18b7c-b034-45c5-a95f-6b79164bd1ce,5c48b622-40c0-4bde-9996-4a6d333b93af,5c48b622-40c0-4bde-9996-4a6d333b93af[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(5c48b622-40c0-4bde-9996-4a6d333b93af) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[275/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mQueue Processing[2m > [22mshould process multiple jobs in batch
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,efeb9bda-14f9-4c7a-a92f-1911a775b5ab,163f9103-c80b-4157-b4c2-891c5dd909d6,efeb9bda-14f9-4c7a-a92f-1911a775b5ab,efeb9bda-14f9-4c7a-a92f-1911a775b5ab[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(efeb9bda-14f9-4c7a-a92f-1911a775b5ab) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[276/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mError Handling[2m > [22mshould handle missing DOCX output gracefully
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,dc6d6243-a133-4e03-bf1c-364e22f27f24,e4595b74-6940-4f71-bda8-3f2298f17701,dc6d6243-a133-4e03-bf1c-364e22f27f24,dc6d6243-a133-4e03-bf1c-364e22f27f24[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(dc6d6243-a133-4e03-bf1c-364e22f27f24) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[277/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mTransaction Support[2m > [22mshould support enqueue within transaction
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,f3086688-7344-4943-8b39-c31b11cf2742,7bc563d4-cda6-41d5-8368-e850bcb04695,f3086688-7344-4943-8b39-c31b11cf2742,f3086688-7344-4943-8b39-c31b11cf2742[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(f3086688-7344-4943-8b39-c31b11cf2742) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w24_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[278/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mTransaction Support[2m > [22mshould support convertImmediate within transaction
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,3c788840-477e-4c33-ac15-fb2b4f0baf15,8fdefa28-3e23-4f4a-b836-ad2d6ff42a30,3c788840-477e-4c33-ac15-fb2b4f0baf15,3c788840-477e-4c33-ac15-fb2b4f0baf15[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(3c788840-477e-4c33-ac15-fb2b4f0baf15) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w34_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[279/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mshould throw error if template belongs to different project
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 8a6a9dcc-b853-4e37-b9ec-178003036800,test-1768681332645@example.com,Test User,Test,User,7dc3dd13-8a1a-4dd7-8a80-16380a93369d,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(7dc3dd13-8a1a-4dd7-8a80-16380a93369d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[280/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mshould automatically unset other primaries when setting new primary
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: f22aadfb-8cf1-4123-b8a0-9eb14a71c935,test-1768681333212@example.com,Test User,Test,User,238a3199-566a-4802-9410-e2f4570b489b,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(238a3199-566a-4802-9410-e2f4570b489b) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w14_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[281/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mlistTemplates[2m > [22mshould list all templates for workflow version
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: 10fa8753-2cd6-4beb-9cd3-d8d24cec8d2c,Test Project,Test Project,Test project for integration tests,4f121cbd-2b11-4342-a869-52af08c7fbd8,5df9bd6c-4ce7-41f3-b0fe-03466686bdee,4f121cbd-2b11-4342-a869-52af08c7fbd8,4f121cbd-2b11-4342-a869-52af08c7fbd8[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(4f121cbd-2b11-4342-a869-52af08c7fbd8) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[282/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mlistTemplates[2m > [22mshould return empty array for version with no templates
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: 90250fbc-7015-4f44-aa35-c672985df3c6,Test Project,Test Project,Test project for integration tests,f74bb174-d2c7-4495-aa15-c080d0b62d01,daf9fc6a-d5a6-46a8-93c1-98ec6171289c,f74bb174-d2c7-4495-aa15-c080d0b62d01,f74bb174-d2c7-4495-aa15-c080d0b62d01[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(f74bb174-d2c7-4495-aa15-c080d0b62d01) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[283/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateMapping[2m > [22mshould get template mapping by id and version
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: f70f73cf-0d2b-4071-b036-56fcf3eff1e9,Test Project,Test Project,Test project for integration tests,899bcfb5-9408-4575-a1f3-5baf524a127f,4271be45-4388-4bc0-a1d6-fcd5addbcc27,899bcfb5-9408-4575-a1f3-5baf524a127f,899bcfb5-9408-4575-a1f3-5baf524a127f[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(899bcfb5-9408-4575-a1f3-5baf524a127f) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[284/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateMapping[2m > [22mshould throw error if mapping not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: cb11bbbd-3513-4c69-853a-ef27b160e757,test-1768681336185@example.com,Test User,Test,User,3952af96-b8ac-485f-9338-a72132e5cdbc,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(3952af96-b8ac-485f-9338-a72132e5cdbc) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[285/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateByKey[2m > [22mshould get template by key
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 615c7b89-adfb-4ec6-9893-fcb74525d20c,test-1768681336837@example.com,Test User,Test,User,aea32167-0f97-4f1e-a0ab-27873ecb27a9,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(aea32167-0f97-4f1e-a0ab-27873ecb27a9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[286/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateByKey[2m > [22mshould throw error if key not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: e0b3bf0f-8c83-4537-9cc5-102cd2068edf,test-1768681337512@example.com,Test User,Test,User,7f981e5f-431e-407f-bdbe-f54a24f8c3d4,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(7f981e5f-431e-407f-bdbe-f54a24f8c3d4) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w25_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[287/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetPrimaryTemplate[2m > [22mshould get primary template for workflow version
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 06ca8d74-9ed4-411d-b857-3f1f679d8114,test-1768681338114@example.com,Test User,Test,User,9bfe8311-e523-4d3d-b218-6b0119687b9f,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9bfe8311-e523-4d3d-b218-6b0119687b9f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[288/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetPrimaryTemplate[2m > [22mshould return null when no primary template exists
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 5c83cd1c-76fd-4aba-afac-a059d02c2765,test-1768681338817@example.com,Test User,Test,User,ed7fd74d-c5e9-4490-b469-a93108526d31,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(ed7fd74d-c5e9-4490-b469-a93108526d31) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[289/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould update mapping key
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 2994fc0f-8853-41ba-a5ab-43c0cd86d377,test-1768681339395@example.com,Test User,Test,User,1334bf1d-81a2-4eb0-8771-78ff8cb69a4c,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1334bf1d-81a2-4eb0-8771-78ff8cb69a4c) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w29_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[290/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould update isPrimary flag
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, $3, $4, $5, default, $6, $7, $8, default, default, default, default, default, default, $9, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: 0cd075b2-b4f6-41f3-baee-714820f1f4c6,Test Workflow,Test workflow,9f2368f8-9493-4724-aa00-489fc14f170d,9f2368f8-9493-4724-aa00-489fc14f170d,test-workflow-697f2ac8-ea00-46c3-aada-27fed67cbdc4,Test Workflow,fc2754b7-405c-4da2-9875-8aaed8774e68,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
    [90m149| [39m    }
    [90m150| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestWorkflow[39m[33m>[39m {
    [90m151| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m152| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflows)
    [90m153| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(9f2368f8-9493-4724-aa00-489fc14f170d) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[291/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould throw error if new key already exists
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 2498b1bb-22e9-46ac-8444-7644378066fd,test-1768681340952@example.com,Test User,Test,User,f33a0dc3-820a-4801-ae95-19fe1524fad9,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f33a0dc3-820a-4801-ae95-19fe1524fad9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[292/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould throw error if mapping not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 01c88284-2785-434e-84e9-8c9a3892fb24,test-1768681341557@example.com,Test User,Test,User,c7b8b81d-eed0-4047-ab0a-c50878a3e02a,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(c7b8b81d-eed0-4047-ab0a-c50878a3e02a) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[293/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould unset other primaries when setting isPrimary to true
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, $3, $4, $5, default, $6, $7, $8, default, default, default, default, default, default, $9, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: 02dbeb1b-9188-45e9-ae7a-84a319d61ef4,Test Workflow,Test workflow,79c7bc23-c544-4102-a61f-6501bc0e1e7d,79c7bc23-c544-4102-a61f-6501bc0e1e7d,test-workflow-7c0af1fc-9538-40c7-98da-32ab50b74f12,Test Workflow,ebae8ce5-6193-4fee-81fd-257f0ea654d2,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
    [90m149| [39m    }
    [90m150| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestWorkflow[39m[33m>[39m {
    [90m151| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m152| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflows)
    [90m153| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(79c7bc23-c544-4102-a61f-6501bc0e1e7d) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[294/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mdetachTemplate[2m > [22mshould detach template from workflow version
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, $3, $4, $5, default, $6, $7, $8, default, default, default, default, default, default, $9, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: 1b566dd8-6fa6-4e95-92d5-a468a3a5e4e8,Test Workflow,Test workflow,9f1a8a7b-a022-401f-8f30-43800be68950,9f1a8a7b-a022-401f-8f30-43800be68950,test-workflow-bba45f67-3859-432c-b936-b54be3e84751,Test Workflow,48e3e200-daf4-4fd6-a0e3-18262d931572,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
    [90m149| [39m    }
    [90m150| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestWorkflow[39m[33m>[39m {
    [90m151| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m152| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflows)
    [90m153| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(9f1a8a7b-a022-401f-8f30-43800be68950) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[295/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mdetachTemplate[2m > [22mshould throw error if mapping not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: a4827499-b6f8-4cc4-bcb5-d307adeb8d17,test-1768681344084@example.com,Test User,Test,User,99cf1989-de21-416e-a2bb-2d9b5047e83e,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(99cf1989-de21-416e-a2bb-2d9b5047e83e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[296/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22msetPrimaryTemplate[2m > [22mshould set template as primary
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, $3, $4, $5, default, $6, $7, $8, default, default, default, default, default, default, $9, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: 309f272c-6eb3-4cd0-ac1b-3544e2cb41c8,Test Workflow,Test workflow,62212234-20db-4bf6-aec1-a8087677f39e,62212234-20db-4bf6-aec1-a8087677f39e,test-workflow-28fb6cf2-e2c4-41ce-a94c-9eb8ecf09be0,Test Workflow,55dac45c-f2fc-4339-a3b4-736b6cc9389f,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
    [90m149| [39m    }
    [90m150| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestWorkflow[39m[33m>[39m {
    [90m151| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m152| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflows)
    [90m153| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(62212234-20db-4bf6-aec1-a8087677f39e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[297/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22msetPrimaryTemplate[2m > [22mshould throw error if mapping not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: e7f8428f-4ffb-433a-bba8-98c5dd2a33c6,test-1768681345456@example.com,Test User,Test,User,88510257-58fc-4a0e-ae8b-2275d8251ae9,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(88510257-58fc-4a0e-ae8b-2275d8251ae9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[298/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mtransaction support[2m > [22mshould support operations within a transaction
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 460f1b49-b566-45bc-a7ae-9bc1ea64b440,test-1768681345979@example.com,Test User,Test,User,837897c6-be4a-4ac6-84f2-505992b0c794,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(837897c6-be4a-4ac6-84f2-505992b0c794) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[299/310]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mtransaction support[2m > [22mshould rollback on transaction error
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 4601e346-2d97-442b-aaaa-df27364c1631,test-1768681346500@example.com,Test User,Test,User,c336e994-d0b8-43a6-aa7b-ff4c3cc012ca,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(c336e994-d0b8-43a6-aa7b-ff4c3cc012ca) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[300/310]âŽ¯[22m[39m


[2m Test Files [22m [1m[31m47 failed[39m[22m[2m | [22m[1m[32m109 passed[39m[22m[2m | [22m[33m1 skipped[39m[90m (157)[39m
[2m      Tests [22m [1m[31m274 failed[39m[22m[2m | [22m[1m[32m2010 passed[39m[22m[2m | [22m[33m356 skipped[39m[90m (2640)[39m
[2m   Start at [22m 14:21:57
[2m   Duration [22m 120.51s[2m (transform 109.42s, setup 31.64s, import 487.51s, tests 758.28s, environment 28.13s)[22m

