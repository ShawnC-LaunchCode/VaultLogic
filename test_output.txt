npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

> ezbuildr@1.0.0 test
> vitest run --coverage tests/integration/auth-enterprise.test.ts


[1m[46m RUN [49m[22m [36mv4.0.15 [39m[90mC:/Users/scoot/poll/VaultLogic[39m
      [2mCoverage enabled with [22m[33mv8[39m

[90mstdout[2m | tests/integration/auth-enterprise.test.ts
[22m[39m[dotenv@17.2.3] injecting env (15) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth-enterprise.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/auth-enterprise.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-enterprise.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1766501193678,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1766501193686,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth-enterprise.test.ts[2m > [22m[2mEnterprise Auth Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1766501193680,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1766501193682,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1766501193686,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1766501193686,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1766501193686,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1766501193686,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1766501193905,"env":"test","module":"user-credentials-repository","userId":"UzuyY4f-GWwg-DfPJ-c3h","msg":"User credentials created"}
{"level":30,"time":1766501193954,"env":"test","module":"auth-security","userId":"UzuyY4f-GWwg-DfPJ-c3h","plainToken":"71bc677306ce291b1fc1ade7f3393d5bea159fc84407dd0ec12ab892392aa656","msg":"Email verification token generated (EMAIL STUB)"}
{"level":30,"time":1766501193955,"env":"test","module":"auth-routes","userId":"UzuyY4f-GWwg-DfPJ-c3h","email":"auth-test-xmgnlHl3gseeMS6bJLX7g@example.com","msg":"Verification token generated: 71bc677306ce291b1fc1ade7f3393d5bea159fc84407dd0ec12ab892392aa656 (EMAIL STUB)"}
{"level":30,"time":1766501194006,"env":"test","module":"auth-routes","userId":"UzuyY4f-GWwg-DfPJ-c3h","email":"auth-test-xmgnlHl3gseeMS6bJLX7g@example.com","msg":"User registered successfully"}
{"level":30,"time":1766501194220,"env":"test","module":"auth-routes","userId":"UzuyY4f-GWwg-DfPJ-c3h","email":"auth-test-xmgnlHl3gseeMS6bJLX7g@example.com","msg":"User logged in successfully"}
{"level":30,"time":1766501194423,"env":"test","module":"auth-routes","userId":"UzuyY4f-GWwg-DfPJ-c3h","email":"auth-test-xmgnlHl3gseeMS6bJLX7g@example.com","msg":"User logged in successfully"}
{"level":30,"time":1766501194765,"env":"test","module":"auth-security","email":"auth-test-xmgnlHl3gseeMS6bJLX7g@example.com","plainToken":"48352a7fe1947471658c3b742d640f99ec30bc1d636d94ee6099e670db0b1e0a","msg":"Password reset token generated (EMAIL STUB)"}
{"level":30,"time":1766501194765,"env":"test","module":"auth-routes","email":"auth-test-xmgnlHl3gseeMS6bJLX7g@example.com","msg":"Reset token generated (STUB)"}
[90mstdout[2m | tests/integration/auth-enterprise.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/auth-enterprise.test.ts [2m([22m[2m7 tests[22m[2m | [22m[31m6 failed[39m[2m)[22m[33m 1895[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m 1. Should register a new user and trigger verification email[39m[33m 325[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m 2. Should verify email with token[39m[32m 9[2mms[22m[39m
       [32mÎ“Â£Ã´[39m 3. Should login and receive access token + refresh cookie[32m 199[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m 4. Should refresh access token[39m[33m 401[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m 5. Should initiate password reset[39m[32m 144[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m 6. Should reset password with token[39m[32m 4[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m 7. Should logout and invalidate refresh token[39m[32m 148[2mms[22m[39m
Failed to parse file:///C:/Users/scoot/poll/VaultLogic/server/queues/DocumentGenerationWorker.ts. Excluding it from coverage.
 Error [RollupError]: Expected ',', got ':'
    at getRollupError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/rollup/dist/es/shared/parseAst.js:401:41)
    at convertProgram (file:///C:/Users/scoot/poll/VaultLogic/node_modules/rollup/dist/es/shared/parseAst.js:1098:26)
    at parseAstAsync (file:///C:/Users/scoot/poll/VaultLogic/node_modules/rollup/dist/es/shared/parseAst.js:2084:106)
    at V8CoverageProvider.remapCoverage (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/coverage-v8/dist/provider.js:135:10)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/coverage-v8/dist/provider.js:121:23
    at async Promise.all (index 5)
    at V8CoverageProvider.getCoverageMapForUncoveredFiles (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/coverage-v8/dist/provider.js:111:4)
    at V8CoverageProvider.generateCoverage (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/coverage-v8/dist/provider.js:59:29)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/cli-api.C7sYjHmQ.js:12526:23
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/cli-api.C7sYjHmQ.js:12539:11 {
  code: 'PARSE_ERROR',
  pos: 1724
}

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 6 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth-enterprise.test.ts > Enterprise Auth Integration Tests > Full Auth Lifecycle > 1. Should register a new user and trigger verification email
AssertionError: expected "vi.fn()" to be called at least once
 Î“Â¥Â» tests/integration/auth-enterprise.test.ts:64:47
     62| 
     63|             expect(res.status).toBe(201);
     64|             expect(mockSendVerificationEmail).toHaveBeenCalled();
       |                                               ^
     65| 
     66|             // Capture verification token from mock calls

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/6]Î“Ã„Â»

 FAIL  tests/integration/auth-enterprise.test.ts > Enterprise Auth Integration Tests > Full Auth Lifecycle > 2. Should verify email with token
AssertionError: expected 400 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 400

 Î“Â¥Â» tests/integration/auth-enterprise.test.ts:79:32
     77|                 .send({ token: verificationToken });
     78| 
     79|             expect(res.status).toBe(200);
       |                                ^
     80|             expect(res.body.message).toContain("verified");
     81|         });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/6]Î“Ã„Â»

 FAIL  tests/integration/auth-enterprise.test.ts > Enterprise Auth Integration Tests > Full Auth Lifecycle > 4. Should refresh access token
AssertionError: expected 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.Î“Ã‡Âª' not to be 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.Î“Ã‡Âª' // Object.is equality
 Î“Â¥Â» tests/integration/auth-enterprise.test.ts:114:40
    112|             expect(res.status).toBe(200);
    113|             expect(res.body.token).toBeDefined();
    114|             expect(res.body.token).not.toBe(loginRes.body.token); // SÎ“Ã‡Âª
       |                                        ^
    115|         });
    116| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/6]Î“Ã„Â»

 FAIL  tests/integration/auth-enterprise.test.ts > Enterprise Auth Integration Tests > Full Auth Lifecycle > 5. Should initiate password reset
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/auth-enterprise.test.ts:128:20
    126|             const calls = mockSendPasswordResetEmail.mock.calls;
    127|             const lastCall = calls[calls.length - 1];
    128|             expect(lastCall[0]).toBe(userEmail);
       |                    ^
    129|             resetToken = lastCall[1];
    130|             expect(resetToken).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/6]Î“Ã„Â»

 FAIL  tests/integration/auth-enterprise.test.ts > Enterprise Auth Integration Tests > Full Auth Lifecycle > 6. Should reset password with token
AssertionError: expected 400 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 400

 Î“Â¥Â» tests/integration/auth-enterprise.test.ts:139:32
    137|                 .send({ token: resetToken, newPassword });
    138| 
    139|             expect(res.status).toBe(200);
       |                                ^
    140| 
    141|             // Verify login with OLD password fails

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/6]Î“Ã„Â»

 FAIL  tests/integration/auth-enterprise.test.ts > Enterprise Auth Integration Tests > Full Auth Lifecycle > 7. Should logout and invalidate refresh token
TypeError: Invalid value "undefined" for header "Cookie"
 Î“Â¥Â» Test.Request.request node_modules/supertest/node_modules/superagent/lib/node/index.js:791:39
 Î“Â¥Â» Test.Request.end node_modules/supertest/node_modules/superagent/lib/node/index.js:909:8
 Î“Â¥Â» Test.end node_modules/supertest/lib/test.js:136:11
 Î“Â¥Â» node_modules/supertest/node_modules/superagent/lib/request-base.js:265:12
 Î“Â¥Â» Test.RequestBase.then node_modules/supertest/node_modules/superagent/lib/request-base.js:249:31

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/6]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m6 failed[39m[22m[2m | [22m[1m[32m1 passed[39m[22m[90m (7)[39m
[2m   Start at [22m 08:46:26
[2m   Duration [22m 13.09s[2m (transform 2.59s, setup 83ms, import 5.88s, tests 1.90s, environment 0ms)[22m

