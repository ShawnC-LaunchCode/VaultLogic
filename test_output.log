npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

 DEV  v4.0.16 C:/Users/scoot/poll/VaultLogic

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöæ add access controls to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768674675621,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768674677897,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768674677935,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: public
≡ƒöä Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/auth/protected.routes.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

stdout | tests/integration/auth/protected.routes.test.ts
   Applying 0000_mushy_thing.sql...

stderr | tests/integration/auth/protected.routes.test.ts
Γ¥î FAILED MIGRATION 0000_mushy_thing.sql: Failed query: CREATE TYPE "public"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint
CREATE TYPE "public"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint
CREATE TYPE "public"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint
CREATE TYPE "public"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint
CREATE TYPE "public"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint
CREATE TYPE "public"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint
CREATE TYPE "public"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint
CREATE TYPE "public"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint
CREATE TYPE "public"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint
CREATE TYPE "public"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint
CREATE TYPE "public"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint
CREATE TYPE "public"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint
CREATE TYPE "public"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint
CREATE TYPE "public"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint
CREATE TYPE "public"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint
CREATE TYPE "public"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint
CREATE TYPE "public"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint
CREATE TYPE "public"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint
CREATE TYPE "public"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint
CREATE TYPE "public"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint
CREATE TYPE "public"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint
CREATE TYPE "public"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint
CREATE TYPE "public"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint
CREATE TYPE "public"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint
CREATE TYPE "public"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint
CREATE TYPE "public"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint
CREATE TYPE "public"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint
CREATE TYPE "public"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint
CREATE TYPE "public"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint
CREATE TYPE "public"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint
CREATE TYPE "public"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint
CREATE TYPE "public"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint
CREATE TYPE "public"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint
CREATE TYPE "public"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint
CREATE TYPE "public"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint
CREATE TYPE "public"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint
CREATE TYPE "public"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint
CREATE TYPE "public"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint
CREATE TYPE "public"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint
CREATE TYPE "public"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint
CREATE TYPE "public"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint
CREATE TYPE "public"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint
CREATE TYPE "public"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint
CREATE TYPE "public"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint
CREATE TABLE "account_locks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"locked_at" timestamp DEFAULT now() NOT NULL,
	"locked_until" timestamp NOT NULL,
	"reason" varchar(255),
	"unlocked" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "audit_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"workspace_id" uuid,
	"user_id" varchar,
	"action" varchar NOT NULL,
	"entity_type" varchar NOT NULL,
	"entity_id" varchar NOT NULL,
	"resource_type" varchar,
	"resource_id" varchar,
	"changes" jsonb,
	"details" jsonb,
	"ip_address" varchar,
	"user_agent" text,
	"created_at" timestamp DEFAULT now(),
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_verification_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "login_attempts" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"ip_address" varchar(45),
	"successful" boolean DEFAULT false NOT NULL,
	"attempted_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_backup_codes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"code_hash" text NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"secret" text NOT NULL,
	"enabled" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"enabled_at" timestamp,
	CONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "organization_invites" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"invited_email" varchar(255) NOT NULL,
	"invited_user_id" varchar,
	"invited_by_user_id" varchar NOT NULL,
	"token" varchar(255) NOT NULL,
	"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp NOT NULL,
	"accepted_at" timestamp,
	"email_sent_at" timestamp,
	"email_failed" boolean DEFAULT false,
	"email_error" text,
	CONSTRAINT "organization_invites_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "organization_memberships" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "organization_role" DEFAULT 'member' NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "organizations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"slug" varchar,
	"domain" varchar,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"tenant_id" uuid NOT NULL,
	"created_by_user_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "organizations_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "password_reset_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "portal_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "portal_tokens_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "refresh_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"revoked" boolean DEFAULT false NOT NULL,
	"metadata" jsonb,
	"device_name" varchar(255),
	"ip_address" varchar(45),
	"location" varchar(255),
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sessions" (
	"sid" varchar PRIMARY KEY NOT NULL,
	"sess" jsonb NOT NULL,
	"expire" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE "team_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"team_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" varchar(50) DEFAULT 'member' NOT NULL,
	"joined_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "teams" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "tenant_domains" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"domain" text NOT NULL,
	"verified" boolean DEFAULT false,
	"verification_token" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "tenant_domains_domain_unique" UNIQUE("domain")
);
--> statement-breakpoint
CREATE TABLE "tenants" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar(255) NOT NULL,
	"billing_email" varchar(255),
	"plan" "tenant_plan" DEFAULT 'free' NOT NULL,
	"mfa_required" boolean DEFAULT false NOT NULL,
	"branding" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "trusted_devices" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"device_fingerprint" varchar(255) NOT NULL,
	"device_name" varchar(255),
	"trusted_until" timestamp NOT NULL,
	"ip_address" varchar(45),
	"location" varchar(255),
	"user_agent" text,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"last_used_at" timestamp,
	"revoked" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "user_credentials" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"password_hash" text NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "user_credentials_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "user_personalization_settings" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"reading_level" varchar DEFAULT 'standard' NOT NULL,
	"tone" varchar DEFAULT 'neutral' NOT NULL,
	"verbosity" varchar DEFAULT 'standard' NOT NULL,
	"language" varchar DEFAULT 'en' NOT NULL,
	"allow_adaptive_prompts" boolean DEFAULT true NOT NULL,
	"allow_ai_clarification" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "user_preferences" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"settings" jsonb DEFAULT '{"celebrationEffects":true,"darkMode":"system","aiHints":true}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "users" (
	"id" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"full_name" varchar(255),
	"first_name" varchar(255),
	"last_name" varchar(255),
	"profile_image_url" varchar(500),
	"tenant_id" uuid,
	"role" "user_role" DEFAULT 'creator' NOT NULL,
	"tenant_role" "user_tenant_role",
	"auth_provider" "auth_provider" DEFAULT 'local' NOT NULL,
	"default_mode" text DEFAULT 'easy' NOT NULL,
	"email_verified" boolean DEFAULT false NOT NULL,
	"mfa_enabled" boolean DEFAULT false NOT NULL,
	"last_password_change" timestamp,
	"is_placeholder" boolean DEFAULT false NOT NULL,
	"placeholder_email" varchar(255),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_invitations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"email" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"invited_by" varchar NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"joined_at" timestamp DEFAULT now(),
	"invited_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workspaces" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"slug" varchar NOT NULL,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"type" "block_type" NOT NULL,
	"phase" "block_phase" NOT NULL,
	"config" jsonb NOT NULL,
	"virtual_step_id" uuid,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_docs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid,
	"tenant_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"clock" integer NOT NULL,
	"state" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "collab_updates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"seq" integer NOT NULL,
	"update" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "document_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"final_block_document_id" varchar(255),
	"name" varchar(255) NOT NULL,
	"phase" "document_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 3000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "lifecycle_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar(255) NOT NULL,
	"phase" "lifecycle_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"virtual_step_ids" uuid[] DEFAULT '{}'::uuid[],
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"mutation_mode" boolean DEFAULT false,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "logic_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"condition_step_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_type" "logic_rule_target_type" NOT NULL,
	"target_step_id" uuid,
	"target_section_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "project_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "projects" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"name" varchar(255),
	"description" text,
	"creator_id" varchar NOT NULL,
	"tenant_id" uuid,
	"created_by" varchar,
	"owner_id" varchar NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"status" "project_status" DEFAULT 'active' NOT NULL,
	"archived" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"order" integer NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"visible_if" jsonb,
	"skip_if" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "steps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"section_id" uuid NOT NULL,
	"type" "step_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"alias" text,
	"default_value" jsonb,
	"order" integer NOT NULL,
	"is_virtual" boolean DEFAULT false NOT NULL,
	"visible_if" jsonb,
	"repeater_config" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"version_number" integer NOT NULL,
	"file_ref" varchar(500) NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"notes" text,
	"is_active" boolean DEFAULT true
);
--> statement-breakpoint
CREATE TABLE "templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"file_ref" varchar(500) NOT NULL,
	"type" "template_type" NOT NULL,
	"helpers_version" integer DEFAULT 1 NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"current_version" integer DEFAULT 1,
	"last_modified_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_key" varchar NOT NULL,
	"virtual_step_id" uuid,
	"phase" "block_phase" DEFAULT 'onSectionSubmit' NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_blueprints" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"creator_id" varchar NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"graph_json" jsonb NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"source_workflow_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"name" text NOT NULL,
	"values" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"workflow_version_id" uuid,
	"version_hash" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_id" uuid NOT NULL,
	"key" text NOT NULL,
	"is_primary" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"base_id" uuid,
	"version_number" integer DEFAULT 1 NOT NULL,
	"is_draft" boolean DEFAULT false NOT NULL,
	"graph_json" jsonb NOT NULL,
	"migration_info" jsonb,
	"changelog" jsonb,
	"notes" text,
	"checksum" text,
	"created_by" varchar NOT NULL,
	"published" boolean DEFAULT false NOT NULL,
	"published_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"description" text,
	"creator_id" varchar,
	"owner_id" varchar,
	"mode_override" text,
	"public_link" text,
	"name" varchar(255),
	"project_id" uuid,
	"current_version_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"slug" text,
	"require_login" boolean DEFAULT false NOT NULL,
	"intake_config" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"pinned_version_id" uuid,
	"status" "workflow_status" DEFAULT 'draft' NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"source_blueprint_id" uuid,
	CONSTRAINT "workflows_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "ai_workflow_feedback" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid,
	"user_id" varchar,
	"operation_type" varchar NOT NULL,
	"rating" integer NOT NULL,
	"comment" text,
	"ai_provider" varchar,
	"ai_model" varchar,
	"prompt_version" varchar,
	"quality_score" integer,
	"quality_passed" boolean,
	"issues_count" integer,
	"request_description" text,
	"generated_sections" integer,
	"generated_steps" integer,
	"was_edited" boolean DEFAULT false,
	"edit_count" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "block_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"block_id" varchar NOT NULL,
	"total_visits" integer DEFAULT 0,
	"avg_time_ms" integer DEFAULT 0,
	"dropoff_count" integer DEFAULT 0,
	"validation_error_count" integer DEFAULT 0,
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"run_id" uuid,
	"type" "metrics_event_type" NOT NULL,
	"ts" timestamp with time zone DEFAULT now() NOT NULL,
	"duration_ms" integer,
	"payload" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_rollups" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"bucket_start" timestamp with time zone NOT NULL,
	"bucket" "rollup_bucket" NOT NULL,
	"runs_count" integer DEFAULT 0 NOT NULL,
	"runs_success" integer DEFAULT 0 NOT NULL,
	"runs_error" integer DEFAULT 0 NOT NULL,
	"dur_p50" integer,
	"dur_p95" integer,
	"pdf_success" integer DEFAULT 0 NOT NULL,
	"pdf_error" integer DEFAULT 0 NOT NULL,
	"docx_success" integer DEFAULT 0 NOT NULL,
	"docx_error" integer DEFAULT 0 NOT NULL,
	"queue_enqueued" integer DEFAULT 0 NOT NULL,
	"queue_dequeued" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "review_tasks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"status" "review_task_status" DEFAULT 'pending' NOT NULL,
	"reviewer_id" varchar,
	"reviewer_email" varchar(255),
	"message" text,
	"comment" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"resolved_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "run_generated_documents" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"file_name" text NOT NULL,
	"file_url" text NOT NULL,
	"mime_type" text,
	"file_size" integer,
	"template_id" uuid,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"node_id" varchar(100),
	"level" "log_level" NOT NULL,
	"message" text NOT NULL,
	"context" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_outputs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_key" text NOT NULL,
	"file_type" "output_file_type" NOT NULL,
	"storage_path" text NOT NULL,
	"status" "output_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"input_json" jsonb,
	"output_refs" jsonb,
	"trace" jsonb,
	"status" "run_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"duration_ms" integer,
	"run_token" varchar,
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "script_execution_log" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"script_type" varchar(50) NOT NULL,
	"script_id" uuid NOT NULL,
	"script_name" varchar(255),
	"phase" varchar(50),
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "script_execution_status" NOT NULL,
	"error_message" text,
	"console_output" jsonb,
	"input_sample" jsonb,
	"output_sample" jsonb,
	"duration_ms" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "signature_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"signature_request_id" uuid NOT NULL,
	"type" "signature_event_type" NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb
);
--> statement-breakpoint
CREATE TABLE "signature_requests" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"signer_email" varchar(255) NOT NULL,
	"signer_name" varchar(255),
	"status" "signature_request_status" DEFAULT 'pending' NOT NULL,
	"provider" "signature_provider" DEFAULT 'native' NOT NULL,
	"provider_request_id" text,
	"token" text NOT NULL,
	"document_url" text,
	"redirect_url" text,
	"message" text,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"signed_at" timestamp,
	CONSTRAINT "signature_requests_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "sli_configs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"target_success_pct" integer DEFAULT 99 NOT NULL,
	"target_p95_ms" integer DEFAULT 5000 NOT NULL,
	"error_budget_pct" integer DEFAULT 1 NOT NULL,
	"window" "sli_window" DEFAULT '7d' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sli_windows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"window_start" timestamp with time zone NOT NULL,
	"window_end" timestamp with time zone NOT NULL,
	"success_pct" integer,
	"p95_ms" integer,
	"error_budget_burn_pct" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "step_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"step_id" uuid NOT NULL,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_generation_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"run_id" uuid,
	"result" varchar(50) NOT NULL,
	"duration_ms" integer,
	"error_message" text,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_block_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"block_id" uuid NOT NULL,
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "transform_block_run_status" NOT NULL,
	"error_message" text,
	"output_sample" jsonb
);
--> statement-breakpoint
CREATE TABLE "workflow_analytics_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"date" timestamp NOT NULL,
	"summary" jsonb NOT NULL,
	"dropoff" jsonb NOT NULL,
	"branching" jsonb NOT NULL,
	"heatmap" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_run_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"block_id" varchar,
	"page_id" uuid,
	"type" varchar NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb,
	"is_preview" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_run_metrics" (
	"run_id" uuid PRIMARY KEY NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"total_time_ms" integer,
	"pages_visited" integer DEFAULT 0,
	"blocks_visited" integer DEFAULT 0,
	"validation_errors" integer DEFAULT 0,
	"script_errors" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"is_preview" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"workflow_version_id" uuid,
	"run_token" text NOT NULL,
	"created_by" text,
	"current_section_id" uuid,
	"progress" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"metadata" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"client_email" varchar,
	"portal_access_key" varchar,
	"access_mode" "portal_access_mode" DEFAULT 'anonymous',
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"owner_type" varchar(50),
	"owner_uuid" uuid,
	CONSTRAINT "workflow_runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "workflow_runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "analytics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"survey_id" uuid NOT NULL,
	"page_id" uuid,
	"question_id" uuid,
	"event" varchar NOT NULL,
	"data" jsonb,
	"duration" integer,
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "anonymous_response_tracking" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"ip_address" varchar NOT NULL,
	"session_id" varchar,
	"response_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "answers" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"question_id" uuid NOT NULL,
	"subquestion_id" uuid,
	"loop_index" integer,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "conditional_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"condition_question_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_question_id" uuid,
	"target_page_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_queue" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"to" varchar NOT NULL,
	"subject" varchar NOT NULL,
	"html" text NOT NULL,
	"status" "email_queue_status" DEFAULT 'pending' NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_error" text,
	"next_attempt_at" timestamp DEFAULT now(),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "files" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"answer_id" uuid NOT NULL,
	"filename" varchar NOT NULL,
	"original_name" varchar NOT NULL,
	"mime_type" varchar NOT NULL,
	"size" integer NOT NULL,
	"uploaded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "loop_group_subquestions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"loop_question_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "questions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"page_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"conditional_logic" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "responses" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"completed" boolean DEFAULT false,
	"submitted_at" timestamp,
	"is_anonymous" boolean DEFAULT false,
	"ip_address" varchar,
	"user_agent" text,
	"session_id" varchar,
	"anonymous_metadata" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_pages" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" text NOT NULL,
	"description" text,
	"content" jsonb NOT NULL,
	"creator_id" varchar,
	"is_system" boolean DEFAULT false NOT NULL,
	"tags" text[] DEFAULT ARRAY[]::text[],
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "surveys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"creator_id" varchar NOT NULL,
	"workspace_id" uuid,
	"status" "survey_status" DEFAULT 'draft' NOT NULL,
	"allow_anonymous" boolean DEFAULT false,
	"anonymous_access_type" "anonymous_access_type" DEFAULT 'unlimited',
	"public_link" varchar,
	"anonymous_config" jsonb,
	"is_public" boolean DEFAULT false,
	"public_access_mode" "public_access_mode" DEFAULT 'link_only',
	"public_slug" varchar,
	"allowed_domains" jsonb,
	"public_settings" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "surveys_public_link_unique" UNIQUE("public_link"),
	CONSTRAINT "surveys_public_slug_unique" UNIQUE("public_slug")
);
--> statement-breakpoint
CREATE TABLE "template_shares" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"user_id" varchar,
	"pending_email" text,
	"access" "template_access" DEFAULT 'use' NOT NULL,
	"invited_at" timestamp with time zone DEFAULT now(),
	"accepted_at" timestamp with time zone
);
--> statement-breakpoint
CREATE TABLE "collection_fields" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"collection_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"type" varchar(50) NOT NULL,
	"options" jsonb,
	"required" boolean DEFAULT false,
	"order" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_api_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"database_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"label" text NOT NULL,
	"token_hash" text NOT NULL,
	"scopes" text[] DEFAULT ARRAY[]::text[] NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "datavault_columns" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"type" "datavault_column_type" NOT NULL,
	"description" text,
	"width_px" integer DEFAULT 150,
	"required" boolean DEFAULT false NOT NULL,
	"is_primary_key" boolean DEFAULT false NOT NULL,
	"is_unique" boolean DEFAULT false NOT NULL,
	"order_index" integer DEFAULT 0 NOT NULL,
	"auto_number_start" integer DEFAULT 1,
	"autonumber_prefix" text,
	"autonumber_padding" integer DEFAULT 4,
	"autonumber_reset_policy" "autonumber_reset_policy" DEFAULT 'never',
	"reference_table_id" uuid,
	"reference_display_column_slug" text,
	"options" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_databases" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"type" "data_source_type" DEFAULT 'native' NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"scope_type" "datavault_scope_type" DEFAULT 'account' NOT NULL,
	"scope_id" uuid,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_number_sequences" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"prefix" text,
	"padding" integer DEFAULT 4 NOT NULL,
	"next_value" integer DEFAULT 1 NOT NULL,
	"reset_policy" "autonumber_reset_policy" DEFAULT 'never' NOT NULL,
	"last_reset" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_row_notes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"text" text NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_rows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"deleted_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "datavault_table_permissions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "datavault_table_role" NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_tables" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"owner_user_id" varchar,
	"database_id" uuid,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"value" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_writeback_mappings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_mappings" jsonb NOT NULL,
	"trigger_phase" varchar(50) DEFAULT 'afterComplete' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar
);
--> statement-breakpoint
CREATE TABLE "records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"collection_id" uuid NOT NULL,
	"data" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workflow_data_sources" (
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "workflow_data_sources_workflow_id_data_source_id_pk" PRIMARY KEY("workflow_id","data_source_id")
);
--> statement-breakpoint
CREATE TABLE "workflow_queries" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"filters" jsonb DEFAULT '[]'::jsonb,
	"sort" jsonb DEFAULT '[]'::jsonb,
	"limit" integer,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "api_keys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"prefix" varchar(50) NOT NULL,
	"key_hash" varchar(255) NOT NULL,
	"scopes" text[] NOT NULL,
	"name" varchar NOT NULL,
	"expires_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "api_keys_key_hash_unique" UNIQUE("key_hash")
);
--> statement-breakpoint
CREATE TABLE "connections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"type" "connection_type" NOT NULL,
	"base_url" varchar(500),
	"auth_config" jsonb DEFAULT '{}'::jsonb,
	"secret_refs" jsonb DEFAULT '{}'::jsonb,
	"oauth_state" jsonb,
	"default_headers" jsonb DEFAULT '{}'::jsonb,
	"timeout_ms" integer DEFAULT 8000,
	"retries" integer DEFAULT 2,
	"backoff_ms" integer DEFAULT 250,
	"enabled" boolean DEFAULT true NOT NULL,
	"last_tested_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "external_destinations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"config" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "oauth_access_tokens" (
	"access_token" varchar PRIMARY KEY NOT NULL,
	"refresh_token" varchar,
	"client_id" varchar NOT NULL,
	"user_id" varchar,
	"workspace_id" uuid NOT NULL,
	"scope" jsonb,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_access_tokens_refresh_token_unique" UNIQUE("refresh_token")
);
--> statement-breakpoint
CREATE TABLE "oauth_apps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"client_id" varchar NOT NULL,
	"client_secret_hash" varchar NOT NULL,
	"redirect_uris" jsonb NOT NULL,
	"scopes" jsonb NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_apps_client_id_unique" UNIQUE("client_id")
);
--> statement-breakpoint
CREATE TABLE "oauth_auth_codes" (
	"code" varchar PRIMARY KEY NOT NULL,
	"client_id" varchar NOT NULL,
	"user_id" varchar NOT NULL,
	"scope" jsonb,
	"redirect_uri" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"key" varchar NOT NULL,
	"value" text,
	"value_enc" text NOT NULL,
	"type" "secret_type" DEFAULT 'api_key' NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"environment" varchar DEFAULT 'production',
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"event" varchar NOT NULL,
	"payload" jsonb NOT NULL,
	"status" varchar NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_attempt_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"target_url" varchar NOT NULL,
	"events" jsonb NOT NULL,
	"secret" varchar NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "billing_plans" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"price_monthly" integer DEFAULT 0 NOT NULL,
	"price_yearly" integer DEFAULT 0 NOT NULL,
	"features" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"limits" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"stripe_product_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "customer_billing_info" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"stripe_customer_id" varchar NOT NULL,
	"billing_email" varchar,
	"default_payment_method_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscription_seats" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"assigned_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"plan_id" uuid NOT NULL,
	"status" "subscription_status" DEFAULT 'active' NOT NULL,
	"stripe_subscription_id" varchar,
	"current_period_start" timestamp,
	"current_period_end" timestamp,
	"cancel_at_period_end" boolean DEFAULT false,
	"canceled_at" timestamp,
	"trial_start" timestamp,
	"trial_end" timestamp,
	"seat_quantity" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "usage_records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"metric" varchar NOT NULL,
	"quantity" integer DEFAULT 1 NOT NULL,
	"workflow_id" uuid,
	"metadata" jsonb,
	"recorded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_template_metadata" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_key" varchar(255) NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"subject_preview" text,
	"branding_tokens" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "email_template_metadata_template_key_unique" UNIQUE("template_key")
);
--> statement-breakpoint
CREATE TABLE "ai_settings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"scope" varchar DEFAULT 'global' NOT NULL,
	"system_prompt" text,
	"updated_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
ALTER TABLE "account_locks" ADD CONSTRAINT "account_locks_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "email_verification_tokens" ADD CONSTRAINT "email_verification_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_backup_codes" ADD CONSTRAINT "mfa_backup_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_secrets" ADD CONSTRAINT "mfa_secrets_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_user_id_users_id_fk" FOREIGN KEY ("invited_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_by_user_id_users_id_fk" FOREIGN KEY ("invited_by_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_created_by_user_id_users_id_fk" FOREIGN KEY ("created_by_user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "password_reset_tokens" ADD CONSTRAINT "password_reset_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "refresh_tokens" ADD CONSTRAINT "refresh_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_team_id_teams_id_fk" FOREIGN KEY ("team_id") REFERENCES "public"."teams"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "teams" ADD CONSTRAINT "teams_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "tenant_domains" ADD CONSTRAINT "tenant_domains_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "trusted_devices" ADD CONSTRAINT "trusted_devices_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_credentials" ADD CONSTRAINT "user_credentials_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_personalization_settings" ADD CONSTRAINT "user_personalization_settings_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_preferences" ADD CONSTRAINT "user_preferences_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "users" ADD CONSTRAINT "users_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspaces" ADD CONSTRAINT "workspaces_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_snapshots" ADD CONSTRAINT "collab_snapshots_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_updates" ADD CONSTRAINT "collab_updates_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "document_hooks" ADD CONSTRAINT "document_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_condition_step_id_steps_id_fk" FOREIGN KEY ("condition_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_step_id_steps_id_fk" FOREIGN KEY ("target_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_section_id_sections_id_fk" FOREIGN KEY ("target_section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "project_access" ADD CONSTRAINT "project_access_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sections" ADD CONSTRAINT "sections_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "steps" ADD CONSTRAINT "steps_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_last_modified_by_users_id_fk" FOREIGN KEY ("last_modified_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_access" ADD CONSTRAINT "workflow_access_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_source_workflow_id_workflows_id_fk" FOREIGN KEY ("source_workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_base_id_workflows_id_fk" FOREIGN KEY ("base_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_reviewer_id_users_id_fk" FOREIGN KEY ("reviewer_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_template_id_workflow_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."workflow_templates"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_logs" ADD CONSTRAINT "run_logs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "script_execution_log" ADD CONSTRAINT "script_execution_log_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_events" ADD CONSTRAINT "signature_events_signature_request_id_signature_requests_id_fk" FOREIGN KEY ("signature_request_id") REFERENCES "public"."signature_requests"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_step_id_steps_id_fk" FOREIGN KEY ("step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_block_id_transform_blocks_id_fk" FOREIGN KEY ("block_id") REFERENCES "public"."transform_blocks"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_current_section_id_sections_id_fk" FOREIGN KEY ("current_section_id") REFERENCES "public"."sections"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_subquestion_id_loop_group_subquestions_id_fk" FOREIGN KEY ("subquestion_id") REFERENCES "public"."loop_group_subquestions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_condition_question_id_questions_id_fk" FOREIGN KEY ("condition_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_question_id_questions_id_fk" FOREIGN KEY ("target_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_page_id_survey_pages_id_fk" FOREIGN KEY ("target_page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "files" ADD CONSTRAINT "files_answer_id_answers_id_fk" FOREIGN KEY ("answer_id") REFERENCES "public"."answers"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "loop_group_subquestions" ADD CONSTRAINT "loop_group_subquestions_loop_question_id_questions_id_fk" FOREIGN KEY ("loop_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "questions" ADD CONSTRAINT "questions_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "responses" ADD CONSTRAINT "responses_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_pages" ADD CONSTRAINT "survey_pages_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_templates" ADD CONSTRAINT "survey_templates_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_template_id_survey_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."survey_templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collection_fields" ADD CONSTRAINT "collection_fields_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collections" ADD CONSTRAINT "collections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_columns" ADD CONSTRAINT "datavault_columns_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_databases" ADD CONSTRAINT "datavault_databases_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_owner_user_id_users_id_fk" FOREIGN KEY ("owner_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "api_keys" ADD CONSTRAINT "api_keys_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "external_destinations" ADD CONSTRAINT "external_destinations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_apps" ADD CONSTRAINT "oauth_apps_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "secrets" ADD CONSTRAINT "secrets_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_events" ADD CONSTRAINT "webhook_events_subscription_id_webhook_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."webhook_subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_subscriptions" ADD CONSTRAINT "webhook_subscriptions_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "customer_billing_info" ADD CONSTRAINT "customer_billing_info_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_subscription_id_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_plan_id_billing_plans_id_fk" FOREIGN KEY ("plan_id") REFERENCES "public"."billing_plans"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_settings" ADD CONSTRAINT "ai_settings_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
CREATE INDEX "account_locks_user_idx" ON "account_locks" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "account_locks_until_idx" ON "account_locks" USING btree ("locked_until");--> statement-breakpoint
CREATE INDEX "audit_logs_tenant_idx" ON "audit_logs" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "audit_logs_user_idx" ON "audit_logs" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "audit_logs_action_idx" ON "audit_logs" USING btree ("action");--> statement-breakpoint
CREATE INDEX "email_verify_token_idx" ON "email_verification_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "email_verify_user_idx" ON "email_verification_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "login_attempts_email_idx" ON "login_attempts" USING btree ("email");--> statement-breakpoint
CREATE INDEX "login_attempts_timestamp_idx" ON "login_attempts" USING btree ("attempted_at");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_user_idx" ON "mfa_backup_codes" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_hash_idx" ON "mfa_backup_codes" USING btree ("code_hash");--> statement-breakpoint
CREATE INDEX "mfa_secrets_user_idx" ON "mfa_secrets" USING btree ("user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "org_invites_token_unique_idx" ON "organization_invites" USING btree ("token");--> statement-breakpoint
CREATE INDEX "idx_org_invites_org_email_status" ON "organization_invites" USING btree ("org_id","invited_email","status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_status" ON "organization_invites" USING btree ("status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_expires" ON "organization_invites" USING btree ("expires_at");--> statement-breakpoint
CREATE UNIQUE INDEX "org_membership_unique_idx" ON "organization_memberships" USING btree ("org_id","user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_org" ON "organization_memberships" USING btree ("org_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_user" ON "organization_memberships" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_role" ON "organization_memberships" USING btree ("role");--> statement-breakpoint
CREATE INDEX "idx_organizations_created_by" ON "organizations" USING btree ("created_by_user_id");--> statement-breakpoint
CREATE INDEX "idx_organizations_tenant" ON "organizations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "pwd_reset_token_idx" ON "password_reset_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "pwd_reset_user_idx" ON "password_reset_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_user_idx" ON "refresh_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_token_idx" ON "refresh_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "IDX_session_expire" ON "sessions" USING btree ("expire");--> statement-breakpoint
CREATE UNIQUE INDEX "team_members_idx" ON "team_members" USING btree ("team_id","user_id");--> statement-breakpoint
CREATE INDEX "teams_tenant_idx" ON "teams" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_tenant_idx" ON "tenant_domains" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_domain_idx" ON "tenant_domains" USING btree ("domain");--> statement-breakpoint
CREATE INDEX "tenants_plan_idx" ON "tenants" USING btree ("plan");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_idx" ON "trusted_devices" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "trusted_devices_fingerprint_idx" ON "trusted_devices" USING btree ("device_fingerprint");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_fingerprint_idx" ON "trusted_devices" USING btree ("user_id","device_fingerprint");--> statement-breakpoint
CREATE INDEX "user_credentials_user_idx" ON "user_credentials" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "users_email_idx" ON "users" USING btree ("email");--> statement-breakpoint
CREATE INDEX "users_tenant_idx" ON "users" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "users_tenant_email_idx" ON "users" USING btree ("tenant_id","email");--> statement-breakpoint
CREATE INDEX "idx_users_is_placeholder" ON "users" USING btree ("is_placeholder");--> statement-breakpoint
CREATE INDEX "idx_users_placeholder_email" ON "users" USING btree ("placeholder_email");--> statement-breakpoint
CREATE INDEX "invitation_token_idx" ON "workspace_invitations" USING btree ("token");--> statement-breakpoint
CREATE INDEX "invitation_ws_email_idx" ON "workspace_invitations" USING btree ("workspace_id","email");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_member_idx" ON "workspace_members" USING btree ("workspace_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_org_slug_idx" ON "workspaces" USING btree ("organization_id","slug");--> statement-breakpoint
CREATE INDEX "blocks_workflow_phase_order_idx" ON "blocks" USING btree ("workflow_id","phase","order");--> statement-breakpoint
CREATE INDEX "collab_docs_workflow_idx" ON "collab_docs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "collab_snapshots_doc_clock_idx" ON "collab_snapshots" USING btree ("doc_id","clock");--> statement-breakpoint
CREATE INDEX "collab_updates_doc_seq_idx" ON "collab_updates" USING btree ("doc_id","seq");--> statement-breakpoint
CREATE INDEX "logic_rules_workflow_idx" ON "logic_rules" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "project_access_project_idx" ON "project_access" USING btree ("project_id");--> statement-breakpoint
CREATE UNIQUE INDEX "project_access_principal_idx" ON "project_access" USING btree ("project_id","principal_type","principal_id");--> statement-breakpoint
CREATE INDEX "projects_tenant_idx" ON "projects" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "projects_created_by_idx" ON "projects" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "projects_creator_idx" ON "projects" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "projects_owner_idx" ON "projects" USING btree ("owner_id");--> statement-breakpoint
CREATE INDEX "idx_projects_owner" ON "projects" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "projects_status_idx" ON "projects" USING btree ("status");--> statement-breakpoint
CREATE INDEX "projects_archived_idx" ON "projects" USING btree ("archived");--> statement-breakpoint
CREATE INDEX "sections_workflow_idx" ON "sections" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "steps_section_idx" ON "steps" USING btree ("section_id");--> statement-breakpoint
CREATE UNIQUE INDEX "template_versions_unique_idx" ON "template_versions" USING btree ("template_id","version_number");--> statement-breakpoint
CREATE INDEX "templates_project_idx" ON "templates" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflow_access_workflow_idx" ON "workflow_access" USING btree ("workflow_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_access_principal_idx" ON "workflow_access" USING btree ("workflow_id","principal_type","principal_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_snapshots_workflow_name_unique" ON "workflow_snapshots" USING btree ("workflow_id","name");--> statement-breakpoint
CREATE INDEX "workflow_templates_version_key_unique" ON "workflow_templates" USING btree ("workflow_version_id","key");--> statement-breakpoint
CREATE INDEX "workflow_versions_workflow_idx" ON "workflow_versions" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_versions_version_number_idx" ON "workflow_versions" USING btree ("workflow_id","version_number");--> statement-breakpoint
CREATE INDEX "workflow_versions_is_draft_idx" ON "workflow_versions" USING btree ("is_draft");--> statement-breakpoint
CREATE INDEX "workflows_project_idx" ON "workflows" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflows_status_idx" ON "workflows" USING btree ("status");--> statement-breakpoint
CREATE INDEX "workflows_is_public_idx" ON "workflows" USING btree ("is_public");--> statement-breakpoint
CREATE INDEX "workflows_slug_idx" ON "workflows" USING btree ("slug");--> statement-breakpoint
CREATE INDEX "workflows_pinned_version_idx" ON "workflows" USING btree ("pinned_version_id");--> statement-breakpoint
CREATE INDEX "idx_workflows_owner" ON "workflows" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "ai_feedback_workflow_idx" ON "ai_workflow_feedback" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "bm_version_block_idx" ON "block_metrics" USING btree ("version_id","block_id");--> statement-breakpoint
CREATE INDEX "metrics_events_project_ts_idx" ON "metrics_events" USING btree ("project_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_workflow_ts_idx" ON "metrics_events" USING btree ("workflow_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_type_idx" ON "metrics_events" USING btree ("type");--> statement-breakpoint
CREATE UNIQUE INDEX "metrics_rollups_unique_idx" ON "metrics_rollups" USING btree ("tenant_id","project_id",COALESCE("workflow_id", '00000000-0000-0000-0000-000000000000'::uuid),"bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "metrics_rollups_project_bucket_idx" ON "metrics_rollups" USING btree ("project_id","bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "review_tasks_run_idx" ON "review_tasks" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "review_tasks_workflow_idx" ON "review_tasks" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "review_tasks_status_idx" ON "review_tasks" USING btree ("status");--> statement-breakpoint
CREATE INDEX "review_tasks_reviewer_idx" ON "review_tasks" USING btree ("reviewer_id");--> statement-breakpoint
CREATE INDEX "run_generated_documents_run_idx" ON "run_generated_documents" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_run_idx" ON "run_logs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_level_idx" ON "run_logs" USING btree ("level");--> statement-breakpoint
CREATE INDEX "run_logs_created_at_idx" ON "run_logs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "run_outputs_run_idx" ON "run_outputs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_outputs_run_template_type_idx" ON "run_outputs" USING btree ("run_id","template_key","file_type");--> statement-breakpoint
CREATE INDEX "runs_workflow_version_idx" ON "runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "runs_status_idx" ON "runs" USING btree ("status");--> statement-breakpoint
CREATE INDEX "runs_created_by_idx" ON "runs" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "runs_created_at_idx" ON "runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "script_execution_log_run_idx" ON "script_execution_log" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_events_request_idx" ON "signature_events" USING btree ("signature_request_id");--> statement-breakpoint
CREATE INDEX "signature_requests_run_idx" ON "signature_requests" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_requests_token_idx" ON "signature_requests" USING btree ("token");--> statement-breakpoint
CREATE INDEX "sli_configs_project_idx" ON "sli_configs" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "sli_windows_project_window_idx" ON "sli_windows" USING btree ("project_id","window_start","window_end");--> statement-breakpoint
CREATE INDEX "step_values_run_idx" ON "step_values" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "step_values_step_idx" ON "step_values" USING btree ("step_id");--> statement-breakpoint
CREATE INDEX "step_values_run_step_idx" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE UNIQUE INDEX "step_values_run_step_unique" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE INDEX "template_metrics_template_idx" ON "template_generation_metrics" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_metrics_run_idx" ON "template_generation_metrics" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_run_idx" ON "transform_block_runs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_block_idx" ON "transform_block_runs" USING btree ("block_id");--> statement-breakpoint
CREATE UNIQUE INDEX "was_workflow_version_date_idx" ON "workflow_analytics_snapshots" USING btree ("workflow_id","version_id","date");--> statement-breakpoint
CREATE INDEX "wre_run_idx" ON "workflow_run_events" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "wre_workflow_ts_idx" ON "workflow_run_events" USING btree ("workflow_id","timestamp");--> statement-breakpoint
CREATE INDEX "wrm_workflow_created_idx" ON "workflow_run_metrics" USING btree ("workflow_id","created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_workflow_idx" ON "workflow_runs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_version_idx" ON "workflow_runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_completed_idx" ON "workflow_runs" USING btree ("completed");--> statement-breakpoint
CREATE INDEX "workflow_runs_run_token_idx" ON "workflow_runs" USING btree ("run_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_share_token_idx" ON "workflow_runs" USING btree ("share_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_current_section_idx" ON "workflow_runs" USING btree ("current_section_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_created_at_idx" ON "workflow_runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_owner_idx" ON "workflow_runs" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "analytics_survey_event_idx" ON "analytics_events" USING btree ("survey_id","event");--> statement-breakpoint
CREATE INDEX "analytics_response_event_idx" ON "analytics_events" USING btree ("response_id","event");--> statement-breakpoint
CREATE INDEX "analytics_timestamp_idx" ON "analytics_events" USING btree ("timestamp");--> statement-breakpoint
CREATE INDEX "anonymous_tracking_survey_ip_idx" ON "anonymous_response_tracking" USING btree ("survey_id","ip_address");--> statement-breakpoint
CREATE INDEX "email_queue_status_idx" ON "email_queue" USING btree ("status");--> statement-breakpoint
CREATE INDEX "email_queue_next_attempt_idx" ON "email_queue" USING btree ("next_attempt_at");--> statement-breakpoint
CREATE INDEX "survey_templates_creator_idx" ON "survey_templates" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "survey_templates_system_idx" ON "survey_templates" USING btree ("is_system");--> statement-breakpoint
CREATE INDEX "surveys_public_link_unique_idx" ON "surveys" USING btree ("public_link");--> statement-breakpoint
CREATE INDEX "surveys_workspace_idx" ON "surveys" USING btree ("workspace_id");--> statement-breakpoint
CREATE INDEX "template_shares_template_idx" ON "template_shares" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_shares_user_idx" ON "template_shares" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "template_shares_pending_email_idx" ON "template_shares" USING btree ("pending_email");--> statement-breakpoint
CREATE INDEX "collection_fields_collection_idx" ON "collection_fields" USING btree ("collection_id");--> statement-breakpoint
CREATE UNIQUE INDEX "collection_fields_slug_unique" ON "collection_fields" USING btree ("collection_id","slug");--> statement-breakpoint
CREATE UNIQUE INDEX "collections_slug_unique" ON "collections" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_database_id" ON "datavault_api_tokens" USING btree ("database_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE INDEX "datavault_columns_table_idx" ON "datavault_columns" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_columns_reference_table_idx" ON "datavault_columns" USING btree ("reference_table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_columns_table_slug_unique" ON "datavault_columns" USING btree ("table_id","slug");--> statement-breakpoint
CREATE INDEX "idx_databases_tenant" ON "datavault_databases" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_databases_scope" ON "datavault_databases" USING btree ("scope_type","scope_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_databases_owner" ON "datavault_databases" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_tenant" ON "datavault_number_sequences" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_table" ON "datavault_number_sequences" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "idx_datavault_sequences_column_unique" ON "datavault_number_sequences" USING btree ("tenant_id","table_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_row_id" ON "datavault_row_notes" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_tenant_id" ON "datavault_row_notes" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_table_idx" ON "datavault_rows" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_created_by_idx" ON "datavault_rows" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "idx_table_permissions_table" ON "datavault_table_permissions" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_table_user_permission" ON "datavault_table_permissions" USING btree ("table_id","user_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_tenant_idx" ON "datavault_tables" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_owner_idx" ON "datavault_tables" USING btree ("owner_user_id");--> statement-breakpoint
CREATE INDEX "idx_tables_database" ON "datavault_tables" USING btree ("database_id","tenant_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_tables_tenant_slug_unique" ON "datavault_tables" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "datavault_values_row_idx" ON "datavault_values" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "datavault_values_column_idx" ON "datavault_values" USING btree ("column_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_values_row_column_unique" ON "datavault_values" USING btree ("row_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_writeback_mappings_workflow" ON "datavault_writeback_mappings" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "records_collection_idx" ON "records" USING btree ("collection_id");--> statement-breakpoint
CREATE INDEX "records_tenant_idx" ON "records" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_data_sources_workflow" ON "workflow_data_sources" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_queries_workflow" ON "workflow_queries" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "api_keys_project_idx" ON "api_keys" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_tenant_idx" ON "connections" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "connections_project_idx" ON "connections" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_project_name_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "connections_type_idx" ON "connections" USING btree ("type");--> statement-breakpoint
CREATE INDEX "connections_enabled_idx" ON "connections" USING btree ("enabled");--> statement-breakpoint
CREATE UNIQUE INDEX "connections_project_name_unique_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "ext_dest_tenant_idx" ON "external_destinations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_client_id_idx" ON "oauth_apps" USING btree ("client_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_workspace_idx" ON "oauth_apps" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "secrets_project_key_env_unique" ON "secrets" USING btree ("project_id","key","environment");--> statement-breakpoint
CREATE INDEX "webhook_events_sub_idx" ON "webhook_events" USING btree ("subscription_id");--> statement-breakpoint
CREATE INDEX "webhook_subs_workspace_idx" ON "webhook_subscriptions" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_org_idx" ON "customer_billing_info" USING btree ("organization_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_stripe_idx" ON "customer_billing_info" USING btree ("stripe_customer_id");--> statement-breakpoint
CREATE UNIQUE INDEX "seat_sub_user_idx" ON "subscription_seats" USING btree ("subscription_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "sub_org_idx" ON "subscriptions" USING btree ("organization_id");--> statement-breakpoint
CREATE INDEX "usage_org_metric_date_idx" ON "usage_records" USING btree ("organization_id","metric","recorded_at");--> statement-breakpoint
CREATE INDEX "email_templates_key_idx" ON "email_template_metadata" USING btree ("template_key");--> statement-breakpoint
CREATE INDEX "ai_settings_scope_idx" ON "ai_settings" USING btree ("scope");
params: 
ΓÜá∩╕Å Migrations failed (non-fatal if DB exists): DrizzleQueryError: Failed query: CREATE TYPE "public"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint
CREATE TYPE "public"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint
CREATE TYPE "public"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint
CREATE TYPE "public"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint
CREATE TYPE "public"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint
CREATE TYPE "public"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint
CREATE TYPE "public"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint
CREATE TYPE "public"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint
CREATE TYPE "public"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint
CREATE TYPE "public"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint
CREATE TYPE "public"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint
CREATE TYPE "public"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint
CREATE TYPE "public"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint
CREATE TYPE "public"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint
CREATE TYPE "public"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint
CREATE TYPE "public"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint
CREATE TYPE "public"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint
CREATE TYPE "public"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint
CREATE TYPE "public"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint
CREATE TYPE "public"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint
CREATE TYPE "public"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint
CREATE TYPE "public"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint
CREATE TYPE "public"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint
CREATE TYPE "public"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint
CREATE TYPE "public"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint
CREATE TYPE "public"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint
CREATE TYPE "public"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint
CREATE TYPE "public"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint
CREATE TYPE "public"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint
CREATE TYPE "public"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint
CREATE TYPE "public"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint
CREATE TYPE "public"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint
CREATE TYPE "public"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint
CREATE TYPE "public"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint
CREATE TYPE "public"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint
CREATE TYPE "public"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint
CREATE TYPE "public"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint
CREATE TYPE "public"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint
CREATE TYPE "public"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint
CREATE TYPE "public"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint
CREATE TYPE "public"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint
CREATE TYPE "public"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint
CREATE TYPE "public"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint
CREATE TYPE "public"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint
CREATE TABLE "account_locks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"locked_at" timestamp DEFAULT now() NOT NULL,
	"locked_until" timestamp NOT NULL,
	"reason" varchar(255),
	"unlocked" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "audit_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"workspace_id" uuid,
	"user_id" varchar,
	"action" varchar NOT NULL,
	"entity_type" varchar NOT NULL,
	"entity_id" varchar NOT NULL,
	"resource_type" varchar,
	"resource_id" varchar,
	"changes" jsonb,
	"details" jsonb,
	"ip_address" varchar,
	"user_agent" text,
	"created_at" timestamp DEFAULT now(),
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_verification_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "login_attempts" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"ip_address" varchar(45),
	"successful" boolean DEFAULT false NOT NULL,
	"attempted_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_backup_codes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"code_hash" text NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"secret" text NOT NULL,
	"enabled" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"enabled_at" timestamp,
	CONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "organization_invites" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"invited_email" varchar(255) NOT NULL,
	"invited_user_id" varchar,
	"invited_by_user_id" varchar NOT NULL,
	"token" varchar(255) NOT NULL,
	"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp NOT NULL,
	"accepted_at" timestamp,
	"email_sent_at" timestamp,
	"email_failed" boolean DEFAULT false,
	"email_error" text,
	CONSTRAINT "organization_invites_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "organization_memberships" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "organization_role" DEFAULT 'member' NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "organizations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"slug" varchar,
	"domain" varchar,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"tenant_id" uuid NOT NULL,
	"created_by_user_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "organizations_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "password_reset_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "portal_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "portal_tokens_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "refresh_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"revoked" boolean DEFAULT false NOT NULL,
	"metadata" jsonb,
	"device_name" varchar(255),
	"ip_address" varchar(45),
	"location" varchar(255),
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sessions" (
	"sid" varchar PRIMARY KEY NOT NULL,
	"sess" jsonb NOT NULL,
	"expire" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE "team_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"team_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" varchar(50) DEFAULT 'member' NOT NULL,
	"joined_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "teams" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "tenant_domains" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"domain" text NOT NULL,
	"verified" boolean DEFAULT false,
	"verification_token" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "tenant_domains_domain_unique" UNIQUE("domain")
);
--> statement-breakpoint
CREATE TABLE "tenants" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar(255) NOT NULL,
	"billing_email" varchar(255),
	"plan" "tenant_plan" DEFAULT 'free' NOT NULL,
	"mfa_required" boolean DEFAULT false NOT NULL,
	"branding" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "trusted_devices" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"device_fingerprint" varchar(255) NOT NULL,
	"device_name" varchar(255),
	"trusted_until" timestamp NOT NULL,
	"ip_address" varchar(45),
	"location" varchar(255),
	"user_agent" text,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"last_used_at" timestamp,
	"revoked" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "user_credentials" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"password_hash" text NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "user_credentials_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "user_personalization_settings" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"reading_level" varchar DEFAULT 'standard' NOT NULL,
	"tone" varchar DEFAULT 'neutral' NOT NULL,
	"verbosity" varchar DEFAULT 'standard' NOT NULL,
	"language" varchar DEFAULT 'en' NOT NULL,
	"allow_adaptive_prompts" boolean DEFAULT true NOT NULL,
	"allow_ai_clarification" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "user_preferences" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"settings" jsonb DEFAULT '{"celebrationEffects":true,"darkMode":"system","aiHints":true}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "users" (
	"id" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"full_name" varchar(255),
	"first_name" varchar(255),
	"last_name" varchar(255),
	"profile_image_url" varchar(500),
	"tenant_id" uuid,
	"role" "user_role" DEFAULT 'creator' NOT NULL,
	"tenant_role" "user_tenant_role",
	"auth_provider" "auth_provider" DEFAULT 'local' NOT NULL,
	"default_mode" text DEFAULT 'easy' NOT NULL,
	"email_verified" boolean DEFAULT false NOT NULL,
	"mfa_enabled" boolean DEFAULT false NOT NULL,
	"last_password_change" timestamp,
	"is_placeholder" boolean DEFAULT false NOT NULL,
	"placeholder_email" varchar(255),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_invitations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"email" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"invited_by" varchar NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"joined_at" timestamp DEFAULT now(),
	"invited_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workspaces" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"slug" varchar NOT NULL,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"type" "block_type" NOT NULL,
	"phase" "block_phase" NOT NULL,
	"config" jsonb NOT NULL,
	"virtual_step_id" uuid,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_docs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid,
	"tenant_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"clock" integer NOT NULL,
	"state" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "collab_updates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"seq" integer NOT NULL,
	"update" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "document_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"final_block_document_id" varchar(255),
	"name" varchar(255) NOT NULL,
	"phase" "document_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 3000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "lifecycle_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar(255) NOT NULL,
	"phase" "lifecycle_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"virtual_step_ids" uuid[] DEFAULT '{}'::uuid[],
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"mutation_mode" boolean DEFAULT false,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "logic_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"condition_step_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_type" "logic_rule_target_type" NOT NULL,
	"target_step_id" uuid,
	"target_section_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "project_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "projects" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"name" varchar(255),
	"description" text,
	"creator_id" varchar NOT NULL,
	"tenant_id" uuid,
	"created_by" varchar,
	"owner_id" varchar NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"status" "project_status" DEFAULT 'active' NOT NULL,
	"archived" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"order" integer NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"visible_if" jsonb,
	"skip_if" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "steps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"section_id" uuid NOT NULL,
	"type" "step_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"alias" text,
	"default_value" jsonb,
	"order" integer NOT NULL,
	"is_virtual" boolean DEFAULT false NOT NULL,
	"visible_if" jsonb,
	"repeater_config" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"version_number" integer NOT NULL,
	"file_ref" varchar(500) NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"notes" text,
	"is_active" boolean DEFAULT true
);
--> statement-breakpoint
CREATE TABLE "templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"file_ref" varchar(500) NOT NULL,
	"type" "template_type" NOT NULL,
	"helpers_version" integer DEFAULT 1 NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"current_version" integer DEFAULT 1,
	"last_modified_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_key" varchar NOT NULL,
	"virtual_step_id" uuid,
	"phase" "block_phase" DEFAULT 'onSectionSubmit' NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_blueprints" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"creator_id" varchar NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"graph_json" jsonb NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"source_workflow_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"name" text NOT NULL,
	"values" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"workflow_version_id" uuid,
	"version_hash" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_id" uuid NOT NULL,
	"key" text NOT NULL,
	"is_primary" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"base_id" uuid,
	"version_number" integer DEFAULT 1 NOT NULL,
	"is_draft" boolean DEFAULT false NOT NULL,
	"graph_json" jsonb NOT NULL,
	"migration_info" jsonb,
	"changelog" jsonb,
	"notes" text,
	"checksum" text,
	"created_by" varchar NOT NULL,
	"published" boolean DEFAULT false NOT NULL,
	"published_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"description" text,
	"creator_id" varchar,
	"owner_id" varchar,
	"mode_override" text,
	"public_link" text,
	"name" varchar(255),
	"project_id" uuid,
	"current_version_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"slug" text,
	"require_login" boolean DEFAULT false NOT NULL,
	"intake_config" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"pinned_version_id" uuid,
	"status" "workflow_status" DEFAULT 'draft' NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"source_blueprint_id" uuid,
	CONSTRAINT "workflows_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "ai_workflow_feedback" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid,
	"user_id" varchar,
	"operation_type" varchar NOT NULL,
	"rating" integer NOT NULL,
	"comment" text,
	"ai_provider" varchar,
	"ai_model" varchar,
	"prompt_version" varchar,
	"quality_score" integer,
	"quality_passed" boolean,
	"issues_count" integer,
	"request_description" text,
	"generated_sections" integer,
	"generated_steps" integer,
	"was_edited" boolean DEFAULT false,
	"edit_count" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "block_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"block_id" varchar NOT NULL,
	"total_visits" integer DEFAULT 0,
	"avg_time_ms" integer DEFAULT 0,
	"dropoff_count" integer DEFAULT 0,
	"validation_error_count" integer DEFAULT 0,
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"run_id" uuid,
	"type" "metrics_event_type" NOT NULL,
	"ts" timestamp with time zone DEFAULT now() NOT NULL,
	"duration_ms" integer,
	"payload" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_rollups" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"bucket_start" timestamp with time zone NOT NULL,
	"bucket" "rollup_bucket" NOT NULL,
	"runs_count" integer DEFAULT 0 NOT NULL,
	"runs_success" integer DEFAULT 0 NOT NULL,
	"runs_error" integer DEFAULT 0 NOT NULL,
	"dur_p50" integer,
	"dur_p95" integer,
	"pdf_success" integer DEFAULT 0 NOT NULL,
	"pdf_error" integer DEFAULT 0 NOT NULL,
	"docx_success" integer DEFAULT 0 NOT NULL,
	"docx_error" integer DEFAULT 0 NOT NULL,
	"queue_enqueued" integer DEFAULT 0 NOT NULL,
	"queue_dequeued" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "review_tasks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"status" "review_task_status" DEFAULT 'pending' NOT NULL,
	"reviewer_id" varchar,
	"reviewer_email" varchar(255),
	"message" text,
	"comment" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"resolved_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "run_generated_documents" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"file_name" text NOT NULL,
	"file_url" text NOT NULL,
	"mime_type" text,
	"file_size" integer,
	"template_id" uuid,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"node_id" varchar(100),
	"level" "log_level" NOT NULL,
	"message" text NOT NULL,
	"context" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_outputs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_key" text NOT NULL,
	"file_type" "output_file_type" NOT NULL,
	"storage_path" text NOT NULL,
	"status" "output_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"input_json" jsonb,
	"output_refs" jsonb,
	"trace" jsonb,
	"status" "run_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"duration_ms" integer,
	"run_token" varchar,
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "script_execution_log" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"script_type" varchar(50) NOT NULL,
	"script_id" uuid NOT NULL,
	"script_name" varchar(255),
	"phase" varchar(50),
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "script_execution_status" NOT NULL,
	"error_message" text,
	"console_output" jsonb,
	"input_sample" jsonb,
	"output_sample" jsonb,
	"duration_ms" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "signature_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"signature_request_id" uuid NOT NULL,
	"type" "signature_event_type" NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb
);
--> statement-breakpoint
CREATE TABLE "signature_requests" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"signer_email" varchar(255) NOT NULL,
	"signer_name" varchar(255),
	"status" "signature_request_status" DEFAULT 'pending' NOT NULL,
	"provider" "signature_provider" DEFAULT 'native' NOT NULL,
	"provider_request_id" text,
	"token" text NOT NULL,
	"document_url" text,
	"redirect_url" text,
	"message" text,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"signed_at" timestamp,
	CONSTRAINT "signature_requests_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "sli_configs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"target_success_pct" integer DEFAULT 99 NOT NULL,
	"target_p95_ms" integer DEFAULT 5000 NOT NULL,
	"error_budget_pct" integer DEFAULT 1 NOT NULL,
	"window" "sli_window" DEFAULT '7d' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sli_windows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"window_start" timestamp with time zone NOT NULL,
	"window_end" timestamp with time zone NOT NULL,
	"success_pct" integer,
	"p95_ms" integer,
	"error_budget_burn_pct" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "step_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"step_id" uuid NOT NULL,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_generation_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"run_id" uuid,
	"result" varchar(50) NOT NULL,
	"duration_ms" integer,
	"error_message" text,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_block_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"block_id" uuid NOT NULL,
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "transform_block_run_status" NOT NULL,
	"error_message" text,
	"output_sample" jsonb
);
--> statement-breakpoint
CREATE TABLE "workflow_analytics_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"date" timestamp NOT NULL,
	"summary" jsonb NOT NULL,
	"dropoff" jsonb NOT NULL,
	"branching" jsonb NOT NULL,
	"heatmap" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_run_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"block_id" varchar,
	"page_id" uuid,
	"type" varchar NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb,
	"is_preview" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_run_metrics" (
	"run_id" uuid PRIMARY KEY NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"total_time_ms" integer,
	"pages_visited" integer DEFAULT 0,
	"blocks_visited" integer DEFAULT 0,
	"validation_errors" integer DEFAULT 0,
	"script_errors" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"is_preview" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"workflow_version_id" uuid,
	"run_token" text NOT NULL,
	"created_by" text,
	"current_section_id" uuid,
	"progress" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"metadata" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"client_email" varchar,
	"portal_access_key" varchar,
	"access_mode" "portal_access_mode" DEFAULT 'anonymous',
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"owner_type" varchar(50),
	"owner_uuid" uuid,
	CONSTRAINT "workflow_runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "workflow_runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "analytics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"survey_id" uuid NOT NULL,
	"page_id" uuid,
	"question_id" uuid,
	"event" varchar NOT NULL,
	"data" jsonb,
	"duration" integer,
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "anonymous_response_tracking" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"ip_address" varchar NOT NULL,
	"session_id" varchar,
	"response_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "answers" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"question_id" uuid NOT NULL,
	"subquestion_id" uuid,
	"loop_index" integer,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "conditional_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"condition_question_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_question_id" uuid,
	"target_page_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_queue" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"to" varchar NOT NULL,
	"subject" varchar NOT NULL,
	"html" text NOT NULL,
	"status" "email_queue_status" DEFAULT 'pending' NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_error" text,
	"next_attempt_at" timestamp DEFAULT now(),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "files" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"answer_id" uuid NOT NULL,
	"filename" varchar NOT NULL,
	"original_name" varchar NOT NULL,
	"mime_type" varchar NOT NULL,
	"size" integer NOT NULL,
	"uploaded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "loop_group_subquestions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"loop_question_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "questions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"page_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"conditional_logic" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "responses" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"completed" boolean DEFAULT false,
	"submitted_at" timestamp,
	"is_anonymous" boolean DEFAULT false,
	"ip_address" varchar,
	"user_agent" text,
	"session_id" varchar,
	"anonymous_metadata" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_pages" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" text NOT NULL,
	"description" text,
	"content" jsonb NOT NULL,
	"creator_id" varchar,
	"is_system" boolean DEFAULT false NOT NULL,
	"tags" text[] DEFAULT ARRAY[]::text[],
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "surveys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"creator_id" varchar NOT NULL,
	"workspace_id" uuid,
	"status" "survey_status" DEFAULT 'draft' NOT NULL,
	"allow_anonymous" boolean DEFAULT false,
	"anonymous_access_type" "anonymous_access_type" DEFAULT 'unlimited',
	"public_link" varchar,
	"anonymous_config" jsonb,
	"is_public" boolean DEFAULT false,
	"public_access_mode" "public_access_mode" DEFAULT 'link_only',
	"public_slug" varchar,
	"allowed_domains" jsonb,
	"public_settings" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "surveys_public_link_unique" UNIQUE("public_link"),
	CONSTRAINT "surveys_public_slug_unique" UNIQUE("public_slug")
);
--> statement-breakpoint
CREATE TABLE "template_shares" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"user_id" varchar,
	"pending_email" text,
	"access" "template_access" DEFAULT 'use' NOT NULL,
	"invited_at" timestamp with time zone DEFAULT now(),
	"accepted_at" timestamp with time zone
);
--> statement-breakpoint
CREATE TABLE "collection_fields" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"collection_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"type" varchar(50) NOT NULL,
	"options" jsonb,
	"required" boolean DEFAULT false,
	"order" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_api_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"database_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"label" text NOT NULL,
	"token_hash" text NOT NULL,
	"scopes" text[] DEFAULT ARRAY[]::text[] NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "datavault_columns" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"type" "datavault_column_type" NOT NULL,
	"description" text,
	"width_px" integer DEFAULT 150,
	"required" boolean DEFAULT false NOT NULL,
	"is_primary_key" boolean DEFAULT false NOT NULL,
	"is_unique" boolean DEFAULT false NOT NULL,
	"order_index" integer DEFAULT 0 NOT NULL,
	"auto_number_start" integer DEFAULT 1,
	"autonumber_prefix" text,
	"autonumber_padding" integer DEFAULT 4,
	"autonumber_reset_policy" "autonumber_reset_policy" DEFAULT 'never',
	"reference_table_id" uuid,
	"reference_display_column_slug" text,
	"options" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_databases" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"type" "data_source_type" DEFAULT 'native' NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"scope_type" "datavault_scope_type" DEFAULT 'account' NOT NULL,
	"scope_id" uuid,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_number_sequences" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"prefix" text,
	"padding" integer DEFAULT 4 NOT NULL,
	"next_value" integer DEFAULT 1 NOT NULL,
	"reset_policy" "autonumber_reset_policy" DEFAULT 'never' NOT NULL,
	"last_reset" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_row_notes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"text" text NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_rows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"deleted_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "datavault_table_permissions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "datavault_table_role" NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_tables" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"owner_user_id" varchar,
	"database_id" uuid,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"value" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_writeback_mappings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_mappings" jsonb NOT NULL,
	"trigger_phase" varchar(50) DEFAULT 'afterComplete' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar
);
--> statement-breakpoint
CREATE TABLE "records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"collection_id" uuid NOT NULL,
	"data" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workflow_data_sources" (
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "workflow_data_sources_workflow_id_data_source_id_pk" PRIMARY KEY("workflow_id","data_source_id")
);
--> statement-breakpoint
CREATE TABLE "workflow_queries" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"filters" jsonb DEFAULT '[]'::jsonb,
	"sort" jsonb DEFAULT '[]'::jsonb,
	"limit" integer,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "api_keys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"prefix" varchar(50) NOT NULL,
	"key_hash" varchar(255) NOT NULL,
	"scopes" text[] NOT NULL,
	"name" varchar NOT NULL,
	"expires_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "api_keys_key_hash_unique" UNIQUE("key_hash")
);
--> statement-breakpoint
CREATE TABLE "connections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"type" "connection_type" NOT NULL,
	"base_url" varchar(500),
	"auth_config" jsonb DEFAULT '{}'::jsonb,
	"secret_refs" jsonb DEFAULT '{}'::jsonb,
	"oauth_state" jsonb,
	"default_headers" jsonb DEFAULT '{}'::jsonb,
	"timeout_ms" integer DEFAULT 8000,
	"retries" integer DEFAULT 2,
	"backoff_ms" integer DEFAULT 250,
	"enabled" boolean DEFAULT true NOT NULL,
	"last_tested_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "external_destinations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"config" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "oauth_access_tokens" (
	"access_token" varchar PRIMARY KEY NOT NULL,
	"refresh_token" varchar,
	"client_id" varchar NOT NULL,
	"user_id" varchar,
	"workspace_id" uuid NOT NULL,
	"scope" jsonb,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_access_tokens_refresh_token_unique" UNIQUE("refresh_token")
);
--> statement-breakpoint
CREATE TABLE "oauth_apps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"client_id" varchar NOT NULL,
	"client_secret_hash" varchar NOT NULL,
	"redirect_uris" jsonb NOT NULL,
	"scopes" jsonb NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_apps_client_id_unique" UNIQUE("client_id")
);
--> statement-breakpoint
CREATE TABLE "oauth_auth_codes" (
	"code" varchar PRIMARY KEY NOT NULL,
	"client_id" varchar NOT NULL,
	"user_id" varchar NOT NULL,
	"scope" jsonb,
	"redirect_uri" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"key" varchar NOT NULL,
	"value" text,
	"value_enc" text NOT NULL,
	"type" "secret_type" DEFAULT 'api_key' NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"environment" varchar DEFAULT 'production',
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"event" varchar NOT NULL,
	"payload" jsonb NOT NULL,
	"status" varchar NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_attempt_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"target_url" varchar NOT NULL,
	"events" jsonb NOT NULL,
	"secret" varchar NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "billing_plans" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"price_monthly" integer DEFAULT 0 NOT NULL,
	"price_yearly" integer DEFAULT 0 NOT NULL,
	"features" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"limits" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"stripe_product_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "customer_billing_info" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"stripe_customer_id" varchar NOT NULL,
	"billing_email" varchar,
	"default_payment_method_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscription_seats" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"assigned_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"plan_id" uuid NOT NULL,
	"status" "subscription_status" DEFAULT 'active' NOT NULL,
	"stripe_subscription_id" varchar,
	"current_period_start" timestamp,
	"current_period_end" timestamp,
	"cancel_at_period_end" boolean DEFAULT false,
	"canceled_at" timestamp,
	"trial_start" timestamp,
	"trial_end" timestamp,
	"seat_quantity" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "usage_records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"metric" varchar NOT NULL,
	"quantity" integer DEFAULT 1 NOT NULL,
	"workflow_id" uuid,
	"metadata" jsonb,
	"recorded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_template_metadata" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_key" varchar(255) NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"subject_preview" text,
	"branding_tokens" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "email_template_metadata_template_key_unique" UNIQUE("template_key")
);
--> statement-breakpoint
CREATE TABLE "ai_settings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"scope" varchar DEFAULT 'global' NOT NULL,
	"system_prompt" text,
	"updated_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
ALTER TABLE "account_locks" ADD CONSTRAINT "account_locks_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "email_verification_tokens" ADD CONSTRAINT "email_verification_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_backup_codes" ADD CONSTRAINT "mfa_backup_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_secrets" ADD CONSTRAINT "mfa_secrets_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_user_id_users_id_fk" FOREIGN KEY ("invited_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_by_user_id_users_id_fk" FOREIGN KEY ("invited_by_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_created_by_user_id_users_id_fk" FOREIGN KEY ("created_by_user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "password_reset_tokens" ADD CONSTRAINT "password_reset_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "refresh_tokens" ADD CONSTRAINT "refresh_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_team_id_teams_id_fk" FOREIGN KEY ("team_id") REFERENCES "public"."teams"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "teams" ADD CONSTRAINT "teams_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "tenant_domains" ADD CONSTRAINT "tenant_domains_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "trusted_devices" ADD CONSTRAINT "trusted_devices_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_credentials" ADD CONSTRAINT "user_credentials_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_personalization_settings" ADD CONSTRAINT "user_personalization_settings_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_preferences" ADD CONSTRAINT "user_preferences_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "users" ADD CONSTRAINT "users_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspaces" ADD CONSTRAINT "workspaces_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_snapshots" ADD CONSTRAINT "collab_snapshots_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_updates" ADD CONSTRAINT "collab_updates_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "document_hooks" ADD CONSTRAINT "document_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_condition_step_id_steps_id_fk" FOREIGN KEY ("condition_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_step_id_steps_id_fk" FOREIGN KEY ("target_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_section_id_sections_id_fk" FOREIGN KEY ("target_section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "project_access" ADD CONSTRAINT "project_access_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sections" ADD CONSTRAINT "sections_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "steps" ADD CONSTRAINT "steps_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_last_modified_by_users_id_fk" FOREIGN KEY ("last_modified_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_access" ADD CONSTRAINT "workflow_access_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_source_workflow_id_workflows_id_fk" FOREIGN KEY ("source_workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_base_id_workflows_id_fk" FOREIGN KEY ("base_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_reviewer_id_users_id_fk" FOREIGN KEY ("reviewer_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_template_id_workflow_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."workflow_templates"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_logs" ADD CONSTRAINT "run_logs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "script_execution_log" ADD CONSTRAINT "script_execution_log_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_events" ADD CONSTRAINT "signature_events_signature_request_id_signature_requests_id_fk" FOREIGN KEY ("signature_request_id") REFERENCES "public"."signature_requests"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_step_id_steps_id_fk" FOREIGN KEY ("step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_block_id_transform_blocks_id_fk" FOREIGN KEY ("block_id") REFERENCES "public"."transform_blocks"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_current_section_id_sections_id_fk" FOREIGN KEY ("current_section_id") REFERENCES "public"."sections"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_subquestion_id_loop_group_subquestions_id_fk" FOREIGN KEY ("subquestion_id") REFERENCES "public"."loop_group_subquestions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_condition_question_id_questions_id_fk" FOREIGN KEY ("condition_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_question_id_questions_id_fk" FOREIGN KEY ("target_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_page_id_survey_pages_id_fk" FOREIGN KEY ("target_page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "files" ADD CONSTRAINT "files_answer_id_answers_id_fk" FOREIGN KEY ("answer_id") REFERENCES "public"."answers"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "loop_group_subquestions" ADD CONSTRAINT "loop_group_subquestions_loop_question_id_questions_id_fk" FOREIGN KEY ("loop_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "questions" ADD CONSTRAINT "questions_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "responses" ADD CONSTRAINT "responses_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_pages" ADD CONSTRAINT "survey_pages_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_templates" ADD CONSTRAINT "survey_templates_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_template_id_survey_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."survey_templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collection_fields" ADD CONSTRAINT "collection_fields_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collections" ADD CONSTRAINT "collections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_columns" ADD CONSTRAINT "datavault_columns_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_databases" ADD CONSTRAINT "datavault_databases_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_owner_user_id_users_id_fk" FOREIGN KEY ("owner_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "api_keys" ADD CONSTRAINT "api_keys_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "external_destinations" ADD CONSTRAINT "external_destinations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_apps" ADD CONSTRAINT "oauth_apps_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "secrets" ADD CONSTRAINT "secrets_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_events" ADD CONSTRAINT "webhook_events_subscription_id_webhook_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."webhook_subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_subscriptions" ADD CONSTRAINT "webhook_subscriptions_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "customer_billing_info" ADD CONSTRAINT "customer_billing_info_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_subscription_id_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_plan_id_billing_plans_id_fk" FOREIGN KEY ("plan_id") REFERENCES "public"."billing_plans"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_settings" ADD CONSTRAINT "ai_settings_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
CREATE INDEX "account_locks_user_idx" ON "account_locks" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "account_locks_until_idx" ON "account_locks" USING btree ("locked_until");--> statement-breakpoint
CREATE INDEX "audit_logs_tenant_idx" ON "audit_logs" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "audit_logs_user_idx" ON "audit_logs" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "audit_logs_action_idx" ON "audit_logs" USING btree ("action");--> statement-breakpoint
CREATE INDEX "email_verify_token_idx" ON "email_verification_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "email_verify_user_idx" ON "email_verification_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "login_attempts_email_idx" ON "login_attempts" USING btree ("email");--> statement-breakpoint
CREATE INDEX "login_attempts_timestamp_idx" ON "login_attempts" USING btree ("attempted_at");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_user_idx" ON "mfa_backup_codes" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_hash_idx" ON "mfa_backup_codes" USING btree ("code_hash");--> statement-breakpoint
CREATE INDEX "mfa_secrets_user_idx" ON "mfa_secrets" USING btree ("user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "org_invites_token_unique_idx" ON "organization_invites" USING btree ("token");--> statement-breakpoint
CREATE INDEX "idx_org_invites_org_email_status" ON "organization_invites" USING btree ("org_id","invited_email","status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_status" ON "organization_invites" USING btree ("status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_expires" ON "organization_invites" USING btree ("expires_at");--> statement-breakpoint
CREATE UNIQUE INDEX "org_membership_unique_idx" ON "organization_memberships" USING btree ("org_id","user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_org" ON "organization_memberships" USING btree ("org_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_user" ON "organization_memberships" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_role" ON "organization_memberships" USING btree ("role");--> statement-breakpoint
CREATE INDEX "idx_organizations_created_by" ON "organizations" USING btree ("created_by_user_id");--> statement-breakpoint
CREATE INDEX "idx_organizations_tenant" ON "organizations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "pwd_reset_token_idx" ON "password_reset_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "pwd_reset_user_idx" ON "password_reset_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_user_idx" ON "refresh_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_token_idx" ON "refresh_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "IDX_session_expire" ON "sessions" USING btree ("expire");--> statement-breakpoint
CREATE UNIQUE INDEX "team_members_idx" ON "team_members" USING btree ("team_id","user_id");--> statement-breakpoint
CREATE INDEX "teams_tenant_idx" ON "teams" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_tenant_idx" ON "tenant_domains" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_domain_idx" ON "tenant_domains" USING btree ("domain");--> statement-breakpoint
CREATE INDEX "tenants_plan_idx" ON "tenants" USING btree ("plan");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_idx" ON "trusted_devices" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "trusted_devices_fingerprint_idx" ON "trusted_devices" USING btree ("device_fingerprint");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_fingerprint_idx" ON "trusted_devices" USING btree ("user_id","device_fingerprint");--> statement-breakpoint
CREATE INDEX "user_credentials_user_idx" ON "user_credentials" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "users_email_idx" ON "users" USING btree ("email");--> statement-breakpoint
CREATE INDEX "users_tenant_idx" ON "users" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "users_tenant_email_idx" ON "users" USING btree ("tenant_id","email");--> statement-breakpoint
CREATE INDEX "idx_users_is_placeholder" ON "users" USING btree ("is_placeholder");--> statement-breakpoint
CREATE INDEX "idx_users_placeholder_email" ON "users" USING btree ("placeholder_email");--> statement-breakpoint
CREATE INDEX "invitation_token_idx" ON "workspace_invitations" USING btree ("token");--> statement-breakpoint
CREATE INDEX "invitation_ws_email_idx" ON "workspace_invitations" USING btree ("workspace_id","email");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_member_idx" ON "workspace_members" USING btree ("workspace_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_org_slug_idx" ON "workspaces" USING btree ("organization_id","slug");--> statement-breakpoint
CREATE INDEX "blocks_workflow_phase_order_idx" ON "blocks" USING btree ("workflow_id","phase","order");--> statement-breakpoint
CREATE INDEX "collab_docs_workflow_idx" ON "collab_docs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "collab_snapshots_doc_clock_idx" ON "collab_snapshots" USING btree ("doc_id","clock");--> statement-breakpoint
CREATE INDEX "collab_updates_doc_seq_idx" ON "collab_updates" USING btree ("doc_id","seq");--> statement-breakpoint
CREATE INDEX "logic_rules_workflow_idx" ON "logic_rules" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "project_access_project_idx" ON "project_access" USING btree ("project_id");--> statement-breakpoint
CREATE UNIQUE INDEX "project_access_principal_idx" ON "project_access" USING btree ("project_id","principal_type","principal_id");--> statement-breakpoint
CREATE INDEX "projects_tenant_idx" ON "projects" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "projects_created_by_idx" ON "projects" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "projects_creator_idx" ON "projects" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "projects_owner_idx" ON "projects" USING btree ("owner_id");--> statement-breakpoint
CREATE INDEX "idx_projects_owner" ON "projects" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "projects_status_idx" ON "projects" USING btree ("status");--> statement-breakpoint
CREATE INDEX "projects_archived_idx" ON "projects" USING btree ("archived");--> statement-breakpoint
CREATE INDEX "sections_workflow_idx" ON "sections" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "steps_section_idx" ON "steps" USING btree ("section_id");--> statement-breakpoint
CREATE UNIQUE INDEX "template_versions_unique_idx" ON "template_versions" USING btree ("template_id","version_number");--> statement-breakpoint
CREATE INDEX "templates_project_idx" ON "templates" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflow_access_workflow_idx" ON "workflow_access" USING btree ("workflow_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_access_principal_idx" ON "workflow_access" USING btree ("workflow_id","principal_type","principal_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_snapshots_workflow_name_unique" ON "workflow_snapshots" USING btree ("workflow_id","name");--> statement-breakpoint
CREATE INDEX "workflow_templates_version_key_unique" ON "workflow_templates" USING btree ("workflow_version_id","key");--> statement-breakpoint
CREATE INDEX "workflow_versions_workflow_idx" ON "workflow_versions" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_versions_version_number_idx" ON "workflow_versions" USING btree ("workflow_id","version_number");--> statement-breakpoint
CREATE INDEX "workflow_versions_is_draft_idx" ON "workflow_versions" USING btree ("is_draft");--> statement-breakpoint
CREATE INDEX "workflows_project_idx" ON "workflows" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflows_status_idx" ON "workflows" USING btree ("status");--> statement-breakpoint
CREATE INDEX "workflows_is_public_idx" ON "workflows" USING btree ("is_public");--> statement-breakpoint
CREATE INDEX "workflows_slug_idx" ON "workflows" USING btree ("slug");--> statement-breakpoint
CREATE INDEX "workflows_pinned_version_idx" ON "workflows" USING btree ("pinned_version_id");--> statement-breakpoint
CREATE INDEX "idx_workflows_owner" ON "workflows" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "ai_feedback_workflow_idx" ON "ai_workflow_feedback" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "bm_version_block_idx" ON "block_metrics" USING btree ("version_id","block_id");--> statement-breakpoint
CREATE INDEX "metrics_events_project_ts_idx" ON "metrics_events" USING btree ("project_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_workflow_ts_idx" ON "metrics_events" USING btree ("workflow_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_type_idx" ON "metrics_events" USING btree ("type");--> statement-breakpoint
CREATE UNIQUE INDEX "metrics_rollups_unique_idx" ON "metrics_rollups" USING btree ("tenant_id","project_id",COALESCE("workflow_id", '00000000-0000-0000-0000-000000000000'::uuid),"bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "metrics_rollups_project_bucket_idx" ON "metrics_rollups" USING btree ("project_id","bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "review_tasks_run_idx" ON "review_tasks" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "review_tasks_workflow_idx" ON "review_tasks" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "review_tasks_status_idx" ON "review_tasks" USING btree ("status");--> statement-breakpoint
CREATE INDEX "review_tasks_reviewer_idx" ON "review_tasks" USING btree ("reviewer_id");--> statement-breakpoint
CREATE INDEX "run_generated_documents_run_idx" ON "run_generated_documents" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_run_idx" ON "run_logs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_level_idx" ON "run_logs" USING btree ("level");--> statement-breakpoint
CREATE INDEX "run_logs_created_at_idx" ON "run_logs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "run_outputs_run_idx" ON "run_outputs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_outputs_run_template_type_idx" ON "run_outputs" USING btree ("run_id","template_key","file_type");--> statement-breakpoint
CREATE INDEX "runs_workflow_version_idx" ON "runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "runs_status_idx" ON "runs" USING btree ("status");--> statement-breakpoint
CREATE INDEX "runs_created_by_idx" ON "runs" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "runs_created_at_idx" ON "runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "script_execution_log_run_idx" ON "script_execution_log" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_events_request_idx" ON "signature_events" USING btree ("signature_request_id");--> statement-breakpoint
CREATE INDEX "signature_requests_run_idx" ON "signature_requests" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_requests_token_idx" ON "signature_requests" USING btree ("token");--> statement-breakpoint
CREATE INDEX "sli_configs_project_idx" ON "sli_configs" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "sli_windows_project_window_idx" ON "sli_windows" USING btree ("project_id","window_start","window_end");--> statement-breakpoint
CREATE INDEX "step_values_run_idx" ON "step_values" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "step_values_step_idx" ON "step_values" USING btree ("step_id");--> statement-breakpoint
CREATE INDEX "step_values_run_step_idx" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE UNIQUE INDEX "step_values_run_step_unique" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE INDEX "template_metrics_template_idx" ON "template_generation_metrics" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_metrics_run_idx" ON "template_generation_metrics" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_run_idx" ON "transform_block_runs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_block_idx" ON "transform_block_runs" USING btree ("block_id");--> statement-breakpoint
CREATE UNIQUE INDEX "was_workflow_version_date_idx" ON "workflow_analytics_snapshots" USING btree ("workflow_id","version_id","date");--> statement-breakpoint
CREATE INDEX "wre_run_idx" ON "workflow_run_events" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "wre_workflow_ts_idx" ON "workflow_run_events" USING btree ("workflow_id","timestamp");--> statement-breakpoint
CREATE INDEX "wrm_workflow_created_idx" ON "workflow_run_metrics" USING btree ("workflow_id","created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_workflow_idx" ON "workflow_runs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_version_idx" ON "workflow_runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_completed_idx" ON "workflow_runs" USING btree ("completed");--> statement-breakpoint
CREATE INDEX "workflow_runs_run_token_idx" ON "workflow_runs" USING btree ("run_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_share_token_idx" ON "workflow_runs" USING btree ("share_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_current_section_idx" ON "workflow_runs" USING btree ("current_section_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_created_at_idx" ON "workflow_runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_owner_idx" ON "workflow_runs" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "analytics_survey_event_idx" ON "analytics_events" USING btree ("survey_id","event");--> statement-breakpoint
CREATE INDEX "analytics_response_event_idx" ON "analytics_events" USING btree ("response_id","event");--> statement-breakpoint
CREATE INDEX "analytics_timestamp_idx" ON "analytics_events" USING btree ("timestamp");--> statement-breakpoint
CREATE INDEX "anonymous_tracking_survey_ip_idx" ON "anonymous_response_tracking" USING btree ("survey_id","ip_address");--> statement-breakpoint
CREATE INDEX "email_queue_status_idx" ON "email_queue" USING btree ("status");--> statement-breakpoint
CREATE INDEX "email_queue_next_attempt_idx" ON "email_queue" USING btree ("next_attempt_at");--> statement-breakpoint
CREATE INDEX "survey_templates_creator_idx" ON "survey_templates" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "survey_templates_system_idx" ON "survey_templates" USING btree ("is_system");--> statement-breakpoint
CREATE INDEX "surveys_public_link_unique_idx" ON "surveys" USING btree ("public_link");--> statement-breakpoint
CREATE INDEX "surveys_workspace_idx" ON "surveys" USING btree ("workspace_id");--> statement-breakpoint
CREATE INDEX "template_shares_template_idx" ON "template_shares" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_shares_user_idx" ON "template_shares" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "template_shares_pending_email_idx" ON "template_shares" USING btree ("pending_email");--> statement-breakpoint
CREATE INDEX "collection_fields_collection_idx" ON "collection_fields" USING btree ("collection_id");--> statement-breakpoint
CREATE UNIQUE INDEX "collection_fields_slug_unique" ON "collection_fields" USING btree ("collection_id","slug");--> statement-breakpoint
CREATE UNIQUE INDEX "collections_slug_unique" ON "collections" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_database_id" ON "datavault_api_tokens" USING btree ("database_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE INDEX "datavault_columns_table_idx" ON "datavault_columns" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_columns_reference_table_idx" ON "datavault_columns" USING btree ("reference_table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_columns_table_slug_unique" ON "datavault_columns" USING btree ("table_id","slug");--> statement-breakpoint
CREATE INDEX "idx_databases_tenant" ON "datavault_databases" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_databases_scope" ON "datavault_databases" USING btree ("scope_type","scope_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_databases_owner" ON "datavault_databases" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_tenant" ON "datavault_number_sequences" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_table" ON "datavault_number_sequences" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "idx_datavault_sequences_column_unique" ON "datavault_number_sequences" USING btree ("tenant_id","table_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_row_id" ON "datavault_row_notes" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_tenant_id" ON "datavault_row_notes" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_table_idx" ON "datavault_rows" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_created_by_idx" ON "datavault_rows" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "idx_table_permissions_table" ON "datavault_table_permissions" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_table_user_permission" ON "datavault_table_permissions" USING btree ("table_id","user_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_tenant_idx" ON "datavault_tables" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_owner_idx" ON "datavault_tables" USING btree ("owner_user_id");--> statement-breakpoint
CREATE INDEX "idx_tables_database" ON "datavault_tables" USING btree ("database_id","tenant_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_tables_tenant_slug_unique" ON "datavault_tables" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "datavault_values_row_idx" ON "datavault_values" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "datavault_values_column_idx" ON "datavault_values" USING btree ("column_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_values_row_column_unique" ON "datavault_values" USING btree ("row_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_writeback_mappings_workflow" ON "datavault_writeback_mappings" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "records_collection_idx" ON "records" USING btree ("collection_id");--> statement-breakpoint
CREATE INDEX "records_tenant_idx" ON "records" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_data_sources_workflow" ON "workflow_data_sources" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_queries_workflow" ON "workflow_queries" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "api_keys_project_idx" ON "api_keys" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_tenant_idx" ON "connections" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "connections_project_idx" ON "connections" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_project_name_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "connections_type_idx" ON "connections" USING btree ("type");--> statement-breakpoint
CREATE INDEX "connections_enabled_idx" ON "connections" USING btree ("enabled");--> statement-breakpoint
CREATE UNIQUE INDEX "connections_project_name_unique_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "ext_dest_tenant_idx" ON "external_destinations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_client_id_idx" ON "oauth_apps" USING btree ("client_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_workspace_idx" ON "oauth_apps" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "secrets_project_key_env_unique" ON "secrets" USING btree ("project_id","key","environment");--> statement-breakpoint
CREATE INDEX "webhook_events_sub_idx" ON "webhook_events" USING btree ("subscription_id");--> statement-breakpoint
CREATE INDEX "webhook_subs_workspace_idx" ON "webhook_subscriptions" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_org_idx" ON "customer_billing_info" USING btree ("organization_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_stripe_idx" ON "customer_billing_info" USING btree ("stripe_customer_id");--> statement-breakpoint
CREATE UNIQUE INDEX "seat_sub_user_idx" ON "subscription_seats" USING btree ("subscription_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "sub_org_idx" ON "subscriptions" USING btree ("organization_id");--> statement-breakpoint
CREATE INDEX "usage_org_metric_date_idx" ON "usage_records" USING btree ("organization_id","metric","recorded_at");--> statement-breakpoint
CREATE INDEX "email_templates_key_idx" ON "email_template_metadata" USING btree ("template_key");--> statement-breakpoint
CREATE INDEX "ai_settings_scope_idx" ON "ai_settings" USING btree ("scope");
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:232:19 {
  query: `CREATE TYPE "public"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint\n` +
    'CREATE TABLE "account_locks" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"locked_at" timestamp DEFAULT now() NOT NULL,\n' +
    '\t"locked_until" timestamp NOT NULL,\n' +
    '\t"reason" varchar(255),\n' +
    '\t"unlocked" boolean DEFAULT false NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "audit_logs" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"tenant_id" uuid,\n' +
    '\t"workspace_id" uuid,\n' +
    '\t"user_id" varchar,\n' +
    '\t"action" varchar NOT NULL,\n' +
    '\t"entity_type" varchar NOT NULL,\n' +
    '\t"entity_id" varchar NOT NULL,\n' +
    '\t"resource_type" varchar,\n' +
    '\t"resource_id" varchar,\n' +
    '\t"changes" jsonb,\n' +
    '\t"details" jsonb,\n' +
    '\t"ip_address" varchar,\n' +
    '\t"user_agent" text,\n' +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"timestamp" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "email_verification_tokens" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"token" varchar NOT NULL,\n' +
    '\t"expires_at" timestamp NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "login_attempts" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"email" varchar(255) NOT NULL,\n' +
    '\t"ip_address" varchar(45),\n' +
    '\t"successful" boolean DEFAULT false NOT NULL,\n' +
    '\t"attempted_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "mfa_backup_codes" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"code_hash" text NOT NULL,\n' +
    '\t"used" boolean DEFAULT false NOT NULL,\n' +
    '\t"used_at" timestamp,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "mfa_secrets" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"secret" text NOT NULL,\n' +
    '\t"enabled" boolean DEFAULT false NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL,\n' +
    '\t"enabled_at" timestamp,\n' +
    '\tCONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "organization_invites" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"org_id" uuid NOT NULL,\n' +
    '\t"invited_email" varchar(255) NOT NULL,\n' +
    '\t"invited_user_id" varchar,\n' +
    '\t"invited_by_user_id" varchar NOT NULL,\n' +
    '\t"token" varchar(255) NOT NULL,\n' +
    `\t"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,\n` +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"expires_at" timestamp NOT NULL,\n' +
    '\t"accepted_at" timestamp,\n' +
    '\t"email_sent_at" timestamp,\n' +
    '\t"email_failed" boolean DEFAULT false,\n' +
    '\t"email_error" text,\n' +
    '\tCONSTRAINT "organization_invites_token_unique" UNIQUE("token")\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "organization_memberships" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"org_id" uuid NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    `\t"role" "organization_role" DEFAULT 'member' NOT NULL,\n` +
    '\t"created_at" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "organizations" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"name" varchar NOT NULL,\n' +
    '\t"description" text,\n' +
    '\t"slug" varchar,\n' +
    '\t"domain" varchar,\n' +
    `\t"settings" jsonb DEFAULT '{}'::jsonb,\n` +
    '\t"tenant_id" uuid NOT NULL,\n' +
    '\t"created_by_user_id" varchar,\n' +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"upd'... 108432 more characters,
  params: [],
  cause: error: type "anonymous_access_type" already exists
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:232:19 {
    length: 101,
    severity: 'ERROR',
    code: '42710',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: 'typecmds.c',
    line: '1177',
    routine: 'DefineEnum'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768674680109,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768674680127,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768674680117,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768674680118,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768674680122,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768674680122,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768674680126,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768674680126,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768674680127,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768674680127,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768674680346,"env":"test","module":"auth-routes","error":{},"msg":"Registration failed"}
{"level":30,"time":1768674680356,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768674680356,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 2462ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  12:31:08
   Duration  14.02s (transform 4.66s, setup 2.29s, import 7.32s, tests 2.46s, environment 0ms)

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/helpers/schemaManager.ts x1 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768674746720,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768674748624,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768674748671,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: public
≡ƒöä Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/auth/protected.routes.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

stdout | tests/integration/auth/protected.routes.test.ts
   Applying 0000_mushy_thing.sql...

stderr | tests/integration/auth/protected.routes.test.ts
Γ¥î FAILED MIGRATION 0000_mushy_thing.sql: Failed query: CREATE TYPE "public"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint
CREATE TYPE "public"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint
CREATE TYPE "public"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint
CREATE TYPE "public"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint
CREATE TYPE "public"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint
CREATE TYPE "public"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint
CREATE TYPE "public"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint
CREATE TYPE "public"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint
CREATE TYPE "public"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint
CREATE TYPE "public"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint
CREATE TYPE "public"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint
CREATE TYPE "public"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint
CREATE TYPE "public"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint
CREATE TYPE "public"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint
CREATE TYPE "public"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint
CREATE TYPE "public"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint
CREATE TYPE "public"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint
CREATE TYPE "public"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint
CREATE TYPE "public"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint
CREATE TYPE "public"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint
CREATE TYPE "public"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint
CREATE TYPE "public"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint
CREATE TYPE "public"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint
CREATE TYPE "public"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint
CREATE TYPE "public"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint
CREATE TYPE "public"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint
CREATE TYPE "public"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint
CREATE TYPE "public"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint
CREATE TYPE "public"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint
CREATE TYPE "public"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint
CREATE TYPE "public"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint
CREATE TYPE "public"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint
CREATE TYPE "public"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint
CREATE TYPE "public"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint
CREATE TYPE "public"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint
CREATE TYPE "public"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint
CREATE TYPE "public"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint
CREATE TYPE "public"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint
CREATE TYPE "public"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint
CREATE TYPE "public"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint
CREATE TYPE "public"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint
CREATE TYPE "public"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint
CREATE TYPE "public"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint
CREATE TYPE "public"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint
CREATE TABLE "account_locks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"locked_at" timestamp DEFAULT now() NOT NULL,
	"locked_until" timestamp NOT NULL,
	"reason" varchar(255),
	"unlocked" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "audit_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"workspace_id" uuid,
	"user_id" varchar,
	"action" varchar NOT NULL,
	"entity_type" varchar NOT NULL,
	"entity_id" varchar NOT NULL,
	"resource_type" varchar,
	"resource_id" varchar,
	"changes" jsonb,
	"details" jsonb,
	"ip_address" varchar,
	"user_agent" text,
	"created_at" timestamp DEFAULT now(),
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_verification_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "login_attempts" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"ip_address" varchar(45),
	"successful" boolean DEFAULT false NOT NULL,
	"attempted_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_backup_codes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"code_hash" text NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"secret" text NOT NULL,
	"enabled" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"enabled_at" timestamp,
	CONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "organization_invites" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"invited_email" varchar(255) NOT NULL,
	"invited_user_id" varchar,
	"invited_by_user_id" varchar NOT NULL,
	"token" varchar(255) NOT NULL,
	"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp NOT NULL,
	"accepted_at" timestamp,
	"email_sent_at" timestamp,
	"email_failed" boolean DEFAULT false,
	"email_error" text,
	CONSTRAINT "organization_invites_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "organization_memberships" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "organization_role" DEFAULT 'member' NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "organizations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"slug" varchar,
	"domain" varchar,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"tenant_id" uuid NOT NULL,
	"created_by_user_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "organizations_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "password_reset_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "portal_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "portal_tokens_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "refresh_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"revoked" boolean DEFAULT false NOT NULL,
	"metadata" jsonb,
	"device_name" varchar(255),
	"ip_address" varchar(45),
	"location" varchar(255),
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sessions" (
	"sid" varchar PRIMARY KEY NOT NULL,
	"sess" jsonb NOT NULL,
	"expire" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE "team_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"team_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" varchar(50) DEFAULT 'member' NOT NULL,
	"joined_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "teams" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "tenant_domains" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"domain" text NOT NULL,
	"verified" boolean DEFAULT false,
	"verification_token" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "tenant_domains_domain_unique" UNIQUE("domain")
);
--> statement-breakpoint
CREATE TABLE "tenants" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar(255) NOT NULL,
	"billing_email" varchar(255),
	"plan" "tenant_plan" DEFAULT 'free' NOT NULL,
	"mfa_required" boolean DEFAULT false NOT NULL,
	"branding" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "trusted_devices" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"device_fingerprint" varchar(255) NOT NULL,
	"device_name" varchar(255),
	"trusted_until" timestamp NOT NULL,
	"ip_address" varchar(45),
	"location" varchar(255),
	"user_agent" text,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"last_used_at" timestamp,
	"revoked" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "user_credentials" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"password_hash" text NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "user_credentials_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "user_personalization_settings" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"reading_level" varchar DEFAULT 'standard' NOT NULL,
	"tone" varchar DEFAULT 'neutral' NOT NULL,
	"verbosity" varchar DEFAULT 'standard' NOT NULL,
	"language" varchar DEFAULT 'en' NOT NULL,
	"allow_adaptive_prompts" boolean DEFAULT true NOT NULL,
	"allow_ai_clarification" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "user_preferences" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"settings" jsonb DEFAULT '{"celebrationEffects":true,"darkMode":"system","aiHints":true}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "users" (
	"id" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"full_name" varchar(255),
	"first_name" varchar(255),
	"last_name" varchar(255),
	"profile_image_url" varchar(500),
	"tenant_id" uuid,
	"role" "user_role" DEFAULT 'creator' NOT NULL,
	"tenant_role" "user_tenant_role",
	"auth_provider" "auth_provider" DEFAULT 'local' NOT NULL,
	"default_mode" text DEFAULT 'easy' NOT NULL,
	"email_verified" boolean DEFAULT false NOT NULL,
	"mfa_enabled" boolean DEFAULT false NOT NULL,
	"last_password_change" timestamp,
	"is_placeholder" boolean DEFAULT false NOT NULL,
	"placeholder_email" varchar(255),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_invitations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"email" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"invited_by" varchar NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"joined_at" timestamp DEFAULT now(),
	"invited_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workspaces" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"slug" varchar NOT NULL,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"type" "block_type" NOT NULL,
	"phase" "block_phase" NOT NULL,
	"config" jsonb NOT NULL,
	"virtual_step_id" uuid,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_docs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid,
	"tenant_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"clock" integer NOT NULL,
	"state" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "collab_updates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"seq" integer NOT NULL,
	"update" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "document_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"final_block_document_id" varchar(255),
	"name" varchar(255) NOT NULL,
	"phase" "document_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 3000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "lifecycle_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar(255) NOT NULL,
	"phase" "lifecycle_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"virtual_step_ids" uuid[] DEFAULT '{}'::uuid[],
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"mutation_mode" boolean DEFAULT false,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "logic_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"condition_step_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_type" "logic_rule_target_type" NOT NULL,
	"target_step_id" uuid,
	"target_section_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "project_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "projects" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"name" varchar(255),
	"description" text,
	"creator_id" varchar NOT NULL,
	"tenant_id" uuid,
	"created_by" varchar,
	"owner_id" varchar NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"status" "project_status" DEFAULT 'active' NOT NULL,
	"archived" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"order" integer NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"visible_if" jsonb,
	"skip_if" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "steps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"section_id" uuid NOT NULL,
	"type" "step_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"alias" text,
	"default_value" jsonb,
	"order" integer NOT NULL,
	"is_virtual" boolean DEFAULT false NOT NULL,
	"visible_if" jsonb,
	"repeater_config" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"version_number" integer NOT NULL,
	"file_ref" varchar(500) NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"notes" text,
	"is_active" boolean DEFAULT true
);
--> statement-breakpoint
CREATE TABLE "templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"file_ref" varchar(500) NOT NULL,
	"type" "template_type" NOT NULL,
	"helpers_version" integer DEFAULT 1 NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"current_version" integer DEFAULT 1,
	"last_modified_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_key" varchar NOT NULL,
	"virtual_step_id" uuid,
	"phase" "block_phase" DEFAULT 'onSectionSubmit' NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_blueprints" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"creator_id" varchar NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"graph_json" jsonb NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"source_workflow_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"name" text NOT NULL,
	"values" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"workflow_version_id" uuid,
	"version_hash" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_id" uuid NOT NULL,
	"key" text NOT NULL,
	"is_primary" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"base_id" uuid,
	"version_number" integer DEFAULT 1 NOT NULL,
	"is_draft" boolean DEFAULT false NOT NULL,
	"graph_json" jsonb NOT NULL,
	"migration_info" jsonb,
	"changelog" jsonb,
	"notes" text,
	"checksum" text,
	"created_by" varchar NOT NULL,
	"published" boolean DEFAULT false NOT NULL,
	"published_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"description" text,
	"creator_id" varchar,
	"owner_id" varchar,
	"mode_override" text,
	"public_link" text,
	"name" varchar(255),
	"project_id" uuid,
	"current_version_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"slug" text,
	"require_login" boolean DEFAULT false NOT NULL,
	"intake_config" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"pinned_version_id" uuid,
	"status" "workflow_status" DEFAULT 'draft' NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"source_blueprint_id" uuid,
	CONSTRAINT "workflows_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "ai_workflow_feedback" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid,
	"user_id" varchar,
	"operation_type" varchar NOT NULL,
	"rating" integer NOT NULL,
	"comment" text,
	"ai_provider" varchar,
	"ai_model" varchar,
	"prompt_version" varchar,
	"quality_score" integer,
	"quality_passed" boolean,
	"issues_count" integer,
	"request_description" text,
	"generated_sections" integer,
	"generated_steps" integer,
	"was_edited" boolean DEFAULT false,
	"edit_count" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "block_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"block_id" varchar NOT NULL,
	"total_visits" integer DEFAULT 0,
	"avg_time_ms" integer DEFAULT 0,
	"dropoff_count" integer DEFAULT 0,
	"validation_error_count" integer DEFAULT 0,
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"run_id" uuid,
	"type" "metrics_event_type" NOT NULL,
	"ts" timestamp with time zone DEFAULT now() NOT NULL,
	"duration_ms" integer,
	"payload" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_rollups" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"bucket_start" timestamp with time zone NOT NULL,
	"bucket" "rollup_bucket" NOT NULL,
	"runs_count" integer DEFAULT 0 NOT NULL,
	"runs_success" integer DEFAULT 0 NOT NULL,
	"runs_error" integer DEFAULT 0 NOT NULL,
	"dur_p50" integer,
	"dur_p95" integer,
	"pdf_success" integer DEFAULT 0 NOT NULL,
	"pdf_error" integer DEFAULT 0 NOT NULL,
	"docx_success" integer DEFAULT 0 NOT NULL,
	"docx_error" integer DEFAULT 0 NOT NULL,
	"queue_enqueued" integer DEFAULT 0 NOT NULL,
	"queue_dequeued" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "review_tasks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"status" "review_task_status" DEFAULT 'pending' NOT NULL,
	"reviewer_id" varchar,
	"reviewer_email" varchar(255),
	"message" text,
	"comment" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"resolved_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "run_generated_documents" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"file_name" text NOT NULL,
	"file_url" text NOT NULL,
	"mime_type" text,
	"file_size" integer,
	"template_id" uuid,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"node_id" varchar(100),
	"level" "log_level" NOT NULL,
	"message" text NOT NULL,
	"context" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_outputs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_key" text NOT NULL,
	"file_type" "output_file_type" NOT NULL,
	"storage_path" text NOT NULL,
	"status" "output_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"input_json" jsonb,
	"output_refs" jsonb,
	"trace" jsonb,
	"status" "run_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"duration_ms" integer,
	"run_token" varchar,
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "script_execution_log" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"script_type" varchar(50) NOT NULL,
	"script_id" uuid NOT NULL,
	"script_name" varchar(255),
	"phase" varchar(50),
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "script_execution_status" NOT NULL,
	"error_message" text,
	"console_output" jsonb,
	"input_sample" jsonb,
	"output_sample" jsonb,
	"duration_ms" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "signature_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"signature_request_id" uuid NOT NULL,
	"type" "signature_event_type" NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb
);
--> statement-breakpoint
CREATE TABLE "signature_requests" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"signer_email" varchar(255) NOT NULL,
	"signer_name" varchar(255),
	"status" "signature_request_status" DEFAULT 'pending' NOT NULL,
	"provider" "signature_provider" DEFAULT 'native' NOT NULL,
	"provider_request_id" text,
	"token" text NOT NULL,
	"document_url" text,
	"redirect_url" text,
	"message" text,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"signed_at" timestamp,
	CONSTRAINT "signature_requests_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "sli_configs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"target_success_pct" integer DEFAULT 99 NOT NULL,
	"target_p95_ms" integer DEFAULT 5000 NOT NULL,
	"error_budget_pct" integer DEFAULT 1 NOT NULL,
	"window" "sli_window" DEFAULT '7d' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sli_windows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"window_start" timestamp with time zone NOT NULL,
	"window_end" timestamp with time zone NOT NULL,
	"success_pct" integer,
	"p95_ms" integer,
	"error_budget_burn_pct" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "step_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"step_id" uuid NOT NULL,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_generation_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"run_id" uuid,
	"result" varchar(50) NOT NULL,
	"duration_ms" integer,
	"error_message" text,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_block_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"block_id" uuid NOT NULL,
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "transform_block_run_status" NOT NULL,
	"error_message" text,
	"output_sample" jsonb
);
--> statement-breakpoint
CREATE TABLE "workflow_analytics_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"date" timestamp NOT NULL,
	"summary" jsonb NOT NULL,
	"dropoff" jsonb NOT NULL,
	"branching" jsonb NOT NULL,
	"heatmap" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_run_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"block_id" varchar,
	"page_id" uuid,
	"type" varchar NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb,
	"is_preview" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_run_metrics" (
	"run_id" uuid PRIMARY KEY NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"total_time_ms" integer,
	"pages_visited" integer DEFAULT 0,
	"blocks_visited" integer DEFAULT 0,
	"validation_errors" integer DEFAULT 0,
	"script_errors" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"is_preview" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"workflow_version_id" uuid,
	"run_token" text NOT NULL,
	"created_by" text,
	"current_section_id" uuid,
	"progress" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"metadata" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"client_email" varchar,
	"portal_access_key" varchar,
	"access_mode" "portal_access_mode" DEFAULT 'anonymous',
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"owner_type" varchar(50),
	"owner_uuid" uuid,
	CONSTRAINT "workflow_runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "workflow_runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "analytics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"survey_id" uuid NOT NULL,
	"page_id" uuid,
	"question_id" uuid,
	"event" varchar NOT NULL,
	"data" jsonb,
	"duration" integer,
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "anonymous_response_tracking" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"ip_address" varchar NOT NULL,
	"session_id" varchar,
	"response_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "answers" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"question_id" uuid NOT NULL,
	"subquestion_id" uuid,
	"loop_index" integer,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "conditional_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"condition_question_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_question_id" uuid,
	"target_page_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_queue" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"to" varchar NOT NULL,
	"subject" varchar NOT NULL,
	"html" text NOT NULL,
	"status" "email_queue_status" DEFAULT 'pending' NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_error" text,
	"next_attempt_at" timestamp DEFAULT now(),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "files" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"answer_id" uuid NOT NULL,
	"filename" varchar NOT NULL,
	"original_name" varchar NOT NULL,
	"mime_type" varchar NOT NULL,
	"size" integer NOT NULL,
	"uploaded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "loop_group_subquestions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"loop_question_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "questions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"page_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"conditional_logic" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "responses" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"completed" boolean DEFAULT false,
	"submitted_at" timestamp,
	"is_anonymous" boolean DEFAULT false,
	"ip_address" varchar,
	"user_agent" text,
	"session_id" varchar,
	"anonymous_metadata" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_pages" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" text NOT NULL,
	"description" text,
	"content" jsonb NOT NULL,
	"creator_id" varchar,
	"is_system" boolean DEFAULT false NOT NULL,
	"tags" text[] DEFAULT ARRAY[]::text[],
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "surveys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"creator_id" varchar NOT NULL,
	"workspace_id" uuid,
	"status" "survey_status" DEFAULT 'draft' NOT NULL,
	"allow_anonymous" boolean DEFAULT false,
	"anonymous_access_type" "anonymous_access_type" DEFAULT 'unlimited',
	"public_link" varchar,
	"anonymous_config" jsonb,
	"is_public" boolean DEFAULT false,
	"public_access_mode" "public_access_mode" DEFAULT 'link_only',
	"public_slug" varchar,
	"allowed_domains" jsonb,
	"public_settings" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "surveys_public_link_unique" UNIQUE("public_link"),
	CONSTRAINT "surveys_public_slug_unique" UNIQUE("public_slug")
);
--> statement-breakpoint
CREATE TABLE "template_shares" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"user_id" varchar,
	"pending_email" text,
	"access" "template_access" DEFAULT 'use' NOT NULL,
	"invited_at" timestamp with time zone DEFAULT now(),
	"accepted_at" timestamp with time zone
);
--> statement-breakpoint
CREATE TABLE "collection_fields" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"collection_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"type" varchar(50) NOT NULL,
	"options" jsonb,
	"required" boolean DEFAULT false,
	"order" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_api_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"database_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"label" text NOT NULL,
	"token_hash" text NOT NULL,
	"scopes" text[] DEFAULT ARRAY[]::text[] NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "datavault_columns" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"type" "datavault_column_type" NOT NULL,
	"description" text,
	"width_px" integer DEFAULT 150,
	"required" boolean DEFAULT false NOT NULL,
	"is_primary_key" boolean DEFAULT false NOT NULL,
	"is_unique" boolean DEFAULT false NOT NULL,
	"order_index" integer DEFAULT 0 NOT NULL,
	"auto_number_start" integer DEFAULT 1,
	"autonumber_prefix" text,
	"autonumber_padding" integer DEFAULT 4,
	"autonumber_reset_policy" "autonumber_reset_policy" DEFAULT 'never',
	"reference_table_id" uuid,
	"reference_display_column_slug" text,
	"options" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_databases" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"type" "data_source_type" DEFAULT 'native' NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"scope_type" "datavault_scope_type" DEFAULT 'account' NOT NULL,
	"scope_id" uuid,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_number_sequences" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"prefix" text,
	"padding" integer DEFAULT 4 NOT NULL,
	"next_value" integer DEFAULT 1 NOT NULL,
	"reset_policy" "autonumber_reset_policy" DEFAULT 'never' NOT NULL,
	"last_reset" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_row_notes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"text" text NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_rows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"deleted_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "datavault_table_permissions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "datavault_table_role" NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_tables" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"owner_user_id" varchar,
	"database_id" uuid,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"value" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_writeback_mappings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_mappings" jsonb NOT NULL,
	"trigger_phase" varchar(50) DEFAULT 'afterComplete' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar
);
--> statement-breakpoint
CREATE TABLE "records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"collection_id" uuid NOT NULL,
	"data" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workflow_data_sources" (
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "workflow_data_sources_workflow_id_data_source_id_pk" PRIMARY KEY("workflow_id","data_source_id")
);
--> statement-breakpoint
CREATE TABLE "workflow_queries" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"filters" jsonb DEFAULT '[]'::jsonb,
	"sort" jsonb DEFAULT '[]'::jsonb,
	"limit" integer,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "api_keys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"prefix" varchar(50) NOT NULL,
	"key_hash" varchar(255) NOT NULL,
	"scopes" text[] NOT NULL,
	"name" varchar NOT NULL,
	"expires_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "api_keys_key_hash_unique" UNIQUE("key_hash")
);
--> statement-breakpoint
CREATE TABLE "connections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"type" "connection_type" NOT NULL,
	"base_url" varchar(500),
	"auth_config" jsonb DEFAULT '{}'::jsonb,
	"secret_refs" jsonb DEFAULT '{}'::jsonb,
	"oauth_state" jsonb,
	"default_headers" jsonb DEFAULT '{}'::jsonb,
	"timeout_ms" integer DEFAULT 8000,
	"retries" integer DEFAULT 2,
	"backoff_ms" integer DEFAULT 250,
	"enabled" boolean DEFAULT true NOT NULL,
	"last_tested_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "external_destinations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"config" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "oauth_access_tokens" (
	"access_token" varchar PRIMARY KEY NOT NULL,
	"refresh_token" varchar,
	"client_id" varchar NOT NULL,
	"user_id" varchar,
	"workspace_id" uuid NOT NULL,
	"scope" jsonb,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_access_tokens_refresh_token_unique" UNIQUE("refresh_token")
);
--> statement-breakpoint
CREATE TABLE "oauth_apps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"client_id" varchar NOT NULL,
	"client_secret_hash" varchar NOT NULL,
	"redirect_uris" jsonb NOT NULL,
	"scopes" jsonb NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_apps_client_id_unique" UNIQUE("client_id")
);
--> statement-breakpoint
CREATE TABLE "oauth_auth_codes" (
	"code" varchar PRIMARY KEY NOT NULL,
	"client_id" varchar NOT NULL,
	"user_id" varchar NOT NULL,
	"scope" jsonb,
	"redirect_uri" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"key" varchar NOT NULL,
	"value" text,
	"value_enc" text NOT NULL,
	"type" "secret_type" DEFAULT 'api_key' NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"environment" varchar DEFAULT 'production',
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"event" varchar NOT NULL,
	"payload" jsonb NOT NULL,
	"status" varchar NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_attempt_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"target_url" varchar NOT NULL,
	"events" jsonb NOT NULL,
	"secret" varchar NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "billing_plans" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"price_monthly" integer DEFAULT 0 NOT NULL,
	"price_yearly" integer DEFAULT 0 NOT NULL,
	"features" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"limits" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"stripe_product_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "customer_billing_info" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"stripe_customer_id" varchar NOT NULL,
	"billing_email" varchar,
	"default_payment_method_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscription_seats" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"assigned_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"plan_id" uuid NOT NULL,
	"status" "subscription_status" DEFAULT 'active' NOT NULL,
	"stripe_subscription_id" varchar,
	"current_period_start" timestamp,
	"current_period_end" timestamp,
	"cancel_at_period_end" boolean DEFAULT false,
	"canceled_at" timestamp,
	"trial_start" timestamp,
	"trial_end" timestamp,
	"seat_quantity" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "usage_records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"metric" varchar NOT NULL,
	"quantity" integer DEFAULT 1 NOT NULL,
	"workflow_id" uuid,
	"metadata" jsonb,
	"recorded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_template_metadata" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_key" varchar(255) NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"subject_preview" text,
	"branding_tokens" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "email_template_metadata_template_key_unique" UNIQUE("template_key")
);
--> statement-breakpoint
CREATE TABLE "ai_settings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"scope" varchar DEFAULT 'global' NOT NULL,
	"system_prompt" text,
	"updated_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
ALTER TABLE "account_locks" ADD CONSTRAINT "account_locks_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "email_verification_tokens" ADD CONSTRAINT "email_verification_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_backup_codes" ADD CONSTRAINT "mfa_backup_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_secrets" ADD CONSTRAINT "mfa_secrets_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_user_id_users_id_fk" FOREIGN KEY ("invited_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_by_user_id_users_id_fk" FOREIGN KEY ("invited_by_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_created_by_user_id_users_id_fk" FOREIGN KEY ("created_by_user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "password_reset_tokens" ADD CONSTRAINT "password_reset_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "refresh_tokens" ADD CONSTRAINT "refresh_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_team_id_teams_id_fk" FOREIGN KEY ("team_id") REFERENCES "public"."teams"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "teams" ADD CONSTRAINT "teams_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "tenant_domains" ADD CONSTRAINT "tenant_domains_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "trusted_devices" ADD CONSTRAINT "trusted_devices_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_credentials" ADD CONSTRAINT "user_credentials_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_personalization_settings" ADD CONSTRAINT "user_personalization_settings_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_preferences" ADD CONSTRAINT "user_preferences_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "users" ADD CONSTRAINT "users_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspaces" ADD CONSTRAINT "workspaces_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_snapshots" ADD CONSTRAINT "collab_snapshots_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_updates" ADD CONSTRAINT "collab_updates_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "document_hooks" ADD CONSTRAINT "document_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_condition_step_id_steps_id_fk" FOREIGN KEY ("condition_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_step_id_steps_id_fk" FOREIGN KEY ("target_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_section_id_sections_id_fk" FOREIGN KEY ("target_section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "project_access" ADD CONSTRAINT "project_access_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sections" ADD CONSTRAINT "sections_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "steps" ADD CONSTRAINT "steps_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_last_modified_by_users_id_fk" FOREIGN KEY ("last_modified_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_access" ADD CONSTRAINT "workflow_access_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_source_workflow_id_workflows_id_fk" FOREIGN KEY ("source_workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_base_id_workflows_id_fk" FOREIGN KEY ("base_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_reviewer_id_users_id_fk" FOREIGN KEY ("reviewer_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_template_id_workflow_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."workflow_templates"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_logs" ADD CONSTRAINT "run_logs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "script_execution_log" ADD CONSTRAINT "script_execution_log_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_events" ADD CONSTRAINT "signature_events_signature_request_id_signature_requests_id_fk" FOREIGN KEY ("signature_request_id") REFERENCES "public"."signature_requests"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_step_id_steps_id_fk" FOREIGN KEY ("step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_block_id_transform_blocks_id_fk" FOREIGN KEY ("block_id") REFERENCES "public"."transform_blocks"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_current_section_id_sections_id_fk" FOREIGN KEY ("current_section_id") REFERENCES "public"."sections"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_subquestion_id_loop_group_subquestions_id_fk" FOREIGN KEY ("subquestion_id") REFERENCES "public"."loop_group_subquestions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_condition_question_id_questions_id_fk" FOREIGN KEY ("condition_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_question_id_questions_id_fk" FOREIGN KEY ("target_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_page_id_survey_pages_id_fk" FOREIGN KEY ("target_page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "files" ADD CONSTRAINT "files_answer_id_answers_id_fk" FOREIGN KEY ("answer_id") REFERENCES "public"."answers"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "loop_group_subquestions" ADD CONSTRAINT "loop_group_subquestions_loop_question_id_questions_id_fk" FOREIGN KEY ("loop_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "questions" ADD CONSTRAINT "questions_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "responses" ADD CONSTRAINT "responses_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_pages" ADD CONSTRAINT "survey_pages_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_templates" ADD CONSTRAINT "survey_templates_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_template_id_survey_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."survey_templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collection_fields" ADD CONSTRAINT "collection_fields_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collections" ADD CONSTRAINT "collections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_columns" ADD CONSTRAINT "datavault_columns_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_databases" ADD CONSTRAINT "datavault_databases_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_owner_user_id_users_id_fk" FOREIGN KEY ("owner_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "api_keys" ADD CONSTRAINT "api_keys_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "external_destinations" ADD CONSTRAINT "external_destinations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_apps" ADD CONSTRAINT "oauth_apps_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "secrets" ADD CONSTRAINT "secrets_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_events" ADD CONSTRAINT "webhook_events_subscription_id_webhook_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."webhook_subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_subscriptions" ADD CONSTRAINT "webhook_subscriptions_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "customer_billing_info" ADD CONSTRAINT "customer_billing_info_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_subscription_id_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_plan_id_billing_plans_id_fk" FOREIGN KEY ("plan_id") REFERENCES "public"."billing_plans"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_settings" ADD CONSTRAINT "ai_settings_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
CREATE INDEX "account_locks_user_idx" ON "account_locks" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "account_locks_until_idx" ON "account_locks" USING btree ("locked_until");--> statement-breakpoint
CREATE INDEX "audit_logs_tenant_idx" ON "audit_logs" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "audit_logs_user_idx" ON "audit_logs" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "audit_logs_action_idx" ON "audit_logs" USING btree ("action");--> statement-breakpoint
CREATE INDEX "email_verify_token_idx" ON "email_verification_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "email_verify_user_idx" ON "email_verification_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "login_attempts_email_idx" ON "login_attempts" USING btree ("email");--> statement-breakpoint
CREATE INDEX "login_attempts_timestamp_idx" ON "login_attempts" USING btree ("attempted_at");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_user_idx" ON "mfa_backup_codes" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_hash_idx" ON "mfa_backup_codes" USING btree ("code_hash");--> statement-breakpoint
CREATE INDEX "mfa_secrets_user_idx" ON "mfa_secrets" USING btree ("user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "org_invites_token_unique_idx" ON "organization_invites" USING btree ("token");--> statement-breakpoint
CREATE INDEX "idx_org_invites_org_email_status" ON "organization_invites" USING btree ("org_id","invited_email","status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_status" ON "organization_invites" USING btree ("status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_expires" ON "organization_invites" USING btree ("expires_at");--> statement-breakpoint
CREATE UNIQUE INDEX "org_membership_unique_idx" ON "organization_memberships" USING btree ("org_id","user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_org" ON "organization_memberships" USING btree ("org_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_user" ON "organization_memberships" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_role" ON "organization_memberships" USING btree ("role");--> statement-breakpoint
CREATE INDEX "idx_organizations_created_by" ON "organizations" USING btree ("created_by_user_id");--> statement-breakpoint
CREATE INDEX "idx_organizations_tenant" ON "organizations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "pwd_reset_token_idx" ON "password_reset_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "pwd_reset_user_idx" ON "password_reset_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_user_idx" ON "refresh_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_token_idx" ON "refresh_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "IDX_session_expire" ON "sessions" USING btree ("expire");--> statement-breakpoint
CREATE UNIQUE INDEX "team_members_idx" ON "team_members" USING btree ("team_id","user_id");--> statement-breakpoint
CREATE INDEX "teams_tenant_idx" ON "teams" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_tenant_idx" ON "tenant_domains" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_domain_idx" ON "tenant_domains" USING btree ("domain");--> statement-breakpoint
CREATE INDEX "tenants_plan_idx" ON "tenants" USING btree ("plan");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_idx" ON "trusted_devices" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "trusted_devices_fingerprint_idx" ON "trusted_devices" USING btree ("device_fingerprint");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_fingerprint_idx" ON "trusted_devices" USING btree ("user_id","device_fingerprint");--> statement-breakpoint
CREATE INDEX "user_credentials_user_idx" ON "user_credentials" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "users_email_idx" ON "users" USING btree ("email");--> statement-breakpoint
CREATE INDEX "users_tenant_idx" ON "users" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "users_tenant_email_idx" ON "users" USING btree ("tenant_id","email");--> statement-breakpoint
CREATE INDEX "idx_users_is_placeholder" ON "users" USING btree ("is_placeholder");--> statement-breakpoint
CREATE INDEX "idx_users_placeholder_email" ON "users" USING btree ("placeholder_email");--> statement-breakpoint
CREATE INDEX "invitation_token_idx" ON "workspace_invitations" USING btree ("token");--> statement-breakpoint
CREATE INDEX "invitation_ws_email_idx" ON "workspace_invitations" USING btree ("workspace_id","email");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_member_idx" ON "workspace_members" USING btree ("workspace_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_org_slug_idx" ON "workspaces" USING btree ("organization_id","slug");--> statement-breakpoint
CREATE INDEX "blocks_workflow_phase_order_idx" ON "blocks" USING btree ("workflow_id","phase","order");--> statement-breakpoint
CREATE INDEX "collab_docs_workflow_idx" ON "collab_docs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "collab_snapshots_doc_clock_idx" ON "collab_snapshots" USING btree ("doc_id","clock");--> statement-breakpoint
CREATE INDEX "collab_updates_doc_seq_idx" ON "collab_updates" USING btree ("doc_id","seq");--> statement-breakpoint
CREATE INDEX "logic_rules_workflow_idx" ON "logic_rules" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "project_access_project_idx" ON "project_access" USING btree ("project_id");--> statement-breakpoint
CREATE UNIQUE INDEX "project_access_principal_idx" ON "project_access" USING btree ("project_id","principal_type","principal_id");--> statement-breakpoint
CREATE INDEX "projects_tenant_idx" ON "projects" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "projects_created_by_idx" ON "projects" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "projects_creator_idx" ON "projects" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "projects_owner_idx" ON "projects" USING btree ("owner_id");--> statement-breakpoint
CREATE INDEX "idx_projects_owner" ON "projects" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "projects_status_idx" ON "projects" USING btree ("status");--> statement-breakpoint
CREATE INDEX "projects_archived_idx" ON "projects" USING btree ("archived");--> statement-breakpoint
CREATE INDEX "sections_workflow_idx" ON "sections" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "steps_section_idx" ON "steps" USING btree ("section_id");--> statement-breakpoint
CREATE UNIQUE INDEX "template_versions_unique_idx" ON "template_versions" USING btree ("template_id","version_number");--> statement-breakpoint
CREATE INDEX "templates_project_idx" ON "templates" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflow_access_workflow_idx" ON "workflow_access" USING btree ("workflow_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_access_principal_idx" ON "workflow_access" USING btree ("workflow_id","principal_type","principal_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_snapshots_workflow_name_unique" ON "workflow_snapshots" USING btree ("workflow_id","name");--> statement-breakpoint
CREATE INDEX "workflow_templates_version_key_unique" ON "workflow_templates" USING btree ("workflow_version_id","key");--> statement-breakpoint
CREATE INDEX "workflow_versions_workflow_idx" ON "workflow_versions" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_versions_version_number_idx" ON "workflow_versions" USING btree ("workflow_id","version_number");--> statement-breakpoint
CREATE INDEX "workflow_versions_is_draft_idx" ON "workflow_versions" USING btree ("is_draft");--> statement-breakpoint
CREATE INDEX "workflows_project_idx" ON "workflows" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflows_status_idx" ON "workflows" USING btree ("status");--> statement-breakpoint
CREATE INDEX "workflows_is_public_idx" ON "workflows" USING btree ("is_public");--> statement-breakpoint
CREATE INDEX "workflows_slug_idx" ON "workflows" USING btree ("slug");--> statement-breakpoint
CREATE INDEX "workflows_pinned_version_idx" ON "workflows" USING btree ("pinned_version_id");--> statement-breakpoint
CREATE INDEX "idx_workflows_owner" ON "workflows" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "ai_feedback_workflow_idx" ON "ai_workflow_feedback" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "bm_version_block_idx" ON "block_metrics" USING btree ("version_id","block_id");--> statement-breakpoint
CREATE INDEX "metrics_events_project_ts_idx" ON "metrics_events" USING btree ("project_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_workflow_ts_idx" ON "metrics_events" USING btree ("workflow_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_type_idx" ON "metrics_events" USING btree ("type");--> statement-breakpoint
CREATE UNIQUE INDEX "metrics_rollups_unique_idx" ON "metrics_rollups" USING btree ("tenant_id","project_id",COALESCE("workflow_id", '00000000-0000-0000-0000-000000000000'::uuid),"bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "metrics_rollups_project_bucket_idx" ON "metrics_rollups" USING btree ("project_id","bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "review_tasks_run_idx" ON "review_tasks" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "review_tasks_workflow_idx" ON "review_tasks" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "review_tasks_status_idx" ON "review_tasks" USING btree ("status");--> statement-breakpoint
CREATE INDEX "review_tasks_reviewer_idx" ON "review_tasks" USING btree ("reviewer_id");--> statement-breakpoint
CREATE INDEX "run_generated_documents_run_idx" ON "run_generated_documents" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_run_idx" ON "run_logs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_level_idx" ON "run_logs" USING btree ("level");--> statement-breakpoint
CREATE INDEX "run_logs_created_at_idx" ON "run_logs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "run_outputs_run_idx" ON "run_outputs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_outputs_run_template_type_idx" ON "run_outputs" USING btree ("run_id","template_key","file_type");--> statement-breakpoint
CREATE INDEX "runs_workflow_version_idx" ON "runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "runs_status_idx" ON "runs" USING btree ("status");--> statement-breakpoint
CREATE INDEX "runs_created_by_idx" ON "runs" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "runs_created_at_idx" ON "runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "script_execution_log_run_idx" ON "script_execution_log" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_events_request_idx" ON "signature_events" USING btree ("signature_request_id");--> statement-breakpoint
CREATE INDEX "signature_requests_run_idx" ON "signature_requests" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_requests_token_idx" ON "signature_requests" USING btree ("token");--> statement-breakpoint
CREATE INDEX "sli_configs_project_idx" ON "sli_configs" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "sli_windows_project_window_idx" ON "sli_windows" USING btree ("project_id","window_start","window_end");--> statement-breakpoint
CREATE INDEX "step_values_run_idx" ON "step_values" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "step_values_step_idx" ON "step_values" USING btree ("step_id");--> statement-breakpoint
CREATE INDEX "step_values_run_step_idx" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE UNIQUE INDEX "step_values_run_step_unique" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE INDEX "template_metrics_template_idx" ON "template_generation_metrics" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_metrics_run_idx" ON "template_generation_metrics" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_run_idx" ON "transform_block_runs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_block_idx" ON "transform_block_runs" USING btree ("block_id");--> statement-breakpoint
CREATE UNIQUE INDEX "was_workflow_version_date_idx" ON "workflow_analytics_snapshots" USING btree ("workflow_id","version_id","date");--> statement-breakpoint
CREATE INDEX "wre_run_idx" ON "workflow_run_events" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "wre_workflow_ts_idx" ON "workflow_run_events" USING btree ("workflow_id","timestamp");--> statement-breakpoint
CREATE INDEX "wrm_workflow_created_idx" ON "workflow_run_metrics" USING btree ("workflow_id","created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_workflow_idx" ON "workflow_runs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_version_idx" ON "workflow_runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_completed_idx" ON "workflow_runs" USING btree ("completed");--> statement-breakpoint
CREATE INDEX "workflow_runs_run_token_idx" ON "workflow_runs" USING btree ("run_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_share_token_idx" ON "workflow_runs" USING btree ("share_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_current_section_idx" ON "workflow_runs" USING btree ("current_section_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_created_at_idx" ON "workflow_runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_owner_idx" ON "workflow_runs" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "analytics_survey_event_idx" ON "analytics_events" USING btree ("survey_id","event");--> statement-breakpoint
CREATE INDEX "analytics_response_event_idx" ON "analytics_events" USING btree ("response_id","event");--> statement-breakpoint
CREATE INDEX "analytics_timestamp_idx" ON "analytics_events" USING btree ("timestamp");--> statement-breakpoint
CREATE INDEX "anonymous_tracking_survey_ip_idx" ON "anonymous_response_tracking" USING btree ("survey_id","ip_address");--> statement-breakpoint
CREATE INDEX "email_queue_status_idx" ON "email_queue" USING btree ("status");--> statement-breakpoint
CREATE INDEX "email_queue_next_attempt_idx" ON "email_queue" USING btree ("next_attempt_at");--> statement-breakpoint
CREATE INDEX "survey_templates_creator_idx" ON "survey_templates" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "survey_templates_system_idx" ON "survey_templates" USING btree ("is_system");--> statement-breakpoint
CREATE INDEX "surveys_public_link_unique_idx" ON "surveys" USING btree ("public_link");--> statement-breakpoint
CREATE INDEX "surveys_workspace_idx" ON "surveys" USING btree ("workspace_id");--> statement-breakpoint
CREATE INDEX "template_shares_template_idx" ON "template_shares" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_shares_user_idx" ON "template_shares" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "template_shares_pending_email_idx" ON "template_shares" USING btree ("pending_email");--> statement-breakpoint
CREATE INDEX "collection_fields_collection_idx" ON "collection_fields" USING btree ("collection_id");--> statement-breakpoint
CREATE UNIQUE INDEX "collection_fields_slug_unique" ON "collection_fields" USING btree ("collection_id","slug");--> statement-breakpoint
CREATE UNIQUE INDEX "collections_slug_unique" ON "collections" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_database_id" ON "datavault_api_tokens" USING btree ("database_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE INDEX "datavault_columns_table_idx" ON "datavault_columns" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_columns_reference_table_idx" ON "datavault_columns" USING btree ("reference_table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_columns_table_slug_unique" ON "datavault_columns" USING btree ("table_id","slug");--> statement-breakpoint
CREATE INDEX "idx_databases_tenant" ON "datavault_databases" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_databases_scope" ON "datavault_databases" USING btree ("scope_type","scope_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_databases_owner" ON "datavault_databases" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_tenant" ON "datavault_number_sequences" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_table" ON "datavault_number_sequences" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "idx_datavault_sequences_column_unique" ON "datavault_number_sequences" USING btree ("tenant_id","table_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_row_id" ON "datavault_row_notes" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_tenant_id" ON "datavault_row_notes" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_table_idx" ON "datavault_rows" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_created_by_idx" ON "datavault_rows" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "idx_table_permissions_table" ON "datavault_table_permissions" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_table_user_permission" ON "datavault_table_permissions" USING btree ("table_id","user_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_tenant_idx" ON "datavault_tables" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_owner_idx" ON "datavault_tables" USING btree ("owner_user_id");--> statement-breakpoint
CREATE INDEX "idx_tables_database" ON "datavault_tables" USING btree ("database_id","tenant_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_tables_tenant_slug_unique" ON "datavault_tables" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "datavault_values_row_idx" ON "datavault_values" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "datavault_values_column_idx" ON "datavault_values" USING btree ("column_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_values_row_column_unique" ON "datavault_values" USING btree ("row_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_writeback_mappings_workflow" ON "datavault_writeback_mappings" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "records_collection_idx" ON "records" USING btree ("collection_id");--> statement-breakpoint
CREATE INDEX "records_tenant_idx" ON "records" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_data_sources_workflow" ON "workflow_data_sources" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_queries_workflow" ON "workflow_queries" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "api_keys_project_idx" ON "api_keys" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_tenant_idx" ON "connections" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "connections_project_idx" ON "connections" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_project_name_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "connections_type_idx" ON "connections" USING btree ("type");--> statement-breakpoint
CREATE INDEX "connections_enabled_idx" ON "connections" USING btree ("enabled");--> statement-breakpoint
CREATE UNIQUE INDEX "connections_project_name_unique_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "ext_dest_tenant_idx" ON "external_destinations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_client_id_idx" ON "oauth_apps" USING btree ("client_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_workspace_idx" ON "oauth_apps" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "secrets_project_key_env_unique" ON "secrets" USING btree ("project_id","key","environment");--> statement-breakpoint
CREATE INDEX "webhook_events_sub_idx" ON "webhook_events" USING btree ("subscription_id");--> statement-breakpoint
CREATE INDEX "webhook_subs_workspace_idx" ON "webhook_subscriptions" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_org_idx" ON "customer_billing_info" USING btree ("organization_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_stripe_idx" ON "customer_billing_info" USING btree ("stripe_customer_id");--> statement-breakpoint
CREATE UNIQUE INDEX "seat_sub_user_idx" ON "subscription_seats" USING btree ("subscription_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "sub_org_idx" ON "subscriptions" USING btree ("organization_id");--> statement-breakpoint
CREATE INDEX "usage_org_metric_date_idx" ON "usage_records" USING btree ("organization_id","metric","recorded_at");--> statement-breakpoint
CREATE INDEX "email_templates_key_idx" ON "email_template_metadata" USING btree ("template_key");--> statement-breakpoint
CREATE INDEX "ai_settings_scope_idx" ON "ai_settings" USING btree ("scope");
params: 
ΓÜá∩╕Å Migrations failed (non-fatal if DB exists): DrizzleQueryError: Failed query: CREATE TYPE "public"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint
CREATE TYPE "public"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint
CREATE TYPE "public"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint
CREATE TYPE "public"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint
CREATE TYPE "public"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint
CREATE TYPE "public"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint
CREATE TYPE "public"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint
CREATE TYPE "public"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint
CREATE TYPE "public"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint
CREATE TYPE "public"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint
CREATE TYPE "public"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint
CREATE TYPE "public"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint
CREATE TYPE "public"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint
CREATE TYPE "public"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint
CREATE TYPE "public"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint
CREATE TYPE "public"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint
CREATE TYPE "public"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint
CREATE TYPE "public"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint
CREATE TYPE "public"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint
CREATE TYPE "public"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint
CREATE TYPE "public"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint
CREATE TYPE "public"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint
CREATE TYPE "public"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint
CREATE TYPE "public"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint
CREATE TYPE "public"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint
CREATE TYPE "public"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint
CREATE TYPE "public"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint
CREATE TYPE "public"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint
CREATE TYPE "public"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint
CREATE TYPE "public"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint
CREATE TYPE "public"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint
CREATE TYPE "public"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint
CREATE TYPE "public"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint
CREATE TYPE "public"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint
CREATE TYPE "public"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint
CREATE TYPE "public"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint
CREATE TYPE "public"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint
CREATE TYPE "public"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint
CREATE TYPE "public"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint
CREATE TYPE "public"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint
CREATE TYPE "public"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint
CREATE TYPE "public"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint
CREATE TYPE "public"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint
CREATE TYPE "public"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint
CREATE TABLE "account_locks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"locked_at" timestamp DEFAULT now() NOT NULL,
	"locked_until" timestamp NOT NULL,
	"reason" varchar(255),
	"unlocked" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "audit_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"workspace_id" uuid,
	"user_id" varchar,
	"action" varchar NOT NULL,
	"entity_type" varchar NOT NULL,
	"entity_id" varchar NOT NULL,
	"resource_type" varchar,
	"resource_id" varchar,
	"changes" jsonb,
	"details" jsonb,
	"ip_address" varchar,
	"user_agent" text,
	"created_at" timestamp DEFAULT now(),
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_verification_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "login_attempts" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"ip_address" varchar(45),
	"successful" boolean DEFAULT false NOT NULL,
	"attempted_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_backup_codes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"code_hash" text NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"secret" text NOT NULL,
	"enabled" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"enabled_at" timestamp,
	CONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "organization_invites" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"invited_email" varchar(255) NOT NULL,
	"invited_user_id" varchar,
	"invited_by_user_id" varchar NOT NULL,
	"token" varchar(255) NOT NULL,
	"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp NOT NULL,
	"accepted_at" timestamp,
	"email_sent_at" timestamp,
	"email_failed" boolean DEFAULT false,
	"email_error" text,
	CONSTRAINT "organization_invites_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "organization_memberships" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "organization_role" DEFAULT 'member' NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "organizations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"slug" varchar,
	"domain" varchar,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"tenant_id" uuid NOT NULL,
	"created_by_user_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "organizations_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "password_reset_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "portal_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "portal_tokens_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "refresh_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"revoked" boolean DEFAULT false NOT NULL,
	"metadata" jsonb,
	"device_name" varchar(255),
	"ip_address" varchar(45),
	"location" varchar(255),
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sessions" (
	"sid" varchar PRIMARY KEY NOT NULL,
	"sess" jsonb NOT NULL,
	"expire" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE "team_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"team_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" varchar(50) DEFAULT 'member' NOT NULL,
	"joined_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "teams" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "tenant_domains" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"domain" text NOT NULL,
	"verified" boolean DEFAULT false,
	"verification_token" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "tenant_domains_domain_unique" UNIQUE("domain")
);
--> statement-breakpoint
CREATE TABLE "tenants" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar(255) NOT NULL,
	"billing_email" varchar(255),
	"plan" "tenant_plan" DEFAULT 'free' NOT NULL,
	"mfa_required" boolean DEFAULT false NOT NULL,
	"branding" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "trusted_devices" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"device_fingerprint" varchar(255) NOT NULL,
	"device_name" varchar(255),
	"trusted_until" timestamp NOT NULL,
	"ip_address" varchar(45),
	"location" varchar(255),
	"user_agent" text,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"last_used_at" timestamp,
	"revoked" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "user_credentials" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"password_hash" text NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "user_credentials_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "user_personalization_settings" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"reading_level" varchar DEFAULT 'standard' NOT NULL,
	"tone" varchar DEFAULT 'neutral' NOT NULL,
	"verbosity" varchar DEFAULT 'standard' NOT NULL,
	"language" varchar DEFAULT 'en' NOT NULL,
	"allow_adaptive_prompts" boolean DEFAULT true NOT NULL,
	"allow_ai_clarification" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "user_preferences" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"settings" jsonb DEFAULT '{"celebrationEffects":true,"darkMode":"system","aiHints":true}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "users" (
	"id" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"full_name" varchar(255),
	"first_name" varchar(255),
	"last_name" varchar(255),
	"profile_image_url" varchar(500),
	"tenant_id" uuid,
	"role" "user_role" DEFAULT 'creator' NOT NULL,
	"tenant_role" "user_tenant_role",
	"auth_provider" "auth_provider" DEFAULT 'local' NOT NULL,
	"default_mode" text DEFAULT 'easy' NOT NULL,
	"email_verified" boolean DEFAULT false NOT NULL,
	"mfa_enabled" boolean DEFAULT false NOT NULL,
	"last_password_change" timestamp,
	"is_placeholder" boolean DEFAULT false NOT NULL,
	"placeholder_email" varchar(255),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_invitations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"email" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"invited_by" varchar NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"joined_at" timestamp DEFAULT now(),
	"invited_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workspaces" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"slug" varchar NOT NULL,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"type" "block_type" NOT NULL,
	"phase" "block_phase" NOT NULL,
	"config" jsonb NOT NULL,
	"virtual_step_id" uuid,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_docs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid,
	"tenant_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"clock" integer NOT NULL,
	"state" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "collab_updates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"seq" integer NOT NULL,
	"update" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "document_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"final_block_document_id" varchar(255),
	"name" varchar(255) NOT NULL,
	"phase" "document_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 3000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "lifecycle_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar(255) NOT NULL,
	"phase" "lifecycle_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"virtual_step_ids" uuid[] DEFAULT '{}'::uuid[],
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"mutation_mode" boolean DEFAULT false,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "logic_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"condition_step_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_type" "logic_rule_target_type" NOT NULL,
	"target_step_id" uuid,
	"target_section_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "project_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "projects" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"name" varchar(255),
	"description" text,
	"creator_id" varchar NOT NULL,
	"tenant_id" uuid,
	"created_by" varchar,
	"owner_id" varchar NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"status" "project_status" DEFAULT 'active' NOT NULL,
	"archived" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"order" integer NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"visible_if" jsonb,
	"skip_if" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "steps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"section_id" uuid NOT NULL,
	"type" "step_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"alias" text,
	"default_value" jsonb,
	"order" integer NOT NULL,
	"is_virtual" boolean DEFAULT false NOT NULL,
	"visible_if" jsonb,
	"repeater_config" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"version_number" integer NOT NULL,
	"file_ref" varchar(500) NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"notes" text,
	"is_active" boolean DEFAULT true
);
--> statement-breakpoint
CREATE TABLE "templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"file_ref" varchar(500) NOT NULL,
	"type" "template_type" NOT NULL,
	"helpers_version" integer DEFAULT 1 NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"current_version" integer DEFAULT 1,
	"last_modified_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_key" varchar NOT NULL,
	"virtual_step_id" uuid,
	"phase" "block_phase" DEFAULT 'onSectionSubmit' NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_blueprints" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"creator_id" varchar NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"graph_json" jsonb NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"source_workflow_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"name" text NOT NULL,
	"values" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"workflow_version_id" uuid,
	"version_hash" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_id" uuid NOT NULL,
	"key" text NOT NULL,
	"is_primary" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"base_id" uuid,
	"version_number" integer DEFAULT 1 NOT NULL,
	"is_draft" boolean DEFAULT false NOT NULL,
	"graph_json" jsonb NOT NULL,
	"migration_info" jsonb,
	"changelog" jsonb,
	"notes" text,
	"checksum" text,
	"created_by" varchar NOT NULL,
	"published" boolean DEFAULT false NOT NULL,
	"published_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"description" text,
	"creator_id" varchar,
	"owner_id" varchar,
	"mode_override" text,
	"public_link" text,
	"name" varchar(255),
	"project_id" uuid,
	"current_version_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"slug" text,
	"require_login" boolean DEFAULT false NOT NULL,
	"intake_config" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"pinned_version_id" uuid,
	"status" "workflow_status" DEFAULT 'draft' NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"source_blueprint_id" uuid,
	CONSTRAINT "workflows_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "ai_workflow_feedback" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid,
	"user_id" varchar,
	"operation_type" varchar NOT NULL,
	"rating" integer NOT NULL,
	"comment" text,
	"ai_provider" varchar,
	"ai_model" varchar,
	"prompt_version" varchar,
	"quality_score" integer,
	"quality_passed" boolean,
	"issues_count" integer,
	"request_description" text,
	"generated_sections" integer,
	"generated_steps" integer,
	"was_edited" boolean DEFAULT false,
	"edit_count" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "block_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"block_id" varchar NOT NULL,
	"total_visits" integer DEFAULT 0,
	"avg_time_ms" integer DEFAULT 0,
	"dropoff_count" integer DEFAULT 0,
	"validation_error_count" integer DEFAULT 0,
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"run_id" uuid,
	"type" "metrics_event_type" NOT NULL,
	"ts" timestamp with time zone DEFAULT now() NOT NULL,
	"duration_ms" integer,
	"payload" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_rollups" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"bucket_start" timestamp with time zone NOT NULL,
	"bucket" "rollup_bucket" NOT NULL,
	"runs_count" integer DEFAULT 0 NOT NULL,
	"runs_success" integer DEFAULT 0 NOT NULL,
	"runs_error" integer DEFAULT 0 NOT NULL,
	"dur_p50" integer,
	"dur_p95" integer,
	"pdf_success" integer DEFAULT 0 NOT NULL,
	"pdf_error" integer DEFAULT 0 NOT NULL,
	"docx_success" integer DEFAULT 0 NOT NULL,
	"docx_error" integer DEFAULT 0 NOT NULL,
	"queue_enqueued" integer DEFAULT 0 NOT NULL,
	"queue_dequeued" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "review_tasks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"status" "review_task_status" DEFAULT 'pending' NOT NULL,
	"reviewer_id" varchar,
	"reviewer_email" varchar(255),
	"message" text,
	"comment" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"resolved_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "run_generated_documents" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"file_name" text NOT NULL,
	"file_url" text NOT NULL,
	"mime_type" text,
	"file_size" integer,
	"template_id" uuid,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"node_id" varchar(100),
	"level" "log_level" NOT NULL,
	"message" text NOT NULL,
	"context" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_outputs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_key" text NOT NULL,
	"file_type" "output_file_type" NOT NULL,
	"storage_path" text NOT NULL,
	"status" "output_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"input_json" jsonb,
	"output_refs" jsonb,
	"trace" jsonb,
	"status" "run_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"duration_ms" integer,
	"run_token" varchar,
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "script_execution_log" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"script_type" varchar(50) NOT NULL,
	"script_id" uuid NOT NULL,
	"script_name" varchar(255),
	"phase" varchar(50),
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "script_execution_status" NOT NULL,
	"error_message" text,
	"console_output" jsonb,
	"input_sample" jsonb,
	"output_sample" jsonb,
	"duration_ms" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "signature_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"signature_request_id" uuid NOT NULL,
	"type" "signature_event_type" NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb
);
--> statement-breakpoint
CREATE TABLE "signature_requests" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"signer_email" varchar(255) NOT NULL,
	"signer_name" varchar(255),
	"status" "signature_request_status" DEFAULT 'pending' NOT NULL,
	"provider" "signature_provider" DEFAULT 'native' NOT NULL,
	"provider_request_id" text,
	"token" text NOT NULL,
	"document_url" text,
	"redirect_url" text,
	"message" text,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"signed_at" timestamp,
	CONSTRAINT "signature_requests_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "sli_configs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"target_success_pct" integer DEFAULT 99 NOT NULL,
	"target_p95_ms" integer DEFAULT 5000 NOT NULL,
	"error_budget_pct" integer DEFAULT 1 NOT NULL,
	"window" "sli_window" DEFAULT '7d' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sli_windows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"window_start" timestamp with time zone NOT NULL,
	"window_end" timestamp with time zone NOT NULL,
	"success_pct" integer,
	"p95_ms" integer,
	"error_budget_burn_pct" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "step_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"step_id" uuid NOT NULL,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_generation_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"run_id" uuid,
	"result" varchar(50) NOT NULL,
	"duration_ms" integer,
	"error_message" text,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_block_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"block_id" uuid NOT NULL,
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "transform_block_run_status" NOT NULL,
	"error_message" text,
	"output_sample" jsonb
);
--> statement-breakpoint
CREATE TABLE "workflow_analytics_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"date" timestamp NOT NULL,
	"summary" jsonb NOT NULL,
	"dropoff" jsonb NOT NULL,
	"branching" jsonb NOT NULL,
	"heatmap" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_run_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"block_id" varchar,
	"page_id" uuid,
	"type" varchar NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb,
	"is_preview" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_run_metrics" (
	"run_id" uuid PRIMARY KEY NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"total_time_ms" integer,
	"pages_visited" integer DEFAULT 0,
	"blocks_visited" integer DEFAULT 0,
	"validation_errors" integer DEFAULT 0,
	"script_errors" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"is_preview" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"workflow_version_id" uuid,
	"run_token" text NOT NULL,
	"created_by" text,
	"current_section_id" uuid,
	"progress" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"metadata" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"client_email" varchar,
	"portal_access_key" varchar,
	"access_mode" "portal_access_mode" DEFAULT 'anonymous',
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"owner_type" varchar(50),
	"owner_uuid" uuid,
	CONSTRAINT "workflow_runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "workflow_runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "analytics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"survey_id" uuid NOT NULL,
	"page_id" uuid,
	"question_id" uuid,
	"event" varchar NOT NULL,
	"data" jsonb,
	"duration" integer,
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "anonymous_response_tracking" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"ip_address" varchar NOT NULL,
	"session_id" varchar,
	"response_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "answers" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"question_id" uuid NOT NULL,
	"subquestion_id" uuid,
	"loop_index" integer,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "conditional_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"condition_question_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_question_id" uuid,
	"target_page_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_queue" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"to" varchar NOT NULL,
	"subject" varchar NOT NULL,
	"html" text NOT NULL,
	"status" "email_queue_status" DEFAULT 'pending' NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_error" text,
	"next_attempt_at" timestamp DEFAULT now(),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "files" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"answer_id" uuid NOT NULL,
	"filename" varchar NOT NULL,
	"original_name" varchar NOT NULL,
	"mime_type" varchar NOT NULL,
	"size" integer NOT NULL,
	"uploaded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "loop_group_subquestions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"loop_question_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "questions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"page_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"conditional_logic" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "responses" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"completed" boolean DEFAULT false,
	"submitted_at" timestamp,
	"is_anonymous" boolean DEFAULT false,
	"ip_address" varchar,
	"user_agent" text,
	"session_id" varchar,
	"anonymous_metadata" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_pages" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" text NOT NULL,
	"description" text,
	"content" jsonb NOT NULL,
	"creator_id" varchar,
	"is_system" boolean DEFAULT false NOT NULL,
	"tags" text[] DEFAULT ARRAY[]::text[],
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "surveys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"creator_id" varchar NOT NULL,
	"workspace_id" uuid,
	"status" "survey_status" DEFAULT 'draft' NOT NULL,
	"allow_anonymous" boolean DEFAULT false,
	"anonymous_access_type" "anonymous_access_type" DEFAULT 'unlimited',
	"public_link" varchar,
	"anonymous_config" jsonb,
	"is_public" boolean DEFAULT false,
	"public_access_mode" "public_access_mode" DEFAULT 'link_only',
	"public_slug" varchar,
	"allowed_domains" jsonb,
	"public_settings" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "surveys_public_link_unique" UNIQUE("public_link"),
	CONSTRAINT "surveys_public_slug_unique" UNIQUE("public_slug")
);
--> statement-breakpoint
CREATE TABLE "template_shares" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"user_id" varchar,
	"pending_email" text,
	"access" "template_access" DEFAULT 'use' NOT NULL,
	"invited_at" timestamp with time zone DEFAULT now(),
	"accepted_at" timestamp with time zone
);
--> statement-breakpoint
CREATE TABLE "collection_fields" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"collection_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"type" varchar(50) NOT NULL,
	"options" jsonb,
	"required" boolean DEFAULT false,
	"order" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_api_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"database_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"label" text NOT NULL,
	"token_hash" text NOT NULL,
	"scopes" text[] DEFAULT ARRAY[]::text[] NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "datavault_columns" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"type" "datavault_column_type" NOT NULL,
	"description" text,
	"width_px" integer DEFAULT 150,
	"required" boolean DEFAULT false NOT NULL,
	"is_primary_key" boolean DEFAULT false NOT NULL,
	"is_unique" boolean DEFAULT false NOT NULL,
	"order_index" integer DEFAULT 0 NOT NULL,
	"auto_number_start" integer DEFAULT 1,
	"autonumber_prefix" text,
	"autonumber_padding" integer DEFAULT 4,
	"autonumber_reset_policy" "autonumber_reset_policy" DEFAULT 'never',
	"reference_table_id" uuid,
	"reference_display_column_slug" text,
	"options" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_databases" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"type" "data_source_type" DEFAULT 'native' NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"scope_type" "datavault_scope_type" DEFAULT 'account' NOT NULL,
	"scope_id" uuid,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_number_sequences" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"prefix" text,
	"padding" integer DEFAULT 4 NOT NULL,
	"next_value" integer DEFAULT 1 NOT NULL,
	"reset_policy" "autonumber_reset_policy" DEFAULT 'never' NOT NULL,
	"last_reset" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_row_notes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"text" text NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_rows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"deleted_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "datavault_table_permissions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "datavault_table_role" NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_tables" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"owner_user_id" varchar,
	"database_id" uuid,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"value" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_writeback_mappings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_mappings" jsonb NOT NULL,
	"trigger_phase" varchar(50) DEFAULT 'afterComplete' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar
);
--> statement-breakpoint
CREATE TABLE "records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"collection_id" uuid NOT NULL,
	"data" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workflow_data_sources" (
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "workflow_data_sources_workflow_id_data_source_id_pk" PRIMARY KEY("workflow_id","data_source_id")
);
--> statement-breakpoint
CREATE TABLE "workflow_queries" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"filters" jsonb DEFAULT '[]'::jsonb,
	"sort" jsonb DEFAULT '[]'::jsonb,
	"limit" integer,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "api_keys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"prefix" varchar(50) NOT NULL,
	"key_hash" varchar(255) NOT NULL,
	"scopes" text[] NOT NULL,
	"name" varchar NOT NULL,
	"expires_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "api_keys_key_hash_unique" UNIQUE("key_hash")
);
--> statement-breakpoint
CREATE TABLE "connections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"type" "connection_type" NOT NULL,
	"base_url" varchar(500),
	"auth_config" jsonb DEFAULT '{}'::jsonb,
	"secret_refs" jsonb DEFAULT '{}'::jsonb,
	"oauth_state" jsonb,
	"default_headers" jsonb DEFAULT '{}'::jsonb,
	"timeout_ms" integer DEFAULT 8000,
	"retries" integer DEFAULT 2,
	"backoff_ms" integer DEFAULT 250,
	"enabled" boolean DEFAULT true NOT NULL,
	"last_tested_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "external_destinations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"config" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "oauth_access_tokens" (
	"access_token" varchar PRIMARY KEY NOT NULL,
	"refresh_token" varchar,
	"client_id" varchar NOT NULL,
	"user_id" varchar,
	"workspace_id" uuid NOT NULL,
	"scope" jsonb,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_access_tokens_refresh_token_unique" UNIQUE("refresh_token")
);
--> statement-breakpoint
CREATE TABLE "oauth_apps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"client_id" varchar NOT NULL,
	"client_secret_hash" varchar NOT NULL,
	"redirect_uris" jsonb NOT NULL,
	"scopes" jsonb NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_apps_client_id_unique" UNIQUE("client_id")
);
--> statement-breakpoint
CREATE TABLE "oauth_auth_codes" (
	"code" varchar PRIMARY KEY NOT NULL,
	"client_id" varchar NOT NULL,
	"user_id" varchar NOT NULL,
	"scope" jsonb,
	"redirect_uri" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"key" varchar NOT NULL,
	"value" text,
	"value_enc" text NOT NULL,
	"type" "secret_type" DEFAULT 'api_key' NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"environment" varchar DEFAULT 'production',
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"event" varchar NOT NULL,
	"payload" jsonb NOT NULL,
	"status" varchar NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_attempt_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"target_url" varchar NOT NULL,
	"events" jsonb NOT NULL,
	"secret" varchar NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "billing_plans" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"price_monthly" integer DEFAULT 0 NOT NULL,
	"price_yearly" integer DEFAULT 0 NOT NULL,
	"features" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"limits" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"stripe_product_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "customer_billing_info" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"stripe_customer_id" varchar NOT NULL,
	"billing_email" varchar,
	"default_payment_method_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscription_seats" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"assigned_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"plan_id" uuid NOT NULL,
	"status" "subscription_status" DEFAULT 'active' NOT NULL,
	"stripe_subscription_id" varchar,
	"current_period_start" timestamp,
	"current_period_end" timestamp,
	"cancel_at_period_end" boolean DEFAULT false,
	"canceled_at" timestamp,
	"trial_start" timestamp,
	"trial_end" timestamp,
	"seat_quantity" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "usage_records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"metric" varchar NOT NULL,
	"quantity" integer DEFAULT 1 NOT NULL,
	"workflow_id" uuid,
	"metadata" jsonb,
	"recorded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_template_metadata" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_key" varchar(255) NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"subject_preview" text,
	"branding_tokens" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "email_template_metadata_template_key_unique" UNIQUE("template_key")
);
--> statement-breakpoint
CREATE TABLE "ai_settings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"scope" varchar DEFAULT 'global' NOT NULL,
	"system_prompt" text,
	"updated_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
ALTER TABLE "account_locks" ADD CONSTRAINT "account_locks_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "email_verification_tokens" ADD CONSTRAINT "email_verification_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_backup_codes" ADD CONSTRAINT "mfa_backup_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_secrets" ADD CONSTRAINT "mfa_secrets_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_user_id_users_id_fk" FOREIGN KEY ("invited_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_by_user_id_users_id_fk" FOREIGN KEY ("invited_by_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_created_by_user_id_users_id_fk" FOREIGN KEY ("created_by_user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "password_reset_tokens" ADD CONSTRAINT "password_reset_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "refresh_tokens" ADD CONSTRAINT "refresh_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_team_id_teams_id_fk" FOREIGN KEY ("team_id") REFERENCES "public"."teams"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "teams" ADD CONSTRAINT "teams_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "tenant_domains" ADD CONSTRAINT "tenant_domains_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "trusted_devices" ADD CONSTRAINT "trusted_devices_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_credentials" ADD CONSTRAINT "user_credentials_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_personalization_settings" ADD CONSTRAINT "user_personalization_settings_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_preferences" ADD CONSTRAINT "user_preferences_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "users" ADD CONSTRAINT "users_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspaces" ADD CONSTRAINT "workspaces_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_snapshots" ADD CONSTRAINT "collab_snapshots_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_updates" ADD CONSTRAINT "collab_updates_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "document_hooks" ADD CONSTRAINT "document_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_condition_step_id_steps_id_fk" FOREIGN KEY ("condition_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_step_id_steps_id_fk" FOREIGN KEY ("target_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_section_id_sections_id_fk" FOREIGN KEY ("target_section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "project_access" ADD CONSTRAINT "project_access_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sections" ADD CONSTRAINT "sections_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "steps" ADD CONSTRAINT "steps_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_last_modified_by_users_id_fk" FOREIGN KEY ("last_modified_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_access" ADD CONSTRAINT "workflow_access_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_source_workflow_id_workflows_id_fk" FOREIGN KEY ("source_workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_base_id_workflows_id_fk" FOREIGN KEY ("base_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_reviewer_id_users_id_fk" FOREIGN KEY ("reviewer_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_template_id_workflow_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."workflow_templates"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_logs" ADD CONSTRAINT "run_logs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "script_execution_log" ADD CONSTRAINT "script_execution_log_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_events" ADD CONSTRAINT "signature_events_signature_request_id_signature_requests_id_fk" FOREIGN KEY ("signature_request_id") REFERENCES "public"."signature_requests"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_step_id_steps_id_fk" FOREIGN KEY ("step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_block_id_transform_blocks_id_fk" FOREIGN KEY ("block_id") REFERENCES "public"."transform_blocks"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_current_section_id_sections_id_fk" FOREIGN KEY ("current_section_id") REFERENCES "public"."sections"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_subquestion_id_loop_group_subquestions_id_fk" FOREIGN KEY ("subquestion_id") REFERENCES "public"."loop_group_subquestions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_condition_question_id_questions_id_fk" FOREIGN KEY ("condition_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_question_id_questions_id_fk" FOREIGN KEY ("target_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_page_id_survey_pages_id_fk" FOREIGN KEY ("target_page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "files" ADD CONSTRAINT "files_answer_id_answers_id_fk" FOREIGN KEY ("answer_id") REFERENCES "public"."answers"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "loop_group_subquestions" ADD CONSTRAINT "loop_group_subquestions_loop_question_id_questions_id_fk" FOREIGN KEY ("loop_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "questions" ADD CONSTRAINT "questions_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "responses" ADD CONSTRAINT "responses_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_pages" ADD CONSTRAINT "survey_pages_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_templates" ADD CONSTRAINT "survey_templates_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_template_id_survey_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."survey_templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collection_fields" ADD CONSTRAINT "collection_fields_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collections" ADD CONSTRAINT "collections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_columns" ADD CONSTRAINT "datavault_columns_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_databases" ADD CONSTRAINT "datavault_databases_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_owner_user_id_users_id_fk" FOREIGN KEY ("owner_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "api_keys" ADD CONSTRAINT "api_keys_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "external_destinations" ADD CONSTRAINT "external_destinations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_apps" ADD CONSTRAINT "oauth_apps_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "secrets" ADD CONSTRAINT "secrets_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_events" ADD CONSTRAINT "webhook_events_subscription_id_webhook_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."webhook_subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_subscriptions" ADD CONSTRAINT "webhook_subscriptions_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "customer_billing_info" ADD CONSTRAINT "customer_billing_info_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_subscription_id_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_plan_id_billing_plans_id_fk" FOREIGN KEY ("plan_id") REFERENCES "public"."billing_plans"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_settings" ADD CONSTRAINT "ai_settings_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
CREATE INDEX "account_locks_user_idx" ON "account_locks" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "account_locks_until_idx" ON "account_locks" USING btree ("locked_until");--> statement-breakpoint
CREATE INDEX "audit_logs_tenant_idx" ON "audit_logs" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "audit_logs_user_idx" ON "audit_logs" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "audit_logs_action_idx" ON "audit_logs" USING btree ("action");--> statement-breakpoint
CREATE INDEX "email_verify_token_idx" ON "email_verification_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "email_verify_user_idx" ON "email_verification_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "login_attempts_email_idx" ON "login_attempts" USING btree ("email");--> statement-breakpoint
CREATE INDEX "login_attempts_timestamp_idx" ON "login_attempts" USING btree ("attempted_at");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_user_idx" ON "mfa_backup_codes" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_hash_idx" ON "mfa_backup_codes" USING btree ("code_hash");--> statement-breakpoint
CREATE INDEX "mfa_secrets_user_idx" ON "mfa_secrets" USING btree ("user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "org_invites_token_unique_idx" ON "organization_invites" USING btree ("token");--> statement-breakpoint
CREATE INDEX "idx_org_invites_org_email_status" ON "organization_invites" USING btree ("org_id","invited_email","status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_status" ON "organization_invites" USING btree ("status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_expires" ON "organization_invites" USING btree ("expires_at");--> statement-breakpoint
CREATE UNIQUE INDEX "org_membership_unique_idx" ON "organization_memberships" USING btree ("org_id","user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_org" ON "organization_memberships" USING btree ("org_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_user" ON "organization_memberships" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_role" ON "organization_memberships" USING btree ("role");--> statement-breakpoint
CREATE INDEX "idx_organizations_created_by" ON "organizations" USING btree ("created_by_user_id");--> statement-breakpoint
CREATE INDEX "idx_organizations_tenant" ON "organizations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "pwd_reset_token_idx" ON "password_reset_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "pwd_reset_user_idx" ON "password_reset_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_user_idx" ON "refresh_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_token_idx" ON "refresh_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "IDX_session_expire" ON "sessions" USING btree ("expire");--> statement-breakpoint
CREATE UNIQUE INDEX "team_members_idx" ON "team_members" USING btree ("team_id","user_id");--> statement-breakpoint
CREATE INDEX "teams_tenant_idx" ON "teams" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_tenant_idx" ON "tenant_domains" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_domain_idx" ON "tenant_domains" USING btree ("domain");--> statement-breakpoint
CREATE INDEX "tenants_plan_idx" ON "tenants" USING btree ("plan");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_idx" ON "trusted_devices" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "trusted_devices_fingerprint_idx" ON "trusted_devices" USING btree ("device_fingerprint");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_fingerprint_idx" ON "trusted_devices" USING btree ("user_id","device_fingerprint");--> statement-breakpoint
CREATE INDEX "user_credentials_user_idx" ON "user_credentials" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "users_email_idx" ON "users" USING btree ("email");--> statement-breakpoint
CREATE INDEX "users_tenant_idx" ON "users" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "users_tenant_email_idx" ON "users" USING btree ("tenant_id","email");--> statement-breakpoint
CREATE INDEX "idx_users_is_placeholder" ON "users" USING btree ("is_placeholder");--> statement-breakpoint
CREATE INDEX "idx_users_placeholder_email" ON "users" USING btree ("placeholder_email");--> statement-breakpoint
CREATE INDEX "invitation_token_idx" ON "workspace_invitations" USING btree ("token");--> statement-breakpoint
CREATE INDEX "invitation_ws_email_idx" ON "workspace_invitations" USING btree ("workspace_id","email");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_member_idx" ON "workspace_members" USING btree ("workspace_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_org_slug_idx" ON "workspaces" USING btree ("organization_id","slug");--> statement-breakpoint
CREATE INDEX "blocks_workflow_phase_order_idx" ON "blocks" USING btree ("workflow_id","phase","order");--> statement-breakpoint
CREATE INDEX "collab_docs_workflow_idx" ON "collab_docs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "collab_snapshots_doc_clock_idx" ON "collab_snapshots" USING btree ("doc_id","clock");--> statement-breakpoint
CREATE INDEX "collab_updates_doc_seq_idx" ON "collab_updates" USING btree ("doc_id","seq");--> statement-breakpoint
CREATE INDEX "logic_rules_workflow_idx" ON "logic_rules" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "project_access_project_idx" ON "project_access" USING btree ("project_id");--> statement-breakpoint
CREATE UNIQUE INDEX "project_access_principal_idx" ON "project_access" USING btree ("project_id","principal_type","principal_id");--> statement-breakpoint
CREATE INDEX "projects_tenant_idx" ON "projects" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "projects_created_by_idx" ON "projects" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "projects_creator_idx" ON "projects" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "projects_owner_idx" ON "projects" USING btree ("owner_id");--> statement-breakpoint
CREATE INDEX "idx_projects_owner" ON "projects" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "projects_status_idx" ON "projects" USING btree ("status");--> statement-breakpoint
CREATE INDEX "projects_archived_idx" ON "projects" USING btree ("archived");--> statement-breakpoint
CREATE INDEX "sections_workflow_idx" ON "sections" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "steps_section_idx" ON "steps" USING btree ("section_id");--> statement-breakpoint
CREATE UNIQUE INDEX "template_versions_unique_idx" ON "template_versions" USING btree ("template_id","version_number");--> statement-breakpoint
CREATE INDEX "templates_project_idx" ON "templates" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflow_access_workflow_idx" ON "workflow_access" USING btree ("workflow_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_access_principal_idx" ON "workflow_access" USING btree ("workflow_id","principal_type","principal_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_snapshots_workflow_name_unique" ON "workflow_snapshots" USING btree ("workflow_id","name");--> statement-breakpoint
CREATE INDEX "workflow_templates_version_key_unique" ON "workflow_templates" USING btree ("workflow_version_id","key");--> statement-breakpoint
CREATE INDEX "workflow_versions_workflow_idx" ON "workflow_versions" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_versions_version_number_idx" ON "workflow_versions" USING btree ("workflow_id","version_number");--> statement-breakpoint
CREATE INDEX "workflow_versions_is_draft_idx" ON "workflow_versions" USING btree ("is_draft");--> statement-breakpoint
CREATE INDEX "workflows_project_idx" ON "workflows" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflows_status_idx" ON "workflows" USING btree ("status");--> statement-breakpoint
CREATE INDEX "workflows_is_public_idx" ON "workflows" USING btree ("is_public");--> statement-breakpoint
CREATE INDEX "workflows_slug_idx" ON "workflows" USING btree ("slug");--> statement-breakpoint
CREATE INDEX "workflows_pinned_version_idx" ON "workflows" USING btree ("pinned_version_id");--> statement-breakpoint
CREATE INDEX "idx_workflows_owner" ON "workflows" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "ai_feedback_workflow_idx" ON "ai_workflow_feedback" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "bm_version_block_idx" ON "block_metrics" USING btree ("version_id","block_id");--> statement-breakpoint
CREATE INDEX "metrics_events_project_ts_idx" ON "metrics_events" USING btree ("project_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_workflow_ts_idx" ON "metrics_events" USING btree ("workflow_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_type_idx" ON "metrics_events" USING btree ("type");--> statement-breakpoint
CREATE UNIQUE INDEX "metrics_rollups_unique_idx" ON "metrics_rollups" USING btree ("tenant_id","project_id",COALESCE("workflow_id", '00000000-0000-0000-0000-000000000000'::uuid),"bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "metrics_rollups_project_bucket_idx" ON "metrics_rollups" USING btree ("project_id","bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "review_tasks_run_idx" ON "review_tasks" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "review_tasks_workflow_idx" ON "review_tasks" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "review_tasks_status_idx" ON "review_tasks" USING btree ("status");--> statement-breakpoint
CREATE INDEX "review_tasks_reviewer_idx" ON "review_tasks" USING btree ("reviewer_id");--> statement-breakpoint
CREATE INDEX "run_generated_documents_run_idx" ON "run_generated_documents" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_run_idx" ON "run_logs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_level_idx" ON "run_logs" USING btree ("level");--> statement-breakpoint
CREATE INDEX "run_logs_created_at_idx" ON "run_logs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "run_outputs_run_idx" ON "run_outputs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_outputs_run_template_type_idx" ON "run_outputs" USING btree ("run_id","template_key","file_type");--> statement-breakpoint
CREATE INDEX "runs_workflow_version_idx" ON "runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "runs_status_idx" ON "runs" USING btree ("status");--> statement-breakpoint
CREATE INDEX "runs_created_by_idx" ON "runs" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "runs_created_at_idx" ON "runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "script_execution_log_run_idx" ON "script_execution_log" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_events_request_idx" ON "signature_events" USING btree ("signature_request_id");--> statement-breakpoint
CREATE INDEX "signature_requests_run_idx" ON "signature_requests" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_requests_token_idx" ON "signature_requests" USING btree ("token");--> statement-breakpoint
CREATE INDEX "sli_configs_project_idx" ON "sli_configs" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "sli_windows_project_window_idx" ON "sli_windows" USING btree ("project_id","window_start","window_end");--> statement-breakpoint
CREATE INDEX "step_values_run_idx" ON "step_values" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "step_values_step_idx" ON "step_values" USING btree ("step_id");--> statement-breakpoint
CREATE INDEX "step_values_run_step_idx" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE UNIQUE INDEX "step_values_run_step_unique" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE INDEX "template_metrics_template_idx" ON "template_generation_metrics" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_metrics_run_idx" ON "template_generation_metrics" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_run_idx" ON "transform_block_runs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_block_idx" ON "transform_block_runs" USING btree ("block_id");--> statement-breakpoint
CREATE UNIQUE INDEX "was_workflow_version_date_idx" ON "workflow_analytics_snapshots" USING btree ("workflow_id","version_id","date");--> statement-breakpoint
CREATE INDEX "wre_run_idx" ON "workflow_run_events" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "wre_workflow_ts_idx" ON "workflow_run_events" USING btree ("workflow_id","timestamp");--> statement-breakpoint
CREATE INDEX "wrm_workflow_created_idx" ON "workflow_run_metrics" USING btree ("workflow_id","created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_workflow_idx" ON "workflow_runs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_version_idx" ON "workflow_runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_completed_idx" ON "workflow_runs" USING btree ("completed");--> statement-breakpoint
CREATE INDEX "workflow_runs_run_token_idx" ON "workflow_runs" USING btree ("run_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_share_token_idx" ON "workflow_runs" USING btree ("share_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_current_section_idx" ON "workflow_runs" USING btree ("current_section_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_created_at_idx" ON "workflow_runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_owner_idx" ON "workflow_runs" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "analytics_survey_event_idx" ON "analytics_events" USING btree ("survey_id","event");--> statement-breakpoint
CREATE INDEX "analytics_response_event_idx" ON "analytics_events" USING btree ("response_id","event");--> statement-breakpoint
CREATE INDEX "analytics_timestamp_idx" ON "analytics_events" USING btree ("timestamp");--> statement-breakpoint
CREATE INDEX "anonymous_tracking_survey_ip_idx" ON "anonymous_response_tracking" USING btree ("survey_id","ip_address");--> statement-breakpoint
CREATE INDEX "email_queue_status_idx" ON "email_queue" USING btree ("status");--> statement-breakpoint
CREATE INDEX "email_queue_next_attempt_idx" ON "email_queue" USING btree ("next_attempt_at");--> statement-breakpoint
CREATE INDEX "survey_templates_creator_idx" ON "survey_templates" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "survey_templates_system_idx" ON "survey_templates" USING btree ("is_system");--> statement-breakpoint
CREATE INDEX "surveys_public_link_unique_idx" ON "surveys" USING btree ("public_link");--> statement-breakpoint
CREATE INDEX "surveys_workspace_idx" ON "surveys" USING btree ("workspace_id");--> statement-breakpoint
CREATE INDEX "template_shares_template_idx" ON "template_shares" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_shares_user_idx" ON "template_shares" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "template_shares_pending_email_idx" ON "template_shares" USING btree ("pending_email");--> statement-breakpoint
CREATE INDEX "collection_fields_collection_idx" ON "collection_fields" USING btree ("collection_id");--> statement-breakpoint
CREATE UNIQUE INDEX "collection_fields_slug_unique" ON "collection_fields" USING btree ("collection_id","slug");--> statement-breakpoint
CREATE UNIQUE INDEX "collections_slug_unique" ON "collections" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_database_id" ON "datavault_api_tokens" USING btree ("database_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE INDEX "datavault_columns_table_idx" ON "datavault_columns" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_columns_reference_table_idx" ON "datavault_columns" USING btree ("reference_table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_columns_table_slug_unique" ON "datavault_columns" USING btree ("table_id","slug");--> statement-breakpoint
CREATE INDEX "idx_databases_tenant" ON "datavault_databases" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_databases_scope" ON "datavault_databases" USING btree ("scope_type","scope_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_databases_owner" ON "datavault_databases" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_tenant" ON "datavault_number_sequences" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_table" ON "datavault_number_sequences" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "idx_datavault_sequences_column_unique" ON "datavault_number_sequences" USING btree ("tenant_id","table_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_row_id" ON "datavault_row_notes" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_tenant_id" ON "datavault_row_notes" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_table_idx" ON "datavault_rows" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_created_by_idx" ON "datavault_rows" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "idx_table_permissions_table" ON "datavault_table_permissions" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_table_user_permission" ON "datavault_table_permissions" USING btree ("table_id","user_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_tenant_idx" ON "datavault_tables" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_owner_idx" ON "datavault_tables" USING btree ("owner_user_id");--> statement-breakpoint
CREATE INDEX "idx_tables_database" ON "datavault_tables" USING btree ("database_id","tenant_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_tables_tenant_slug_unique" ON "datavault_tables" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "datavault_values_row_idx" ON "datavault_values" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "datavault_values_column_idx" ON "datavault_values" USING btree ("column_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_values_row_column_unique" ON "datavault_values" USING btree ("row_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_writeback_mappings_workflow" ON "datavault_writeback_mappings" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "records_collection_idx" ON "records" USING btree ("collection_id");--> statement-breakpoint
CREATE INDEX "records_tenant_idx" ON "records" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_data_sources_workflow" ON "workflow_data_sources" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_queries_workflow" ON "workflow_queries" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "api_keys_project_idx" ON "api_keys" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_tenant_idx" ON "connections" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "connections_project_idx" ON "connections" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_project_name_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "connections_type_idx" ON "connections" USING btree ("type");--> statement-breakpoint
CREATE INDEX "connections_enabled_idx" ON "connections" USING btree ("enabled");--> statement-breakpoint
CREATE UNIQUE INDEX "connections_project_name_unique_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "ext_dest_tenant_idx" ON "external_destinations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_client_id_idx" ON "oauth_apps" USING btree ("client_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_workspace_idx" ON "oauth_apps" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "secrets_project_key_env_unique" ON "secrets" USING btree ("project_id","key","environment");--> statement-breakpoint
CREATE INDEX "webhook_events_sub_idx" ON "webhook_events" USING btree ("subscription_id");--> statement-breakpoint
CREATE INDEX "webhook_subs_workspace_idx" ON "webhook_subscriptions" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_org_idx" ON "customer_billing_info" USING btree ("organization_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_stripe_idx" ON "customer_billing_info" USING btree ("stripe_customer_id");--> statement-breakpoint
CREATE UNIQUE INDEX "seat_sub_user_idx" ON "subscription_seats" USING btree ("subscription_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "sub_org_idx" ON "subscriptions" USING btree ("organization_id");--> statement-breakpoint
CREATE INDEX "usage_org_metric_date_idx" ON "usage_records" USING btree ("organization_id","metric","recorded_at");--> statement-breakpoint
CREATE INDEX "email_templates_key_idx" ON "email_template_metadata" USING btree ("template_key");--> statement-breakpoint
CREATE INDEX "ai_settings_scope_idx" ON "ai_settings" USING btree ("scope");
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:232:19 {
  query: `CREATE TYPE "public"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint\n` +
    'CREATE TABLE "account_locks" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"locked_at" timestamp DEFAULT now() NOT NULL,\n' +
    '\t"locked_until" timestamp NOT NULL,\n' +
    '\t"reason" varchar(255),\n' +
    '\t"unlocked" boolean DEFAULT false NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "audit_logs" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"tenant_id" uuid,\n' +
    '\t"workspace_id" uuid,\n' +
    '\t"user_id" varchar,\n' +
    '\t"action" varchar NOT NULL,\n' +
    '\t"entity_type" varchar NOT NULL,\n' +
    '\t"entity_id" varchar NOT NULL,\n' +
    '\t"resource_type" varchar,\n' +
    '\t"resource_id" varchar,\n' +
    '\t"changes" jsonb,\n' +
    '\t"details" jsonb,\n' +
    '\t"ip_address" varchar,\n' +
    '\t"user_agent" text,\n' +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"timestamp" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "email_verification_tokens" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"token" varchar NOT NULL,\n' +
    '\t"expires_at" timestamp NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "login_attempts" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"email" varchar(255) NOT NULL,\n' +
    '\t"ip_address" varchar(45),\n' +
    '\t"successful" boolean DEFAULT false NOT NULL,\n' +
    '\t"attempted_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "mfa_backup_codes" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"code_hash" text NOT NULL,\n' +
    '\t"used" boolean DEFAULT false NOT NULL,\n' +
    '\t"used_at" timestamp,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "mfa_secrets" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"secret" text NOT NULL,\n' +
    '\t"enabled" boolean DEFAULT false NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL,\n' +
    '\t"enabled_at" timestamp,\n' +
    '\tCONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "organization_invites" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"org_id" uuid NOT NULL,\n' +
    '\t"invited_email" varchar(255) NOT NULL,\n' +
    '\t"invited_user_id" varchar,\n' +
    '\t"invited_by_user_id" varchar NOT NULL,\n' +
    '\t"token" varchar(255) NOT NULL,\n' +
    `\t"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,\n` +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"expires_at" timestamp NOT NULL,\n' +
    '\t"accepted_at" timestamp,\n' +
    '\t"email_sent_at" timestamp,\n' +
    '\t"email_failed" boolean DEFAULT false,\n' +
    '\t"email_error" text,\n' +
    '\tCONSTRAINT "organization_invites_token_unique" UNIQUE("token")\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "organization_memberships" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"org_id" uuid NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    `\t"role" "organization_role" DEFAULT 'member' NOT NULL,\n` +
    '\t"created_at" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "organizations" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"name" varchar NOT NULL,\n' +
    '\t"description" text,\n' +
    '\t"slug" varchar,\n' +
    '\t"domain" varchar,\n' +
    `\t"settings" jsonb DEFAULT '{}'::jsonb,\n` +
    '\t"tenant_id" uuid NOT NULL,\n' +
    '\t"created_by_user_id" varchar,\n' +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"upd'... 108432 more characters,
  params: [],
  cause: error: type "anonymous_access_type" already exists
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:232:19 {
    length: 101,
    severity: 'ERROR',
    code: '42710',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: 'typecmds.c',
    line: '1177',
    routine: 'DefineEnum'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

{"level":30,"time":1768674750949,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768674750970,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768674750957,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768674750958,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768674750963,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768674750964,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768674750970,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768674750970,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768674750970,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768674750970,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768674751208,"env":"test","module":"auth-routes","error":{},"msg":"Registration failed"}
{"level":30,"time":1768674751221,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768674751221,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: []

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 2600ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  12:32:20
   Duration  10.79s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x2 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöæ add access controls to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768674898114,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768674901340,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768674901390,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: public
≡ƒöä Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/auth/protected.routes.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

stdout | tests/integration/auth/protected.routes.test.ts
   Applying 0000_mushy_thing.sql...

stderr | tests/integration/auth/protected.routes.test.ts
Γ¥î FAILED MIGRATION 0000_mushy_thing.sql: Failed query: CREATE TYPE "public"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint
CREATE TYPE "public"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint
CREATE TYPE "public"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint
CREATE TYPE "public"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint
CREATE TYPE "public"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint
CREATE TYPE "public"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint
CREATE TYPE "public"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint
CREATE TYPE "public"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint
CREATE TYPE "public"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint
CREATE TYPE "public"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint
CREATE TYPE "public"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint
CREATE TYPE "public"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint
CREATE TYPE "public"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint
CREATE TYPE "public"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint
CREATE TYPE "public"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint
CREATE TYPE "public"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint
CREATE TYPE "public"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint
CREATE TYPE "public"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint
CREATE TYPE "public"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint
CREATE TYPE "public"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint
CREATE TYPE "public"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint
CREATE TYPE "public"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint
CREATE TYPE "public"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint
CREATE TYPE "public"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint
CREATE TYPE "public"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint
CREATE TYPE "public"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint
CREATE TYPE "public"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint
CREATE TYPE "public"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint
CREATE TYPE "public"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint
CREATE TYPE "public"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint
CREATE TYPE "public"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint
CREATE TYPE "public"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint
CREATE TYPE "public"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint
CREATE TYPE "public"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint
CREATE TYPE "public"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint
CREATE TYPE "public"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint
CREATE TYPE "public"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint
CREATE TYPE "public"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint
CREATE TYPE "public"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint
CREATE TYPE "public"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint
CREATE TYPE "public"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint
CREATE TYPE "public"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint
CREATE TYPE "public"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint
CREATE TYPE "public"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint
CREATE TABLE "account_locks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"locked_at" timestamp DEFAULT now() NOT NULL,
	"locked_until" timestamp NOT NULL,
	"reason" varchar(255),
	"unlocked" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "audit_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"workspace_id" uuid,
	"user_id" varchar,
	"action" varchar NOT NULL,
	"entity_type" varchar NOT NULL,
	"entity_id" varchar NOT NULL,
	"resource_type" varchar,
	"resource_id" varchar,
	"changes" jsonb,
	"details" jsonb,
	"ip_address" varchar,
	"user_agent" text,
	"created_at" timestamp DEFAULT now(),
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_verification_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "login_attempts" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"ip_address" varchar(45),
	"successful" boolean DEFAULT false NOT NULL,
	"attempted_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_backup_codes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"code_hash" text NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"secret" text NOT NULL,
	"enabled" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"enabled_at" timestamp,
	CONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "organization_invites" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"invited_email" varchar(255) NOT NULL,
	"invited_user_id" varchar,
	"invited_by_user_id" varchar NOT NULL,
	"token" varchar(255) NOT NULL,
	"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp NOT NULL,
	"accepted_at" timestamp,
	"email_sent_at" timestamp,
	"email_failed" boolean DEFAULT false,
	"email_error" text,
	CONSTRAINT "organization_invites_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "organization_memberships" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "organization_role" DEFAULT 'member' NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "organizations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"slug" varchar,
	"domain" varchar,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"tenant_id" uuid NOT NULL,
	"created_by_user_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "organizations_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "password_reset_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "portal_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "portal_tokens_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "refresh_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"revoked" boolean DEFAULT false NOT NULL,
	"metadata" jsonb,
	"device_name" varchar(255),
	"ip_address" varchar(45),
	"location" varchar(255),
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sessions" (
	"sid" varchar PRIMARY KEY NOT NULL,
	"sess" jsonb NOT NULL,
	"expire" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE "team_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"team_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" varchar(50) DEFAULT 'member' NOT NULL,
	"joined_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "teams" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "tenant_domains" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"domain" text NOT NULL,
	"verified" boolean DEFAULT false,
	"verification_token" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "tenant_domains_domain_unique" UNIQUE("domain")
);
--> statement-breakpoint
CREATE TABLE "tenants" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar(255) NOT NULL,
	"billing_email" varchar(255),
	"plan" "tenant_plan" DEFAULT 'free' NOT NULL,
	"mfa_required" boolean DEFAULT false NOT NULL,
	"branding" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "trusted_devices" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"device_fingerprint" varchar(255) NOT NULL,
	"device_name" varchar(255),
	"trusted_until" timestamp NOT NULL,
	"ip_address" varchar(45),
	"location" varchar(255),
	"user_agent" text,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"last_used_at" timestamp,
	"revoked" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "user_credentials" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"password_hash" text NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "user_credentials_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "user_personalization_settings" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"reading_level" varchar DEFAULT 'standard' NOT NULL,
	"tone" varchar DEFAULT 'neutral' NOT NULL,
	"verbosity" varchar DEFAULT 'standard' NOT NULL,
	"language" varchar DEFAULT 'en' NOT NULL,
	"allow_adaptive_prompts" boolean DEFAULT true NOT NULL,
	"allow_ai_clarification" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "user_preferences" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"settings" jsonb DEFAULT '{"celebrationEffects":true,"darkMode":"system","aiHints":true}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "users" (
	"id" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"full_name" varchar(255),
	"first_name" varchar(255),
	"last_name" varchar(255),
	"profile_image_url" varchar(500),
	"tenant_id" uuid,
	"role" "user_role" DEFAULT 'creator' NOT NULL,
	"tenant_role" "user_tenant_role",
	"auth_provider" "auth_provider" DEFAULT 'local' NOT NULL,
	"default_mode" text DEFAULT 'easy' NOT NULL,
	"email_verified" boolean DEFAULT false NOT NULL,
	"mfa_enabled" boolean DEFAULT false NOT NULL,
	"last_password_change" timestamp,
	"is_placeholder" boolean DEFAULT false NOT NULL,
	"placeholder_email" varchar(255),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_invitations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"email" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"invited_by" varchar NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"joined_at" timestamp DEFAULT now(),
	"invited_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workspaces" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"slug" varchar NOT NULL,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"type" "block_type" NOT NULL,
	"phase" "block_phase" NOT NULL,
	"config" jsonb NOT NULL,
	"virtual_step_id" uuid,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_docs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid,
	"tenant_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"clock" integer NOT NULL,
	"state" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "collab_updates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"seq" integer NOT NULL,
	"update" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "document_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"final_block_document_id" varchar(255),
	"name" varchar(255) NOT NULL,
	"phase" "document_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 3000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "lifecycle_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar(255) NOT NULL,
	"phase" "lifecycle_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"virtual_step_ids" uuid[] DEFAULT '{}'::uuid[],
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"mutation_mode" boolean DEFAULT false,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "logic_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"condition_step_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_type" "logic_rule_target_type" NOT NULL,
	"target_step_id" uuid,
	"target_section_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "project_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "projects" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"name" varchar(255),
	"description" text,
	"creator_id" varchar NOT NULL,
	"tenant_id" uuid,
	"created_by" varchar,
	"owner_id" varchar NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"status" "project_status" DEFAULT 'active' NOT NULL,
	"archived" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"order" integer NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"visible_if" jsonb,
	"skip_if" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "steps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"section_id" uuid NOT NULL,
	"type" "step_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"alias" text,
	"default_value" jsonb,
	"order" integer NOT NULL,
	"is_virtual" boolean DEFAULT false NOT NULL,
	"visible_if" jsonb,
	"repeater_config" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"version_number" integer NOT NULL,
	"file_ref" varchar(500) NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"notes" text,
	"is_active" boolean DEFAULT true
);
--> statement-breakpoint
CREATE TABLE "templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"file_ref" varchar(500) NOT NULL,
	"type" "template_type" NOT NULL,
	"helpers_version" integer DEFAULT 1 NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"current_version" integer DEFAULT 1,
	"last_modified_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_key" varchar NOT NULL,
	"virtual_step_id" uuid,
	"phase" "block_phase" DEFAULT 'onSectionSubmit' NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_blueprints" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"creator_id" varchar NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"graph_json" jsonb NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"source_workflow_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"name" text NOT NULL,
	"values" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"workflow_version_id" uuid,
	"version_hash" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_id" uuid NOT NULL,
	"key" text NOT NULL,
	"is_primary" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"base_id" uuid,
	"version_number" integer DEFAULT 1 NOT NULL,
	"is_draft" boolean DEFAULT false NOT NULL,
	"graph_json" jsonb NOT NULL,
	"migration_info" jsonb,
	"changelog" jsonb,
	"notes" text,
	"checksum" text,
	"created_by" varchar NOT NULL,
	"published" boolean DEFAULT false NOT NULL,
	"published_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"description" text,
	"creator_id" varchar,
	"owner_id" varchar,
	"mode_override" text,
	"public_link" text,
	"name" varchar(255),
	"project_id" uuid,
	"current_version_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"slug" text,
	"require_login" boolean DEFAULT false NOT NULL,
	"intake_config" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"pinned_version_id" uuid,
	"status" "workflow_status" DEFAULT 'draft' NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"source_blueprint_id" uuid,
	CONSTRAINT "workflows_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "ai_workflow_feedback" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid,
	"user_id" varchar,
	"operation_type" varchar NOT NULL,
	"rating" integer NOT NULL,
	"comment" text,
	"ai_provider" varchar,
	"ai_model" varchar,
	"prompt_version" varchar,
	"quality_score" integer,
	"quality_passed" boolean,
	"issues_count" integer,
	"request_description" text,
	"generated_sections" integer,
	"generated_steps" integer,
	"was_edited" boolean DEFAULT false,
	"edit_count" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "block_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"block_id" varchar NOT NULL,
	"total_visits" integer DEFAULT 0,
	"avg_time_ms" integer DEFAULT 0,
	"dropoff_count" integer DEFAULT 0,
	"validation_error_count" integer DEFAULT 0,
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"run_id" uuid,
	"type" "metrics_event_type" NOT NULL,
	"ts" timestamp with time zone DEFAULT now() NOT NULL,
	"duration_ms" integer,
	"payload" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_rollups" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"bucket_start" timestamp with time zone NOT NULL,
	"bucket" "rollup_bucket" NOT NULL,
	"runs_count" integer DEFAULT 0 NOT NULL,
	"runs_success" integer DEFAULT 0 NOT NULL,
	"runs_error" integer DEFAULT 0 NOT NULL,
	"dur_p50" integer,
	"dur_p95" integer,
	"pdf_success" integer DEFAULT 0 NOT NULL,
	"pdf_error" integer DEFAULT 0 NOT NULL,
	"docx_success" integer DEFAULT 0 NOT NULL,
	"docx_error" integer DEFAULT 0 NOT NULL,
	"queue_enqueued" integer DEFAULT 0 NOT NULL,
	"queue_dequeued" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "review_tasks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"status" "review_task_status" DEFAULT 'pending' NOT NULL,
	"reviewer_id" varchar,
	"reviewer_email" varchar(255),
	"message" text,
	"comment" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"resolved_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "run_generated_documents" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"file_name" text NOT NULL,
	"file_url" text NOT NULL,
	"mime_type" text,
	"file_size" integer,
	"template_id" uuid,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"node_id" varchar(100),
	"level" "log_level" NOT NULL,
	"message" text NOT NULL,
	"context" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_outputs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_key" text NOT NULL,
	"file_type" "output_file_type" NOT NULL,
	"storage_path" text NOT NULL,
	"status" "output_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"input_json" jsonb,
	"output_refs" jsonb,
	"trace" jsonb,
	"status" "run_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"duration_ms" integer,
	"run_token" varchar,
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "script_execution_log" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"script_type" varchar(50) NOT NULL,
	"script_id" uuid NOT NULL,
	"script_name" varchar(255),
	"phase" varchar(50),
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "script_execution_status" NOT NULL,
	"error_message" text,
	"console_output" jsonb,
	"input_sample" jsonb,
	"output_sample" jsonb,
	"duration_ms" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "signature_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"signature_request_id" uuid NOT NULL,
	"type" "signature_event_type" NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb
);
--> statement-breakpoint
CREATE TABLE "signature_requests" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"signer_email" varchar(255) NOT NULL,
	"signer_name" varchar(255),
	"status" "signature_request_status" DEFAULT 'pending' NOT NULL,
	"provider" "signature_provider" DEFAULT 'native' NOT NULL,
	"provider_request_id" text,
	"token" text NOT NULL,
	"document_url" text,
	"redirect_url" text,
	"message" text,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"signed_at" timestamp,
	CONSTRAINT "signature_requests_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "sli_configs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"target_success_pct" integer DEFAULT 99 NOT NULL,
	"target_p95_ms" integer DEFAULT 5000 NOT NULL,
	"error_budget_pct" integer DEFAULT 1 NOT NULL,
	"window" "sli_window" DEFAULT '7d' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sli_windows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"window_start" timestamp with time zone NOT NULL,
	"window_end" timestamp with time zone NOT NULL,
	"success_pct" integer,
	"p95_ms" integer,
	"error_budget_burn_pct" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "step_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"step_id" uuid NOT NULL,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_generation_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"run_id" uuid,
	"result" varchar(50) NOT NULL,
	"duration_ms" integer,
	"error_message" text,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_block_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"block_id" uuid NOT NULL,
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "transform_block_run_status" NOT NULL,
	"error_message" text,
	"output_sample" jsonb
);
--> statement-breakpoint
CREATE TABLE "workflow_analytics_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"date" timestamp NOT NULL,
	"summary" jsonb NOT NULL,
	"dropoff" jsonb NOT NULL,
	"branching" jsonb NOT NULL,
	"heatmap" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_run_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"block_id" varchar,
	"page_id" uuid,
	"type" varchar NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb,
	"is_preview" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_run_metrics" (
	"run_id" uuid PRIMARY KEY NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"total_time_ms" integer,
	"pages_visited" integer DEFAULT 0,
	"blocks_visited" integer DEFAULT 0,
	"validation_errors" integer DEFAULT 0,
	"script_errors" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"is_preview" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"workflow_version_id" uuid,
	"run_token" text NOT NULL,
	"created_by" text,
	"current_section_id" uuid,
	"progress" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"metadata" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"client_email" varchar,
	"portal_access_key" varchar,
	"access_mode" "portal_access_mode" DEFAULT 'anonymous',
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"owner_type" varchar(50),
	"owner_uuid" uuid,
	CONSTRAINT "workflow_runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "workflow_runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "analytics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"survey_id" uuid NOT NULL,
	"page_id" uuid,
	"question_id" uuid,
	"event" varchar NOT NULL,
	"data" jsonb,
	"duration" integer,
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "anonymous_response_tracking" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"ip_address" varchar NOT NULL,
	"session_id" varchar,
	"response_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "answers" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"question_id" uuid NOT NULL,
	"subquestion_id" uuid,
	"loop_index" integer,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "conditional_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"condition_question_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_question_id" uuid,
	"target_page_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_queue" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"to" varchar NOT NULL,
	"subject" varchar NOT NULL,
	"html" text NOT NULL,
	"status" "email_queue_status" DEFAULT 'pending' NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_error" text,
	"next_attempt_at" timestamp DEFAULT now(),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "files" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"answer_id" uuid NOT NULL,
	"filename" varchar NOT NULL,
	"original_name" varchar NOT NULL,
	"mime_type" varchar NOT NULL,
	"size" integer NOT NULL,
	"uploaded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "loop_group_subquestions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"loop_question_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "questions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"page_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"conditional_logic" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "responses" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"completed" boolean DEFAULT false,
	"submitted_at" timestamp,
	"is_anonymous" boolean DEFAULT false,
	"ip_address" varchar,
	"user_agent" text,
	"session_id" varchar,
	"anonymous_metadata" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_pages" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" text NOT NULL,
	"description" text,
	"content" jsonb NOT NULL,
	"creator_id" varchar,
	"is_system" boolean DEFAULT false NOT NULL,
	"tags" text[] DEFAULT ARRAY[]::text[],
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "surveys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"creator_id" varchar NOT NULL,
	"workspace_id" uuid,
	"status" "survey_status" DEFAULT 'draft' NOT NULL,
	"allow_anonymous" boolean DEFAULT false,
	"anonymous_access_type" "anonymous_access_type" DEFAULT 'unlimited',
	"public_link" varchar,
	"anonymous_config" jsonb,
	"is_public" boolean DEFAULT false,
	"public_access_mode" "public_access_mode" DEFAULT 'link_only',
	"public_slug" varchar,
	"allowed_domains" jsonb,
	"public_settings" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "surveys_public_link_unique" UNIQUE("public_link"),
	CONSTRAINT "surveys_public_slug_unique" UNIQUE("public_slug")
);
--> statement-breakpoint
CREATE TABLE "template_shares" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"user_id" varchar,
	"pending_email" text,
	"access" "template_access" DEFAULT 'use' NOT NULL,
	"invited_at" timestamp with time zone DEFAULT now(),
	"accepted_at" timestamp with time zone
);
--> statement-breakpoint
CREATE TABLE "collection_fields" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"collection_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"type" varchar(50) NOT NULL,
	"options" jsonb,
	"required" boolean DEFAULT false,
	"order" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_api_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"database_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"label" text NOT NULL,
	"token_hash" text NOT NULL,
	"scopes" text[] DEFAULT ARRAY[]::text[] NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "datavault_columns" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"type" "datavault_column_type" NOT NULL,
	"description" text,
	"width_px" integer DEFAULT 150,
	"required" boolean DEFAULT false NOT NULL,
	"is_primary_key" boolean DEFAULT false NOT NULL,
	"is_unique" boolean DEFAULT false NOT NULL,
	"order_index" integer DEFAULT 0 NOT NULL,
	"auto_number_start" integer DEFAULT 1,
	"autonumber_prefix" text,
	"autonumber_padding" integer DEFAULT 4,
	"autonumber_reset_policy" "autonumber_reset_policy" DEFAULT 'never',
	"reference_table_id" uuid,
	"reference_display_column_slug" text,
	"options" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_databases" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"type" "data_source_type" DEFAULT 'native' NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"scope_type" "datavault_scope_type" DEFAULT 'account' NOT NULL,
	"scope_id" uuid,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_number_sequences" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"prefix" text,
	"padding" integer DEFAULT 4 NOT NULL,
	"next_value" integer DEFAULT 1 NOT NULL,
	"reset_policy" "autonumber_reset_policy" DEFAULT 'never' NOT NULL,
	"last_reset" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_row_notes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"text" text NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_rows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"deleted_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "datavault_table_permissions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "datavault_table_role" NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_tables" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"owner_user_id" varchar,
	"database_id" uuid,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"value" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_writeback_mappings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_mappings" jsonb NOT NULL,
	"trigger_phase" varchar(50) DEFAULT 'afterComplete' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar
);
--> statement-breakpoint
CREATE TABLE "records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"collection_id" uuid NOT NULL,
	"data" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workflow_data_sources" (
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "workflow_data_sources_workflow_id_data_source_id_pk" PRIMARY KEY("workflow_id","data_source_id")
);
--> statement-breakpoint
CREATE TABLE "workflow_queries" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"filters" jsonb DEFAULT '[]'::jsonb,
	"sort" jsonb DEFAULT '[]'::jsonb,
	"limit" integer,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "api_keys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"prefix" varchar(50) NOT NULL,
	"key_hash" varchar(255) NOT NULL,
	"scopes" text[] NOT NULL,
	"name" varchar NOT NULL,
	"expires_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "api_keys_key_hash_unique" UNIQUE("key_hash")
);
--> statement-breakpoint
CREATE TABLE "connections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"type" "connection_type" NOT NULL,
	"base_url" varchar(500),
	"auth_config" jsonb DEFAULT '{}'::jsonb,
	"secret_refs" jsonb DEFAULT '{}'::jsonb,
	"oauth_state" jsonb,
	"default_headers" jsonb DEFAULT '{}'::jsonb,
	"timeout_ms" integer DEFAULT 8000,
	"retries" integer DEFAULT 2,
	"backoff_ms" integer DEFAULT 250,
	"enabled" boolean DEFAULT true NOT NULL,
	"last_tested_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "external_destinations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"config" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "oauth_access_tokens" (
	"access_token" varchar PRIMARY KEY NOT NULL,
	"refresh_token" varchar,
	"client_id" varchar NOT NULL,
	"user_id" varchar,
	"workspace_id" uuid NOT NULL,
	"scope" jsonb,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_access_tokens_refresh_token_unique" UNIQUE("refresh_token")
);
--> statement-breakpoint
CREATE TABLE "oauth_apps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"client_id" varchar NOT NULL,
	"client_secret_hash" varchar NOT NULL,
	"redirect_uris" jsonb NOT NULL,
	"scopes" jsonb NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_apps_client_id_unique" UNIQUE("client_id")
);
--> statement-breakpoint
CREATE TABLE "oauth_auth_codes" (
	"code" varchar PRIMARY KEY NOT NULL,
	"client_id" varchar NOT NULL,
	"user_id" varchar NOT NULL,
	"scope" jsonb,
	"redirect_uri" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"key" varchar NOT NULL,
	"value" text,
	"value_enc" text NOT NULL,
	"type" "secret_type" DEFAULT 'api_key' NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"environment" varchar DEFAULT 'production',
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"event" varchar NOT NULL,
	"payload" jsonb NOT NULL,
	"status" varchar NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_attempt_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"target_url" varchar NOT NULL,
	"events" jsonb NOT NULL,
	"secret" varchar NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "billing_plans" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"price_monthly" integer DEFAULT 0 NOT NULL,
	"price_yearly" integer DEFAULT 0 NOT NULL,
	"features" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"limits" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"stripe_product_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "customer_billing_info" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"stripe_customer_id" varchar NOT NULL,
	"billing_email" varchar,
	"default_payment_method_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscription_seats" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"assigned_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"plan_id" uuid NOT NULL,
	"status" "subscription_status" DEFAULT 'active' NOT NULL,
	"stripe_subscription_id" varchar,
	"current_period_start" timestamp,
	"current_period_end" timestamp,
	"cancel_at_period_end" boolean DEFAULT false,
	"canceled_at" timestamp,
	"trial_start" timestamp,
	"trial_end" timestamp,
	"seat_quantity" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "usage_records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"metric" varchar NOT NULL,
	"quantity" integer DEFAULT 1 NOT NULL,
	"workflow_id" uuid,
	"metadata" jsonb,
	"recorded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_template_metadata" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_key" varchar(255) NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"subject_preview" text,
	"branding_tokens" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "email_template_metadata_template_key_unique" UNIQUE("template_key")
);
--> statement-breakpoint
CREATE TABLE "ai_settings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"scope" varchar DEFAULT 'global' NOT NULL,
	"system_prompt" text,
	"updated_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
ALTER TABLE "account_locks" ADD CONSTRAINT "account_locks_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "email_verification_tokens" ADD CONSTRAINT "email_verification_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_backup_codes" ADD CONSTRAINT "mfa_backup_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_secrets" ADD CONSTRAINT "mfa_secrets_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_user_id_users_id_fk" FOREIGN KEY ("invited_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_by_user_id_users_id_fk" FOREIGN KEY ("invited_by_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_created_by_user_id_users_id_fk" FOREIGN KEY ("created_by_user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "password_reset_tokens" ADD CONSTRAINT "password_reset_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "refresh_tokens" ADD CONSTRAINT "refresh_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_team_id_teams_id_fk" FOREIGN KEY ("team_id") REFERENCES "public"."teams"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "teams" ADD CONSTRAINT "teams_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "tenant_domains" ADD CONSTRAINT "tenant_domains_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "trusted_devices" ADD CONSTRAINT "trusted_devices_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_credentials" ADD CONSTRAINT "user_credentials_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_personalization_settings" ADD CONSTRAINT "user_personalization_settings_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_preferences" ADD CONSTRAINT "user_preferences_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "users" ADD CONSTRAINT "users_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspaces" ADD CONSTRAINT "workspaces_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_snapshots" ADD CONSTRAINT "collab_snapshots_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_updates" ADD CONSTRAINT "collab_updates_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "document_hooks" ADD CONSTRAINT "document_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_condition_step_id_steps_id_fk" FOREIGN KEY ("condition_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_step_id_steps_id_fk" FOREIGN KEY ("target_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_section_id_sections_id_fk" FOREIGN KEY ("target_section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "project_access" ADD CONSTRAINT "project_access_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sections" ADD CONSTRAINT "sections_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "steps" ADD CONSTRAINT "steps_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_last_modified_by_users_id_fk" FOREIGN KEY ("last_modified_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_access" ADD CONSTRAINT "workflow_access_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_source_workflow_id_workflows_id_fk" FOREIGN KEY ("source_workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_base_id_workflows_id_fk" FOREIGN KEY ("base_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_reviewer_id_users_id_fk" FOREIGN KEY ("reviewer_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_template_id_workflow_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."workflow_templates"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_logs" ADD CONSTRAINT "run_logs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "script_execution_log" ADD CONSTRAINT "script_execution_log_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_events" ADD CONSTRAINT "signature_events_signature_request_id_signature_requests_id_fk" FOREIGN KEY ("signature_request_id") REFERENCES "public"."signature_requests"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_step_id_steps_id_fk" FOREIGN KEY ("step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_block_id_transform_blocks_id_fk" FOREIGN KEY ("block_id") REFERENCES "public"."transform_blocks"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_current_section_id_sections_id_fk" FOREIGN KEY ("current_section_id") REFERENCES "public"."sections"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_subquestion_id_loop_group_subquestions_id_fk" FOREIGN KEY ("subquestion_id") REFERENCES "public"."loop_group_subquestions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_condition_question_id_questions_id_fk" FOREIGN KEY ("condition_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_question_id_questions_id_fk" FOREIGN KEY ("target_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_page_id_survey_pages_id_fk" FOREIGN KEY ("target_page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "files" ADD CONSTRAINT "files_answer_id_answers_id_fk" FOREIGN KEY ("answer_id") REFERENCES "public"."answers"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "loop_group_subquestions" ADD CONSTRAINT "loop_group_subquestions_loop_question_id_questions_id_fk" FOREIGN KEY ("loop_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "questions" ADD CONSTRAINT "questions_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "responses" ADD CONSTRAINT "responses_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_pages" ADD CONSTRAINT "survey_pages_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_templates" ADD CONSTRAINT "survey_templates_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_template_id_survey_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."survey_templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collection_fields" ADD CONSTRAINT "collection_fields_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collections" ADD CONSTRAINT "collections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_columns" ADD CONSTRAINT "datavault_columns_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_databases" ADD CONSTRAINT "datavault_databases_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_owner_user_id_users_id_fk" FOREIGN KEY ("owner_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "api_keys" ADD CONSTRAINT "api_keys_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "external_destinations" ADD CONSTRAINT "external_destinations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_apps" ADD CONSTRAINT "oauth_apps_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "secrets" ADD CONSTRAINT "secrets_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_events" ADD CONSTRAINT "webhook_events_subscription_id_webhook_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."webhook_subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_subscriptions" ADD CONSTRAINT "webhook_subscriptions_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "customer_billing_info" ADD CONSTRAINT "customer_billing_info_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_subscription_id_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_plan_id_billing_plans_id_fk" FOREIGN KEY ("plan_id") REFERENCES "public"."billing_plans"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_settings" ADD CONSTRAINT "ai_settings_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
CREATE INDEX "account_locks_user_idx" ON "account_locks" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "account_locks_until_idx" ON "account_locks" USING btree ("locked_until");--> statement-breakpoint
CREATE INDEX "audit_logs_tenant_idx" ON "audit_logs" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "audit_logs_user_idx" ON "audit_logs" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "audit_logs_action_idx" ON "audit_logs" USING btree ("action");--> statement-breakpoint
CREATE INDEX "email_verify_token_idx" ON "email_verification_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "email_verify_user_idx" ON "email_verification_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "login_attempts_email_idx" ON "login_attempts" USING btree ("email");--> statement-breakpoint
CREATE INDEX "login_attempts_timestamp_idx" ON "login_attempts" USING btree ("attempted_at");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_user_idx" ON "mfa_backup_codes" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_hash_idx" ON "mfa_backup_codes" USING btree ("code_hash");--> statement-breakpoint
CREATE INDEX "mfa_secrets_user_idx" ON "mfa_secrets" USING btree ("user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "org_invites_token_unique_idx" ON "organization_invites" USING btree ("token");--> statement-breakpoint
CREATE INDEX "idx_org_invites_org_email_status" ON "organization_invites" USING btree ("org_id","invited_email","status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_status" ON "organization_invites" USING btree ("status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_expires" ON "organization_invites" USING btree ("expires_at");--> statement-breakpoint
CREATE UNIQUE INDEX "org_membership_unique_idx" ON "organization_memberships" USING btree ("org_id","user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_org" ON "organization_memberships" USING btree ("org_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_user" ON "organization_memberships" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_role" ON "organization_memberships" USING btree ("role");--> statement-breakpoint
CREATE INDEX "idx_organizations_created_by" ON "organizations" USING btree ("created_by_user_id");--> statement-breakpoint
CREATE INDEX "idx_organizations_tenant" ON "organizations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "pwd_reset_token_idx" ON "password_reset_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "pwd_reset_user_idx" ON "password_reset_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_user_idx" ON "refresh_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_token_idx" ON "refresh_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "IDX_session_expire" ON "sessions" USING btree ("expire");--> statement-breakpoint
CREATE UNIQUE INDEX "team_members_idx" ON "team_members" USING btree ("team_id","user_id");--> statement-breakpoint
CREATE INDEX "teams_tenant_idx" ON "teams" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_tenant_idx" ON "tenant_domains" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_domain_idx" ON "tenant_domains" USING btree ("domain");--> statement-breakpoint
CREATE INDEX "tenants_plan_idx" ON "tenants" USING btree ("plan");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_idx" ON "trusted_devices" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "trusted_devices_fingerprint_idx" ON "trusted_devices" USING btree ("device_fingerprint");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_fingerprint_idx" ON "trusted_devices" USING btree ("user_id","device_fingerprint");--> statement-breakpoint
CREATE INDEX "user_credentials_user_idx" ON "user_credentials" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "users_email_idx" ON "users" USING btree ("email");--> statement-breakpoint
CREATE INDEX "users_tenant_idx" ON "users" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "users_tenant_email_idx" ON "users" USING btree ("tenant_id","email");--> statement-breakpoint
CREATE INDEX "idx_users_is_placeholder" ON "users" USING btree ("is_placeholder");--> statement-breakpoint
CREATE INDEX "idx_users_placeholder_email" ON "users" USING btree ("placeholder_email");--> statement-breakpoint
CREATE INDEX "invitation_token_idx" ON "workspace_invitations" USING btree ("token");--> statement-breakpoint
CREATE INDEX "invitation_ws_email_idx" ON "workspace_invitations" USING btree ("workspace_id","email");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_member_idx" ON "workspace_members" USING btree ("workspace_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_org_slug_idx" ON "workspaces" USING btree ("organization_id","slug");--> statement-breakpoint
CREATE INDEX "blocks_workflow_phase_order_idx" ON "blocks" USING btree ("workflow_id","phase","order");--> statement-breakpoint
CREATE INDEX "collab_docs_workflow_idx" ON "collab_docs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "collab_snapshots_doc_clock_idx" ON "collab_snapshots" USING btree ("doc_id","clock");--> statement-breakpoint
CREATE INDEX "collab_updates_doc_seq_idx" ON "collab_updates" USING btree ("doc_id","seq");--> statement-breakpoint
CREATE INDEX "logic_rules_workflow_idx" ON "logic_rules" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "project_access_project_idx" ON "project_access" USING btree ("project_id");--> statement-breakpoint
CREATE UNIQUE INDEX "project_access_principal_idx" ON "project_access" USING btree ("project_id","principal_type","principal_id");--> statement-breakpoint
CREATE INDEX "projects_tenant_idx" ON "projects" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "projects_created_by_idx" ON "projects" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "projects_creator_idx" ON "projects" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "projects_owner_idx" ON "projects" USING btree ("owner_id");--> statement-breakpoint
CREATE INDEX "idx_projects_owner" ON "projects" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "projects_status_idx" ON "projects" USING btree ("status");--> statement-breakpoint
CREATE INDEX "projects_archived_idx" ON "projects" USING btree ("archived");--> statement-breakpoint
CREATE INDEX "sections_workflow_idx" ON "sections" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "steps_section_idx" ON "steps" USING btree ("section_id");--> statement-breakpoint
CREATE UNIQUE INDEX "template_versions_unique_idx" ON "template_versions" USING btree ("template_id","version_number");--> statement-breakpoint
CREATE INDEX "templates_project_idx" ON "templates" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflow_access_workflow_idx" ON "workflow_access" USING btree ("workflow_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_access_principal_idx" ON "workflow_access" USING btree ("workflow_id","principal_type","principal_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_snapshots_workflow_name_unique" ON "workflow_snapshots" USING btree ("workflow_id","name");--> statement-breakpoint
CREATE INDEX "workflow_templates_version_key_unique" ON "workflow_templates" USING btree ("workflow_version_id","key");--> statement-breakpoint
CREATE INDEX "workflow_versions_workflow_idx" ON "workflow_versions" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_versions_version_number_idx" ON "workflow_versions" USING btree ("workflow_id","version_number");--> statement-breakpoint
CREATE INDEX "workflow_versions_is_draft_idx" ON "workflow_versions" USING btree ("is_draft");--> statement-breakpoint
CREATE INDEX "workflows_project_idx" ON "workflows" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflows_status_idx" ON "workflows" USING btree ("status");--> statement-breakpoint
CREATE INDEX "workflows_is_public_idx" ON "workflows" USING btree ("is_public");--> statement-breakpoint
CREATE INDEX "workflows_slug_idx" ON "workflows" USING btree ("slug");--> statement-breakpoint
CREATE INDEX "workflows_pinned_version_idx" ON "workflows" USING btree ("pinned_version_id");--> statement-breakpoint
CREATE INDEX "idx_workflows_owner" ON "workflows" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "ai_feedback_workflow_idx" ON "ai_workflow_feedback" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "bm_version_block_idx" ON "block_metrics" USING btree ("version_id","block_id");--> statement-breakpoint
CREATE INDEX "metrics_events_project_ts_idx" ON "metrics_events" USING btree ("project_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_workflow_ts_idx" ON "metrics_events" USING btree ("workflow_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_type_idx" ON "metrics_events" USING btree ("type");--> statement-breakpoint
CREATE UNIQUE INDEX "metrics_rollups_unique_idx" ON "metrics_rollups" USING btree ("tenant_id","project_id",COALESCE("workflow_id", '00000000-0000-0000-0000-000000000000'::uuid),"bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "metrics_rollups_project_bucket_idx" ON "metrics_rollups" USING btree ("project_id","bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "review_tasks_run_idx" ON "review_tasks" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "review_tasks_workflow_idx" ON "review_tasks" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "review_tasks_status_idx" ON "review_tasks" USING btree ("status");--> statement-breakpoint
CREATE INDEX "review_tasks_reviewer_idx" ON "review_tasks" USING btree ("reviewer_id");--> statement-breakpoint
CREATE INDEX "run_generated_documents_run_idx" ON "run_generated_documents" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_run_idx" ON "run_logs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_level_idx" ON "run_logs" USING btree ("level");--> statement-breakpoint
CREATE INDEX "run_logs_created_at_idx" ON "run_logs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "run_outputs_run_idx" ON "run_outputs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_outputs_run_template_type_idx" ON "run_outputs" USING btree ("run_id","template_key","file_type");--> statement-breakpoint
CREATE INDEX "runs_workflow_version_idx" ON "runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "runs_status_idx" ON "runs" USING btree ("status");--> statement-breakpoint
CREATE INDEX "runs_created_by_idx" ON "runs" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "runs_created_at_idx" ON "runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "script_execution_log_run_idx" ON "script_execution_log" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_events_request_idx" ON "signature_events" USING btree ("signature_request_id");--> statement-breakpoint
CREATE INDEX "signature_requests_run_idx" ON "signature_requests" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_requests_token_idx" ON "signature_requests" USING btree ("token");--> statement-breakpoint
CREATE INDEX "sli_configs_project_idx" ON "sli_configs" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "sli_windows_project_window_idx" ON "sli_windows" USING btree ("project_id","window_start","window_end");--> statement-breakpoint
CREATE INDEX "step_values_run_idx" ON "step_values" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "step_values_step_idx" ON "step_values" USING btree ("step_id");--> statement-breakpoint
CREATE INDEX "step_values_run_step_idx" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE UNIQUE INDEX "step_values_run_step_unique" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE INDEX "template_metrics_template_idx" ON "template_generation_metrics" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_metrics_run_idx" ON "template_generation_metrics" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_run_idx" ON "transform_block_runs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_block_idx" ON "transform_block_runs" USING btree ("block_id");--> statement-breakpoint
CREATE UNIQUE INDEX "was_workflow_version_date_idx" ON "workflow_analytics_snapshots" USING btree ("workflow_id","version_id","date");--> statement-breakpoint
CREATE INDEX "wre_run_idx" ON "workflow_run_events" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "wre_workflow_ts_idx" ON "workflow_run_events" USING btree ("workflow_id","timestamp");--> statement-breakpoint
CREATE INDEX "wrm_workflow_created_idx" ON "workflow_run_metrics" USING btree ("workflow_id","created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_workflow_idx" ON "workflow_runs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_version_idx" ON "workflow_runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_completed_idx" ON "workflow_runs" USING btree ("completed");--> statement-breakpoint
CREATE INDEX "workflow_runs_run_token_idx" ON "workflow_runs" USING btree ("run_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_share_token_idx" ON "workflow_runs" USING btree ("share_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_current_section_idx" ON "workflow_runs" USING btree ("current_section_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_created_at_idx" ON "workflow_runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_owner_idx" ON "workflow_runs" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "analytics_survey_event_idx" ON "analytics_events" USING btree ("survey_id","event");--> statement-breakpoint
CREATE INDEX "analytics_response_event_idx" ON "analytics_events" USING btree ("response_id","event");--> statement-breakpoint
CREATE INDEX "analytics_timestamp_idx" ON "analytics_events" USING btree ("timestamp");--> statement-breakpoint
CREATE INDEX "anonymous_tracking_survey_ip_idx" ON "anonymous_response_tracking" USING btree ("survey_id","ip_address");--> statement-breakpoint
CREATE INDEX "email_queue_status_idx" ON "email_queue" USING btree ("status");--> statement-breakpoint
CREATE INDEX "email_queue_next_attempt_idx" ON "email_queue" USING btree ("next_attempt_at");--> statement-breakpoint
CREATE INDEX "survey_templates_creator_idx" ON "survey_templates" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "survey_templates_system_idx" ON "survey_templates" USING btree ("is_system");--> statement-breakpoint
CREATE INDEX "surveys_public_link_unique_idx" ON "surveys" USING btree ("public_link");--> statement-breakpoint
CREATE INDEX "surveys_workspace_idx" ON "surveys" USING btree ("workspace_id");--> statement-breakpoint
CREATE INDEX "template_shares_template_idx" ON "template_shares" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_shares_user_idx" ON "template_shares" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "template_shares_pending_email_idx" ON "template_shares" USING btree ("pending_email");--> statement-breakpoint
CREATE INDEX "collection_fields_collection_idx" ON "collection_fields" USING btree ("collection_id");--> statement-breakpoint
CREATE UNIQUE INDEX "collection_fields_slug_unique" ON "collection_fields" USING btree ("collection_id","slug");--> statement-breakpoint
CREATE UNIQUE INDEX "collections_slug_unique" ON "collections" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_database_id" ON "datavault_api_tokens" USING btree ("database_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE INDEX "datavault_columns_table_idx" ON "datavault_columns" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_columns_reference_table_idx" ON "datavault_columns" USING btree ("reference_table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_columns_table_slug_unique" ON "datavault_columns" USING btree ("table_id","slug");--> statement-breakpoint
CREATE INDEX "idx_databases_tenant" ON "datavault_databases" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_databases_scope" ON "datavault_databases" USING btree ("scope_type","scope_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_databases_owner" ON "datavault_databases" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_tenant" ON "datavault_number_sequences" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_table" ON "datavault_number_sequences" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "idx_datavault_sequences_column_unique" ON "datavault_number_sequences" USING btree ("tenant_id","table_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_row_id" ON "datavault_row_notes" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_tenant_id" ON "datavault_row_notes" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_table_idx" ON "datavault_rows" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_created_by_idx" ON "datavault_rows" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "idx_table_permissions_table" ON "datavault_table_permissions" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_table_user_permission" ON "datavault_table_permissions" USING btree ("table_id","user_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_tenant_idx" ON "datavault_tables" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_owner_idx" ON "datavault_tables" USING btree ("owner_user_id");--> statement-breakpoint
CREATE INDEX "idx_tables_database" ON "datavault_tables" USING btree ("database_id","tenant_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_tables_tenant_slug_unique" ON "datavault_tables" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "datavault_values_row_idx" ON "datavault_values" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "datavault_values_column_idx" ON "datavault_values" USING btree ("column_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_values_row_column_unique" ON "datavault_values" USING btree ("row_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_writeback_mappings_workflow" ON "datavault_writeback_mappings" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "records_collection_idx" ON "records" USING btree ("collection_id");--> statement-breakpoint
CREATE INDEX "records_tenant_idx" ON "records" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_data_sources_workflow" ON "workflow_data_sources" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_queries_workflow" ON "workflow_queries" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "api_keys_project_idx" ON "api_keys" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_tenant_idx" ON "connections" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "connections_project_idx" ON "connections" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_project_name_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "connections_type_idx" ON "connections" USING btree ("type");--> statement-breakpoint
CREATE INDEX "connections_enabled_idx" ON "connections" USING btree ("enabled");--> statement-breakpoint
CREATE UNIQUE INDEX "connections_project_name_unique_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "ext_dest_tenant_idx" ON "external_destinations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_client_id_idx" ON "oauth_apps" USING btree ("client_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_workspace_idx" ON "oauth_apps" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "secrets_project_key_env_unique" ON "secrets" USING btree ("project_id","key","environment");--> statement-breakpoint
CREATE INDEX "webhook_events_sub_idx" ON "webhook_events" USING btree ("subscription_id");--> statement-breakpoint
CREATE INDEX "webhook_subs_workspace_idx" ON "webhook_subscriptions" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_org_idx" ON "customer_billing_info" USING btree ("organization_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_stripe_idx" ON "customer_billing_info" USING btree ("stripe_customer_id");--> statement-breakpoint
CREATE UNIQUE INDEX "seat_sub_user_idx" ON "subscription_seats" USING btree ("subscription_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "sub_org_idx" ON "subscriptions" USING btree ("organization_id");--> statement-breakpoint
CREATE INDEX "usage_org_metric_date_idx" ON "usage_records" USING btree ("organization_id","metric","recorded_at");--> statement-breakpoint
CREATE INDEX "email_templates_key_idx" ON "email_template_metadata" USING btree ("template_key");--> statement-breakpoint
CREATE INDEX "ai_settings_scope_idx" ON "ai_settings" USING btree ("scope");
params: 
ΓÜá∩╕Å Migrations failed (non-fatal if DB exists): DrizzleQueryError: Failed query: CREATE TYPE "public"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint
CREATE TYPE "public"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint
CREATE TYPE "public"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint
CREATE TYPE "public"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint
CREATE TYPE "public"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint
CREATE TYPE "public"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint
CREATE TYPE "public"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint
CREATE TYPE "public"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint
CREATE TYPE "public"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint
CREATE TYPE "public"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint
CREATE TYPE "public"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint
CREATE TYPE "public"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint
CREATE TYPE "public"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint
CREATE TYPE "public"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint
CREATE TYPE "public"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint
CREATE TYPE "public"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint
CREATE TYPE "public"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint
CREATE TYPE "public"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint
CREATE TYPE "public"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint
CREATE TYPE "public"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint
CREATE TYPE "public"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint
CREATE TYPE "public"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint
CREATE TYPE "public"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint
CREATE TYPE "public"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint
CREATE TYPE "public"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint
CREATE TYPE "public"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint
CREATE TYPE "public"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint
CREATE TYPE "public"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint
CREATE TYPE "public"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint
CREATE TYPE "public"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint
CREATE TYPE "public"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint
CREATE TYPE "public"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint
CREATE TYPE "public"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint
CREATE TYPE "public"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint
CREATE TYPE "public"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint
CREATE TYPE "public"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint
CREATE TYPE "public"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint
CREATE TYPE "public"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint
CREATE TYPE "public"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint
CREATE TYPE "public"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint
CREATE TYPE "public"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint
CREATE TYPE "public"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint
CREATE TYPE "public"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint
CREATE TYPE "public"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint
CREATE TABLE "account_locks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"locked_at" timestamp DEFAULT now() NOT NULL,
	"locked_until" timestamp NOT NULL,
	"reason" varchar(255),
	"unlocked" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "audit_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"workspace_id" uuid,
	"user_id" varchar,
	"action" varchar NOT NULL,
	"entity_type" varchar NOT NULL,
	"entity_id" varchar NOT NULL,
	"resource_type" varchar,
	"resource_id" varchar,
	"changes" jsonb,
	"details" jsonb,
	"ip_address" varchar,
	"user_agent" text,
	"created_at" timestamp DEFAULT now(),
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_verification_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "login_attempts" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"ip_address" varchar(45),
	"successful" boolean DEFAULT false NOT NULL,
	"attempted_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_backup_codes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"code_hash" text NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"secret" text NOT NULL,
	"enabled" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"enabled_at" timestamp,
	CONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "organization_invites" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"invited_email" varchar(255) NOT NULL,
	"invited_user_id" varchar,
	"invited_by_user_id" varchar NOT NULL,
	"token" varchar(255) NOT NULL,
	"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp NOT NULL,
	"accepted_at" timestamp,
	"email_sent_at" timestamp,
	"email_failed" boolean DEFAULT false,
	"email_error" text,
	CONSTRAINT "organization_invites_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "organization_memberships" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "organization_role" DEFAULT 'member' NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "organizations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"slug" varchar,
	"domain" varchar,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"tenant_id" uuid NOT NULL,
	"created_by_user_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "organizations_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "password_reset_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "portal_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "portal_tokens_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "refresh_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"revoked" boolean DEFAULT false NOT NULL,
	"metadata" jsonb,
	"device_name" varchar(255),
	"ip_address" varchar(45),
	"location" varchar(255),
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sessions" (
	"sid" varchar PRIMARY KEY NOT NULL,
	"sess" jsonb NOT NULL,
	"expire" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE "team_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"team_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" varchar(50) DEFAULT 'member' NOT NULL,
	"joined_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "teams" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "tenant_domains" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"domain" text NOT NULL,
	"verified" boolean DEFAULT false,
	"verification_token" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "tenant_domains_domain_unique" UNIQUE("domain")
);
--> statement-breakpoint
CREATE TABLE "tenants" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar(255) NOT NULL,
	"billing_email" varchar(255),
	"plan" "tenant_plan" DEFAULT 'free' NOT NULL,
	"mfa_required" boolean DEFAULT false NOT NULL,
	"branding" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "trusted_devices" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"device_fingerprint" varchar(255) NOT NULL,
	"device_name" varchar(255),
	"trusted_until" timestamp NOT NULL,
	"ip_address" varchar(45),
	"location" varchar(255),
	"user_agent" text,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"last_used_at" timestamp,
	"revoked" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "user_credentials" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"password_hash" text NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "user_credentials_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "user_personalization_settings" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"reading_level" varchar DEFAULT 'standard' NOT NULL,
	"tone" varchar DEFAULT 'neutral' NOT NULL,
	"verbosity" varchar DEFAULT 'standard' NOT NULL,
	"language" varchar DEFAULT 'en' NOT NULL,
	"allow_adaptive_prompts" boolean DEFAULT true NOT NULL,
	"allow_ai_clarification" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "user_preferences" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"settings" jsonb DEFAULT '{"celebrationEffects":true,"darkMode":"system","aiHints":true}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "users" (
	"id" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"full_name" varchar(255),
	"first_name" varchar(255),
	"last_name" varchar(255),
	"profile_image_url" varchar(500),
	"tenant_id" uuid,
	"role" "user_role" DEFAULT 'creator' NOT NULL,
	"tenant_role" "user_tenant_role",
	"auth_provider" "auth_provider" DEFAULT 'local' NOT NULL,
	"default_mode" text DEFAULT 'easy' NOT NULL,
	"email_verified" boolean DEFAULT false NOT NULL,
	"mfa_enabled" boolean DEFAULT false NOT NULL,
	"last_password_change" timestamp,
	"is_placeholder" boolean DEFAULT false NOT NULL,
	"placeholder_email" varchar(255),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_invitations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"email" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"invited_by" varchar NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"joined_at" timestamp DEFAULT now(),
	"invited_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workspaces" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"slug" varchar NOT NULL,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"type" "block_type" NOT NULL,
	"phase" "block_phase" NOT NULL,
	"config" jsonb NOT NULL,
	"virtual_step_id" uuid,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_docs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid,
	"tenant_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"clock" integer NOT NULL,
	"state" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "collab_updates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"seq" integer NOT NULL,
	"update" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "document_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"final_block_document_id" varchar(255),
	"name" varchar(255) NOT NULL,
	"phase" "document_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 3000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "lifecycle_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar(255) NOT NULL,
	"phase" "lifecycle_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"virtual_step_ids" uuid[] DEFAULT '{}'::uuid[],
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"mutation_mode" boolean DEFAULT false,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "logic_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"condition_step_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_type" "logic_rule_target_type" NOT NULL,
	"target_step_id" uuid,
	"target_section_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "project_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "projects" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"name" varchar(255),
	"description" text,
	"creator_id" varchar NOT NULL,
	"tenant_id" uuid,
	"created_by" varchar,
	"owner_id" varchar NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"status" "project_status" DEFAULT 'active' NOT NULL,
	"archived" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"order" integer NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"visible_if" jsonb,
	"skip_if" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "steps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"section_id" uuid NOT NULL,
	"type" "step_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"alias" text,
	"default_value" jsonb,
	"order" integer NOT NULL,
	"is_virtual" boolean DEFAULT false NOT NULL,
	"visible_if" jsonb,
	"repeater_config" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"version_number" integer NOT NULL,
	"file_ref" varchar(500) NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"notes" text,
	"is_active" boolean DEFAULT true
);
--> statement-breakpoint
CREATE TABLE "templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"file_ref" varchar(500) NOT NULL,
	"type" "template_type" NOT NULL,
	"helpers_version" integer DEFAULT 1 NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"current_version" integer DEFAULT 1,
	"last_modified_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_key" varchar NOT NULL,
	"virtual_step_id" uuid,
	"phase" "block_phase" DEFAULT 'onSectionSubmit' NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_blueprints" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"creator_id" varchar NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"graph_json" jsonb NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"source_workflow_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"name" text NOT NULL,
	"values" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"workflow_version_id" uuid,
	"version_hash" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_id" uuid NOT NULL,
	"key" text NOT NULL,
	"is_primary" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"base_id" uuid,
	"version_number" integer DEFAULT 1 NOT NULL,
	"is_draft" boolean DEFAULT false NOT NULL,
	"graph_json" jsonb NOT NULL,
	"migration_info" jsonb,
	"changelog" jsonb,
	"notes" text,
	"checksum" text,
	"created_by" varchar NOT NULL,
	"published" boolean DEFAULT false NOT NULL,
	"published_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"description" text,
	"creator_id" varchar,
	"owner_id" varchar,
	"mode_override" text,
	"public_link" text,
	"name" varchar(255),
	"project_id" uuid,
	"current_version_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"slug" text,
	"require_login" boolean DEFAULT false NOT NULL,
	"intake_config" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"pinned_version_id" uuid,
	"status" "workflow_status" DEFAULT 'draft' NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"source_blueprint_id" uuid,
	CONSTRAINT "workflows_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "ai_workflow_feedback" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid,
	"user_id" varchar,
	"operation_type" varchar NOT NULL,
	"rating" integer NOT NULL,
	"comment" text,
	"ai_provider" varchar,
	"ai_model" varchar,
	"prompt_version" varchar,
	"quality_score" integer,
	"quality_passed" boolean,
	"issues_count" integer,
	"request_description" text,
	"generated_sections" integer,
	"generated_steps" integer,
	"was_edited" boolean DEFAULT false,
	"edit_count" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "block_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"block_id" varchar NOT NULL,
	"total_visits" integer DEFAULT 0,
	"avg_time_ms" integer DEFAULT 0,
	"dropoff_count" integer DEFAULT 0,
	"validation_error_count" integer DEFAULT 0,
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"run_id" uuid,
	"type" "metrics_event_type" NOT NULL,
	"ts" timestamp with time zone DEFAULT now() NOT NULL,
	"duration_ms" integer,
	"payload" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_rollups" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"bucket_start" timestamp with time zone NOT NULL,
	"bucket" "rollup_bucket" NOT NULL,
	"runs_count" integer DEFAULT 0 NOT NULL,
	"runs_success" integer DEFAULT 0 NOT NULL,
	"runs_error" integer DEFAULT 0 NOT NULL,
	"dur_p50" integer,
	"dur_p95" integer,
	"pdf_success" integer DEFAULT 0 NOT NULL,
	"pdf_error" integer DEFAULT 0 NOT NULL,
	"docx_success" integer DEFAULT 0 NOT NULL,
	"docx_error" integer DEFAULT 0 NOT NULL,
	"queue_enqueued" integer DEFAULT 0 NOT NULL,
	"queue_dequeued" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "review_tasks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"status" "review_task_status" DEFAULT 'pending' NOT NULL,
	"reviewer_id" varchar,
	"reviewer_email" varchar(255),
	"message" text,
	"comment" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"resolved_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "run_generated_documents" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"file_name" text NOT NULL,
	"file_url" text NOT NULL,
	"mime_type" text,
	"file_size" integer,
	"template_id" uuid,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"node_id" varchar(100),
	"level" "log_level" NOT NULL,
	"message" text NOT NULL,
	"context" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_outputs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_key" text NOT NULL,
	"file_type" "output_file_type" NOT NULL,
	"storage_path" text NOT NULL,
	"status" "output_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"input_json" jsonb,
	"output_refs" jsonb,
	"trace" jsonb,
	"status" "run_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"duration_ms" integer,
	"run_token" varchar,
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "script_execution_log" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"script_type" varchar(50) NOT NULL,
	"script_id" uuid NOT NULL,
	"script_name" varchar(255),
	"phase" varchar(50),
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "script_execution_status" NOT NULL,
	"error_message" text,
	"console_output" jsonb,
	"input_sample" jsonb,
	"output_sample" jsonb,
	"duration_ms" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "signature_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"signature_request_id" uuid NOT NULL,
	"type" "signature_event_type" NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb
);
--> statement-breakpoint
CREATE TABLE "signature_requests" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"signer_email" varchar(255) NOT NULL,
	"signer_name" varchar(255),
	"status" "signature_request_status" DEFAULT 'pending' NOT NULL,
	"provider" "signature_provider" DEFAULT 'native' NOT NULL,
	"provider_request_id" text,
	"token" text NOT NULL,
	"document_url" text,
	"redirect_url" text,
	"message" text,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"signed_at" timestamp,
	CONSTRAINT "signature_requests_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "sli_configs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"target_success_pct" integer DEFAULT 99 NOT NULL,
	"target_p95_ms" integer DEFAULT 5000 NOT NULL,
	"error_budget_pct" integer DEFAULT 1 NOT NULL,
	"window" "sli_window" DEFAULT '7d' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sli_windows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"window_start" timestamp with time zone NOT NULL,
	"window_end" timestamp with time zone NOT NULL,
	"success_pct" integer,
	"p95_ms" integer,
	"error_budget_burn_pct" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "step_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"step_id" uuid NOT NULL,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_generation_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"run_id" uuid,
	"result" varchar(50) NOT NULL,
	"duration_ms" integer,
	"error_message" text,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_block_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"block_id" uuid NOT NULL,
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "transform_block_run_status" NOT NULL,
	"error_message" text,
	"output_sample" jsonb
);
--> statement-breakpoint
CREATE TABLE "workflow_analytics_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"date" timestamp NOT NULL,
	"summary" jsonb NOT NULL,
	"dropoff" jsonb NOT NULL,
	"branching" jsonb NOT NULL,
	"heatmap" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_run_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"block_id" varchar,
	"page_id" uuid,
	"type" varchar NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb,
	"is_preview" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_run_metrics" (
	"run_id" uuid PRIMARY KEY NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"total_time_ms" integer,
	"pages_visited" integer DEFAULT 0,
	"blocks_visited" integer DEFAULT 0,
	"validation_errors" integer DEFAULT 0,
	"script_errors" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"is_preview" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"workflow_version_id" uuid,
	"run_token" text NOT NULL,
	"created_by" text,
	"current_section_id" uuid,
	"progress" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"metadata" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"client_email" varchar,
	"portal_access_key" varchar,
	"access_mode" "portal_access_mode" DEFAULT 'anonymous',
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"owner_type" varchar(50),
	"owner_uuid" uuid,
	CONSTRAINT "workflow_runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "workflow_runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "analytics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"survey_id" uuid NOT NULL,
	"page_id" uuid,
	"question_id" uuid,
	"event" varchar NOT NULL,
	"data" jsonb,
	"duration" integer,
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "anonymous_response_tracking" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"ip_address" varchar NOT NULL,
	"session_id" varchar,
	"response_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "answers" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"question_id" uuid NOT NULL,
	"subquestion_id" uuid,
	"loop_index" integer,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "conditional_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"condition_question_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_question_id" uuid,
	"target_page_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_queue" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"to" varchar NOT NULL,
	"subject" varchar NOT NULL,
	"html" text NOT NULL,
	"status" "email_queue_status" DEFAULT 'pending' NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_error" text,
	"next_attempt_at" timestamp DEFAULT now(),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "files" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"answer_id" uuid NOT NULL,
	"filename" varchar NOT NULL,
	"original_name" varchar NOT NULL,
	"mime_type" varchar NOT NULL,
	"size" integer NOT NULL,
	"uploaded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "loop_group_subquestions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"loop_question_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "questions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"page_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"conditional_logic" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "responses" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"completed" boolean DEFAULT false,
	"submitted_at" timestamp,
	"is_anonymous" boolean DEFAULT false,
	"ip_address" varchar,
	"user_agent" text,
	"session_id" varchar,
	"anonymous_metadata" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_pages" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" text NOT NULL,
	"description" text,
	"content" jsonb NOT NULL,
	"creator_id" varchar,
	"is_system" boolean DEFAULT false NOT NULL,
	"tags" text[] DEFAULT ARRAY[]::text[],
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "surveys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"creator_id" varchar NOT NULL,
	"workspace_id" uuid,
	"status" "survey_status" DEFAULT 'draft' NOT NULL,
	"allow_anonymous" boolean DEFAULT false,
	"anonymous_access_type" "anonymous_access_type" DEFAULT 'unlimited',
	"public_link" varchar,
	"anonymous_config" jsonb,
	"is_public" boolean DEFAULT false,
	"public_access_mode" "public_access_mode" DEFAULT 'link_only',
	"public_slug" varchar,
	"allowed_domains" jsonb,
	"public_settings" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "surveys_public_link_unique" UNIQUE("public_link"),
	CONSTRAINT "surveys_public_slug_unique" UNIQUE("public_slug")
);
--> statement-breakpoint
CREATE TABLE "template_shares" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"user_id" varchar,
	"pending_email" text,
	"access" "template_access" DEFAULT 'use' NOT NULL,
	"invited_at" timestamp with time zone DEFAULT now(),
	"accepted_at" timestamp with time zone
);
--> statement-breakpoint
CREATE TABLE "collection_fields" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"collection_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"type" varchar(50) NOT NULL,
	"options" jsonb,
	"required" boolean DEFAULT false,
	"order" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_api_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"database_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"label" text NOT NULL,
	"token_hash" text NOT NULL,
	"scopes" text[] DEFAULT ARRAY[]::text[] NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "datavault_columns" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"type" "datavault_column_type" NOT NULL,
	"description" text,
	"width_px" integer DEFAULT 150,
	"required" boolean DEFAULT false NOT NULL,
	"is_primary_key" boolean DEFAULT false NOT NULL,
	"is_unique" boolean DEFAULT false NOT NULL,
	"order_index" integer DEFAULT 0 NOT NULL,
	"auto_number_start" integer DEFAULT 1,
	"autonumber_prefix" text,
	"autonumber_padding" integer DEFAULT 4,
	"autonumber_reset_policy" "autonumber_reset_policy" DEFAULT 'never',
	"reference_table_id" uuid,
	"reference_display_column_slug" text,
	"options" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_databases" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"type" "data_source_type" DEFAULT 'native' NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"scope_type" "datavault_scope_type" DEFAULT 'account' NOT NULL,
	"scope_id" uuid,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_number_sequences" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"prefix" text,
	"padding" integer DEFAULT 4 NOT NULL,
	"next_value" integer DEFAULT 1 NOT NULL,
	"reset_policy" "autonumber_reset_policy" DEFAULT 'never' NOT NULL,
	"last_reset" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_row_notes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"text" text NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_rows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"deleted_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "datavault_table_permissions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "datavault_table_role" NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_tables" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"owner_user_id" varchar,
	"database_id" uuid,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"value" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_writeback_mappings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_mappings" jsonb NOT NULL,
	"trigger_phase" varchar(50) DEFAULT 'afterComplete' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar
);
--> statement-breakpoint
CREATE TABLE "records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"collection_id" uuid NOT NULL,
	"data" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workflow_data_sources" (
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "workflow_data_sources_workflow_id_data_source_id_pk" PRIMARY KEY("workflow_id","data_source_id")
);
--> statement-breakpoint
CREATE TABLE "workflow_queries" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"filters" jsonb DEFAULT '[]'::jsonb,
	"sort" jsonb DEFAULT '[]'::jsonb,
	"limit" integer,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "api_keys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"prefix" varchar(50) NOT NULL,
	"key_hash" varchar(255) NOT NULL,
	"scopes" text[] NOT NULL,
	"name" varchar NOT NULL,
	"expires_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "api_keys_key_hash_unique" UNIQUE("key_hash")
);
--> statement-breakpoint
CREATE TABLE "connections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"type" "connection_type" NOT NULL,
	"base_url" varchar(500),
	"auth_config" jsonb DEFAULT '{}'::jsonb,
	"secret_refs" jsonb DEFAULT '{}'::jsonb,
	"oauth_state" jsonb,
	"default_headers" jsonb DEFAULT '{}'::jsonb,
	"timeout_ms" integer DEFAULT 8000,
	"retries" integer DEFAULT 2,
	"backoff_ms" integer DEFAULT 250,
	"enabled" boolean DEFAULT true NOT NULL,
	"last_tested_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "external_destinations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"config" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "oauth_access_tokens" (
	"access_token" varchar PRIMARY KEY NOT NULL,
	"refresh_token" varchar,
	"client_id" varchar NOT NULL,
	"user_id" varchar,
	"workspace_id" uuid NOT NULL,
	"scope" jsonb,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_access_tokens_refresh_token_unique" UNIQUE("refresh_token")
);
--> statement-breakpoint
CREATE TABLE "oauth_apps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"client_id" varchar NOT NULL,
	"client_secret_hash" varchar NOT NULL,
	"redirect_uris" jsonb NOT NULL,
	"scopes" jsonb NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_apps_client_id_unique" UNIQUE("client_id")
);
--> statement-breakpoint
CREATE TABLE "oauth_auth_codes" (
	"code" varchar PRIMARY KEY NOT NULL,
	"client_id" varchar NOT NULL,
	"user_id" varchar NOT NULL,
	"scope" jsonb,
	"redirect_uri" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"key" varchar NOT NULL,
	"value" text,
	"value_enc" text NOT NULL,
	"type" "secret_type" DEFAULT 'api_key' NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"environment" varchar DEFAULT 'production',
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"event" varchar NOT NULL,
	"payload" jsonb NOT NULL,
	"status" varchar NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_attempt_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"target_url" varchar NOT NULL,
	"events" jsonb NOT NULL,
	"secret" varchar NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "billing_plans" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"price_monthly" integer DEFAULT 0 NOT NULL,
	"price_yearly" integer DEFAULT 0 NOT NULL,
	"features" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"limits" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"stripe_product_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "customer_billing_info" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"stripe_customer_id" varchar NOT NULL,
	"billing_email" varchar,
	"default_payment_method_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscription_seats" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"assigned_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"plan_id" uuid NOT NULL,
	"status" "subscription_status" DEFAULT 'active' NOT NULL,
	"stripe_subscription_id" varchar,
	"current_period_start" timestamp,
	"current_period_end" timestamp,
	"cancel_at_period_end" boolean DEFAULT false,
	"canceled_at" timestamp,
	"trial_start" timestamp,
	"trial_end" timestamp,
	"seat_quantity" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "usage_records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"metric" varchar NOT NULL,
	"quantity" integer DEFAULT 1 NOT NULL,
	"workflow_id" uuid,
	"metadata" jsonb,
	"recorded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_template_metadata" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_key" varchar(255) NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"subject_preview" text,
	"branding_tokens" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "email_template_metadata_template_key_unique" UNIQUE("template_key")
);
--> statement-breakpoint
CREATE TABLE "ai_settings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"scope" varchar DEFAULT 'global' NOT NULL,
	"system_prompt" text,
	"updated_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
ALTER TABLE "account_locks" ADD CONSTRAINT "account_locks_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "email_verification_tokens" ADD CONSTRAINT "email_verification_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_backup_codes" ADD CONSTRAINT "mfa_backup_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_secrets" ADD CONSTRAINT "mfa_secrets_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_user_id_users_id_fk" FOREIGN KEY ("invited_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_by_user_id_users_id_fk" FOREIGN KEY ("invited_by_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_created_by_user_id_users_id_fk" FOREIGN KEY ("created_by_user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "password_reset_tokens" ADD CONSTRAINT "password_reset_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "refresh_tokens" ADD CONSTRAINT "refresh_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_team_id_teams_id_fk" FOREIGN KEY ("team_id") REFERENCES "public"."teams"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "teams" ADD CONSTRAINT "teams_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "tenant_domains" ADD CONSTRAINT "tenant_domains_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "trusted_devices" ADD CONSTRAINT "trusted_devices_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_credentials" ADD CONSTRAINT "user_credentials_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_personalization_settings" ADD CONSTRAINT "user_personalization_settings_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_preferences" ADD CONSTRAINT "user_preferences_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "users" ADD CONSTRAINT "users_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspaces" ADD CONSTRAINT "workspaces_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_snapshots" ADD CONSTRAINT "collab_snapshots_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_updates" ADD CONSTRAINT "collab_updates_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "document_hooks" ADD CONSTRAINT "document_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_condition_step_id_steps_id_fk" FOREIGN KEY ("condition_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_step_id_steps_id_fk" FOREIGN KEY ("target_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_section_id_sections_id_fk" FOREIGN KEY ("target_section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "project_access" ADD CONSTRAINT "project_access_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sections" ADD CONSTRAINT "sections_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "steps" ADD CONSTRAINT "steps_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_last_modified_by_users_id_fk" FOREIGN KEY ("last_modified_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_access" ADD CONSTRAINT "workflow_access_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_source_workflow_id_workflows_id_fk" FOREIGN KEY ("source_workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_base_id_workflows_id_fk" FOREIGN KEY ("base_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_reviewer_id_users_id_fk" FOREIGN KEY ("reviewer_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_template_id_workflow_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."workflow_templates"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_logs" ADD CONSTRAINT "run_logs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "script_execution_log" ADD CONSTRAINT "script_execution_log_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_events" ADD CONSTRAINT "signature_events_signature_request_id_signature_requests_id_fk" FOREIGN KEY ("signature_request_id") REFERENCES "public"."signature_requests"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_step_id_steps_id_fk" FOREIGN KEY ("step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_block_id_transform_blocks_id_fk" FOREIGN KEY ("block_id") REFERENCES "public"."transform_blocks"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_current_section_id_sections_id_fk" FOREIGN KEY ("current_section_id") REFERENCES "public"."sections"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_subquestion_id_loop_group_subquestions_id_fk" FOREIGN KEY ("subquestion_id") REFERENCES "public"."loop_group_subquestions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_condition_question_id_questions_id_fk" FOREIGN KEY ("condition_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_question_id_questions_id_fk" FOREIGN KEY ("target_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_page_id_survey_pages_id_fk" FOREIGN KEY ("target_page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "files" ADD CONSTRAINT "files_answer_id_answers_id_fk" FOREIGN KEY ("answer_id") REFERENCES "public"."answers"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "loop_group_subquestions" ADD CONSTRAINT "loop_group_subquestions_loop_question_id_questions_id_fk" FOREIGN KEY ("loop_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "questions" ADD CONSTRAINT "questions_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "responses" ADD CONSTRAINT "responses_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_pages" ADD CONSTRAINT "survey_pages_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_templates" ADD CONSTRAINT "survey_templates_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_template_id_survey_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."survey_templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collection_fields" ADD CONSTRAINT "collection_fields_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collections" ADD CONSTRAINT "collections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_columns" ADD CONSTRAINT "datavault_columns_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_databases" ADD CONSTRAINT "datavault_databases_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_owner_user_id_users_id_fk" FOREIGN KEY ("owner_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "api_keys" ADD CONSTRAINT "api_keys_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "external_destinations" ADD CONSTRAINT "external_destinations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_apps" ADD CONSTRAINT "oauth_apps_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "secrets" ADD CONSTRAINT "secrets_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_events" ADD CONSTRAINT "webhook_events_subscription_id_webhook_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."webhook_subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_subscriptions" ADD CONSTRAINT "webhook_subscriptions_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "customer_billing_info" ADD CONSTRAINT "customer_billing_info_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_subscription_id_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_plan_id_billing_plans_id_fk" FOREIGN KEY ("plan_id") REFERENCES "public"."billing_plans"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_settings" ADD CONSTRAINT "ai_settings_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
CREATE INDEX "account_locks_user_idx" ON "account_locks" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "account_locks_until_idx" ON "account_locks" USING btree ("locked_until");--> statement-breakpoint
CREATE INDEX "audit_logs_tenant_idx" ON "audit_logs" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "audit_logs_user_idx" ON "audit_logs" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "audit_logs_action_idx" ON "audit_logs" USING btree ("action");--> statement-breakpoint
CREATE INDEX "email_verify_token_idx" ON "email_verification_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "email_verify_user_idx" ON "email_verification_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "login_attempts_email_idx" ON "login_attempts" USING btree ("email");--> statement-breakpoint
CREATE INDEX "login_attempts_timestamp_idx" ON "login_attempts" USING btree ("attempted_at");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_user_idx" ON "mfa_backup_codes" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_hash_idx" ON "mfa_backup_codes" USING btree ("code_hash");--> statement-breakpoint
CREATE INDEX "mfa_secrets_user_idx" ON "mfa_secrets" USING btree ("user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "org_invites_token_unique_idx" ON "organization_invites" USING btree ("token");--> statement-breakpoint
CREATE INDEX "idx_org_invites_org_email_status" ON "organization_invites" USING btree ("org_id","invited_email","status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_status" ON "organization_invites" USING btree ("status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_expires" ON "organization_invites" USING btree ("expires_at");--> statement-breakpoint
CREATE UNIQUE INDEX "org_membership_unique_idx" ON "organization_memberships" USING btree ("org_id","user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_org" ON "organization_memberships" USING btree ("org_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_user" ON "organization_memberships" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_role" ON "organization_memberships" USING btree ("role");--> statement-breakpoint
CREATE INDEX "idx_organizations_created_by" ON "organizations" USING btree ("created_by_user_id");--> statement-breakpoint
CREATE INDEX "idx_organizations_tenant" ON "organizations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "pwd_reset_token_idx" ON "password_reset_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "pwd_reset_user_idx" ON "password_reset_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_user_idx" ON "refresh_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_token_idx" ON "refresh_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "IDX_session_expire" ON "sessions" USING btree ("expire");--> statement-breakpoint
CREATE UNIQUE INDEX "team_members_idx" ON "team_members" USING btree ("team_id","user_id");--> statement-breakpoint
CREATE INDEX "teams_tenant_idx" ON "teams" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_tenant_idx" ON "tenant_domains" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_domain_idx" ON "tenant_domains" USING btree ("domain");--> statement-breakpoint
CREATE INDEX "tenants_plan_idx" ON "tenants" USING btree ("plan");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_idx" ON "trusted_devices" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "trusted_devices_fingerprint_idx" ON "trusted_devices" USING btree ("device_fingerprint");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_fingerprint_idx" ON "trusted_devices" USING btree ("user_id","device_fingerprint");--> statement-breakpoint
CREATE INDEX "user_credentials_user_idx" ON "user_credentials" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "users_email_idx" ON "users" USING btree ("email");--> statement-breakpoint
CREATE INDEX "users_tenant_idx" ON "users" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "users_tenant_email_idx" ON "users" USING btree ("tenant_id","email");--> statement-breakpoint
CREATE INDEX "idx_users_is_placeholder" ON "users" USING btree ("is_placeholder");--> statement-breakpoint
CREATE INDEX "idx_users_placeholder_email" ON "users" USING btree ("placeholder_email");--> statement-breakpoint
CREATE INDEX "invitation_token_idx" ON "workspace_invitations" USING btree ("token");--> statement-breakpoint
CREATE INDEX "invitation_ws_email_idx" ON "workspace_invitations" USING btree ("workspace_id","email");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_member_idx" ON "workspace_members" USING btree ("workspace_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_org_slug_idx" ON "workspaces" USING btree ("organization_id","slug");--> statement-breakpoint
CREATE INDEX "blocks_workflow_phase_order_idx" ON "blocks" USING btree ("workflow_id","phase","order");--> statement-breakpoint
CREATE INDEX "collab_docs_workflow_idx" ON "collab_docs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "collab_snapshots_doc_clock_idx" ON "collab_snapshots" USING btree ("doc_id","clock");--> statement-breakpoint
CREATE INDEX "collab_updates_doc_seq_idx" ON "collab_updates" USING btree ("doc_id","seq");--> statement-breakpoint
CREATE INDEX "logic_rules_workflow_idx" ON "logic_rules" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "project_access_project_idx" ON "project_access" USING btree ("project_id");--> statement-breakpoint
CREATE UNIQUE INDEX "project_access_principal_idx" ON "project_access" USING btree ("project_id","principal_type","principal_id");--> statement-breakpoint
CREATE INDEX "projects_tenant_idx" ON "projects" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "projects_created_by_idx" ON "projects" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "projects_creator_idx" ON "projects" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "projects_owner_idx" ON "projects" USING btree ("owner_id");--> statement-breakpoint
CREATE INDEX "idx_projects_owner" ON "projects" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "projects_status_idx" ON "projects" USING btree ("status");--> statement-breakpoint
CREATE INDEX "projects_archived_idx" ON "projects" USING btree ("archived");--> statement-breakpoint
CREATE INDEX "sections_workflow_idx" ON "sections" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "steps_section_idx" ON "steps" USING btree ("section_id");--> statement-breakpoint
CREATE UNIQUE INDEX "template_versions_unique_idx" ON "template_versions" USING btree ("template_id","version_number");--> statement-breakpoint
CREATE INDEX "templates_project_idx" ON "templates" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflow_access_workflow_idx" ON "workflow_access" USING btree ("workflow_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_access_principal_idx" ON "workflow_access" USING btree ("workflow_id","principal_type","principal_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_snapshots_workflow_name_unique" ON "workflow_snapshots" USING btree ("workflow_id","name");--> statement-breakpoint
CREATE INDEX "workflow_templates_version_key_unique" ON "workflow_templates" USING btree ("workflow_version_id","key");--> statement-breakpoint
CREATE INDEX "workflow_versions_workflow_idx" ON "workflow_versions" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_versions_version_number_idx" ON "workflow_versions" USING btree ("workflow_id","version_number");--> statement-breakpoint
CREATE INDEX "workflow_versions_is_draft_idx" ON "workflow_versions" USING btree ("is_draft");--> statement-breakpoint
CREATE INDEX "workflows_project_idx" ON "workflows" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflows_status_idx" ON "workflows" USING btree ("status");--> statement-breakpoint
CREATE INDEX "workflows_is_public_idx" ON "workflows" USING btree ("is_public");--> statement-breakpoint
CREATE INDEX "workflows_slug_idx" ON "workflows" USING btree ("slug");--> statement-breakpoint
CREATE INDEX "workflows_pinned_version_idx" ON "workflows" USING btree ("pinned_version_id");--> statement-breakpoint
CREATE INDEX "idx_workflows_owner" ON "workflows" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "ai_feedback_workflow_idx" ON "ai_workflow_feedback" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "bm_version_block_idx" ON "block_metrics" USING btree ("version_id","block_id");--> statement-breakpoint
CREATE INDEX "metrics_events_project_ts_idx" ON "metrics_events" USING btree ("project_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_workflow_ts_idx" ON "metrics_events" USING btree ("workflow_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_type_idx" ON "metrics_events" USING btree ("type");--> statement-breakpoint
CREATE UNIQUE INDEX "metrics_rollups_unique_idx" ON "metrics_rollups" USING btree ("tenant_id","project_id",COALESCE("workflow_id", '00000000-0000-0000-0000-000000000000'::uuid),"bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "metrics_rollups_project_bucket_idx" ON "metrics_rollups" USING btree ("project_id","bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "review_tasks_run_idx" ON "review_tasks" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "review_tasks_workflow_idx" ON "review_tasks" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "review_tasks_status_idx" ON "review_tasks" USING btree ("status");--> statement-breakpoint
CREATE INDEX "review_tasks_reviewer_idx" ON "review_tasks" USING btree ("reviewer_id");--> statement-breakpoint
CREATE INDEX "run_generated_documents_run_idx" ON "run_generated_documents" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_run_idx" ON "run_logs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_level_idx" ON "run_logs" USING btree ("level");--> statement-breakpoint
CREATE INDEX "run_logs_created_at_idx" ON "run_logs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "run_outputs_run_idx" ON "run_outputs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_outputs_run_template_type_idx" ON "run_outputs" USING btree ("run_id","template_key","file_type");--> statement-breakpoint
CREATE INDEX "runs_workflow_version_idx" ON "runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "runs_status_idx" ON "runs" USING btree ("status");--> statement-breakpoint
CREATE INDEX "runs_created_by_idx" ON "runs" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "runs_created_at_idx" ON "runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "script_execution_log_run_idx" ON "script_execution_log" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_events_request_idx" ON "signature_events" USING btree ("signature_request_id");--> statement-breakpoint
CREATE INDEX "signature_requests_run_idx" ON "signature_requests" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_requests_token_idx" ON "signature_requests" USING btree ("token");--> statement-breakpoint
CREATE INDEX "sli_configs_project_idx" ON "sli_configs" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "sli_windows_project_window_idx" ON "sli_windows" USING btree ("project_id","window_start","window_end");--> statement-breakpoint
CREATE INDEX "step_values_run_idx" ON "step_values" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "step_values_step_idx" ON "step_values" USING btree ("step_id");--> statement-breakpoint
CREATE INDEX "step_values_run_step_idx" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE UNIQUE INDEX "step_values_run_step_unique" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE INDEX "template_metrics_template_idx" ON "template_generation_metrics" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_metrics_run_idx" ON "template_generation_metrics" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_run_idx" ON "transform_block_runs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_block_idx" ON "transform_block_runs" USING btree ("block_id");--> statement-breakpoint
CREATE UNIQUE INDEX "was_workflow_version_date_idx" ON "workflow_analytics_snapshots" USING btree ("workflow_id","version_id","date");--> statement-breakpoint
CREATE INDEX "wre_run_idx" ON "workflow_run_events" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "wre_workflow_ts_idx" ON "workflow_run_events" USING btree ("workflow_id","timestamp");--> statement-breakpoint
CREATE INDEX "wrm_workflow_created_idx" ON "workflow_run_metrics" USING btree ("workflow_id","created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_workflow_idx" ON "workflow_runs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_version_idx" ON "workflow_runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_completed_idx" ON "workflow_runs" USING btree ("completed");--> statement-breakpoint
CREATE INDEX "workflow_runs_run_token_idx" ON "workflow_runs" USING btree ("run_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_share_token_idx" ON "workflow_runs" USING btree ("share_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_current_section_idx" ON "workflow_runs" USING btree ("current_section_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_created_at_idx" ON "workflow_runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_owner_idx" ON "workflow_runs" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "analytics_survey_event_idx" ON "analytics_events" USING btree ("survey_id","event");--> statement-breakpoint
CREATE INDEX "analytics_response_event_idx" ON "analytics_events" USING btree ("response_id","event");--> statement-breakpoint
CREATE INDEX "analytics_timestamp_idx" ON "analytics_events" USING btree ("timestamp");--> statement-breakpoint
CREATE INDEX "anonymous_tracking_survey_ip_idx" ON "anonymous_response_tracking" USING btree ("survey_id","ip_address");--> statement-breakpoint
CREATE INDEX "email_queue_status_idx" ON "email_queue" USING btree ("status");--> statement-breakpoint
CREATE INDEX "email_queue_next_attempt_idx" ON "email_queue" USING btree ("next_attempt_at");--> statement-breakpoint
CREATE INDEX "survey_templates_creator_idx" ON "survey_templates" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "survey_templates_system_idx" ON "survey_templates" USING btree ("is_system");--> statement-breakpoint
CREATE INDEX "surveys_public_link_unique_idx" ON "surveys" USING btree ("public_link");--> statement-breakpoint
CREATE INDEX "surveys_workspace_idx" ON "surveys" USING btree ("workspace_id");--> statement-breakpoint
CREATE INDEX "template_shares_template_idx" ON "template_shares" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_shares_user_idx" ON "template_shares" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "template_shares_pending_email_idx" ON "template_shares" USING btree ("pending_email");--> statement-breakpoint
CREATE INDEX "collection_fields_collection_idx" ON "collection_fields" USING btree ("collection_id");--> statement-breakpoint
CREATE UNIQUE INDEX "collection_fields_slug_unique" ON "collection_fields" USING btree ("collection_id","slug");--> statement-breakpoint
CREATE UNIQUE INDEX "collections_slug_unique" ON "collections" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_database_id" ON "datavault_api_tokens" USING btree ("database_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE INDEX "datavault_columns_table_idx" ON "datavault_columns" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_columns_reference_table_idx" ON "datavault_columns" USING btree ("reference_table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_columns_table_slug_unique" ON "datavault_columns" USING btree ("table_id","slug");--> statement-breakpoint
CREATE INDEX "idx_databases_tenant" ON "datavault_databases" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_databases_scope" ON "datavault_databases" USING btree ("scope_type","scope_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_databases_owner" ON "datavault_databases" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_tenant" ON "datavault_number_sequences" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_table" ON "datavault_number_sequences" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "idx_datavault_sequences_column_unique" ON "datavault_number_sequences" USING btree ("tenant_id","table_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_row_id" ON "datavault_row_notes" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_tenant_id" ON "datavault_row_notes" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_table_idx" ON "datavault_rows" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_created_by_idx" ON "datavault_rows" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "idx_table_permissions_table" ON "datavault_table_permissions" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_table_user_permission" ON "datavault_table_permissions" USING btree ("table_id","user_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_tenant_idx" ON "datavault_tables" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_owner_idx" ON "datavault_tables" USING btree ("owner_user_id");--> statement-breakpoint
CREATE INDEX "idx_tables_database" ON "datavault_tables" USING btree ("database_id","tenant_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_tables_tenant_slug_unique" ON "datavault_tables" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "datavault_values_row_idx" ON "datavault_values" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "datavault_values_column_idx" ON "datavault_values" USING btree ("column_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_values_row_column_unique" ON "datavault_values" USING btree ("row_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_writeback_mappings_workflow" ON "datavault_writeback_mappings" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "records_collection_idx" ON "records" USING btree ("collection_id");--> statement-breakpoint
CREATE INDEX "records_tenant_idx" ON "records" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_data_sources_workflow" ON "workflow_data_sources" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_queries_workflow" ON "workflow_queries" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "api_keys_project_idx" ON "api_keys" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_tenant_idx" ON "connections" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "connections_project_idx" ON "connections" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_project_name_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "connections_type_idx" ON "connections" USING btree ("type");--> statement-breakpoint
CREATE INDEX "connections_enabled_idx" ON "connections" USING btree ("enabled");--> statement-breakpoint
CREATE UNIQUE INDEX "connections_project_name_unique_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "ext_dest_tenant_idx" ON "external_destinations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_client_id_idx" ON "oauth_apps" USING btree ("client_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_workspace_idx" ON "oauth_apps" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "secrets_project_key_env_unique" ON "secrets" USING btree ("project_id","key","environment");--> statement-breakpoint
CREATE INDEX "webhook_events_sub_idx" ON "webhook_events" USING btree ("subscription_id");--> statement-breakpoint
CREATE INDEX "webhook_subs_workspace_idx" ON "webhook_subscriptions" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_org_idx" ON "customer_billing_info" USING btree ("organization_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_stripe_idx" ON "customer_billing_info" USING btree ("stripe_customer_id");--> statement-breakpoint
CREATE UNIQUE INDEX "seat_sub_user_idx" ON "subscription_seats" USING btree ("subscription_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "sub_org_idx" ON "subscriptions" USING btree ("organization_id");--> statement-breakpoint
CREATE INDEX "usage_org_metric_date_idx" ON "usage_records" USING btree ("organization_id","metric","recorded_at");--> statement-breakpoint
CREATE INDEX "email_templates_key_idx" ON "email_template_metadata" USING btree ("template_key");--> statement-breakpoint
CREATE INDEX "ai_settings_scope_idx" ON "ai_settings" USING btree ("scope");
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:232:19 {
  query: `CREATE TYPE "public"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint\n` +
    'CREATE TABLE "account_locks" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"locked_at" timestamp DEFAULT now() NOT NULL,\n' +
    '\t"locked_until" timestamp NOT NULL,\n' +
    '\t"reason" varchar(255),\n' +
    '\t"unlocked" boolean DEFAULT false NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "audit_logs" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"tenant_id" uuid,\n' +
    '\t"workspace_id" uuid,\n' +
    '\t"user_id" varchar,\n' +
    '\t"action" varchar NOT NULL,\n' +
    '\t"entity_type" varchar NOT NULL,\n' +
    '\t"entity_id" varchar NOT NULL,\n' +
    '\t"resource_type" varchar,\n' +
    '\t"resource_id" varchar,\n' +
    '\t"changes" jsonb,\n' +
    '\t"details" jsonb,\n' +
    '\t"ip_address" varchar,\n' +
    '\t"user_agent" text,\n' +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"timestamp" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "email_verification_tokens" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"token" varchar NOT NULL,\n' +
    '\t"expires_at" timestamp NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "login_attempts" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"email" varchar(255) NOT NULL,\n' +
    '\t"ip_address" varchar(45),\n' +
    '\t"successful" boolean DEFAULT false NOT NULL,\n' +
    '\t"attempted_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "mfa_backup_codes" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"code_hash" text NOT NULL,\n' +
    '\t"used" boolean DEFAULT false NOT NULL,\n' +
    '\t"used_at" timestamp,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "mfa_secrets" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"secret" text NOT NULL,\n' +
    '\t"enabled" boolean DEFAULT false NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL,\n' +
    '\t"enabled_at" timestamp,\n' +
    '\tCONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "organization_invites" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"org_id" uuid NOT NULL,\n' +
    '\t"invited_email" varchar(255) NOT NULL,\n' +
    '\t"invited_user_id" varchar,\n' +
    '\t"invited_by_user_id" varchar NOT NULL,\n' +
    '\t"token" varchar(255) NOT NULL,\n' +
    `\t"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,\n` +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"expires_at" timestamp NOT NULL,\n' +
    '\t"accepted_at" timestamp,\n' +
    '\t"email_sent_at" timestamp,\n' +
    '\t"email_failed" boolean DEFAULT false,\n' +
    '\t"email_error" text,\n' +
    '\tCONSTRAINT "organization_invites_token_unique" UNIQUE("token")\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "organization_memberships" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"org_id" uuid NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    `\t"role" "organization_role" DEFAULT 'member' NOT NULL,\n` +
    '\t"created_at" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "organizations" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"name" varchar NOT NULL,\n' +
    '\t"description" text,\n' +
    '\t"slug" varchar,\n' +
    '\t"domain" varchar,\n' +
    `\t"settings" jsonb DEFAULT '{}'::jsonb,\n` +
    '\t"tenant_id" uuid NOT NULL,\n' +
    '\t"created_by_user_id" varchar,\n' +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"upd'... 108432 more characters,
  params: [],
  cause: error: type "anonymous_access_type" already exists
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:232:19 {
    length: 101,
    severity: 'ERROR',
    code: '42710',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: 'typecmds.c',
    line: '1177',
    routine: 'DefineEnum'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: []

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768674903570,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768674903590,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768674903579,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768674903580,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768674903584,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768674903584,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768674903589,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768674903589,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768674903590,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768674903590,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768674903813,"env":"test","module":"auth-routes","error":{},"msg":"Registration failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
CRITICAL REGISTRATION ERROR: ReferenceError: SALT_ROUNDS is not defined
    at AuthService.hashPassword (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:168:38)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:242:46
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

{"level":30,"time":1768674903825,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768674903825,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 2489ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  12:34:50
   Duration  13.00s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x3 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768675043480,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 0 tables - running migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768675046620,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768675046666,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
≡ƒöä Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/auth/protected.routes.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

stdout | tests/integration/auth/protected.routes.test.ts
   Applying 0000_mushy_thing.sql...

stderr | tests/integration/auth/protected.routes.test.ts
Γ¥î FAILED MIGRATION 0000_mushy_thing.sql: Failed query: SET search_path TO "test_schema_w0_v3", public;

CREATE TYPE "test_schema_w0_v3"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint
CREATE TABLE "account_locks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"locked_at" timestamp DEFAULT now() NOT NULL,
	"locked_until" timestamp NOT NULL,
	"reason" varchar(255),
	"unlocked" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "audit_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"workspace_id" uuid,
	"user_id" varchar,
	"action" varchar NOT NULL,
	"entity_type" varchar NOT NULL,
	"entity_id" varchar NOT NULL,
	"resource_type" varchar,
	"resource_id" varchar,
	"changes" jsonb,
	"details" jsonb,
	"ip_address" varchar,
	"user_agent" text,
	"created_at" timestamp DEFAULT now(),
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_verification_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "login_attempts" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"ip_address" varchar(45),
	"successful" boolean DEFAULT false NOT NULL,
	"attempted_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_backup_codes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"code_hash" text NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"secret" text NOT NULL,
	"enabled" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"enabled_at" timestamp,
	CONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "organization_invites" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"invited_email" varchar(255) NOT NULL,
	"invited_user_id" varchar,
	"invited_by_user_id" varchar NOT NULL,
	"token" varchar(255) NOT NULL,
	"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp NOT NULL,
	"accepted_at" timestamp,
	"email_sent_at" timestamp,
	"email_failed" boolean DEFAULT false,
	"email_error" text,
	CONSTRAINT "organization_invites_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "organization_memberships" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "organization_role" DEFAULT 'member' NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "organizations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"slug" varchar,
	"domain" varchar,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"tenant_id" uuid NOT NULL,
	"created_by_user_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "organizations_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "password_reset_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "portal_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "portal_tokens_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "refresh_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"revoked" boolean DEFAULT false NOT NULL,
	"metadata" jsonb,
	"device_name" varchar(255),
	"ip_address" varchar(45),
	"location" varchar(255),
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sessions" (
	"sid" varchar PRIMARY KEY NOT NULL,
	"sess" jsonb NOT NULL,
	"expire" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE "team_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"team_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" varchar(50) DEFAULT 'member' NOT NULL,
	"joined_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "teams" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "tenant_domains" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"domain" text NOT NULL,
	"verified" boolean DEFAULT false,
	"verification_token" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "tenant_domains_domain_unique" UNIQUE("domain")
);
--> statement-breakpoint
CREATE TABLE "tenants" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar(255) NOT NULL,
	"billing_email" varchar(255),
	"plan" "tenant_plan" DEFAULT 'free' NOT NULL,
	"mfa_required" boolean DEFAULT false NOT NULL,
	"branding" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "trusted_devices" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"device_fingerprint" varchar(255) NOT NULL,
	"device_name" varchar(255),
	"trusted_until" timestamp NOT NULL,
	"ip_address" varchar(45),
	"location" varchar(255),
	"user_agent" text,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"last_used_at" timestamp,
	"revoked" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "user_credentials" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"password_hash" text NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "user_credentials_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "user_personalization_settings" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"reading_level" varchar DEFAULT 'standard' NOT NULL,
	"tone" varchar DEFAULT 'neutral' NOT NULL,
	"verbosity" varchar DEFAULT 'standard' NOT NULL,
	"language" varchar DEFAULT 'en' NOT NULL,
	"allow_adaptive_prompts" boolean DEFAULT true NOT NULL,
	"allow_ai_clarification" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "user_preferences" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"settings" jsonb DEFAULT '{"celebrationEffects":true,"darkMode":"system","aiHints":true}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "users" (
	"id" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"full_name" varchar(255),
	"first_name" varchar(255),
	"last_name" varchar(255),
	"profile_image_url" varchar(500),
	"tenant_id" uuid,
	"role" "user_role" DEFAULT 'creator' NOT NULL,
	"tenant_role" "user_tenant_role",
	"auth_provider" "auth_provider" DEFAULT 'local' NOT NULL,
	"default_mode" text DEFAULT 'easy' NOT NULL,
	"email_verified" boolean DEFAULT false NOT NULL,
	"mfa_enabled" boolean DEFAULT false NOT NULL,
	"last_password_change" timestamp,
	"is_placeholder" boolean DEFAULT false NOT NULL,
	"placeholder_email" varchar(255),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_invitations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"email" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"invited_by" varchar NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"joined_at" timestamp DEFAULT now(),
	"invited_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workspaces" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"slug" varchar NOT NULL,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"type" "block_type" NOT NULL,
	"phase" "block_phase" NOT NULL,
	"config" jsonb NOT NULL,
	"virtual_step_id" uuid,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_docs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid,
	"tenant_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"clock" integer NOT NULL,
	"state" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "collab_updates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"seq" integer NOT NULL,
	"update" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "document_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"final_block_document_id" varchar(255),
	"name" varchar(255) NOT NULL,
	"phase" "document_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 3000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "lifecycle_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar(255) NOT NULL,
	"phase" "lifecycle_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"virtual_step_ids" uuid[] DEFAULT '{}'::uuid[],
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"mutation_mode" boolean DEFAULT false,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "logic_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"condition_step_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_type" "logic_rule_target_type" NOT NULL,
	"target_step_id" uuid,
	"target_section_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "project_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "projects" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"name" varchar(255),
	"description" text,
	"creator_id" varchar NOT NULL,
	"tenant_id" uuid,
	"created_by" varchar,
	"owner_id" varchar NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"status" "project_status" DEFAULT 'active' NOT NULL,
	"archived" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"order" integer NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"visible_if" jsonb,
	"skip_if" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "steps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"section_id" uuid NOT NULL,
	"type" "step_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"alias" text,
	"default_value" jsonb,
	"order" integer NOT NULL,
	"is_virtual" boolean DEFAULT false NOT NULL,
	"visible_if" jsonb,
	"repeater_config" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"version_number" integer NOT NULL,
	"file_ref" varchar(500) NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"notes" text,
	"is_active" boolean DEFAULT true
);
--> statement-breakpoint
CREATE TABLE "templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"file_ref" varchar(500) NOT NULL,
	"type" "template_type" NOT NULL,
	"helpers_version" integer DEFAULT 1 NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"current_version" integer DEFAULT 1,
	"last_modified_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_key" varchar NOT NULL,
	"virtual_step_id" uuid,
	"phase" "block_phase" DEFAULT 'onSectionSubmit' NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_blueprints" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"creator_id" varchar NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"graph_json" jsonb NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"source_workflow_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"name" text NOT NULL,
	"values" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"workflow_version_id" uuid,
	"version_hash" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_id" uuid NOT NULL,
	"key" text NOT NULL,
	"is_primary" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"base_id" uuid,
	"version_number" integer DEFAULT 1 NOT NULL,
	"is_draft" boolean DEFAULT false NOT NULL,
	"graph_json" jsonb NOT NULL,
	"migration_info" jsonb,
	"changelog" jsonb,
	"notes" text,
	"checksum" text,
	"created_by" varchar NOT NULL,
	"published" boolean DEFAULT false NOT NULL,
	"published_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"description" text,
	"creator_id" varchar,
	"owner_id" varchar,
	"mode_override" text,
	"public_link" text,
	"name" varchar(255),
	"project_id" uuid,
	"current_version_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"slug" text,
	"require_login" boolean DEFAULT false NOT NULL,
	"intake_config" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"pinned_version_id" uuid,
	"status" "workflow_status" DEFAULT 'draft' NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"source_blueprint_id" uuid,
	CONSTRAINT "workflows_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "ai_workflow_feedback" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid,
	"user_id" varchar,
	"operation_type" varchar NOT NULL,
	"rating" integer NOT NULL,
	"comment" text,
	"ai_provider" varchar,
	"ai_model" varchar,
	"prompt_version" varchar,
	"quality_score" integer,
	"quality_passed" boolean,
	"issues_count" integer,
	"request_description" text,
	"generated_sections" integer,
	"generated_steps" integer,
	"was_edited" boolean DEFAULT false,
	"edit_count" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "block_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"block_id" varchar NOT NULL,
	"total_visits" integer DEFAULT 0,
	"avg_time_ms" integer DEFAULT 0,
	"dropoff_count" integer DEFAULT 0,
	"validation_error_count" integer DEFAULT 0,
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"run_id" uuid,
	"type" "metrics_event_type" NOT NULL,
	"ts" timestamp with time zone DEFAULT now() NOT NULL,
	"duration_ms" integer,
	"payload" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_rollups" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"bucket_start" timestamp with time zone NOT NULL,
	"bucket" "rollup_bucket" NOT NULL,
	"runs_count" integer DEFAULT 0 NOT NULL,
	"runs_success" integer DEFAULT 0 NOT NULL,
	"runs_error" integer DEFAULT 0 NOT NULL,
	"dur_p50" integer,
	"dur_p95" integer,
	"pdf_success" integer DEFAULT 0 NOT NULL,
	"pdf_error" integer DEFAULT 0 NOT NULL,
	"docx_success" integer DEFAULT 0 NOT NULL,
	"docx_error" integer DEFAULT 0 NOT NULL,
	"queue_enqueued" integer DEFAULT 0 NOT NULL,
	"queue_dequeued" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "review_tasks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"status" "review_task_status" DEFAULT 'pending' NOT NULL,
	"reviewer_id" varchar,
	"reviewer_email" varchar(255),
	"message" text,
	"comment" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"resolved_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "run_generated_documents" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"file_name" text NOT NULL,
	"file_url" text NOT NULL,
	"mime_type" text,
	"file_size" integer,
	"template_id" uuid,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"node_id" varchar(100),
	"level" "log_level" NOT NULL,
	"message" text NOT NULL,
	"context" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_outputs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_key" text NOT NULL,
	"file_type" "output_file_type" NOT NULL,
	"storage_path" text NOT NULL,
	"status" "output_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"input_json" jsonb,
	"output_refs" jsonb,
	"trace" jsonb,
	"status" "run_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"duration_ms" integer,
	"run_token" varchar,
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "script_execution_log" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"script_type" varchar(50) NOT NULL,
	"script_id" uuid NOT NULL,
	"script_name" varchar(255),
	"phase" varchar(50),
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "script_execution_status" NOT NULL,
	"error_message" text,
	"console_output" jsonb,
	"input_sample" jsonb,
	"output_sample" jsonb,
	"duration_ms" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "signature_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"signature_request_id" uuid NOT NULL,
	"type" "signature_event_type" NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb
);
--> statement-breakpoint
CREATE TABLE "signature_requests" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"signer_email" varchar(255) NOT NULL,
	"signer_name" varchar(255),
	"status" "signature_request_status" DEFAULT 'pending' NOT NULL,
	"provider" "signature_provider" DEFAULT 'native' NOT NULL,
	"provider_request_id" text,
	"token" text NOT NULL,
	"document_url" text,
	"redirect_url" text,
	"message" text,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"signed_at" timestamp,
	CONSTRAINT "signature_requests_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "sli_configs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"target_success_pct" integer DEFAULT 99 NOT NULL,
	"target_p95_ms" integer DEFAULT 5000 NOT NULL,
	"error_budget_pct" integer DEFAULT 1 NOT NULL,
	"window" "sli_window" DEFAULT '7d' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sli_windows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"window_start" timestamp with time zone NOT NULL,
	"window_end" timestamp with time zone NOT NULL,
	"success_pct" integer,
	"p95_ms" integer,
	"error_budget_burn_pct" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "step_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"step_id" uuid NOT NULL,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_generation_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"run_id" uuid,
	"result" varchar(50) NOT NULL,
	"duration_ms" integer,
	"error_message" text,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_block_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"block_id" uuid NOT NULL,
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "transform_block_run_status" NOT NULL,
	"error_message" text,
	"output_sample" jsonb
);
--> statement-breakpoint
CREATE TABLE "workflow_analytics_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"date" timestamp NOT NULL,
	"summary" jsonb NOT NULL,
	"dropoff" jsonb NOT NULL,
	"branching" jsonb NOT NULL,
	"heatmap" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_run_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"block_id" varchar,
	"page_id" uuid,
	"type" varchar NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb,
	"is_preview" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_run_metrics" (
	"run_id" uuid PRIMARY KEY NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"total_time_ms" integer,
	"pages_visited" integer DEFAULT 0,
	"blocks_visited" integer DEFAULT 0,
	"validation_errors" integer DEFAULT 0,
	"script_errors" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"is_preview" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"workflow_version_id" uuid,
	"run_token" text NOT NULL,
	"created_by" text,
	"current_section_id" uuid,
	"progress" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"metadata" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"client_email" varchar,
	"portal_access_key" varchar,
	"access_mode" "portal_access_mode" DEFAULT 'anonymous',
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"owner_type" varchar(50),
	"owner_uuid" uuid,
	CONSTRAINT "workflow_runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "workflow_runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "analytics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"survey_id" uuid NOT NULL,
	"page_id" uuid,
	"question_id" uuid,
	"event" varchar NOT NULL,
	"data" jsonb,
	"duration" integer,
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "anonymous_response_tracking" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"ip_address" varchar NOT NULL,
	"session_id" varchar,
	"response_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "answers" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"question_id" uuid NOT NULL,
	"subquestion_id" uuid,
	"loop_index" integer,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "conditional_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"condition_question_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_question_id" uuid,
	"target_page_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_queue" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"to" varchar NOT NULL,
	"subject" varchar NOT NULL,
	"html" text NOT NULL,
	"status" "email_queue_status" DEFAULT 'pending' NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_error" text,
	"next_attempt_at" timestamp DEFAULT now(),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "files" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"answer_id" uuid NOT NULL,
	"filename" varchar NOT NULL,
	"original_name" varchar NOT NULL,
	"mime_type" varchar NOT NULL,
	"size" integer NOT NULL,
	"uploaded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "loop_group_subquestions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"loop_question_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "questions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"page_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"conditional_logic" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "responses" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"completed" boolean DEFAULT false,
	"submitted_at" timestamp,
	"is_anonymous" boolean DEFAULT false,
	"ip_address" varchar,
	"user_agent" text,
	"session_id" varchar,
	"anonymous_metadata" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_pages" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" text NOT NULL,
	"description" text,
	"content" jsonb NOT NULL,
	"creator_id" varchar,
	"is_system" boolean DEFAULT false NOT NULL,
	"tags" text[] DEFAULT ARRAY[]::text[],
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "surveys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"creator_id" varchar NOT NULL,
	"workspace_id" uuid,
	"status" "survey_status" DEFAULT 'draft' NOT NULL,
	"allow_anonymous" boolean DEFAULT false,
	"anonymous_access_type" "anonymous_access_type" DEFAULT 'unlimited',
	"public_link" varchar,
	"anonymous_config" jsonb,
	"is_public" boolean DEFAULT false,
	"public_access_mode" "public_access_mode" DEFAULT 'link_only',
	"public_slug" varchar,
	"allowed_domains" jsonb,
	"public_settings" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "surveys_public_link_unique" UNIQUE("public_link"),
	CONSTRAINT "surveys_public_slug_unique" UNIQUE("public_slug")
);
--> statement-breakpoint
CREATE TABLE "template_shares" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"user_id" varchar,
	"pending_email" text,
	"access" "template_access" DEFAULT 'use' NOT NULL,
	"invited_at" timestamp with time zone DEFAULT now(),
	"accepted_at" timestamp with time zone
);
--> statement-breakpoint
CREATE TABLE "collection_fields" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"collection_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"type" varchar(50) NOT NULL,
	"options" jsonb,
	"required" boolean DEFAULT false,
	"order" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_api_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"database_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"label" text NOT NULL,
	"token_hash" text NOT NULL,
	"scopes" text[] DEFAULT ARRAY[]::text[] NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "datavault_columns" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"type" "datavault_column_type" NOT NULL,
	"description" text,
	"width_px" integer DEFAULT 150,
	"required" boolean DEFAULT false NOT NULL,
	"is_primary_key" boolean DEFAULT false NOT NULL,
	"is_unique" boolean DEFAULT false NOT NULL,
	"order_index" integer DEFAULT 0 NOT NULL,
	"auto_number_start" integer DEFAULT 1,
	"autonumber_prefix" text,
	"autonumber_padding" integer DEFAULT 4,
	"autonumber_reset_policy" "autonumber_reset_policy" DEFAULT 'never',
	"reference_table_id" uuid,
	"reference_display_column_slug" text,
	"options" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_databases" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"type" "data_source_type" DEFAULT 'native' NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"scope_type" "datavault_scope_type" DEFAULT 'account' NOT NULL,
	"scope_id" uuid,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_number_sequences" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"prefix" text,
	"padding" integer DEFAULT 4 NOT NULL,
	"next_value" integer DEFAULT 1 NOT NULL,
	"reset_policy" "autonumber_reset_policy" DEFAULT 'never' NOT NULL,
	"last_reset" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_row_notes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"text" text NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_rows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"deleted_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "datavault_table_permissions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "datavault_table_role" NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_tables" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"owner_user_id" varchar,
	"database_id" uuid,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"value" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_writeback_mappings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_mappings" jsonb NOT NULL,
	"trigger_phase" varchar(50) DEFAULT 'afterComplete' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar
);
--> statement-breakpoint
CREATE TABLE "records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"collection_id" uuid NOT NULL,
	"data" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workflow_data_sources" (
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "workflow_data_sources_workflow_id_data_source_id_pk" PRIMARY KEY("workflow_id","data_source_id")
);
--> statement-breakpoint
CREATE TABLE "workflow_queries" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"filters" jsonb DEFAULT '[]'::jsonb,
	"sort" jsonb DEFAULT '[]'::jsonb,
	"limit" integer,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "api_keys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"prefix" varchar(50) NOT NULL,
	"key_hash" varchar(255) NOT NULL,
	"scopes" text[] NOT NULL,
	"name" varchar NOT NULL,
	"expires_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "api_keys_key_hash_unique" UNIQUE("key_hash")
);
--> statement-breakpoint
CREATE TABLE "connections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"type" "connection_type" NOT NULL,
	"base_url" varchar(500),
	"auth_config" jsonb DEFAULT '{}'::jsonb,
	"secret_refs" jsonb DEFAULT '{}'::jsonb,
	"oauth_state" jsonb,
	"default_headers" jsonb DEFAULT '{}'::jsonb,
	"timeout_ms" integer DEFAULT 8000,
	"retries" integer DEFAULT 2,
	"backoff_ms" integer DEFAULT 250,
	"enabled" boolean DEFAULT true NOT NULL,
	"last_tested_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "external_destinations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"config" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "oauth_access_tokens" (
	"access_token" varchar PRIMARY KEY NOT NULL,
	"refresh_token" varchar,
	"client_id" varchar NOT NULL,
	"user_id" varchar,
	"workspace_id" uuid NOT NULL,
	"scope" jsonb,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_access_tokens_refresh_token_unique" UNIQUE("refresh_token")
);
--> statement-breakpoint
CREATE TABLE "oauth_apps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"client_id" varchar NOT NULL,
	"client_secret_hash" varchar NOT NULL,
	"redirect_uris" jsonb NOT NULL,
	"scopes" jsonb NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_apps_client_id_unique" UNIQUE("client_id")
);
--> statement-breakpoint
CREATE TABLE "oauth_auth_codes" (
	"code" varchar PRIMARY KEY NOT NULL,
	"client_id" varchar NOT NULL,
	"user_id" varchar NOT NULL,
	"scope" jsonb,
	"redirect_uri" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"key" varchar NOT NULL,
	"value" text,
	"value_enc" text NOT NULL,
	"type" "secret_type" DEFAULT 'api_key' NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"environment" varchar DEFAULT 'production',
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"event" varchar NOT NULL,
	"payload" jsonb NOT NULL,
	"status" varchar NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_attempt_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"target_url" varchar NOT NULL,
	"events" jsonb NOT NULL,
	"secret" varchar NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "billing_plans" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"price_monthly" integer DEFAULT 0 NOT NULL,
	"price_yearly" integer DEFAULT 0 NOT NULL,
	"features" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"limits" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"stripe_product_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "customer_billing_info" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"stripe_customer_id" varchar NOT NULL,
	"billing_email" varchar,
	"default_payment_method_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscription_seats" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"assigned_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"plan_id" uuid NOT NULL,
	"status" "subscription_status" DEFAULT 'active' NOT NULL,
	"stripe_subscription_id" varchar,
	"current_period_start" timestamp,
	"current_period_end" timestamp,
	"cancel_at_period_end" boolean DEFAULT false,
	"canceled_at" timestamp,
	"trial_start" timestamp,
	"trial_end" timestamp,
	"seat_quantity" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "usage_records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"metric" varchar NOT NULL,
	"quantity" integer DEFAULT 1 NOT NULL,
	"workflow_id" uuid,
	"metadata" jsonb,
	"recorded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_template_metadata" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_key" varchar(255) NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"subject_preview" text,
	"branding_tokens" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "email_template_metadata_template_key_unique" UNIQUE("template_key")
);
--> statement-breakpoint
CREATE TABLE "ai_settings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"scope" varchar DEFAULT 'global' NOT NULL,
	"system_prompt" text,
	"updated_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
ALTER TABLE "account_locks" ADD CONSTRAINT "account_locks_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "email_verification_tokens" ADD CONSTRAINT "email_verification_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_backup_codes" ADD CONSTRAINT "mfa_backup_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_secrets" ADD CONSTRAINT "mfa_secrets_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_user_id_users_id_fk" FOREIGN KEY ("invited_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_by_user_id_users_id_fk" FOREIGN KEY ("invited_by_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_created_by_user_id_users_id_fk" FOREIGN KEY ("created_by_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "password_reset_tokens" ADD CONSTRAINT "password_reset_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "refresh_tokens" ADD CONSTRAINT "refresh_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_team_id_teams_id_fk" FOREIGN KEY ("team_id") REFERENCES "test_schema_w0_v3"."teams"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "teams" ADD CONSTRAINT "teams_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "tenant_domains" ADD CONSTRAINT "tenant_domains_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "trusted_devices" ADD CONSTRAINT "trusted_devices_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_credentials" ADD CONSTRAINT "user_credentials_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_personalization_settings" ADD CONSTRAINT "user_personalization_settings_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_preferences" ADD CONSTRAINT "user_preferences_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "users" ADD CONSTRAINT "users_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspaces" ADD CONSTRAINT "workspaces_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_snapshots" ADD CONSTRAINT "collab_snapshots_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "test_schema_w0_v3"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_updates" ADD CONSTRAINT "collab_updates_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "test_schema_w0_v3"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "document_hooks" ADD CONSTRAINT "document_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_condition_step_id_steps_id_fk" FOREIGN KEY ("condition_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_step_id_steps_id_fk" FOREIGN KEY ("target_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_section_id_sections_id_fk" FOREIGN KEY ("target_section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "project_access" ADD CONSTRAINT "project_access_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sections" ADD CONSTRAINT "sections_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "steps" ADD CONSTRAINT "steps_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_last_modified_by_users_id_fk" FOREIGN KEY ("last_modified_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_access" ADD CONSTRAINT "workflow_access_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_source_workflow_id_workflows_id_fk" FOREIGN KEY ("source_workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_base_id_workflows_id_fk" FOREIGN KEY ("base_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_reviewer_id_users_id_fk" FOREIGN KEY ("reviewer_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_template_id_workflow_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."workflow_templates"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_logs" ADD CONSTRAINT "run_logs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "script_execution_log" ADD CONSTRAINT "script_execution_log_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_events" ADD CONSTRAINT "signature_events_signature_request_id_signature_requests_id_fk" FOREIGN KEY ("signature_request_id") REFERENCES "test_schema_w0_v3"."signature_requests"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_step_id_steps_id_fk" FOREIGN KEY ("step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_block_id_transform_blocks_id_fk" FOREIGN KEY ("block_id") REFERENCES "test_schema_w0_v3"."transform_blocks"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_current_section_id_sections_id_fk" FOREIGN KEY ("current_section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "test_schema_w0_v3"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "test_schema_w0_v3"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "test_schema_w0_v3"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "test_schema_w0_v3"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_subquestion_id_loop_group_subquestions_id_fk" FOREIGN KEY ("subquestion_id") REFERENCES "test_schema_w0_v3"."loop_group_subquestions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_condition_question_id_questions_id_fk" FOREIGN KEY ("condition_question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_question_id_questions_id_fk" FOREIGN KEY ("target_question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_page_id_survey_pages_id_fk" FOREIGN KEY ("target_page_id") REFERENCES "test_schema_w0_v3"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "files" ADD CONSTRAINT "files_answer_id_answers_id_fk" FOREIGN KEY ("answer_id") REFERENCES "test_schema_w0_v3"."answers"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "loop_group_subquestions" ADD CONSTRAINT "loop_group_subquestions_loop_question_id_questions_id_fk" FOREIGN KEY ("loop_question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "questions" ADD CONSTRAINT "questions_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "test_schema_w0_v3"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "responses" ADD CONSTRAINT "responses_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_pages" ADD CONSTRAINT "survey_pages_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_templates" ADD CONSTRAINT "survey_templates_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_template_id_survey_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."survey_templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collection_fields" ADD CONSTRAINT "collection_fields_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "test_schema_w0_v3"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collections" ADD CONSTRAINT "collections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_columns" ADD CONSTRAINT "datavault_columns_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_databases" ADD CONSTRAINT "datavault_databases_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "test_schema_w0_v3"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "test_schema_w0_v3"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_owner_user_id_users_id_fk" FOREIGN KEY ("owner_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "test_schema_w0_v3"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "test_schema_w0_v3"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "test_schema_w0_v3"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "api_keys" ADD CONSTRAINT "api_keys_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "external_destinations" ADD CONSTRAINT "external_destinations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "test_schema_w0_v3"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_apps" ADD CONSTRAINT "oauth_apps_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "test_schema_w0_v3"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "secrets" ADD CONSTRAINT "secrets_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_events" ADD CONSTRAINT "webhook_events_subscription_id_webhook_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "test_schema_w0_v3"."webhook_subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_subscriptions" ADD CONSTRAINT "webhook_subscriptions_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "customer_billing_info" ADD CONSTRAINT "customer_billing_info_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_subscription_id_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "test_schema_w0_v3"."subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_plan_id_billing_plans_id_fk" FOREIGN KEY ("plan_id") REFERENCES "test_schema_w0_v3"."billing_plans"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_settings" ADD CONSTRAINT "ai_settings_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
CREATE INDEX "account_locks_user_idx" ON "account_locks" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "account_locks_until_idx" ON "account_locks" USING btree ("locked_until");--> statement-breakpoint
CREATE INDEX "audit_logs_tenant_idx" ON "audit_logs" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "audit_logs_user_idx" ON "audit_logs" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "audit_logs_action_idx" ON "audit_logs" USING btree ("action");--> statement-breakpoint
CREATE INDEX "email_verify_token_idx" ON "email_verification_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "email_verify_user_idx" ON "email_verification_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "login_attempts_email_idx" ON "login_attempts" USING btree ("email");--> statement-breakpoint
CREATE INDEX "login_attempts_timestamp_idx" ON "login_attempts" USING btree ("attempted_at");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_user_idx" ON "mfa_backup_codes" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_hash_idx" ON "mfa_backup_codes" USING btree ("code_hash");--> statement-breakpoint
CREATE INDEX "mfa_secrets_user_idx" ON "mfa_secrets" USING btree ("user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "org_invites_token_unique_idx" ON "organization_invites" USING btree ("token");--> statement-breakpoint
CREATE INDEX "idx_org_invites_org_email_status" ON "organization_invites" USING btree ("org_id","invited_email","status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_status" ON "organization_invites" USING btree ("status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_expires" ON "organization_invites" USING btree ("expires_at");--> statement-breakpoint
CREATE UNIQUE INDEX "org_membership_unique_idx" ON "organization_memberships" USING btree ("org_id","user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_org" ON "organization_memberships" USING btree ("org_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_user" ON "organization_memberships" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_role" ON "organization_memberships" USING btree ("role");--> statement-breakpoint
CREATE INDEX "idx_organizations_created_by" ON "organizations" USING btree ("created_by_user_id");--> statement-breakpoint
CREATE INDEX "idx_organizations_tenant" ON "organizations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "pwd_reset_token_idx" ON "password_reset_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "pwd_reset_user_idx" ON "password_reset_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_user_idx" ON "refresh_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_token_idx" ON "refresh_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "IDX_session_expire" ON "sessions" USING btree ("expire");--> statement-breakpoint
CREATE UNIQUE INDEX "team_members_idx" ON "team_members" USING btree ("team_id","user_id");--> statement-breakpoint
CREATE INDEX "teams_tenant_idx" ON "teams" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_tenant_idx" ON "tenant_domains" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_domain_idx" ON "tenant_domains" USING btree ("domain");--> statement-breakpoint
CREATE INDEX "tenants_plan_idx" ON "tenants" USING btree ("plan");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_idx" ON "trusted_devices" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "trusted_devices_fingerprint_idx" ON "trusted_devices" USING btree ("device_fingerprint");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_fingerprint_idx" ON "trusted_devices" USING btree ("user_id","device_fingerprint");--> statement-breakpoint
CREATE INDEX "user_credentials_user_idx" ON "user_credentials" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "users_email_idx" ON "users" USING btree ("email");--> statement-breakpoint
CREATE INDEX "users_tenant_idx" ON "users" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "users_tenant_email_idx" ON "users" USING btree ("tenant_id","email");--> statement-breakpoint
CREATE INDEX "idx_users_is_placeholder" ON "users" USING btree ("is_placeholder");--> statement-breakpoint
CREATE INDEX "idx_users_placeholder_email" ON "users" USING btree ("placeholder_email");--> statement-breakpoint
CREATE INDEX "invitation_token_idx" ON "workspace_invitations" USING btree ("token");--> statement-breakpoint
CREATE INDEX "invitation_ws_email_idx" ON "workspace_invitations" USING btree ("workspace_id","email");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_member_idx" ON "workspace_members" USING btree ("workspace_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_org_slug_idx" ON "workspaces" USING btree ("organization_id","slug");--> statement-breakpoint
CREATE INDEX "blocks_workflow_phase_order_idx" ON "blocks" USING btree ("workflow_id","phase","order");--> statement-breakpoint
CREATE INDEX "collab_docs_workflow_idx" ON "collab_docs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "collab_snapshots_doc_clock_idx" ON "collab_snapshots" USING btree ("doc_id","clock");--> statement-breakpoint
CREATE INDEX "collab_updates_doc_seq_idx" ON "collab_updates" USING btree ("doc_id","seq");--> statement-breakpoint
CREATE INDEX "logic_rules_workflow_idx" ON "logic_rules" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "project_access_project_idx" ON "project_access" USING btree ("project_id");--> statement-breakpoint
CREATE UNIQUE INDEX "project_access_principal_idx" ON "project_access" USING btree ("project_id","principal_type","principal_id");--> statement-breakpoint
CREATE INDEX "projects_tenant_idx" ON "projects" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "projects_created_by_idx" ON "projects" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "projects_creator_idx" ON "projects" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "projects_owner_idx" ON "projects" USING btree ("owner_id");--> statement-breakpoint
CREATE INDEX "idx_projects_owner" ON "projects" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "projects_status_idx" ON "projects" USING btree ("status");--> statement-breakpoint
CREATE INDEX "projects_archived_idx" ON "projects" USING btree ("archived");--> statement-breakpoint
CREATE INDEX "sections_workflow_idx" ON "sections" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "steps_section_idx" ON "steps" USING btree ("section_id");--> statement-breakpoint
CREATE UNIQUE INDEX "template_versions_unique_idx" ON "template_versions" USING btree ("template_id","version_number");--> statement-breakpoint
CREATE INDEX "templates_project_idx" ON "templates" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflow_access_workflow_idx" ON "workflow_access" USING btree ("workflow_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_access_principal_idx" ON "workflow_access" USING btree ("workflow_id","principal_type","principal_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_snapshots_workflow_name_unique" ON "workflow_snapshots" USING btree ("workflow_id","name");--> statement-breakpoint
CREATE INDEX "workflow_templates_version_key_unique" ON "workflow_templates" USING btree ("workflow_version_id","key");--> statement-breakpoint
CREATE INDEX "workflow_versions_workflow_idx" ON "workflow_versions" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_versions_version_number_idx" ON "workflow_versions" USING btree ("workflow_id","version_number");--> statement-breakpoint
CREATE INDEX "workflow_versions_is_draft_idx" ON "workflow_versions" USING btree ("is_draft");--> statement-breakpoint
CREATE INDEX "workflows_project_idx" ON "workflows" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflows_status_idx" ON "workflows" USING btree ("status");--> statement-breakpoint
CREATE INDEX "workflows_is_public_idx" ON "workflows" USING btree ("is_public");--> statement-breakpoint
CREATE INDEX "workflows_slug_idx" ON "workflows" USING btree ("slug");--> statement-breakpoint
CREATE INDEX "workflows_pinned_version_idx" ON "workflows" USING btree ("pinned_version_id");--> statement-breakpoint
CREATE INDEX "idx_workflows_owner" ON "workflows" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "ai_feedback_workflow_idx" ON "ai_workflow_feedback" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "bm_version_block_idx" ON "block_metrics" USING btree ("version_id","block_id");--> statement-breakpoint
CREATE INDEX "metrics_events_project_ts_idx" ON "metrics_events" USING btree ("project_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_workflow_ts_idx" ON "metrics_events" USING btree ("workflow_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_type_idx" ON "metrics_events" USING btree ("type");--> statement-breakpoint
CREATE UNIQUE INDEX "metrics_rollups_unique_idx" ON "metrics_rollups" USING btree ("tenant_id","project_id",COALESCE("workflow_id", '00000000-0000-0000-0000-000000000000'::uuid),"bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "metrics_rollups_project_bucket_idx" ON "metrics_rollups" USING btree ("project_id","bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "review_tasks_run_idx" ON "review_tasks" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "review_tasks_workflow_idx" ON "review_tasks" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "review_tasks_status_idx" ON "review_tasks" USING btree ("status");--> statement-breakpoint
CREATE INDEX "review_tasks_reviewer_idx" ON "review_tasks" USING btree ("reviewer_id");--> statement-breakpoint
CREATE INDEX "run_generated_documents_run_idx" ON "run_generated_documents" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_run_idx" ON "run_logs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_level_idx" ON "run_logs" USING btree ("level");--> statement-breakpoint
CREATE INDEX "run_logs_created_at_idx" ON "run_logs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "run_outputs_run_idx" ON "run_outputs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_outputs_run_template_type_idx" ON "run_outputs" USING btree ("run_id","template_key","file_type");--> statement-breakpoint
CREATE INDEX "runs_workflow_version_idx" ON "runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "runs_status_idx" ON "runs" USING btree ("status");--> statement-breakpoint
CREATE INDEX "runs_created_by_idx" ON "runs" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "runs_created_at_idx" ON "runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "script_execution_log_run_idx" ON "script_execution_log" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_events_request_idx" ON "signature_events" USING btree ("signature_request_id");--> statement-breakpoint
CREATE INDEX "signature_requests_run_idx" ON "signature_requests" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_requests_token_idx" ON "signature_requests" USING btree ("token");--> statement-breakpoint
CREATE INDEX "sli_configs_project_idx" ON "sli_configs" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "sli_windows_project_window_idx" ON "sli_windows" USING btree ("project_id","window_start","window_end");--> statement-breakpoint
CREATE INDEX "step_values_run_idx" ON "step_values" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "step_values_step_idx" ON "step_values" USING btree ("step_id");--> statement-breakpoint
CREATE INDEX "step_values_run_step_idx" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE UNIQUE INDEX "step_values_run_step_unique" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE INDEX "template_metrics_template_idx" ON "template_generation_metrics" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_metrics_run_idx" ON "template_generation_metrics" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_run_idx" ON "transform_block_runs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_block_idx" ON "transform_block_runs" USING btree ("block_id");--> statement-breakpoint
CREATE UNIQUE INDEX "was_workflow_version_date_idx" ON "workflow_analytics_snapshots" USING btree ("workflow_id","version_id","date");--> statement-breakpoint
CREATE INDEX "wre_run_idx" ON "workflow_run_events" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "wre_workflow_ts_idx" ON "workflow_run_events" USING btree ("workflow_id","timestamp");--> statement-breakpoint
CREATE INDEX "wrm_workflow_created_idx" ON "workflow_run_metrics" USING btree ("workflow_id","created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_workflow_idx" ON "workflow_runs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_version_idx" ON "workflow_runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_completed_idx" ON "workflow_runs" USING btree ("completed");--> statement-breakpoint
CREATE INDEX "workflow_runs_run_token_idx" ON "workflow_runs" USING btree ("run_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_share_token_idx" ON "workflow_runs" USING btree ("share_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_current_section_idx" ON "workflow_runs" USING btree ("current_section_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_created_at_idx" ON "workflow_runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_owner_idx" ON "workflow_runs" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "analytics_survey_event_idx" ON "analytics_events" USING btree ("survey_id","event");--> statement-breakpoint
CREATE INDEX "analytics_response_event_idx" ON "analytics_events" USING btree ("response_id","event");--> statement-breakpoint
CREATE INDEX "analytics_timestamp_idx" ON "analytics_events" USING btree ("timestamp");--> statement-breakpoint
CREATE INDEX "anonymous_tracking_survey_ip_idx" ON "anonymous_response_tracking" USING btree ("survey_id","ip_address");--> statement-breakpoint
CREATE INDEX "email_queue_status_idx" ON "email_queue" USING btree ("status");--> statement-breakpoint
CREATE INDEX "email_queue_next_attempt_idx" ON "email_queue" USING btree ("next_attempt_at");--> statement-breakpoint
CREATE INDEX "survey_templates_creator_idx" ON "survey_templates" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "survey_templates_system_idx" ON "survey_templates" USING btree ("is_system");--> statement-breakpoint
CREATE INDEX "surveys_public_link_unique_idx" ON "surveys" USING btree ("public_link");--> statement-breakpoint
CREATE INDEX "surveys_workspace_idx" ON "surveys" USING btree ("workspace_id");--> statement-breakpoint
CREATE INDEX "template_shares_template_idx" ON "template_shares" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_shares_user_idx" ON "template_shares" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "template_shares_pending_email_idx" ON "template_shares" USING btree ("pending_email");--> statement-breakpoint
CREATE INDEX "collection_fields_collection_idx" ON "collection_fields" USING btree ("collection_id");--> statement-breakpoint
CREATE UNIQUE INDEX "collection_fields_slug_unique" ON "collection_fields" USING btree ("collection_id","slug");--> statement-breakpoint
CREATE UNIQUE INDEX "collections_slug_unique" ON "collections" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_database_id" ON "datavault_api_tokens" USING btree ("database_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE INDEX "datavault_columns_table_idx" ON "datavault_columns" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_columns_reference_table_idx" ON "datavault_columns" USING btree ("reference_table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_columns_table_slug_unique" ON "datavault_columns" USING btree ("table_id","slug");--> statement-breakpoint
CREATE INDEX "idx_databases_tenant" ON "datavault_databases" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_databases_scope" ON "datavault_databases" USING btree ("scope_type","scope_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_databases_owner" ON "datavault_databases" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_tenant" ON "datavault_number_sequences" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_table" ON "datavault_number_sequences" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "idx_datavault_sequences_column_unique" ON "datavault_number_sequences" USING btree ("tenant_id","table_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_row_id" ON "datavault_row_notes" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_tenant_id" ON "datavault_row_notes" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_table_idx" ON "datavault_rows" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_created_by_idx" ON "datavault_rows" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "idx_table_permissions_table" ON "datavault_table_permissions" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_table_user_permission" ON "datavault_table_permissions" USING btree ("table_id","user_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_tenant_idx" ON "datavault_tables" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_owner_idx" ON "datavault_tables" USING btree ("owner_user_id");--> statement-breakpoint
CREATE INDEX "idx_tables_database" ON "datavault_tables" USING btree ("database_id","tenant_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_tables_tenant_slug_unique" ON "datavault_tables" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "datavault_values_row_idx" ON "datavault_values" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "datavault_values_column_idx" ON "datavault_values" USING btree ("column_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_values_row_column_unique" ON "datavault_values" USING btree ("row_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_writeback_mappings_workflow" ON "datavault_writeback_mappings" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "records_collection_idx" ON "records" USING btree ("collection_id");--> statement-breakpoint
CREATE INDEX "records_tenant_idx" ON "records" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_data_sources_workflow" ON "workflow_data_sources" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_queries_workflow" ON "workflow_queries" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "api_keys_project_idx" ON "api_keys" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_tenant_idx" ON "connections" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "connections_project_idx" ON "connections" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_project_name_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "connections_type_idx" ON "connections" USING btree ("type");--> statement-breakpoint
CREATE INDEX "connections_enabled_idx" ON "connections" USING btree ("enabled");--> statement-breakpoint
CREATE UNIQUE INDEX "connections_project_name_unique_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "ext_dest_tenant_idx" ON "external_destinations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_client_id_idx" ON "oauth_apps" USING btree ("client_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_workspace_idx" ON "oauth_apps" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "secrets_project_key_env_unique" ON "secrets" USING btree ("project_id","key","environment");--> statement-breakpoint
CREATE INDEX "webhook_events_sub_idx" ON "webhook_events" USING btree ("subscription_id");--> statement-breakpoint
CREATE INDEX "webhook_subs_workspace_idx" ON "webhook_subscriptions" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_org_idx" ON "customer_billing_info" USING btree ("organization_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_stripe_idx" ON "customer_billing_info" USING btree ("stripe_customer_id");--> statement-breakpoint
CREATE UNIQUE INDEX "seat_sub_user_idx" ON "subscription_seats" USING btree ("subscription_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "sub_org_idx" ON "subscriptions" USING btree ("organization_id");--> statement-breakpoint
CREATE INDEX "usage_org_metric_date_idx" ON "usage_records" USING btree ("organization_id","metric","recorded_at");--> statement-breakpoint
CREATE INDEX "email_templates_key_idx" ON "email_template_metadata" USING btree ("template_key");--> statement-breakpoint
CREATE INDEX "ai_settings_scope_idx" ON "ai_settings" USING btree ("scope");
params: 
ΓÜá∩╕Å Migrations failed (non-fatal if DB exists): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public;

CREATE TYPE "test_schema_w0_v3"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint
CREATE TABLE "account_locks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"locked_at" timestamp DEFAULT now() NOT NULL,
	"locked_until" timestamp NOT NULL,
	"reason" varchar(255),
	"unlocked" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "audit_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"workspace_id" uuid,
	"user_id" varchar,
	"action" varchar NOT NULL,
	"entity_type" varchar NOT NULL,
	"entity_id" varchar NOT NULL,
	"resource_type" varchar,
	"resource_id" varchar,
	"changes" jsonb,
	"details" jsonb,
	"ip_address" varchar,
	"user_agent" text,
	"created_at" timestamp DEFAULT now(),
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_verification_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "login_attempts" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"ip_address" varchar(45),
	"successful" boolean DEFAULT false NOT NULL,
	"attempted_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_backup_codes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"code_hash" text NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"secret" text NOT NULL,
	"enabled" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"enabled_at" timestamp,
	CONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "organization_invites" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"invited_email" varchar(255) NOT NULL,
	"invited_user_id" varchar,
	"invited_by_user_id" varchar NOT NULL,
	"token" varchar(255) NOT NULL,
	"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp NOT NULL,
	"accepted_at" timestamp,
	"email_sent_at" timestamp,
	"email_failed" boolean DEFAULT false,
	"email_error" text,
	CONSTRAINT "organization_invites_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "organization_memberships" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "organization_role" DEFAULT 'member' NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "organizations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"slug" varchar,
	"domain" varchar,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"tenant_id" uuid NOT NULL,
	"created_by_user_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "organizations_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "password_reset_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "portal_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "portal_tokens_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "refresh_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"revoked" boolean DEFAULT false NOT NULL,
	"metadata" jsonb,
	"device_name" varchar(255),
	"ip_address" varchar(45),
	"location" varchar(255),
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sessions" (
	"sid" varchar PRIMARY KEY NOT NULL,
	"sess" jsonb NOT NULL,
	"expire" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE "team_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"team_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" varchar(50) DEFAULT 'member' NOT NULL,
	"joined_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "teams" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "tenant_domains" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"domain" text NOT NULL,
	"verified" boolean DEFAULT false,
	"verification_token" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "tenant_domains_domain_unique" UNIQUE("domain")
);
--> statement-breakpoint
CREATE TABLE "tenants" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar(255) NOT NULL,
	"billing_email" varchar(255),
	"plan" "tenant_plan" DEFAULT 'free' NOT NULL,
	"mfa_required" boolean DEFAULT false NOT NULL,
	"branding" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "trusted_devices" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"device_fingerprint" varchar(255) NOT NULL,
	"device_name" varchar(255),
	"trusted_until" timestamp NOT NULL,
	"ip_address" varchar(45),
	"location" varchar(255),
	"user_agent" text,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"last_used_at" timestamp,
	"revoked" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "user_credentials" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"password_hash" text NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "user_credentials_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "user_personalization_settings" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"reading_level" varchar DEFAULT 'standard' NOT NULL,
	"tone" varchar DEFAULT 'neutral' NOT NULL,
	"verbosity" varchar DEFAULT 'standard' NOT NULL,
	"language" varchar DEFAULT 'en' NOT NULL,
	"allow_adaptive_prompts" boolean DEFAULT true NOT NULL,
	"allow_ai_clarification" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "user_preferences" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"settings" jsonb DEFAULT '{"celebrationEffects":true,"darkMode":"system","aiHints":true}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "users" (
	"id" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"full_name" varchar(255),
	"first_name" varchar(255),
	"last_name" varchar(255),
	"profile_image_url" varchar(500),
	"tenant_id" uuid,
	"role" "user_role" DEFAULT 'creator' NOT NULL,
	"tenant_role" "user_tenant_role",
	"auth_provider" "auth_provider" DEFAULT 'local' NOT NULL,
	"default_mode" text DEFAULT 'easy' NOT NULL,
	"email_verified" boolean DEFAULT false NOT NULL,
	"mfa_enabled" boolean DEFAULT false NOT NULL,
	"last_password_change" timestamp,
	"is_placeholder" boolean DEFAULT false NOT NULL,
	"placeholder_email" varchar(255),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_invitations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"email" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"invited_by" varchar NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"joined_at" timestamp DEFAULT now(),
	"invited_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workspaces" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"slug" varchar NOT NULL,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"type" "block_type" NOT NULL,
	"phase" "block_phase" NOT NULL,
	"config" jsonb NOT NULL,
	"virtual_step_id" uuid,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_docs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid,
	"tenant_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"clock" integer NOT NULL,
	"state" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "collab_updates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"seq" integer NOT NULL,
	"update" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "document_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"final_block_document_id" varchar(255),
	"name" varchar(255) NOT NULL,
	"phase" "document_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 3000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "lifecycle_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar(255) NOT NULL,
	"phase" "lifecycle_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"virtual_step_ids" uuid[] DEFAULT '{}'::uuid[],
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"mutation_mode" boolean DEFAULT false,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "logic_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"condition_step_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_type" "logic_rule_target_type" NOT NULL,
	"target_step_id" uuid,
	"target_section_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "project_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "projects" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"name" varchar(255),
	"description" text,
	"creator_id" varchar NOT NULL,
	"tenant_id" uuid,
	"created_by" varchar,
	"owner_id" varchar NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"status" "project_status" DEFAULT 'active' NOT NULL,
	"archived" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"order" integer NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"visible_if" jsonb,
	"skip_if" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "steps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"section_id" uuid NOT NULL,
	"type" "step_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"alias" text,
	"default_value" jsonb,
	"order" integer NOT NULL,
	"is_virtual" boolean DEFAULT false NOT NULL,
	"visible_if" jsonb,
	"repeater_config" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"version_number" integer NOT NULL,
	"file_ref" varchar(500) NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"notes" text,
	"is_active" boolean DEFAULT true
);
--> statement-breakpoint
CREATE TABLE "templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"file_ref" varchar(500) NOT NULL,
	"type" "template_type" NOT NULL,
	"helpers_version" integer DEFAULT 1 NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"current_version" integer DEFAULT 1,
	"last_modified_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_key" varchar NOT NULL,
	"virtual_step_id" uuid,
	"phase" "block_phase" DEFAULT 'onSectionSubmit' NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_blueprints" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"creator_id" varchar NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"graph_json" jsonb NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"source_workflow_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"name" text NOT NULL,
	"values" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"workflow_version_id" uuid,
	"version_hash" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_id" uuid NOT NULL,
	"key" text NOT NULL,
	"is_primary" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"base_id" uuid,
	"version_number" integer DEFAULT 1 NOT NULL,
	"is_draft" boolean DEFAULT false NOT NULL,
	"graph_json" jsonb NOT NULL,
	"migration_info" jsonb,
	"changelog" jsonb,
	"notes" text,
	"checksum" text,
	"created_by" varchar NOT NULL,
	"published" boolean DEFAULT false NOT NULL,
	"published_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"description" text,
	"creator_id" varchar,
	"owner_id" varchar,
	"mode_override" text,
	"public_link" text,
	"name" varchar(255),
	"project_id" uuid,
	"current_version_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"slug" text,
	"require_login" boolean DEFAULT false NOT NULL,
	"intake_config" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"pinned_version_id" uuid,
	"status" "workflow_status" DEFAULT 'draft' NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"source_blueprint_id" uuid,
	CONSTRAINT "workflows_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "ai_workflow_feedback" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid,
	"user_id" varchar,
	"operation_type" varchar NOT NULL,
	"rating" integer NOT NULL,
	"comment" text,
	"ai_provider" varchar,
	"ai_model" varchar,
	"prompt_version" varchar,
	"quality_score" integer,
	"quality_passed" boolean,
	"issues_count" integer,
	"request_description" text,
	"generated_sections" integer,
	"generated_steps" integer,
	"was_edited" boolean DEFAULT false,
	"edit_count" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "block_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"block_id" varchar NOT NULL,
	"total_visits" integer DEFAULT 0,
	"avg_time_ms" integer DEFAULT 0,
	"dropoff_count" integer DEFAULT 0,
	"validation_error_count" integer DEFAULT 0,
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"run_id" uuid,
	"type" "metrics_event_type" NOT NULL,
	"ts" timestamp with time zone DEFAULT now() NOT NULL,
	"duration_ms" integer,
	"payload" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_rollups" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"bucket_start" timestamp with time zone NOT NULL,
	"bucket" "rollup_bucket" NOT NULL,
	"runs_count" integer DEFAULT 0 NOT NULL,
	"runs_success" integer DEFAULT 0 NOT NULL,
	"runs_error" integer DEFAULT 0 NOT NULL,
	"dur_p50" integer,
	"dur_p95" integer,
	"pdf_success" integer DEFAULT 0 NOT NULL,
	"pdf_error" integer DEFAULT 0 NOT NULL,
	"docx_success" integer DEFAULT 0 NOT NULL,
	"docx_error" integer DEFAULT 0 NOT NULL,
	"queue_enqueued" integer DEFAULT 0 NOT NULL,
	"queue_dequeued" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "review_tasks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"status" "review_task_status" DEFAULT 'pending' NOT NULL,
	"reviewer_id" varchar,
	"reviewer_email" varchar(255),
	"message" text,
	"comment" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"resolved_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "run_generated_documents" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"file_name" text NOT NULL,
	"file_url" text NOT NULL,
	"mime_type" text,
	"file_size" integer,
	"template_id" uuid,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"node_id" varchar(100),
	"level" "log_level" NOT NULL,
	"message" text NOT NULL,
	"context" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_outputs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_key" text NOT NULL,
	"file_type" "output_file_type" NOT NULL,
	"storage_path" text NOT NULL,
	"status" "output_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"input_json" jsonb,
	"output_refs" jsonb,
	"trace" jsonb,
	"status" "run_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"duration_ms" integer,
	"run_token" varchar,
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "script_execution_log" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"script_type" varchar(50) NOT NULL,
	"script_id" uuid NOT NULL,
	"script_name" varchar(255),
	"phase" varchar(50),
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "script_execution_status" NOT NULL,
	"error_message" text,
	"console_output" jsonb,
	"input_sample" jsonb,
	"output_sample" jsonb,
	"duration_ms" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "signature_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"signature_request_id" uuid NOT NULL,
	"type" "signature_event_type" NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb
);
--> statement-breakpoint
CREATE TABLE "signature_requests" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"signer_email" varchar(255) NOT NULL,
	"signer_name" varchar(255),
	"status" "signature_request_status" DEFAULT 'pending' NOT NULL,
	"provider" "signature_provider" DEFAULT 'native' NOT NULL,
	"provider_request_id" text,
	"token" text NOT NULL,
	"document_url" text,
	"redirect_url" text,
	"message" text,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"signed_at" timestamp,
	CONSTRAINT "signature_requests_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "sli_configs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"target_success_pct" integer DEFAULT 99 NOT NULL,
	"target_p95_ms" integer DEFAULT 5000 NOT NULL,
	"error_budget_pct" integer DEFAULT 1 NOT NULL,
	"window" "sli_window" DEFAULT '7d' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sli_windows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"window_start" timestamp with time zone NOT NULL,
	"window_end" timestamp with time zone NOT NULL,
	"success_pct" integer,
	"p95_ms" integer,
	"error_budget_burn_pct" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "step_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"step_id" uuid NOT NULL,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_generation_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"run_id" uuid,
	"result" varchar(50) NOT NULL,
	"duration_ms" integer,
	"error_message" text,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_block_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"block_id" uuid NOT NULL,
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "transform_block_run_status" NOT NULL,
	"error_message" text,
	"output_sample" jsonb
);
--> statement-breakpoint
CREATE TABLE "workflow_analytics_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"date" timestamp NOT NULL,
	"summary" jsonb NOT NULL,
	"dropoff" jsonb NOT NULL,
	"branching" jsonb NOT NULL,
	"heatmap" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_run_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"block_id" varchar,
	"page_id" uuid,
	"type" varchar NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb,
	"is_preview" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_run_metrics" (
	"run_id" uuid PRIMARY KEY NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"total_time_ms" integer,
	"pages_visited" integer DEFAULT 0,
	"blocks_visited" integer DEFAULT 0,
	"validation_errors" integer DEFAULT 0,
	"script_errors" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"is_preview" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"workflow_version_id" uuid,
	"run_token" text NOT NULL,
	"created_by" text,
	"current_section_id" uuid,
	"progress" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"metadata" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"client_email" varchar,
	"portal_access_key" varchar,
	"access_mode" "portal_access_mode" DEFAULT 'anonymous',
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"owner_type" varchar(50),
	"owner_uuid" uuid,
	CONSTRAINT "workflow_runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "workflow_runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "analytics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"survey_id" uuid NOT NULL,
	"page_id" uuid,
	"question_id" uuid,
	"event" varchar NOT NULL,
	"data" jsonb,
	"duration" integer,
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "anonymous_response_tracking" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"ip_address" varchar NOT NULL,
	"session_id" varchar,
	"response_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "answers" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"question_id" uuid NOT NULL,
	"subquestion_id" uuid,
	"loop_index" integer,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "conditional_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"condition_question_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_question_id" uuid,
	"target_page_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_queue" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"to" varchar NOT NULL,
	"subject" varchar NOT NULL,
	"html" text NOT NULL,
	"status" "email_queue_status" DEFAULT 'pending' NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_error" text,
	"next_attempt_at" timestamp DEFAULT now(),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "files" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"answer_id" uuid NOT NULL,
	"filename" varchar NOT NULL,
	"original_name" varchar NOT NULL,
	"mime_type" varchar NOT NULL,
	"size" integer NOT NULL,
	"uploaded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "loop_group_subquestions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"loop_question_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "questions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"page_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"conditional_logic" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "responses" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"completed" boolean DEFAULT false,
	"submitted_at" timestamp,
	"is_anonymous" boolean DEFAULT false,
	"ip_address" varchar,
	"user_agent" text,
	"session_id" varchar,
	"anonymous_metadata" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_pages" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" text NOT NULL,
	"description" text,
	"content" jsonb NOT NULL,
	"creator_id" varchar,
	"is_system" boolean DEFAULT false NOT NULL,
	"tags" text[] DEFAULT ARRAY[]::text[],
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "surveys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"creator_id" varchar NOT NULL,
	"workspace_id" uuid,
	"status" "survey_status" DEFAULT 'draft' NOT NULL,
	"allow_anonymous" boolean DEFAULT false,
	"anonymous_access_type" "anonymous_access_type" DEFAULT 'unlimited',
	"public_link" varchar,
	"anonymous_config" jsonb,
	"is_public" boolean DEFAULT false,
	"public_access_mode" "public_access_mode" DEFAULT 'link_only',
	"public_slug" varchar,
	"allowed_domains" jsonb,
	"public_settings" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "surveys_public_link_unique" UNIQUE("public_link"),
	CONSTRAINT "surveys_public_slug_unique" UNIQUE("public_slug")
);
--> statement-breakpoint
CREATE TABLE "template_shares" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"user_id" varchar,
	"pending_email" text,
	"access" "template_access" DEFAULT 'use' NOT NULL,
	"invited_at" timestamp with time zone DEFAULT now(),
	"accepted_at" timestamp with time zone
);
--> statement-breakpoint
CREATE TABLE "collection_fields" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"collection_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"type" varchar(50) NOT NULL,
	"options" jsonb,
	"required" boolean DEFAULT false,
	"order" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_api_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"database_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"label" text NOT NULL,
	"token_hash" text NOT NULL,
	"scopes" text[] DEFAULT ARRAY[]::text[] NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "datavault_columns" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"type" "datavault_column_type" NOT NULL,
	"description" text,
	"width_px" integer DEFAULT 150,
	"required" boolean DEFAULT false NOT NULL,
	"is_primary_key" boolean DEFAULT false NOT NULL,
	"is_unique" boolean DEFAULT false NOT NULL,
	"order_index" integer DEFAULT 0 NOT NULL,
	"auto_number_start" integer DEFAULT 1,
	"autonumber_prefix" text,
	"autonumber_padding" integer DEFAULT 4,
	"autonumber_reset_policy" "autonumber_reset_policy" DEFAULT 'never',
	"reference_table_id" uuid,
	"reference_display_column_slug" text,
	"options" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_databases" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"type" "data_source_type" DEFAULT 'native' NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"scope_type" "datavault_scope_type" DEFAULT 'account' NOT NULL,
	"scope_id" uuid,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_number_sequences" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"prefix" text,
	"padding" integer DEFAULT 4 NOT NULL,
	"next_value" integer DEFAULT 1 NOT NULL,
	"reset_policy" "autonumber_reset_policy" DEFAULT 'never' NOT NULL,
	"last_reset" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_row_notes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"text" text NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_rows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"deleted_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "datavault_table_permissions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "datavault_table_role" NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_tables" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"owner_user_id" varchar,
	"database_id" uuid,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"value" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_writeback_mappings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_mappings" jsonb NOT NULL,
	"trigger_phase" varchar(50) DEFAULT 'afterComplete' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar
);
--> statement-breakpoint
CREATE TABLE "records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"collection_id" uuid NOT NULL,
	"data" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workflow_data_sources" (
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "workflow_data_sources_workflow_id_data_source_id_pk" PRIMARY KEY("workflow_id","data_source_id")
);
--> statement-breakpoint
CREATE TABLE "workflow_queries" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"filters" jsonb DEFAULT '[]'::jsonb,
	"sort" jsonb DEFAULT '[]'::jsonb,
	"limit" integer,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "api_keys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"prefix" varchar(50) NOT NULL,
	"key_hash" varchar(255) NOT NULL,
	"scopes" text[] NOT NULL,
	"name" varchar NOT NULL,
	"expires_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "api_keys_key_hash_unique" UNIQUE("key_hash")
);
--> statement-breakpoint
CREATE TABLE "connections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"type" "connection_type" NOT NULL,
	"base_url" varchar(500),
	"auth_config" jsonb DEFAULT '{}'::jsonb,
	"secret_refs" jsonb DEFAULT '{}'::jsonb,
	"oauth_state" jsonb,
	"default_headers" jsonb DEFAULT '{}'::jsonb,
	"timeout_ms" integer DEFAULT 8000,
	"retries" integer DEFAULT 2,
	"backoff_ms" integer DEFAULT 250,
	"enabled" boolean DEFAULT true NOT NULL,
	"last_tested_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "external_destinations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"config" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "oauth_access_tokens" (
	"access_token" varchar PRIMARY KEY NOT NULL,
	"refresh_token" varchar,
	"client_id" varchar NOT NULL,
	"user_id" varchar,
	"workspace_id" uuid NOT NULL,
	"scope" jsonb,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_access_tokens_refresh_token_unique" UNIQUE("refresh_token")
);
--> statement-breakpoint
CREATE TABLE "oauth_apps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"client_id" varchar NOT NULL,
	"client_secret_hash" varchar NOT NULL,
	"redirect_uris" jsonb NOT NULL,
	"scopes" jsonb NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_apps_client_id_unique" UNIQUE("client_id")
);
--> statement-breakpoint
CREATE TABLE "oauth_auth_codes" (
	"code" varchar PRIMARY KEY NOT NULL,
	"client_id" varchar NOT NULL,
	"user_id" varchar NOT NULL,
	"scope" jsonb,
	"redirect_uri" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"key" varchar NOT NULL,
	"value" text,
	"value_enc" text NOT NULL,
	"type" "secret_type" DEFAULT 'api_key' NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"environment" varchar DEFAULT 'production',
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"event" varchar NOT NULL,
	"payload" jsonb NOT NULL,
	"status" varchar NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_attempt_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"target_url" varchar NOT NULL,
	"events" jsonb NOT NULL,
	"secret" varchar NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "billing_plans" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"price_monthly" integer DEFAULT 0 NOT NULL,
	"price_yearly" integer DEFAULT 0 NOT NULL,
	"features" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"limits" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"stripe_product_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "customer_billing_info" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"stripe_customer_id" varchar NOT NULL,
	"billing_email" varchar,
	"default_payment_method_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscription_seats" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"assigned_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"plan_id" uuid NOT NULL,
	"status" "subscription_status" DEFAULT 'active' NOT NULL,
	"stripe_subscription_id" varchar,
	"current_period_start" timestamp,
	"current_period_end" timestamp,
	"cancel_at_period_end" boolean DEFAULT false,
	"canceled_at" timestamp,
	"trial_start" timestamp,
	"trial_end" timestamp,
	"seat_quantity" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "usage_records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"metric" varchar NOT NULL,
	"quantity" integer DEFAULT 1 NOT NULL,
	"workflow_id" uuid,
	"metadata" jsonb,
	"recorded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_template_metadata" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_key" varchar(255) NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"subject_preview" text,
	"branding_tokens" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "email_template_metadata_template_key_unique" UNIQUE("template_key")
);
--> statement-breakpoint
CREATE TABLE "ai_settings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"scope" varchar DEFAULT 'global' NOT NULL,
	"system_prompt" text,
	"updated_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
ALTER TABLE "account_locks" ADD CONSTRAINT "account_locks_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "email_verification_tokens" ADD CONSTRAINT "email_verification_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_backup_codes" ADD CONSTRAINT "mfa_backup_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_secrets" ADD CONSTRAINT "mfa_secrets_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_user_id_users_id_fk" FOREIGN KEY ("invited_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_by_user_id_users_id_fk" FOREIGN KEY ("invited_by_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_created_by_user_id_users_id_fk" FOREIGN KEY ("created_by_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "password_reset_tokens" ADD CONSTRAINT "password_reset_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "refresh_tokens" ADD CONSTRAINT "refresh_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_team_id_teams_id_fk" FOREIGN KEY ("team_id") REFERENCES "test_schema_w0_v3"."teams"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "teams" ADD CONSTRAINT "teams_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "tenant_domains" ADD CONSTRAINT "tenant_domains_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "trusted_devices" ADD CONSTRAINT "trusted_devices_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_credentials" ADD CONSTRAINT "user_credentials_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_personalization_settings" ADD CONSTRAINT "user_personalization_settings_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_preferences" ADD CONSTRAINT "user_preferences_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "users" ADD CONSTRAINT "users_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspaces" ADD CONSTRAINT "workspaces_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_snapshots" ADD CONSTRAINT "collab_snapshots_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "test_schema_w0_v3"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_updates" ADD CONSTRAINT "collab_updates_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "test_schema_w0_v3"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "document_hooks" ADD CONSTRAINT "document_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_condition_step_id_steps_id_fk" FOREIGN KEY ("condition_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_step_id_steps_id_fk" FOREIGN KEY ("target_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_section_id_sections_id_fk" FOREIGN KEY ("target_section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "project_access" ADD CONSTRAINT "project_access_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sections" ADD CONSTRAINT "sections_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "steps" ADD CONSTRAINT "steps_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_last_modified_by_users_id_fk" FOREIGN KEY ("last_modified_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_access" ADD CONSTRAINT "workflow_access_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_source_workflow_id_workflows_id_fk" FOREIGN KEY ("source_workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_base_id_workflows_id_fk" FOREIGN KEY ("base_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_reviewer_id_users_id_fk" FOREIGN KEY ("reviewer_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_template_id_workflow_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."workflow_templates"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_logs" ADD CONSTRAINT "run_logs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "script_execution_log" ADD CONSTRAINT "script_execution_log_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_events" ADD CONSTRAINT "signature_events_signature_request_id_signature_requests_id_fk" FOREIGN KEY ("signature_request_id") REFERENCES "test_schema_w0_v3"."signature_requests"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_step_id_steps_id_fk" FOREIGN KEY ("step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_block_id_transform_blocks_id_fk" FOREIGN KEY ("block_id") REFERENCES "test_schema_w0_v3"."transform_blocks"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_current_section_id_sections_id_fk" FOREIGN KEY ("current_section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "test_schema_w0_v3"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "test_schema_w0_v3"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "test_schema_w0_v3"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "test_schema_w0_v3"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_subquestion_id_loop_group_subquestions_id_fk" FOREIGN KEY ("subquestion_id") REFERENCES "test_schema_w0_v3"."loop_group_subquestions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_condition_question_id_questions_id_fk" FOREIGN KEY ("condition_question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_question_id_questions_id_fk" FOREIGN KEY ("target_question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_page_id_survey_pages_id_fk" FOREIGN KEY ("target_page_id") REFERENCES "test_schema_w0_v3"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "files" ADD CONSTRAINT "files_answer_id_answers_id_fk" FOREIGN KEY ("answer_id") REFERENCES "test_schema_w0_v3"."answers"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "loop_group_subquestions" ADD CONSTRAINT "loop_group_subquestions_loop_question_id_questions_id_fk" FOREIGN KEY ("loop_question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "questions" ADD CONSTRAINT "questions_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "test_schema_w0_v3"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "responses" ADD CONSTRAINT "responses_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_pages" ADD CONSTRAINT "survey_pages_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_templates" ADD CONSTRAINT "survey_templates_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_template_id_survey_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."survey_templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collection_fields" ADD CONSTRAINT "collection_fields_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "test_schema_w0_v3"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collections" ADD CONSTRAINT "collections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_columns" ADD CONSTRAINT "datavault_columns_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_databases" ADD CONSTRAINT "datavault_databases_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "test_schema_w0_v3"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "test_schema_w0_v3"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_owner_user_id_users_id_fk" FOREIGN KEY ("owner_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "test_schema_w0_v3"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "test_schema_w0_v3"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "test_schema_w0_v3"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "api_keys" ADD CONSTRAINT "api_keys_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "external_destinations" ADD CONSTRAINT "external_destinations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "test_schema_w0_v3"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_apps" ADD CONSTRAINT "oauth_apps_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "test_schema_w0_v3"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "secrets" ADD CONSTRAINT "secrets_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_events" ADD CONSTRAINT "webhook_events_subscription_id_webhook_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "test_schema_w0_v3"."webhook_subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_subscriptions" ADD CONSTRAINT "webhook_subscriptions_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "customer_billing_info" ADD CONSTRAINT "customer_billing_info_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_subscription_id_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "test_schema_w0_v3"."subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_plan_id_billing_plans_id_fk" FOREIGN KEY ("plan_id") REFERENCES "test_schema_w0_v3"."billing_plans"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_settings" ADD CONSTRAINT "ai_settings_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
CREATE INDEX "account_locks_user_idx" ON "account_locks" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "account_locks_until_idx" ON "account_locks" USING btree ("locked_until");--> statement-breakpoint
CREATE INDEX "audit_logs_tenant_idx" ON "audit_logs" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "audit_logs_user_idx" ON "audit_logs" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "audit_logs_action_idx" ON "audit_logs" USING btree ("action");--> statement-breakpoint
CREATE INDEX "email_verify_token_idx" ON "email_verification_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "email_verify_user_idx" ON "email_verification_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "login_attempts_email_idx" ON "login_attempts" USING btree ("email");--> statement-breakpoint
CREATE INDEX "login_attempts_timestamp_idx" ON "login_attempts" USING btree ("attempted_at");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_user_idx" ON "mfa_backup_codes" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_hash_idx" ON "mfa_backup_codes" USING btree ("code_hash");--> statement-breakpoint
CREATE INDEX "mfa_secrets_user_idx" ON "mfa_secrets" USING btree ("user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "org_invites_token_unique_idx" ON "organization_invites" USING btree ("token");--> statement-breakpoint
CREATE INDEX "idx_org_invites_org_email_status" ON "organization_invites" USING btree ("org_id","invited_email","status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_status" ON "organization_invites" USING btree ("status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_expires" ON "organization_invites" USING btree ("expires_at");--> statement-breakpoint
CREATE UNIQUE INDEX "org_membership_unique_idx" ON "organization_memberships" USING btree ("org_id","user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_org" ON "organization_memberships" USING btree ("org_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_user" ON "organization_memberships" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_role" ON "organization_memberships" USING btree ("role");--> statement-breakpoint
CREATE INDEX "idx_organizations_created_by" ON "organizations" USING btree ("created_by_user_id");--> statement-breakpoint
CREATE INDEX "idx_organizations_tenant" ON "organizations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "pwd_reset_token_idx" ON "password_reset_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "pwd_reset_user_idx" ON "password_reset_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_user_idx" ON "refresh_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_token_idx" ON "refresh_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "IDX_session_expire" ON "sessions" USING btree ("expire");--> statement-breakpoint
CREATE UNIQUE INDEX "team_members_idx" ON "team_members" USING btree ("team_id","user_id");--> statement-breakpoint
CREATE INDEX "teams_tenant_idx" ON "teams" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_tenant_idx" ON "tenant_domains" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_domain_idx" ON "tenant_domains" USING btree ("domain");--> statement-breakpoint
CREATE INDEX "tenants_plan_idx" ON "tenants" USING btree ("plan");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_idx" ON "trusted_devices" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "trusted_devices_fingerprint_idx" ON "trusted_devices" USING btree ("device_fingerprint");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_fingerprint_idx" ON "trusted_devices" USING btree ("user_id","device_fingerprint");--> statement-breakpoint
CREATE INDEX "user_credentials_user_idx" ON "user_credentials" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "users_email_idx" ON "users" USING btree ("email");--> statement-breakpoint
CREATE INDEX "users_tenant_idx" ON "users" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "users_tenant_email_idx" ON "users" USING btree ("tenant_id","email");--> statement-breakpoint
CREATE INDEX "idx_users_is_placeholder" ON "users" USING btree ("is_placeholder");--> statement-breakpoint
CREATE INDEX "idx_users_placeholder_email" ON "users" USING btree ("placeholder_email");--> statement-breakpoint
CREATE INDEX "invitation_token_idx" ON "workspace_invitations" USING btree ("token");--> statement-breakpoint
CREATE INDEX "invitation_ws_email_idx" ON "workspace_invitations" USING btree ("workspace_id","email");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_member_idx" ON "workspace_members" USING btree ("workspace_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_org_slug_idx" ON "workspaces" USING btree ("organization_id","slug");--> statement-breakpoint
CREATE INDEX "blocks_workflow_phase_order_idx" ON "blocks" USING btree ("workflow_id","phase","order");--> statement-breakpoint
CREATE INDEX "collab_docs_workflow_idx" ON "collab_docs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "collab_snapshots_doc_clock_idx" ON "collab_snapshots" USING btree ("doc_id","clock");--> statement-breakpoint
CREATE INDEX "collab_updates_doc_seq_idx" ON "collab_updates" USING btree ("doc_id","seq");--> statement-breakpoint
CREATE INDEX "logic_rules_workflow_idx" ON "logic_rules" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "project_access_project_idx" ON "project_access" USING btree ("project_id");--> statement-breakpoint
CREATE UNIQUE INDEX "project_access_principal_idx" ON "project_access" USING btree ("project_id","principal_type","principal_id");--> statement-breakpoint
CREATE INDEX "projects_tenant_idx" ON "projects" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "projects_created_by_idx" ON "projects" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "projects_creator_idx" ON "projects" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "projects_owner_idx" ON "projects" USING btree ("owner_id");--> statement-breakpoint
CREATE INDEX "idx_projects_owner" ON "projects" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "projects_status_idx" ON "projects" USING btree ("status");--> statement-breakpoint
CREATE INDEX "projects_archived_idx" ON "projects" USING btree ("archived");--> statement-breakpoint
CREATE INDEX "sections_workflow_idx" ON "sections" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "steps_section_idx" ON "steps" USING btree ("section_id");--> statement-breakpoint
CREATE UNIQUE INDEX "template_versions_unique_idx" ON "template_versions" USING btree ("template_id","version_number");--> statement-breakpoint
CREATE INDEX "templates_project_idx" ON "templates" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflow_access_workflow_idx" ON "workflow_access" USING btree ("workflow_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_access_principal_idx" ON "workflow_access" USING btree ("workflow_id","principal_type","principal_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_snapshots_workflow_name_unique" ON "workflow_snapshots" USING btree ("workflow_id","name");--> statement-breakpoint
CREATE INDEX "workflow_templates_version_key_unique" ON "workflow_templates" USING btree ("workflow_version_id","key");--> statement-breakpoint
CREATE INDEX "workflow_versions_workflow_idx" ON "workflow_versions" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_versions_version_number_idx" ON "workflow_versions" USING btree ("workflow_id","version_number");--> statement-breakpoint
CREATE INDEX "workflow_versions_is_draft_idx" ON "workflow_versions" USING btree ("is_draft");--> statement-breakpoint
CREATE INDEX "workflows_project_idx" ON "workflows" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflows_status_idx" ON "workflows" USING btree ("status");--> statement-breakpoint
CREATE INDEX "workflows_is_public_idx" ON "workflows" USING btree ("is_public");--> statement-breakpoint
CREATE INDEX "workflows_slug_idx" ON "workflows" USING btree ("slug");--> statement-breakpoint
CREATE INDEX "workflows_pinned_version_idx" ON "workflows" USING btree ("pinned_version_id");--> statement-breakpoint
CREATE INDEX "idx_workflows_owner" ON "workflows" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "ai_feedback_workflow_idx" ON "ai_workflow_feedback" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "bm_version_block_idx" ON "block_metrics" USING btree ("version_id","block_id");--> statement-breakpoint
CREATE INDEX "metrics_events_project_ts_idx" ON "metrics_events" USING btree ("project_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_workflow_ts_idx" ON "metrics_events" USING btree ("workflow_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_type_idx" ON "metrics_events" USING btree ("type");--> statement-breakpoint
CREATE UNIQUE INDEX "metrics_rollups_unique_idx" ON "metrics_rollups" USING btree ("tenant_id","project_id",COALESCE("workflow_id", '00000000-0000-0000-0000-000000000000'::uuid),"bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "metrics_rollups_project_bucket_idx" ON "metrics_rollups" USING btree ("project_id","bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "review_tasks_run_idx" ON "review_tasks" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "review_tasks_workflow_idx" ON "review_tasks" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "review_tasks_status_idx" ON "review_tasks" USING btree ("status");--> statement-breakpoint
CREATE INDEX "review_tasks_reviewer_idx" ON "review_tasks" USING btree ("reviewer_id");--> statement-breakpoint
CREATE INDEX "run_generated_documents_run_idx" ON "run_generated_documents" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_run_idx" ON "run_logs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_level_idx" ON "run_logs" USING btree ("level");--> statement-breakpoint
CREATE INDEX "run_logs_created_at_idx" ON "run_logs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "run_outputs_run_idx" ON "run_outputs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_outputs_run_template_type_idx" ON "run_outputs" USING btree ("run_id","template_key","file_type");--> statement-breakpoint
CREATE INDEX "runs_workflow_version_idx" ON "runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "runs_status_idx" ON "runs" USING btree ("status");--> statement-breakpoint
CREATE INDEX "runs_created_by_idx" ON "runs" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "runs_created_at_idx" ON "runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "script_execution_log_run_idx" ON "script_execution_log" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_events_request_idx" ON "signature_events" USING btree ("signature_request_id");--> statement-breakpoint
CREATE INDEX "signature_requests_run_idx" ON "signature_requests" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_requests_token_idx" ON "signature_requests" USING btree ("token");--> statement-breakpoint
CREATE INDEX "sli_configs_project_idx" ON "sli_configs" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "sli_windows_project_window_idx" ON "sli_windows" USING btree ("project_id","window_start","window_end");--> statement-breakpoint
CREATE INDEX "step_values_run_idx" ON "step_values" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "step_values_step_idx" ON "step_values" USING btree ("step_id");--> statement-breakpoint
CREATE INDEX "step_values_run_step_idx" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE UNIQUE INDEX "step_values_run_step_unique" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE INDEX "template_metrics_template_idx" ON "template_generation_metrics" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_metrics_run_idx" ON "template_generation_metrics" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_run_idx" ON "transform_block_runs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_block_idx" ON "transform_block_runs" USING btree ("block_id");--> statement-breakpoint
CREATE UNIQUE INDEX "was_workflow_version_date_idx" ON "workflow_analytics_snapshots" USING btree ("workflow_id","version_id","date");--> statement-breakpoint
CREATE INDEX "wre_run_idx" ON "workflow_run_events" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "wre_workflow_ts_idx" ON "workflow_run_events" USING btree ("workflow_id","timestamp");--> statement-breakpoint
CREATE INDEX "wrm_workflow_created_idx" ON "workflow_run_metrics" USING btree ("workflow_id","created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_workflow_idx" ON "workflow_runs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_version_idx" ON "workflow_runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_completed_idx" ON "workflow_runs" USING btree ("completed");--> statement-breakpoint
CREATE INDEX "workflow_runs_run_token_idx" ON "workflow_runs" USING btree ("run_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_share_token_idx" ON "workflow_runs" USING btree ("share_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_current_section_idx" ON "workflow_runs" USING btree ("current_section_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_created_at_idx" ON "workflow_runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_owner_idx" ON "workflow_runs" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "analytics_survey_event_idx" ON "analytics_events" USING btree ("survey_id","event");--> statement-breakpoint
CREATE INDEX "analytics_response_event_idx" ON "analytics_events" USING btree ("response_id","event");--> statement-breakpoint
CREATE INDEX "analytics_timestamp_idx" ON "analytics_events" USING btree ("timestamp");--> statement-breakpoint
CREATE INDEX "anonymous_tracking_survey_ip_idx" ON "anonymous_response_tracking" USING btree ("survey_id","ip_address");--> statement-breakpoint
CREATE INDEX "email_queue_status_idx" ON "email_queue" USING btree ("status");--> statement-breakpoint
CREATE INDEX "email_queue_next_attempt_idx" ON "email_queue" USING btree ("next_attempt_at");--> statement-breakpoint
CREATE INDEX "survey_templates_creator_idx" ON "survey_templates" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "survey_templates_system_idx" ON "survey_templates" USING btree ("is_system");--> statement-breakpoint
CREATE INDEX "surveys_public_link_unique_idx" ON "surveys" USING btree ("public_link");--> statement-breakpoint
CREATE INDEX "surveys_workspace_idx" ON "surveys" USING btree ("workspace_id");--> statement-breakpoint
CREATE INDEX "template_shares_template_idx" ON "template_shares" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_shares_user_idx" ON "template_shares" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "template_shares_pending_email_idx" ON "template_shares" USING btree ("pending_email");--> statement-breakpoint
CREATE INDEX "collection_fields_collection_idx" ON "collection_fields" USING btree ("collection_id");--> statement-breakpoint
CREATE UNIQUE INDEX "collection_fields_slug_unique" ON "collection_fields" USING btree ("collection_id","slug");--> statement-breakpoint
CREATE UNIQUE INDEX "collections_slug_unique" ON "collections" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_database_id" ON "datavault_api_tokens" USING btree ("database_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE INDEX "datavault_columns_table_idx" ON "datavault_columns" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_columns_reference_table_idx" ON "datavault_columns" USING btree ("reference_table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_columns_table_slug_unique" ON "datavault_columns" USING btree ("table_id","slug");--> statement-breakpoint
CREATE INDEX "idx_databases_tenant" ON "datavault_databases" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_databases_scope" ON "datavault_databases" USING btree ("scope_type","scope_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_databases_owner" ON "datavault_databases" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_tenant" ON "datavault_number_sequences" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_table" ON "datavault_number_sequences" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "idx_datavault_sequences_column_unique" ON "datavault_number_sequences" USING btree ("tenant_id","table_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_row_id" ON "datavault_row_notes" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_tenant_id" ON "datavault_row_notes" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_table_idx" ON "datavault_rows" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_created_by_idx" ON "datavault_rows" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "idx_table_permissions_table" ON "datavault_table_permissions" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_table_user_permission" ON "datavault_table_permissions" USING btree ("table_id","user_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_tenant_idx" ON "datavault_tables" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_owner_idx" ON "datavault_tables" USING btree ("owner_user_id");--> statement-breakpoint
CREATE INDEX "idx_tables_database" ON "datavault_tables" USING btree ("database_id","tenant_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_tables_tenant_slug_unique" ON "datavault_tables" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "datavault_values_row_idx" ON "datavault_values" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "datavault_values_column_idx" ON "datavault_values" USING btree ("column_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_values_row_column_unique" ON "datavault_values" USING btree ("row_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_writeback_mappings_workflow" ON "datavault_writeback_mappings" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "records_collection_idx" ON "records" USING btree ("collection_id");--> statement-breakpoint
CREATE INDEX "records_tenant_idx" ON "records" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_data_sources_workflow" ON "workflow_data_sources" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_queries_workflow" ON "workflow_queries" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "api_keys_project_idx" ON "api_keys" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_tenant_idx" ON "connections" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "connections_project_idx" ON "connections" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_project_name_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "connections_type_idx" ON "connections" USING btree ("type");--> statement-breakpoint
CREATE INDEX "connections_enabled_idx" ON "connections" USING btree ("enabled");--> statement-breakpoint
CREATE UNIQUE INDEX "connections_project_name_unique_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "ext_dest_tenant_idx" ON "external_destinations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_client_id_idx" ON "oauth_apps" USING btree ("client_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_workspace_idx" ON "oauth_apps" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "secrets_project_key_env_unique" ON "secrets" USING btree ("project_id","key","environment");--> statement-breakpoint
CREATE INDEX "webhook_events_sub_idx" ON "webhook_events" USING btree ("subscription_id");--> statement-breakpoint
CREATE INDEX "webhook_subs_workspace_idx" ON "webhook_subscriptions" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_org_idx" ON "customer_billing_info" USING btree ("organization_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_stripe_idx" ON "customer_billing_info" USING btree ("stripe_customer_id");--> statement-breakpoint
CREATE UNIQUE INDEX "seat_sub_user_idx" ON "subscription_seats" USING btree ("subscription_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "sub_org_idx" ON "subscriptions" USING btree ("organization_id");--> statement-breakpoint
CREATE INDEX "usage_org_metric_date_idx" ON "usage_records" USING btree ("organization_id","metric","recorded_at");--> statement-breakpoint
CREATE INDEX "email_templates_key_idx" ON "email_template_metadata" USING btree ("template_key");--> statement-breakpoint
CREATE INDEX "ai_settings_scope_idx" ON "ai_settings" USING btree ("scope");
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:235:19 {
  query: 'SET search_path TO "test_schema_w0_v3", public;\n' +
    '\n' +
    `CREATE TYPE "test_schema_w0_v3"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint\n` +
    'CREATE TABLE "account_locks" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"locked_at" timestamp DEFAULT now() NOT NULL,\n' +
    '\t"locked_until" timestamp NOT NULL,\n' +
    '\t"reason" varchar(255),\n' +
    '\t"unlocked" boolean DEFAULT false NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "audit_logs" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"tenant_id" uuid,\n' +
    '\t"workspace_id" uuid,\n' +
    '\t"user_id" varchar,\n' +
    '\t"action" varchar NOT NULL,\n' +
    '\t"entity_type" varchar NOT NULL,\n' +
    '\t"entity_id" varchar NOT NULL,\n' +
    '\t"resource_type" varchar,\n' +
    '\t"resource_id" varchar,\n' +
    '\t"changes" jsonb,\n' +
    '\t"details" jsonb,\n' +
    '\t"ip_address" varchar,\n' +
    '\t"user_agent" text,\n' +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"timestamp" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "email_verification_tokens" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"token" varchar NOT NULL,\n' +
    '\t"expires_at" timestamp NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "login_attempts" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"email" varchar(255) NOT NULL,\n' +
    '\t"ip_address" varchar(45),\n' +
    '\t"successful" boolean DEFAULT false NOT NULL,\n' +
    '\t"attempted_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "mfa_backup_codes" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"code_hash" text NOT NULL,\n' +
    '\t"used" boolean DEFAULT false NOT NULL,\n' +
    '\t"used_at" timestamp,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "mfa_secrets" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"secret" text NOT NULL,\n' +
    '\t"enabled" boolean DEFAULT false NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL,\n' +
    '\t"enabled_at" timestamp,\n' +
    '\tCONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "organization_invites" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"org_id" uuid NOT NULL,\n' +
    '\t"invited_email" varchar(255) NOT NULL,\n' +
    '\t"invited_user_id" varchar,\n' +
    '\t"invited_by_user_id" varchar NOT NULL,\n' +
    '\t"token" varchar(255) NOT NULL,\n' +
    `\t"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,\n` +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"expires_at" timestamp NOT NULL,\n' +
    '\t"accepted_at" timestamp,\n' +
    '\t"email_sent_at" timestamp,\n' +
    '\t"email_failed" boolean DEFAULT false,\n' +
    '\t"email_error" text,\n' +
    '\tCONSTRAINT "organization_invites_token_unique" UNIQUE("token")\n' +
    ');\n' +
    '--> st'... 111275 more characters,
  params: [],
  cause: error: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:235:19 {
    length: 264,
    severity: 'ERROR',
    code: '23505',
    detail: 'Key (typname, typnamespace)=(anonymous_access_type, 2456483) already exists.',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'pg_catalog',
    table: 'pg_type',
    column: undefined,
    dataType: undefined,
    constraint: 'pg_type_typname_nsp_index',
    file: 'nbtinsert.c',
    line: '667',
    routine: '_bt_check_unique'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

{"level":30,"time":1768675050520,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768675050539,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768675050529,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768675050529,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768675050533,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768675050534,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768675050538,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768675050538,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768675050538,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768675050539,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768675050735,"env":"test","module":"auth-routes","error":{},"msg":"Registration failed"}
{"level":30,"time":1768675050747,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768675050747,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: []

stderr | tests/integration/auth/protected.routes.test.ts
Minor warning during forceful cleanup: DrizzleQueryError: Failed query: DROP FUNCTION IF EXISTS datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text) CASCADE;
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at ensureDbFunctions (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:415:5)
    at ensureDbFunctionsWithRetry (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:369:7)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:314:9 {
  query: 'DROP FUNCTION IF EXISTS datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text) CASCADE;',
  params: [],
  cause: error: tuple concurrently updated
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at ensureDbFunctions (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:415:5)
      at ensureDbFunctionsWithRetry (C:/Users/scoot/poll/VaultLogic/tests/setup.ts:369:7)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:314:9 {
    length: 90,
    severity: 'ERROR',
    code: 'XX000',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: 'heapam.c',
    line: '3221',
    routine: 'simple_heap_delete'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
CRITICAL REGISTRATION ERROR: ReferenceError: SALT_ROUNDS is not defined
    at AuthService.hashPassword (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:168:38)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:242:46
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 5047ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  12:37:13
   Duration  16.52s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/AuthService.ts x4 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768675168416,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768675172002,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768675172053,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: []

{"level":30,"time":1768675173840,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768675173860,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768675173850,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768675173851,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768675173855,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768675173856,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768675173860,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768675173860,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768675173860,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768675173860,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768675174388,"env":"test","module":"user-credentials-repository","userId":"9a9b82e9-f74d-44b0-9809-e8ec5ab2e4d5","msg":"User credentials created"}
{"level":30,"time":1768675174544,"env":"test","module":"email-queue","jobId":"7df408ac-2fcc-466c-a941-07e9a282bfe2","to":"test-FPmsWkdySHhMzn9zwHfBq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768675174547,"env":"test","module":"auth-routes","error":{},"msg":"Registration failed"}
{"level":30,"time":1768675174559,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768675174560,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
CRITICAL REGISTRATION ERROR: ReferenceError: JWT_SECRET is not defined
    at AuthService.createToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:72:9)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:248:33
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 3404ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»


 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  12:39:17
   Duration  16.81s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»

c[3J RERUN  server/services/AuthService.ts x5 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768675270703,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

{"level":30,"time":1768675278956,"env":"test","msg":"DB: initializing... Local"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768675284076,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

{"level":30,"time":1768675285571,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768675285585,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768675285576,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768675285577,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768675285581,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768675285581,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768675285585,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768675285585,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768675285585,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768675285585,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768675286038,"env":"test","module":"user-credentials-repository","userId":"0e014473-4208-460c-82df-fffae73c42cd","msg":"User credentials created"}
{"level":30,"time":1768675286128,"env":"test","module":"email-queue","jobId":"a17ab739-b4c3-4472-9959-042c3d05e4f8","to":"test-jn_L-OpbF6iGmN6hRa15L@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675286176,"env":"test","module":"auth-routes","userId":"0e014473-4208-460c-82df-fffae73c42cd","email":"test-jn_L-OpbF6iGmN6hRa15L@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

{"level":30,"time":1768675286779,"env":"test","module":"user-credentials-repository","userId":"4b7a3303-7b48-440f-9317-0ac0fc2e5f29","msg":"User credentials created"}
{"level":30,"time":1768675286872,"env":"test","module":"email-queue","jobId":"fb38eaee-f3e7-4815-8dca-13098d6f48e1","to":"protected-test-6JaVswyuWkqINxkHJHwnc@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675286920,"env":"test","module":"auth-routes","userId":"4b7a3303-7b48-440f-9317-0ac0fc2e5f29","email":"protected-test-6JaVswyuWkqINxkHJHwnc@example.com","msg":"User registered"}
{"level":30,"time":1768675287574,"env":"test","module":"auth-routes","userId":"4b7a3303-7b48-440f-9317-0ac0fc2e5f29","msg":"User logged in successfully"}
{"level":30,"time":1768675287621,"env":"test","module":"audit-log-service","userId":"4b7a3303-7b48-440f-9317-0ac0fc2e5f29","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768675288030,"env":"test","module":"user-credentials-repository","userId":"5cc181ca-a4c4-49ba-bc8e-e305e59b12b4","msg":"User credentials created"}
{"level":30,"time":1768675288132,"env":"test","module":"email-queue","jobId":"075bd6b7-9b76-46ef-a5a1-64ecfb5603f1","to":"protected-test-Q81_01Q06D7EA9li2Bx4t@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675288181,"env":"test","module":"auth-routes","userId":"5cc181ca-a4c4-49ba-bc8e-e305e59b12b4","email":"protected-test-Q81_01Q06D7EA9li2Bx4t@example.com","msg":"User registered"}
{"level":30,"time":1768675288782,"env":"test","module":"auth-routes","userId":"5cc181ca-a4c4-49ba-bc8e-e305e59b12b4","msg":"User logged in successfully"}
{"level":30,"time":1768675288827,"env":"test","module":"audit-log-service","userId":"5cc181ca-a4c4-49ba-bc8e-e305e59b12b4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675288833,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675289192,"env":"test","module":"user-credentials-repository","userId":"c87e44e9-c780-4bac-b078-d4ce69844e83","msg":"User credentials created"}
{"level":30,"time":1768675289285,"env":"test","module":"email-queue","jobId":"512f5a27-383c-42d2-8f42-ae1bd23e213c","to":"protected-test-GDqcP7mPOJB7AKx9ABn9k@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675289331,"env":"test","module":"auth-routes","userId":"c87e44e9-c780-4bac-b078-d4ce69844e83","email":"protected-test-GDqcP7mPOJB7AKx9ABn9k@example.com","msg":"User registered"}
{"level":30,"time":1768675289924,"env":"test","module":"auth-routes","userId":"c87e44e9-c780-4bac-b078-d4ce69844e83","msg":"User logged in successfully"}
{"level":30,"time":1768675289968,"env":"test","module":"audit-log-service","userId":"c87e44e9-c780-4bac-b078-d4ce69844e83","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675289973,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

{"level":30,"time":1768675290323,"env":"test","module":"user-credentials-repository","userId":"5424791a-4ec3-4910-a7c9-bb3d4864fc27","msg":"User credentials created"}
{"level":30,"time":1768675290413,"env":"test","module":"email-queue","jobId":"79fbbbd5-a0dc-4d47-bb45-252c61bb9a66","to":"protected-test-Q1H4MZoelqnhYMlNhX5iz@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675290457,"env":"test","module":"auth-routes","userId":"5424791a-4ec3-4910-a7c9-bb3d4864fc27","email":"protected-test-Q1H4MZoelqnhYMlNhX5iz@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768675291072,"env":"test","module":"auth-routes","userId":"5424791a-4ec3-4910-a7c9-bb3d4864fc27","msg":"User logged in successfully"}
{"level":30,"time":1768675291117,"env":"test","module":"audit-log-service","userId":"5424791a-4ec3-4910-a7c9-bb3d4864fc27","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675291122,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675291566,"env":"test","module":"user-credentials-repository","userId":"19eda680-ba4c-4745-9ac0-c5a80c0a461d","msg":"User credentials created"}
{"level":30,"time":1768675291653,"env":"test","module":"email-queue","jobId":"15ed2695-5ea9-467d-b332-95083fa1a246","to":"protected-test-3HCr-lzKOGEmpJD4FypYf@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675291698,"env":"test","module":"auth-routes","userId":"19eda680-ba4c-4745-9ac0-c5a80c0a461d","email":"protected-test-3HCr-lzKOGEmpJD4FypYf@example.com","msg":"User registered"}
{"level":30,"time":1768675292296,"env":"test","module":"auth-routes","userId":"19eda680-ba4c-4745-9ac0-c5a80c0a461d","msg":"User logged in successfully"}
{"level":30,"time":1768675292346,"env":"test","module":"audit-log-service","userId":"19eda680-ba4c-4745-9ac0-c5a80c0a461d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768675292351,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768675292352,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768675292733,"env":"test","module":"user-credentials-repository","userId":"6e12c344-84ee-4708-af61-b0f335cd3e62","msg":"User credentials created"}
{"level":30,"time":1768675292824,"env":"test","module":"email-queue","jobId":"37fbab3f-a940-4726-9d4c-fe4ee0e8daf7","to":"protected-test-LcBYmIy24XbqbVsv72cdE@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675292870,"env":"test","module":"auth-routes","userId":"6e12c344-84ee-4708-af61-b0f335cd3e62","email":"protected-test-LcBYmIy24XbqbVsv72cdE@example.com","msg":"User registered"}
{"level":30,"time":1768675293472,"env":"test","module":"auth-routes","userId":"6e12c344-84ee-4708-af61-b0f335cd3e62","msg":"User logged in successfully"}
{"level":30,"time":1768675293523,"env":"test","module":"audit-log-service","userId":"6e12c344-84ee-4708-af61-b0f335cd3e62","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675293946,"env":"test","module":"user-credentials-repository","userId":"87c266f3-98b1-479b-97c3-4303fd0641ea","msg":"User credentials created"}
{"level":30,"time":1768675294034,"env":"test","module":"email-queue","jobId":"335f5c52-26d9-4eff-85be-24066a75b329","to":"protected-test-mHGO0GP4z_zLlE3BPUH99@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675294079,"env":"test","module":"auth-routes","userId":"87c266f3-98b1-479b-97c3-4303fd0641ea","email":"protected-test-mHGO0GP4z_zLlE3BPUH99@example.com","msg":"User registered"}
{"level":30,"time":1768675294670,"env":"test","module":"auth-routes","userId":"87c266f3-98b1-479b-97c3-4303fd0641ea","msg":"User logged in successfully"}
{"level":30,"time":1768675294714,"env":"test","module":"audit-log-service","userId":"87c266f3-98b1-479b-97c3-4303fd0641ea","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675294718,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675295082,"env":"test","module":"user-credentials-repository","userId":"f8367ebd-14d6-46b0-9cbe-0d9eb3140866","msg":"User credentials created"}
{"level":30,"time":1768675295170,"env":"test","module":"email-queue","jobId":"858c9b23-bcae-44db-9ea3-e5782d5875ca","to":"protected-test-tkbmlQOm7cwwOVNB1knbr@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675295221,"env":"test","module":"auth-routes","userId":"f8367ebd-14d6-46b0-9cbe-0d9eb3140866","email":"protected-test-tkbmlQOm7cwwOVNB1knbr@example.com","msg":"User registered"}
{"level":30,"time":1768675295818,"env":"test","module":"auth-routes","userId":"f8367ebd-14d6-46b0-9cbe-0d9eb3140866","msg":"User logged in successfully"}
{"level":30,"time":1768675295864,"env":"test","module":"audit-log-service","userId":"f8367ebd-14d6-46b0-9cbe-0d9eb3140866","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675295870,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675296272,"env":"test","module":"user-credentials-repository","userId":"899c7a13-5672-46f4-a46d-29aac5274c73","msg":"User credentials created"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675296365,"env":"test","module":"email-queue","jobId":"c860278e-b879-4d10-b0d1-a3007bbff665","to":"protected-test-F8-IeziSY-k3PB75wL7YO@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675296417,"env":"test","module":"auth-routes","userId":"899c7a13-5672-46f4-a46d-29aac5274c73","email":"protected-test-F8-IeziSY-k3PB75wL7YO@example.com","msg":"User registered"}
{"level":30,"time":1768675297003,"env":"test","module":"auth-routes","userId":"899c7a13-5672-46f4-a46d-29aac5274c73","msg":"User logged in successfully"}
{"level":30,"time":1768675297047,"env":"test","module":"audit-log-service","userId":"899c7a13-5672-46f4-a46d-29aac5274c73","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[DEBUG] BaseRepository.update users: id=899c7a13-5672-46f4-a46d-29aac5274c73, updates={"defaultMode":"advanced","updatedAt":"2026-01-17T18:41:37.142Z"}
{"level":30,"time":1768675297549,"env":"test","module":"user-credentials-repository","userId":"5b027ac1-b0a3-43a1-a488-bab515751b6b","msg":"User credentials created"}
{"level":30,"time":1768675297643,"env":"test","module":"email-queue","jobId":"d82eac60-b1f9-48f3-a480-a882a6809c9f","to":"protected-test-gk1h9cqckWViOhnrDHdsB@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675297717,"env":"test","module":"auth-routes","userId":"5b027ac1-b0a3-43a1-a488-bab515751b6b","email":"protected-test-gk1h9cqckWViOhnrDHdsB@example.com","msg":"User registered"}
{"level":30,"time":1768675298323,"env":"test","module":"auth-routes","userId":"5b027ac1-b0a3-43a1-a488-bab515751b6b","msg":"User logged in successfully"}
{"level":30,"time":1768675298378,"env":"test","module":"audit-log-service","userId":"5b027ac1-b0a3-43a1-a488-bab515751b6b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675298384,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675298742,"env":"test","module":"user-credentials-repository","userId":"2836a5f6-93eb-4ba1-9bd8-74fb982a7cd9","msg":"User credentials created"}
{"level":30,"time":1768675298837,"env":"test","module":"email-queue","jobId":"9487ca95-bcf6-499b-aaec-6a1111b3a86c","to":"protected-test-GlR9Rk1FU6_zx-JdXr-dq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675298882,"env":"test","module":"auth-routes","userId":"2836a5f6-93eb-4ba1-9bd8-74fb982a7cd9","email":"protected-test-GlR9Rk1FU6_zx-JdXr-dq@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675299459,"env":"test","module":"auth-routes","userId":"2836a5f6-93eb-4ba1-9bd8-74fb982a7cd9","msg":"User logged in successfully"}
{"level":30,"time":1768675299504,"env":"test","module":"audit-log-service","userId":"2836a5f6-93eb-4ba1-9bd8-74fb982a7cd9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675300027,"env":"test","module":"user-credentials-repository","userId":"30e759ce-de6c-49b3-a43c-d6dd1cf68867","msg":"User credentials created"}
{"level":30,"time":1768675300115,"env":"test","module":"email-queue","jobId":"f0b9e6a3-2e05-4e9b-85be-e9079ff0cb26","to":"protected-test-7kDZuAp6HUYLyRKTl0Ta1@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675300163,"env":"test","module":"auth-routes","userId":"30e759ce-de6c-49b3-a43c-d6dd1cf68867","email":"protected-test-7kDZuAp6HUYLyRKTl0Ta1@example.com","msg":"User registered"}
{"level":30,"time":1768675300761,"env":"test","module":"auth-routes","userId":"30e759ce-de6c-49b3-a43c-d6dd1cf68867","msg":"User logged in successfully"}
{"level":30,"time":1768675300808,"env":"test","module":"audit-log-service","userId":"30e759ce-de6c-49b3-a43c-d6dd1cf68867","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675300812,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675301178,"env":"test","module":"user-credentials-repository","userId":"35807f3c-3e97-4e86-826c-164df0d6ea4f","msg":"User credentials created"}
{"level":30,"time":1768675301267,"env":"test","module":"email-queue","jobId":"d000965c-ad12-4fdf-9748-176d7646f56b","to":"protected-test-jzfX_yiIEyXUbPkSFecEO@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675301310,"env":"test","module":"auth-routes","userId":"35807f3c-3e97-4e86-826c-164df0d6ea4f","email":"protected-test-jzfX_yiIEyXUbPkSFecEO@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675301890,"env":"test","module":"auth-routes","userId":"35807f3c-3e97-4e86-826c-164df0d6ea4f","msg":"User logged in successfully"}
{"level":30,"time":1768675301939,"env":"test","module":"audit-log-service","userId":"35807f3c-3e97-4e86-826c-164df0d6ea4f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675302954,"env":"test","module":"user-credentials-repository","userId":"af440211-2907-4710-9403-71a563e0ace4","msg":"User credentials created"}
{"level":30,"time":1768675303043,"env":"test","module":"email-queue","jobId":"237ce590-b3f9-4f7f-bceb-7f69365636fa","to":"protected-test-lKz0h-g0pAQKI2IkPUHuh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675303090,"env":"test","module":"auth-routes","userId":"af440211-2907-4710-9403-71a563e0ace4","email":"protected-test-lKz0h-g0pAQKI2IkPUHuh@example.com","msg":"User registered"}
{"level":30,"time":1768675303672,"env":"test","module":"auth-routes","userId":"af440211-2907-4710-9403-71a563e0ace4","msg":"User logged in successfully"}
{"level":30,"time":1768675303719,"env":"test","module":"audit-log-service","userId":"af440211-2907-4710-9403-71a563e0ace4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675303723,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675304080,"env":"test","module":"user-credentials-repository","userId":"5847116d-5b26-4f78-8294-1ba382165487","msg":"User credentials created"}
{"level":30,"time":1768675304167,"env":"test","module":"email-queue","jobId":"1403b20c-390d-4bf5-a671-72794baea180","to":"protected-test-UCiXMrnt6p9sXKDfdxDi_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675304210,"env":"test","module":"auth-routes","userId":"5847116d-5b26-4f78-8294-1ba382165487","email":"protected-test-UCiXMrnt6p9sXKDfdxDi_@example.com","msg":"User registered"}
{"level":30,"time":1768675304813,"env":"test","module":"auth-routes","userId":"5847116d-5b26-4f78-8294-1ba382165487","msg":"User logged in successfully"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675304865,"env":"test","module":"audit-log-service","userId":"5847116d-5b26-4f78-8294-1ba382165487","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768675304868,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768675304869,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675305237,"env":"test","module":"user-credentials-repository","userId":"10b75543-dba6-42f7-ae97-82d31d29feac","msg":"User credentials created"}
{"level":30,"time":1768675305332,"env":"test","module":"email-queue","jobId":"f8c5333e-ab0a-43cd-83be-ac8394013111","to":"protected-test-ys5v35lo6-gxoBMByO8g5@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675305380,"env":"test","module":"auth-routes","userId":"10b75543-dba6-42f7-ae97-82d31d29feac","email":"protected-test-ys5v35lo6-gxoBMByO8g5@example.com","msg":"User registered"}
{"level":30,"time":1768675305974,"env":"test","module":"auth-routes","userId":"10b75543-dba6-42f7-ae97-82d31d29feac","msg":"User logged in successfully"}
{"level":30,"time":1768675306024,"env":"test","module":"audit-log-service","userId":"10b75543-dba6-42f7-ae97-82d31d29feac","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675306029,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675306445,"env":"test","module":"user-credentials-repository","userId":"c0888252-b08e-4629-8dd9-1a33b32c1c88","msg":"User credentials created"}
{"level":30,"time":1768675306532,"env":"test","module":"email-queue","jobId":"fed04dff-919e-49fb-8e1a-2f0e46bd9396","to":"protected-test-NwndJ89YzEIEy1BaSdnca@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675306576,"env":"test","module":"auth-routes","userId":"c0888252-b08e-4629-8dd9-1a33b32c1c88","email":"protected-test-NwndJ89YzEIEy1BaSdnca@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675307175,"env":"test","module":"auth-routes","userId":"c0888252-b08e-4629-8dd9-1a33b32c1c88","msg":"User logged in successfully"}
{"level":30,"time":1768675307220,"env":"test","module":"audit-log-service","userId":"c0888252-b08e-4629-8dd9-1a33b32c1c88","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675307223,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675307599,"env":"test","module":"user-credentials-repository","userId":"5ca83f87-3f0b-4b38-a1c2-bd2ae72ecc5e","msg":"User credentials created"}
{"level":30,"time":1768675307704,"env":"test","module":"email-queue","jobId":"8b01870c-8e4d-48d7-9bf8-2d4b0137ddff","to":"protected-test-0t6mbkB8vDKju9q4oxX46@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675307753,"env":"test","module":"auth-routes","userId":"5ca83f87-3f0b-4b38-a1c2-bd2ae72ecc5e","email":"protected-test-0t6mbkB8vDKju9q4oxX46@example.com","msg":"User registered"}
{"level":30,"time":1768675308367,"env":"test","module":"auth-routes","userId":"5ca83f87-3f0b-4b38-a1c2-bd2ae72ecc5e","msg":"User logged in successfully"}
{"level":30,"time":1768675308416,"env":"test","module":"audit-log-service","userId":"5ca83f87-3f0b-4b38-a1c2-bd2ae72ecc5e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675308420,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675308805,"env":"test","module":"user-credentials-repository","userId":"435c8b37-48bb-461a-ab53-1e21abc25034","msg":"User credentials created"}
{"level":30,"time":1768675308900,"env":"test","module":"email-queue","jobId":"de0eadeb-75af-4470-9577-1bb12715dc5d","to":"protected-test-Bu0fiZsu_t2yqjJqCt-vA@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675308944,"env":"test","module":"auth-routes","userId":"435c8b37-48bb-461a-ab53-1e21abc25034","email":"protected-test-Bu0fiZsu_t2yqjJqCt-vA@example.com","msg":"User registered"}
{"level":30,"time":1768675309546,"env":"test","module":"auth-routes","userId":"435c8b37-48bb-461a-ab53-1e21abc25034","msg":"User logged in successfully"}
{"level":30,"time":1768675309589,"env":"test","module":"audit-log-service","userId":"435c8b37-48bb-461a-ab53-1e21abc25034","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675309591,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675309996,"env":"test","module":"user-credentials-repository","userId":"9bdb1b01-be7e-4f51-baf9-d9b2120cd796","msg":"User credentials created"}
{"level":30,"time":1768675310086,"env":"test","module":"email-queue","jobId":"cbf432c6-4c60-42bb-a5f1-7c69f55bd7f5","to":"protected-test-_QmscQ-UwhEDVe0imUBSH@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675310134,"env":"test","module":"auth-routes","userId":"9bdb1b01-be7e-4f51-baf9-d9b2120cd796","email":"protected-test-_QmscQ-UwhEDVe0imUBSH@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675310722,"env":"test","module":"auth-routes","userId":"9bdb1b01-be7e-4f51-baf9-d9b2120cd796","msg":"User logged in successfully"}
{"level":30,"time":1768675310771,"env":"test","module":"audit-log-service","userId":"9bdb1b01-be7e-4f51-baf9-d9b2120cd796","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675310775,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675311176,"env":"test","module":"user-credentials-repository","userId":"18a89f30-3870-48ea-8738-4370fcbb6445","msg":"User credentials created"}
{"level":30,"time":1768675311264,"env":"test","module":"email-queue","jobId":"611920d7-4832-4aa0-994e-6ed48fab3855","to":"protected-test-hIKp7cTtlqk2jhvq7mjLO@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675311313,"env":"test","module":"auth-routes","userId":"18a89f30-3870-48ea-8738-4370fcbb6445","email":"protected-test-hIKp7cTtlqk2jhvq7mjLO@example.com","msg":"User registered"}
{"level":30,"time":1768675311892,"env":"test","module":"auth-routes","userId":"18a89f30-3870-48ea-8738-4370fcbb6445","msg":"User logged in successfully"}
{"level":30,"time":1768675311936,"env":"test","module":"audit-log-service","userId":"18a89f30-3870-48ea-8738-4370fcbb6445","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675311940,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675312327,"env":"test","module":"user-credentials-repository","userId":"c49fe0df-1a9f-4e4a-8f6d-ed091808c07d","msg":"User credentials created"}
{"level":30,"time":1768675312420,"env":"test","module":"email-queue","jobId":"30b70695-8839-4d7d-9810-df209e72002b","to":"protected-test-dxwPLLpdfo4nEYdrIyvu-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675312465,"env":"test","module":"auth-routes","userId":"c49fe0df-1a9f-4e4a-8f6d-ed091808c07d","email":"protected-test-dxwPLLpdfo4nEYdrIyvu-@example.com","msg":"User registered"}
{"level":30,"time":1768675313065,"env":"test","module":"auth-routes","userId":"c49fe0df-1a9f-4e4a-8f6d-ed091808c07d","msg":"User logged in successfully"}
{"level":30,"time":1768675313110,"env":"test","module":"audit-log-service","userId":"c49fe0df-1a9f-4e4a-8f6d-ed091808c07d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675313483,"env":"test","module":"user-credentials-repository","userId":"0931c2fa-2e03-4afd-90d1-544190da1369","msg":"User credentials created"}
{"level":30,"time":1768675313573,"env":"test","module":"email-queue","jobId":"9201cce1-9c11-44af-b251-71a6f1e3b674","to":"protected-test-riYMAJYPcTQDz-h0Yy1op@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675313617,"env":"test","module":"auth-routes","userId":"0931c2fa-2e03-4afd-90d1-544190da1369","email":"protected-test-riYMAJYPcTQDz-h0Yy1op@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675314252,"env":"test","module":"auth-routes","userId":"0931c2fa-2e03-4afd-90d1-544190da1369","msg":"User logged in successfully"}
{"level":30,"time":1768675314296,"env":"test","module":"audit-log-service","userId":"0931c2fa-2e03-4afd-90d1-544190da1369","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675314779,"env":"test","module":"user-credentials-repository","userId":"47607b56-b603-4fb6-8412-ab47711b2a5e","msg":"User credentials created"}
{"level":30,"time":1768675314869,"env":"test","module":"email-queue","jobId":"ce923c65-0b73-4dec-92bd-2f83f1d431b4","to":"protected-test-1PVBLGaBLFoqeX0k1c1bL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675314920,"env":"test","module":"auth-routes","userId":"47607b56-b603-4fb6-8412-ab47711b2a5e","email":"protected-test-1PVBLGaBLFoqeX0k1c1bL@example.com","msg":"User registered"}
{"level":30,"time":1768675315518,"env":"test","module":"auth-routes","userId":"47607b56-b603-4fb6-8412-ab47711b2a5e","msg":"User logged in successfully"}
{"level":30,"time":1768675315564,"env":"test","module":"audit-log-service","userId":"47607b56-b603-4fb6-8412-ab47711b2a5e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675315922,"env":"test","module":"user-credentials-repository","userId":"35842643-4dcf-4453-90ef-110d3de58af3","msg":"User credentials created"}
{"level":30,"time":1768675316013,"env":"test","module":"email-queue","jobId":"005b514f-6562-4de1-b3e1-f35fd6d2f345","to":"user2-S7Z3qyWQdvgO8XbKmYbbQ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675316058,"env":"test","module":"auth-routes","userId":"35842643-4dcf-4453-90ef-110d3de58af3","email":"user2-S7Z3qyWQdvgO8XbKmYbbQ@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675316595,"env":"test","module":"auth-routes","userId":"35842643-4dcf-4453-90ef-110d3de58af3","msg":"User logged in successfully"}
{"level":30,"time":1768675316638,"env":"test","module":"audit-log-service","userId":"35842643-4dcf-4453-90ef-110d3de58af3","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768675316690,"env":"test","module":"rbac-middleware","userId":"35842643-4dcf-4453-90ef-110d3de58af3","userRole":"viewer","permission":"project:delete","path":"/28a6e24c-020a-4e3c-948f-03d92782b637","msg":"Permission denied"}
{"level":30,"time":1768675317109,"env":"test","module":"user-credentials-repository","userId":"310c20e6-a3a5-4079-82c8-1efbfe8ac65a","msg":"User credentials created"}
{"level":30,"time":1768675317226,"env":"test","module":"email-queue","jobId":"a6bb100a-12ab-4a9e-8f91-9dc6622bdeff","to":"protected-test-2ebq1MkCCvGwTVxd3JK-j@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675317270,"env":"test","module":"auth-routes","userId":"310c20e6-a3a5-4079-82c8-1efbfe8ac65a","email":"protected-test-2ebq1MkCCvGwTVxd3JK-j@example.com","msg":"User registered"}
{"level":30,"time":1768675317859,"env":"test","module":"auth-routes","userId":"310c20e6-a3a5-4079-82c8-1efbfe8ac65a","msg":"User logged in successfully"}
{"level":30,"time":1768675317907,"env":"test","module":"audit-log-service","userId":"310c20e6-a3a5-4079-82c8-1efbfe8ac65a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675318334,"env":"test","module":"user-credentials-repository","userId":"0f956179-0c3f-4c60-8e8b-22d6b4526f3b","msg":"User credentials created"}
{"level":30,"time":1768675318423,"env":"test","module":"email-queue","jobId":"bcfe8f05-b175-4c55-a42e-a616e584120e","to":"protected-test--sNdcSfYLbu7oW26jHvKa@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675318466,"env":"test","module":"auth-routes","userId":"0f956179-0c3f-4c60-8e8b-22d6b4526f3b","email":"protected-test--sNdcSfYLbu7oW26jHvKa@example.com","msg":"User registered"}
{"level":30,"time":1768675319058,"env":"test","module":"auth-routes","userId":"0f956179-0c3f-4c60-8e8b-22d6b4526f3b","msg":"User logged in successfully"}
{"level":30,"time":1768675319118,"env":"test","module":"audit-log-service","userId":"0f956179-0c3f-4c60-8e8b-22d6b4526f3b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675319523,"env":"test","module":"user-credentials-repository","userId":"d18132f9-c6b5-4a71-8b34-dced61252558","msg":"User credentials created"}
{"level":30,"time":1768675319613,"env":"test","module":"email-queue","jobId":"e1f00b01-042f-44e4-aaba-df659220938a","to":"protected-test-xWV4EvSrhPPVD6bkoVHpL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675319661,"env":"test","module":"auth-routes","userId":"d18132f9-c6b5-4a71-8b34-dced61252558","email":"protected-test-xWV4EvSrhPPVD6bkoVHpL@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675320275,"env":"test","module":"auth-routes","userId":"d18132f9-c6b5-4a71-8b34-dced61252558","msg":"User logged in successfully"}
{"level":30,"time":1768675320319,"env":"test","module":"audit-log-service","userId":"d18132f9-c6b5-4a71-8b34-dced61252558","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675320740,"env":"test","module":"user-credentials-repository","userId":"e113ae89-da64-47d4-afb0-d4f0e3eb6391","msg":"User credentials created"}
{"level":30,"time":1768675320831,"env":"test","module":"email-queue","jobId":"53bd9d35-7959-41ab-90b0-059c467fbe15","to":"protected-test-cE3FMXLnDNRxm2JwZvpV2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675320876,"env":"test","module":"auth-routes","userId":"e113ae89-da64-47d4-afb0-d4f0e3eb6391","email":"protected-test-cE3FMXLnDNRxm2JwZvpV2@example.com","msg":"User registered"}
{"level":30,"time":1768675321481,"env":"test","module":"auth-routes","userId":"e113ae89-da64-47d4-afb0-d4f0e3eb6391","msg":"User logged in successfully"}
{"level":30,"time":1768675321526,"env":"test","module":"audit-log-service","userId":"e113ae89-da64-47d4-afb0-d4f0e3eb6391","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675322389,"env":"test","module":"user-credentials-repository","userId":"1950a7e2-745d-4154-bcf0-2e2c7c1c3a0a","msg":"User credentials created"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675322519,"env":"test","module":"email-queue","jobId":"44a1a1da-429c-4150-bef9-16dd4c997c9d","to":"protected-test-CEKU1mgdC5U1BuZH0GI2R@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675322578,"env":"test","module":"auth-routes","userId":"1950a7e2-745d-4154-bcf0-2e2c7c1c3a0a","email":"protected-test-CEKU1mgdC5U1BuZH0GI2R@example.com","msg":"User registered"}
{"level":30,"time":1768675323268,"env":"test","module":"auth-routes","userId":"1950a7e2-745d-4154-bcf0-2e2c7c1c3a0a","msg":"User logged in successfully"}
{"level":30,"time":1768675323331,"env":"test","module":"audit-log-service","userId":"1950a7e2-745d-4154-bcf0-2e2c7c1c3a0a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675323913,"env":"test","module":"auth-routes","userId":"1950a7e2-745d-4154-bcf0-2e2c7c1c3a0a","msg":"User logged in successfully"}
{"level":30,"time":1768675323968,"env":"test","module":"audit-log-service","userId":"1950a7e2-745d-4154-bcf0-2e2c7c1c3a0a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675324430,"env":"test","module":"user-credentials-repository","userId":"ccf9d1ed-593f-43f9-9a06-b95fc3bd8d12","msg":"User credentials created"}
{"level":30,"time":1768675324544,"env":"test","module":"email-queue","jobId":"cb59452d-cd2d-4641-b022-b315b06e83b6","to":"protected-test-oKnrhDiAM7i3vFhij_fIj@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675324605,"env":"test","module":"auth-routes","userId":"ccf9d1ed-593f-43f9-9a06-b95fc3bd8d12","email":"protected-test-oKnrhDiAM7i3vFhij_fIj@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675325274,"env":"test","module":"auth-routes","userId":"ccf9d1ed-593f-43f9-9a06-b95fc3bd8d12","msg":"User logged in successfully"}
{"level":30,"time":1768675325333,"env":"test","module":"audit-log-service","userId":"ccf9d1ed-593f-43f9-9a06-b95fc3bd8d12","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675325916,"env":"test","module":"auth-routes","userId":"ccf9d1ed-593f-43f9-9a06-b95fc3bd8d12","msg":"User logged in successfully"}
{"level":30,"time":1768675325971,"env":"test","module":"audit-log-service","userId":"ccf9d1ed-593f-43f9-9a06-b95fc3bd8d12","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675326363,"env":"test","module":"user-credentials-repository","userId":"7da104db-5c7f-42f1-8133-2af454bf8360","msg":"User credentials created"}
{"level":30,"time":1768675326492,"env":"test","module":"email-queue","jobId":"7e674719-fba8-42b3-b447-3835634c6a6c","to":"user2-1vdaq6TSQIqzm7k4LFAth@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675326557,"env":"test","module":"auth-routes","userId":"7da104db-5c7f-42f1-8133-2af454bf8360","email":"user2-1vdaq6TSQIqzm7k4LFAth@example.com","msg":"User registered"}
{"level":30,"time":1768675327142,"env":"test","module":"auth-routes","userId":"7da104db-5c7f-42f1-8133-2af454bf8360","msg":"User logged in successfully"}
{"level":30,"time":1768675327200,"env":"test","module":"audit-log-service","userId":"7da104db-5c7f-42f1-8133-2af454bf8360","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675327720,"env":"test","module":"user-credentials-repository","userId":"f304bb01-c69e-43cc-bf50-b69170210921","msg":"User credentials created"}
{"level":30,"time":1768675327832,"env":"test","module":"email-queue","jobId":"2158c991-f232-4d50-b4e7-f48ee9b8d7c9","to":"protected-test-BaITT4prNaeforVbYhIF9@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675327892,"env":"test","module":"auth-routes","userId":"f304bb01-c69e-43cc-bf50-b69170210921","email":"protected-test-BaITT4prNaeforVbYhIF9@example.com","msg":"User registered"}
{"level":30,"time":1768675328597,"env":"test","module":"auth-routes","userId":"f304bb01-c69e-43cc-bf50-b69170210921","msg":"User logged in successfully"}
{"level":30,"time":1768675328662,"env":"test","module":"audit-log-service","userId":"f304bb01-c69e-43cc-bf50-b69170210921","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675329311,"env":"test","module":"intake-service","runId":"0138ec9f-8b30-4d68-9e17-eca7c00fd6b1","slug":"public-yX2V9CsL7DXK3rjNoAw7Y","msg":"Created intake run"}
{"level":30,"time":1768675329781,"env":"test","module":"user-credentials-repository","userId":"6b2b9432-8cf7-449b-af0d-d4c2ebccb9b6","msg":"User credentials created"}
{"level":30,"time":1768675329900,"env":"test","module":"email-queue","jobId":"f7dd6e0d-3cad-4eb1-880c-5413110ee300","to":"protected-test-AJoBhV-GCaMXbmv1rzGRf@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675329958,"env":"test","module":"auth-routes","userId":"6b2b9432-8cf7-449b-af0d-d4c2ebccb9b6","email":"protected-test-AJoBhV-GCaMXbmv1rzGRf@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675330668,"env":"test","module":"auth-routes","userId":"6b2b9432-8cf7-449b-af0d-d4c2ebccb9b6","msg":"User logged in successfully"}
{"level":30,"time":1768675330722,"env":"test","module":"audit-log-service","userId":"6b2b9432-8cf7-449b-af0d-d4c2ebccb9b6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675331350,"env":"test","module":"intake-service","runId":"657233f1-28b0-48c9-9423-f9d438fda6c4","slug":"optional-SX0BA4GW6Sd-gAsQm2wMc","userId":"6b2b9432-8cf7-449b-af0d-d4c2ebccb9b6","msg":"Created intake run"}
{"level":30,"time":1768675331807,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768675331808,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ£ô tests/integration/auth/protected.routes.test.ts (33 tests | 1 skipped) 53760ms
       Γ£ô should allow access with valid Bearer token  1256ms
       Γ£ô should reject access without Authorization header  1162ms
       Γ£ô should reject access with empty Bearer token  1140ms
       Γ£ô should reject access with malformed Authorization header  1149ms
       Γ£ô should reject access with wrong token type  1230ms
       Γ£ô should allow POST with valid Bearer token  1222ms
       Γ£ô should reject POST without Bearer token  1143ms
       Γ£ô should reject POST with invalid token  1153ms
       Γ£ô should allow PUT with valid Bearer token  1320ms
       Γ£ô should reject PUT without Bearer token  1192ms
       Γ£ô should allow DELETE with valid Bearer token  1266ms
       Γ£ô should reject DELETE without Bearer token  1162ms
       Γ£ô should allow PATCH with valid Bearer token  1768ms
       Γ£ô should reject PATCH without Bearer token  1142ms
       Γ£ô should handle Bearer token with extra spaces  1145ms
       Γ£ô should handle very long invalid token  1161ms
       Γ£ô should handle empty Authorization header  1194ms
       Γ£ô should handle Authorization header with only Bearer  1198ms
       Γ£ô should handle multiple Authorization headers  1171ms
       Γ£ô should reject token with SQL injection attempt  1184ms
       Γ£ô should reject token with XSS attempt  1164ms
       Γ£ô should reject token with missing userId  1174ms
       Γ£ô should reject token with non-existent userId  1280ms
       Γ£ô should not allow user to access another user's resources  2295ms
       Γ£ô should inject userId into request context  1268ms
       Γ£ô should inject tenantId into request context  1209ms
       Γ£ô should inject role into request context  1207ms
       Γ£ô should not apply general rate limiting to authenticated requests  1607ms
       Γ£ô should handle request with both Bearer token and cookies  2049ms
       Γ£ô should prioritize Bearer token over cookie when both present  3289ms
       Γ£ô should allow unauthenticated access to optional auth routes  2052ms
       Γ£ô should enhance optional auth routes with user context when authenticated  2109ms

 Test Files  1 passed (1)
      Tests  32 passed | 1 skipped (33)
   Start at  12:40:53
   Duration  77.91s

 PASS  Waiting for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x6 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768675487745,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768675493498,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768675493547,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768675494977,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768675494995,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768675494985,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768675494986,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768675494990,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768675494991,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768675494995,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768675494995,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768675494995,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768675494995,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768675495441,"env":"test","module":"user-credentials-repository","userId":"ec14c20e-5969-431d-a20f-1ffaa67467f6","msg":"User credentials created"}
{"level":30,"time":1768675495535,"env":"test","module":"email-queue","jobId":"5ab0709f-b3c4-4f24-b103-e1a2612a9382","to":"test-AkFeIiG2cKR0_7FnnHWi6@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675495584,"env":"test","module":"auth-routes","userId":"ec14c20e-5969-431d-a20f-1ffaa67467f6","email":"test-AkFeIiG2cKR0_7FnnHWi6@example.com","msg":"User registered"}
{"level":30,"time":1768675496199,"env":"test","module":"user-credentials-repository","userId":"a7f288fc-d564-4f20-a5b3-329d90918013","msg":"User credentials created"}
{"level":30,"time":1768675496293,"env":"test","module":"email-queue","jobId":"af76eab9-9483-4988-a748-57bb087db38f","to":"protected-test-QKH4JpR0GWoNnQEZmN1D2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675496336,"env":"test","module":"auth-routes","userId":"a7f288fc-d564-4f20-a5b3-329d90918013","email":"protected-test-QKH4JpR0GWoNnQEZmN1D2@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675496952,"env":"test","module":"auth-routes","userId":"a7f288fc-d564-4f20-a5b3-329d90918013","msg":"User logged in successfully"}
{"level":30,"time":1768675496997,"env":"test","module":"audit-log-service","userId":"a7f288fc-d564-4f20-a5b3-329d90918013","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675497426,"env":"test","module":"user-credentials-repository","userId":"239b6887-ad4b-4353-9846-9fbb7518ac5b","msg":"User credentials created"}
{"level":30,"time":1768675497532,"env":"test","module":"email-queue","jobId":"5b0e25be-fe05-456f-b2f8-5f0ae8eb6f8e","to":"protected-test-poAAwX58KMSE0l3zfWmq0@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675497576,"env":"test","module":"auth-routes","userId":"239b6887-ad4b-4353-9846-9fbb7518ac5b","email":"protected-test-poAAwX58KMSE0l3zfWmq0@example.com","msg":"User registered"}
{"level":30,"time":1768675498180,"env":"test","module":"auth-routes","userId":"239b6887-ad4b-4353-9846-9fbb7518ac5b","msg":"User logged in successfully"}
{"level":30,"time":1768675498225,"env":"test","module":"audit-log-service","userId":"239b6887-ad4b-4353-9846-9fbb7518ac5b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675498229,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675498615,"env":"test","module":"user-credentials-repository","userId":"f4e0640b-6df5-4ef1-9ba0-15ccca714b1a","msg":"User credentials created"}
{"level":30,"time":1768675498708,"env":"test","module":"email-queue","jobId":"2a5359be-98c2-4b49-87f7-8397cddb7191","to":"protected-test-gLTZYDddYeX3N9KlggJ3I@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675498753,"env":"test","module":"auth-routes","userId":"f4e0640b-6df5-4ef1-9ba0-15ccca714b1a","email":"protected-test-gLTZYDddYeX3N9KlggJ3I@example.com","msg":"User registered"}
{"level":30,"time":1768675499584,"env":"test","module":"user-credentials-repository","userId":"cae142ea-29ac-471e-8e87-02e547dddefd","msg":"User credentials created"}
{"level":30,"time":1768675499702,"env":"test","module":"email-queue","jobId":"4187b6fb-c6a0-45a7-8fe6-fd12e38eecbf","to":"protected-test-pSabo9fqxjLa7ljyvlmAx@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675499769,"env":"test","module":"auth-routes","userId":"cae142ea-29ac-471e-8e87-02e547dddefd","email":"protected-test-pSabo9fqxjLa7ljyvlmAx@example.com","msg":"User registered"}
{"level":30,"time":1768675500503,"env":"test","module":"user-credentials-repository","userId":"8ec562d3-0df6-49e4-aa68-ed19fa0d1a73","msg":"User credentials created"}
{"level":30,"time":1768675500620,"env":"test","module":"email-queue","jobId":"b1702db0-6da0-4c8d-8ff5-19acce554a41","to":"protected-test-l67x51amee5U78IZ1P-Iq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675500666,"env":"test","module":"auth-routes","userId":"8ec562d3-0df6-49e4-aa68-ed19fa0d1a73","email":"protected-test-l67x51amee5U78IZ1P-Iq@example.com","msg":"User registered"}
{"level":30,"time":1768675501387,"env":"test","module":"user-credentials-repository","userId":"9b9fb80a-3bc2-4bc6-bacc-d63614f69283","msg":"User credentials created"}
{"level":30,"time":1768675501485,"env":"test","module":"email-queue","jobId":"853ba15b-a1fa-4b40-a0da-402dbd9494c5","to":"protected-test-cEx-_pF_oAcKhzoHVoKG2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675501539,"env":"test","module":"auth-routes","userId":"9b9fb80a-3bc2-4bc6-bacc-d63614f69283","email":"protected-test-cEx-_pF_oAcKhzoHVoKG2@example.com","msg":"User registered"}
{"level":30,"time":1768675502214,"env":"test","module":"user-credentials-repository","userId":"6d7d24cf-a654-4cd5-8294-afc67f7b4a1b","msg":"User credentials created"}
{"level":30,"time":1768675502318,"env":"test","module":"email-queue","jobId":"4c5591ac-4ad8-4176-b3cd-9696bf6b6a50","to":"protected-test-KxZPz57ZtF4TEfPL_E0kr@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675502362,"env":"test","module":"auth-routes","userId":"6d7d24cf-a654-4cd5-8294-afc67f7b4a1b","email":"protected-test-KxZPz57ZtF4TEfPL_E0kr@example.com","msg":"User registered"}
{"level":30,"time":1768675503155,"env":"test","module":"user-credentials-repository","userId":"41693287-9027-4540-8d71-86d7984bf800","msg":"User credentials created"}
{"level":30,"time":1768675503276,"env":"test","module":"email-queue","jobId":"b3675880-f4e4-4863-83f3-00bddf3c8f2f","to":"protected-test-5oRoj1YJmnS3BFiAogRJ9@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675503336,"env":"test","module":"auth-routes","userId":"41693287-9027-4540-8d71-86d7984bf800","email":"protected-test-5oRoj1YJmnS3BFiAogRJ9@example.com","msg":"User registered"}
{"level":30,"time":1768675504156,"env":"test","module":"user-credentials-repository","userId":"45b5e15c-90d3-4297-a2f8-c220d8054dec","msg":"User credentials created"}
{"level":30,"time":1768675504274,"env":"test","module":"email-queue","jobId":"7ab0da50-8ae5-4336-af32-52839b071dbc","to":"protected-test-aKAAgMjNEUrx0huu6u7BC@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675504337,"env":"test","module":"auth-routes","userId":"45b5e15c-90d3-4297-a2f8-c220d8054dec","email":"protected-test-aKAAgMjNEUrx0huu6u7BC@example.com","msg":"User registered"}
{"level":30,"time":1768675505166,"env":"test","module":"user-credentials-repository","userId":"d082ed79-3a58-4c46-adeb-9676e3c87838","msg":"User credentials created"}
{"level":30,"time":1768675505286,"env":"test","module":"email-queue","jobId":"0dbaa509-8f40-456e-892f-36b765afb3f0","to":"protected-test-fejZZlDEUe0kCnF0ShuJI@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675505344,"env":"test","module":"auth-routes","userId":"d082ed79-3a58-4c46-adeb-9676e3c87838","email":"protected-test-fejZZlDEUe0kCnF0ShuJI@example.com","msg":"User registered"}
{"level":30,"time":1768675506067,"env":"test","module":"user-credentials-repository","userId":"0eac4fb3-955b-4a17-8e24-da436f35703c","msg":"User credentials created"}
{"level":30,"time":1768675506161,"env":"test","module":"email-queue","jobId":"ad470a43-1564-4e4b-a298-17561b77870c","to":"protected-test-sivA6BU0dhNihReCITncP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675506212,"env":"test","module":"auth-routes","userId":"0eac4fb3-955b-4a17-8e24-da436f35703c","email":"protected-test-sivA6BU0dhNihReCITncP@example.com","msg":"User registered"}
{"level":30,"time":1768675506914,"env":"test","module":"user-credentials-repository","userId":"63c5bc35-7639-414a-8112-6ce8af0430b6","msg":"User credentials created"}
{"level":30,"time":1768675507002,"env":"test","module":"email-queue","jobId":"ecc9c0ae-418a-4e86-8dd0-5334149f4990","to":"protected-test-W3IfKoM_M3-6D5iJedYWZ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675507045,"env":"test","module":"auth-routes","userId":"63c5bc35-7639-414a-8112-6ce8af0430b6","email":"protected-test-W3IfKoM_M3-6D5iJedYWZ@example.com","msg":"User registered"}
{"level":30,"time":1768675507843,"env":"test","module":"user-credentials-repository","userId":"a5a352e6-3831-45f6-956a-c86074157126","msg":"User credentials created"}
{"level":30,"time":1768675507958,"env":"test","module":"email-queue","jobId":"924051d5-3174-443c-a556-355880290c69","to":"protected-test-nhDkrbFnApqV03rY97t0N@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675508022,"env":"test","module":"auth-routes","userId":"a5a352e6-3831-45f6-956a-c86074157126","email":"protected-test-nhDkrbFnApqV03rY97t0N@example.com","msg":"User registered"}
{"level":30,"time":1768675508919,"env":"test","module":"user-credentials-repository","userId":"a239da83-8dde-435e-921c-c50023019f8c","msg":"User credentials created"}
{"level":30,"time":1768675509038,"env":"test","module":"email-queue","jobId":"3bba303e-8137-4b2d-9f10-e6ff5139e735","to":"protected-test-018cZDKnhnvPUR6YJTMfp@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675509100,"env":"test","module":"auth-routes","userId":"a239da83-8dde-435e-921c-c50023019f8c","email":"protected-test-018cZDKnhnvPUR6YJTMfp@example.com","msg":"User registered"}
{"level":50,"time":1768675509892,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b277127f-b02f-473b-b0eb-4ccca77101f9","$2b$12$fMJVceHsTKL/y7uI1MpUhOTjDeAw015WqgnH0H4BNLQpDJh6rkr0q"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b277127f-b02f-473b-b0eb-4ccca77101f9) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"b277127f-b02f-473b-b0eb-4ccca77101f9","msg":"Failed to create user credentials"}
{"level":50,"time":1768675509892,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b277127f-b02f-473b-b0eb-4ccca77101f9","$2b$12$fMJVceHsTKL/y7uI1MpUhOTjDeAw015WqgnH0H4BNLQpDJh6rkr0q"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b277127f-b02f-473b-b0eb-4ccca77101f9) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675510557,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["a3290df7-68fe-4292-8679-2d7a91b441ab","$2b$12$2K/TfoW3m1HUr5O9/l7dCexYulFHn3AnHnun9zDrrkNRyr1aJP/im"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(a3290df7-68fe-4292-8679-2d7a91b441ab) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"a3290df7-68fe-4292-8679-2d7a91b441ab","msg":"Failed to create user credentials"}
{"level":50,"time":1768675510557,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["a3290df7-68fe-4292-8679-2d7a91b441ab","$2b$12$2K/TfoW3m1HUr5O9/l7dCexYulFHn3AnHnun9zDrrkNRyr1aJP/im"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(a3290df7-68fe-4292-8679-2d7a91b441ab) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675511237,"env":"test","module":"user-credentials-repository","userId":"5bf8dc1c-06df-43e4-a324-9c71feb31624","msg":"User credentials created"}
{"level":30,"time":1768675511340,"env":"test","module":"email-queue","jobId":"cd85c94c-81fa-446e-acd6-899c8017f6b1","to":"protected-test-WjjlJjsyZPk5-JhH4-Zxo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768675511387,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["5bf8dc1c-06df-43e4-a324-9c71feb31624","57e6d0b51441da103d136a980d8e7673d73690bc3b74793ee9df28e3e5fa297f","2026-02-16T18:45:11.340Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T18:45:11.341Z"],"cause":{"length":338,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5bf8dc1c-06df-43e4-a324-9c71feb31624) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675512052,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8b4e4791-8f3c-45e2-b7ad-a8d5e01f02eb","$2b$12$5izsmV4ooQN/ObT3YG/pBOiUsfAIFl/mCsPUlvkTZF.Bf3ZcvQbTS"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8b4e4791-8f3c-45e2-b7ad-a8d5e01f02eb) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"8b4e4791-8f3c-45e2-b7ad-a8d5e01f02eb","msg":"Failed to create user credentials"}
{"level":50,"time":1768675512052,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8b4e4791-8f3c-45e2-b7ad-a8d5e01f02eb","$2b$12$5izsmV4ooQN/ObT3YG/pBOiUsfAIFl/mCsPUlvkTZF.Bf3ZcvQbTS"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8b4e4791-8f3c-45e2-b7ad-a8d5e01f02eb) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675512749,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["16449903-9ea6-4c47-8251-2580731f02dc","$2b$12$4qqlZKLU/ep2SuVFKqc4BOrQW6oaygn327pge9FmEtGGMDnwxPm4m"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(16449903-9ea6-4c47-8251-2580731f02dc) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"16449903-9ea6-4c47-8251-2580731f02dc","msg":"Failed to create user credentials"}
{"level":50,"time":1768675512750,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["16449903-9ea6-4c47-8251-2580731f02dc","$2b$12$4qqlZKLU/ep2SuVFKqc4BOrQW6oaygn327pge9FmEtGGMDnwxPm4m"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(16449903-9ea6-4c47-8251-2580731f02dc) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675513511,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["c49164b3-cc17-4a9f-8a18-b9e5d2148f0b","$2b$12$76NLjpxaTaC2T9jbfhquE.XnFmpYPXOzoZmGxjZ3Us8hcYoB7AyHK"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c49164b3-cc17-4a9f-8a18-b9e5d2148f0b) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"c49164b3-cc17-4a9f-8a18-b9e5d2148f0b","msg":"Failed to create user credentials"}
{"level":50,"time":1768675513511,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["c49164b3-cc17-4a9f-8a18-b9e5d2148f0b","$2b$12$76NLjpxaTaC2T9jbfhquE.XnFmpYPXOzoZmGxjZ3Us8hcYoB7AyHK"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c49164b3-cc17-4a9f-8a18-b9e5d2148f0b) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675514283,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["65cbbdf8-a202-44fe-b037-eb99901297e8","$2b$12$LfhIHQygCTqrD/yDU17GAe9dQE9EIeF2YPOmMDfzYyQyx1bZi7p/2"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(65cbbdf8-a202-44fe-b037-eb99901297e8) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"65cbbdf8-a202-44fe-b037-eb99901297e8","msg":"Failed to create user credentials"}
{"level":50,"time":1768675514283,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["65cbbdf8-a202-44fe-b037-eb99901297e8","$2b$12$LfhIHQygCTqrD/yDU17GAe9dQE9EIeF2YPOmMDfzYyQyx1bZi7p/2"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(65cbbdf8-a202-44fe-b037-eb99901297e8) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675515056,"env":"test","module":"user-credentials-repository","userId":"1547ab9a-1bdd-41e8-9e0c-0a7ab66a59ee","msg":"User credentials created"}
{"level":30,"time":1768675515177,"env":"test","module":"email-queue","jobId":"d479cf88-32cb-4b4e-9e6a-222b10711e3f","to":"protected-test-c1ASGZ2I8ja2FuHDNCDmU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675515234,"env":"test","module":"auth-routes","userId":"1547ab9a-1bdd-41e8-9e0c-0a7ab66a59ee","email":"protected-test-c1ASGZ2I8ja2FuHDNCDmU@example.com","msg":"User registered"}
{"level":50,"time":1768675515989,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["c02f5fc7-7b60-4bf8-af3b-959b56baad56","$2b$12$lkrCd8T/olMZ6jYpyHAZ9uIUmYw0R4cPhUoBxZIHSqk730NvWNVhq"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c02f5fc7-7b60-4bf8-af3b-959b56baad56) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"c02f5fc7-7b60-4bf8-af3b-959b56baad56","msg":"Failed to create user credentials"}
{"level":50,"time":1768675515989,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["c02f5fc7-7b60-4bf8-af3b-959b56baad56","$2b$12$lkrCd8T/olMZ6jYpyHAZ9uIUmYw0R4cPhUoBxZIHSqk730NvWNVhq"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c02f5fc7-7b60-4bf8-af3b-959b56baad56) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675516646,"env":"test","module":"user-credentials-repository","userId":"ae0bf1ba-1521-4b16-a3f2-0ac80fbc35a0","msg":"User credentials created"}
{"level":30,"time":1768675516742,"env":"test","module":"email-queue","jobId":"d3e1e4c0-1749-4370-b5b7-4dbdd6b7fa41","to":"protected-test-EphQioyQBsAx4chQCZs9W@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675516784,"env":"test","module":"auth-routes","userId":"ae0bf1ba-1521-4b16-a3f2-0ac80fbc35a0","email":"protected-test-EphQioyQBsAx4chQCZs9W@example.com","msg":"User registered"}
{"level":50,"time":1768675517527,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["5d0ddaa2-a530-474d-98c9-7619edd2b4eb","$2b$12$/vixC0cgr/CFK2qXBrjdFe5ZZRPIdb9XlReZh7cPFspRriAm1FtHS"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5d0ddaa2-a530-474d-98c9-7619edd2b4eb) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"5d0ddaa2-a530-474d-98c9-7619edd2b4eb","msg":"Failed to create user credentials"}
{"level":50,"time":1768675517527,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["5d0ddaa2-a530-474d-98c9-7619edd2b4eb","$2b$12$/vixC0cgr/CFK2qXBrjdFe5ZZRPIdb9XlReZh7cPFspRriAm1FtHS"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5d0ddaa2-a530-474d-98c9-7619edd2b4eb) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675518303,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["227e4ea6-71ee-4dad-b9d2-8a3fcc7ee806","$2b$12$N3tV1eRsGKOww6Fyfo7qn.bYkhwb620RL6PyKNrVpiiXUTBLY4Kp."],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(227e4ea6-71ee-4dad-b9d2-8a3fcc7ee806) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"227e4ea6-71ee-4dad-b9d2-8a3fcc7ee806","msg":"Failed to create user credentials"}
{"level":50,"time":1768675518303,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["227e4ea6-71ee-4dad-b9d2-8a3fcc7ee806","$2b$12$N3tV1eRsGKOww6Fyfo7qn.bYkhwb620RL6PyKNrVpiiXUTBLY4Kp."],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(227e4ea6-71ee-4dad-b9d2-8a3fcc7ee806) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675518942,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["278c6986-55c0-4c2a-8333-18147866dc76","$2b$12$cZEFyjZzVa7DEDiXAeggDe/rcRcK4lezYLGgzp0etgDKbcJQoo7JS"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(278c6986-55c0-4c2a-8333-18147866dc76) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"278c6986-55c0-4c2a-8333-18147866dc76","msg":"Failed to create user credentials"}
{"level":50,"time":1768675518942,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["278c6986-55c0-4c2a-8333-18147866dc76","$2b$12$cZEFyjZzVa7DEDiXAeggDe/rcRcK4lezYLGgzp0etgDKbcJQoo7JS"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(278c6986-55c0-4c2a-8333-18147866dc76) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675519583,"env":"test","module":"user-credentials-repository","userId":"dd9ad911-2c1c-4fd9-b256-b63063f0ee7b","msg":"User credentials created"}
{"level":30,"time":1768675519672,"env":"test","module":"email-queue","jobId":"b922e1fe-70b2-47b0-bda6-b0186a615230","to":"protected-test-4KNlEbDUOgFVT8gm_WiCz@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675519716,"env":"test","module":"auth-routes","userId":"dd9ad911-2c1c-4fd9-b256-b63063f0ee7b","email":"protected-test-4KNlEbDUOgFVT8gm_WiCz@example.com","msg":"User registered"}
{"level":30,"time":1768675520407,"env":"test","module":"user-credentials-repository","userId":"9c9d3ee1-8b98-4974-834f-8403e26a6c83","msg":"User credentials created"}
{"level":50,"time":1768675520460,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["9c9d3ee1-8b98-4974-834f-8403e26a6c83","db4e5295b1bd7bd445d337c46895445a36d08001f9812144fe103e8a7060d7aa","2026-01-18T18:45:20.407Z"],"cause":{"length":371,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(9c9d3ee1-8b98-4974-834f-8403e26a6c83) is not present in table \"users\".","schema":"public","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675521125,"env":"test","module":"user-credentials-repository","userId":"b6c75abd-e7c8-4ba2-9d8d-dad153775810","msg":"User credentials created"}
{"level":50,"time":1768675521173,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["b6c75abd-e7c8-4ba2-9d8d-dad153775810","593b08eb3bb041cb156a62219615a894a45a2a2d434eff6b8d764650fb03da98","2026-01-18T18:45:21.125Z"],"cause":{"length":382,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b6c75abd-e7c8-4ba2-9d8d-dad153775810) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675521962,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["ea59a473-a001-4ed2-bfc3-126f1c0c3dd8","$2b$12$YqfBVQnd3cofiwPXl3geYO6ZMbF90bggnMvgVfwrMNC4I5woxZNiu"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(ea59a473-a001-4ed2-bfc3-126f1c0c3dd8) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"ea59a473-a001-4ed2-bfc3-126f1c0c3dd8","msg":"Failed to create user credentials"}
{"level":50,"time":1768675521962,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["ea59a473-a001-4ed2-bfc3-126f1c0c3dd8","$2b$12$YqfBVQnd3cofiwPXl3geYO6ZMbF90bggnMvgVfwrMNC4I5woxZNiu"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(ea59a473-a001-4ed2-bfc3-126f1c0c3dd8) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675522705,"env":"test","module":"user-credentials-repository","userId":"385cc9d8-1eb4-4331-b551-475c5e8f661a","msg":"User credentials created"}
{"level":30,"time":1768675522819,"env":"test","module":"email-queue","jobId":"0b26f1ec-6bec-45cc-be12-ee4f007a11fe","to":"protected-test-X-VeYlQHRqcnL1nqFVT19@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675522882,"env":"test","module":"auth-routes","userId":"385cc9d8-1eb4-4331-b551-475c5e8f661a","email":"protected-test-X-VeYlQHRqcnL1nqFVT19@example.com","msg":"User registered"}
{"level":30,"time":1768675523606,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768675523606,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 30 failed | 1 skipped) 31020ms
       Γ£ô should allow access with valid Bearer token  1202ms
       Γ£ô should reject access without Authorization header  1182ms
       ├ù should reject access with empty Bearer token 574ms
       ├ù should reject access with malformed Authorization header 1030ms
       ├ù should reject access with wrong token type 885ms
       ├ù should allow POST with valid Bearer token 866ms
       ├ù should reject POST without Bearer token 824ms
       ├ù should reject POST with invalid token 983ms
       ├ù should allow PUT with valid Bearer token 1002ms
       ├ù should reject PUT without Bearer token 1014ms
       ├ù should allow DELETE with valid Bearer token 855ms
       ├ù should reject DELETE without Bearer token 838ms
       ├ù should allow PATCH with valid Bearer token 1037ms
       ├ù should reject PATCH without Bearer token 1024ms
       ├ù should handle Bearer token with extra spaces 732ms
       Γåô should handle token with newlines
       ├ù should handle very long invalid token 666ms
       ├ù should handle empty Authorization header 830ms
       ├ù should handle Authorization header with only Bearer 665ms
       ├ù should handle multiple Authorization headers 697ms
       ├ù should reject token with SQL injection attempt 762ms
       ├ù should reject token with XSS attempt 771ms
       ├ù should reject token with missing userId 1065ms
       ├ù should reject token with non-existent userId 641ms
       ├ù should not allow user to access another user's resources 881ms
       ├ù should inject userId into request context 657ms
       ├ù should inject tenantId into request context 776ms
       ├ù should inject role into request context 638ms
       ├ù should not apply general rate limiting to authenticated requests 821ms
       ├ù should handle request with both Bearer token and cookies 697ms
       ├ù should prioritize Bearer token over cookie when both present 714ms
       ├ù should allow unauthenticated access to optional auth routes 789ms
       ├ù should enhance optional auth routes with user context when authenticated 978ms

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Tests 30 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: df9d7542-7d9b-4544-afe8-022c211c9f73,owner,true,f4e0640b-6df5-4ef1-9ba0-15ccca714b1a
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(df9d7542-7d9b-4544-afe8-022c211c9f73) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/30]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: df9d7542-7d9b-4544-afe8-022c211c9f73,owner,true,cae142ea-29ac-471e-8e87-02e547dddefd
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(df9d7542-7d9b-4544-afe8-022c211c9f73) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/30]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: df9d7542-7d9b-4544-afe8-022c211c9f73,owner,true,8ec562d3-0df6-49e4-aa68-ed19fa0d1a73
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(df9d7542-7d9b-4544-afe8-022c211c9f73) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[3/30]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: df9d7542-7d9b-4544-afe8-022c211c9f73,owner,true,9b9fb80a-3bc2-4bc6-bacc-d63614f69283
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(df9d7542-7d9b-4544-afe8-022c211c9f73) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[4/30]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: df9d7542-7d9b-4544-afe8-022c211c9f73,owner,true,6d7d24cf-a654-4cd5-8294-afc67f7b4a1b
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(df9d7542-7d9b-4544-afe8-022c211c9f73) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[5/30]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: df9d7542-7d9b-4544-afe8-022c211c9f73,owner,true,41693287-9027-4540-8d71-86d7984bf800
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(df9d7542-7d9b-4544-afe8-022c211c9f73) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[6/30]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: df9d7542-7d9b-4544-afe8-022c211c9f73,owner,true,45b5e15c-90d3-4297-a2f8-c220d8054dec
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(df9d7542-7d9b-4544-afe8-022c211c9f73) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[7/30]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: df9d7542-7d9b-4544-afe8-022c211c9f73,owner,true,d082ed79-3a58-4c46-adeb-9676e3c87838
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(df9d7542-7d9b-4544-afe8-022c211c9f73) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[8/30]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: df9d7542-7d9b-4544-afe8-022c211c9f73,owner,true,0eac4fb3-955b-4a17-8e24-da436f35703c
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(df9d7542-7d9b-4544-afe8-022c211c9f73) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[9/30]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: df9d7542-7d9b-4544-afe8-022c211c9f73,owner,true,63c5bc35-7639-414a-8112-6ce8af0430b6
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(df9d7542-7d9b-4544-afe8-022c211c9f73) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[10/30]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
Error: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: dcb5976b-1468-4e41-957c-fa0411c0d7e0,a5a352e6-3831-45f6-956a-c86074157126,admin
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:71:13
     69|         // This fixes the 403 error in "Cross-User Authorization" test
     70|         if (ctx.orgId) {
     71|             await db.insert(organizationMemberships).values({
       |             ^
     72|                 orgId: ctx.orgId,
     73|                 userId: userId,

Caused by: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_user_id_users_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:71:13

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 378, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(a5a352e6-3831-45f6-956a-c86074157126) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[11/30]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: df9d7542-7d9b-4544-afe8-022c211c9f73,owner,true,a239da83-8dde-435e-921c-c50023019f8c
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(df9d7542-7d9b-4544-afe8-022c211c9f73) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[12/30]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
Error: expected 201 "Created", got 500 "Internal Server Error"
 Γ¥» tests/integration/auth/protected.routes.test.ts:56:14
     54|             .post("/api/auth/register")
     55|             .send(testUser)
     56|             .expect(201);
       |              ^
     57| 
     58|         const userId = registerRes.body.user.id;
 Γ¥» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Γ¥» node_modules/supertest/lib/test.js:365:13
 Γ¥» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Γ¥» Test.assert node_modules/supertest/lib/test.js:195:23
 Γ¥» localAssert node_modules/supertest/lib/test.js:138:14
 Γ¥» node_modules/supertest/lib/test.js:156:7
 Γ¥» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Γ¥» node_modules/superagent/lib/node/index.js:1102:18
 Γ¥» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[13/30]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
Error: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: dcb5976b-1468-4e41-957c-fa0411c0d7e0,1547ab9a-1bdd-41e8-9e0c-0a7ab66a59ee,admin
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:71:13
     69|         // This fixes the 403 error in "Cross-User Authorization" test
     70|         if (ctx.orgId) {
     71|             await db.insert(organizationMemberships).values({
       |             ^
     72|                 orgId: ctx.orgId,
     73|                 userId: userId,

Caused by: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:71:13

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 388, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(dcb5976b-1468-4e41-957c-fa0411c0d7e0) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[14/30]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
Error: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: dcb5976b-1468-4e41-957c-fa0411c0d7e0,ae0bf1ba-1521-4b16-a3f2-0ac80fbc35a0,admin
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:71:13
     69|         // This fixes the 403 error in "Cross-User Authorization" test
     70|         if (ctx.orgId) {
     71|             await db.insert(organizationMemberships).values({
       |             ^
     72|                 orgId: ctx.orgId,
     73|                 userId: userId,

Caused by: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_user_id_users_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:71:13

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 378, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(ae0bf1ba-1521-4b16-a3f2-0ac80fbc35a0) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[15/30]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: df9d7542-7d9b-4544-afe8-022c211c9f73,owner,true,dd9ad911-2c1c-4fd9-b256-b63063f0ee7b
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(df9d7542-7d9b-4544-afe8-022c211c9f73) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[16/30]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: df9d7542-7d9b-4544-afe8-022c211c9f73,owner,true,385cc9d8-1eb4-4331-b551-475c5e8f661a
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(df9d7542-7d9b-4544-afe8-022c211c9f73) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[17/30]ΓÄ»


 Test Files  1 failed (1)
      Tests  30 failed | 2 passed | 1 skipped (33)
   Start at  12:44:04
   Duration  74.13s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x7 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768678738880,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768678747007,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768678747054,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: []

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768678748711,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768678748726,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768678748718,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768678748718,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768678748722,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768678748723,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768678748725,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768678748725,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768678748726,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768678748726,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768678749242,"env":"test","module":"user-credentials-repository","userId":"67b36611-5632-4226-afe9-3a49c5fd717f","msg":"User credentials created"}
{"level":30,"time":1768678749367,"env":"test","module":"email-queue","jobId":"5ec7b2a1-6a77-4819-8328-44a7a639d93f","to":"test-FEdjTPEIyOnyL2mpAILfp@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768678749435,"env":"test","module":"auth-routes","userId":"67b36611-5632-4226-afe9-3a49c5fd717f","email":"test-FEdjTPEIyOnyL2mpAILfp@example.com","msg":"User registered"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: update "users" set "tenant_id" = $1, "role" = $2, "tenant_role" = $3 where "users"."id" = $4
params: c8f20d3c-c9a3-47e6-809a-f833c4faaff3,admin,owner,67b36611-5632-4226-afe9-3a49c5fd717f
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:121:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'update "users" set "tenant_id" = $1, "role" = $2, "tenant_role" = $3 where "users"."id" = $4',
  params: [
    'c8f20d3c-c9a3-47e6-809a-f833c4faaff3',
    'admin',
    'owner',
    '67b36611-5632-4226-afe9-3a49c5fd717f'
  ],
  cause: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:121:5)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 314,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (tenant_id)=(c8f20d3c-c9a3-47e6-809a-f833c4faaff3) is not present in table "tenants".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w0_v3',
    table: 'users',
    column: undefined,
    dataType: undefined,
    constraint: 'users_tenant_id_tenants_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":30,"time":1768678749506,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768678749506,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 3371ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: update "users" set "tenant_id" = $1, "role" = $2, "tenant_role" = $3 where "users"."id" = $4
params: c8f20d3c-c9a3-47e6-809a-f833c4faaff3,admin,owner,67b36611-5632-4226-afe9-3a49c5fd717f
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:121:5
    119| 
    120|     // Update user with tenant and roles
    121|     await db.update(schema.users)
       |     ^
    122|       .set({
    123|         tenantId,
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:121:5
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(c8f20d3c-c9a3-47e6-809a-f833c4faaff3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:38:49
   Duration  17.35s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x8 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöæ add access controls to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768678769145,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768678777537,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768678777577,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:188:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:188:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768678777887,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768678777905,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768678777895,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768678777896,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768678777901,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768678777901,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768678777905,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768678777905,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768678777905,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768678777905,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant ZGZc1lJbrQiQP_e24kaJX,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant ZGZc1lJbrQiQP_e24kaJX', 'pro' ],
  cause: error: Too many connections attempts
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 50,
    severity: 'ERROR',
    code: 'XX000',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768678778274,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768678778274,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1761ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant ZGZc1lJbrQiQP_e24kaJX,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: Too many connections attempts
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 50, severity: 'ERROR', code: 'XX000', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:39:17
   Duration  17.97s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x9 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768678786771,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

{"level":30,"time":1768678826720,"env":"test","msg":"DB: initializing... Local"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768678832894,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768678833331,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768678833352,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768678833342,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768678833342,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768678833347,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768678833347,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768678833352,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768678833352,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768678833352,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768678833352,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768678833754,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768678833754,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:191:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:191:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant Ey-BjYIcUpMgpWwD1edXT,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant Ey-BjYIcUpMgpWwD1edXT', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 7978ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant Ey-BjYIcUpMgpWwD1edXT,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:39:38
   Duration  54.93s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x10 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768679038351,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

{"level":30,"time":1768679075864,"env":"test","msg":"DB: initializing... Local"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768679088145,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768679089890,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768679089913,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768679089900,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768679089901,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768679089907,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768679089907,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768679089912,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768679089912,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768679089913,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768679089913,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w37_v3
ΓÅ⌐ Schema reused, skipping migrations.

{"level":50,"time":1768679090788,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8b9d0325-1cd3-479c-bec4-53b029005b3a","$2b$12$dpDXebh3IIvyoRk1jA4WxOxT9KskYsyAMA0bzJ4.5irIxop5g3/q2"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8b9d0325-1cd3-479c-bec4-53b029005b3a) is not present in table \"users\".","schema":"test_schema_w49_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"8b9d0325-1cd3-479c-bec4-53b029005b3a","msg":"Failed to create user credentials"}
{"level":50,"time":1768679090788,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8b9d0325-1cd3-479c-bec4-53b029005b3a","$2b$12$dpDXebh3IIvyoRk1jA4WxOxT9KskYsyAMA0bzJ4.5irIxop5g3/q2"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8b9d0325-1cd3-479c-bec4-53b029005b3a) is not present in table \"users\".","schema":"test_schema_w49_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768679090804,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768679090805,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 15954ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:43:48
   Duration  53.43s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x11 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768679219256,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768679224097,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768679224558,"env":"test","msg":"DB: Set search_path on initial connection: \"test_schema_w0_v3\",public"}
{"level":30,"time":1768679224558,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public"}
{"level":30,"time":1768679228882,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768679230385,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768679230404,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768679230393,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768679230394,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768679230398,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768679230399,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768679230403,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768679230403,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768679230404,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768679230404,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768679230973,"env":"test","module":"user-credentials-repository","userId":"5e4f4000-cda5-4ad0-bd64-cbeb701694a9","msg":"User credentials created"}
{"level":30,"time":1768679231098,"env":"test","module":"email-queue","jobId":"7dba04d4-f4b7-4082-9f06-51303ac52851","to":"test-2W_vesU-XRwmfklh0LuBy@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679231168,"env":"test","module":"auth-routes","userId":"5e4f4000-cda5-4ad0-bd64-cbeb701694a9","email":"test-2W_vesU-XRwmfklh0LuBy@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

{"level":30,"time":1768679231924,"env":"test","module":"user-credentials-repository","userId":"5acc72a1-b7e2-4fa6-abfa-449acf599fdc","msg":"User credentials created"}
{"level":30,"time":1768679232041,"env":"test","module":"email-queue","jobId":"89f24b46-96ce-40de-8c17-a02686ade5b1","to":"protected-test-7d4dBlaP3xxkNBgOdq4_6@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679232099,"env":"test","module":"auth-routes","userId":"5acc72a1-b7e2-4fa6-abfa-449acf599fdc","email":"protected-test-7d4dBlaP3xxkNBgOdq4_6@example.com","msg":"User registered"}
{"level":30,"time":1768679232803,"env":"test","module":"auth-routes","userId":"5acc72a1-b7e2-4fa6-abfa-449acf599fdc","msg":"User logged in successfully"}
{"level":30,"time":1768679232869,"env":"test","module":"audit-log-service","userId":"5acc72a1-b7e2-4fa6-abfa-449acf599fdc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679233375,"env":"test","module":"user-credentials-repository","userId":"d15b2fa3-685b-407c-b056-f87d37eb356d","msg":"User credentials created"}
{"level":30,"time":1768679233489,"env":"test","module":"email-queue","jobId":"5e86cfa7-f771-41ea-a292-ae0ab7c31336","to":"protected-test-9OJh492YfPjE7SEi-TXWz@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679233547,"env":"test","module":"auth-routes","userId":"d15b2fa3-685b-407c-b056-f87d37eb356d","email":"protected-test-9OJh492YfPjE7SEi-TXWz@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

{"level":30,"time":1768679234251,"env":"test","module":"auth-routes","userId":"d15b2fa3-685b-407c-b056-f87d37eb356d","msg":"User logged in successfully"}
{"level":30,"time":1768679234306,"env":"test","module":"audit-log-service","userId":"d15b2fa3-685b-407c-b056-f87d37eb356d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679234312,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679234830,"env":"test","module":"user-credentials-repository","userId":"388671e2-a13c-473d-b66c-8c0ce75db2b0","msg":"User credentials created"}
{"level":30,"time":1768679234956,"env":"test","module":"email-queue","jobId":"918492a7-aa9b-4222-8b8e-31010c8154dc","to":"protected-test-32imigCkG2n4ytQAxzcmG@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679235018,"env":"test","module":"auth-routes","userId":"388671e2-a13c-473d-b66c-8c0ce75db2b0","email":"protected-test-32imigCkG2n4ytQAxzcmG@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w154_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w154_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768679235749,"env":"test","module":"auth-routes","userId":"388671e2-a13c-473d-b66c-8c0ce75db2b0","msg":"User logged in successfully"}
{"level":30,"time":1768679235804,"env":"test","module":"audit-log-service","userId":"388671e2-a13c-473d-b66c-8c0ce75db2b0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679235809,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679236206,"env":"test","module":"user-credentials-repository","userId":"96c1bce1-1ab0-4dff-9d72-53cfe8e49afa","msg":"User credentials created"}
{"level":30,"time":1768679236321,"env":"test","module":"email-queue","jobId":"a3f0c226-c67a-4a34-97aa-b026b62e65f9","to":"protected-test-FMvQqgOo1S4PDtL3YKJJQ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679236378,"env":"test","module":"auth-routes","userId":"96c1bce1-1ab0-4dff-9d72-53cfe8e49afa","email":"protected-test-FMvQqgOo1S4PDtL3YKJJQ@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

{"level":30,"time":1768679237070,"env":"test","module":"auth-routes","userId":"96c1bce1-1ab0-4dff-9d72-53cfe8e49afa","msg":"User logged in successfully"}
{"level":30,"time":1768679237126,"env":"test","module":"audit-log-service","userId":"96c1bce1-1ab0-4dff-9d72-53cfe8e49afa","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679237131,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679237547,"env":"test","module":"user-credentials-repository","userId":"dd972ea2-2643-4d00-8f54-d5db313e9d6e","msg":"User credentials created"}
{"level":30,"time":1768679237658,"env":"test","module":"email-queue","jobId":"e5ee4645-46cf-40d4-9ed4-9a5926f231d7","to":"protected-test-WA8kkLX9vbRADEOEM8lf2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679237714,"env":"test","module":"auth-routes","userId":"dd972ea2-2643-4d00-8f54-d5db313e9d6e","email":"protected-test-WA8kkLX9vbRADEOEM8lf2@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768679238411,"env":"test","module":"auth-routes","userId":"dd972ea2-2643-4d00-8f54-d5db313e9d6e","msg":"User logged in successfully"}
{"level":30,"time":1768679238475,"env":"test","module":"audit-log-service","userId":"dd972ea2-2643-4d00-8f54-d5db313e9d6e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768679238480,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768679238480,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679238891,"env":"test","module":"user-credentials-repository","userId":"7740881f-c056-4c6e-a3e7-5f8ddbd63220","msg":"User credentials created"}
{"level":30,"time":1768679239010,"env":"test","module":"email-queue","jobId":"8696cee6-779a-4d79-b2c9-5a2d54cfeeff","to":"protected-test-GxapIAnp3Zzzzyf_I8qSQ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679239071,"env":"test","module":"auth-routes","userId":"7740881f-c056-4c6e-a3e7-5f8ddbd63220","email":"protected-test-GxapIAnp3Zzzzyf_I8qSQ@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768679239767,"env":"test","module":"auth-routes","userId":"7740881f-c056-4c6e-a3e7-5f8ddbd63220","msg":"User logged in successfully"}
{"level":30,"time":1768679239822,"env":"test","module":"audit-log-service","userId":"7740881f-c056-4c6e-a3e7-5f8ddbd63220","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679240290,"env":"test","module":"user-credentials-repository","userId":"9c3e44bc-02fe-4201-9c4d-2a932f87b634","msg":"User credentials created"}
{"level":30,"time":1768679240400,"env":"test","module":"email-queue","jobId":"6ec3c439-74c7-4f8d-87f2-fab527179f8f","to":"protected-test-DhFvMLMOfI3PCAPiSS-xO@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679240458,"env":"test","module":"auth-routes","userId":"9c3e44bc-02fe-4201-9c4d-2a932f87b634","email":"protected-test-DhFvMLMOfI3PCAPiSS-xO@example.com","msg":"User registered"}
{"level":30,"time":1768679241132,"env":"test","module":"auth-routes","userId":"9c3e44bc-02fe-4201-9c4d-2a932f87b634","msg":"User logged in successfully"}
{"level":30,"time":1768679241187,"env":"test","module":"audit-log-service","userId":"9c3e44bc-02fe-4201-9c4d-2a932f87b634","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679241191,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679241589,"env":"test","module":"user-credentials-repository","userId":"15c47228-b7cc-4b24-b547-7fcb95b8e8a9","msg":"User credentials created"}
{"level":30,"time":1768679241703,"env":"test","module":"email-queue","jobId":"ffbe3161-e1ed-4f4f-bbd0-367000beedb6","to":"protected-test-S_WoQG6PxNjWlKw-z3Z2Y@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679241762,"env":"test","module":"auth-routes","userId":"15c47228-b7cc-4b24-b547-7fcb95b8e8a9","email":"protected-test-S_WoQG6PxNjWlKw-z3Z2Y@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679242479,"env":"test","module":"auth-routes","userId":"15c47228-b7cc-4b24-b547-7fcb95b8e8a9","msg":"User logged in successfully"}
{"level":30,"time":1768679242535,"env":"test","module":"audit-log-service","userId":"15c47228-b7cc-4b24-b547-7fcb95b8e8a9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679242541,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679242946,"env":"test","module":"user-credentials-repository","userId":"4b3bde99-3aac-4b7b-bcbd-236b7a2fb96f","msg":"User credentials created"}
{"level":30,"time":1768679243058,"env":"test","module":"email-queue","jobId":"b38f3217-9536-4962-ab7a-37133c6b2f97","to":"protected-test-pJGFWTSPaNi9aIpTefTyp@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679243114,"env":"test","module":"auth-routes","userId":"4b3bde99-3aac-4b7b-bcbd-236b7a2fb96f","email":"protected-test-pJGFWTSPaNi9aIpTefTyp@example.com","msg":"User registered"}
{"level":30,"time":1768679243815,"env":"test","module":"auth-routes","userId":"4b3bde99-3aac-4b7b-bcbd-236b7a2fb96f","msg":"User logged in successfully"}
{"level":30,"time":1768679243871,"env":"test","module":"audit-log-service","userId":"4b3bde99-3aac-4b7b-bcbd-236b7a2fb96f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[DEBUG] BaseRepository.update users: id=4b3bde99-3aac-4b7b-bcbd-236b7a2fb96f, updates={"defaultMode":"advanced","updatedAt":"2026-01-17T19:47:23.989Z"}
{"level":30,"time":1768679244451,"env":"test","module":"user-credentials-repository","userId":"e178fe52-5b31-4f7f-aafe-bbd890482f53","msg":"User credentials created"}
{"level":30,"time":1768679244570,"env":"test","module":"email-queue","jobId":"41ba64f3-9ce4-4d05-93d2-208b38df79b3","to":"protected-test-60O1D8yIyyKSEDSe7AmBC@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679244632,"env":"test","module":"auth-routes","userId":"e178fe52-5b31-4f7f-aafe-bbd890482f53","email":"protected-test-60O1D8yIyyKSEDSe7AmBC@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679245324,"env":"test","module":"auth-routes","userId":"e178fe52-5b31-4f7f-aafe-bbd890482f53","msg":"User logged in successfully"}
{"level":30,"time":1768679245378,"env":"test","module":"audit-log-service","userId":"e178fe52-5b31-4f7f-aafe-bbd890482f53","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679245384,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679245790,"env":"test","module":"user-credentials-repository","userId":"5a399e66-bf9d-477c-8a17-285a08591972","msg":"User credentials created"}
{"level":30,"time":1768679245901,"env":"test","module":"email-queue","jobId":"61acad60-ca4f-44c7-95fd-62b1c5cc6190","to":"protected-test-DaBPXuxcBDUxgvko9pwnG@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679245962,"env":"test","module":"auth-routes","userId":"5a399e66-bf9d-477c-8a17-285a08591972","email":"protected-test-DaBPXuxcBDUxgvko9pwnG@example.com","msg":"User registered"}
{"level":30,"time":1768679246652,"env":"test","module":"auth-routes","userId":"5a399e66-bf9d-477c-8a17-285a08591972","msg":"User logged in successfully"}
{"level":30,"time":1768679246711,"env":"test","module":"audit-log-service","userId":"5a399e66-bf9d-477c-8a17-285a08591972","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679247314,"env":"test","module":"user-credentials-repository","userId":"9580ea79-44f0-46d9-a8ae-ccbae06fcdd2","msg":"User credentials created"}
{"level":30,"time":1768679247429,"env":"test","module":"email-queue","jobId":"b6eb9f96-75f3-49a4-92b0-3d586c388113","to":"protected-test-EbTRh8rDfLH8OO6T7X1vH@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679247485,"env":"test","module":"auth-routes","userId":"9580ea79-44f0-46d9-a8ae-ccbae06fcdd2","email":"protected-test-EbTRh8rDfLH8OO6T7X1vH@example.com","msg":"User registered"}
{"level":30,"time":1768679248179,"env":"test","module":"auth-routes","userId":"9580ea79-44f0-46d9-a8ae-ccbae06fcdd2","msg":"User logged in successfully"}
{"level":30,"time":1768679248239,"env":"test","module":"audit-log-service","userId":"9580ea79-44f0-46d9-a8ae-ccbae06fcdd2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679248243,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679248643,"env":"test","module":"user-credentials-repository","userId":"150f42d9-4cbb-4a18-90e9-23cc9fb2a6e6","msg":"User credentials created"}
{"level":30,"time":1768679248761,"env":"test","module":"email-queue","jobId":"d39218a1-93b5-49f6-b915-fec285d7475c","to":"protected-test-s_3VZYXZIQnzmWOGvEXr1@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679248822,"env":"test","module":"auth-routes","userId":"150f42d9-4cbb-4a18-90e9-23cc9fb2a6e6","email":"protected-test-s_3VZYXZIQnzmWOGvEXr1@example.com","msg":"User registered"}
{"level":30,"time":1768679249498,"env":"test","module":"auth-routes","userId":"150f42d9-4cbb-4a18-90e9-23cc9fb2a6e6","msg":"User logged in successfully"}
{"level":30,"time":1768679249556,"env":"test","module":"audit-log-service","userId":"150f42d9-4cbb-4a18-90e9-23cc9fb2a6e6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679250755,"env":"test","module":"user-credentials-repository","userId":"09d72345-e13b-4362-b60a-2c755455a6f9","msg":"User credentials created"}
{"level":30,"time":1768679250871,"env":"test","module":"email-queue","jobId":"b071763b-54e4-4801-95f5-2512bb6f2a5c","to":"protected-test-BepI3bGZuO6qpaiBERF1c@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679250926,"env":"test","module":"auth-routes","userId":"09d72345-e13b-4362-b60a-2c755455a6f9","email":"protected-test-BepI3bGZuO6qpaiBERF1c@example.com","msg":"User registered"}
{"level":30,"time":1768679251626,"env":"test","module":"auth-routes","userId":"09d72345-e13b-4362-b60a-2c755455a6f9","msg":"User logged in successfully"}
{"level":30,"time":1768679251683,"env":"test","module":"audit-log-service","userId":"09d72345-e13b-4362-b60a-2c755455a6f9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679251688,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679252118,"env":"test","module":"user-credentials-repository","userId":"09eaf354-77b0-4fda-9961-69b7b2594411","msg":"User credentials created"}
{"level":30,"time":1768679252229,"env":"test","module":"email-queue","jobId":"3bbfb15f-15d5-4273-823c-a214a640c36c","to":"protected-test-TqMDl_mlVVcFoACBbOKhR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679252283,"env":"test","module":"auth-routes","userId":"09eaf354-77b0-4fda-9961-69b7b2594411","email":"protected-test-TqMDl_mlVVcFoACBbOKhR@example.com","msg":"User registered"}
{"level":30,"time":1768679252994,"env":"test","module":"auth-routes","userId":"09eaf354-77b0-4fda-9961-69b7b2594411","msg":"User logged in successfully"}
{"level":30,"time":1768679253050,"env":"test","module":"audit-log-service","userId":"09eaf354-77b0-4fda-9961-69b7b2594411","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768679253053,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768679253053,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679253465,"env":"test","module":"user-credentials-repository","userId":"1e3da547-0559-40e6-9415-9e61ba0e0d22","msg":"User credentials created"}
{"level":30,"time":1768679253578,"env":"test","module":"email-queue","jobId":"2bb40a87-7a90-4a00-a3e9-b1b94515d783","to":"protected-test-ekxnI-xzCRhqdghUy5aIU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679253633,"env":"test","module":"auth-routes","userId":"1e3da547-0559-40e6-9415-9e61ba0e0d22","email":"protected-test-ekxnI-xzCRhqdghUy5aIU@example.com","msg":"User registered"}
{"level":30,"time":1768679254330,"env":"test","module":"auth-routes","userId":"1e3da547-0559-40e6-9415-9e61ba0e0d22","msg":"User logged in successfully"}
{"level":30,"time":1768679254392,"env":"test","module":"audit-log-service","userId":"1e3da547-0559-40e6-9415-9e61ba0e0d22","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679254396,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679254803,"env":"test","module":"user-credentials-repository","userId":"24a52f21-51a9-4959-80d6-6408a555c4f6","msg":"User credentials created"}
{"level":30,"time":1768679254917,"env":"test","module":"email-queue","jobId":"2ce21724-4cd5-45a6-90fd-d6dbdabcd9a0","to":"protected-test-utbGowcgeb2mNIqeJAthr@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679254977,"env":"test","module":"auth-routes","userId":"24a52f21-51a9-4959-80d6-6408a555c4f6","email":"protected-test-utbGowcgeb2mNIqeJAthr@example.com","msg":"User registered"}
{"level":30,"time":1768679255663,"env":"test","module":"auth-routes","userId":"24a52f21-51a9-4959-80d6-6408a555c4f6","msg":"User logged in successfully"}
{"level":30,"time":1768679255720,"env":"test","module":"audit-log-service","userId":"24a52f21-51a9-4959-80d6-6408a555c4f6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679255723,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679256130,"env":"test","module":"user-credentials-repository","userId":"eb22f54d-36d3-402f-a16f-db4a8807191f","msg":"User credentials created"}
{"level":30,"time":1768679256248,"env":"test","module":"email-queue","jobId":"762c693c-d8a3-471c-a993-849265498142","to":"protected-test-tiWOY7orTaWW8Peankhap@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679256309,"env":"test","module":"auth-routes","userId":"eb22f54d-36d3-402f-a16f-db4a8807191f","email":"protected-test-tiWOY7orTaWW8Peankhap@example.com","msg":"User registered"}
{"level":30,"time":1768679256984,"env":"test","module":"auth-routes","userId":"eb22f54d-36d3-402f-a16f-db4a8807191f","msg":"User logged in successfully"}
{"level":30,"time":1768679257039,"env":"test","module":"audit-log-service","userId":"eb22f54d-36d3-402f-a16f-db4a8807191f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679257043,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679257437,"env":"test","module":"user-credentials-repository","userId":"b3f333a8-e8d7-4fd2-a05f-3b9d9f9680c6","msg":"User credentials created"}
{"level":30,"time":1768679257552,"env":"test","module":"email-queue","jobId":"1c0e588c-5400-4334-a6c7-1fb330c94337","to":"protected-test-iwsDRy5DsRgh3yaat6BfI@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679257609,"env":"test","module":"auth-routes","userId":"b3f333a8-e8d7-4fd2-a05f-3b9d9f9680c6","email":"protected-test-iwsDRy5DsRgh3yaat6BfI@example.com","msg":"User registered"}
{"level":30,"time":1768679258308,"env":"test","module":"auth-routes","userId":"b3f333a8-e8d7-4fd2-a05f-3b9d9f9680c6","msg":"User logged in successfully"}
{"level":30,"time":1768679258368,"env":"test","module":"audit-log-service","userId":"b3f333a8-e8d7-4fd2-a05f-3b9d9f9680c6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679258371,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679258774,"env":"test","module":"user-credentials-repository","userId":"14110944-c492-496d-a97a-0aa25f0d0ee8","msg":"User credentials created"}
{"level":30,"time":1768679258893,"env":"test","module":"email-queue","jobId":"30c726cb-a710-4f0d-9749-2962843b2a39","to":"protected-test-zVPJ4mkzf2g6NhdtY_Tgj@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679258951,"env":"test","module":"auth-routes","userId":"14110944-c492-496d-a97a-0aa25f0d0ee8","email":"protected-test-zVPJ4mkzf2g6NhdtY_Tgj@example.com","msg":"User registered"}
{"level":30,"time":1768679259653,"env":"test","module":"auth-routes","userId":"14110944-c492-496d-a97a-0aa25f0d0ee8","msg":"User logged in successfully"}
{"level":30,"time":1768679259712,"env":"test","module":"audit-log-service","userId":"14110944-c492-496d-a97a-0aa25f0d0ee8","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679259718,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679260131,"env":"test","module":"user-credentials-repository","userId":"3bfc1c53-f868-4694-a20e-a246b86df142","msg":"User credentials created"}
{"level":30,"time":1768679260243,"env":"test","module":"email-queue","jobId":"68ce2109-569e-4078-a245-360812c8213c","to":"protected-test-k5lQn1dLq-g3xtCnkweJc@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679260302,"env":"test","module":"auth-routes","userId":"3bfc1c53-f868-4694-a20e-a246b86df142","email":"protected-test-k5lQn1dLq-g3xtCnkweJc@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679260995,"env":"test","module":"auth-routes","userId":"3bfc1c53-f868-4694-a20e-a246b86df142","msg":"User logged in successfully"}
{"level":30,"time":1768679261051,"env":"test","module":"audit-log-service","userId":"3bfc1c53-f868-4694-a20e-a246b86df142","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679261055,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768679261455,"env":"test","module":"user-credentials-repository","userId":"87ad7784-df8f-40b6-b2ab-feddc0664384","msg":"User credentials created"}
{"level":30,"time":1768679261568,"env":"test","module":"email-queue","jobId":"6eb44ab4-ced0-4253-a01e-d6899007ed74","to":"protected-test-6QXClgo4lTFTbUnt55l7C@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679261629,"env":"test","module":"auth-routes","userId":"87ad7784-df8f-40b6-b2ab-feddc0664384","email":"protected-test-6QXClgo4lTFTbUnt55l7C@example.com","msg":"User registered"}
{"level":30,"time":1768679262308,"env":"test","module":"auth-routes","userId":"87ad7784-df8f-40b6-b2ab-feddc0664384","msg":"User logged in successfully"}
{"level":30,"time":1768679262368,"env":"test","module":"audit-log-service","userId":"87ad7784-df8f-40b6-b2ab-feddc0664384","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679262776,"env":"test","module":"user-credentials-repository","userId":"876bda0d-313d-44a4-830c-19d8bd5e291d","msg":"User credentials created"}
{"level":30,"time":1768679262891,"env":"test","module":"email-queue","jobId":"3c465c4b-bb75-478f-a425-c3fea16f7e2d","to":"protected-test-SwUIuDqBU9p7MwzflZ-Ht@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679262945,"env":"test","module":"auth-routes","userId":"876bda0d-313d-44a4-830c-19d8bd5e291d","email":"protected-test-SwUIuDqBU9p7MwzflZ-Ht@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679263619,"env":"test","module":"auth-routes","userId":"876bda0d-313d-44a4-830c-19d8bd5e291d","msg":"User logged in successfully"}
{"level":30,"time":1768679263674,"env":"test","module":"audit-log-service","userId":"876bda0d-313d-44a4-830c-19d8bd5e291d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679264200,"env":"test","module":"user-credentials-repository","userId":"df74befd-3ef4-4a9a-8cb5-2f770f3b6668","msg":"User credentials created"}
{"level":30,"time":1768679264312,"env":"test","module":"email-queue","jobId":"e3c0dd2e-e34f-4afd-85f9-66ef214985b3","to":"protected-test-SAjfk5EavXO2SXL2k5w3q@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679264367,"env":"test","module":"auth-routes","userId":"df74befd-3ef4-4a9a-8cb5-2f770f3b6668","email":"protected-test-SAjfk5EavXO2SXL2k5w3q@example.com","msg":"User registered"}
{"level":30,"time":1768679265042,"env":"test","module":"auth-routes","userId":"df74befd-3ef4-4a9a-8cb5-2f770f3b6668","msg":"User logged in successfully"}
{"level":30,"time":1768679265101,"env":"test","module":"audit-log-service","userId":"df74befd-3ef4-4a9a-8cb5-2f770f3b6668","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679265505,"env":"test","module":"user-credentials-repository","userId":"99a1209e-4952-4d8f-8c1a-9d7e8c874441","msg":"User credentials created"}
{"level":30,"time":1768679265622,"env":"test","module":"email-queue","jobId":"12abed7c-0e19-461d-b97d-d68882f2b2c3","to":"user2-kCmiZqijeP4I0xpe-PFEt@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679265676,"env":"test","module":"auth-routes","userId":"99a1209e-4952-4d8f-8c1a-9d7e8c874441","email":"user2-kCmiZqijeP4I0xpe-PFEt@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679266306,"env":"test","module":"auth-routes","userId":"99a1209e-4952-4d8f-8c1a-9d7e8c874441","msg":"User logged in successfully"}
{"level":30,"time":1768679266365,"env":"test","module":"audit-log-service","userId":"99a1209e-4952-4d8f-8c1a-9d7e8c874441","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768679266426,"env":"test","module":"rbac-middleware","userId":"99a1209e-4952-4d8f-8c1a-9d7e8c874441","userRole":"viewer","permission":"project:delete","path":"/fba4f36e-7108-49ac-8d27-2cd9cb63139c","msg":"Permission denied"}
{"level":30,"time":1768679266829,"env":"test","module":"user-credentials-repository","userId":"0da6e2bb-fcf1-413b-9cd4-096045ca964c","msg":"User credentials created"}
{"level":30,"time":1768679266941,"env":"test","module":"email-queue","jobId":"e99d2335-3e70-4575-ac15-c490e14832a1","to":"protected-test-6ZAi41-woXda92sQT0GWR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679267002,"env":"test","module":"auth-routes","userId":"0da6e2bb-fcf1-413b-9cd4-096045ca964c","email":"protected-test-6ZAi41-woXda92sQT0GWR@example.com","msg":"User registered"}
{"level":30,"time":1768679267686,"env":"test","module":"auth-routes","userId":"0da6e2bb-fcf1-413b-9cd4-096045ca964c","msg":"User logged in successfully"}
{"level":30,"time":1768679267745,"env":"test","module":"audit-log-service","userId":"0da6e2bb-fcf1-413b-9cd4-096045ca964c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679268222,"env":"test","module":"user-credentials-repository","userId":"55aba584-24a1-47bb-afba-ca2ce9f638cf","msg":"User credentials created"}
{"level":30,"time":1768679268334,"env":"test","module":"email-queue","jobId":"f79f8e55-d4e1-4604-870f-176aa04ef88a","to":"protected-test-h7b5MeJ62hp6CiKj9Ik6h@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679268393,"env":"test","module":"auth-routes","userId":"55aba584-24a1-47bb-afba-ca2ce9f638cf","email":"protected-test-h7b5MeJ62hp6CiKj9Ik6h@example.com","msg":"User registered"}
{"level":30,"time":1768679269082,"env":"test","module":"auth-routes","userId":"55aba584-24a1-47bb-afba-ca2ce9f638cf","msg":"User logged in successfully"}
{"level":30,"time":1768679269141,"env":"test","module":"audit-log-service","userId":"55aba584-24a1-47bb-afba-ca2ce9f638cf","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679269619,"env":"test","module":"user-credentials-repository","userId":"b168a331-0f9c-418a-aa7e-8d764b8b20c2","msg":"User credentials created"}
{"level":30,"time":1768679269728,"env":"test","module":"email-queue","jobId":"e94663d9-c5fb-4f03-abdf-298d565b88ac","to":"protected-test-BGTLjMDnJYvnIpDjEvCli@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679269783,"env":"test","module":"auth-routes","userId":"b168a331-0f9c-418a-aa7e-8d764b8b20c2","email":"protected-test-BGTLjMDnJYvnIpDjEvCli@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679270500,"env":"test","module":"auth-routes","userId":"b168a331-0f9c-418a-aa7e-8d764b8b20c2","msg":"User logged in successfully"}
{"level":30,"time":1768679270556,"env":"test","module":"audit-log-service","userId":"b168a331-0f9c-418a-aa7e-8d764b8b20c2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679271032,"env":"test","module":"user-credentials-repository","userId":"67e72c4c-6a26-4dd8-ad9a-c59c7591e4b7","msg":"User credentials created"}
{"level":30,"time":1768679271143,"env":"test","module":"email-queue","jobId":"0285a8f9-a9dd-4eee-be42-5308819d7d53","to":"protected-test-FKPlBtRoLB8lXOsDNNOB4@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679271206,"env":"test","module":"auth-routes","userId":"67e72c4c-6a26-4dd8-ad9a-c59c7591e4b7","email":"protected-test-FKPlBtRoLB8lXOsDNNOB4@example.com","msg":"User registered"}
{"level":30,"time":1768679272052,"env":"test","module":"auth-routes","userId":"67e72c4c-6a26-4dd8-ad9a-c59c7591e4b7","msg":"User logged in successfully"}
{"level":30,"time":1768679272116,"env":"test","module":"audit-log-service","userId":"67e72c4c-6a26-4dd8-ad9a-c59c7591e4b7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679273220,"env":"test","module":"user-credentials-repository","userId":"46db1c39-2518-4820-8a19-5973063c6134","msg":"User credentials created"}
{"level":30,"time":1768679273342,"env":"test","module":"email-queue","jobId":"ec11c510-e8ff-4b96-a424-88bae1174285","to":"protected-test-QgNf05-SgYpklxAMzOeO6@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679273409,"env":"test","module":"auth-routes","userId":"46db1c39-2518-4820-8a19-5973063c6134","email":"protected-test-QgNf05-SgYpklxAMzOeO6@example.com","msg":"User registered"}
{"level":30,"time":1768679274194,"env":"test","module":"auth-routes","userId":"46db1c39-2518-4820-8a19-5973063c6134","msg":"User logged in successfully"}
{"level":30,"time":1768679274252,"env":"test","module":"audit-log-service","userId":"46db1c39-2518-4820-8a19-5973063c6134","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679274882,"env":"test","module":"auth-routes","userId":"46db1c39-2518-4820-8a19-5973063c6134","msg":"User logged in successfully"}
{"level":30,"time":1768679274938,"env":"test","module":"audit-log-service","userId":"46db1c39-2518-4820-8a19-5973063c6134","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679275433,"env":"test","module":"user-credentials-repository","userId":"e6c4684d-ac3c-4ad1-8ee3-9768c523f98a","msg":"User credentials created"}
{"level":30,"time":1768679275549,"env":"test","module":"email-queue","jobId":"1cd3e754-e22d-4b0f-b6f5-afcdc3db9b8f","to":"protected-test-ErMG8sqEcVTf-3-yJM-8J@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679275608,"env":"test","module":"auth-routes","userId":"e6c4684d-ac3c-4ad1-8ee3-9768c523f98a","email":"protected-test-ErMG8sqEcVTf-3-yJM-8J@example.com","msg":"User registered"}
{"level":30,"time":1768679276423,"env":"test","module":"auth-routes","userId":"e6c4684d-ac3c-4ad1-8ee3-9768c523f98a","msg":"User logged in successfully"}
{"level":30,"time":1768679276483,"env":"test","module":"audit-log-service","userId":"e6c4684d-ac3c-4ad1-8ee3-9768c523f98a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768679277107,"env":"test","module":"auth-routes","userId":"e6c4684d-ac3c-4ad1-8ee3-9768c523f98a","msg":"User logged in successfully"}
{"level":30,"time":1768679277166,"env":"test","module":"audit-log-service","userId":"e6c4684d-ac3c-4ad1-8ee3-9768c523f98a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768679277622,"env":"test","module":"user-credentials-repository","userId":"49b37fe6-16ed-45fc-9ad2-eec65f211e91","msg":"User credentials created"}
{"level":30,"time":1768679277747,"env":"test","module":"email-queue","jobId":"4424cc96-d45a-4b6e-8190-f5ecbdc5064b","to":"user2-C5dxNzz0Yy434GN_Qtgjo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679277807,"env":"test","module":"auth-routes","userId":"49b37fe6-16ed-45fc-9ad2-eec65f211e91","email":"user2-C5dxNzz0Yy434GN_Qtgjo@example.com","msg":"User registered"}
{"level":30,"time":1768679278468,"env":"test","module":"auth-routes","userId":"49b37fe6-16ed-45fc-9ad2-eec65f211e91","msg":"User logged in successfully"}
{"level":30,"time":1768679278528,"env":"test","module":"audit-log-service","userId":"49b37fe6-16ed-45fc-9ad2-eec65f211e91","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768679279169,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["24d4cf0b-d408-4fb7-b81b-6fd6e253f76f","$2b$12$GzkrDpweLAZ9c7J9Rb41WeHK45M59YT6ssqT3ENTbgtth/likAOTK"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(24d4cf0b-d408-4fb7-b81b-6fd6e253f76f) is not present in table \"users\".","schema":"test_schema_w14_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"24d4cf0b-d408-4fb7-b81b-6fd6e253f76f","msg":"Failed to create user credentials"}
{"level":50,"time":1768679279169,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["24d4cf0b-d408-4fb7-b81b-6fd6e253f76f","$2b$12$GzkrDpweLAZ9c7J9Rb41WeHK45M59YT6ssqT3ENTbgtth/likAOTK"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(24d4cf0b-d408-4fb7-b81b-6fd6e253f76f) is not present in table \"users\".","schema":"test_schema_w14_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768679279609,"env":"test","module":"user-credentials-repository","userId":"c58ad410-7f23-47e0-a827-305bb16f7156","msg":"User credentials created"}
{"level":30,"time":1768679279837,"env":"test","module":"email-queue","jobId":"b4c9b42b-91bf-43e7-a9ac-443363ff27e5","to":"protected-test-PvEEq3ENS_llamNbxgUW9@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768679280007,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["c58ad410-7f23-47e0-a827-305bb16f7156","00948dd6bf435b1738e3f0c85579f838881d18b2982fa6c31204793aaf2edd19","2026-02-16T19:47:59.838Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T19:47:59.838Z"],"cause":{"length":339,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c58ad410-7f23-47e0-a827-305bb16f7156) is not present in table \"users\".","schema":"test_schema_w14_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768679280128,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768679280129,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 2 failed | 1 skipped) 56878ms
       Γ£ô should allow access with valid Bearer token  1436ms
       Γ£ô should reject access without Authorization header  1378ms
       Γ£ô should reject access with empty Bearer token  1495ms
       Γ£ô should reject access with malformed Authorization header  1323ms
       Γ£ô should reject access with wrong token type  1349ms
       Γ£ô should allow POST with valid Bearer token  1403ms
       Γ£ô should reject POST without Bearer token  1308ms
       Γ£ô should reject POST with invalid token  1350ms
       Γ£ô should allow PUT with valid Bearer token  1509ms
       Γ£ô should reject PUT without Bearer token  1334ms
       Γ£ô should allow DELETE with valid Bearer token  1514ms
       Γ£ô should reject DELETE without Bearer token  1344ms
       Γ£ô should allow PATCH with valid Bearer token  2080ms
       Γ£ô should reject PATCH without Bearer token  1366ms
       Γ£ô should handle Bearer token with extra spaces  1365ms
       Γåô should handle token with newlines
       Γ£ô should handle very long invalid token  1343ms
       Γ£ô should handle empty Authorization header  1327ms
       Γ£ô should handle Authorization header with only Bearer  1320ms
       Γ£ô should handle multiple Authorization headers  1329ms
       Γ£ô should reject token with SQL injection attempt  1346ms
       Γ£ô should reject token with XSS attempt  1336ms
       Γ£ô should reject token with missing userId  1319ms
       Γ£ô should reject token with non-existent userId  1415ms
       Γ£ô should not allow user to access another user's resources  2638ms
       Γ£ô should inject userId into request context  1379ms
       Γ£ô should inject tenantId into request context  1400ms
       Γ£ô should inject role into request context  1410ms
       Γ£ô should not apply general rate limiting to authenticated requests  2077ms
       Γ£ô should handle request with both Bearer token and cookies  2307ms
       Γ£ô should prioritize Bearer token over cookie when both present  3657ms
       ├ù should allow unauthenticated access to optional auth routes 513ms
       ├ù should enhance optional auth routes with user context when authenticated 838ms

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Tests 2 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Error: expected 201 "Created", got 500 "Internal Server Error"
 Γ¥» tests/integration/auth/protected.routes.test.ts:56:14
 Γ¥» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Γ¥» node_modules/supertest/lib/test.js:365:13
 Γ¥» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Γ¥» Test.assert node_modules/supertest/lib/test.js:195:23
 Γ¥» localAssert node_modules/supertest/lib/test.js:138:14
 Γ¥» node_modules/supertest/lib/test.js:156:7
 Γ¥» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Γ¥» node_modules/superagent/lib/node/index.js:1102:18
 Γ¥» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  2 failed | 30 passed | 1 skipped (33)
   Start at  13:46:49
   Duration  70.04s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x12 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768679333690,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

{"level":30,"time":1768679342218,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768679342219,"env":"test","msg":"DB: Using test schema \"test_schema_w0_v3\" (from connection string options)"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768679343889,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

{"level":30,"time":1768679345435,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768679345454,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768679345443,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768679345444,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768679345449,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768679345449,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768679345453,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768679345453,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768679345453,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768679345453,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768679345969,"env":"test","module":"user-credentials-repository","userId":"c52bba64-25b2-457e-b584-771a612bb0c8","msg":"User credentials created"}
{"level":30,"time":1768679346185,"env":"test","module":"email-queue","jobId":"046c949d-d082-416f-a580-c1163812cabd","to":"test-4o-rj9OuFdAnuRB9oMeQw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768679346367,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["c52bba64-25b2-457e-b584-771a612bb0c8","8ed8dfd4bc8d07c6ae908954522076f25106070081d09c8cd62eb452be269852","2026-02-16T19:49:06.190Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T19:49:06.190Z"],"cause":{"length":339,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c52bba64-25b2-457e-b584-771a612bb0c8) is not present in table \"users\".","schema":"test_schema_w72_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768679346384,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768679346384,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w66_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Dropping existing function: test_schema_w66_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 5165ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:48:21
   Duration  38.78s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x13 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768679567093,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768679575405,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768679575405,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w0_v3\",public on all connections"}
{"level":30,"time":1768679580851,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768679874476,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 600007ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
Error: Hook timed out in 300000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Γ¥» tests/setup.ts:114:1
    112| 
    113| // Global test hooks
    114| beforeAll(async () => {
       | ^
    115|   // Conditionally load jest-dom for UI tests (JSDOM environment)
    116|   if (typeof window !== 'undefined') {

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
Error: Hook timed out in 300000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Γ¥» tests/setup.ts:334:1
    332| });
    333| 
    334| afterAll(async () => {
       | ^
    335|   // Cleanup test database
    336|   console.log("≡ƒº╣ Cleaning up test environment...");

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:52:35
   Duration  615.27s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/helpers/schemaManager.ts x14 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768680389797,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768680394622,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768680394623,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w0_v3\",public on all connections"}
{"level":30,"time":1768680394674,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768680693573,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 600019ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
Error: Hook timed out in 300000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Γ¥» tests/setup.ts:114:1
    112| 
    113| // Global test hooks
    114| beforeAll(async () => {
       | ^
    115|   // Conditionally load jest-dom for UI tests (JSDOM environment)
    116|   if (typeof window !== 'undefined') {

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
Error: Hook timed out in 300000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Γ¥» tests/setup.ts:334:1
    332| });
    333| 
    334| afterAll(async () => {
       | ^
    335|   // Cleanup test database
    336|   console.log("≡ƒº╣ Cleaning up test environment...");

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:06:21
   Duration  611.74s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x15 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681266868,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681274614,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681274615,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w0_v3\",public on all connections"}
{"level":30,"time":1768681274736,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: []

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

{"level":30,"time":1768681276255,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681276275,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768681276264,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681276265,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681276269,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681276270,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681276275,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681276275,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681276275,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681276275,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768681276887,"env":"test","module":"user-credentials-repository","userId":"14479be4-6916-4828-9625-bbc61967c07d","msg":"User credentials created"}
{"level":30,"time":1768681276991,"env":"test","module":"email-queue","jobId":"9ed16420-51c0-41f7-b631-67aa93c44c94","to":"test-7dF8jJNjSQ13LFID2q4Uv@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681277046,"env":"test","module":"auth-routes","userId":"14479be4-6916-4828-9625-bbc61967c07d","email":"test-7dF8jJNjSQ13LFID2q4Uv@example.com","msg":"User registered"}
{"level":30,"time":1768681277766,"env":"test","module":"user-credentials-repository","userId":"cc16b43b-0610-4327-b090-8361597f4494","msg":"User credentials created"}
{"level":30,"time":1768681277875,"env":"test","module":"email-queue","jobId":"874ad042-b163-4fbf-b058-f982b000d752","to":"protected-test-25016kTOuFXeVWil0y3aj@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681277925,"env":"test","module":"auth-routes","userId":"cc16b43b-0610-4327-b090-8361597f4494","email":"protected-test-25016kTOuFXeVWil0y3aj@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681278582,"env":"test","module":"auth-routes","userId":"cc16b43b-0610-4327-b090-8361597f4494","msg":"User logged in successfully"}
{"level":30,"time":1768681278630,"env":"test","module":"audit-log-service","userId":"cc16b43b-0610-4327-b090-8361597f4494","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681279123,"env":"test","module":"user-credentials-repository","userId":"dd3083f8-039a-44d4-8357-cae1f089f4d5","msg":"User credentials created"}
{"level":30,"time":1768681279220,"env":"test","module":"email-queue","jobId":"bdc0b4aa-2449-483c-9a87-a85a0af1a62a","to":"protected-test-iIug68sOGVnzlBJrAwc_j@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768681279282,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["dd3083f8-039a-44d4-8357-cae1f089f4d5","1076d58ff2d4f70c88d40f73afd5c63a4e65b418d8ba241cdb3b59c144711a38","2026-02-16T20:21:19.220Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T20:21:19.220Z"],"cause":{"length":327,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(dd3083f8-039a-44d4-8357-cae1f089f4d5) is not present in table \"users\".","schema":"public","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768681280164,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["f9d66b82-2fa5-4687-91e3-f2e7cbce002c","$2b$12$iV9Cenrrtu11x/jk6X.O4uQ3EliRODEKdhmXyWe6Val0kv0osUXWe"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f9d66b82-2fa5-4687-91e3-f2e7cbce002c) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"f9d66b82-2fa5-4687-91e3-f2e7cbce002c","msg":"Failed to create user credentials"}
{"level":50,"time":1768681280164,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["f9d66b82-2fa5-4687-91e3-f2e7cbce002c","$2b$12$iV9Cenrrtu11x/jk6X.O4uQ3EliRODEKdhmXyWe6Val0kv0osUXWe"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f9d66b82-2fa5-4687-91e3-f2e7cbce002c) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681280898,"env":"test","module":"user-credentials-repository","userId":"208565f1-3aba-4131-b704-0081326a8018","msg":"User credentials created"}
{"level":30,"time":1768681280991,"env":"test","module":"email-queue","jobId":"6008d055-3c46-4686-8a30-0b1665a307b8","to":"protected-test-JjT7b6LZmAB1iqOTtb6qX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681281036,"env":"test","module":"auth-routes","userId":"208565f1-3aba-4131-b704-0081326a8018","email":"protected-test-JjT7b6LZmAB1iqOTtb6qX@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681281708,"env":"test","module":"auth-routes","userId":"208565f1-3aba-4131-b704-0081326a8018","msg":"User logged in successfully"}
{"level":30,"time":1768681281759,"env":"test","module":"audit-log-service","userId":"208565f1-3aba-4131-b704-0081326a8018","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681281768,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681282213,"env":"test","module":"user-credentials-repository","userId":"4d0224c7-641b-4101-acc5-3af1a9bcf566","msg":"User credentials created"}
{"level":30,"time":1768681282299,"env":"test","module":"email-queue","jobId":"3a3563d7-1c1b-4da5-859e-5985cca796f6","to":"protected-test-s7ML-APC8fU1V7ndYIm7A@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681282352,"env":"test","module":"auth-routes","userId":"4d0224c7-641b-4101-acc5-3af1a9bcf566","email":"protected-test-s7ML-APC8fU1V7ndYIm7A@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681282982,"env":"test","module":"auth-routes","userId":"4d0224c7-641b-4101-acc5-3af1a9bcf566","msg":"User logged in successfully"}
{"level":30,"time":1768681283026,"env":"test","module":"audit-log-service","userId":"4d0224c7-641b-4101-acc5-3af1a9bcf566","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681283031,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768681283031,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681283444,"env":"test","module":"user-credentials-repository","userId":"3720be11-da80-45e7-86b4-3566ff8bbe5e","msg":"User credentials created"}
{"level":30,"time":1768681283541,"env":"test","module":"email-queue","jobId":"4b7ac3eb-51b1-43f0-b342-074b25358937","to":"protected-test-m_PzEr-axqZJiR0pMAc_2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681283585,"env":"test","module":"auth-routes","userId":"3720be11-da80-45e7-86b4-3566ff8bbe5e","email":"protected-test-m_PzEr-axqZJiR0pMAc_2@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681284201,"env":"test","module":"auth-routes","userId":"3720be11-da80-45e7-86b4-3566ff8bbe5e","msg":"User logged in successfully"}
{"level":30,"time":1768681284248,"env":"test","module":"audit-log-service","userId":"3720be11-da80-45e7-86b4-3566ff8bbe5e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681284712,"env":"test","module":"user-credentials-repository","userId":"c56fd15c-3e80-43e9-b75a-e65deaf02cd5","msg":"User credentials created"}
{"level":30,"time":1768681284801,"env":"test","module":"email-queue","jobId":"1df4123c-375f-437d-ad47-552e6ea3363a","to":"protected-test-I3U_0lh1XcIGXCCGPJ7yA@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681284846,"env":"test","module":"auth-routes","userId":"c56fd15c-3e80-43e9-b75a-e65deaf02cd5","email":"protected-test-I3U_0lh1XcIGXCCGPJ7yA@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681285475,"env":"test","module":"auth-routes","userId":"c56fd15c-3e80-43e9-b75a-e65deaf02cd5","msg":"User logged in successfully"}
{"level":30,"time":1768681285523,"env":"test","module":"audit-log-service","userId":"c56fd15c-3e80-43e9-b75a-e65deaf02cd5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681285529,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681285947,"env":"test","module":"user-credentials-repository","userId":"731ba0bb-0ea1-47e2-805d-04cb59d2e8f7","msg":"User credentials created"}
{"level":30,"time":1768681286037,"env":"test","module":"email-queue","jobId":"a2098572-5f49-4883-82f5-d2d0ff574765","to":"protected-test-9jHVnFtrEOzL33znOFM5C@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681286083,"env":"test","module":"auth-routes","userId":"731ba0bb-0ea1-47e2-805d-04cb59d2e8f7","email":"protected-test-9jHVnFtrEOzL33znOFM5C@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681286718,"env":"test","module":"auth-routes","userId":"731ba0bb-0ea1-47e2-805d-04cb59d2e8f7","msg":"User logged in successfully"}
{"level":30,"time":1768681286764,"env":"test","module":"audit-log-service","userId":"731ba0bb-0ea1-47e2-805d-04cb59d2e8f7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681286769,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681287238,"env":"test","module":"user-credentials-repository","userId":"804c6ea4-b7f1-40bb-9b05-9c42368ad0ce","msg":"User credentials created"}
{"level":30,"time":1768681287399,"env":"test","module":"email-queue","jobId":"1db6c200-704d-4579-974a-22980a718838","to":"protected-test-8m22fMOKb_ytOmAsIYxA9@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681287444,"env":"test","module":"auth-routes","userId":"804c6ea4-b7f1-40bb-9b05-9c42368ad0ce","email":"protected-test-8m22fMOKb_ytOmAsIYxA9@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681288120,"env":"test","module":"auth-routes","userId":"804c6ea4-b7f1-40bb-9b05-9c42368ad0ce","msg":"User logged in successfully"}
{"level":30,"time":1768681288165,"env":"test","module":"audit-log-service","userId":"804c6ea4-b7f1-40bb-9b05-9c42368ad0ce","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[DEBUG] BaseRepository.update users: id=804c6ea4-b7f1-40bb-9b05-9c42368ad0ce, updates={"defaultMode":"advanced","updatedAt":"2026-01-17T20:21:28.260Z"}
{"level":30,"time":1768681288709,"env":"test","module":"user-credentials-repository","userId":"3db4e4fd-55f9-42e7-b687-5a567ee55ea7","msg":"User credentials created"}
{"level":30,"time":1768681288826,"env":"test","module":"email-queue","jobId":"5814742f-848f-418d-a078-4f79b75ada2c","to":"protected-test-jY--eZ0f0ZHZsUv_zLZT0@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681288870,"env":"test","module":"auth-routes","userId":"3db4e4fd-55f9-42e7-b687-5a567ee55ea7","email":"protected-test-jY--eZ0f0ZHZsUv_zLZT0@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681289505,"env":"test","module":"auth-routes","userId":"3db4e4fd-55f9-42e7-b687-5a567ee55ea7","msg":"User logged in successfully"}
{"level":30,"time":1768681289551,"env":"test","module":"audit-log-service","userId":"3db4e4fd-55f9-42e7-b687-5a567ee55ea7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681289558,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681289962,"env":"test","module":"user-credentials-repository","userId":"6cf18fde-ef4c-4ab7-8c66-74c159251c12","msg":"User credentials created"}
{"level":30,"time":1768681290056,"env":"test","module":"email-queue","jobId":"9c7afdd8-8f5c-47aa-b86d-e3c6b4a81d05","to":"protected-test-5Oa8OGLZAjwRUvxorqMuz@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681290104,"env":"test","module":"auth-routes","userId":"6cf18fde-ef4c-4ab7-8c66-74c159251c12","email":"protected-test-5Oa8OGLZAjwRUvxorqMuz@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681290762,"env":"test","module":"auth-routes","userId":"6cf18fde-ef4c-4ab7-8c66-74c159251c12","msg":"User logged in successfully"}
{"level":30,"time":1768681290810,"env":"test","module":"audit-log-service","userId":"6cf18fde-ef4c-4ab7-8c66-74c159251c12","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681291406,"env":"test","module":"user-credentials-repository","userId":"42d32c47-ddf2-4839-944b-4728519b16e6","msg":"User credentials created"}
{"level":30,"time":1768681291504,"env":"test","module":"email-queue","jobId":"0aedbfb4-feaa-4a4b-b691-0d92c801d03d","to":"protected-test-zJ5UGRNW_K98CldqYebjq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681291556,"env":"test","module":"auth-routes","userId":"42d32c47-ddf2-4839-944b-4728519b16e6","email":"protected-test-zJ5UGRNW_K98CldqYebjq@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681292233,"env":"test","module":"auth-routes","userId":"42d32c47-ddf2-4839-944b-4728519b16e6","msg":"User logged in successfully"}
{"level":30,"time":1768681292282,"env":"test","module":"audit-log-service","userId":"42d32c47-ddf2-4839-944b-4728519b16e6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681292286,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681292727,"env":"test","module":"user-credentials-repository","userId":"f368602a-1bc2-4b72-a0d1-b4bd748ddfd5","msg":"User credentials created"}
{"level":30,"time":1768681292819,"env":"test","module":"email-queue","jobId":"afca1a8e-79a4-45da-ba3d-6f087792ab4a","to":"protected-test-XJKxNIX-s9RDlOObgm1oN@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681292867,"env":"test","module":"auth-routes","userId":"f368602a-1bc2-4b72-a0d1-b4bd748ddfd5","email":"protected-test-XJKxNIX-s9RDlOObgm1oN@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681293496,"env":"test","module":"auth-routes","userId":"f368602a-1bc2-4b72-a0d1-b4bd748ddfd5","msg":"User logged in successfully"}
{"level":30,"time":1768681293543,"env":"test","module":"audit-log-service","userId":"f368602a-1bc2-4b72-a0d1-b4bd748ddfd5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681294565,"env":"test","module":"user-credentials-repository","userId":"ef1fbcaa-7c2a-44d1-994e-3028a32538f0","msg":"User credentials created"}
{"level":30,"time":1768681294662,"env":"test","module":"email-queue","jobId":"cb76e1c7-b41a-4908-a59f-2ce69546f7d4","to":"protected-test-eIh1x4kQNJJy2V1mBDl3B@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681294710,"env":"test","module":"auth-routes","userId":"ef1fbcaa-7c2a-44d1-994e-3028a32538f0","email":"protected-test-eIh1x4kQNJJy2V1mBDl3B@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681295357,"env":"test","module":"auth-routes","userId":"ef1fbcaa-7c2a-44d1-994e-3028a32538f0","msg":"User logged in successfully"}
{"level":30,"time":1768681295401,"env":"test","module":"audit-log-service","userId":"ef1fbcaa-7c2a-44d1-994e-3028a32538f0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681295406,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681295823,"env":"test","module":"user-credentials-repository","userId":"537df0b9-6a6e-45cc-8635-72314642c845","msg":"User credentials created"}
{"level":30,"time":1768681295913,"env":"test","module":"email-queue","jobId":"8404be56-867f-4357-86b2-1d546527a2ce","to":"protected-test-0qLKHrUdZp1EC0Jt7kajQ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681295961,"env":"test","module":"auth-routes","userId":"537df0b9-6a6e-45cc-8635-72314642c845","email":"protected-test-0qLKHrUdZp1EC0Jt7kajQ@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681296646,"env":"test","module":"auth-routes","userId":"537df0b9-6a6e-45cc-8635-72314642c845","msg":"User logged in successfully"}
{"level":30,"time":1768681296691,"env":"test","module":"audit-log-service","userId":"537df0b9-6a6e-45cc-8635-72314642c845","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681296698,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768681296698,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681297093,"env":"test","module":"user-credentials-repository","userId":"7c0cf154-e89a-43b4-8a61-f87b2133f9cd","msg":"User credentials created"}
{"level":30,"time":1768681297189,"env":"test","module":"email-queue","jobId":"bda1a463-32af-4901-bf37-bc295aca29ea","to":"protected-test-9UMGE8_Et6lVZ2nftSe1D@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681297235,"env":"test","module":"auth-routes","userId":"7c0cf154-e89a-43b4-8a61-f87b2133f9cd","email":"protected-test-9UMGE8_Et6lVZ2nftSe1D@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681297884,"env":"test","module":"auth-routes","userId":"7c0cf154-e89a-43b4-8a61-f87b2133f9cd","msg":"User logged in successfully"}
{"level":30,"time":1768681297934,"env":"test","module":"audit-log-service","userId":"7c0cf154-e89a-43b4-8a61-f87b2133f9cd","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681297941,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681298410,"env":"test","module":"user-credentials-repository","userId":"454d520f-25e7-4d12-a66e-faf9bfa230ca","msg":"User credentials created"}
{"level":30,"time":1768681298501,"env":"test","module":"email-queue","jobId":"252b1e49-a125-45b7-a7fe-7567126025b5","to":"protected-test-M3rLOuFagLWcgVmnZeW7D@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681298546,"env":"test","module":"auth-routes","userId":"454d520f-25e7-4d12-a66e-faf9bfa230ca","email":"protected-test-M3rLOuFagLWcgVmnZeW7D@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681299175,"env":"test","module":"auth-routes","userId":"454d520f-25e7-4d12-a66e-faf9bfa230ca","msg":"User logged in successfully"}
{"level":30,"time":1768681299220,"env":"test","module":"audit-log-service","userId":"454d520f-25e7-4d12-a66e-faf9bfa230ca","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681299224,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681299610,"env":"test","module":"user-credentials-repository","userId":"3dd9fb9f-2227-4fe2-ad5b-e55a507fd212","msg":"User credentials created"}
{"level":30,"time":1768681299707,"env":"test","module":"email-queue","jobId":"f7c16fa1-c117-4a8a-a244-22f85ddd38ff","to":"protected-test-b5b0LaYQ6RUCg3TRMTEFO@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681299755,"env":"test","module":"auth-routes","userId":"3dd9fb9f-2227-4fe2-ad5b-e55a507fd212","email":"protected-test-b5b0LaYQ6RUCg3TRMTEFO@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681300373,"env":"test","module":"auth-routes","userId":"3dd9fb9f-2227-4fe2-ad5b-e55a507fd212","msg":"User logged in successfully"}
{"level":30,"time":1768681300422,"env":"test","module":"audit-log-service","userId":"3dd9fb9f-2227-4fe2-ad5b-e55a507fd212","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681300428,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681300855,"env":"test","module":"user-credentials-repository","userId":"ff5588e0-0d9a-4cda-91ff-ad02108fc167","msg":"User credentials created"}
{"level":30,"time":1768681300948,"env":"test","module":"email-queue","jobId":"6d245c40-641e-4b25-8a82-75161d3d5974","to":"protected-test-09pVQOI8Ago-jse0I3JlU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681300993,"env":"test","module":"auth-routes","userId":"ff5588e0-0d9a-4cda-91ff-ad02108fc167","email":"protected-test-09pVQOI8Ago-jse0I3JlU@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681301605,"env":"test","module":"auth-routes","userId":"ff5588e0-0d9a-4cda-91ff-ad02108fc167","msg":"User logged in successfully"}
{"level":30,"time":1768681301653,"env":"test","module":"audit-log-service","userId":"ff5588e0-0d9a-4cda-91ff-ad02108fc167","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681301657,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681302048,"env":"test","module":"user-credentials-repository","userId":"de1b80fc-1ce3-4bbf-beb9-38c198b2c5c6","msg":"User credentials created"}
{"level":30,"time":1768681302140,"env":"test","module":"email-queue","jobId":"6832ea12-22ef-426e-ac0f-1bad5b320091","to":"protected-test-eBVYATBlawTnTCbOjGAeb@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681302185,"env":"test","module":"auth-routes","userId":"de1b80fc-1ce3-4bbf-beb9-38c198b2c5c6","email":"protected-test-eBVYATBlawTnTCbOjGAeb@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681302824,"env":"test","module":"auth-routes","userId":"de1b80fc-1ce3-4bbf-beb9-38c198b2c5c6","msg":"User logged in successfully"}
{"level":30,"time":1768681302870,"env":"test","module":"audit-log-service","userId":"de1b80fc-1ce3-4bbf-beb9-38c198b2c5c6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681302874,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681303255,"env":"test","module":"user-credentials-repository","userId":"a7a1f163-5d52-43da-8c93-1fa2e4c51dd9","msg":"User credentials created"}
{"level":30,"time":1768681303353,"env":"test","module":"email-queue","jobId":"9f954dd6-f491-46db-a6c9-70c72563e606","to":"protected-test-GLt9UgRDSAhZavkcITgCd@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681303403,"env":"test","module":"auth-routes","userId":"a7a1f163-5d52-43da-8c93-1fa2e4c51dd9","email":"protected-test-GLt9UgRDSAhZavkcITgCd@example.com","msg":"User registered"}
{"level":30,"time":1768681303997,"env":"test","module":"auth-routes","userId":"a7a1f163-5d52-43da-8c93-1fa2e4c51dd9","msg":"User logged in successfully"}
{"level":30,"time":1768681304174,"env":"test","module":"audit-log-service","userId":"a7a1f163-5d52-43da-8c93-1fa2e4c51dd9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681304181,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681304565,"env":"test","module":"user-credentials-repository","userId":"020c00e2-4c73-4d73-a9c7-210c0c41d027","msg":"User credentials created"}
{"level":30,"time":1768681304661,"env":"test","module":"email-queue","jobId":"017b7159-37a0-4c3f-bf23-79d26fdcb215","to":"protected-test-bf-k0_gcqEinAg6fGkmrj@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681304717,"env":"test","module":"auth-routes","userId":"020c00e2-4c73-4d73-a9c7-210c0c41d027","email":"protected-test-bf-k0_gcqEinAg6fGkmrj@example.com","msg":"User registered"}
{"level":30,"time":1768681305313,"env":"test","module":"auth-routes","userId":"020c00e2-4c73-4d73-a9c7-210c0c41d027","msg":"User logged in successfully"}
{"level":30,"time":1768681305356,"env":"test","module":"audit-log-service","userId":"020c00e2-4c73-4d73-a9c7-210c0c41d027","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681305735,"env":"test","module":"user-credentials-repository","userId":"e01f2f7a-70fe-49c4-b694-cbdaaf053ffc","msg":"User credentials created"}
{"level":30,"time":1768681305823,"env":"test","module":"email-queue","jobId":"3b5d23b5-c6be-49c7-a363-aa396221a5c5","to":"protected-test-5HilodzgcvO9sZVp9V300@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681305872,"env":"test","module":"auth-routes","userId":"e01f2f7a-70fe-49c4-b694-cbdaaf053ffc","email":"protected-test-5HilodzgcvO9sZVp9V300@example.com","msg":"User registered"}
{"level":30,"time":1768681306494,"env":"test","module":"auth-routes","userId":"e01f2f7a-70fe-49c4-b694-cbdaaf053ffc","msg":"User logged in successfully"}
{"level":30,"time":1768681306539,"env":"test","module":"audit-log-service","userId":"e01f2f7a-70fe-49c4-b694-cbdaaf053ffc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681307010,"env":"test","module":"user-credentials-repository","userId":"27172259-b1b4-4fe6-9b82-376b1253186c","msg":"User credentials created"}
{"level":30,"time":1768681307105,"env":"test","module":"email-queue","jobId":"f629abbc-148d-45c5-9e03-1dec5facc6bf","to":"protected-test-bHAXkPBIutd7dg-zcQU1A@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681307155,"env":"test","module":"auth-routes","userId":"27172259-b1b4-4fe6-9b82-376b1253186c","email":"protected-test-bHAXkPBIutd7dg-zcQU1A@example.com","msg":"User registered"}
{"level":30,"time":1768681307748,"env":"test","module":"auth-routes","userId":"27172259-b1b4-4fe6-9b82-376b1253186c","msg":"User logged in successfully"}
{"level":30,"time":1768681307791,"env":"test","module":"audit-log-service","userId":"27172259-b1b4-4fe6-9b82-376b1253186c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681308152,"env":"test","module":"user-credentials-repository","userId":"244ec3c1-9eb1-4211-9311-400c7d3c3d71","msg":"User credentials created"}
{"level":30,"time":1768681308244,"env":"test","module":"email-queue","jobId":"3bef1da0-0ff7-4405-aae3-cb877b0a508e","to":"user2-ghi--MKxzepQnt_9yU3oz@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681308288,"env":"test","module":"auth-routes","userId":"244ec3c1-9eb1-4211-9311-400c7d3c3d71","email":"user2-ghi--MKxzepQnt_9yU3oz@example.com","msg":"User registered"}
{"level":30,"time":1768681308832,"env":"test","module":"auth-routes","userId":"244ec3c1-9eb1-4211-9311-400c7d3c3d71","msg":"User logged in successfully"}
{"level":30,"time":1768681308882,"env":"test","module":"audit-log-service","userId":"244ec3c1-9eb1-4211-9311-400c7d3c3d71","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681308939,"env":"test","module":"rbac-middleware","userId":"244ec3c1-9eb1-4211-9311-400c7d3c3d71","userRole":"viewer","permission":"project:delete","path":"/a8304c29-2e14-4b5b-a80d-c1fe503481be","msg":"Permission denied"}
{"level":30,"time":1768681309313,"env":"test","module":"user-credentials-repository","userId":"dd91e463-3870-4b76-b037-3d1712d4dd6b","msg":"User credentials created"}
{"level":30,"time":1768681309403,"env":"test","module":"email-queue","jobId":"1244d677-1a86-47cd-978c-c50d87371ace","to":"protected-test-IHtJWL9bSgwfCu-V1lrYN@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681309448,"env":"test","module":"auth-routes","userId":"dd91e463-3870-4b76-b037-3d1712d4dd6b","email":"protected-test-IHtJWL9bSgwfCu-V1lrYN@example.com","msg":"User registered"}
{"level":30,"time":1768681310078,"env":"test","module":"auth-routes","userId":"dd91e463-3870-4b76-b037-3d1712d4dd6b","msg":"User logged in successfully"}
{"level":30,"time":1768681310127,"env":"test","module":"audit-log-service","userId":"dd91e463-3870-4b76-b037-3d1712d4dd6b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681310551,"env":"test","module":"user-credentials-repository","userId":"f256fde8-7034-4318-974f-6953be46b969","msg":"User credentials created"}
{"level":30,"time":1768681310642,"env":"test","module":"email-queue","jobId":"b0348227-443d-4549-b184-0241ca365ff9","to":"protected-test-Uxycl5_Enr6AixhnYCt7Y@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681310685,"env":"test","module":"auth-routes","userId":"f256fde8-7034-4318-974f-6953be46b969","email":"protected-test-Uxycl5_Enr6AixhnYCt7Y@example.com","msg":"User registered"}
{"level":30,"time":1768681311284,"env":"test","module":"auth-routes","userId":"f256fde8-7034-4318-974f-6953be46b969","msg":"User logged in successfully"}
{"level":30,"time":1768681311330,"env":"test","module":"audit-log-service","userId":"f256fde8-7034-4318-974f-6953be46b969","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681311766,"env":"test","module":"user-credentials-repository","userId":"68b333f8-890e-4814-965a-842d98db59dc","msg":"User credentials created"}
{"level":30,"time":1768681311854,"env":"test","module":"email-queue","jobId":"f3469525-652b-498e-ad37-4d8d91f780af","to":"protected-test-R6YlCdEk2YPrlbHXlD9td@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681311898,"env":"test","module":"auth-routes","userId":"68b333f8-890e-4814-965a-842d98db59dc","email":"protected-test-R6YlCdEk2YPrlbHXlD9td@example.com","msg":"User registered"}
{"level":30,"time":1768681312513,"env":"test","module":"auth-routes","userId":"68b333f8-890e-4814-965a-842d98db59dc","msg":"User logged in successfully"}
{"level":30,"time":1768681312562,"env":"test","module":"audit-log-service","userId":"68b333f8-890e-4814-965a-842d98db59dc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681313009,"env":"test","module":"user-credentials-repository","userId":"7b7c0cd7-cdc0-40cd-a9db-06578437d800","msg":"User credentials created"}
{"level":30,"time":1768681313104,"env":"test","module":"email-queue","jobId":"ad0a77da-7246-4459-a262-76794b1e0f9c","to":"protected-test-RSLqCAyXNI_YXisirlbAh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681313149,"env":"test","module":"auth-routes","userId":"7b7c0cd7-cdc0-40cd-a9db-06578437d800","email":"protected-test-RSLqCAyXNI_YXisirlbAh@example.com","msg":"User registered"}
{"level":30,"time":1768681313781,"env":"test","module":"auth-routes","userId":"7b7c0cd7-cdc0-40cd-a9db-06578437d800","msg":"User logged in successfully"}
{"level":30,"time":1768681313830,"env":"test","module":"audit-log-service","userId":"7b7c0cd7-cdc0-40cd-a9db-06578437d800","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681314762,"env":"test","module":"user-credentials-repository","userId":"9e864b40-e5b2-4d67-a13f-27cdef7cfada","msg":"User credentials created"}
{"level":30,"time":1768681314876,"env":"test","module":"email-queue","jobId":"94e6b99a-a702-4695-8a48-93b4eed1d744","to":"protected-test-yVQR3JanczAnWD3dKstPS@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681314939,"env":"test","module":"auth-routes","userId":"9e864b40-e5b2-4d67-a13f-27cdef7cfada","email":"protected-test-yVQR3JanczAnWD3dKstPS@example.com","msg":"User registered"}
{"level":30,"time":1768681315628,"env":"test","module":"auth-routes","userId":"9e864b40-e5b2-4d67-a13f-27cdef7cfada","msg":"User logged in successfully"}
{"level":30,"time":1768681315686,"env":"test","module":"audit-log-service","userId":"9e864b40-e5b2-4d67-a13f-27cdef7cfada","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681316274,"env":"test","module":"auth-routes","userId":"9e864b40-e5b2-4d67-a13f-27cdef7cfada","msg":"User logged in successfully"}
{"level":30,"time":1768681316332,"env":"test","module":"audit-log-service","userId":"9e864b40-e5b2-4d67-a13f-27cdef7cfada","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681316845,"env":"test","module":"user-credentials-repository","userId":"081149e1-d392-4e18-8f65-7d06d32065f7","msg":"User credentials created"}
{"level":30,"time":1768681316956,"env":"test","module":"email-queue","jobId":"594ea5de-1b63-4fad-91fa-4dddf0d01962","to":"protected-test-HSsevcxlBH9q7VrepdNcG@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681317013,"env":"test","module":"auth-routes","userId":"081149e1-d392-4e18-8f65-7d06d32065f7","email":"protected-test-HSsevcxlBH9q7VrepdNcG@example.com","msg":"User registered"}
{"level":30,"time":1768681317752,"env":"test","module":"auth-routes","userId":"081149e1-d392-4e18-8f65-7d06d32065f7","msg":"User logged in successfully"}
{"level":30,"time":1768681317812,"env":"test","module":"audit-log-service","userId":"081149e1-d392-4e18-8f65-7d06d32065f7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681318436,"env":"test","module":"auth-routes","userId":"081149e1-d392-4e18-8f65-7d06d32065f7","msg":"User logged in successfully"}
{"level":30,"time":1768681318498,"env":"test","module":"audit-log-service","userId":"081149e1-d392-4e18-8f65-7d06d32065f7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681318923,"env":"test","module":"user-credentials-repository","userId":"8698661f-2435-425b-bcec-7491551ae1d3","msg":"User credentials created"}
{"level":30,"time":1768681319039,"env":"test","module":"email-queue","jobId":"1fd0cc1f-e23c-4925-8822-be5385052df7","to":"user2-eGvWC3lEp1rMsx0_0-eI3@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681319097,"env":"test","module":"auth-routes","userId":"8698661f-2435-425b-bcec-7491551ae1d3","email":"user2-eGvWC3lEp1rMsx0_0-eI3@example.com","msg":"User registered"}
{"level":30,"time":1768681319806,"env":"test","module":"auth-routes","userId":"8698661f-2435-425b-bcec-7491551ae1d3","msg":"User logged in successfully"}
{"level":30,"time":1768681319863,"env":"test","module":"audit-log-service","userId":"8698661f-2435-425b-bcec-7491551ae1d3","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
DEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681320444,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["cfdd3938-f22d-4f50-b54a-8d9fb50d051f","$2b$12$usWeNqpQkSu432rRwXOTueVAUwikfNFKK69oQ58MtmnuZSKetXaOa"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(cfdd3938-f22d-4f50-b54a-8d9fb50d051f) is not present in table \"users\".","schema":"test_schema_w15_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"cfdd3938-f22d-4f50-b54a-8d9fb50d051f","msg":"Failed to create user credentials"}
{"level":50,"time":1768681320444,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["cfdd3938-f22d-4f50-b54a-8d9fb50d051f","$2b$12$usWeNqpQkSu432rRwXOTueVAUwikfNFKK69oQ58MtmnuZSKetXaOa"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(cfdd3938-f22d-4f50-b54a-8d9fb50d051f) is not present in table \"users\".","schema":"test_schema_w15_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681320881,"env":"test","module":"user-credentials-repository","userId":"5722e3e6-3fe1-45f2-8ccb-3dd6b40205c1","msg":"User credentials created"}
{"level":30,"time":1768681321005,"env":"test","module":"email-queue","jobId":"bbd6463a-ce37-4e7e-ac1b-f1797c5a6d1a","to":"protected-test-WMWHYY0XaNsulZKu3tnES@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681321060,"env":"test","module":"auth-routes","userId":"5722e3e6-3fe1-45f2-8ccb-3dd6b40205c1","email":"protected-test-WMWHYY0XaNsulZKu3tnES@example.com","msg":"User registered"}
{"level":50,"time":1768681321880,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["5722e3e6-3fe1-45f2-8ccb-3dd6b40205c1","2d0932ea4fa11b1783fcd98e540e00aad66f7104028b830774044916e502fc0c","2026-02-16T20:22:01.793Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T20:22:01.793Z"],"cause":{"length":339,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5722e3e6-3fe1-45f2-8ccb-3dd6b40205c1) is not present in table \"users\".","schema":"test_schema_w18_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
{"level":30,"time":1768681322011,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681322012,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
DEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: 5722e3e6-3fe1-45f2-8ccb-3dd6b40205c1,2d0932ea4fa11b1783fcd98e540e00aad66f7104028b830774044916e502fc0c,2026-02-16T20:22:01.793Z,false,{"ip":"::1"},,::1,Location Unknown,2026-01-17T20:22:01.793Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
  query: 'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)',
  params: [
    '5722e3e6-3fe1-45f2-8ccb-3dd6b40205c1',
    '2d0932ea4fa11b1783fcd98e540e00aad66f7104028b830774044916e502fc0c',
    '2026-02-16T20:22:01.793Z',
    false,
    '{"ip":"::1"}',
    null,
    '::1',
    'Location Unknown',
    '2026-01-17T20:22:01.793Z'
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
    length: 339,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(5722e3e6-3fe1-45f2-8ccb-3dd6b40205c1) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w18_v3',
    table: 'refresh_tokens',
    column: undefined,
    dataType: undefined,
    constraint: 'refresh_tokens_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 4 failed | 1 skipped) 48277ms
       Γ£ô should allow access with valid Bearer token  1389ms
       ├ù should reject access without Authorization header 604ms
       ├ù should reject access with empty Bearer token 881ms
       Γ£ô should reject access with malformed Authorization header  1603ms
       Γ£ô should reject access with wrong token type  1262ms
       Γ£ô should allow POST with valid Bearer token  1276ms
       Γ£ô should reject POST without Bearer token  1221ms
       Γ£ô should reject POST with invalid token  1240ms
       Γ£ô should allow PUT with valid Bearer token  1539ms
       Γ£ô should reject PUT without Bearer token  1251ms
       Γ£ô should allow DELETE with valid Bearer token  1409ms
       Γ£ô should reject DELETE without Bearer token  1318ms
       Γ£ô should allow PATCH with valid Bearer token  1874ms
       Γ£ô should reject PATCH without Bearer token  1247ms
       Γ£ô should handle Bearer token with extra spaces  1291ms
       Γåô should handle token with newlines
       Γ£ô should handle very long invalid token  1244ms
       Γ£ô should handle empty Authorization header  1282ms
       Γ£ô should handle Authorization header with only Bearer  1204ms
       Γ£ô should handle multiple Authorization headers  1231ms
       Γ£ô should reject token with SQL injection attempt  1215ms
       Γ£ô should reject token with XSS attempt  1307ms
       Γ£ô should reject token with missing userId  1181ms
       Γ£ô should reject token with non-existent userId  1279ms
       Γ£ô should not allow user to access another user's resources  2297ms
       Γ£ô should inject userId into request context  1241ms
       Γ£ô should inject tenantId into request context  1199ms
       Γ£ô should inject role into request context  1232ms
       Γ£ô should not apply general rate limiting to authenticated requests  1737ms
       Γ£ô should handle request with both Bearer token and cookies  2048ms
       Γ£ô should prioritize Bearer token over cookie when both present  3593ms
       ├ù should allow unauthenticated access to optional auth routes 456ms
       ├ù should enhance optional auth routes with user context when authenticated 1448ms

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Tests 4 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
Error: expected 201 "Created", got 500 "Internal Server Error"
 Γ¥» tests/integration/auth/protected.routes.test.ts:56:14
     54|             .post("/api/auth/register")
     55|             .send(testUser)
     56|             .expect(201);
       |              ^
     57| 
     58|         const userId = registerRes.body.user.id;
 Γ¥» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Γ¥» node_modules/supertest/lib/test.js:365:13
 Γ¥» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Γ¥» Test.assert node_modules/supertest/lib/test.js:195:23
 Γ¥» localAssert node_modules/supertest/lib/test.js:138:14
 Γ¥» node_modules/supertest/lib/test.js:156:7
 Γ¥» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Γ¥» node_modules/superagent/lib/node/index.js:1102:18

 Test Files  1 failed (1)
      Tests  4 failed | 28 passed | 1 skipped (33)
   Start at  14:20:48
   Duration  67.82s

 Γ¥» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/4]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Error: expected 200 "OK", got 500 "Internal Server Error"
 Γ¥» tests/integration/auth/protected.routes.test.ts:84:14
     82|                 password: testUser.password,
     83|             })
     84|             .expect(200);
       |              ^
     85| 
     86|         userToken = loginRes.body.token;
 Γ¥» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Γ¥» node_modules/supertest/lib/test.js:365:13
 Γ¥» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Γ¥» Test.assert node_modules/supertest/lib/test.js:195:23
 Γ¥» localAssert node_modules/supertest/lib/test.js:138:14
 Γ¥» node_modules/supertest/lib/test.js:156:7
 Γ¥» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Γ¥» node_modules/superagent/lib/node/index.js:1102:18
 Γ¥» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/4]ΓÄ»

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x16 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681467780,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681472214,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681472215,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w0_v3\",public on all connections"}
{"level":30,"time":1768681472266,"env":"test","msg":"DB: Wrapped execute() to set search_path=\"test_schema_w0_v3\",public"}
{"level":30,"time":1768681472266,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: []

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681475055,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681475074,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768681475063,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681475064,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681475068,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681475068,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681475073,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681475073,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681475074,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681475074,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768681475575,"env":"test","module":"user-credentials-repository","userId":"809b7ce9-9906-4b8c-ac16-b2ae56b863f5","msg":"User credentials created"}
{"level":30,"time":1768681475697,"env":"test","module":"email-queue","jobId":"1cab05f7-0be9-4cfc-b75c-6589da068d4a","to":"test-ThPdI_dSy3Z_O70rrgEHZ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681475759,"env":"test","module":"auth-routes","userId":"809b7ce9-9906-4b8c-ac16-b2ae56b863f5","email":"test-ThPdI_dSy3Z_O70rrgEHZ@example.com","msg":"User registered"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 499167d9-d6e6-4a6f-b510-aa751b8d606f,809b7ce9-9906-4b8c-ac16-b2ae56b863f5,admin
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:137:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)',
  params: [
    '499167d9-d6e6-4a6f-b510-aa751b8d606f',
    '809b7ce9-9906-4b8c-ac16-b2ae56b863f5',
    'admin'
  ],
  cause: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:137:5)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 400,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (org_id)=(499167d9-d6e6-4a6f-b510-aa751b8d606f) is not present in table "organizations".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w20_v3',
    table: 'organization_memberships',
    column: undefined,
    dataType: undefined,
    constraint: 'organization_memberships_org_id_organizations_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":30,"time":1768681475976,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768681475977,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 4810ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 499167d9-d6e6-4a6f-b510-aa751b8d606f,809b7ce9-9906-4b8c-ac16-b2ae56b863f5,admin
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:137:5
    135| 
    136|     // Create organization membership
    137|     await db.insert(schema.organizationMemberships).values({
       |     ^
    138|       orgId: orgId,
    139|       userId: userId,
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:137:5
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 400, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(499167d9-d6e6-4a6f-b510-aa751b8d606f) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:24:19
   Duration  15.88s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x17 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681566195,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

{"level":30,"time":1768681582230,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681582231,"env":"test","msg":"DB: Configured pool.connect() to set search_path=\"test_schema_w0_v3\",public on all clients"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681591169,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681592832,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681592853,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768681592843,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681592843,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681592848,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681592848,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681592853,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681592853,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681592853,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681592853,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768681593410,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b734c4c9-8d0b-4e8d-8980-37ae936acb06","$2b$12$eUZ0o28bzKS94AG7v4T/l.4IdHb4Pg7RU08B8BbchXp64CuwVRG/m"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b734c4c9-8d0b-4e8d-8980-37ae936acb06) is not present in table \"users\".","schema":"test_schema_w30_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"b734c4c9-8d0b-4e8d-8980-37ae936acb06","msg":"Failed to create user credentials"}
{"level":50,"time":1768681593410,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b734c4c9-8d0b-4e8d-8980-37ae936acb06","$2b$12$eUZ0o28bzKS94AG7v4T/l.4IdHb4Pg7RU08B8BbchXp64CuwVRG/m"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b734c4c9-8d0b-4e8d-8980-37ae936acb06) is not present in table \"users\".","schema":"test_schema_w30_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681593426,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681593426,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w122_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w0_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Dropping existing function: test_schema_w0_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 12233ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:24:48
   Duration  98.86s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x18 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681688543,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stderr | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Failed to create schema test_schema_w0_v3: error: Too many connections attempts
    at Parser.parseErrorMessage (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:285:98)
    at Parser.handlePacket (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:122:29)
    at Parser.parse (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:35:38)
    at TLSSocket.<anonymous> (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\index.js:11:42)
    at TLSSocket.emit (node:events:508:28)
    at addChunk (node:internal/streams/readable:559:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
    at TLSSocket.Readable.push (node:internal/streams/readable:390:5)
    at TLSWrap.onStreamRead (node:internal/stream_base_commons:189:23) {
  length: 50,
  severity: 'ERROR',
  code: 'XX000',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: undefined,
  line: undefined,
  routine: undefined
}

stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): error: Too many connections attempts
    at Parser.parseErrorMessage (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:285:98)
    at Parser.handlePacket (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:122:29)
    at Parser.parse (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:35:38)
    at TLSSocket.<anonymous> (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\index.js:11:42)
    at TLSSocket.emit (node:events:508:28)
    at addChunk (node:internal/streams/readable:559:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
    at TLSSocket.Readable.push (node:internal/streams/readable:390:5)
    at TLSWrap.onStreamRead (node:internal/stream_base_commons:189:23) {
  length: 50,
  severity: 'ERROR',
  code: 'XX000',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: undefined,
  line: undefined,
  routine: undefined
}

{"level":30,"time":1768681694856,"env":"test","msg":"DB: initializing... Local"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

{"level":30,"time":1768681694915,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681695006,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768681694919,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681694989,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681694990,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681694995,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681694997,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681695005,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681695006,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681695006,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681695006,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 4qhyl_y1fHMQvqmMfau4F,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant 4qhyl_y1fHMQvqmMfau4F', 'pro' ],
  cause: error: Too many connections attempts
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 50,
    severity: 'ERROR',
    code: 'XX000',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 925ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 4qhyl_y1fHMQvqmMfau4F,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: Too many connections attempts
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 50, severity: 'ERROR', code: 'XX000', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:27:17
   Duration  52.92s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x19 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681705106,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681710243,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681710243,"env":"test","msg":"DB: Using test schema \"test_schema_w0_v3\" (via PGOPTIONS)"}
{"level":30,"time":1768681710302,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:196:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:196:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681710736,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768681710764,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768681710745,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681710754,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681710759,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681710759,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681710763,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681710763,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681710764,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681710764,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant HoeSw8C3FewyU0sT_UJea,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant HoeSw8C3FewyU0sT_UJea', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768681711256,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768681711257,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 2044ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant HoeSw8C3FewyU0sT_UJea,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:28:15
   Duration  15.10s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x20 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöä add secrets lifecycle management: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681927911,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

{"level":30,"time":1768681951745,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681951746,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681956505,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681956798,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681956815,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768681956806,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681956806,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681956810,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681956810,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681956814,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681956814,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681956815,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681956815,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768681957191,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681957192,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:196:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:196:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant TnyPooa64wq-vjakJyu6o,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant TnyPooa64wq-vjakJyu6o', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 6466ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant TnyPooa64wq-vjakJyu6o,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:31:54
   Duration  39.80s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x21 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöæ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681994917,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681998034,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681998034,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768681998078,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681998374,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681998391,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768681998381,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681998382,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681998386,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681998386,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681998391,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681998391,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681998391,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681998391,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 2bXe9rSjKDZmk32xm8Kss,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant 2bXe9rSjKDZmk32xm8Kss', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768681998688,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768681998688,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1482ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant 2bXe9rSjKDZmk32xm8Kss,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:32:42
   Duration  30.82s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
