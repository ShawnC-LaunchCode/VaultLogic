
[1m[44m DEV [49m[22m [34mv4.0.5 [39m[90mC:/Users/scoot/poll/VaultLogic[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (11) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

{"level":40,"time":1764871468935,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764871468937,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764871469127,"env":"test","msg":"GEMINI_API_KEY not configured - AI features will be unavailable"}
{"level":30,"time":1764871470512,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764871470512,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

{"level":30,"time":1764871471959,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764871471961,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764871471960,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764871471968,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764871471969,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764871471969,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764871471969,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764871471962,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764871471971,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764871471971,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764871471971,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764871471971,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764871472001,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764871472002,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764871472003,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764871472004,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764871472009,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764871472021,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764871472021,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764871472027,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764871472027,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764871472027,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764871472028,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764871472029,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764871472040,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764871472045,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764871472045,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764871472045,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764871472045,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764871472046,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764871472050,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764871472054,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764871472059,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764871472061,"env":"test","module":"auth-routes","userId":"-1ojbzpz_fRai0-lAuLd0","email":"test-bkExTIG9Bld_AOkiMcH3z@example.com","msg":"User registered successfully"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 108[2mms[22m[39m
{"level":30,"time":1764871472136,"env":"test","module":"auth-routes","userId":"eRIcggS7J2tVEqW56Ay8D","email":"test-rDX2etlYA20Ag2vrnqeOj@example.com","msg":"User registered successfully"}
{"level":30,"time":1764871472200,"env":"test","module":"auth-routes","userId":"y-PDJO0MGn0bik4SnhzJX","email":"test-login-XfbebD3h2XRuXmhLPYQfA@example.com","msg":"User registered successfully"}
{"level":30,"time":1764871472257,"env":"test","module":"auth-routes","userId":"y-PDJO0MGn0bik4SnhzJX","email":"test-login-XfbebD3h2XRuXmhLPYQfA@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764871472380,"env":"test","module":"auth-routes","userId":"o9vwiLcFI8QB48X0zX2EH","email":"test-me-oVw0PuBhMBc-wTled3X9P@example.com","msg":"User registered successfully"}
{"level":40,"time":1764871472390,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764871472393,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764871472396,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764871472452,"env":"test","module":"auth-routes","userId":"Yj_RBzdgaxBKI6jydqJOb","email":"owner-cFnptciSy1UkC8UHceerA@example.com","msg":"User registered successfully"}
{"level":30,"time":1764871472686,"env":"test","module":"tenant-routes","tenantId":"3a22bcfe-a56f-4a31-808b-c59cdfb3ad71","userId":"Yj_RBzdgaxBKI6jydqJOb","msg":"Tenant created"}
{"level":30,"time":1764871472740,"env":"test","module":"auth-routes","userId":"OZvFUPhgi8-T5oxtR_ouE","email":"builder-XAubkHJakiFwstTnEY0PB@example.com","msg":"User registered successfully"}
{"level":30,"time":1764871472794,"env":"test","module":"auth-routes","userId":"Erii8ofQfJmG3jxHnrlvS","email":"viewer-1e5JNETkdBJFlvwaB3bfA@example.com","msg":"User registered successfully"}
{"level":40,"time":1764871472798,"env":"test","module":"tenant-middleware","userId":"Yj_RBzdgaxBKI6jydqJOb","path":"/api/tenants/current","msg":"User does not have an associated tenant"}
{"level":40,"time":1764871472892,"env":"test","module":"rbac-middleware","userId":"OZvFUPhgi8-T5oxtR_ouE","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/3a22bcfe-a56f-4a31-808b-c59cdfb3ad71","msg":"Role check failed"}
{"level":40,"time":1764871472895,"env":"test","module":"rbac-middleware","userId":"Erii8ofQfJmG3jxHnrlvS","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/3a22bcfe-a56f-4a31-808b-c59cdfb3ad71","msg":"Role check failed"}
{"level":40,"time":1764871472897,"env":"test","module":"tenant-middleware","userId":"Yj_RBzdgaxBKI6jydqJOb","paramTenantId":"3a22bcfe-a56f-4a31-808b-c59cdfb3ad71","path":"/api/tenants/3a22bcfe-a56f-4a31-808b-c59cdfb3ad71","msg":"User has no tenant, cannot access tenant-specific route"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 944[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should register a new user with email and password[32m 93[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject registration with weak password[32m 6[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject registration with invalid email[32m 4[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject registration with missing fields[32m 3[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject duplicate email registration[32m 61[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should login with valid credentials[32m 58[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject login with wrong password[32m 59[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject login with non-existent email[32m 5[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject login with missing fields[32m 3[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should return current user with valid token[32m 7[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject request without token[32m 3[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject request with invalid token[32m 3[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should logout successfully[32m 3[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow owner to access tenant information[39m[32m 4[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should allow builder to access tenant information[32m 46[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should allow viewer to access tenant information[32m 45[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should only allow owner to update tenant[39m[32m 9[2mms[22m[39m

[2m Test Files [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m1 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[31m2 failed[39m[22m[2m | [22m[1m[32m21 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 12:04:26
[2m   Duration [22m 6.54s[2m (transform 3.99s, setup 1.38s, collect 8.62s, tests 1.05s, environment 0ms, prepare 27ms)[22m

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/repositories/UserRepository.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (11) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

{"level":40,"time":1764871632948,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764871633294,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764871633566,"env":"test","msg":"GEMINI_API_KEY not configured - AI features will be unavailable"}
{"level":30,"time":1764871635967,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764871636317,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

{"level":30,"time":1764871640440,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764871640440,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764871640451,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764871640451,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764871640452,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764871640452,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764871640790,"env":"test","module":"auth-routes","userId":"fqKc0q_upnBZ-EworfKi2","email":"test-tzVg0z5rZsvmVrDoaRLmO@example.com","msg":"User registered successfully"}
{"level":30,"time":1764871641078,"env":"test","module":"auth-routes","userId":"pEFPrzyS1zAkmofagMJCm","email":"test-bKh1UhYWtkSYemFiONRuV@example.com","msg":"User registered successfully"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

{"level":30,"time":1764871641164,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764871641164,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764871641175,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764871641176,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764871641176,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764871641176,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764871641246,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764871641246,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764871641294,"env":"test","module":"auth-routes","userId":"l1OWsI7PsB-zwOHUNI236","email":"test-login-q6ROZHIF8YHXQBuD1vESC@example.com","msg":"User registered successfully"}
{"level":30,"time":1764871641314,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764871641315,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764871641344,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764871641376,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764871641376,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764871641387,"env":"test","module":"auth-routes","userId":"l1OWsI7PsB-zwOHUNI236","email":"test-login-q6ROZHIF8YHXQBuD1vESC@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764871641387,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764871641387,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764871641400,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764871641401,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764871641402,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764871641423,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764871641437,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764871641437,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764871641438,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764871641438,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764871641440,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764871641448,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764871641457,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764871641470,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 379[2mms[22m[39m
{"level":30,"time":1764871641670,"env":"test","module":"auth-routes","userId":"0-aB2tAIdfaAy7Xev6wlN","email":"test-me-Do4ex9rGsxByt-0dtz1Gu@example.com","msg":"User registered successfully"}
{"level":40,"time":1764871641712,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764871641718,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764871641734,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764871641818,"env":"test","module":"auth-routes","userId":"BiSwOnwv8y0lMsDw483ne","email":"owner-h_n3feHU1Jsc7Xs4st6yI@example.com","msg":"User registered successfully"}
{"level":30,"time":1764871642115,"env":"test","module":"tenant-routes","tenantId":"ac43b994-3a9f-454c-afb0-aa59ec6ccbfa","userId":"BiSwOnwv8y0lMsDw483ne","msg":"Tenant created"}
{"level":30,"time":1764871642189,"env":"test","module":"auth-routes","userId":"yfPkvPHNb58du5AdDbgYo","email":"builder-wEnh0mBfln3uXRSlH0FSJ@example.com","msg":"User registered successfully"}
{"level":30,"time":1764871642265,"env":"test","module":"auth-routes","userId":"99WumvJu1PmdYfXWSGYgG","email":"viewer-Tq2agYi6MyaM9ye1t-oGr@example.com","msg":"User registered successfully"}
{"level":40,"time":1764871642280,"env":"test","module":"tenant-middleware","userId":"BiSwOnwv8y0lMsDw483ne","path":"/api/tenants/current","msg":"User does not have an associated tenant"}
{"level":40,"time":1764871642455,"env":"test","module":"rbac-middleware","userId":"yfPkvPHNb58du5AdDbgYo","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/ac43b994-3a9f-454c-afb0-aa59ec6ccbfa","msg":"Role check failed"}
{"level":40,"time":1764871642463,"env":"test","module":"rbac-middleware","userId":"99WumvJu1PmdYfXWSGYgG","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/ac43b994-3a9f-454c-afb0-aa59ec6ccbfa","msg":"Role check failed"}
{"level":40,"time":1764871642467,"env":"test","module":"tenant-middleware","userId":"BiSwOnwv8y0lMsDw483ne","paramTenantId":"ac43b994-3a9f-454c-afb0-aa59ec6ccbfa","path":"/api/tenants/ac43b994-3a9f-454c-afb0-aa59ec6ccbfa","msg":"User has no tenant, cannot access tenant-specific route"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 2039[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should register a new user with email and password [33m 377[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject registration with weak password[32m 110[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject registration with invalid email[32m 8[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject registration with missing fields[32m 7[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject duplicate email registration[32m 129[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should login with valid credentials[32m 94[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject login with wrong password[32m 107[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject login with non-existent email[32m 9[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject login with missing fields[32m 78[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should return current user with valid token[32m 23[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject request without token[32m 9[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject request with invalid token[32m 6[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should logout successfully[32m 16[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow owner to access tenant information[39m[32m 61[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should allow builder to access tenant information[32m 61[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should allow viewer to access tenant information[32m 62[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should only allow owner to update tenant[39m[32m 17[2mms[22m[39m

[2m Test Files [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m1 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[31m2 failed[39m[22m[2m | [22m[1m[32m21 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 12:07:08
[2m   Duration [22m 24.37s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/tenant.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (11) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

{"level":40,"time":1764871701260,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764871701606,"env":"test","msg":"GEMINI_API_KEY not configured - AI features will be unavailable"}
{"level":40,"time":1764871702413,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764871708652,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764871708670,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

{"level":30,"time":1764871710667,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764871710668,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764871710677,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764871710677,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764871710678,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764871710678,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

{"level":30,"time":1764871710741,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764871710742,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764871710752,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764871710752,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764871710753,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764871710753,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764871710796,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764871710810,"env":"test","module":"auth-routes","userId":"8RmzUquDEg7pEAH3-N-8P","email":"test-0osLojGqB5R2GUTUhFWZ7@example.com","msg":"User registered successfully"}
{"level":30,"time":1764871710798,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764871710816,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764871710817,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764871710823,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764871710846,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764871710846,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764871710864,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764871710864,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764871710866,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764871710867,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764871710869,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764871710898,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764871710904,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764871710904,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764871710905,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764871710906,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764871710907,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764871710915,"env":"test","module":"auth-routes","userId":"5hhEC61_lATn5CWQyfHfL","email":"test-GU9jKjdTzXFCN0zaAKYfp@example.com","msg":"User registered successfully"}
{"level":30,"time":1764871710916,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764871710921,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764871710929,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 199[2mms[22m[39m
{"level":30,"time":1764871710991,"env":"test","module":"auth-routes","userId":"73XPQ2AK4-rabsjttpJ3q","email":"test-login-nm14hQWo7ADHWYw47v0tm@example.com","msg":"User registered successfully"}
{"level":30,"time":1764871711052,"env":"test","module":"auth-routes","userId":"73XPQ2AK4-rabsjttpJ3q","email":"test-login-nm14hQWo7ADHWYw47v0tm@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764871711183,"env":"test","module":"auth-routes","userId":"8g1Tkjf27QUiwqxi9ktsJ","email":"test-me-M0kE5fLGTXbQ_7tJTO5mt@example.com","msg":"User registered successfully"}
{"level":40,"time":1764871711197,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764871711202,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764871711206,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764871711267,"env":"test","module":"auth-routes","userId":"hvH3V0q4CVsEcxu_KkKk3","email":"owner-rPFF4V7dKLbfEYANiwlRi@example.com","msg":"User registered successfully"}
{"level":50,"time":1764871711470,"env":"test","module":"tenant-routes","error":{},"msg":"Failed to create tenant"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[33m 814[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should register a new user with email and password[32m 142[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject registration with weak password[32m 9[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject registration with invalid email[32m 7[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject registration with missing fields[32m 6[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject duplicate email registration[32m 80[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should login with valid credentials[32m 62[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject login with wrong password[32m 61[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject login with non-existent email[32m 5[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject login with missing fields[32m 4[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should return current user with valid token[32m 8[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject request without token[32m 8[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject request with invalid token[32m 3[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should logout successfully[32m 5[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow owner to access tenant information
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow builder to access tenant information
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow viewer to access tenant information
       [2m[90mÎ“Ã¥Ã´[39m[22m should only allow owner to update tenant

[2m Test Files [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m1 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m19 passed[39m[22m[2m | [22m[33m4 skipped[39m[90m (23)[39m
[2m   Start at [22m 12:08:17
[2m   Duration [22m 25.07s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/tenant.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (11) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":40,"time":1764871752602,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764871753030,"env":"test","msg":"GEMINI_API_KEY not configured - AI features will be unavailable"}
{"level":40,"time":1764871753475,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764871755971,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764871756410,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

{"level":30,"time":1764871759333,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764871759334,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764871759344,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764871759344,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764871759345,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764871759345,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764871759409,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764871759410,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764871759412,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764871759413,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764871759419,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764871759439,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764871759440,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764871759477,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764871759478,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764871759480,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764871759481,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764871759484,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764871759525,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764871759537,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764871759537,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764871759539,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764871759539,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764871759541,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764871759550,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764871759560,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764871759572,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 254[2mms[22m[39m
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

{"level":30,"time":1764871759619,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764871759620,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764871759631,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764871759631,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764871759631,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764871759631,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764871759875,"env":"test","module":"auth-routes","userId":"_GDOJ7DKnrKRV4OOrI3wi","email":"test-MgOwmMFzei1dOFQmjx-yU@example.com","msg":"User registered successfully"}
{"level":30,"time":1764871760094,"env":"test","module":"auth-routes","userId":"y6JS7XxVvyE4YUaEOGOzT","email":"test-hVELb2Zd3d3Aw8YJvpqH3@example.com","msg":"User registered successfully"}
{"level":30,"time":1764871760188,"env":"test","module":"auth-routes","userId":"-fEFiqhHOOmPheK2Qk5rG","email":"test-login--FCaP7uycBSdXEclUwcRz@example.com","msg":"User registered successfully"}
{"level":30,"time":1764871760275,"env":"test","module":"auth-routes","userId":"-fEFiqhHOOmPheK2Qk5rG","email":"test-login--FCaP7uycBSdXEclUwcRz@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764871760458,"env":"test","module":"auth-routes","userId":"MLiM1ufW4b1DQYVqdU8SU","email":"test-me-QJNqm0SgiWZVxUYl3K-0z@example.com","msg":"User registered successfully"}
{"level":40,"time":1764871760488,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764871760496,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764871760505,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764871760585,"env":"test","module":"auth-routes","userId":"2EHo6h1VhRetW2LQ1d9Z-","email":"owner-0OUKf-7TTCDhurH_h7w-I@example.com","msg":"User registered successfully"}
{"level":50,"time":1764871760823,"env":"test","module":"tenant-routes","error":{},"msg":"Failed to create tenant"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[33m 1258[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should register a new user with email and password[32m 278[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject registration with weak password[32m 10[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject registration with invalid email[32m 49[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject registration with missing fields[32m 20[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject duplicate email registration[32m 110[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should login with valid credentials[32m 85[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject login with wrong password[32m 85[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject login with non-existent email[32m 7[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject login with missing fields[32m 5[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should return current user with valid token[32m 11[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject request without token[32m 16[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject request with invalid token[32m 8[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should logout successfully[32m 13[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow owner to access tenant information
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow builder to access tenant information
       [2m[90mÎ“Ã¥Ã´[39m[22m should allow viewer to access tenant information
       [2m[90mÎ“Ã¥Ã´[39m[22m should only allow owner to update tenant

[2m Test Files [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m1 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m19 passed[39m[22m[2m | [22m[33m4 skipped[39m[90m (23)[39m
[2m   Start at [22m 12:09:08
[2m   Duration [22m 21.08s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mtests/integration/auth-jwt.integration.test.ts [22m[34mx4 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (11) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

{"level":40,"time":1764871813373,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764871814377,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

{"level":30,"time":1764871815834,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764871815835,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764871815843,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764871815843,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764871815843,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764871815843,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764871815966,"env":"test","module":"auth-routes","userId":"9gGiVCpXjJ2eWZgzFU6rv","email":"test-a29dNoY_-OHOhyAt-6XAy@example.com","msg":"User registered successfully"}
{"level":30,"time":1764871816058,"env":"test","module":"auth-routes","userId":"v3ilCZEX6_6OTnm52HFt2","email":"test-jIm9XF-qyi_drhf_cRRBi@example.com","msg":"User registered successfully"}
{"level":30,"time":1764871816126,"env":"test","module":"auth-routes","userId":"ftZ_mA8NF9bgYV2rJ2yn5","email":"test-login-8f7WR0lhBXjGftiib6GKi@example.com","msg":"User registered successfully"}
{"level":30,"time":1764871816190,"env":"test","module":"auth-routes","userId":"ftZ_mA8NF9bgYV2rJ2yn5","email":"test-login-8f7WR0lhBXjGftiib6GKi@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764871816327,"env":"test","module":"auth-routes","userId":"QtmZVM_aExj26XoqecQtG","email":"test-me-cP09oN1DlQsyKC2oTfTaM@example.com","msg":"User registered successfully"}
{"level":40,"time":1764871816337,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764871816341,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764871816345,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764871816404,"env":"test","module":"auth-routes","userId":"xZWnI3IYJ3G-k-mL5Nsxe","email":"owner-hI2DeSeegmZwpox75e8Gw@example.com","msg":"User registered successfully"}
{"level":30,"time":1764871816631,"env":"test","module":"tenant-routes","tenantId":"d43d4fb2-9777-4ee1-8f38-6b4dd18289d8","userId":"xZWnI3IYJ3G-k-mL5Nsxe","msg":"Tenant created"}
{"level":30,"time":1764871816692,"env":"test","module":"auth-routes","userId":"oEPtSwFSBp8HkFJSazZu_","email":"builder-G7QTG1TjuR9H_8dAeOMWw@example.com","msg":"User registered successfully"}
{"level":30,"time":1764871816755,"env":"test","module":"auth-routes","userId":"JRJiTf6_mYa_m_abhgf8O","email":"viewer-HKag4S5MSnWgjwPkDlnqx@example.com","msg":"User registered successfully"}
{"level":40,"time":1764871816913,"env":"test","module":"rbac-middleware","userId":"oEPtSwFSBp8HkFJSazZu_","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/d43d4fb2-9777-4ee1-8f38-6b4dd18289d8","msg":"Role check failed"}
{"level":40,"time":1764871816920,"env":"test","module":"rbac-middleware","userId":"JRJiTf6_mYa_m_abhgf8O","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/d43d4fb2-9777-4ee1-8f38-6b4dd18289d8","msg":"Role check failed"}
{"level":30,"time":1764871816970,"env":"test","module":"tenant-routes","tenantId":"d43d4fb2-9777-4ee1-8f38-6b4dd18289d8","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1144[2mms[22m[39m

[2m Test Files [22m [1m[32m1 passed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[32m17 passed[39m[22m[90m (17)[39m
[2m   Start at [22m 12:10:11
[2m   Duration [22m 5.09s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mtests/setup.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

{"level":40,"time":1764873688995,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764873689694,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764873691973,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764873691975,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764873696304,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764873696305,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764873696316,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764873696316,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764873696316,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764873696316,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764873696560,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764873696561,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764873696576,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764873696576,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764873696577,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764873696577,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764873696594,"env":"test","module":"auth-routes","userId":"Jr0LQUHTCHrwJ85M0Xqpc","email":"test-giwfE9yUhpKRsE-VkU44e@example.com","msg":"User registered successfully"}
{"level":30,"time":1764873696662,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764873696662,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764873696664,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764873696664,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764873696672,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764873696696,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764873696696,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764873696712,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764873696712,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764873696727,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":30,"time":1764873696750,"env":"test","module":"auth-routes","userId":"4Sqd01yjeWJdB_zugZkvz","email":"test-o_Q2MCdqXLOIqICPxRgaE@example.com","msg":"User registered successfully"}
{"level":40,"time":1764873696754,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764873696755,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764873696851,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764873696866,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764873696867,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764873696871,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764873696871,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764873696878,"env":"test","module":"auth-routes","userId":"LmnydO1vn-2IjFYN9rIpk","email":"test-login-7YOs5Vn4uplo3r72u9O-r@example.com","msg":"User registered successfully"}
{"level":30,"time":1764873696872,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764873696881,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764873696889,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764873696905,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 357[2mms[22m[39m
{"level":30,"time":1764873696983,"env":"test","module":"auth-routes","userId":"LmnydO1vn-2IjFYN9rIpk","email":"test-login-7YOs5Vn4uplo3r72u9O-r@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764873697202,"env":"test","module":"auth-routes","userId":"ZWm_pJgPia08XYtvTGIf1","email":"test-me-NlgS2thNbuUBKqARIyy_I@example.com","msg":"User registered successfully"}
{"level":40,"time":1764873697242,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764873697250,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764873697260,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764873697347,"env":"test","module":"auth-routes","userId":"51KCwWyPuvZZ43q8tdtu3","email":"owner-AagyjkNUhafX6tZJgMvPG@example.com","msg":"User registered successfully"}
{"level":30,"time":1764873697564,"env":"test","module":"tenant-routes","tenantId":"ab3eddf3-b1a0-44a2-bc6e-9497ed975b13","userId":"51KCwWyPuvZZ43q8tdtu3","msg":"Tenant created"}
{"level":30,"time":1764873697636,"env":"test","module":"auth-routes","userId":"kddrLC7Y6EQm-QY7XnTo7","email":"builder-wEwQrPVTIyj8BeqwKHtaR@example.com","msg":"User registered successfully"}
{"level":30,"time":1764873697721,"env":"test","module":"auth-routes","userId":"qJw_mVLK074CxqvDIyPoR","email":"viewer-XMoVSM5sPYcmMtk0SzvFa@example.com","msg":"User registered successfully"}
{"level":40,"time":1764873697913,"env":"test","module":"rbac-middleware","userId":"kddrLC7Y6EQm-QY7XnTo7","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/ab3eddf3-b1a0-44a2-bc6e-9497ed975b13","msg":"Role check failed"}
{"level":40,"time":1764873697919,"env":"test","module":"rbac-middleware","userId":"qJw_mVLK074CxqvDIyPoR","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/ab3eddf3-b1a0-44a2-bc6e-9497ed975b13","msg":"Role check failed"}
{"level":30,"time":1764873697976,"env":"test","module":"tenant-routes","tenantId":"ab3eddf3-b1a0-44a2-bc6e-9497ed975b13","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1685[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 12:41:24
[2m   Duration [22m 23.31s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/db.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops


[2m Test Files [22m [1m[31m2 failed[39m[22m[90m (2)[39m
[2m      Tests [22m [2mno tests[22m
[2m     Errors [22m [1m[31m2 errors[39m[22m
[2m   Start at [22m 12:55:40
[2m   Duration [22m 0ms

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/db.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

{"level":40,"time":1764874578928,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764874580324,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764874584050,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764874584796,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764874590448,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764874590449,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764874590465,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764874590465,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764874590466,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764874590466,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764874590673,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764874590673,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764874590684,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764874590684,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764874590685,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764874590685,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764874590953,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764874590954,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764874590956,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764874590957,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764874591066,"env":"test","module":"auth-routes","userId":"0N4pWGlPaIlRXMjuidSb9","email":"test-J_n0KozNTIkNy2EkNBElB@example.com","msg":"User registered successfully"}
{"level":30,"time":1764874590967,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764874591281,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764874591282,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764874591355,"env":"test","module":"auth-routes","userId":"muYUwZly4DpFbEtb_moYo","email":"test-KUdfrJnd6o4ZYEDCJ96P4@example.com","msg":"User registered successfully"}
{"level":30,"time":1764874591509,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764874591509,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764874591512,"env":"test","module":"auth-routes","userId":"QJTrXhD9p1GPt4ice_A6q","email":"test-login-M3WWrMpP7v8IrpayKza5I@example.com","msg":"User registered successfully"}
{"level":30,"time":1764874591628,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764874591628,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764874591630,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764874591652,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764874591654,"env":"test","module":"auth-routes","userId":"QJTrXhD9p1GPt4ice_A6q","email":"test-login-M3WWrMpP7v8IrpayKza5I@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764874591661,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764874591661,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764874591664,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764874591664,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764874591666,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764874591674,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764874591681,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764874591691,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 1032[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should successfully log in with valid Google ID token [33m 588[2mms[22m[39m
{"level":30,"time":1764874591968,"env":"test","module":"auth-routes","userId":"t-c3EmuH5rHt8qN7FnMLO","email":"test-me-BDbMItk-4alB8ugXo9VHF@example.com","msg":"User registered successfully"}
{"level":40,"time":1764874592011,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764874592018,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764874592056,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764874592177,"env":"test","module":"auth-routes","userId":"kYMDJt57JuDYaYq-RIcIr","email":"owner-6Z2vPW1SKWrmnVTQEPE2S@example.com","msg":"User registered successfully"}
{"level":30,"time":1764874592412,"env":"test","module":"tenant-routes","tenantId":"524ab59f-2615-412c-a9d6-f93401e0d1ef","userId":"kYMDJt57JuDYaYq-RIcIr","msg":"Tenant created"}
{"level":30,"time":1764874592488,"env":"test","module":"auth-routes","userId":"uZ0XMFNTRpPDbT2wYUOUN","email":"builder-4WvOn0NaIMc1355ykY3gS@example.com","msg":"User registered successfully"}
{"level":30,"time":1764874592597,"env":"test","module":"auth-routes","userId":"9StyvQIdye6WsE4iM5vKB","email":"viewer-m3Oixs90HiwBy6xu2LVSP@example.com","msg":"User registered successfully"}
{"level":40,"time":1764874592833,"env":"test","module":"rbac-middleware","userId":"uZ0XMFNTRpPDbT2wYUOUN","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/524ab59f-2615-412c-a9d6-f93401e0d1ef","msg":"Role check failed"}
{"level":40,"time":1764874592839,"env":"test","module":"rbac-middleware","userId":"9StyvQIdye6WsE4iM5vKB","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/524ab59f-2615-412c-a9d6-f93401e0d1ef","msg":"Role check failed"}
{"level":30,"time":1764874592900,"env":"test","module":"tenant-routes","tenantId":"524ab59f-2615-412c-a9d6-f93401e0d1ef","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2467[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should register a new user with email and password [33m 597[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 12:56:13
[2m   Duration [22m 34.77s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mtests/setup.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

{"level":40,"time":1764874685776,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764874686161,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764874689627,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764874690598,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764874696075,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764874696075,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764874696088,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764874696088,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764874696088,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764874696088,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764874696165,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764874696166,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764874696177,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764874696177,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764874696177,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764874696177,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764874696235,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764874696236,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764874696281,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764874696282,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764874696288,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764874696313,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764874696313,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764874696325,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764874696325,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764874696401,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764874696402,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764874696404,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764874696425,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764874696433,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764874696433,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764874696471,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764874696472,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764874696473,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764874696480,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764874696487,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764874696494,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 340[2mms[22m[39m
{"level":30,"time":1764874696589,"env":"test","module":"auth-routes","userId":"42epohadkMchDN6E5moxw","email":"test-qD8x_fx-KSgWM7TqyOXJ2@example.com","msg":"User registered successfully"}
{"level":30,"time":1764874697101,"env":"test","module":"auth-routes","userId":"1N58S_F8PpHpHkbTXPymR","email":"test-kFA5TmyBXVqEx9ZcGu3Zf@example.com","msg":"User registered successfully"}
{"level":30,"time":1764874697386,"env":"test","module":"auth-routes","userId":"_-C0lCqfo5BTdKfn-nOyp","email":"test-login-ImqQm5CCUnVaPWUeZEOYG@example.com","msg":"User registered successfully"}
{"level":30,"time":1764874697597,"env":"test","module":"auth-routes","userId":"_-C0lCqfo5BTdKfn-nOyp","email":"test-login-ImqQm5CCUnVaPWUeZEOYG@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764874697900,"env":"test","module":"auth-routes","userId":"UVHm7_nkVCBH6BzYkFPF7","email":"test-me-CMR8btkyLSznPBbPN6eUl@example.com","msg":"User registered successfully"}
{"level":40,"time":1764874697933,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764874697939,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764874697968,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764874698108,"env":"test","module":"auth-routes","userId":"6HdlnKd-XOX6rBGKwiW-J","email":"owner-uTJ9pKq5Dh1OI3gac2gwK@example.com","msg":"User registered successfully"}
{"level":30,"time":1764874698331,"env":"test","module":"tenant-routes","tenantId":"d3155e9c-4f9c-452a-b128-8d2a1e29608f","userId":"6HdlnKd-XOX6rBGKwiW-J","msg":"Tenant created"}
{"level":30,"time":1764874698393,"env":"test","module":"auth-routes","userId":"5CoONGLOp858aDN2bvOFD","email":"builder--Vr0cncAH9QmRD8OmjTNL@example.com","msg":"User registered successfully"}
{"level":30,"time":1764874698460,"env":"test","module":"auth-routes","userId":"Zp48diGn0KLZAt5QGPS-e","email":"viewer-0Cmgk8LUmBMNBC3XwR5ba@example.com","msg":"User registered successfully"}
{"level":40,"time":1764874698624,"env":"test","module":"rbac-middleware","userId":"5CoONGLOp858aDN2bvOFD","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/d3155e9c-4f9c-452a-b128-8d2a1e29608f","msg":"Role check failed"}
{"level":40,"time":1764874698629,"env":"test","module":"rbac-middleware","userId":"Zp48diGn0KLZAt5QGPS-e","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/d3155e9c-4f9c-452a-b128-8d2a1e29608f","msg":"Role check failed"}
{"level":30,"time":1764874698680,"env":"test","module":"tenant-routes","tenantId":"d3155e9c-4f9c-452a-b128-8d2a1e29608f","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2616[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should register a new user with email and password [33m 510[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject duplicate email registration [33m 400[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 12:57:58
[2m   Duration [22m 34.61s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/middleware/rbac.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

{"level":40,"time":1764876565138,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764876566265,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764876569611,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764876569678,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764876573305,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764876573306,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764876573318,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764876573319,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764876573319,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764876573319,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764876573428,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764876573462,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764876573463,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764876573429,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764876573442,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764876573442,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764876573443,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764876573443,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764876573515,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764876573516,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764876573527,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764876573608,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764876573723,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764876573737,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764876573738,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764876573739,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764876573740,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764876573742,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764876573764,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764876573778,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764876573778,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764876573819,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764876573819,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764876573820,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764876573830,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764876573837,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764876573890,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 599[2mms[22m[39m
{"level":30,"time":1764876573965,"env":"test","module":"auth-routes","userId":"ZkLpJpJJlFYl0wmYxKyP4","email":"test-7-iwREV0Jj1iklQt23a4w@example.com","msg":"User registered successfully"}
{"level":30,"time":1764876574244,"env":"test","module":"auth-routes","userId":"d10jxWCmn5aHgHPG71Zes","email":"test-WH0_BKZbXl9XmLR-zOQco@example.com","msg":"User registered successfully"}
{"level":30,"time":1764876574438,"env":"test","module":"auth-routes","userId":"NCfR2BzLSDwmCZok3sM01","email":"test-login-7EwGovm2LcIRv0EhR4H4h@example.com","msg":"User registered successfully"}
{"level":30,"time":1764876574562,"env":"test","module":"auth-routes","userId":"NCfR2BzLSDwmCZok3sM01","email":"test-login-7EwGovm2LcIRv0EhR4H4h@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764876574881,"env":"test","module":"auth-routes","userId":"jSaIIvPO7fKFx9s5GG3F9","email":"test-me-6Rl6FjyuWYlEB8MKa7zAB@example.com","msg":"User registered successfully"}
{"level":40,"time":1764876574898,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764876574906,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764876574914,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764876575064,"env":"test","module":"auth-routes","userId":"Ol8GkG8pTKOle39lfgtJr","email":"owner-9lMwOM_2m90KXsJroOV4h@example.com","msg":"User registered successfully"}
{"level":30,"time":1764876575290,"env":"test","module":"tenant-routes","tenantId":"e3e15055-b434-4816-93ac-57681300c6fb","userId":"Ol8GkG8pTKOle39lfgtJr","msg":"Tenant created"}
{"level":30,"time":1764876575360,"env":"test","module":"auth-routes","userId":"bK4JIU1y2cyHDuc3GrrjW","email":"builder-El-At01VQU77jUCe41ypT@example.com","msg":"User registered successfully"}
{"level":30,"time":1764876575463,"env":"test","module":"auth-routes","userId":"cxEN-BmFgfp9UgoubMamV","email":"viewer-4fXDf6GKguNZ4HNVdddQg@example.com","msg":"User registered successfully"}
{"level":40,"time":1764876575623,"env":"test","module":"rbac-middleware","userId":"bK4JIU1y2cyHDuc3GrrjW","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/e3e15055-b434-4816-93ac-57681300c6fb","msg":"Role check failed"}
{"level":40,"time":1764876575627,"env":"test","module":"rbac-middleware","userId":"cxEN-BmFgfp9UgoubMamV","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/e3e15055-b434-4816-93ac-57681300c6fb","msg":"Role check failed"}
{"level":30,"time":1764876575681,"env":"test","module":"tenant-routes","tenantId":"e3e15055-b434-4816-93ac-57681300c6fb","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2266[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should register a new user with email and password [33m 530[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 13:29:20
[2m   Duration [22m 27.13s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/middleware/rbac.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

{"level":40,"time":1764876644755,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764876644988,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764876647737,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764876648285,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764876651881,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764876651881,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764876651893,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764876651894,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764876651894,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764876651894,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764876652306,"env":"test","module":"auth-routes","userId":"EWoGPN07iswmIIyAhQeyu","email":"test-v1uebbJ7x4Hi8yLlWglEM@example.com","msg":"User registered successfully"}
{"level":30,"time":1764876652584,"env":"test","module":"auth-routes","userId":"FXErtm_tnL1FhLOU8iWls","email":"test-ewvoSwtBfuSDLPCvko8LB@example.com","msg":"User registered successfully"}
{"level":30,"time":1764876652716,"env":"test","module":"auth-routes","userId":"MKoB5X7osX7PWeoOFmoBT","email":"test-login-8CKPlnLnILvYMJ6zn-4kP@example.com","msg":"User registered successfully"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764876652748,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764876652749,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764876652763,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764876652763,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764876652764,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764876652764,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764876652818,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764876652819,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764876652829,"env":"test","module":"auth-routes","userId":"MKoB5X7osX7PWeoOFmoBT","email":"test-login-8CKPlnLnILvYMJ6zn-4kP@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764876652857,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764876652858,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764876652865,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764876652904,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764876652904,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764876652921,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764876652941,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764876652943,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764876652944,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764876652945,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764876652968,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764876652976,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764876652999,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764876653007,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764876653007,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764876653008,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764876653016,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764876653023,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764876653031,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 294[2mms[22m[39m
{"level":30,"time":1764876653146,"env":"test","module":"auth-routes","userId":"kll_2OgnQfCJ8pvsD9_i8","email":"test-me-cxNC2AQtkgfHI7Ge5aYz4@example.com","msg":"User registered successfully"}
{"level":40,"time":1764876653162,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764876653171,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764876653194,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764876653327,"env":"test","module":"auth-routes","userId":"9BSMM8CbOVf9nE8k7QxWt","email":"owner-AgFc3F9_Gqmr9pfduXO2J@example.com","msg":"User registered successfully"}
{"level":30,"time":1764876653573,"env":"test","module":"tenant-routes","tenantId":"fb7dc11d-db54-4cff-99b1-297eaff66504","userId":"9BSMM8CbOVf9nE8k7QxWt","msg":"Tenant created"}
{"level":30,"time":1764876653646,"env":"test","module":"auth-routes","userId":"Baqnly_0fZVWqEmC70_XN","email":"builder-wEFvE9IFX5GSyaz6fVFIZ@example.com","msg":"User registered successfully"}
{"level":30,"time":1764876653740,"env":"test","module":"auth-routes","userId":"sNsT1aKsCYVuaAhn-7T0v","email":"viewer-l646KgI_jO7GfRRjYGCzc@example.com","msg":"User registered successfully"}
{"level":40,"time":1764876653961,"env":"test","module":"rbac-middleware","userId":"Baqnly_0fZVWqEmC70_XN","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/fb7dc11d-db54-4cff-99b1-297eaff66504","msg":"Role check failed"}
{"level":40,"time":1764876653966,"env":"test","module":"rbac-middleware","userId":"sNsT1aKsCYVuaAhn-7T0v","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/fb7dc11d-db54-4cff-99b1-297eaff66504","msg":"Role check failed"}
{"level":30,"time":1764876654020,"env":"test","module":"tenant-routes","tenantId":"fb7dc11d-db54-4cff-99b1-297eaff66504","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2150[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should register a new user with email and password [33m 434[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 13:30:40
[2m   Duration [22m 23.63s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/middleware/rbac.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

{"level":40,"time":1764877226794,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764877228255,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764877230164,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764877231749,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764877235266,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764877235267,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764877235279,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764877235279,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764877235280,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764877235280,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764877235394,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764877235440,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764877235459,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764877235461,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764877235462,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764877235471,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764877235503,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764877235503,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764877235516,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764877235516,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764877235518,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764877235518,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764877235520,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764877235540,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764877235550,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764877235550,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764877235553,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764877235553,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:337:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764877235555,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764877235564,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":30,"time":1764877235441,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764877235454,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764877235454,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764877235455,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764877235455,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":40,"time":1764877235570,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764877235578,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 325[2mms[22m[39m
{"level":30,"time":1764877236055,"env":"test","module":"auth-routes","userId":"_qumXE6ogEDNrV9D7Dkgb","email":"test-rvcXE6yYpKsv1nAAmNxTo@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877236500,"env":"test","module":"auth-routes","userId":"pHwHd0KSuJ8llSD3VdytS","email":"test-FV3GW8xt4GSH5b6gEuBKY@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877236616,"env":"test","module":"auth-routes","userId":"IBVvNQ4Dxu4VEkirKtDiL","email":"test-login-Fo6i-h8wMM5JnCTiZ9aQ8@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877236698,"env":"test","module":"auth-routes","userId":"IBVvNQ4Dxu4VEkirKtDiL","email":"test-login-Fo6i-h8wMM5JnCTiZ9aQ8@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764877236879,"env":"test","module":"auth-routes","userId":"VBSta_B4hpINSOAzR0R14","email":"test-me-b76FHfTSFAP4YVV1mmpCN@example.com","msg":"User registered successfully"}
{"level":40,"time":1764877236899,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764877236906,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764877236929,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764877237020,"env":"test","module":"auth-routes","userId":"f2uSfkvB76Uw0J4uEOJr-","email":"owner-kBoh7JrzjR69auLqqZ6Cq@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877237233,"env":"test","module":"tenant-routes","tenantId":"3f0936bd-b2e9-4e5f-9a42-52d689b61427","userId":"f2uSfkvB76Uw0J4uEOJr-","msg":"Tenant created"}
{"level":30,"time":1764877237297,"env":"test","module":"auth-routes","userId":"Py6tsBrJvRzGnXHtz_ynR","email":"builder-k41kqjTr-f1yvbsD7uc4K@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877237365,"env":"test","module":"auth-routes","userId":"pVvVj3lCojwFVEKPnO7hS","email":"viewer-H-JlhMpyP3MCbA3s3wfFo@example.com","msg":"User registered successfully"}
{"level":40,"time":1764877237530,"env":"test","module":"rbac-middleware","userId":"Py6tsBrJvRzGnXHtz_ynR","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/3f0936bd-b2e9-4e5f-9a42-52d689b61427","msg":"Role check failed"}
{"level":40,"time":1764877237535,"env":"test","module":"rbac-middleware","userId":"pVvVj3lCojwFVEKPnO7hS","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/3f0936bd-b2e9-4e5f-9a42-52d689b61427","msg":"Role check failed"}
{"level":30,"time":1764877237586,"env":"test","module":"tenant-routes","tenantId":"3f0936bd-b2e9-4e5f-9a42-52d689b61427","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2158[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should register a new user with email and password [33m 707[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 13:40:22
[2m   Duration [22m 26.13s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/googleAuth.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":40,"time":1764877489100,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764877489186,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764877491793,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764877491797,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764877496609,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764877496620,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764877496609,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764877496620,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764877496621,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764877496621,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764877496621,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764877496620,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764877496636,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764877496636,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764877496637,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764877496637,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764877496722,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764877496723,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764877496725,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764877496725,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764877496731,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764877496751,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764877496751,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764877496840,"env":"test","module":"auth-routes","userId":"FNMioPlGu2Bwwrw_dReg9","email":"test-nS6K4jfQXLuHax_SEm1LX@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877496851,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764877496851,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764877496891,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764877496891,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764877496893,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764877496912,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764877496922,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764877496956,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764877496957,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764877496958,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764877496960,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764877496968,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764877496976,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764877496987,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 391[2mms[22m[39m
{"level":30,"time":1764877497259,"env":"test","module":"auth-routes","userId":"QlHA53y1YbcsK_QQmKp2X","email":"test-305EGTIDkP3eMh3tyqE7y@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877497453,"env":"test","module":"auth-routes","userId":"dqy8dyk5jGdxJLp1437kA","email":"test-login-cz2tu9eOAN0uT8GRe2NrG@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877497570,"env":"test","module":"auth-routes","userId":"dqy8dyk5jGdxJLp1437kA","email":"test-login-cz2tu9eOAN0uT8GRe2NrG@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764877497846,"env":"test","module":"auth-routes","userId":"eMMRHEGMlHMhO8nmJzTpk","email":"test-me-aNpdMHc77QBt9nFzTw0gr@example.com","msg":"User registered successfully"}
{"level":40,"time":1764877497859,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764877497865,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764877497912,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764877498022,"env":"test","module":"auth-routes","userId":"TzOqDpYuNOcemfpR_F5cs","email":"owner-JEtDAwUnGr3VXgY9es7yk@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877498230,"env":"test","module":"tenant-routes","tenantId":"449461e5-6926-47de-8a58-164349b4b7b4","userId":"TzOqDpYuNOcemfpR_F5cs","msg":"Tenant created"}
{"level":30,"time":1764877498300,"env":"test","module":"auth-routes","userId":"rvT5Qzx-w4JxuWp42vLWM","email":"builder---JeaZ3FA_mcqfQKLFVF0@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877498385,"env":"test","module":"auth-routes","userId":"-HN6y2YWe3XI0Y_WU6s0X","email":"viewer-bE4myiYGrhg24fzzj76zV@example.com","msg":"User registered successfully"}
{"level":40,"time":1764877498561,"env":"test","module":"rbac-middleware","userId":"rvT5Qzx-w4JxuWp42vLWM","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/449461e5-6926-47de-8a58-164349b4b7b4","msg":"Role check failed"}
{"level":40,"time":1764877498565,"env":"test","module":"rbac-middleware","userId":"-HN6y2YWe3XI0Y_WU6s0X","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/449461e5-6926-47de-8a58-164349b4b7b4","msg":"Role check failed"}
{"level":30,"time":1764877498612,"env":"test","module":"tenant-routes","tenantId":"449461e5-6926-47de-8a58-164349b4b7b4","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2004[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 13:44:44
[2m   Duration [22m 24.31s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/dashboard.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

{"level":40,"time":1764877821749,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764877822815,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764877824405,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764877825886,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764877828065,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764877828066,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764877828076,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764877828076,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764877828077,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764877828077,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764877828282,"env":"test","module":"auth-routes","userId":"N-glAi6VfdwK1m7vW-D3O","email":"test-bCCZ0GFwCwvwcL2mKCpFk@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877828456,"env":"test","module":"auth-routes","userId":"SbMpRbvzMKc4TFkASui5r","email":"test-Qm9Y3kpnB-UmSgl-rzPww@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877828550,"env":"test","module":"auth-routes","userId":"7JbkZaww2n-seKQva1A_T","email":"test-login-xUYMqItj1qCHUslsnjbGw@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877828623,"env":"test","module":"auth-routes","userId":"7JbkZaww2n-seKQva1A_T","email":"test-login-xUYMqItj1qCHUslsnjbGw@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764877828898,"env":"test","module":"auth-routes","userId":"OZ9su0OQBUxOhugmsezo0","email":"test-me-eGMnWjpx-U6b0vlBPGrQ4@example.com","msg":"User registered successfully"}
{"level":40,"time":1764877828916,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764877828925,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764877829000,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764877829127,"env":"test","module":"auth-routes","userId":"8nYGjXkkQ4n3ukRfpgt_Y","email":"owner-SeuqpsHG5kqTyywaVSRU7@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877829368,"env":"test","module":"tenant-routes","tenantId":"d291d1e2-1b79-4e74-bc29-65e6496aef5c","userId":"8nYGjXkkQ4n3ukRfpgt_Y","msg":"Tenant created"}
{"level":30,"time":1764877829439,"env":"test","module":"auth-routes","userId":"DAh6nkydRA3HXGNuNaVFF","email":"builder-i6_k_9fz9Km2IHy6D8_s4@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877829547,"env":"test","module":"auth-routes","userId":"_pzPOv2N_mP7IP_Bdyin3","email":"viewer-kjUUNc6-OondfChZxbIx8@example.com","msg":"User registered successfully"}
{"level":40,"time":1764877829835,"env":"test","module":"rbac-middleware","userId":"DAh6nkydRA3HXGNuNaVFF","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/d291d1e2-1b79-4e74-bc29-65e6496aef5c","msg":"Role check failed"}
{"level":40,"time":1764877829841,"env":"test","module":"rbac-middleware","userId":"_pzPOv2N_mP7IP_Bdyin3","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/d291d1e2-1b79-4e74-bc29-65e6496aef5c","msg":"Role check failed"}
{"level":30,"time":1764877829902,"env":"test","module":"tenant-routes","tenantId":"d291d1e2-1b79-4e74-bc29-65e6496aef5c","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1849[2mms[22m[39m
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764877830039,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764877830066,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764877830081,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764877830081,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764877830081,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764877830082,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764877830150,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764877830151,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764877830156,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764877830156,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764877830162,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764877830184,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764877830184,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764877830245,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764877830246,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764877830248,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764877830248,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764877830250,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764877830276,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764877830289,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764877830289,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764877830291,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764877830292,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764877830293,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764877830302,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764877830310,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764877830334,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 318[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 13:50:18
[2m   Duration [22m 22.23s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/dashboard.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

{"level":40,"time":1764877838703,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764877838753,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764877840496,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764877840789,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764877844284,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764877844285,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764877844298,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764877844298,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764877844299,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764877844299,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764877844962,"env":"test","module":"auth-routes","userId":"fVR5j9fUg1lmiVlItsfID","email":"test-V81eNcPwihE7XqFUm7ned@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877845390,"env":"test","module":"auth-routes","userId":"6JMyqaN7kv8S4bAkToY47","email":"test-cBdjUbo9WBQgl6wlwVB6f@example.com","msg":"User registered successfully"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764877845528,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764877845585,"env":"test","module":"auth-routes","userId":"WF3DNhQcVZ-VUP_k8k6JH","email":"test-login-Y6BxB6OkbduLjxbTW4Umm@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877845529,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764877845544,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764877845544,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764877845585,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764877845585,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764877845644,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764877845644,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764877845690,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764877845691,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764877845699,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764877845716,"env":"test","module":"auth-routes","userId":"WF3DNhQcVZ-VUP_k8k6JH","email":"test-login-Y6BxB6OkbduLjxbTW4Umm@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764877845731,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764877845731,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764877845796,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764877845797,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764877845798,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764877845798,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764877845800,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764877845819,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764877845831,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764877845831,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764877845900,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764877845900,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764877845916,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764877845932,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764877845941,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764877845949,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 433[2mms[22m[39m
{"level":30,"time":1764877846342,"env":"test","module":"auth-routes","userId":"u5JZMJQWkfGvgd-HtmRCR","email":"test-me-P34P8JiQ4GuRCsi3gNoGm@example.com","msg":"User registered successfully"}
{"level":40,"time":1764877846358,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764877846463,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764877846513,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764877846659,"env":"test","module":"auth-routes","userId":"n6WYpuwpaYwujCkmC9jLb","email":"owner-SxC3rrCq3njHkpfxmBEjN@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877846895,"env":"test","module":"tenant-routes","tenantId":"accd2b48-f78e-488e-bb98-5500e33af3ed","userId":"n6WYpuwpaYwujCkmC9jLb","msg":"Tenant created"}
{"level":30,"time":1764877846973,"env":"test","module":"auth-routes","userId":"G52lsYrx91BeIaHwf7gMl","email":"builder-2SQ7hyayLd9tN-kfRE31T@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877847059,"env":"test","module":"auth-routes","userId":"Kv37XOSziNX8PBrFUcq9d","email":"viewer-_6lukMsye1bFWtNWT_AVq@example.com","msg":"User registered successfully"}
{"level":40,"time":1764877847266,"env":"test","module":"rbac-middleware","userId":"G52lsYrx91BeIaHwf7gMl","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/accd2b48-f78e-488e-bb98-5500e33af3ed","msg":"Role check failed"}
{"level":40,"time":1764877847271,"env":"test","module":"rbac-middleware","userId":"Kv37XOSziNX8PBrFUcq9d","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/accd2b48-f78e-488e-bb98-5500e33af3ed","msg":"Role check failed"}
{"level":30,"time":1764877847318,"env":"test","module":"tenant-routes","tenantId":"accd2b48-f78e-488e-bb98-5500e33af3ed","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 3045[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should register a new user with email and password [33m 673[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject duplicate email registration [33m 359[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 13:50:36
[2m   Duration [22m 19.75s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/dashboard.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

{"level":40,"time":1764877853598,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764877853673,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764877855193,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764877855224,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764877857105,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764877857105,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764877857117,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764877857117,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764877857117,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764877857117,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764877857210,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764877857215,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764877857219,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764877857219,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764877857228,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764877857237,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764877857250,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764877857250,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764877857279,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764877857279,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764877857283,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":30,"time":1764877857237,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764877857249,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764877857249,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764877857249,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764877857249,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":40,"time":1764877857283,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764877857285,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764877857308,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764877857318,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764877857318,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764877857329,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764877857329,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764877857331,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764877857340,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764877857348,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764877857357,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 263[2mms[22m[39m
{"level":30,"time":1764877857415,"env":"test","module":"auth-routes","userId":"BBw89fm3HUYFMLBOxnLOX","email":"test-t80pnlGNRhGN8Zg4LNfSn@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877857519,"env":"test","module":"auth-routes","userId":"wFKyvHnr4b7iv0xYaE3WB","email":"test-zRWodowlmi_kl4B6PjGqR@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877857597,"env":"test","module":"auth-routes","userId":"fvBwYwDW5gdPaEPtRWmG-","email":"test-login-n16P5Nw-NzCng-ip0KJ3h@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877857660,"env":"test","module":"auth-routes","userId":"fvBwYwDW5gdPaEPtRWmG-","email":"test-login-n16P5Nw-NzCng-ip0KJ3h@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764877857826,"env":"test","module":"auth-routes","userId":"yQVMY4SuXyIdziUhLm6eP","email":"test-me-mwGLppEczGFoumzuhTe4Z@example.com","msg":"User registered successfully"}
{"level":40,"time":1764877857838,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764877857843,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764877857848,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764877857913,"env":"test","module":"auth-routes","userId":"NjyijGxxqLCJ8vG-tnFH2","email":"owner-fpWRkjRp9T0CfYN0NNJWw@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877858131,"env":"test","module":"tenant-routes","tenantId":"a56db7c0-3e1c-409d-81b8-ac19e3f2285f","userId":"NjyijGxxqLCJ8vG-tnFH2","msg":"Tenant created"}
{"level":30,"time":1764877858192,"env":"test","module":"auth-routes","userId":"8FxE6NlxSzGpAhjeNxndb","email":"builder-e7uMJMDhixsAD0VeFz6et@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877858256,"env":"test","module":"auth-routes","userId":"unhGyquaIQk7hbZE4KwkB","email":"viewer-gfy_SfYWt6VANjLOKFZeD@example.com","msg":"User registered successfully"}
{"level":40,"time":1764877858421,"env":"test","module":"rbac-middleware","userId":"8FxE6NlxSzGpAhjeNxndb","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/a56db7c0-3e1c-409d-81b8-ac19e3f2285f","msg":"Role check failed"}
{"level":40,"time":1764877858425,"env":"test","module":"rbac-middleware","userId":"unhGyquaIQk7hbZE4KwkB","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/a56db7c0-3e1c-409d-81b8-ac19e3f2285f","msg":"Role check failed"}
{"level":30,"time":1764877858474,"env":"test","module":"tenant-routes","tenantId":"a56db7c0-3e1c-409d-81b8-ac19e3f2285f","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1248[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 13:50:51
[2m   Duration [22m 12.43s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/dashboard.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

{"level":40,"time":1764877864280,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764877864201,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764877866680,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764877867086,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764877870530,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764877870531,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764877870542,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764877870542,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764877870542,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764877870542,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764877870620,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764877870623,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764877870629,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764877870632,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764877870644,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764877870737,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764877870764,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764877870764,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764877870796,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764877870797,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764877870738,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764877870750,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764877870750,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764877870751,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764877870751,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764877870816,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764877870816,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764877870818,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764877870838,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764877870847,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764877870848,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764877870849,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764877870849,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764877870851,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764877870891,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764877870902,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764877870932,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 421[2mms[22m[39m
{"level":30,"time":1764877870980,"env":"test","module":"auth-routes","userId":"RHxJ1YBu3GXD_kBjlrQ3L","email":"test-X3Pt3UJxpHUL3UyvQKDtK@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877871114,"env":"test","module":"auth-routes","userId":"Qeq3p76zU2EkvzJ4R8F42","email":"test-h41NE9m1sU0lHHdjV7i4P@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877871265,"env":"test","module":"auth-routes","userId":"15YPuErA9jAhXbTIQpoeu","email":"test-login-lHSyU7qs-Vxus1e9l5NEG@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877871408,"env":"test","module":"auth-routes","userId":"15YPuErA9jAhXbTIQpoeu","email":"test-login-lHSyU7qs-Vxus1e9l5NEG@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764877871649,"env":"test","module":"auth-routes","userId":"G6qpS_3m0ELEd8UGXQ4Hq","email":"test-me-pAMH9UAfxzp3DY-IJPkCQ@example.com","msg":"User registered successfully"}
{"level":40,"time":1764877871672,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764877871680,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764877871688,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764877871787,"env":"test","module":"auth-routes","userId":"qHz2W0vK-ygqDhcdOlgji","email":"owner-KQVpQMO5GqOEk4NmMZapr@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877872024,"env":"test","module":"tenant-routes","tenantId":"e4adf720-d0aa-401f-af6a-33be34464fdc","userId":"qHz2W0vK-ygqDhcdOlgji","msg":"Tenant created"}
{"level":30,"time":1764877872094,"env":"test","module":"auth-routes","userId":"4myMSp0FJlKLKxHmUfqAU","email":"builder-Bcp67u1mzi4bCwJIQeU0L@example.com","msg":"User registered successfully"}
{"level":30,"time":1764877872171,"env":"test","module":"auth-routes","userId":"9Wy6wKmIeC5-XP_i8cpRT","email":"viewer-F6fsA6eGwCLACQ0eTaN3Q@example.com","msg":"User registered successfully"}
{"level":40,"time":1764877872382,"env":"test","module":"rbac-middleware","userId":"4myMSp0FJlKLKxHmUfqAU","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/e4adf720-d0aa-401f-af6a-33be34464fdc","msg":"Role check failed"}
{"level":40,"time":1764877872388,"env":"test","module":"rbac-middleware","userId":"9Wy6wKmIeC5-XP_i8cpRT","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/e4adf720-d0aa-401f-af6a-33be34464fdc","msg":"Role check failed"}
{"level":30,"time":1764877872435,"env":"test","module":"tenant-routes","tenantId":"e4adf720-d0aa-401f-af6a-33be34464fdc","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1709[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 13:51:00
[2m   Duration [22m 20.81s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/account.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

{"level":40,"time":1764879993328,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764879994099,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764879996139,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764879996376,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880000319,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880000320,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880000331,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880000331,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880000331,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880000331,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880000390,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880000395,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880000397,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880000398,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880000404,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880000424,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764880000424,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764880000496,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880000497,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880000498,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880000498,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880000500,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764880000519,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880000535,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880000536,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880000537,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880000537,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880000539,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880000540,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880000549,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764880000556,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880000601,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 300[2mms[22m[39m
{"level":30,"time":1764880000541,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880000553,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880000553,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880000554,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880000554,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880000842,"env":"test","module":"auth-routes","userId":"ouUifCcDngq8Dq6ze3oTt","email":"test-pK7opo9TBaXe3tnaHEWkM@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880001087,"env":"test","module":"auth-routes","userId":"xDjgAxJQJKa4NSrkSUeza","email":"test-SaVC7hrXJztuEs0Nsa1rZ@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880001205,"env":"test","module":"auth-routes","userId":"vDbu46VWWIcpq8uaeEnut","email":"test-login-TT7LGqPfsXMnJL6mL1186@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880001303,"env":"test","module":"auth-routes","userId":"vDbu46VWWIcpq8uaeEnut","email":"test-login-TT7LGqPfsXMnJL6mL1186@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764880001602,"env":"test","module":"auth-routes","userId":"cPncJXONORb1NLMNs9bQh","email":"test-me-wxXNjuZ1BcMxt4Z2kn25S@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880001620,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764880001646,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764880001671,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764880001800,"env":"test","module":"auth-routes","userId":"7RfsNcyDef2yK6UWWmAYb","email":"owner-iidUKTDg3r2l66NPncGic@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880001998,"env":"test","module":"tenant-routes","tenantId":"cff57ca1-f3af-481a-85dc-b3f08bfdc95a","userId":"7RfsNcyDef2yK6UWWmAYb","msg":"Tenant created"}
{"level":30,"time":1764880002078,"env":"test","module":"auth-routes","userId":"tQpS7gdSKW_sibi9IF-hX","email":"builder-WtYSxcrI-hQNhjtXADDWf@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880002148,"env":"test","module":"auth-routes","userId":"wqUtzUxOURuJm3vm3kqp5","email":"viewer-37h0aLajf3RVl7gMU--og@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880002300,"env":"test","module":"rbac-middleware","userId":"tQpS7gdSKW_sibi9IF-hX","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/cff57ca1-f3af-481a-85dc-b3f08bfdc95a","msg":"Role check failed"}
{"level":40,"time":1764880002303,"env":"test","module":"rbac-middleware","userId":"wqUtzUxOURuJm3vm3kqp5","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/cff57ca1-f3af-481a-85dc-b3f08bfdc95a","msg":"Role check failed"}
{"level":30,"time":1764880002353,"env":"test","module":"tenant-routes","tenantId":"cff57ca1-f3af-481a-85dc-b3f08bfdc95a","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1823[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should register a new user with email and password [33m 303[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 14:26:29
[2m   Duration [22m 21.83s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/account.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":40,"time":1764880005427,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764880005435,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764880006969,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764880006977,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880009268,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880009269,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880009281,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880009281,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880009282,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880009282,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880009332,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880009333,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880009344,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880009344,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880009347,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880009348,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880009424,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880009425,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880009427,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880009428,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880009435,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880009453,"env":"test","module":"auth-routes","userId":"yFRVtMBvqx5QJGhrx7Ysz","email":"test-b2_OMls0sR-u7IzC_oACe@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880009459,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764880009459,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764880009482,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880009482,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880009484,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880009484,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880009486,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764880009505,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880009513,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880009514,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880009516,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880009517,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880009519,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880009530,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764880009538,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880009545,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 224[2mms[22m[39m
{"level":30,"time":1764880009574,"env":"test","module":"auth-routes","userId":"P0Y8VvOnz1A6eEB2txq3I","email":"test-ZM5VPDT_zDFPI6jQedd0k@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880009648,"env":"test","module":"auth-routes","userId":"UMEodsBIYUi9fRsWK9xyj","email":"test-login-4plr8ICpPfyqWyT274frH@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880009711,"env":"test","module":"auth-routes","userId":"UMEodsBIYUi9fRsWK9xyj","email":"test-login-4plr8ICpPfyqWyT274frH@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764880009855,"env":"test","module":"auth-routes","userId":"B1bQtyu-digcpXHU9rCcx","email":"test-me-o2fdFdMFH20VK_nE6qhNL@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880009869,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764880009875,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764880009881,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764880009951,"env":"test","module":"auth-routes","userId":"EtOLlbNw9mUVTN0e5mZeF","email":"owner-uEj7cyPfvshtxdGv2-hbM@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880010157,"env":"test","module":"tenant-routes","tenantId":"762c541d-d431-4940-846b-8909409fa914","userId":"EtOLlbNw9mUVTN0e5mZeF","msg":"Tenant created"}
{"level":30,"time":1764880010231,"env":"test","module":"auth-routes","userId":"LkNNI3XGHNtu4UXz9qm8b","email":"builder-seFx4rzjwMYiMI9iWlsWt@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880010301,"env":"test","module":"auth-routes","userId":"teChNMBfFpK1S5PhV5pP8","email":"viewer-zJbET_M5UYOcI4Are7qe1@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880010455,"env":"test","module":"rbac-middleware","userId":"LkNNI3XGHNtu4UXz9qm8b","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/762c541d-d431-4940-846b-8909409fa914","msg":"Role check failed"}
{"level":40,"time":1764880010461,"env":"test","module":"rbac-middleware","userId":"teChNMBfFpK1S5PhV5pP8","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/762c541d-d431-4940-846b-8909409fa914","msg":"Role check failed"}
{"level":30,"time":1764880010506,"env":"test","module":"tenant-routes","tenantId":"762c541d-d431-4940-846b-8909409fa914","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1255[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 14:26:43
[2m   Duration [22m 13.06s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/account.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

{"level":40,"time":1764880015059,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764880015618,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764880017789,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764880017914,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880021039,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880021040,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880021052,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880021052,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880021053,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880021053,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880021155,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880021156,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880021158,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880021159,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880021167,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880021223,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764880021223,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764880021236,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880021236,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880021238,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880021238,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880021239,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764880021263,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880021274,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880021274,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880021325,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880021325,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880021326,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880021335,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":30,"time":1764880021339,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":40,"time":1764880021345,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880021455,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 429[2mms[22m[39m
{"level":30,"time":1764880021340,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880021392,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880021392,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880021392,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880021392,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880021653,"env":"test","module":"auth-routes","userId":"vt7lczJvaKiGg3OdL-Zkz","email":"test-c5p3tk_xD7kfIEmdYD-WK@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880021829,"env":"test","module":"auth-routes","userId":"1Wt6lTC9sOfNpp_jI15Sr","email":"test-DZZQqvkoe7qZ1iDeXYzYg@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880021922,"env":"test","module":"auth-routes","userId":"_f7VLlv3xaNjO_VSWkB9n","email":"test-login-Z_9LmheE0z7jSrKukUxRC@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880022017,"env":"test","module":"auth-routes","userId":"_f7VLlv3xaNjO_VSWkB9n","email":"test-login-Z_9LmheE0z7jSrKukUxRC@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764880022256,"env":"test","module":"auth-routes","userId":"FghE5ind2KuGsqFo5yWlF","email":"test-me-l7dLwCaBrDbaakPX9bDSy@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880022308,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764880022314,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764880022321,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764880022610,"env":"test","module":"auth-routes","userId":"9IIWQDLprEdU40A4r43p4","email":"owner-gCje0wNcfN1c2zDRXeSm8@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880022885,"env":"test","module":"tenant-routes","tenantId":"6d46ce10-d752-49b6-9219-ba51cf449d45","userId":"9IIWQDLprEdU40A4r43p4","msg":"Tenant created"}
{"level":30,"time":1764880022953,"env":"test","module":"auth-routes","userId":"qBbmhU8qb2J4a7YB649R_","email":"builder-YwGIpJc1iJ5hUaqBFhxh3@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880023033,"env":"test","module":"auth-routes","userId":"rmFW_Ws-2_LtrPtAS88pz","email":"viewer-pqa02MbrQmkGnUbeyJILM@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880023344,"env":"test","module":"rbac-middleware","userId":"qBbmhU8qb2J4a7YB649R_","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/6d46ce10-d752-49b6-9219-ba51cf449d45","msg":"Role check failed"}
{"level":40,"time":1764880023350,"env":"test","module":"rbac-middleware","userId":"rmFW_Ws-2_LtrPtAS88pz","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/6d46ce10-d752-49b6-9219-ba51cf449d45","msg":"Role check failed"}
{"level":30,"time":1764880023415,"env":"test","module":"tenant-routes","tenantId":"6d46ce10-d752-49b6-9219-ba51cf449d45","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2088[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 14:26:51
[2m   Duration [22m 20.41s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/runs.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

{"level":40,"time":1764880066193,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764880067739,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764880068911,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764880070446,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880073662,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880073662,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880073674,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880073674,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880073674,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880073674,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880073864,"env":"test","module":"auth-routes","userId":"M3wp_4o_4l8MEdA9XgO0q","email":"test-LtQaxOkON7f-GGUryueXE@example.com","msg":"User registered successfully"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880074112,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880074164,"env":"test","module":"auth-routes","userId":"oEZZ4hh0wUbWLZbYGu7tt","email":"test-P65TOIGDYjSgGzyWRfi3t@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880074113,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880074127,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880074128,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880074128,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880074128,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880074222,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880074223,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880074234,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880074235,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880074241,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880074261,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764880074261,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764880074273,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880074281,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880074283,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880074284,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880074285,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764880074302,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880074311,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880074311,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880074312,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880074312,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880074313,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880074320,"env":"test","module":"auth-routes","userId":"1YubBlF4JLImgYds3CB7X","email":"test-login-dcZ0_r-M2oCoG9ue1XBts@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880074321,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764880074330,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880074340,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 240[2mms[22m[39m
{"level":30,"time":1764880074412,"env":"test","module":"auth-routes","userId":"1YubBlF4JLImgYds3CB7X","email":"test-login-dcZ0_r-M2oCoG9ue1XBts@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764880074685,"env":"test","module":"auth-routes","userId":"4S4kE-AtFuTuKxb6KFWlg","email":"test-me-jJQ2KpmxWJSFN2_bWqS6h@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880074699,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764880074704,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764880074749,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764880074849,"env":"test","module":"auth-routes","userId":"OE4fv-WedtQAfPKuScPd4","email":"owner-pJ1ZZb2wHwCQI7B7QC5WW@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880075069,"env":"test","module":"tenant-routes","tenantId":"131e7ea9-f277-485a-af05-0080ff0b9fc5","userId":"OE4fv-WedtQAfPKuScPd4","msg":"Tenant created"}
{"level":30,"time":1764880075139,"env":"test","module":"auth-routes","userId":"PLtSXXH4LokfaFCQX4TUq","email":"builder-zm-QbOUQ4mUX4spvTxeHK@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880075210,"env":"test","module":"auth-routes","userId":"L7Gc55M4NIf0o2KAgq8ZC","email":"viewer-64zYys8dMd_g3eqh39X0q@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880075380,"env":"test","module":"rbac-middleware","userId":"PLtSXXH4LokfaFCQX4TUq","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/131e7ea9-f277-485a-af05-0080ff0b9fc5","msg":"Role check failed"}
{"level":40,"time":1764880075385,"env":"test","module":"rbac-middleware","userId":"L7Gc55M4NIf0o2KAgq8ZC","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/131e7ea9-f277-485a-af05-0080ff0b9fc5","msg":"Role check failed"}
{"level":30,"time":1764880075434,"env":"test","module":"tenant-routes","tenantId":"131e7ea9-f277-485a-af05-0080ff0b9fc5","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1784[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 14:27:42
[2m   Duration [22m 23.23s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/collections.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

{"level":40,"time":1764880086534,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764880087041,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764880088407,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764880089759,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880092237,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880092237,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880092250,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880092251,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880092251,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880092251,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880092493,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880092494,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880092518,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880092519,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880092527,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880092558,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764880092558,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764880092609,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880092609,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880092611,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880092611,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880092614,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764880092635,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880092660,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880092660,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880092730,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880092733,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880092735,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880092743,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764880092808,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880092820,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 598[2mms[22m[39m
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880093462,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880093463,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880093473,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880093473,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880093474,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880093474,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880093707,"env":"test","module":"auth-routes","userId":"ReiGJNragjE4VYyXovSo7","email":"test-4_wuGId_TbUxXZqyTyhey@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880094047,"env":"test","module":"auth-routes","userId":"6QKstuK1qXMhh38mxc_eV","email":"test-v8iXkj6Fj3LkLsc_65wOk@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880094175,"env":"test","module":"auth-routes","userId":"UDVUNStF4VU33Mg1JVSML","email":"test-login-JJJgQfJPXa-HU7kgwtGqd@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880094299,"env":"test","module":"auth-routes","userId":"UDVUNStF4VU33Mg1JVSML","email":"test-login-JJJgQfJPXa-HU7kgwtGqd@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764880094566,"env":"test","module":"auth-routes","userId":"mR8YA_ycHMMpI2DowZ516","email":"test-me-ljtRKtqtu_Y_xCFau7LF5@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880094582,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764880094588,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764880094596,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764880094685,"env":"test","module":"auth-routes","userId":"PwFKPpEOPJQ4aaRyRsXll","email":"owner-Rn4np9OhrJUmsG_TqHW1K@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880094974,"env":"test","module":"tenant-routes","tenantId":"e12804cd-c095-4e45-94c2-c1a7e106d79a","userId":"PwFKPpEOPJQ4aaRyRsXll","msg":"Tenant created"}
{"level":30,"time":1764880095045,"env":"test","module":"auth-routes","userId":"c_KPOjLnd1RkXDP6KsQEP","email":"builder-6_hzsiWVg9PpfQZE6l8VC@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880095163,"env":"test","module":"auth-routes","userId":"agu6q-RkTZZj_OmNH3VnD","email":"viewer-STeT-G1_fuvIiWsb0rPNy@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880095318,"env":"test","module":"rbac-middleware","userId":"c_KPOjLnd1RkXDP6KsQEP","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/e12804cd-c095-4e45-94c2-c1a7e106d79a","msg":"Role check failed"}
{"level":40,"time":1764880095322,"env":"test","module":"rbac-middleware","userId":"agu6q-RkTZZj_OmNH3VnD","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/e12804cd-c095-4e45-94c2-c1a7e106d79a","msg":"Role check failed"}
{"level":30,"time":1764880095374,"env":"test","module":"tenant-routes","tenantId":"e12804cd-c095-4e45-94c2-c1a7e106d79a","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1923[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 14:28:03
[2m   Duration [22m 19.84s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/collections.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":40,"time":1764880100204,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764880100209,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764880101610,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764880101672,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880103784,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880103785,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880103796,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880103796,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880103796,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880103796,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880104019,"env":"test","module":"auth-routes","userId":"ezWItsR-0Hb9pLmv3R3zB","email":"test-mpzy9xbJk3aYqhcNZabuX@example.com","msg":"User registered successfully"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880104064,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880104065,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880104078,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880104078,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880104078,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880104078,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880104142,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880104143,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880104151,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880104151,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880104158,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880104167,"env":"test","module":"auth-routes","userId":"qoic1uS6S-ZJp0MGqGTaw","email":"test-dfDKkO7b6YRouxVjMdfJC@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880104181,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764880104181,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764880104194,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880104195,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880104196,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880104196,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880104197,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764880104214,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880104222,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880104222,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880104223,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880104223,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880104225,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880104232,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":30,"time":1764880104241,"env":"test","module":"auth-routes","userId":"nOE2rIE_G8x9EEbdJjBpW","email":"test-login-8I8h4DnyZTA5fEXd1mRTS@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880104243,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880104251,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 199[2mms[22m[39m
{"level":30,"time":1764880104350,"env":"test","module":"auth-routes","userId":"nOE2rIE_G8x9EEbdJjBpW","email":"test-login-8I8h4DnyZTA5fEXd1mRTS@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764880104539,"env":"test","module":"auth-routes","userId":"XBOkIrpPkYJxDFe6iWXUh","email":"test-me-tHAXjjei5wUbT-ekMFG9K@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880104560,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764880104567,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764880104583,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764880104651,"env":"test","module":"auth-routes","userId":"Bcqz93JTD2e5EsjOqb6zt","email":"owner-o8Ovi4fgIJIVyarhETQDN@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880104881,"env":"test","module":"tenant-routes","tenantId":"e112a79c-9bb5-44ed-a1aa-b0fe891ba158","userId":"Bcqz93JTD2e5EsjOqb6zt","msg":"Tenant created"}
{"level":30,"time":1764880104946,"env":"test","module":"auth-routes","userId":"f648OO-2LUVpa6n5CVWV_","email":"builder-vKzcFMT48CZbcvFzgi73j@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880105009,"env":"test","module":"auth-routes","userId":"yHKnEVOElRtVbNOLrENbD","email":"viewer-Z0lRAVAxesx86NLkxid9C@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880105178,"env":"test","module":"rbac-middleware","userId":"f648OO-2LUVpa6n5CVWV_","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/e112a79c-9bb5-44ed-a1aa-b0fe891ba158","msg":"Role check failed"}
{"level":40,"time":1764880105182,"env":"test","module":"rbac-middleware","userId":"yHKnEVOElRtVbNOLrENbD","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/e112a79c-9bb5-44ed-a1aa-b0fe891ba158","msg":"Role check failed"}
{"level":30,"time":1764880105246,"env":"test","module":"tenant-routes","tenantId":"e112a79c-9bb5-44ed-a1aa-b0fe891ba158","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1473[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 14:28:17
[2m   Duration [22m 13.25s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/sections.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

{"level":40,"time":1764880140374,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764880141039,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764880142817,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764880144171,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880147659,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880147660,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880147672,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880147672,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880147672,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880147672,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880147755,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880147755,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880147757,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880147757,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880147764,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880147853,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764880147853,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764880147880,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880147880,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880148003,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880148004,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880148006,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764880148028,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880148040,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880148040,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880148071,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880148071,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880148122,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880148132,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764880148147,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880148176,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 571[2mms[22m[39m
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880148249,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880148250,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880148296,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880148296,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880148297,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880148297,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880148567,"env":"test","module":"auth-routes","userId":"GkeDxZSvOP3dok0faHhAw","email":"test-TPm1G7gzai0tnE-NY5uFI@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880148738,"env":"test","module":"auth-routes","userId":"FFpnFJySblUwO6WKLk0Gr","email":"test-PUgWCasWvY5-SXEM2rkC2@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880148853,"env":"test","module":"auth-routes","userId":"Ja0SqvnbGdPLqe6S5PkM-","email":"test-login-iroO7VfhMVxmzKT9fLGZg@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880148986,"env":"test","module":"auth-routes","userId":"Ja0SqvnbGdPLqe6S5PkM-","email":"test-login-iroO7VfhMVxmzKT9fLGZg@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764880149209,"env":"test","module":"auth-routes","userId":"uS-wiFf65JoEAsdnEwyL5","email":"test-me-VXwQlqkO2rPFcUIvGgcD9@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880149249,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764880149255,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764880149265,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764880149372,"env":"test","module":"auth-routes","userId":"oCrPq7CK5n8p405Ry8CfE","email":"owner-BEak4ZPchaBEUeyO4i8LL@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880149580,"env":"test","module":"tenant-routes","tenantId":"7da1540c-bd84-4c49-84b7-d119a62ca8a6","userId":"oCrPq7CK5n8p405Ry8CfE","msg":"Tenant created"}
{"level":30,"time":1764880149672,"env":"test","module":"auth-routes","userId":"MRnON6hdbtdys4Wl6SEqk","email":"builder-q2vaOvBtsLETqS82Wq15K@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880149733,"env":"test","module":"auth-routes","userId":"ojeMMHrB6Tw3OrseLiE3_","email":"viewer-x8GGrJq7B0SwG7A9Vx6Zq@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880149881,"env":"test","module":"rbac-middleware","userId":"MRnON6hdbtdys4Wl6SEqk","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/7da1540c-bd84-4c49-84b7-d119a62ca8a6","msg":"Role check failed"}
{"level":40,"time":1764880149886,"env":"test","module":"rbac-middleware","userId":"ojeMMHrB6Tw3OrseLiE3_","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/7da1540c-bd84-4c49-84b7-d119a62ca8a6","msg":"Role check failed"}
{"level":30,"time":1764880149936,"env":"test","module":"tenant-routes","tenantId":"7da1540c-bd84-4c49-84b7-d119a62ca8a6","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1698[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 14:28:56
[2m   Duration [22m 23.76s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/secrets.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

{"level":40,"time":1764880169517,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764880169537,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764880171946,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764880172041,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880174828,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880174831,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880174841,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880174841,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880174842,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880174842,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880175150,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880175172,"env":"test","module":"auth-routes","userId":"QpHWU3wZJcNY3rjQ7ERRY","email":"test-ZmedP5FhcTo2XHQLjjk3E@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880175150,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880175161,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880175161,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880175161,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880175161,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880175213,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880175214,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880175215,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880175216,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880175222,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880175241,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764880175241,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764880175292,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880175292,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880175319,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880175319,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880175320,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764880175339,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880175348,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880175349,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880175350,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880175350,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880175352,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880175358,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764880175365,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880175372,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 234[2mms[22m[39m
{"level":30,"time":1764880175411,"env":"test","module":"auth-routes","userId":"9KZyOxMLgyBk1sELaguSW","email":"test-l0UHSDmKSuiiVIpjIvy6-@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880175506,"env":"test","module":"auth-routes","userId":"NLLbLN-jT9c56ia0rPj9p","email":"test-login-XwkgIdyhdKUulOA7I1Lgf@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880175569,"env":"test","module":"auth-routes","userId":"NLLbLN-jT9c56ia0rPj9p","email":"test-login-XwkgIdyhdKUulOA7I1Lgf@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764880175752,"env":"test","module":"auth-routes","userId":"ClC-GkBmm0Pb71Zu7nIR4","email":"test-me-qL82KAIutn-sfHAT7bjfh@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880175767,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764880175772,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764880175777,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764880175909,"env":"test","module":"auth-routes","userId":"3YX__O50huNZYy1a1P3k4","email":"owner-3hBe6-iBH0SdqyaRzQ4PF@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880176123,"env":"test","module":"tenant-routes","tenantId":"b1b63ba5-d358-4401-ac49-290c2a2794ec","userId":"3YX__O50huNZYy1a1P3k4","msg":"Tenant created"}
{"level":30,"time":1764880176189,"env":"test","module":"auth-routes","userId":"4f7hSbmNts03kWAj61RsD","email":"builder-86YO4NGBwVXGD0KKS1HTL@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880176294,"env":"test","module":"auth-routes","userId":"PVVZGuPQm0FkE7yfN21WE","email":"viewer-kKvyfG038JVoeTjxhmQvB@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880176471,"env":"test","module":"rbac-middleware","userId":"4f7hSbmNts03kWAj61RsD","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/b1b63ba5-d358-4401-ac49-290c2a2794ec","msg":"Role check failed"}
{"level":40,"time":1764880176475,"env":"test","module":"rbac-middleware","userId":"PVVZGuPQm0FkE7yfN21WE","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/b1b63ba5-d358-4401-ac49-290c2a2794ec","msg":"Role check failed"}
{"level":30,"time":1764880176526,"env":"test","module":"tenant-routes","tenantId":"b1b63ba5-d358-4401-ac49-290c2a2794ec","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1710[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should register a new user with email and password [33m 334[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 14:29:25
[2m   Duration [22m 19.03s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/secrets.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

{"level":40,"time":1764880182618,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764880182713,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764880184385,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764880184393,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880186631,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880186632,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880186642,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880186643,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880186643,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880186643,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880186817,"env":"test","module":"auth-routes","userId":"VyNtVUVoQUrBVbgYhgnmC","email":"test-AcvmW4xIZjPspnoIZvKjZ@example.com","msg":"User registered successfully"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880186852,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880186852,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880186864,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880186864,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880186885,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880186885,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880186994,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880186995,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880187000,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880187001,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880187009,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880187020,"env":"test","module":"auth-routes","userId":"-JZWBeDu9JOs2eIUKcDtQ","email":"test-_DsswHATuZIzh9Ayr-dE0@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880187034,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764880187035,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764880187052,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880187052,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880187054,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880187054,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880187055,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764880187075,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880187092,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880187092,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880187093,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880187094,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880187095,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880187103,"env":"test","module":"auth-routes","userId":"xtV6EpRCHbSkNrjT1rs4G","email":"test-login-7QX0ap41PFv-wzOsaXWvv@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880187104,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764880187111,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880187120,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 288[2mms[22m[39m
{"level":30,"time":1764880187174,"env":"test","module":"auth-routes","userId":"xtV6EpRCHbSkNrjT1rs4G","email":"test-login-7QX0ap41PFv-wzOsaXWvv@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764880187634,"env":"test","module":"auth-routes","userId":"A0igH5dshEfZpe-vU4KM3","email":"test-me-1h7elBg8T8n9o0hGIZnEd@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880187701,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764880187707,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764880187721,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764880187823,"env":"test","module":"auth-routes","userId":"wtm-yWQ4SC_ApRqDMrzFR","email":"owner-L7TztW3iuYFE3te-rkhzb@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880188037,"env":"test","module":"tenant-routes","tenantId":"7a4a372c-8538-413d-85d0-e119a18039c4","userId":"wtm-yWQ4SC_ApRqDMrzFR","msg":"Tenant created"}
{"level":30,"time":1764880188110,"env":"test","module":"auth-routes","userId":"ogVKpB9cr5Buf6KCHHCnf","email":"builder-nKU_aMZLFaW356NPf4JJL@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880188189,"env":"test","module":"auth-routes","userId":"HoY3Cd2M8IomaSRw4zX3t","email":"viewer-yQDh2p8woKPBaz48jAjO7@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880188345,"env":"test","module":"rbac-middleware","userId":"ogVKpB9cr5Buf6KCHHCnf","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/7a4a372c-8538-413d-85d0-e119a18039c4","msg":"Role check failed"}
{"level":40,"time":1764880188350,"env":"test","module":"rbac-middleware","userId":"HoY3Cd2M8IomaSRw4zX3t","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/7a4a372c-8538-413d-85d0-e119a18039c4","msg":"Role check failed"}
{"level":30,"time":1764880188402,"env":"test","module":"tenant-routes","tenantId":"7a4a372c-8538-413d-85d0-e119a18039c4","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1782[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 14:29:40
[2m   Duration [22m 14.41s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/steps.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

{"level":40,"time":1764880218205,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764880218551,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764880220988,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764880221098,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880225104,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880225105,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880225121,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880225121,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880225121,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880225121,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880225325,"env":"test","module":"auth-routes","userId":"dJGf9VXkDAmFGHy4c-0eK","email":"test-bzjRj9g4oZSf6acmwarbV@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880225330,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880225331,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880225344,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880225344,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880225344,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880225345,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880225520,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880225521,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880225523,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880225524,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880225533,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880225556,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764880225556,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764880225568,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880225568,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880225570,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880225570,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880225571,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764880225592,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880225603,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880225603,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880225657,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":30,"time":1764880225657,"env":"test","module":"auth-routes","userId":"d3v6xEYFKWKjksPSMd5Hd","email":"test-Y1RCVpR98epkNtCEs7sEv@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880225657,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880225658,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880225668,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764880225708,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880225718,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 401[2mms[22m[39m
{"level":30,"time":1764880225848,"env":"test","module":"auth-routes","userId":"3ebPzp_PxQ2_JNahpMiHW","email":"test-login-EGhHttAHiVlELDIMrXmIE@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880225998,"env":"test","module":"auth-routes","userId":"3ebPzp_PxQ2_JNahpMiHW","email":"test-login-EGhHttAHiVlELDIMrXmIE@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764880226202,"env":"test","module":"auth-routes","userId":"TxLI3X1baFML3NfV-ZxzJ","email":"test-me-pBcQqwRl8uOIPeycVU0vx@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880226263,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764880226300,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764880226309,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764880226421,"env":"test","module":"auth-routes","userId":"wL59MFRDxvYRU4LmN4Kac","email":"owner--GhZ1rMHnJkIq81E7mTPc@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880226759,"env":"test","module":"tenant-routes","tenantId":"868eed2f-5073-4c49-a366-dc71bbbaea94","userId":"wL59MFRDxvYRU4LmN4Kac","msg":"Tenant created"}
{"level":30,"time":1764880226827,"env":"test","module":"auth-routes","userId":"zEqVXXPIhGfLhSSM_ZBWS","email":"builder-TXip4uuuRUgpyoE_WowBz@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880226925,"env":"test","module":"auth-routes","userId":"WoRx6cDyq8DLsvirRJqvk","email":"viewer-ndYP9aeHxPuHDNS-oc3q4@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880227106,"env":"test","module":"rbac-middleware","userId":"zEqVXXPIhGfLhSSM_ZBWS","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/868eed2f-5073-4c49-a366-dc71bbbaea94","msg":"Role check failed"}
{"level":40,"time":1764880227110,"env":"test","module":"rbac-middleware","userId":"WoRx6cDyq8DLsvirRJqvk","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/868eed2f-5073-4c49-a366-dc71bbbaea94","msg":"Role check failed"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2071[2mms[22m[39m
{"level":30,"time":1764880227159,"env":"test","module":"tenant-routes","tenantId":"868eed2f-5073-4c49-a366-dc71bbbaea94","msg":"Tenant updated"}

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 14:30:14
[2m   Duration [22m 22.21s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/userPreferences.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

{"level":40,"time":1764880255726,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764880256580,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764880258398,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764880259091,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880262310,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880262311,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880262322,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880262322,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880262322,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880262322,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880262438,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880262439,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880262440,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880262441,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880262485,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880262511,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764880262511,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764880262560,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880262560,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880262561,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880262561,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880262563,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764880262590,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880262604,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880262604,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880262630,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880262631,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880262632,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880262640,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764880262648,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880262656,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 357[2mms[22m[39m
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880263034,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880263035,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880263045,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880263045,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880263046,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880263046,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880263262,"env":"test","module":"auth-routes","userId":"7tcJf81yd6aRETccLiHq4","email":"test-9uCzKgIvZsdQOwQo5nax5@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880263616,"env":"test","module":"auth-routes","userId":"UztzEpBa5GQXeA6d_qucG","email":"test-TGP34C_3nxPK1xDcw1Av8@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880263813,"env":"test","module":"auth-routes","userId":"VwWFhI7edNsZC4jFRq5Hx","email":"test-login--_EVWsQ1tcjN6S_XBlDgo@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880263930,"env":"test","module":"auth-routes","userId":"VwWFhI7edNsZC4jFRq5Hx","email":"test-login--_EVWsQ1tcjN6S_XBlDgo@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764880264100,"env":"test","module":"auth-routes","userId":"K9GXxj-9t5KBTJdNIWWIK","email":"test-me-_PklD_DEDTEei_SGIk8DV@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880264114,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764880264121,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764880264129,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764880264221,"env":"test","module":"auth-routes","userId":"lzAIIrkAz48GirDejoszE","email":"owner-xX3PSpUw1KbEfY246JlFk@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880264458,"env":"test","module":"tenant-routes","tenantId":"06d3d6cc-121c-4239-89da-affb3bc989bf","userId":"lzAIIrkAz48GirDejoszE","msg":"Tenant created"}
{"level":30,"time":1764880264523,"env":"test","module":"auth-routes","userId":"KCpMwDIQMuIpddd_UtRtK","email":"builder-eJ1j_DljtmqMZ4xVy1CHf@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880264603,"env":"test","module":"auth-routes","userId":"AMKyjHFWLpumb51ecEiv8","email":"viewer-7HGIw0zIAkeNHQVCEPXH3@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880264784,"env":"test","module":"rbac-middleware","userId":"KCpMwDIQMuIpddd_UtRtK","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/06d3d6cc-121c-4239-89da-affb3bc989bf","msg":"Role check failed"}
{"level":40,"time":1764880264789,"env":"test","module":"rbac-middleware","userId":"AMKyjHFWLpumb51ecEiv8","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/06d3d6cc-121c-4239-89da-affb3bc989bf","msg":"Role check failed"}
{"level":30,"time":1764880264849,"env":"test","module":"tenant-routes","tenantId":"06d3d6cc-121c-4239-89da-affb3bc989bf","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1830[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 14:30:52
[2m   Duration [22m 21.44s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/versions.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

{"level":40,"time":1764880267079,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764880267090,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764880268580,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764880268594,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880270957,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880270957,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880270968,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880270969,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880270969,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880270969,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880271003,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880271003,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880271014,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880271014,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880271015,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880271015,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880271076,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880271077,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880271078,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880271079,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880271085,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880271105,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764880271105,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764880271111,"env":"test","module":"auth-routes","userId":"C58DP-v6DveDgZN2A09vg","email":"test-y93R1bTxeFCynm5DYLHhC@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880271117,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880271117,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880271119,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880271119,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880271121,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764880271140,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880271149,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880271150,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880271152,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880271152,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880271153,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880271162,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764880271170,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880271180,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 190[2mms[22m[39m
{"level":30,"time":1764880271231,"env":"test","module":"auth-routes","userId":"MVlevvaSljt6Iwf7yGQrA","email":"test-lJyPsq8PwUZxS_Hrs2hCK@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880271320,"env":"test","module":"auth-routes","userId":"PURXyHpMNil08Q45S7zwq","email":"test-login-FlfcCKtvIeLuXcTgW5IBn@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880271392,"env":"test","module":"auth-routes","userId":"PURXyHpMNil08Q45S7zwq","email":"test-login-FlfcCKtvIeLuXcTgW5IBn@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764880271555,"env":"test","module":"auth-routes","userId":"GfO5cvNr5BiGgR8Veuhze","email":"test-me-HRYDBM5upfweEyjYr_Z5Q@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880271570,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764880271576,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764880271595,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764880271676,"env":"test","module":"auth-routes","userId":"vgs2wvNiUok6ka0-5B4v6","email":"owner-deYAi0Xa8bWhQ8AYtwmHZ@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880271945,"env":"test","module":"tenant-routes","tenantId":"c6234eb7-802f-403d-b2e2-cc5cc3ff3394","userId":"vgs2wvNiUok6ka0-5B4v6","msg":"Tenant created"}
{"level":30,"time":1764880272013,"env":"test","module":"auth-routes","userId":"E_UrqfwZfethrIFjaWmGF","email":"builder-tUlfrNiQRzZDefJ4Uk5Ni@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880272087,"env":"test","module":"auth-routes","userId":"9yiUmp0C1ZQAaDdLpiJ9O","email":"viewer-6iPX-C_nZw3CdJBSqWBuT@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880272249,"env":"test","module":"rbac-middleware","userId":"E_UrqfwZfethrIFjaWmGF","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/c6234eb7-802f-403d-b2e2-cc5cc3ff3394","msg":"Role check failed"}
{"level":40,"time":1764880272256,"env":"test","module":"rbac-middleware","userId":"9yiUmp0C1ZQAaDdLpiJ9O","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/c6234eb7-802f-403d-b2e2-cc5cc3ff3394","msg":"Role check failed"}
{"level":30,"time":1764880272310,"env":"test","module":"tenant-routes","tenantId":"c6234eb7-802f-403d-b2e2-cc5cc3ff3394","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1363[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 14:31:04
[2m   Duration [22m 12.90s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/workflowExports.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

{"level":40,"time":1764880274976,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764880275219,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764880276868,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764880277356,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880280555,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880280556,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880280566,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880280566,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880280567,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880280567,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880281193,"env":"test","module":"auth-routes","userId":"RHdWNDs16JYap_8Scy3Kf","email":"test-mDqF_OtcZsMY3nOO1VWHO@example.com","msg":"User registered successfully"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880281240,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880281240,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880281251,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880281251,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880281252,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880281252,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880281398,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880281403,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880281405,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880281495,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880281504,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880281582,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764880281582,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764880281623,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880281624,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880281657,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880281658,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880281660,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764880281683,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880281693,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880281693,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880281724,"env":"test","module":"auth-routes","userId":"-Yw8r61SDR23iA717IGYs","email":"test-E6ORKjR8A7Xp__cPB75Lu@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880281757,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880281757,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880281758,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880281767,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764880281776,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880281787,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 560[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should successfully log in with valid Google ID token [33m 318[2mms[22m[39m
{"level":30,"time":1764880281966,"env":"test","module":"auth-routes","userId":"YQLOBL2ZD8iPNXaCA5YhG","email":"test-login-ebI855ACPjx3ZnfGkpF-t@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880282055,"env":"test","module":"auth-routes","userId":"YQLOBL2ZD8iPNXaCA5YhG","email":"test-login-ebI855ACPjx3ZnfGkpF-t@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764880282658,"env":"test","module":"auth-routes","userId":"QQEYjbzu5BEpGswnn3q0C","email":"test-me-4h5hAyN8D5lbnyyzD8dGX@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880282715,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764880282722,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764880282758,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764880282943,"env":"test","module":"auth-routes","userId":"so9k6ZFHX_rPVOdvin_Yh","email":"owner-yIvsv9FfXwf5_GCcc5dUp@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880283190,"env":"test","module":"tenant-routes","tenantId":"7b15108c-4d19-40a4-820b-39e93c82ec0a","userId":"so9k6ZFHX_rPVOdvin_Yh","msg":"Tenant created"}
{"level":30,"time":1764880283256,"env":"test","module":"auth-routes","userId":"pJSytHpExh3f8wg3p1M_1","email":"builder-SUye9XGSkbx5Em2Dw1noQ@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880283411,"env":"test","module":"auth-routes","userId":"2lrr79M1JVYGOMLTSlReQ","email":"viewer-4p7XBBRivQ4uDxctUe4f8@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880283808,"env":"test","module":"rbac-middleware","userId":"pJSytHpExh3f8wg3p1M_1","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/7b15108c-4d19-40a4-820b-39e93c82ec0a","msg":"Role check failed"}
{"level":40,"time":1764880283814,"env":"test","module":"rbac-middleware","userId":"2lrr79M1JVYGOMLTSlReQ","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/7b15108c-4d19-40a4-820b-39e93c82ec0a","msg":"Role check failed"}
{"level":30,"time":1764880283864,"env":"test","module":"tenant-routes","tenantId":"7b15108c-4d19-40a4-820b-39e93c82ec0a","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 3320[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should register a new user with email and password [33m 700[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject login with wrong password [33m 350[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 14:31:12
[2m   Duration [22m 20.03s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/userPreferences.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

{"level":40,"time":1764880293926,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764880294082,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764880295795,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764880295853,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880298975,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880298975,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880298994,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880298995,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880298995,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880298995,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880299134,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880299135,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880299144,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880299145,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880299145,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880299145,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880299196,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880299197,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880299266,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880299266,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880299276,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880299296,"env":"test","module":"auth-routes","userId":"egfLrQpdbbIab0gU-qGpf","email":"test-KdwDPhkqAG-vJvzEVXijC@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880299299,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764880299299,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764880299503,"env":"test","module":"auth-routes","userId":"QzFJ8mc-wQF6yqTXewjOZ","email":"test-O6fCzIfJmzcGwhEA1bgsC@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880299517,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880299518,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880299522,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880299522,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880299524,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764880299555,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880299568,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880299569,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880299570,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880299570,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880299571,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880299579,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764880299587,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880299596,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 473[2mms[22m[39m
{"level":30,"time":1764880299619,"env":"test","module":"auth-routes","userId":"MqXHVDjCacfiWyTSx_Sm4","email":"test-login-91EQHqE1hPvGY7l2GB4WG@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880299830,"env":"test","module":"auth-routes","userId":"MqXHVDjCacfiWyTSx_Sm4","email":"test-login-91EQHqE1hPvGY7l2GB4WG@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764880300485,"env":"test","module":"auth-routes","userId":"8EEjkWOTFQ2u9GgfX_qMB","email":"test-me-Vs9bVzkP6PKGgHZ41X8I7@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880300569,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764880300575,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764880300582,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764880300752,"env":"test","module":"auth-routes","userId":"_kAbqvDUSBZOYLw5RpfWL","email":"owner-Y_z7_yCWga9aexbmJYgsm@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880301047,"env":"test","module":"tenant-routes","tenantId":"ff17ce2f-491f-4d30-a0be-9776ac40bc7c","userId":"_kAbqvDUSBZOYLw5RpfWL","msg":"Tenant created"}
{"level":30,"time":1764880301116,"env":"test","module":"auth-routes","userId":"79uiuXosCNdEzh0vBchKR","email":"builder-y37FWhqHLZbzE_GD8PBCb@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880301221,"env":"test","module":"auth-routes","userId":"GnVl6pv8eJYui-qz1TvTL","email":"viewer-NCbmcsGd8FNGSYWnnMWcP@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880301385,"env":"test","module":"rbac-middleware","userId":"79uiuXosCNdEzh0vBchKR","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/ff17ce2f-491f-4d30-a0be-9776ac40bc7c","msg":"Role check failed"}
{"level":40,"time":1764880301390,"env":"test","module":"rbac-middleware","userId":"GnVl6pv8eJYui-qz1TvTL","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/ff17ce2f-491f-4d30-a0be-9776ac40bc7c","msg":"Role check failed"}
{"level":30,"time":1764880301491,"env":"test","module":"tenant-routes","tenantId":"ff17ce2f-491f-4d30-a0be-9776ac40bc7c","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2537[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should register a new user with email and password [33m 309[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 14:31:31
[2m   Duration [22m 17.25s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/versions.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

{"level":40,"time":1764880308561,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764880308750,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764880310107,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764880310333,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880312360,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880312361,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880312373,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880312373,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880312374,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880312374,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880312469,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880312470,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880312472,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880312473,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880312481,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880312508,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764880312508,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764880312520,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880312520,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880312521,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880312521,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880312523,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764880312558,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880312567,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880312568,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880312570,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880312571,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880312573,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880312581,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764880312589,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880312635,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 289[2mms[22m[39m
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880312732,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880312732,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880312743,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880312743,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880312744,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880312744,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880312898,"env":"test","module":"auth-routes","userId":"Ru5OvxxfwYc6Xxee1Qd8a","email":"test--L-MqOBRGX4BJGph0Yqkz@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880313005,"env":"test","module":"auth-routes","userId":"Z974jCVPe1cFe4t2e--nS","email":"test-cfD1DKV0cpBQjuEDTkQHP@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880313083,"env":"test","module":"auth-routes","userId":"dBuozhj6RF3P_NcJLdkle","email":"test-login-0aFjvHbX-l94oJlEP_DAX@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880313151,"env":"test","module":"auth-routes","userId":"dBuozhj6RF3P_NcJLdkle","email":"test-login-0aFjvHbX-l94oJlEP_DAX@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764880313300,"env":"test","module":"auth-routes","userId":"b7MOpUSESpFNYC5wTAVBS","email":"test-me-qAcxtTap1SbjVg5iYXcrk@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880313321,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764880313326,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764880313341,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764880313412,"env":"test","module":"auth-routes","userId":"Q6jxitGJT4kj5AfyQRe4S","email":"owner-tj8g6TxZruvipV2vLe9jd@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880313619,"env":"test","module":"tenant-routes","tenantId":"5970aba9-d33c-4fa7-a781-6f2f0b48eca6","userId":"Q6jxitGJT4kj5AfyQRe4S","msg":"Tenant created"}
{"level":30,"time":1764880313694,"env":"test","module":"auth-routes","userId":"FeYRdnmxJOkAVph7R3Jqk","email":"builder-iA71gCUE8tK_EFsppmaZ6@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880313756,"env":"test","module":"auth-routes","userId":"zZmBBiqSrcsoJmQm-MHJ4","email":"viewer-cCXFaG5BLwfQ64U7QFuys@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880313909,"env":"test","module":"rbac-middleware","userId":"FeYRdnmxJOkAVph7R3Jqk","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/5970aba9-d33c-4fa7-a781-6f2f0b48eca6","msg":"Role check failed"}
{"level":40,"time":1764880313914,"env":"test","module":"rbac-middleware","userId":"zZmBBiqSrcsoJmQm-MHJ4","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/5970aba9-d33c-4fa7-a781-6f2f0b48eca6","msg":"Role check failed"}
{"level":30,"time":1764880313962,"env":"test","module":"tenant-routes","tenantId":"5970aba9-d33c-4fa7-a781-6f2f0b48eca6","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1242[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 14:31:45
[2m   Duration [22m 14.04s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/workflowExports.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

{"level":40,"time":1764880316810,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764880317255,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764880319448,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764880319511,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880322982,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880322983,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880322993,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880322993,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880322994,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880322994,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880323154,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880323154,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880323169,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880323169,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880323170,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880323170,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880323213,"env":"test","module":"auth-routes","userId":"JH7iK8xQPv1haxrgtUFn7","email":"test-CdC81Xi2-2nItKLW5gAwn@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880323253,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880323254,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880323256,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880323257,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880323264,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880323297,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764880323297,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764880323311,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880323312,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880323313,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880323313,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880323314,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764880323337,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880323369,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880323369,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880323371,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880323371,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880323373,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880323381,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764880323388,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880323398,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 255[2mms[22m[39m
{"level":30,"time":1764880323506,"env":"test","module":"auth-routes","userId":"uhThTnTMf1qhV-QWzf1ys","email":"test-JBg7DI5qzcvMc7rPy8-we@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880323614,"env":"test","module":"auth-routes","userId":"pRpb17PUrkKM3vi-qaNpg","email":"test-login-PJ8yKZXU9gOHDbgT84Um-@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880323755,"env":"test","module":"auth-routes","userId":"pRpb17PUrkKM3vi-qaNpg","email":"test-login-PJ8yKZXU9gOHDbgT84Um-@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764880324076,"env":"test","module":"auth-routes","userId":"Y47Kv2S-gdCW-BfgPX45g","email":"test-me-Gf8AvhJg4hCLC5bsYRznJ@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880324171,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764880324178,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764880324292,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764880324370,"env":"test","module":"auth-routes","userId":"5D20VRpZVswWluBSD37Q5","email":"owner-Zzm3LI3IKTwZR7V93nfY2@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880324601,"env":"test","module":"tenant-routes","tenantId":"e9300719-da8c-4cb0-b155-8c04b7a87077","userId":"5D20VRpZVswWluBSD37Q5","msg":"Tenant created"}
{"level":30,"time":1764880324664,"env":"test","module":"auth-routes","userId":"ihIpBzb-t_FguE-GbRczb","email":"builder-OvwUA6Dc5fu26nYUvtf3C@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880324765,"env":"test","module":"auth-routes","userId":"K9xgvA_DH0m6-pVwVyMfB","email":"viewer-zX892Ucm6pKp_UJRc5W7_@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880324987,"env":"test","module":"rbac-middleware","userId":"ihIpBzb-t_FguE-GbRczb","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/e9300719-da8c-4cb0-b155-8c04b7a87077","msg":"Role check failed"}
{"level":40,"time":1764880324993,"env":"test","module":"rbac-middleware","userId":"K9xgvA_DH0m6-pVwVyMfB","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/e9300719-da8c-4cb0-b155-8c04b7a87077","msg":"Role check failed"}
{"level":30,"time":1764880325042,"env":"test","module":"tenant-routes","tenantId":"e9300719-da8c-4cb0-b155-8c04b7a87077","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2071[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 14:31:54
[2m   Duration [22m 18.73s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/runs.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

{"level":40,"time":1764880371487,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764880371961,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764880373903,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764880374493,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880377334,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880377335,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880377348,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880377349,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880377349,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880377349,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880377411,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880377412,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880377453,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880377453,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880377460,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880377518,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764880377518,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764880377561,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880377562,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880377563,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880377563,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880377564,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764880377587,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880377597,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764880377597,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764880377599,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764880377599,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764880377600,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764880377608,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764880377615,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764880377623,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 302[2mms[22m[39m
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764880377852,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764880377853,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764880377865,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764880377865,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764880377866,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764880377866,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764880378014,"env":"test","module":"auth-routes","userId":"LN4snXtRbbD44AmQoPVFT","email":"test-Iv8vYSohv2t8_yDRoWs2_@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880378264,"env":"test","module":"auth-routes","userId":"SAoFeOD72h0OSVEKjmNEz","email":"test-Jl6ZbFIyoKmBOvzj0KsPQ@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880378373,"env":"test","module":"auth-routes","userId":"Qqj9-k4Z4FSAR1jj0gGVX","email":"test-login-eeCwKmlREmgrJY_32a2Wz@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880378515,"env":"test","module":"auth-routes","userId":"Qqj9-k4Z4FSAR1jj0gGVX","email":"test-login-eeCwKmlREmgrJY_32a2Wz@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764880378799,"env":"test","module":"auth-routes","userId":"cCCvzWcYPM1WdqLo9t6Db","email":"test-me-2zKRkUxqkb80qedUQX3gV@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880378819,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764880378839,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764880378900,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764880379025,"env":"test","module":"auth-routes","userId":"Ur-z3Whq0lhRghXpegTJm","email":"owner-wP9BfNrh9HHitSdw3eKMx@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880379287,"env":"test","module":"tenant-routes","tenantId":"6c7a896d-76c8-40fb-aedc-afc6bf6bf5b8","userId":"Ur-z3Whq0lhRghXpegTJm","msg":"Tenant created"}
{"level":30,"time":1764880379367,"env":"test","module":"auth-routes","userId":"pSfcCvHUgKC3mBdCuvpT-","email":"builder-UH2Ro7O7SKHJuAmTB-C12@example.com","msg":"User registered successfully"}
{"level":30,"time":1764880379474,"env":"test","module":"auth-routes","userId":"SbAgALAcVIA8RDnKlwO-K","email":"viewer-ZAuXsyIw50xgI8D4l9-ew@example.com","msg":"User registered successfully"}
{"level":40,"time":1764880379639,"env":"test","module":"rbac-middleware","userId":"pSfcCvHUgKC3mBdCuvpT-","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/6c7a896d-76c8-40fb-aedc-afc6bf6bf5b8","msg":"Role check failed"}
{"level":40,"time":1764880379643,"env":"test","module":"rbac-middleware","userId":"SbAgALAcVIA8RDnKlwO-K","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/6c7a896d-76c8-40fb-aedc-afc6bf6bf5b8","msg":"Role check failed"}
{"level":30,"time":1764880379708,"env":"test","module":"tenant-routes","tenantId":"6c7a896d-76c8-40fb-aedc-afc6bf6bf5b8","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1867[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 14:32:47
[2m   Duration [22m 19.92s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/auth.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

{"level":40,"time":1764891573073,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764891573428,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764891576360,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764891576362,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764891580105,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764891580105,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764891580116,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764891580116,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764891580117,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764891580117,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764891580318,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764891580320,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764891580323,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764891580413,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764891580420,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764891580489,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764891580489,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764891580501,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764891580502,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764891580503,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764891580503,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764891580505,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764891580525,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764891580534,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764891580535,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764891580536,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764891580537,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764891580538,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764891580547,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764891580553,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764891580561,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 467[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should successfully log in with valid Google ID token [33m 362[2mms[22m[39m
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764891580630,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764891580631,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764891580644,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764891580645,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764891580645,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764891580645,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764891580955,"env":"test","module":"auth-routes","userId":"frELYk2bYDNHei3L0N1ML","email":"test-n8Dhr8-gULpSzDtWoZKnV@example.com","msg":"User registered successfully"}
{"level":30,"time":1764891581248,"env":"test","module":"auth-routes","userId":"-QAddNK32D0vOuPegtnpp","email":"test-lsq6EZqbi2iLvxdfLScgb@example.com","msg":"User registered successfully"}
{"level":30,"time":1764891581454,"env":"test","module":"auth-routes","userId":"hauKcWbuwVxTPqPP9SSzi","email":"test-login-mCesqfwfeCie4OPJjDMTv@example.com","msg":"User registered successfully"}
{"level":30,"time":1764891581666,"env":"test","module":"auth-routes","userId":"hauKcWbuwVxTPqPP9SSzi","email":"test-login-mCesqfwfeCie4OPJjDMTv@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764891581917,"env":"test","module":"auth-routes","userId":"8AAEXE9Qye_kwTo4LKcQN","email":"test-me-6rX8CGUExou1jLsfEyN23@example.com","msg":"User registered successfully"}
{"level":40,"time":1764891581940,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764891581955,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764891581968,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764891582044,"env":"test","module":"auth-routes","userId":"xyZnnSJqoRMOp4RhSwKdB","email":"owner-iQlc-SU9xZ0T-bX-S6DoH@example.com","msg":"User registered successfully"}
{"level":30,"time":1764891582264,"env":"test","module":"tenant-routes","tenantId":"38ee0fa8-4646-4ddb-8a1a-1cd73a5eaab6","userId":"xyZnnSJqoRMOp4RhSwKdB","msg":"Tenant created"}
{"level":30,"time":1764891582329,"env":"test","module":"auth-routes","userId":"O0G4Y2hgi00nvxdcXLH7G","email":"builder-pHRcdUtlvBaAO2-3vPqbx@example.com","msg":"User registered successfully"}
{"level":30,"time":1764891582417,"env":"test","module":"auth-routes","userId":"EI6QdCTu1JkNyXYCMWRkz","email":"viewer-yio2pKgwyYk8J8NNrqXDl@example.com","msg":"User registered successfully"}
{"level":40,"time":1764891582590,"env":"test","module":"rbac-middleware","userId":"O0G4Y2hgi00nvxdcXLH7G","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/38ee0fa8-4646-4ddb-8a1a-1cd73a5eaab6","msg":"Role check failed"}
{"level":40,"time":1764891582596,"env":"test","module":"rbac-middleware","userId":"EI6QdCTu1JkNyXYCMWRkz","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/38ee0fa8-4646-4ddb-8a1a-1cd73a5eaab6","msg":"Role check failed"}
{"level":30,"time":1764891582651,"env":"test","module":"tenant-routes","tenantId":"38ee0fa8-4646-4ddb-8a1a-1cd73a5eaab6","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2032[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should register a new user with email and password [33m 328[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 17:39:28
[2m   Duration [22m 24.00s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/middleware/auth.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

{"level":40,"time":1764892165021,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764892164958,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764892168646,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764892169039,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764892172993,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764892172993,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764892173005,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764892173005,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764892173005,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764892173006,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764892173361,"env":"test","module":"auth-routes","userId":"iqcuZcPLO1Kwc_lLUJOC0","email":"test-w_NEcmnpD7E0gour0CAUm@example.com","msg":"User registered successfully"}
{"level":30,"time":1764892173657,"env":"test","module":"auth-routes","userId":"ZrRWGdpAgHQ2ZXulO1EIT","email":"test-gwDsg8uewV2T4pe2NBhlv@example.com","msg":"User registered successfully"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764892173725,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764892173726,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764892173737,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764892173737,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764892173737,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764892173737,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764892173793,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764892173794,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764892173797,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764892173799,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764892173805,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764892173825,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764892173826,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764892173836,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764892173836,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764892173838,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764892173838,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764892173840,"env":"test","module":"auth-routes","userId":"03NJjeEkyIx17p1S6Obfy","email":"test-login-RSEN6ION2FGJOyAZDSxMY@example.com","msg":"User registered successfully"}
{"level":30,"time":1764892173840,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764892173859,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764892173868,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764892173868,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764892173872,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764892173872,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764892173873,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764892173881,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764892173888,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764892173899,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 186[2mms[22m[39m
{"level":30,"time":1764892173991,"env":"test","module":"auth-routes","userId":"03NJjeEkyIx17p1S6Obfy","email":"test-login-RSEN6ION2FGJOyAZDSxMY@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764892174354,"env":"test","module":"auth-routes","userId":"oQVMSrYXCUgG5pf0Vt73d","email":"test-me-X9MjlQLddmMgWtsrJmXhm@example.com","msg":"User registered successfully"}
{"level":40,"time":1764892174375,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764892174381,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764892174386,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764892174470,"env":"test","module":"auth-routes","userId":"3cuc4zDT7Th0P7JUOX2QX","email":"owner-xC75mN_NbDQ1b0DJCyiub@example.com","msg":"User registered successfully"}
{"level":30,"time":1764892174684,"env":"test","module":"tenant-routes","tenantId":"f3d8af5c-c711-4e1e-bb56-f1a722585c44","userId":"3cuc4zDT7Th0P7JUOX2QX","msg":"Tenant created"}
{"level":30,"time":1764892174754,"env":"test","module":"auth-routes","userId":"HMJfmzJfXVW_Z8xhNocSl","email":"builder-jMBP4gaAO37UbO9x_7bPx@example.com","msg":"User registered successfully"}
{"level":30,"time":1764892174835,"env":"test","module":"auth-routes","userId":"Lx7-L9shtxmeblEflNzvA","email":"viewer-9W8lupH-RAKZIEZp2KVes@example.com","msg":"User registered successfully"}
{"level":40,"time":1764892174995,"env":"test","module":"rbac-middleware","userId":"HMJfmzJfXVW_Z8xhNocSl","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/f3d8af5c-c711-4e1e-bb56-f1a722585c44","msg":"Role check failed"}
{"level":40,"time":1764892175000,"env":"test","module":"rbac-middleware","userId":"Lx7-L9shtxmeblEflNzvA","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/f3d8af5c-c711-4e1e-bb56-f1a722585c44","msg":"Role check failed"}
{"level":30,"time":1764892175048,"env":"test","module":"tenant-routes","tenantId":"f3d8af5c-c711-4e1e-bb56-f1a722585c44","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2067[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should register a new user with email and password [33m 420[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 17:49:20
[2m   Duration [22m 25.35s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/auth.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

{"level":40,"time":1764892480501,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764892480790,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764892483030,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764892483193,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764892486306,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764892486307,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764892486318,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764892486318,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764892486319,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764892486319,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764892486411,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764892486412,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764892486414,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764892486415,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764892486423,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764892486506,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764892486513,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764892486513,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764892486507,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764892486517,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764892486517,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764892486517,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764892486517,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764892486565,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764892486566,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764892486567,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764892486567,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764892486569,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":40,"time":1764892486593,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764892486653,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764892486680,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764892486683,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764892486683,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764892486684,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764892486693,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":40,"time":1764892486700,"env":"test","module":"auth-middleware","path":"/api/auth/user","msg":"No valid authentication found"}
{"level":30,"time":1764892486708,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 414[2mms[22m[39m
{"level":30,"time":1764892486821,"env":"test","module":"auth-routes","userId":"BrL408rnnx3336wbhokKs","email":"test-qgYj0m3g55wATCbUhakDh@example.com","msg":"User registered successfully"}
{"level":30,"time":1764892487048,"env":"test","module":"auth-routes","userId":"rwIgecDp7awgC_kR7R_A9","email":"test-SFwLsGorMa_Wil0GjU2HR@example.com","msg":"User registered successfully"}
{"level":30,"time":1764892487150,"env":"test","module":"auth-routes","userId":"7x3Vy5OX3X9XA155nKELj","email":"test-login-XQRPxEA2jyxD7HbRJhmWj@example.com","msg":"User registered successfully"}
{"level":30,"time":1764892487232,"env":"test","module":"auth-routes","userId":"7x3Vy5OX3X9XA155nKELj","email":"test-login-XQRPxEA2jyxD7HbRJhmWj@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764892487581,"env":"test","module":"auth-routes","userId":"y2ke9LIrRlS80LP4dJZNo","email":"test-me-sTateTn_5hb1ALwVgUio1@example.com","msg":"User registered successfully"}
{"level":40,"time":1764892487597,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764892487609,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764892487618,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764892487764,"env":"test","module":"auth-routes","userId":"OPiLViULqEjGiav3cqPGK","email":"owner-U7mIcsyw6IZDpCfpwD-7w@example.com","msg":"User registered successfully"}
{"level":30,"time":1764892488028,"env":"test","module":"tenant-routes","tenantId":"498fc7dc-be2e-4715-8d57-4ecea4d43a28","userId":"OPiLViULqEjGiav3cqPGK","msg":"Tenant created"}
{"level":30,"time":1764892488091,"env":"test","module":"auth-routes","userId":"Ou4dY8K-SIVOz6qvf299z","email":"builder-LunkyESvY2PdLDdZYJg1k@example.com","msg":"User registered successfully"}
{"level":30,"time":1764892488157,"env":"test","module":"auth-routes","userId":"FUnilzxushyub62boQ1Bs","email":"viewer-148org4zzv9ch9iz37Hvh@example.com","msg":"User registered successfully"}
{"level":40,"time":1764892488326,"env":"test","module":"rbac-middleware","userId":"Ou4dY8K-SIVOz6qvf299z","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/498fc7dc-be2e-4715-8d57-4ecea4d43a28","msg":"Role check failed"}
{"level":40,"time":1764892488331,"env":"test","module":"rbac-middleware","userId":"FUnilzxushyub62boQ1Bs","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/498fc7dc-be2e-4715-8d57-4ecea4d43a28","msg":"Role check failed"}
{"level":30,"time":1764892488384,"env":"test","module":"tenant-routes","tenantId":"498fc7dc-be2e-4715-8d57-4ecea4d43a28","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1890[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should register a new user with email and password [33m 351[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m23 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 17:54:36
[2m   Duration [22m 20.02s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/auth.routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

{"level":40,"time":1764892494561,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764892494574,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764892496210,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764892496239,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764892499122,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764892499188,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764892499123,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764892499134,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764892499134,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764892499134,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764892499134,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764892499189,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764892499201,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764892499201,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764892499201,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764892499201,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764892499339,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764892499351,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764892499358,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764892499359,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764892499367,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764892499384,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764892499384,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764892499396,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764892499396,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764892499423,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764892499424,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764892499425,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764892499456,"env":"test","module":"auth-routes","userId":"LlhSziXcj0moxTdzyxvir","email":"test-URbZznLZKjmyU88ou0pJ_@example.com","msg":"User registered successfully"}
{"level":30,"time":1764892499467,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764892499468,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764892499501,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764892499501,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764892499502,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764892499509,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":30,"time":1764892499522,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 344[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should successfully log in with valid Google ID token[32m 176[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject login with missing ID token[32m 12[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should return current user if authenticated[32m 49[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 401 if not authenticated[39m[32m 21[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should successfully log out authenticated user[39m[32m 56[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should handle logout when not logged in[32m 8[2mms[22m[39m
{"level":30,"time":1764892499709,"env":"test","module":"auth-routes","userId":"BQy9w9Rnn0Yw8GXYBust6","email":"test-lGk-H93hzWxvPz8LGvkJH@example.com","msg":"User registered successfully"}
{"level":30,"time":1764892499906,"env":"test","module":"auth-routes","userId":"Biq3BirQeusPAswmFmHyh","email":"test-login-TMrgFhN8x-HFI7aR0S3uJ@example.com","msg":"User registered successfully"}
{"level":30,"time":1764892500069,"env":"test","module":"auth-routes","userId":"Biq3BirQeusPAswmFmHyh","email":"test-login-TMrgFhN8x-HFI7aR0S3uJ@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764892500444,"env":"test","module":"auth-routes","userId":"Fy3kzhklRrxo-CW_V2G0C","email":"test-me-qvB8ZnA1PnpwNg7vpfdGA@example.com","msg":"User registered successfully"}
{"level":40,"time":1764892500475,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764892500484,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764892500552,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764892500794,"env":"test","module":"auth-routes","userId":"iMUSBc8x5fj8keoI61Yb7","email":"owner-U1QgRJV0tmWcEoeCAYnm3@example.com","msg":"User registered successfully"}
{"level":30,"time":1764892501220,"env":"test","module":"tenant-routes","tenantId":"dce754ce-b000-4115-b138-2548f505a669","userId":"iMUSBc8x5fj8keoI61Yb7","msg":"Tenant created"}
{"level":30,"time":1764892501290,"env":"test","module":"auth-routes","userId":"hev0VAutLyy1JPiKDLnn0","email":"builder-H-ROIj2N-yJwQQAcAPriZ@example.com","msg":"User registered successfully"}
{"level":30,"time":1764892501432,"env":"test","module":"auth-routes","userId":"b9P-vzLUr3pfa2WlqtxhM","email":"viewer-LORYYMUpYkhTO74wvlzgz@example.com","msg":"User registered successfully"}
{"level":40,"time":1764892501634,"env":"test","module":"rbac-middleware","userId":"hev0VAutLyy1JPiKDLnn0","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/dce754ce-b000-4115-b138-2548f505a669","msg":"Role check failed"}
{"level":40,"time":1764892501637,"env":"test","module":"rbac-middleware","userId":"b9P-vzLUr3pfa2WlqtxhM","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/dce754ce-b000-4115-b138-2548f505a669","msg":"Role check failed"}
{"level":30,"time":1764892501682,"env":"test","module":"tenant-routes","tenantId":"dce754ce-b000-4115-b138-2548f505a669","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2571[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should register a new user with email and password [33m 332[2mms[22m[39m

[2m Test Files [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m1 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[31m2 failed[39m[22m[2m | [22m[1m[32m21 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 17:54:51
[2m   Duration [22m 16.52s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

{"level":40,"time":1764895077289,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764895077337,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764895079961,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764895081539,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764895084436,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764895084437,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764895084449,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764895084449,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764895084450,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764895084450,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764895084887,"env":"test","module":"auth-routes","userId":"_tq8KVR15MS_ZbTF1KqMg","email":"test-fHCWFYbc0NNFrlasSETt6@example.com","msg":"User registered successfully"}
{"level":30,"time":1764895085140,"env":"test","module":"auth-routes","userId":"JwcOW0-XNygMI5BIGmPUw","email":"test-OZau4XL7z9xh6rCasXASd@example.com","msg":"User registered successfully"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764895085238,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764895085239,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764895085249,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764895085250,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764895085250,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764895085250,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764895085358,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764895085359,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764895085362,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764895085362,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764895085383,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764895085489,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764895085489,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764895085547,"env":"test","module":"auth-routes","userId":"3gOTi6olsup62LMqEQ6qb","email":"test-login-yrVQfLS3tMduOAnnMBDFq@example.com","msg":"User registered successfully"}
{"level":30,"time":1764895085559,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764895085559,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764895085560,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764895085561,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764895085562,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764895085588,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764895085591,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764895085594,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764895085594,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764895085597,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764895085604,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":30,"time":1764895085618,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 389[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should successfully log in with valid Google ID token[32m 148[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject login with missing ID token[32m 97[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should return current user if authenticated[32m 77[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 401 if not authenticated[39m[32m 9[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should successfully log out authenticated user[39m[32m 31[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should handle logout when not logged in[32m 6[2mms[22m[39m
{"level":30,"time":1764895085659,"env":"test","module":"auth-routes","userId":"3gOTi6olsup62LMqEQ6qb","email":"test-login-yrVQfLS3tMduOAnnMBDFq@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764895085928,"env":"test","module":"auth-routes","userId":"QJRdHqn_QQIeswHFEglzs","email":"test-me-_wb_a82tpRueNKcojrWba@example.com","msg":"User registered successfully"}
{"level":40,"time":1764895085939,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764895085945,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764895085951,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764895086059,"env":"test","module":"auth-routes","userId":"tTeDW1QaZZeGfZSG0j6gJ","email":"owner-1w51adEocNuEb_AFD8MMO@example.com","msg":"User registered successfully"}
{"level":30,"time":1764895086304,"env":"test","module":"tenant-routes","tenantId":"ea0e82ef-eea9-44c6-a480-e4d2d88f1738","userId":"tTeDW1QaZZeGfZSG0j6gJ","msg":"Tenant created"}
{"level":30,"time":1764895086370,"env":"test","module":"auth-routes","userId":"756vOROBjqLZCD1g0QmFU","email":"builder--yoeKIs7MhbqdZXini4G0@example.com","msg":"User registered successfully"}
{"level":30,"time":1764895086433,"env":"test","module":"auth-routes","userId":"MSUZ2tF9OZq9STEwVIW9x","email":"viewer-VHDIPVrcdcUh1oKhADjs6@example.com","msg":"User registered successfully"}
{"level":40,"time":1764895086589,"env":"test","module":"rbac-middleware","userId":"756vOROBjqLZCD1g0QmFU","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/ea0e82ef-eea9-44c6-a480-e4d2d88f1738","msg":"Role check failed"}
{"level":40,"time":1764895086594,"env":"test","module":"rbac-middleware","userId":"MSUZ2tF9OZq9STEwVIW9x","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/ea0e82ef-eea9-44c6-a480-e4d2d88f1738","msg":"Role check failed"}
{"level":30,"time":1764895086646,"env":"test","module":"tenant-routes","tenantId":"ea0e82ef-eea9-44c6-a480-e4d2d88f1738","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2225[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should register a new user with email and password [33m 448[2mms[22m[39m

[2m Test Files [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m1 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[31m2 failed[39m[22m[2m | [22m[1m[32m21 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 18:37:52
[2m   Duration [22m 24.10s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes.ts [22m[39m
       [2m Filename pattern: [22m[34mtests/integration/auth-jwt.integration.test.ts, tests/integration/routes/US-A-001-login.test.ts[39m

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (13) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

{"level":40,"time":1764895088570,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":40,"time":1764895088591,"env":"test","module":"auth-service","msg":"JWT_SECRET not set - falling back to SESSION_SECRET. This is acceptable for development but should be fixed for production."}
{"level":30,"time":1764895089490,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
{"level":30,"time":1764895089495,"env":"test","multerImportKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceKeys":["diskStorage","memoryStorage","MulterError"],"multerInstanceType":"function","uploadKeys":["storage","limits","preservePath","fileFilter"],"uploadType":"object","uploadPrototype":{},"msg":"Debug Multer Import"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764895090768,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests

{"level":30,"time":1764895090780,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1764895090768,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764895090776,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764895090776,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764895090777,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764895090777,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764895090781,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1764895090791,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1764895090791,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1764895090791,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1764895090791,"env":"test","module":"routes","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1764895090830,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764895090830,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764895090831,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764895090832,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764895090836,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764895090848,"env":"test","module":"auth","hasToken":false,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":40,"time":1764895090848,"env":"test","module":"auth","msg":"OAuth2 login failed: No token provided"}
{"level":30,"time":1764895090854,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764895090855,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764895090855,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764895090855,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764895090856,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764895090871,"env":"test","module":"auth-routes","userId":"31EAdEJdhKaXt4rpsUYtk","email":"test-no_OEL1WlYEuqWBVjEK8U@example.com","msg":"User registered successfully"}
{"level":30,"time":1764895090875,"env":"test","module":"auth","hasToken":true,"origin":"http://localhost:5000","ip":"::ffff:127.0.0.1","msg":"OAuth2 login attempt"}
{"level":30,"time":1764895090875,"env":"test","module":"auth","email":"testuser@example.com","msg":"Token verified successfully"}
{"level":30,"time":1764895090877,"env":"test","module":"auth","userId":"google-user-id","msg":"User upserted successfully"}
{"level":40,"time":1764895090877,"env":"test","module":"auth","err":{"type":"Error","message":"[vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n","stack":"Error: [vitest] No \"db\" export is defined on the \"../../../server/db\" mock. Did you forget to return it from \"vi.mock\"?\nIf you need to partially mock a module, you can use \"importOriginal\" helper inside:\n\n    at VitestMocker.createError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:230:48)\n    at Object.get (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/startModuleRunner.BqQUfEjB.js:279:16)\n    at TemplateShareRepository.acceptPendingForUser (C:/Users/scoot/poll/VaultLogic/server/repositories/TemplateShareRepository.ts:91:27)\n    at TemplateSharingService.acceptPendingOnLogin (C:/Users/scoot/poll/VaultLogic/server/services/TemplateSharingService.ts:210:27)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:338:38\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)","codeFrame":"vi.mock(import(\"../../../server/db\"), async (importOriginal) => {\n  const actual = await importOriginal()\n  return {\n    ...actual,\n    // your mocked methods\n  }\n})"},"email":"testuser@example.com","msg":"Failed to accept pending template shares"}
{"level":30,"time":1764895090879,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1764895090885,"env":"test","module":"auth","email":"testuser@example.com","msg":"User logged out"}
{"level":30,"time":1764895090895,"env":"test","module":"auth","msg":"User logged out"}
[90mstdout[2m | tests/integration/routes/US-A-001-login.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/routes/US-A-001-login.test.ts [2m([22m[2m6 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[32m 123[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should successfully log in with valid Google ID token[32m 52[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should reject login with missing ID token[32m 7[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should return current user if authenticated[32m 14[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 401 if not authenticated[39m[32m 6[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should successfully log out authenticated user[39m[32m 21[2mms[22m[39m
       [32mÎ“Â£Ã´[39m should handle logout when not logged in[32m 6[2mms[22m[39m
{"level":30,"time":1764895090951,"env":"test","module":"auth-routes","userId":"ZeZ--gUkMZHvgwQOBjQsS","email":"test-6-gVdkC7PMP4xwIElrcIW@example.com","msg":"User registered successfully"}
{"level":30,"time":1764895091012,"env":"test","module":"auth-routes","userId":"7FalHJTPSDbA7Q4YZumLX","email":"test-login-DWMaRGlNM9RVFMvHjToep@example.com","msg":"User registered successfully"}
{"level":30,"time":1764895091071,"env":"test","module":"auth-routes","userId":"7FalHJTPSDbA7Q4YZumLX","email":"test-login-DWMaRGlNM9RVFMvHjToep@example.com","msg":"User logged in successfully"}
{"level":30,"time":1764895091197,"env":"test","module":"auth-routes","userId":"5tN7Ew8JuesSF6pPNlzkl","email":"test-me-hNbThE_f8H15jCo5zJMwE@example.com","msg":"User registered successfully"}
{"level":40,"time":1764895091208,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":40,"time":1764895091212,"env":"test","module":"auth-middleware","path":"/api/auth/me","msg":"No valid authentication found"}
{"level":30,"time":1764895091217,"env":"test","module":"auth","msg":"User logged out"}
{"level":30,"time":1764895091275,"env":"test","module":"auth-routes","userId":"DqSTLYSzQ5cRxcDYQbXSG","email":"owner-D0eAUs_5wvQeuJaos6xWV@example.com","msg":"User registered successfully"}
{"level":30,"time":1764895091472,"env":"test","module":"tenant-routes","tenantId":"43ca792c-86ec-4f40-85a3-18c1a605593f","userId":"DqSTLYSzQ5cRxcDYQbXSG","msg":"Tenant created"}
{"level":30,"time":1764895091530,"env":"test","module":"auth-routes","userId":"T1uo3sNBmhi69_5xrTAPN","email":"builder-hlhFYbQLmHiV-PIsVStIt@example.com","msg":"User registered successfully"}
{"level":30,"time":1764895091588,"env":"test","module":"auth-routes","userId":"-Donf6HhCKsXUAww1LTmv","email":"viewer-DirPuu3bcLk_gUA_EZjKN@example.com","msg":"User registered successfully"}
{"level":40,"time":1764895091738,"env":"test","module":"rbac-middleware","userId":"T1uo3sNBmhi69_5xrTAPN","userRole":"builder","requiredRoles":["owner"],"path":"/api/tenants/43ca792c-86ec-4f40-85a3-18c1a605593f","msg":"Role check failed"}
{"level":40,"time":1764895091742,"env":"test","module":"rbac-middleware","userId":"-Donf6HhCKsXUAww1LTmv","userRole":"viewer","requiredRoles":["owner"],"path":"/api/tenants/43ca792c-86ec-4f40-85a3-18c1a605593f","msg":"Role check failed"}
{"level":30,"time":1764895091791,"env":"test","module":"tenant-routes","tenantId":"43ca792c-86ec-4f40-85a3-18c1a605593f","msg":"Tenant updated"}
[90mstdout[2m | tests/integration/auth-jwt.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/auth-jwt.integration.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1033[2mms[22m[39m

[2m Test Files [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m1 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[31m2 failed[39m[22m[2m | [22m[1m[32m21 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 18:38:06
[2m   Duration [22m 8.48s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
