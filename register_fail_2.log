npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

 DEV  v4.0.16 C:/Users/scoot/poll/VaultLogic

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768674916039,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768674919283,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768674919321,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: public
≡ƒöä Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/auth/protected.routes.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

stdout | tests/integration/auth/protected.routes.test.ts
   Applying 0000_mushy_thing.sql...

stderr | tests/integration/auth/protected.routes.test.ts
Γ¥î FAILED MIGRATION 0000_mushy_thing.sql: Failed query: CREATE TYPE "public"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint
CREATE TYPE "public"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint
CREATE TYPE "public"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint
CREATE TYPE "public"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint
CREATE TYPE "public"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint
CREATE TYPE "public"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint
CREATE TYPE "public"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint
CREATE TYPE "public"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint
CREATE TYPE "public"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint
CREATE TYPE "public"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint
CREATE TYPE "public"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint
CREATE TYPE "public"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint
CREATE TYPE "public"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint
CREATE TYPE "public"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint
CREATE TYPE "public"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint
CREATE TYPE "public"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint
CREATE TYPE "public"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint
CREATE TYPE "public"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint
CREATE TYPE "public"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint
CREATE TYPE "public"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint
CREATE TYPE "public"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint
CREATE TYPE "public"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint
CREATE TYPE "public"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint
CREATE TYPE "public"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint
CREATE TYPE "public"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint
CREATE TYPE "public"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint
CREATE TYPE "public"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint
CREATE TYPE "public"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint
CREATE TYPE "public"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint
CREATE TYPE "public"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint
CREATE TYPE "public"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint
CREATE TYPE "public"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint
CREATE TYPE "public"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint
CREATE TYPE "public"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint
CREATE TYPE "public"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint
CREATE TYPE "public"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint
CREATE TYPE "public"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint
CREATE TYPE "public"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint
CREATE TYPE "public"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint
CREATE TYPE "public"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint
CREATE TYPE "public"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint
CREATE TYPE "public"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint
CREATE TYPE "public"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint
CREATE TYPE "public"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint
CREATE TABLE "account_locks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"locked_at" timestamp DEFAULT now() NOT NULL,
	"locked_until" timestamp NOT NULL,
	"reason" varchar(255),
	"unlocked" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "audit_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"workspace_id" uuid,
	"user_id" varchar,
	"action" varchar NOT NULL,
	"entity_type" varchar NOT NULL,
	"entity_id" varchar NOT NULL,
	"resource_type" varchar,
	"resource_id" varchar,
	"changes" jsonb,
	"details" jsonb,
	"ip_address" varchar,
	"user_agent" text,
	"created_at" timestamp DEFAULT now(),
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_verification_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "login_attempts" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"ip_address" varchar(45),
	"successful" boolean DEFAULT false NOT NULL,
	"attempted_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_backup_codes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"code_hash" text NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"secret" text NOT NULL,
	"enabled" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"enabled_at" timestamp,
	CONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "organization_invites" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"invited_email" varchar(255) NOT NULL,
	"invited_user_id" varchar,
	"invited_by_user_id" varchar NOT NULL,
	"token" varchar(255) NOT NULL,
	"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp NOT NULL,
	"accepted_at" timestamp,
	"email_sent_at" timestamp,
	"email_failed" boolean DEFAULT false,
	"email_error" text,
	CONSTRAINT "organization_invites_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "organization_memberships" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "organization_role" DEFAULT 'member' NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "organizations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"slug" varchar,
	"domain" varchar,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"tenant_id" uuid NOT NULL,
	"created_by_user_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "organizations_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "password_reset_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "portal_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "portal_tokens_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "refresh_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"revoked" boolean DEFAULT false NOT NULL,
	"metadata" jsonb,
	"device_name" varchar(255),
	"ip_address" varchar(45),
	"location" varchar(255),
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sessions" (
	"sid" varchar PRIMARY KEY NOT NULL,
	"sess" jsonb NOT NULL,
	"expire" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE "team_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"team_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" varchar(50) DEFAULT 'member' NOT NULL,
	"joined_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "teams" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "tenant_domains" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"domain" text NOT NULL,
	"verified" boolean DEFAULT false,
	"verification_token" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "tenant_domains_domain_unique" UNIQUE("domain")
);
--> statement-breakpoint
CREATE TABLE "tenants" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar(255) NOT NULL,
	"billing_email" varchar(255),
	"plan" "tenant_plan" DEFAULT 'free' NOT NULL,
	"mfa_required" boolean DEFAULT false NOT NULL,
	"branding" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "trusted_devices" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"device_fingerprint" varchar(255) NOT NULL,
	"device_name" varchar(255),
	"trusted_until" timestamp NOT NULL,
	"ip_address" varchar(45),
	"location" varchar(255),
	"user_agent" text,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"last_used_at" timestamp,
	"revoked" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "user_credentials" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"password_hash" text NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "user_credentials_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "user_personalization_settings" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"reading_level" varchar DEFAULT 'standard' NOT NULL,
	"tone" varchar DEFAULT 'neutral' NOT NULL,
	"verbosity" varchar DEFAULT 'standard' NOT NULL,
	"language" varchar DEFAULT 'en' NOT NULL,
	"allow_adaptive_prompts" boolean DEFAULT true NOT NULL,
	"allow_ai_clarification" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "user_preferences" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"settings" jsonb DEFAULT '{"celebrationEffects":true,"darkMode":"system","aiHints":true}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "users" (
	"id" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"full_name" varchar(255),
	"first_name" varchar(255),
	"last_name" varchar(255),
	"profile_image_url" varchar(500),
	"tenant_id" uuid,
	"role" "user_role" DEFAULT 'creator' NOT NULL,
	"tenant_role" "user_tenant_role",
	"auth_provider" "auth_provider" DEFAULT 'local' NOT NULL,
	"default_mode" text DEFAULT 'easy' NOT NULL,
	"email_verified" boolean DEFAULT false NOT NULL,
	"mfa_enabled" boolean DEFAULT false NOT NULL,
	"last_password_change" timestamp,
	"is_placeholder" boolean DEFAULT false NOT NULL,
	"placeholder_email" varchar(255),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_invitations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"email" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"invited_by" varchar NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"joined_at" timestamp DEFAULT now(),
	"invited_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workspaces" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"slug" varchar NOT NULL,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"type" "block_type" NOT NULL,
	"phase" "block_phase" NOT NULL,
	"config" jsonb NOT NULL,
	"virtual_step_id" uuid,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_docs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid,
	"tenant_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"clock" integer NOT NULL,
	"state" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "collab_updates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"seq" integer NOT NULL,
	"update" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "document_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"final_block_document_id" varchar(255),
	"name" varchar(255) NOT NULL,
	"phase" "document_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 3000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "lifecycle_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar(255) NOT NULL,
	"phase" "lifecycle_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"virtual_step_ids" uuid[] DEFAULT '{}'::uuid[],
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"mutation_mode" boolean DEFAULT false,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "logic_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"condition_step_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_type" "logic_rule_target_type" NOT NULL,
	"target_step_id" uuid,
	"target_section_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "project_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "projects" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"name" varchar(255),
	"description" text,
	"creator_id" varchar NOT NULL,
	"tenant_id" uuid,
	"created_by" varchar,
	"owner_id" varchar NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"status" "project_status" DEFAULT 'active' NOT NULL,
	"archived" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"order" integer NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"visible_if" jsonb,
	"skip_if" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "steps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"section_id" uuid NOT NULL,
	"type" "step_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"alias" text,
	"default_value" jsonb,
	"order" integer NOT NULL,
	"is_virtual" boolean DEFAULT false NOT NULL,
	"visible_if" jsonb,
	"repeater_config" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"version_number" integer NOT NULL,
	"file_ref" varchar(500) NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"notes" text,
	"is_active" boolean DEFAULT true
);
--> statement-breakpoint
CREATE TABLE "templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"file_ref" varchar(500) NOT NULL,
	"type" "template_type" NOT NULL,
	"helpers_version" integer DEFAULT 1 NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"current_version" integer DEFAULT 1,
	"last_modified_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_key" varchar NOT NULL,
	"virtual_step_id" uuid,
	"phase" "block_phase" DEFAULT 'onSectionSubmit' NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_blueprints" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"creator_id" varchar NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"graph_json" jsonb NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"source_workflow_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"name" text NOT NULL,
	"values" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"workflow_version_id" uuid,
	"version_hash" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_id" uuid NOT NULL,
	"key" text NOT NULL,
	"is_primary" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"base_id" uuid,
	"version_number" integer DEFAULT 1 NOT NULL,
	"is_draft" boolean DEFAULT false NOT NULL,
	"graph_json" jsonb NOT NULL,
	"migration_info" jsonb,
	"changelog" jsonb,
	"notes" text,
	"checksum" text,
	"created_by" varchar NOT NULL,
	"published" boolean DEFAULT false NOT NULL,
	"published_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"description" text,
	"creator_id" varchar,
	"owner_id" varchar,
	"mode_override" text,
	"public_link" text,
	"name" varchar(255),
	"project_id" uuid,
	"current_version_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"slug" text,
	"require_login" boolean DEFAULT false NOT NULL,
	"intake_config" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"pinned_version_id" uuid,
	"status" "workflow_status" DEFAULT 'draft' NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"source_blueprint_id" uuid,
	CONSTRAINT "workflows_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "ai_workflow_feedback" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid,
	"user_id" varchar,
	"operation_type" varchar NOT NULL,
	"rating" integer NOT NULL,
	"comment" text,
	"ai_provider" varchar,
	"ai_model" varchar,
	"prompt_version" varchar,
	"quality_score" integer,
	"quality_passed" boolean,
	"issues_count" integer,
	"request_description" text,
	"generated_sections" integer,
	"generated_steps" integer,
	"was_edited" boolean DEFAULT false,
	"edit_count" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "block_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"block_id" varchar NOT NULL,
	"total_visits" integer DEFAULT 0,
	"avg_time_ms" integer DEFAULT 0,
	"dropoff_count" integer DEFAULT 0,
	"validation_error_count" integer DEFAULT 0,
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"run_id" uuid,
	"type" "metrics_event_type" NOT NULL,
	"ts" timestamp with time zone DEFAULT now() NOT NULL,
	"duration_ms" integer,
	"payload" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_rollups" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"bucket_start" timestamp with time zone NOT NULL,
	"bucket" "rollup_bucket" NOT NULL,
	"runs_count" integer DEFAULT 0 NOT NULL,
	"runs_success" integer DEFAULT 0 NOT NULL,
	"runs_error" integer DEFAULT 0 NOT NULL,
	"dur_p50" integer,
	"dur_p95" integer,
	"pdf_success" integer DEFAULT 0 NOT NULL,
	"pdf_error" integer DEFAULT 0 NOT NULL,
	"docx_success" integer DEFAULT 0 NOT NULL,
	"docx_error" integer DEFAULT 0 NOT NULL,
	"queue_enqueued" integer DEFAULT 0 NOT NULL,
	"queue_dequeued" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "review_tasks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"status" "review_task_status" DEFAULT 'pending' NOT NULL,
	"reviewer_id" varchar,
	"reviewer_email" varchar(255),
	"message" text,
	"comment" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"resolved_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "run_generated_documents" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"file_name" text NOT NULL,
	"file_url" text NOT NULL,
	"mime_type" text,
	"file_size" integer,
	"template_id" uuid,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"node_id" varchar(100),
	"level" "log_level" NOT NULL,
	"message" text NOT NULL,
	"context" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_outputs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_key" text NOT NULL,
	"file_type" "output_file_type" NOT NULL,
	"storage_path" text NOT NULL,
	"status" "output_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"input_json" jsonb,
	"output_refs" jsonb,
	"trace" jsonb,
	"status" "run_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"duration_ms" integer,
	"run_token" varchar,
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "script_execution_log" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"script_type" varchar(50) NOT NULL,
	"script_id" uuid NOT NULL,
	"script_name" varchar(255),
	"phase" varchar(50),
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "script_execution_status" NOT NULL,
	"error_message" text,
	"console_output" jsonb,
	"input_sample" jsonb,
	"output_sample" jsonb,
	"duration_ms" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "signature_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"signature_request_id" uuid NOT NULL,
	"type" "signature_event_type" NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb
);
--> statement-breakpoint
CREATE TABLE "signature_requests" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"signer_email" varchar(255) NOT NULL,
	"signer_name" varchar(255),
	"status" "signature_request_status" DEFAULT 'pending' NOT NULL,
	"provider" "signature_provider" DEFAULT 'native' NOT NULL,
	"provider_request_id" text,
	"token" text NOT NULL,
	"document_url" text,
	"redirect_url" text,
	"message" text,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"signed_at" timestamp,
	CONSTRAINT "signature_requests_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "sli_configs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"target_success_pct" integer DEFAULT 99 NOT NULL,
	"target_p95_ms" integer DEFAULT 5000 NOT NULL,
	"error_budget_pct" integer DEFAULT 1 NOT NULL,
	"window" "sli_window" DEFAULT '7d' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sli_windows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"window_start" timestamp with time zone NOT NULL,
	"window_end" timestamp with time zone NOT NULL,
	"success_pct" integer,
	"p95_ms" integer,
	"error_budget_burn_pct" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "step_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"step_id" uuid NOT NULL,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_generation_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"run_id" uuid,
	"result" varchar(50) NOT NULL,
	"duration_ms" integer,
	"error_message" text,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_block_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"block_id" uuid NOT NULL,
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "transform_block_run_status" NOT NULL,
	"error_message" text,
	"output_sample" jsonb
);
--> statement-breakpoint
CREATE TABLE "workflow_analytics_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"date" timestamp NOT NULL,
	"summary" jsonb NOT NULL,
	"dropoff" jsonb NOT NULL,
	"branching" jsonb NOT NULL,
	"heatmap" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_run_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"block_id" varchar,
	"page_id" uuid,
	"type" varchar NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb,
	"is_preview" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_run_metrics" (
	"run_id" uuid PRIMARY KEY NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"total_time_ms" integer,
	"pages_visited" integer DEFAULT 0,
	"blocks_visited" integer DEFAULT 0,
	"validation_errors" integer DEFAULT 0,
	"script_errors" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"is_preview" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"workflow_version_id" uuid,
	"run_token" text NOT NULL,
	"created_by" text,
	"current_section_id" uuid,
	"progress" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"metadata" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"client_email" varchar,
	"portal_access_key" varchar,
	"access_mode" "portal_access_mode" DEFAULT 'anonymous',
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"owner_type" varchar(50),
	"owner_uuid" uuid,
	CONSTRAINT "workflow_runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "workflow_runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "analytics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"survey_id" uuid NOT NULL,
	"page_id" uuid,
	"question_id" uuid,
	"event" varchar NOT NULL,
	"data" jsonb,
	"duration" integer,
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "anonymous_response_tracking" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"ip_address" varchar NOT NULL,
	"session_id" varchar,
	"response_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "answers" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"question_id" uuid NOT NULL,
	"subquestion_id" uuid,
	"loop_index" integer,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "conditional_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"condition_question_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_question_id" uuid,
	"target_page_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_queue" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"to" varchar NOT NULL,
	"subject" varchar NOT NULL,
	"html" text NOT NULL,
	"status" "email_queue_status" DEFAULT 'pending' NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_error" text,
	"next_attempt_at" timestamp DEFAULT now(),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "files" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"answer_id" uuid NOT NULL,
	"filename" varchar NOT NULL,
	"original_name" varchar NOT NULL,
	"mime_type" varchar NOT NULL,
	"size" integer NOT NULL,
	"uploaded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "loop_group_subquestions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"loop_question_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "questions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"page_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"conditional_logic" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "responses" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"completed" boolean DEFAULT false,
	"submitted_at" timestamp,
	"is_anonymous" boolean DEFAULT false,
	"ip_address" varchar,
	"user_agent" text,
	"session_id" varchar,
	"anonymous_metadata" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_pages" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" text NOT NULL,
	"description" text,
	"content" jsonb NOT NULL,
	"creator_id" varchar,
	"is_system" boolean DEFAULT false NOT NULL,
	"tags" text[] DEFAULT ARRAY[]::text[],
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "surveys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"creator_id" varchar NOT NULL,
	"workspace_id" uuid,
	"status" "survey_status" DEFAULT 'draft' NOT NULL,
	"allow_anonymous" boolean DEFAULT false,
	"anonymous_access_type" "anonymous_access_type" DEFAULT 'unlimited',
	"public_link" varchar,
	"anonymous_config" jsonb,
	"is_public" boolean DEFAULT false,
	"public_access_mode" "public_access_mode" DEFAULT 'link_only',
	"public_slug" varchar,
	"allowed_domains" jsonb,
	"public_settings" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "surveys_public_link_unique" UNIQUE("public_link"),
	CONSTRAINT "surveys_public_slug_unique" UNIQUE("public_slug")
);
--> statement-breakpoint
CREATE TABLE "template_shares" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"user_id" varchar,
	"pending_email" text,
	"access" "template_access" DEFAULT 'use' NOT NULL,
	"invited_at" timestamp with time zone DEFAULT now(),
	"accepted_at" timestamp with time zone
);
--> statement-breakpoint
CREATE TABLE "collection_fields" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"collection_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"type" varchar(50) NOT NULL,
	"options" jsonb,
	"required" boolean DEFAULT false,
	"order" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_api_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"database_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"label" text NOT NULL,
	"token_hash" text NOT NULL,
	"scopes" text[] DEFAULT ARRAY[]::text[] NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "datavault_columns" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"type" "datavault_column_type" NOT NULL,
	"description" text,
	"width_px" integer DEFAULT 150,
	"required" boolean DEFAULT false NOT NULL,
	"is_primary_key" boolean DEFAULT false NOT NULL,
	"is_unique" boolean DEFAULT false NOT NULL,
	"order_index" integer DEFAULT 0 NOT NULL,
	"auto_number_start" integer DEFAULT 1,
	"autonumber_prefix" text,
	"autonumber_padding" integer DEFAULT 4,
	"autonumber_reset_policy" "autonumber_reset_policy" DEFAULT 'never',
	"reference_table_id" uuid,
	"reference_display_column_slug" text,
	"options" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_databases" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"type" "data_source_type" DEFAULT 'native' NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"scope_type" "datavault_scope_type" DEFAULT 'account' NOT NULL,
	"scope_id" uuid,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_number_sequences" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"prefix" text,
	"padding" integer DEFAULT 4 NOT NULL,
	"next_value" integer DEFAULT 1 NOT NULL,
	"reset_policy" "autonumber_reset_policy" DEFAULT 'never' NOT NULL,
	"last_reset" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_row_notes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"text" text NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_rows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"deleted_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "datavault_table_permissions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "datavault_table_role" NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_tables" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"owner_user_id" varchar,
	"database_id" uuid,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"value" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_writeback_mappings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_mappings" jsonb NOT NULL,
	"trigger_phase" varchar(50) DEFAULT 'afterComplete' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar
);
--> statement-breakpoint
CREATE TABLE "records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"collection_id" uuid NOT NULL,
	"data" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workflow_data_sources" (
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "workflow_data_sources_workflow_id_data_source_id_pk" PRIMARY KEY("workflow_id","data_source_id")
);
--> statement-breakpoint
CREATE TABLE "workflow_queries" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"filters" jsonb DEFAULT '[]'::jsonb,
	"sort" jsonb DEFAULT '[]'::jsonb,
	"limit" integer,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "api_keys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"prefix" varchar(50) NOT NULL,
	"key_hash" varchar(255) NOT NULL,
	"scopes" text[] NOT NULL,
	"name" varchar NOT NULL,
	"expires_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "api_keys_key_hash_unique" UNIQUE("key_hash")
);
--> statement-breakpoint
CREATE TABLE "connections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"type" "connection_type" NOT NULL,
	"base_url" varchar(500),
	"auth_config" jsonb DEFAULT '{}'::jsonb,
	"secret_refs" jsonb DEFAULT '{}'::jsonb,
	"oauth_state" jsonb,
	"default_headers" jsonb DEFAULT '{}'::jsonb,
	"timeout_ms" integer DEFAULT 8000,
	"retries" integer DEFAULT 2,
	"backoff_ms" integer DEFAULT 250,
	"enabled" boolean DEFAULT true NOT NULL,
	"last_tested_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "external_destinations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"config" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "oauth_access_tokens" (
	"access_token" varchar PRIMARY KEY NOT NULL,
	"refresh_token" varchar,
	"client_id" varchar NOT NULL,
	"user_id" varchar,
	"workspace_id" uuid NOT NULL,
	"scope" jsonb,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_access_tokens_refresh_token_unique" UNIQUE("refresh_token")
);
--> statement-breakpoint
CREATE TABLE "oauth_apps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"client_id" varchar NOT NULL,
	"client_secret_hash" varchar NOT NULL,
	"redirect_uris" jsonb NOT NULL,
	"scopes" jsonb NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_apps_client_id_unique" UNIQUE("client_id")
);
--> statement-breakpoint
CREATE TABLE "oauth_auth_codes" (
	"code" varchar PRIMARY KEY NOT NULL,
	"client_id" varchar NOT NULL,
	"user_id" varchar NOT NULL,
	"scope" jsonb,
	"redirect_uri" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"key" varchar NOT NULL,
	"value" text,
	"value_enc" text NOT NULL,
	"type" "secret_type" DEFAULT 'api_key' NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"environment" varchar DEFAULT 'production',
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"event" varchar NOT NULL,
	"payload" jsonb NOT NULL,
	"status" varchar NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_attempt_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"target_url" varchar NOT NULL,
	"events" jsonb NOT NULL,
	"secret" varchar NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "billing_plans" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"price_monthly" integer DEFAULT 0 NOT NULL,
	"price_yearly" integer DEFAULT 0 NOT NULL,
	"features" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"limits" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"stripe_product_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "customer_billing_info" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"stripe_customer_id" varchar NOT NULL,
	"billing_email" varchar,
	"default_payment_method_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscription_seats" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"assigned_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"plan_id" uuid NOT NULL,
	"status" "subscription_status" DEFAULT 'active' NOT NULL,
	"stripe_subscription_id" varchar,
	"current_period_start" timestamp,
	"current_period_end" timestamp,
	"cancel_at_period_end" boolean DEFAULT false,
	"canceled_at" timestamp,
	"trial_start" timestamp,
	"trial_end" timestamp,
	"seat_quantity" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "usage_records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"metric" varchar NOT NULL,
	"quantity" integer DEFAULT 1 NOT NULL,
	"workflow_id" uuid,
	"metadata" jsonb,
	"recorded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_template_metadata" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_key" varchar(255) NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"subject_preview" text,
	"branding_tokens" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "email_template_metadata_template_key_unique" UNIQUE("template_key")
);
--> statement-breakpoint
CREATE TABLE "ai_settings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"scope" varchar DEFAULT 'global' NOT NULL,
	"system_prompt" text,
	"updated_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
ALTER TABLE "account_locks" ADD CONSTRAINT "account_locks_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "email_verification_tokens" ADD CONSTRAINT "email_verification_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_backup_codes" ADD CONSTRAINT "mfa_backup_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_secrets" ADD CONSTRAINT "mfa_secrets_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_user_id_users_id_fk" FOREIGN KEY ("invited_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_by_user_id_users_id_fk" FOREIGN KEY ("invited_by_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_created_by_user_id_users_id_fk" FOREIGN KEY ("created_by_user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "password_reset_tokens" ADD CONSTRAINT "password_reset_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "refresh_tokens" ADD CONSTRAINT "refresh_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_team_id_teams_id_fk" FOREIGN KEY ("team_id") REFERENCES "public"."teams"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "teams" ADD CONSTRAINT "teams_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "tenant_domains" ADD CONSTRAINT "tenant_domains_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "trusted_devices" ADD CONSTRAINT "trusted_devices_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_credentials" ADD CONSTRAINT "user_credentials_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_personalization_settings" ADD CONSTRAINT "user_personalization_settings_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_preferences" ADD CONSTRAINT "user_preferences_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "users" ADD CONSTRAINT "users_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspaces" ADD CONSTRAINT "workspaces_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_snapshots" ADD CONSTRAINT "collab_snapshots_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_updates" ADD CONSTRAINT "collab_updates_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "document_hooks" ADD CONSTRAINT "document_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_condition_step_id_steps_id_fk" FOREIGN KEY ("condition_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_step_id_steps_id_fk" FOREIGN KEY ("target_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_section_id_sections_id_fk" FOREIGN KEY ("target_section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "project_access" ADD CONSTRAINT "project_access_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sections" ADD CONSTRAINT "sections_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "steps" ADD CONSTRAINT "steps_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_last_modified_by_users_id_fk" FOREIGN KEY ("last_modified_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_access" ADD CONSTRAINT "workflow_access_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_source_workflow_id_workflows_id_fk" FOREIGN KEY ("source_workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_base_id_workflows_id_fk" FOREIGN KEY ("base_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_reviewer_id_users_id_fk" FOREIGN KEY ("reviewer_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_template_id_workflow_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."workflow_templates"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_logs" ADD CONSTRAINT "run_logs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "script_execution_log" ADD CONSTRAINT "script_execution_log_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_events" ADD CONSTRAINT "signature_events_signature_request_id_signature_requests_id_fk" FOREIGN KEY ("signature_request_id") REFERENCES "public"."signature_requests"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_step_id_steps_id_fk" FOREIGN KEY ("step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_block_id_transform_blocks_id_fk" FOREIGN KEY ("block_id") REFERENCES "public"."transform_blocks"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_current_section_id_sections_id_fk" FOREIGN KEY ("current_section_id") REFERENCES "public"."sections"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_subquestion_id_loop_group_subquestions_id_fk" FOREIGN KEY ("subquestion_id") REFERENCES "public"."loop_group_subquestions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_condition_question_id_questions_id_fk" FOREIGN KEY ("condition_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_question_id_questions_id_fk" FOREIGN KEY ("target_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_page_id_survey_pages_id_fk" FOREIGN KEY ("target_page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "files" ADD CONSTRAINT "files_answer_id_answers_id_fk" FOREIGN KEY ("answer_id") REFERENCES "public"."answers"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "loop_group_subquestions" ADD CONSTRAINT "loop_group_subquestions_loop_question_id_questions_id_fk" FOREIGN KEY ("loop_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "questions" ADD CONSTRAINT "questions_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "responses" ADD CONSTRAINT "responses_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_pages" ADD CONSTRAINT "survey_pages_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_templates" ADD CONSTRAINT "survey_templates_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_template_id_survey_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."survey_templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collection_fields" ADD CONSTRAINT "collection_fields_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collections" ADD CONSTRAINT "collections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_columns" ADD CONSTRAINT "datavault_columns_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_databases" ADD CONSTRAINT "datavault_databases_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_owner_user_id_users_id_fk" FOREIGN KEY ("owner_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "api_keys" ADD CONSTRAINT "api_keys_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "external_destinations" ADD CONSTRAINT "external_destinations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_apps" ADD CONSTRAINT "oauth_apps_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "secrets" ADD CONSTRAINT "secrets_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_events" ADD CONSTRAINT "webhook_events_subscription_id_webhook_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."webhook_subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_subscriptions" ADD CONSTRAINT "webhook_subscriptions_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "customer_billing_info" ADD CONSTRAINT "customer_billing_info_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_subscription_id_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_plan_id_billing_plans_id_fk" FOREIGN KEY ("plan_id") REFERENCES "public"."billing_plans"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_settings" ADD CONSTRAINT "ai_settings_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
CREATE INDEX "account_locks_user_idx" ON "account_locks" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "account_locks_until_idx" ON "account_locks" USING btree ("locked_until");--> statement-breakpoint
CREATE INDEX "audit_logs_tenant_idx" ON "audit_logs" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "audit_logs_user_idx" ON "audit_logs" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "audit_logs_action_idx" ON "audit_logs" USING btree ("action");--> statement-breakpoint
CREATE INDEX "email_verify_token_idx" ON "email_verification_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "email_verify_user_idx" ON "email_verification_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "login_attempts_email_idx" ON "login_attempts" USING btree ("email");--> statement-breakpoint
CREATE INDEX "login_attempts_timestamp_idx" ON "login_attempts" USING btree ("attempted_at");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_user_idx" ON "mfa_backup_codes" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_hash_idx" ON "mfa_backup_codes" USING btree ("code_hash");--> statement-breakpoint
CREATE INDEX "mfa_secrets_user_idx" ON "mfa_secrets" USING btree ("user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "org_invites_token_unique_idx" ON "organization_invites" USING btree ("token");--> statement-breakpoint
CREATE INDEX "idx_org_invites_org_email_status" ON "organization_invites" USING btree ("org_id","invited_email","status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_status" ON "organization_invites" USING btree ("status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_expires" ON "organization_invites" USING btree ("expires_at");--> statement-breakpoint
CREATE UNIQUE INDEX "org_membership_unique_idx" ON "organization_memberships" USING btree ("org_id","user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_org" ON "organization_memberships" USING btree ("org_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_user" ON "organization_memberships" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_role" ON "organization_memberships" USING btree ("role");--> statement-breakpoint
CREATE INDEX "idx_organizations_created_by" ON "organizations" USING btree ("created_by_user_id");--> statement-breakpoint
CREATE INDEX "idx_organizations_tenant" ON "organizations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "pwd_reset_token_idx" ON "password_reset_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "pwd_reset_user_idx" ON "password_reset_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_user_idx" ON "refresh_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_token_idx" ON "refresh_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "IDX_session_expire" ON "sessions" USING btree ("expire");--> statement-breakpoint
CREATE UNIQUE INDEX "team_members_idx" ON "team_members" USING btree ("team_id","user_id");--> statement-breakpoint
CREATE INDEX "teams_tenant_idx" ON "teams" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_tenant_idx" ON "tenant_domains" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_domain_idx" ON "tenant_domains" USING btree ("domain");--> statement-breakpoint
CREATE INDEX "tenants_plan_idx" ON "tenants" USING btree ("plan");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_idx" ON "trusted_devices" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "trusted_devices_fingerprint_idx" ON "trusted_devices" USING btree ("device_fingerprint");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_fingerprint_idx" ON "trusted_devices" USING btree ("user_id","device_fingerprint");--> statement-breakpoint
CREATE INDEX "user_credentials_user_idx" ON "user_credentials" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "users_email_idx" ON "users" USING btree ("email");--> statement-breakpoint
CREATE INDEX "users_tenant_idx" ON "users" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "users_tenant_email_idx" ON "users" USING btree ("tenant_id","email");--> statement-breakpoint
CREATE INDEX "idx_users_is_placeholder" ON "users" USING btree ("is_placeholder");--> statement-breakpoint
CREATE INDEX "idx_users_placeholder_email" ON "users" USING btree ("placeholder_email");--> statement-breakpoint
CREATE INDEX "invitation_token_idx" ON "workspace_invitations" USING btree ("token");--> statement-breakpoint
CREATE INDEX "invitation_ws_email_idx" ON "workspace_invitations" USING btree ("workspace_id","email");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_member_idx" ON "workspace_members" USING btree ("workspace_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_org_slug_idx" ON "workspaces" USING btree ("organization_id","slug");--> statement-breakpoint
CREATE INDEX "blocks_workflow_phase_order_idx" ON "blocks" USING btree ("workflow_id","phase","order");--> statement-breakpoint
CREATE INDEX "collab_docs_workflow_idx" ON "collab_docs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "collab_snapshots_doc_clock_idx" ON "collab_snapshots" USING btree ("doc_id","clock");--> statement-breakpoint
CREATE INDEX "collab_updates_doc_seq_idx" ON "collab_updates" USING btree ("doc_id","seq");--> statement-breakpoint
CREATE INDEX "logic_rules_workflow_idx" ON "logic_rules" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "project_access_project_idx" ON "project_access" USING btree ("project_id");--> statement-breakpoint
CREATE UNIQUE INDEX "project_access_principal_idx" ON "project_access" USING btree ("project_id","principal_type","principal_id");--> statement-breakpoint
CREATE INDEX "projects_tenant_idx" ON "projects" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "projects_created_by_idx" ON "projects" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "projects_creator_idx" ON "projects" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "projects_owner_idx" ON "projects" USING btree ("owner_id");--> statement-breakpoint
CREATE INDEX "idx_projects_owner" ON "projects" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "projects_status_idx" ON "projects" USING btree ("status");--> statement-breakpoint
CREATE INDEX "projects_archived_idx" ON "projects" USING btree ("archived");--> statement-breakpoint
CREATE INDEX "sections_workflow_idx" ON "sections" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "steps_section_idx" ON "steps" USING btree ("section_id");--> statement-breakpoint
CREATE UNIQUE INDEX "template_versions_unique_idx" ON "template_versions" USING btree ("template_id","version_number");--> statement-breakpoint
CREATE INDEX "templates_project_idx" ON "templates" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflow_access_workflow_idx" ON "workflow_access" USING btree ("workflow_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_access_principal_idx" ON "workflow_access" USING btree ("workflow_id","principal_type","principal_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_snapshots_workflow_name_unique" ON "workflow_snapshots" USING btree ("workflow_id","name");--> statement-breakpoint
CREATE INDEX "workflow_templates_version_key_unique" ON "workflow_templates" USING btree ("workflow_version_id","key");--> statement-breakpoint
CREATE INDEX "workflow_versions_workflow_idx" ON "workflow_versions" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_versions_version_number_idx" ON "workflow_versions" USING btree ("workflow_id","version_number");--> statement-breakpoint
CREATE INDEX "workflow_versions_is_draft_idx" ON "workflow_versions" USING btree ("is_draft");--> statement-breakpoint
CREATE INDEX "workflows_project_idx" ON "workflows" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflows_status_idx" ON "workflows" USING btree ("status");--> statement-breakpoint
CREATE INDEX "workflows_is_public_idx" ON "workflows" USING btree ("is_public");--> statement-breakpoint
CREATE INDEX "workflows_slug_idx" ON "workflows" USING btree ("slug");--> statement-breakpoint
CREATE INDEX "workflows_pinned_version_idx" ON "workflows" USING btree ("pinned_version_id");--> statement-breakpoint
CREATE INDEX "idx_workflows_owner" ON "workflows" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "ai_feedback_workflow_idx" ON "ai_workflow_feedback" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "bm_version_block_idx" ON "block_metrics" USING btree ("version_id","block_id");--> statement-breakpoint
CREATE INDEX "metrics_events_project_ts_idx" ON "metrics_events" USING btree ("project_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_workflow_ts_idx" ON "metrics_events" USING btree ("workflow_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_type_idx" ON "metrics_events" USING btree ("type");--> statement-breakpoint
CREATE UNIQUE INDEX "metrics_rollups_unique_idx" ON "metrics_rollups" USING btree ("tenant_id","project_id",COALESCE("workflow_id", '00000000-0000-0000-0000-000000000000'::uuid),"bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "metrics_rollups_project_bucket_idx" ON "metrics_rollups" USING btree ("project_id","bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "review_tasks_run_idx" ON "review_tasks" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "review_tasks_workflow_idx" ON "review_tasks" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "review_tasks_status_idx" ON "review_tasks" USING btree ("status");--> statement-breakpoint
CREATE INDEX "review_tasks_reviewer_idx" ON "review_tasks" USING btree ("reviewer_id");--> statement-breakpoint
CREATE INDEX "run_generated_documents_run_idx" ON "run_generated_documents" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_run_idx" ON "run_logs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_level_idx" ON "run_logs" USING btree ("level");--> statement-breakpoint
CREATE INDEX "run_logs_created_at_idx" ON "run_logs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "run_outputs_run_idx" ON "run_outputs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_outputs_run_template_type_idx" ON "run_outputs" USING btree ("run_id","template_key","file_type");--> statement-breakpoint
CREATE INDEX "runs_workflow_version_idx" ON "runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "runs_status_idx" ON "runs" USING btree ("status");--> statement-breakpoint
CREATE INDEX "runs_created_by_idx" ON "runs" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "runs_created_at_idx" ON "runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "script_execution_log_run_idx" ON "script_execution_log" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_events_request_idx" ON "signature_events" USING btree ("signature_request_id");--> statement-breakpoint
CREATE INDEX "signature_requests_run_idx" ON "signature_requests" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_requests_token_idx" ON "signature_requests" USING btree ("token");--> statement-breakpoint
CREATE INDEX "sli_configs_project_idx" ON "sli_configs" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "sli_windows_project_window_idx" ON "sli_windows" USING btree ("project_id","window_start","window_end");--> statement-breakpoint
CREATE INDEX "step_values_run_idx" ON "step_values" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "step_values_step_idx" ON "step_values" USING btree ("step_id");--> statement-breakpoint
CREATE INDEX "step_values_run_step_idx" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE UNIQUE INDEX "step_values_run_step_unique" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE INDEX "template_metrics_template_idx" ON "template_generation_metrics" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_metrics_run_idx" ON "template_generation_metrics" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_run_idx" ON "transform_block_runs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_block_idx" ON "transform_block_runs" USING btree ("block_id");--> statement-breakpoint
CREATE UNIQUE INDEX "was_workflow_version_date_idx" ON "workflow_analytics_snapshots" USING btree ("workflow_id","version_id","date");--> statement-breakpoint
CREATE INDEX "wre_run_idx" ON "workflow_run_events" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "wre_workflow_ts_idx" ON "workflow_run_events" USING btree ("workflow_id","timestamp");--> statement-breakpoint
CREATE INDEX "wrm_workflow_created_idx" ON "workflow_run_metrics" USING btree ("workflow_id","created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_workflow_idx" ON "workflow_runs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_version_idx" ON "workflow_runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_completed_idx" ON "workflow_runs" USING btree ("completed");--> statement-breakpoint
CREATE INDEX "workflow_runs_run_token_idx" ON "workflow_runs" USING btree ("run_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_share_token_idx" ON "workflow_runs" USING btree ("share_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_current_section_idx" ON "workflow_runs" USING btree ("current_section_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_created_at_idx" ON "workflow_runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_owner_idx" ON "workflow_runs" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "analytics_survey_event_idx" ON "analytics_events" USING btree ("survey_id","event");--> statement-breakpoint
CREATE INDEX "analytics_response_event_idx" ON "analytics_events" USING btree ("response_id","event");--> statement-breakpoint
CREATE INDEX "analytics_timestamp_idx" ON "analytics_events" USING btree ("timestamp");--> statement-breakpoint
CREATE INDEX "anonymous_tracking_survey_ip_idx" ON "anonymous_response_tracking" USING btree ("survey_id","ip_address");--> statement-breakpoint
CREATE INDEX "email_queue_status_idx" ON "email_queue" USING btree ("status");--> statement-breakpoint
CREATE INDEX "email_queue_next_attempt_idx" ON "email_queue" USING btree ("next_attempt_at");--> statement-breakpoint
CREATE INDEX "survey_templates_creator_idx" ON "survey_templates" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "survey_templates_system_idx" ON "survey_templates" USING btree ("is_system");--> statement-breakpoint
CREATE INDEX "surveys_public_link_unique_idx" ON "surveys" USING btree ("public_link");--> statement-breakpoint
CREATE INDEX "surveys_workspace_idx" ON "surveys" USING btree ("workspace_id");--> statement-breakpoint
CREATE INDEX "template_shares_template_idx" ON "template_shares" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_shares_user_idx" ON "template_shares" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "template_shares_pending_email_idx" ON "template_shares" USING btree ("pending_email");--> statement-breakpoint
CREATE INDEX "collection_fields_collection_idx" ON "collection_fields" USING btree ("collection_id");--> statement-breakpoint
CREATE UNIQUE INDEX "collection_fields_slug_unique" ON "collection_fields" USING btree ("collection_id","slug");--> statement-breakpoint
CREATE UNIQUE INDEX "collections_slug_unique" ON "collections" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_database_id" ON "datavault_api_tokens" USING btree ("database_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE INDEX "datavault_columns_table_idx" ON "datavault_columns" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_columns_reference_table_idx" ON "datavault_columns" USING btree ("reference_table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_columns_table_slug_unique" ON "datavault_columns" USING btree ("table_id","slug");--> statement-breakpoint
CREATE INDEX "idx_databases_tenant" ON "datavault_databases" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_databases_scope" ON "datavault_databases" USING btree ("scope_type","scope_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_databases_owner" ON "datavault_databases" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_tenant" ON "datavault_number_sequences" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_table" ON "datavault_number_sequences" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "idx_datavault_sequences_column_unique" ON "datavault_number_sequences" USING btree ("tenant_id","table_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_row_id" ON "datavault_row_notes" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_tenant_id" ON "datavault_row_notes" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_table_idx" ON "datavault_rows" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_created_by_idx" ON "datavault_rows" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "idx_table_permissions_table" ON "datavault_table_permissions" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_table_user_permission" ON "datavault_table_permissions" USING btree ("table_id","user_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_tenant_idx" ON "datavault_tables" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_owner_idx" ON "datavault_tables" USING btree ("owner_user_id");--> statement-breakpoint
CREATE INDEX "idx_tables_database" ON "datavault_tables" USING btree ("database_id","tenant_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_tables_tenant_slug_unique" ON "datavault_tables" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "datavault_values_row_idx" ON "datavault_values" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "datavault_values_column_idx" ON "datavault_values" USING btree ("column_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_values_row_column_unique" ON "datavault_values" USING btree ("row_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_writeback_mappings_workflow" ON "datavault_writeback_mappings" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "records_collection_idx" ON "records" USING btree ("collection_id");--> statement-breakpoint
CREATE INDEX "records_tenant_idx" ON "records" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_data_sources_workflow" ON "workflow_data_sources" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_queries_workflow" ON "workflow_queries" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "api_keys_project_idx" ON "api_keys" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_tenant_idx" ON "connections" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "connections_project_idx" ON "connections" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_project_name_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "connections_type_idx" ON "connections" USING btree ("type");--> statement-breakpoint
CREATE INDEX "connections_enabled_idx" ON "connections" USING btree ("enabled");--> statement-breakpoint
CREATE UNIQUE INDEX "connections_project_name_unique_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "ext_dest_tenant_idx" ON "external_destinations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_client_id_idx" ON "oauth_apps" USING btree ("client_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_workspace_idx" ON "oauth_apps" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "secrets_project_key_env_unique" ON "secrets" USING btree ("project_id","key","environment");--> statement-breakpoint
CREATE INDEX "webhook_events_sub_idx" ON "webhook_events" USING btree ("subscription_id");--> statement-breakpoint
CREATE INDEX "webhook_subs_workspace_idx" ON "webhook_subscriptions" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_org_idx" ON "customer_billing_info" USING btree ("organization_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_stripe_idx" ON "customer_billing_info" USING btree ("stripe_customer_id");--> statement-breakpoint
CREATE UNIQUE INDEX "seat_sub_user_idx" ON "subscription_seats" USING btree ("subscription_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "sub_org_idx" ON "subscriptions" USING btree ("organization_id");--> statement-breakpoint
CREATE INDEX "usage_org_metric_date_idx" ON "usage_records" USING btree ("organization_id","metric","recorded_at");--> statement-breakpoint
CREATE INDEX "email_templates_key_idx" ON "email_template_metadata" USING btree ("template_key");--> statement-breakpoint
CREATE INDEX "ai_settings_scope_idx" ON "ai_settings" USING btree ("scope");
params: 
ΓÜá∩╕Å Migrations failed (non-fatal if DB exists): DrizzleQueryError: Failed query: CREATE TYPE "public"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint
CREATE TYPE "public"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint
CREATE TYPE "public"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint
CREATE TYPE "public"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint
CREATE TYPE "public"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint
CREATE TYPE "public"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint
CREATE TYPE "public"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint
CREATE TYPE "public"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint
CREATE TYPE "public"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint
CREATE TYPE "public"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint
CREATE TYPE "public"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint
CREATE TYPE "public"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint
CREATE TYPE "public"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint
CREATE TYPE "public"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint
CREATE TYPE "public"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint
CREATE TYPE "public"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint
CREATE TYPE "public"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint
CREATE TYPE "public"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint
CREATE TYPE "public"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint
CREATE TYPE "public"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint
CREATE TYPE "public"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint
CREATE TYPE "public"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint
CREATE TYPE "public"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint
CREATE TYPE "public"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint
CREATE TYPE "public"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint
CREATE TYPE "public"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint
CREATE TYPE "public"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint
CREATE TYPE "public"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint
CREATE TYPE "public"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint
CREATE TYPE "public"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint
CREATE TYPE "public"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint
CREATE TYPE "public"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint
CREATE TYPE "public"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint
CREATE TYPE "public"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint
CREATE TYPE "public"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint
CREATE TYPE "public"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint
CREATE TYPE "public"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "public"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint
CREATE TYPE "public"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint
CREATE TYPE "public"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint
CREATE TYPE "public"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint
CREATE TYPE "public"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint
CREATE TYPE "public"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint
CREATE TYPE "public"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint
CREATE TYPE "public"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint
CREATE TYPE "public"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint
CREATE TYPE "public"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint
CREATE TABLE "account_locks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"locked_at" timestamp DEFAULT now() NOT NULL,
	"locked_until" timestamp NOT NULL,
	"reason" varchar(255),
	"unlocked" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "audit_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"workspace_id" uuid,
	"user_id" varchar,
	"action" varchar NOT NULL,
	"entity_type" varchar NOT NULL,
	"entity_id" varchar NOT NULL,
	"resource_type" varchar,
	"resource_id" varchar,
	"changes" jsonb,
	"details" jsonb,
	"ip_address" varchar,
	"user_agent" text,
	"created_at" timestamp DEFAULT now(),
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_verification_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "login_attempts" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"ip_address" varchar(45),
	"successful" boolean DEFAULT false NOT NULL,
	"attempted_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_backup_codes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"code_hash" text NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"secret" text NOT NULL,
	"enabled" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"enabled_at" timestamp,
	CONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "organization_invites" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"invited_email" varchar(255) NOT NULL,
	"invited_user_id" varchar,
	"invited_by_user_id" varchar NOT NULL,
	"token" varchar(255) NOT NULL,
	"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp NOT NULL,
	"accepted_at" timestamp,
	"email_sent_at" timestamp,
	"email_failed" boolean DEFAULT false,
	"email_error" text,
	CONSTRAINT "organization_invites_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "organization_memberships" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "organization_role" DEFAULT 'member' NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "organizations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"slug" varchar,
	"domain" varchar,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"tenant_id" uuid NOT NULL,
	"created_by_user_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "organizations_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "password_reset_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "portal_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "portal_tokens_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "refresh_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"revoked" boolean DEFAULT false NOT NULL,
	"metadata" jsonb,
	"device_name" varchar(255),
	"ip_address" varchar(45),
	"location" varchar(255),
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sessions" (
	"sid" varchar PRIMARY KEY NOT NULL,
	"sess" jsonb NOT NULL,
	"expire" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE "team_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"team_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" varchar(50) DEFAULT 'member' NOT NULL,
	"joined_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "teams" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "tenant_domains" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"domain" text NOT NULL,
	"verified" boolean DEFAULT false,
	"verification_token" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "tenant_domains_domain_unique" UNIQUE("domain")
);
--> statement-breakpoint
CREATE TABLE "tenants" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar(255) NOT NULL,
	"billing_email" varchar(255),
	"plan" "tenant_plan" DEFAULT 'free' NOT NULL,
	"mfa_required" boolean DEFAULT false NOT NULL,
	"branding" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "trusted_devices" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"device_fingerprint" varchar(255) NOT NULL,
	"device_name" varchar(255),
	"trusted_until" timestamp NOT NULL,
	"ip_address" varchar(45),
	"location" varchar(255),
	"user_agent" text,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"last_used_at" timestamp,
	"revoked" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "user_credentials" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"password_hash" text NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "user_credentials_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "user_personalization_settings" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"reading_level" varchar DEFAULT 'standard' NOT NULL,
	"tone" varchar DEFAULT 'neutral' NOT NULL,
	"verbosity" varchar DEFAULT 'standard' NOT NULL,
	"language" varchar DEFAULT 'en' NOT NULL,
	"allow_adaptive_prompts" boolean DEFAULT true NOT NULL,
	"allow_ai_clarification" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "user_preferences" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"settings" jsonb DEFAULT '{"celebrationEffects":true,"darkMode":"system","aiHints":true}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "users" (
	"id" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"full_name" varchar(255),
	"first_name" varchar(255),
	"last_name" varchar(255),
	"profile_image_url" varchar(500),
	"tenant_id" uuid,
	"role" "user_role" DEFAULT 'creator' NOT NULL,
	"tenant_role" "user_tenant_role",
	"auth_provider" "auth_provider" DEFAULT 'local' NOT NULL,
	"default_mode" text DEFAULT 'easy' NOT NULL,
	"email_verified" boolean DEFAULT false NOT NULL,
	"mfa_enabled" boolean DEFAULT false NOT NULL,
	"last_password_change" timestamp,
	"is_placeholder" boolean DEFAULT false NOT NULL,
	"placeholder_email" varchar(255),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_invitations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"email" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"invited_by" varchar NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"joined_at" timestamp DEFAULT now(),
	"invited_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workspaces" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"slug" varchar NOT NULL,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"type" "block_type" NOT NULL,
	"phase" "block_phase" NOT NULL,
	"config" jsonb NOT NULL,
	"virtual_step_id" uuid,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_docs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid,
	"tenant_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"clock" integer NOT NULL,
	"state" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "collab_updates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"seq" integer NOT NULL,
	"update" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "document_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"final_block_document_id" varchar(255),
	"name" varchar(255) NOT NULL,
	"phase" "document_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 3000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "lifecycle_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar(255) NOT NULL,
	"phase" "lifecycle_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"virtual_step_ids" uuid[] DEFAULT '{}'::uuid[],
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"mutation_mode" boolean DEFAULT false,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "logic_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"condition_step_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_type" "logic_rule_target_type" NOT NULL,
	"target_step_id" uuid,
	"target_section_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "project_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "projects" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"name" varchar(255),
	"description" text,
	"creator_id" varchar NOT NULL,
	"tenant_id" uuid,
	"created_by" varchar,
	"owner_id" varchar NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"status" "project_status" DEFAULT 'active' NOT NULL,
	"archived" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"order" integer NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"visible_if" jsonb,
	"skip_if" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "steps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"section_id" uuid NOT NULL,
	"type" "step_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"alias" text,
	"default_value" jsonb,
	"order" integer NOT NULL,
	"is_virtual" boolean DEFAULT false NOT NULL,
	"visible_if" jsonb,
	"repeater_config" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"version_number" integer NOT NULL,
	"file_ref" varchar(500) NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"notes" text,
	"is_active" boolean DEFAULT true
);
--> statement-breakpoint
CREATE TABLE "templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"file_ref" varchar(500) NOT NULL,
	"type" "template_type" NOT NULL,
	"helpers_version" integer DEFAULT 1 NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"current_version" integer DEFAULT 1,
	"last_modified_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_key" varchar NOT NULL,
	"virtual_step_id" uuid,
	"phase" "block_phase" DEFAULT 'onSectionSubmit' NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_blueprints" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"creator_id" varchar NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"graph_json" jsonb NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"source_workflow_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"name" text NOT NULL,
	"values" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"workflow_version_id" uuid,
	"version_hash" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_id" uuid NOT NULL,
	"key" text NOT NULL,
	"is_primary" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"base_id" uuid,
	"version_number" integer DEFAULT 1 NOT NULL,
	"is_draft" boolean DEFAULT false NOT NULL,
	"graph_json" jsonb NOT NULL,
	"migration_info" jsonb,
	"changelog" jsonb,
	"notes" text,
	"checksum" text,
	"created_by" varchar NOT NULL,
	"published" boolean DEFAULT false NOT NULL,
	"published_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"description" text,
	"creator_id" varchar,
	"owner_id" varchar,
	"mode_override" text,
	"public_link" text,
	"name" varchar(255),
	"project_id" uuid,
	"current_version_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"slug" text,
	"require_login" boolean DEFAULT false NOT NULL,
	"intake_config" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"pinned_version_id" uuid,
	"status" "workflow_status" DEFAULT 'draft' NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"source_blueprint_id" uuid,
	CONSTRAINT "workflows_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "ai_workflow_feedback" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid,
	"user_id" varchar,
	"operation_type" varchar NOT NULL,
	"rating" integer NOT NULL,
	"comment" text,
	"ai_provider" varchar,
	"ai_model" varchar,
	"prompt_version" varchar,
	"quality_score" integer,
	"quality_passed" boolean,
	"issues_count" integer,
	"request_description" text,
	"generated_sections" integer,
	"generated_steps" integer,
	"was_edited" boolean DEFAULT false,
	"edit_count" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "block_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"block_id" varchar NOT NULL,
	"total_visits" integer DEFAULT 0,
	"avg_time_ms" integer DEFAULT 0,
	"dropoff_count" integer DEFAULT 0,
	"validation_error_count" integer DEFAULT 0,
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"run_id" uuid,
	"type" "metrics_event_type" NOT NULL,
	"ts" timestamp with time zone DEFAULT now() NOT NULL,
	"duration_ms" integer,
	"payload" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_rollups" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"bucket_start" timestamp with time zone NOT NULL,
	"bucket" "rollup_bucket" NOT NULL,
	"runs_count" integer DEFAULT 0 NOT NULL,
	"runs_success" integer DEFAULT 0 NOT NULL,
	"runs_error" integer DEFAULT 0 NOT NULL,
	"dur_p50" integer,
	"dur_p95" integer,
	"pdf_success" integer DEFAULT 0 NOT NULL,
	"pdf_error" integer DEFAULT 0 NOT NULL,
	"docx_success" integer DEFAULT 0 NOT NULL,
	"docx_error" integer DEFAULT 0 NOT NULL,
	"queue_enqueued" integer DEFAULT 0 NOT NULL,
	"queue_dequeued" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "review_tasks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"status" "review_task_status" DEFAULT 'pending' NOT NULL,
	"reviewer_id" varchar,
	"reviewer_email" varchar(255),
	"message" text,
	"comment" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"resolved_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "run_generated_documents" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"file_name" text NOT NULL,
	"file_url" text NOT NULL,
	"mime_type" text,
	"file_size" integer,
	"template_id" uuid,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"node_id" varchar(100),
	"level" "log_level" NOT NULL,
	"message" text NOT NULL,
	"context" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_outputs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_key" text NOT NULL,
	"file_type" "output_file_type" NOT NULL,
	"storage_path" text NOT NULL,
	"status" "output_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"input_json" jsonb,
	"output_refs" jsonb,
	"trace" jsonb,
	"status" "run_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"duration_ms" integer,
	"run_token" varchar,
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "script_execution_log" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"script_type" varchar(50) NOT NULL,
	"script_id" uuid NOT NULL,
	"script_name" varchar(255),
	"phase" varchar(50),
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "script_execution_status" NOT NULL,
	"error_message" text,
	"console_output" jsonb,
	"input_sample" jsonb,
	"output_sample" jsonb,
	"duration_ms" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "signature_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"signature_request_id" uuid NOT NULL,
	"type" "signature_event_type" NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb
);
--> statement-breakpoint
CREATE TABLE "signature_requests" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"signer_email" varchar(255) NOT NULL,
	"signer_name" varchar(255),
	"status" "signature_request_status" DEFAULT 'pending' NOT NULL,
	"provider" "signature_provider" DEFAULT 'native' NOT NULL,
	"provider_request_id" text,
	"token" text NOT NULL,
	"document_url" text,
	"redirect_url" text,
	"message" text,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"signed_at" timestamp,
	CONSTRAINT "signature_requests_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "sli_configs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"target_success_pct" integer DEFAULT 99 NOT NULL,
	"target_p95_ms" integer DEFAULT 5000 NOT NULL,
	"error_budget_pct" integer DEFAULT 1 NOT NULL,
	"window" "sli_window" DEFAULT '7d' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sli_windows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"window_start" timestamp with time zone NOT NULL,
	"window_end" timestamp with time zone NOT NULL,
	"success_pct" integer,
	"p95_ms" integer,
	"error_budget_burn_pct" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "step_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"step_id" uuid NOT NULL,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_generation_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"run_id" uuid,
	"result" varchar(50) NOT NULL,
	"duration_ms" integer,
	"error_message" text,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_block_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"block_id" uuid NOT NULL,
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "transform_block_run_status" NOT NULL,
	"error_message" text,
	"output_sample" jsonb
);
--> statement-breakpoint
CREATE TABLE "workflow_analytics_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"date" timestamp NOT NULL,
	"summary" jsonb NOT NULL,
	"dropoff" jsonb NOT NULL,
	"branching" jsonb NOT NULL,
	"heatmap" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_run_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"block_id" varchar,
	"page_id" uuid,
	"type" varchar NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb,
	"is_preview" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_run_metrics" (
	"run_id" uuid PRIMARY KEY NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"total_time_ms" integer,
	"pages_visited" integer DEFAULT 0,
	"blocks_visited" integer DEFAULT 0,
	"validation_errors" integer DEFAULT 0,
	"script_errors" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"is_preview" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"workflow_version_id" uuid,
	"run_token" text NOT NULL,
	"created_by" text,
	"current_section_id" uuid,
	"progress" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"metadata" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"client_email" varchar,
	"portal_access_key" varchar,
	"access_mode" "portal_access_mode" DEFAULT 'anonymous',
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"owner_type" varchar(50),
	"owner_uuid" uuid,
	CONSTRAINT "workflow_runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "workflow_runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "analytics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"survey_id" uuid NOT NULL,
	"page_id" uuid,
	"question_id" uuid,
	"event" varchar NOT NULL,
	"data" jsonb,
	"duration" integer,
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "anonymous_response_tracking" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"ip_address" varchar NOT NULL,
	"session_id" varchar,
	"response_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "answers" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"question_id" uuid NOT NULL,
	"subquestion_id" uuid,
	"loop_index" integer,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "conditional_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"condition_question_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_question_id" uuid,
	"target_page_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_queue" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"to" varchar NOT NULL,
	"subject" varchar NOT NULL,
	"html" text NOT NULL,
	"status" "email_queue_status" DEFAULT 'pending' NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_error" text,
	"next_attempt_at" timestamp DEFAULT now(),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "files" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"answer_id" uuid NOT NULL,
	"filename" varchar NOT NULL,
	"original_name" varchar NOT NULL,
	"mime_type" varchar NOT NULL,
	"size" integer NOT NULL,
	"uploaded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "loop_group_subquestions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"loop_question_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "questions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"page_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"conditional_logic" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "responses" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"completed" boolean DEFAULT false,
	"submitted_at" timestamp,
	"is_anonymous" boolean DEFAULT false,
	"ip_address" varchar,
	"user_agent" text,
	"session_id" varchar,
	"anonymous_metadata" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_pages" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" text NOT NULL,
	"description" text,
	"content" jsonb NOT NULL,
	"creator_id" varchar,
	"is_system" boolean DEFAULT false NOT NULL,
	"tags" text[] DEFAULT ARRAY[]::text[],
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "surveys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"creator_id" varchar NOT NULL,
	"workspace_id" uuid,
	"status" "survey_status" DEFAULT 'draft' NOT NULL,
	"allow_anonymous" boolean DEFAULT false,
	"anonymous_access_type" "anonymous_access_type" DEFAULT 'unlimited',
	"public_link" varchar,
	"anonymous_config" jsonb,
	"is_public" boolean DEFAULT false,
	"public_access_mode" "public_access_mode" DEFAULT 'link_only',
	"public_slug" varchar,
	"allowed_domains" jsonb,
	"public_settings" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "surveys_public_link_unique" UNIQUE("public_link"),
	CONSTRAINT "surveys_public_slug_unique" UNIQUE("public_slug")
);
--> statement-breakpoint
CREATE TABLE "template_shares" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"user_id" varchar,
	"pending_email" text,
	"access" "template_access" DEFAULT 'use' NOT NULL,
	"invited_at" timestamp with time zone DEFAULT now(),
	"accepted_at" timestamp with time zone
);
--> statement-breakpoint
CREATE TABLE "collection_fields" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"collection_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"type" varchar(50) NOT NULL,
	"options" jsonb,
	"required" boolean DEFAULT false,
	"order" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_api_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"database_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"label" text NOT NULL,
	"token_hash" text NOT NULL,
	"scopes" text[] DEFAULT ARRAY[]::text[] NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "datavault_columns" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"type" "datavault_column_type" NOT NULL,
	"description" text,
	"width_px" integer DEFAULT 150,
	"required" boolean DEFAULT false NOT NULL,
	"is_primary_key" boolean DEFAULT false NOT NULL,
	"is_unique" boolean DEFAULT false NOT NULL,
	"order_index" integer DEFAULT 0 NOT NULL,
	"auto_number_start" integer DEFAULT 1,
	"autonumber_prefix" text,
	"autonumber_padding" integer DEFAULT 4,
	"autonumber_reset_policy" "autonumber_reset_policy" DEFAULT 'never',
	"reference_table_id" uuid,
	"reference_display_column_slug" text,
	"options" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_databases" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"type" "data_source_type" DEFAULT 'native' NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"scope_type" "datavault_scope_type" DEFAULT 'account' NOT NULL,
	"scope_id" uuid,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_number_sequences" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"prefix" text,
	"padding" integer DEFAULT 4 NOT NULL,
	"next_value" integer DEFAULT 1 NOT NULL,
	"reset_policy" "autonumber_reset_policy" DEFAULT 'never' NOT NULL,
	"last_reset" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_row_notes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"text" text NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_rows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"deleted_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "datavault_table_permissions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "datavault_table_role" NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_tables" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"owner_user_id" varchar,
	"database_id" uuid,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"value" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_writeback_mappings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_mappings" jsonb NOT NULL,
	"trigger_phase" varchar(50) DEFAULT 'afterComplete' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar
);
--> statement-breakpoint
CREATE TABLE "records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"collection_id" uuid NOT NULL,
	"data" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workflow_data_sources" (
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "workflow_data_sources_workflow_id_data_source_id_pk" PRIMARY KEY("workflow_id","data_source_id")
);
--> statement-breakpoint
CREATE TABLE "workflow_queries" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"filters" jsonb DEFAULT '[]'::jsonb,
	"sort" jsonb DEFAULT '[]'::jsonb,
	"limit" integer,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "api_keys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"prefix" varchar(50) NOT NULL,
	"key_hash" varchar(255) NOT NULL,
	"scopes" text[] NOT NULL,
	"name" varchar NOT NULL,
	"expires_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "api_keys_key_hash_unique" UNIQUE("key_hash")
);
--> statement-breakpoint
CREATE TABLE "connections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"type" "connection_type" NOT NULL,
	"base_url" varchar(500),
	"auth_config" jsonb DEFAULT '{}'::jsonb,
	"secret_refs" jsonb DEFAULT '{}'::jsonb,
	"oauth_state" jsonb,
	"default_headers" jsonb DEFAULT '{}'::jsonb,
	"timeout_ms" integer DEFAULT 8000,
	"retries" integer DEFAULT 2,
	"backoff_ms" integer DEFAULT 250,
	"enabled" boolean DEFAULT true NOT NULL,
	"last_tested_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "external_destinations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"config" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "oauth_access_tokens" (
	"access_token" varchar PRIMARY KEY NOT NULL,
	"refresh_token" varchar,
	"client_id" varchar NOT NULL,
	"user_id" varchar,
	"workspace_id" uuid NOT NULL,
	"scope" jsonb,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_access_tokens_refresh_token_unique" UNIQUE("refresh_token")
);
--> statement-breakpoint
CREATE TABLE "oauth_apps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"client_id" varchar NOT NULL,
	"client_secret_hash" varchar NOT NULL,
	"redirect_uris" jsonb NOT NULL,
	"scopes" jsonb NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_apps_client_id_unique" UNIQUE("client_id")
);
--> statement-breakpoint
CREATE TABLE "oauth_auth_codes" (
	"code" varchar PRIMARY KEY NOT NULL,
	"client_id" varchar NOT NULL,
	"user_id" varchar NOT NULL,
	"scope" jsonb,
	"redirect_uri" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"key" varchar NOT NULL,
	"value" text,
	"value_enc" text NOT NULL,
	"type" "secret_type" DEFAULT 'api_key' NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"environment" varchar DEFAULT 'production',
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"event" varchar NOT NULL,
	"payload" jsonb NOT NULL,
	"status" varchar NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_attempt_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"target_url" varchar NOT NULL,
	"events" jsonb NOT NULL,
	"secret" varchar NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "billing_plans" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"price_monthly" integer DEFAULT 0 NOT NULL,
	"price_yearly" integer DEFAULT 0 NOT NULL,
	"features" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"limits" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"stripe_product_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "customer_billing_info" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"stripe_customer_id" varchar NOT NULL,
	"billing_email" varchar,
	"default_payment_method_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscription_seats" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"assigned_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"plan_id" uuid NOT NULL,
	"status" "subscription_status" DEFAULT 'active' NOT NULL,
	"stripe_subscription_id" varchar,
	"current_period_start" timestamp,
	"current_period_end" timestamp,
	"cancel_at_period_end" boolean DEFAULT false,
	"canceled_at" timestamp,
	"trial_start" timestamp,
	"trial_end" timestamp,
	"seat_quantity" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "usage_records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"metric" varchar NOT NULL,
	"quantity" integer DEFAULT 1 NOT NULL,
	"workflow_id" uuid,
	"metadata" jsonb,
	"recorded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_template_metadata" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_key" varchar(255) NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"subject_preview" text,
	"branding_tokens" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "email_template_metadata_template_key_unique" UNIQUE("template_key")
);
--> statement-breakpoint
CREATE TABLE "ai_settings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"scope" varchar DEFAULT 'global' NOT NULL,
	"system_prompt" text,
	"updated_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
ALTER TABLE "account_locks" ADD CONSTRAINT "account_locks_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "email_verification_tokens" ADD CONSTRAINT "email_verification_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_backup_codes" ADD CONSTRAINT "mfa_backup_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_secrets" ADD CONSTRAINT "mfa_secrets_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_user_id_users_id_fk" FOREIGN KEY ("invited_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_by_user_id_users_id_fk" FOREIGN KEY ("invited_by_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_created_by_user_id_users_id_fk" FOREIGN KEY ("created_by_user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "password_reset_tokens" ADD CONSTRAINT "password_reset_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "refresh_tokens" ADD CONSTRAINT "refresh_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_team_id_teams_id_fk" FOREIGN KEY ("team_id") REFERENCES "public"."teams"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "teams" ADD CONSTRAINT "teams_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "tenant_domains" ADD CONSTRAINT "tenant_domains_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "trusted_devices" ADD CONSTRAINT "trusted_devices_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_credentials" ADD CONSTRAINT "user_credentials_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_personalization_settings" ADD CONSTRAINT "user_personalization_settings_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_preferences" ADD CONSTRAINT "user_preferences_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "users" ADD CONSTRAINT "users_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspaces" ADD CONSTRAINT "workspaces_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_snapshots" ADD CONSTRAINT "collab_snapshots_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_updates" ADD CONSTRAINT "collab_updates_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "public"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "document_hooks" ADD CONSTRAINT "document_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_condition_step_id_steps_id_fk" FOREIGN KEY ("condition_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_step_id_steps_id_fk" FOREIGN KEY ("target_step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_section_id_sections_id_fk" FOREIGN KEY ("target_section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "project_access" ADD CONSTRAINT "project_access_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sections" ADD CONSTRAINT "sections_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "steps" ADD CONSTRAINT "steps_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_last_modified_by_users_id_fk" FOREIGN KEY ("last_modified_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "public"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "public"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_access" ADD CONSTRAINT "workflow_access_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_source_workflow_id_workflows_id_fk" FOREIGN KEY ("source_workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_base_id_workflows_id_fk" FOREIGN KEY ("base_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_reviewer_id_users_id_fk" FOREIGN KEY ("reviewer_id") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_template_id_workflow_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."workflow_templates"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_logs" ADD CONSTRAINT "run_logs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "script_execution_log" ADD CONSTRAINT "script_execution_log_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_events" ADD CONSTRAINT "signature_events_signature_request_id_signature_requests_id_fk" FOREIGN KEY ("signature_request_id") REFERENCES "public"."signature_requests"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_step_id_steps_id_fk" FOREIGN KEY ("step_id") REFERENCES "public"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_block_id_transform_blocks_id_fk" FOREIGN KEY ("block_id") REFERENCES "public"."transform_blocks"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "public"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "public"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_current_section_id_sections_id_fk" FOREIGN KEY ("current_section_id") REFERENCES "public"."sections"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "public"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_subquestion_id_loop_group_subquestions_id_fk" FOREIGN KEY ("subquestion_id") REFERENCES "public"."loop_group_subquestions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_condition_question_id_questions_id_fk" FOREIGN KEY ("condition_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_question_id_questions_id_fk" FOREIGN KEY ("target_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_page_id_survey_pages_id_fk" FOREIGN KEY ("target_page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "files" ADD CONSTRAINT "files_answer_id_answers_id_fk" FOREIGN KEY ("answer_id") REFERENCES "public"."answers"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "loop_group_subquestions" ADD CONSTRAINT "loop_group_subquestions_loop_question_id_questions_id_fk" FOREIGN KEY ("loop_question_id") REFERENCES "public"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "questions" ADD CONSTRAINT "questions_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "public"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "responses" ADD CONSTRAINT "responses_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_pages" ADD CONSTRAINT "survey_pages_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "public"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_templates" ADD CONSTRAINT "survey_templates_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "public"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_template_id_survey_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "public"."survey_templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collection_fields" ADD CONSTRAINT "collection_fields_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collections" ADD CONSTRAINT "collections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_columns" ADD CONSTRAINT "datavault_columns_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_databases" ADD CONSTRAINT "datavault_databases_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_owner_user_id_users_id_fk" FOREIGN KEY ("owner_user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "public"."datavault_databases"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "public"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "public"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "public"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "public"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "public"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "api_keys" ADD CONSTRAINT "api_keys_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "external_destinations" ADD CONSTRAINT "external_destinations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "public"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_apps" ADD CONSTRAINT "oauth_apps_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "public"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "secrets" ADD CONSTRAINT "secrets_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_events" ADD CONSTRAINT "webhook_events_subscription_id_webhook_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."webhook_subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_subscriptions" ADD CONSTRAINT "webhook_subscriptions_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "public"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "customer_billing_info" ADD CONSTRAINT "customer_billing_info_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_subscription_id_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "public"."subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_plan_id_billing_plans_id_fk" FOREIGN KEY ("plan_id") REFERENCES "public"."billing_plans"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "public"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "public"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_settings" ADD CONSTRAINT "ai_settings_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "public"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
CREATE INDEX "account_locks_user_idx" ON "account_locks" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "account_locks_until_idx" ON "account_locks" USING btree ("locked_until");--> statement-breakpoint
CREATE INDEX "audit_logs_tenant_idx" ON "audit_logs" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "audit_logs_user_idx" ON "audit_logs" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "audit_logs_action_idx" ON "audit_logs" USING btree ("action");--> statement-breakpoint
CREATE INDEX "email_verify_token_idx" ON "email_verification_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "email_verify_user_idx" ON "email_verification_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "login_attempts_email_idx" ON "login_attempts" USING btree ("email");--> statement-breakpoint
CREATE INDEX "login_attempts_timestamp_idx" ON "login_attempts" USING btree ("attempted_at");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_user_idx" ON "mfa_backup_codes" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_hash_idx" ON "mfa_backup_codes" USING btree ("code_hash");--> statement-breakpoint
CREATE INDEX "mfa_secrets_user_idx" ON "mfa_secrets" USING btree ("user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "org_invites_token_unique_idx" ON "organization_invites" USING btree ("token");--> statement-breakpoint
CREATE INDEX "idx_org_invites_org_email_status" ON "organization_invites" USING btree ("org_id","invited_email","status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_status" ON "organization_invites" USING btree ("status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_expires" ON "organization_invites" USING btree ("expires_at");--> statement-breakpoint
CREATE UNIQUE INDEX "org_membership_unique_idx" ON "organization_memberships" USING btree ("org_id","user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_org" ON "organization_memberships" USING btree ("org_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_user" ON "organization_memberships" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_role" ON "organization_memberships" USING btree ("role");--> statement-breakpoint
CREATE INDEX "idx_organizations_created_by" ON "organizations" USING btree ("created_by_user_id");--> statement-breakpoint
CREATE INDEX "idx_organizations_tenant" ON "organizations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "pwd_reset_token_idx" ON "password_reset_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "pwd_reset_user_idx" ON "password_reset_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_user_idx" ON "refresh_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_token_idx" ON "refresh_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "IDX_session_expire" ON "sessions" USING btree ("expire");--> statement-breakpoint
CREATE UNIQUE INDEX "team_members_idx" ON "team_members" USING btree ("team_id","user_id");--> statement-breakpoint
CREATE INDEX "teams_tenant_idx" ON "teams" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_tenant_idx" ON "tenant_domains" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_domain_idx" ON "tenant_domains" USING btree ("domain");--> statement-breakpoint
CREATE INDEX "tenants_plan_idx" ON "tenants" USING btree ("plan");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_idx" ON "trusted_devices" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "trusted_devices_fingerprint_idx" ON "trusted_devices" USING btree ("device_fingerprint");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_fingerprint_idx" ON "trusted_devices" USING btree ("user_id","device_fingerprint");--> statement-breakpoint
CREATE INDEX "user_credentials_user_idx" ON "user_credentials" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "users_email_idx" ON "users" USING btree ("email");--> statement-breakpoint
CREATE INDEX "users_tenant_idx" ON "users" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "users_tenant_email_idx" ON "users" USING btree ("tenant_id","email");--> statement-breakpoint
CREATE INDEX "idx_users_is_placeholder" ON "users" USING btree ("is_placeholder");--> statement-breakpoint
CREATE INDEX "idx_users_placeholder_email" ON "users" USING btree ("placeholder_email");--> statement-breakpoint
CREATE INDEX "invitation_token_idx" ON "workspace_invitations" USING btree ("token");--> statement-breakpoint
CREATE INDEX "invitation_ws_email_idx" ON "workspace_invitations" USING btree ("workspace_id","email");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_member_idx" ON "workspace_members" USING btree ("workspace_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_org_slug_idx" ON "workspaces" USING btree ("organization_id","slug");--> statement-breakpoint
CREATE INDEX "blocks_workflow_phase_order_idx" ON "blocks" USING btree ("workflow_id","phase","order");--> statement-breakpoint
CREATE INDEX "collab_docs_workflow_idx" ON "collab_docs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "collab_snapshots_doc_clock_idx" ON "collab_snapshots" USING btree ("doc_id","clock");--> statement-breakpoint
CREATE INDEX "collab_updates_doc_seq_idx" ON "collab_updates" USING btree ("doc_id","seq");--> statement-breakpoint
CREATE INDEX "logic_rules_workflow_idx" ON "logic_rules" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "project_access_project_idx" ON "project_access" USING btree ("project_id");--> statement-breakpoint
CREATE UNIQUE INDEX "project_access_principal_idx" ON "project_access" USING btree ("project_id","principal_type","principal_id");--> statement-breakpoint
CREATE INDEX "projects_tenant_idx" ON "projects" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "projects_created_by_idx" ON "projects" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "projects_creator_idx" ON "projects" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "projects_owner_idx" ON "projects" USING btree ("owner_id");--> statement-breakpoint
CREATE INDEX "idx_projects_owner" ON "projects" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "projects_status_idx" ON "projects" USING btree ("status");--> statement-breakpoint
CREATE INDEX "projects_archived_idx" ON "projects" USING btree ("archived");--> statement-breakpoint
CREATE INDEX "sections_workflow_idx" ON "sections" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "steps_section_idx" ON "steps" USING btree ("section_id");--> statement-breakpoint
CREATE UNIQUE INDEX "template_versions_unique_idx" ON "template_versions" USING btree ("template_id","version_number");--> statement-breakpoint
CREATE INDEX "templates_project_idx" ON "templates" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflow_access_workflow_idx" ON "workflow_access" USING btree ("workflow_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_access_principal_idx" ON "workflow_access" USING btree ("workflow_id","principal_type","principal_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_snapshots_workflow_name_unique" ON "workflow_snapshots" USING btree ("workflow_id","name");--> statement-breakpoint
CREATE INDEX "workflow_templates_version_key_unique" ON "workflow_templates" USING btree ("workflow_version_id","key");--> statement-breakpoint
CREATE INDEX "workflow_versions_workflow_idx" ON "workflow_versions" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_versions_version_number_idx" ON "workflow_versions" USING btree ("workflow_id","version_number");--> statement-breakpoint
CREATE INDEX "workflow_versions_is_draft_idx" ON "workflow_versions" USING btree ("is_draft");--> statement-breakpoint
CREATE INDEX "workflows_project_idx" ON "workflows" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflows_status_idx" ON "workflows" USING btree ("status");--> statement-breakpoint
CREATE INDEX "workflows_is_public_idx" ON "workflows" USING btree ("is_public");--> statement-breakpoint
CREATE INDEX "workflows_slug_idx" ON "workflows" USING btree ("slug");--> statement-breakpoint
CREATE INDEX "workflows_pinned_version_idx" ON "workflows" USING btree ("pinned_version_id");--> statement-breakpoint
CREATE INDEX "idx_workflows_owner" ON "workflows" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "ai_feedback_workflow_idx" ON "ai_workflow_feedback" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "bm_version_block_idx" ON "block_metrics" USING btree ("version_id","block_id");--> statement-breakpoint
CREATE INDEX "metrics_events_project_ts_idx" ON "metrics_events" USING btree ("project_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_workflow_ts_idx" ON "metrics_events" USING btree ("workflow_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_type_idx" ON "metrics_events" USING btree ("type");--> statement-breakpoint
CREATE UNIQUE INDEX "metrics_rollups_unique_idx" ON "metrics_rollups" USING btree ("tenant_id","project_id",COALESCE("workflow_id", '00000000-0000-0000-0000-000000000000'::uuid),"bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "metrics_rollups_project_bucket_idx" ON "metrics_rollups" USING btree ("project_id","bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "review_tasks_run_idx" ON "review_tasks" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "review_tasks_workflow_idx" ON "review_tasks" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "review_tasks_status_idx" ON "review_tasks" USING btree ("status");--> statement-breakpoint
CREATE INDEX "review_tasks_reviewer_idx" ON "review_tasks" USING btree ("reviewer_id");--> statement-breakpoint
CREATE INDEX "run_generated_documents_run_idx" ON "run_generated_documents" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_run_idx" ON "run_logs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_level_idx" ON "run_logs" USING btree ("level");--> statement-breakpoint
CREATE INDEX "run_logs_created_at_idx" ON "run_logs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "run_outputs_run_idx" ON "run_outputs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_outputs_run_template_type_idx" ON "run_outputs" USING btree ("run_id","template_key","file_type");--> statement-breakpoint
CREATE INDEX "runs_workflow_version_idx" ON "runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "runs_status_idx" ON "runs" USING btree ("status");--> statement-breakpoint
CREATE INDEX "runs_created_by_idx" ON "runs" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "runs_created_at_idx" ON "runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "script_execution_log_run_idx" ON "script_execution_log" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_events_request_idx" ON "signature_events" USING btree ("signature_request_id");--> statement-breakpoint
CREATE INDEX "signature_requests_run_idx" ON "signature_requests" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_requests_token_idx" ON "signature_requests" USING btree ("token");--> statement-breakpoint
CREATE INDEX "sli_configs_project_idx" ON "sli_configs" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "sli_windows_project_window_idx" ON "sli_windows" USING btree ("project_id","window_start","window_end");--> statement-breakpoint
CREATE INDEX "step_values_run_idx" ON "step_values" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "step_values_step_idx" ON "step_values" USING btree ("step_id");--> statement-breakpoint
CREATE INDEX "step_values_run_step_idx" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE UNIQUE INDEX "step_values_run_step_unique" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE INDEX "template_metrics_template_idx" ON "template_generation_metrics" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_metrics_run_idx" ON "template_generation_metrics" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_run_idx" ON "transform_block_runs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_block_idx" ON "transform_block_runs" USING btree ("block_id");--> statement-breakpoint
CREATE UNIQUE INDEX "was_workflow_version_date_idx" ON "workflow_analytics_snapshots" USING btree ("workflow_id","version_id","date");--> statement-breakpoint
CREATE INDEX "wre_run_idx" ON "workflow_run_events" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "wre_workflow_ts_idx" ON "workflow_run_events" USING btree ("workflow_id","timestamp");--> statement-breakpoint
CREATE INDEX "wrm_workflow_created_idx" ON "workflow_run_metrics" USING btree ("workflow_id","created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_workflow_idx" ON "workflow_runs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_version_idx" ON "workflow_runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_completed_idx" ON "workflow_runs" USING btree ("completed");--> statement-breakpoint
CREATE INDEX "workflow_runs_run_token_idx" ON "workflow_runs" USING btree ("run_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_share_token_idx" ON "workflow_runs" USING btree ("share_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_current_section_idx" ON "workflow_runs" USING btree ("current_section_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_created_at_idx" ON "workflow_runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_owner_idx" ON "workflow_runs" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "analytics_survey_event_idx" ON "analytics_events" USING btree ("survey_id","event");--> statement-breakpoint
CREATE INDEX "analytics_response_event_idx" ON "analytics_events" USING btree ("response_id","event");--> statement-breakpoint
CREATE INDEX "analytics_timestamp_idx" ON "analytics_events" USING btree ("timestamp");--> statement-breakpoint
CREATE INDEX "anonymous_tracking_survey_ip_idx" ON "anonymous_response_tracking" USING btree ("survey_id","ip_address");--> statement-breakpoint
CREATE INDEX "email_queue_status_idx" ON "email_queue" USING btree ("status");--> statement-breakpoint
CREATE INDEX "email_queue_next_attempt_idx" ON "email_queue" USING btree ("next_attempt_at");--> statement-breakpoint
CREATE INDEX "survey_templates_creator_idx" ON "survey_templates" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "survey_templates_system_idx" ON "survey_templates" USING btree ("is_system");--> statement-breakpoint
CREATE INDEX "surveys_public_link_unique_idx" ON "surveys" USING btree ("public_link");--> statement-breakpoint
CREATE INDEX "surveys_workspace_idx" ON "surveys" USING btree ("workspace_id");--> statement-breakpoint
CREATE INDEX "template_shares_template_idx" ON "template_shares" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_shares_user_idx" ON "template_shares" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "template_shares_pending_email_idx" ON "template_shares" USING btree ("pending_email");--> statement-breakpoint
CREATE INDEX "collection_fields_collection_idx" ON "collection_fields" USING btree ("collection_id");--> statement-breakpoint
CREATE UNIQUE INDEX "collection_fields_slug_unique" ON "collection_fields" USING btree ("collection_id","slug");--> statement-breakpoint
CREATE UNIQUE INDEX "collections_slug_unique" ON "collections" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_database_id" ON "datavault_api_tokens" USING btree ("database_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE INDEX "datavault_columns_table_idx" ON "datavault_columns" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_columns_reference_table_idx" ON "datavault_columns" USING btree ("reference_table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_columns_table_slug_unique" ON "datavault_columns" USING btree ("table_id","slug");--> statement-breakpoint
CREATE INDEX "idx_databases_tenant" ON "datavault_databases" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_databases_scope" ON "datavault_databases" USING btree ("scope_type","scope_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_databases_owner" ON "datavault_databases" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_tenant" ON "datavault_number_sequences" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_table" ON "datavault_number_sequences" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "idx_datavault_sequences_column_unique" ON "datavault_number_sequences" USING btree ("tenant_id","table_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_row_id" ON "datavault_row_notes" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_tenant_id" ON "datavault_row_notes" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_table_idx" ON "datavault_rows" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_created_by_idx" ON "datavault_rows" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "idx_table_permissions_table" ON "datavault_table_permissions" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_table_user_permission" ON "datavault_table_permissions" USING btree ("table_id","user_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_tenant_idx" ON "datavault_tables" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_owner_idx" ON "datavault_tables" USING btree ("owner_user_id");--> statement-breakpoint
CREATE INDEX "idx_tables_database" ON "datavault_tables" USING btree ("database_id","tenant_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_tables_tenant_slug_unique" ON "datavault_tables" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "datavault_values_row_idx" ON "datavault_values" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "datavault_values_column_idx" ON "datavault_values" USING btree ("column_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_values_row_column_unique" ON "datavault_values" USING btree ("row_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_writeback_mappings_workflow" ON "datavault_writeback_mappings" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "records_collection_idx" ON "records" USING btree ("collection_id");--> statement-breakpoint
CREATE INDEX "records_tenant_idx" ON "records" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_data_sources_workflow" ON "workflow_data_sources" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_queries_workflow" ON "workflow_queries" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "api_keys_project_idx" ON "api_keys" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_tenant_idx" ON "connections" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "connections_project_idx" ON "connections" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_project_name_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "connections_type_idx" ON "connections" USING btree ("type");--> statement-breakpoint
CREATE INDEX "connections_enabled_idx" ON "connections" USING btree ("enabled");--> statement-breakpoint
CREATE UNIQUE INDEX "connections_project_name_unique_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "ext_dest_tenant_idx" ON "external_destinations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_client_id_idx" ON "oauth_apps" USING btree ("client_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_workspace_idx" ON "oauth_apps" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "secrets_project_key_env_unique" ON "secrets" USING btree ("project_id","key","environment");--> statement-breakpoint
CREATE INDEX "webhook_events_sub_idx" ON "webhook_events" USING btree ("subscription_id");--> statement-breakpoint
CREATE INDEX "webhook_subs_workspace_idx" ON "webhook_subscriptions" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_org_idx" ON "customer_billing_info" USING btree ("organization_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_stripe_idx" ON "customer_billing_info" USING btree ("stripe_customer_id");--> statement-breakpoint
CREATE UNIQUE INDEX "seat_sub_user_idx" ON "subscription_seats" USING btree ("subscription_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "sub_org_idx" ON "subscriptions" USING btree ("organization_id");--> statement-breakpoint
CREATE INDEX "usage_org_metric_date_idx" ON "usage_records" USING btree ("organization_id","metric","recorded_at");--> statement-breakpoint
CREATE INDEX "email_templates_key_idx" ON "email_template_metadata" USING btree ("template_key");--> statement-breakpoint
CREATE INDEX "ai_settings_scope_idx" ON "ai_settings" USING btree ("scope");
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:232:19 {
  query: `CREATE TYPE "public"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint\n` +
    `CREATE TYPE "public"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint\n` +
    'CREATE TABLE "account_locks" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"locked_at" timestamp DEFAULT now() NOT NULL,\n' +
    '\t"locked_until" timestamp NOT NULL,\n' +
    '\t"reason" varchar(255),\n' +
    '\t"unlocked" boolean DEFAULT false NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "audit_logs" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"tenant_id" uuid,\n' +
    '\t"workspace_id" uuid,\n' +
    '\t"user_id" varchar,\n' +
    '\t"action" varchar NOT NULL,\n' +
    '\t"entity_type" varchar NOT NULL,\n' +
    '\t"entity_id" varchar NOT NULL,\n' +
    '\t"resource_type" varchar,\n' +
    '\t"resource_id" varchar,\n' +
    '\t"changes" jsonb,\n' +
    '\t"details" jsonb,\n' +
    '\t"ip_address" varchar,\n' +
    '\t"user_agent" text,\n' +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"timestamp" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "email_verification_tokens" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"token" varchar NOT NULL,\n' +
    '\t"expires_at" timestamp NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "login_attempts" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"email" varchar(255) NOT NULL,\n' +
    '\t"ip_address" varchar(45),\n' +
    '\t"successful" boolean DEFAULT false NOT NULL,\n' +
    '\t"attempted_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "mfa_backup_codes" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"code_hash" text NOT NULL,\n' +
    '\t"used" boolean DEFAULT false NOT NULL,\n' +
    '\t"used_at" timestamp,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "mfa_secrets" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"secret" text NOT NULL,\n' +
    '\t"enabled" boolean DEFAULT false NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL,\n' +
    '\t"enabled_at" timestamp,\n' +
    '\tCONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "organization_invites" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"org_id" uuid NOT NULL,\n' +
    '\t"invited_email" varchar(255) NOT NULL,\n' +
    '\t"invited_user_id" varchar,\n' +
    '\t"invited_by_user_id" varchar NOT NULL,\n' +
    '\t"token" varchar(255) NOT NULL,\n' +
    `\t"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,\n` +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"expires_at" timestamp NOT NULL,\n' +
    '\t"accepted_at" timestamp,\n' +
    '\t"email_sent_at" timestamp,\n' +
    '\t"email_failed" boolean DEFAULT false,\n' +
    '\t"email_error" text,\n' +
    '\tCONSTRAINT "organization_invites_token_unique" UNIQUE("token")\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "organization_memberships" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"org_id" uuid NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    `\t"role" "organization_role" DEFAULT 'member' NOT NULL,\n` +
    '\t"created_at" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "organizations" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"name" varchar NOT NULL,\n' +
    '\t"description" text,\n' +
    '\t"slug" varchar,\n' +
    '\t"domain" varchar,\n' +
    `\t"settings" jsonb DEFAULT '{}'::jsonb,\n` +
    '\t"tenant_id" uuid NOT NULL,\n' +
    '\t"created_by_user_id" varchar,\n' +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"upd'... 108432 more characters,
  params: [],
  cause: error: type "anonymous_access_type" already exists
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:232:19 {
    length: 101,
    severity: 'ERROR',
    code: '42710',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: 'typecmds.c',
    line: '1177',
    routine: 'DefineEnum'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

{"level":30,"time":1768674921451,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768674921468,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768674921458,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768674921459,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768674921463,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768674921463,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768674921467,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768674921468,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768674921468,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768674921468,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768674921698,"env":"test","module":"auth-routes","error":{},"msg":"Registration failed"}
{"level":30,"time":1768674921708,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768674921708,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
CRITICAL REGISTRATION ERROR: ReferenceError: SALT_ROUNDS is not defined
    at AuthService.hashPassword (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:168:38)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:242:46
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 2428ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  12:35:06
   Duration  19.08s (transform 5.87s, setup 2.14s, import 9.50s, tests 2.43s, environment 0ms)

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x1 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöä add secrets lifecycle management: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768675043579,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 0 tables - running migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768675046826,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768675046870,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
≡ƒöä Running test migrations (manual file mode due to broken journal)...

stderr | tests/integration/auth/protected.routes.test.ts
Debug: migrationsDir found: C:\Users\scoot\poll\VaultLogic\migrations
Debug: Found 5 migration files
Debug: Files: 0000_mushy_thing.sql, 0001_fix_collection_schema.sql, 0002_fix_audit_logs.sql, 0003_fix_ai_settings.sql, 0004_restore_autonumber.sql

stdout | tests/integration/auth/protected.routes.test.ts
   Applying 0000_mushy_thing.sql...

stderr | tests/integration/auth/protected.routes.test.ts
Γ¥î FAILED MIGRATION 0000_mushy_thing.sql: Failed query: SET search_path TO "test_schema_w0_v3", public;

CREATE TYPE "test_schema_w0_v3"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint
CREATE TABLE "account_locks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"locked_at" timestamp DEFAULT now() NOT NULL,
	"locked_until" timestamp NOT NULL,
	"reason" varchar(255),
	"unlocked" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "audit_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"workspace_id" uuid,
	"user_id" varchar,
	"action" varchar NOT NULL,
	"entity_type" varchar NOT NULL,
	"entity_id" varchar NOT NULL,
	"resource_type" varchar,
	"resource_id" varchar,
	"changes" jsonb,
	"details" jsonb,
	"ip_address" varchar,
	"user_agent" text,
	"created_at" timestamp DEFAULT now(),
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_verification_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "login_attempts" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"ip_address" varchar(45),
	"successful" boolean DEFAULT false NOT NULL,
	"attempted_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_backup_codes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"code_hash" text NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"secret" text NOT NULL,
	"enabled" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"enabled_at" timestamp,
	CONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "organization_invites" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"invited_email" varchar(255) NOT NULL,
	"invited_user_id" varchar,
	"invited_by_user_id" varchar NOT NULL,
	"token" varchar(255) NOT NULL,
	"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp NOT NULL,
	"accepted_at" timestamp,
	"email_sent_at" timestamp,
	"email_failed" boolean DEFAULT false,
	"email_error" text,
	CONSTRAINT "organization_invites_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "organization_memberships" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "organization_role" DEFAULT 'member' NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "organizations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"slug" varchar,
	"domain" varchar,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"tenant_id" uuid NOT NULL,
	"created_by_user_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "organizations_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "password_reset_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "portal_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "portal_tokens_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "refresh_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"revoked" boolean DEFAULT false NOT NULL,
	"metadata" jsonb,
	"device_name" varchar(255),
	"ip_address" varchar(45),
	"location" varchar(255),
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sessions" (
	"sid" varchar PRIMARY KEY NOT NULL,
	"sess" jsonb NOT NULL,
	"expire" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE "team_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"team_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" varchar(50) DEFAULT 'member' NOT NULL,
	"joined_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "teams" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "tenant_domains" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"domain" text NOT NULL,
	"verified" boolean DEFAULT false,
	"verification_token" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "tenant_domains_domain_unique" UNIQUE("domain")
);
--> statement-breakpoint
CREATE TABLE "tenants" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar(255) NOT NULL,
	"billing_email" varchar(255),
	"plan" "tenant_plan" DEFAULT 'free' NOT NULL,
	"mfa_required" boolean DEFAULT false NOT NULL,
	"branding" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "trusted_devices" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"device_fingerprint" varchar(255) NOT NULL,
	"device_name" varchar(255),
	"trusted_until" timestamp NOT NULL,
	"ip_address" varchar(45),
	"location" varchar(255),
	"user_agent" text,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"last_used_at" timestamp,
	"revoked" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "user_credentials" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"password_hash" text NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "user_credentials_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "user_personalization_settings" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"reading_level" varchar DEFAULT 'standard' NOT NULL,
	"tone" varchar DEFAULT 'neutral' NOT NULL,
	"verbosity" varchar DEFAULT 'standard' NOT NULL,
	"language" varchar DEFAULT 'en' NOT NULL,
	"allow_adaptive_prompts" boolean DEFAULT true NOT NULL,
	"allow_ai_clarification" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "user_preferences" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"settings" jsonb DEFAULT '{"celebrationEffects":true,"darkMode":"system","aiHints":true}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "users" (
	"id" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"full_name" varchar(255),
	"first_name" varchar(255),
	"last_name" varchar(255),
	"profile_image_url" varchar(500),
	"tenant_id" uuid,
	"role" "user_role" DEFAULT 'creator' NOT NULL,
	"tenant_role" "user_tenant_role",
	"auth_provider" "auth_provider" DEFAULT 'local' NOT NULL,
	"default_mode" text DEFAULT 'easy' NOT NULL,
	"email_verified" boolean DEFAULT false NOT NULL,
	"mfa_enabled" boolean DEFAULT false NOT NULL,
	"last_password_change" timestamp,
	"is_placeholder" boolean DEFAULT false NOT NULL,
	"placeholder_email" varchar(255),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_invitations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"email" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"invited_by" varchar NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"joined_at" timestamp DEFAULT now(),
	"invited_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workspaces" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"slug" varchar NOT NULL,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"type" "block_type" NOT NULL,
	"phase" "block_phase" NOT NULL,
	"config" jsonb NOT NULL,
	"virtual_step_id" uuid,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_docs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid,
	"tenant_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"clock" integer NOT NULL,
	"state" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "collab_updates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"seq" integer NOT NULL,
	"update" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "document_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"final_block_document_id" varchar(255),
	"name" varchar(255) NOT NULL,
	"phase" "document_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 3000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "lifecycle_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar(255) NOT NULL,
	"phase" "lifecycle_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"virtual_step_ids" uuid[] DEFAULT '{}'::uuid[],
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"mutation_mode" boolean DEFAULT false,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "logic_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"condition_step_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_type" "logic_rule_target_type" NOT NULL,
	"target_step_id" uuid,
	"target_section_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "project_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "projects" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"name" varchar(255),
	"description" text,
	"creator_id" varchar NOT NULL,
	"tenant_id" uuid,
	"created_by" varchar,
	"owner_id" varchar NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"status" "project_status" DEFAULT 'active' NOT NULL,
	"archived" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"order" integer NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"visible_if" jsonb,
	"skip_if" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "steps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"section_id" uuid NOT NULL,
	"type" "step_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"alias" text,
	"default_value" jsonb,
	"order" integer NOT NULL,
	"is_virtual" boolean DEFAULT false NOT NULL,
	"visible_if" jsonb,
	"repeater_config" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"version_number" integer NOT NULL,
	"file_ref" varchar(500) NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"notes" text,
	"is_active" boolean DEFAULT true
);
--> statement-breakpoint
CREATE TABLE "templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"file_ref" varchar(500) NOT NULL,
	"type" "template_type" NOT NULL,
	"helpers_version" integer DEFAULT 1 NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"current_version" integer DEFAULT 1,
	"last_modified_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_key" varchar NOT NULL,
	"virtual_step_id" uuid,
	"phase" "block_phase" DEFAULT 'onSectionSubmit' NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_blueprints" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"creator_id" varchar NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"graph_json" jsonb NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"source_workflow_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"name" text NOT NULL,
	"values" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"workflow_version_id" uuid,
	"version_hash" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_id" uuid NOT NULL,
	"key" text NOT NULL,
	"is_primary" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"base_id" uuid,
	"version_number" integer DEFAULT 1 NOT NULL,
	"is_draft" boolean DEFAULT false NOT NULL,
	"graph_json" jsonb NOT NULL,
	"migration_info" jsonb,
	"changelog" jsonb,
	"notes" text,
	"checksum" text,
	"created_by" varchar NOT NULL,
	"published" boolean DEFAULT false NOT NULL,
	"published_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"description" text,
	"creator_id" varchar,
	"owner_id" varchar,
	"mode_override" text,
	"public_link" text,
	"name" varchar(255),
	"project_id" uuid,
	"current_version_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"slug" text,
	"require_login" boolean DEFAULT false NOT NULL,
	"intake_config" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"pinned_version_id" uuid,
	"status" "workflow_status" DEFAULT 'draft' NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"source_blueprint_id" uuid,
	CONSTRAINT "workflows_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "ai_workflow_feedback" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid,
	"user_id" varchar,
	"operation_type" varchar NOT NULL,
	"rating" integer NOT NULL,
	"comment" text,
	"ai_provider" varchar,
	"ai_model" varchar,
	"prompt_version" varchar,
	"quality_score" integer,
	"quality_passed" boolean,
	"issues_count" integer,
	"request_description" text,
	"generated_sections" integer,
	"generated_steps" integer,
	"was_edited" boolean DEFAULT false,
	"edit_count" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "block_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"block_id" varchar NOT NULL,
	"total_visits" integer DEFAULT 0,
	"avg_time_ms" integer DEFAULT 0,
	"dropoff_count" integer DEFAULT 0,
	"validation_error_count" integer DEFAULT 0,
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"run_id" uuid,
	"type" "metrics_event_type" NOT NULL,
	"ts" timestamp with time zone DEFAULT now() NOT NULL,
	"duration_ms" integer,
	"payload" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_rollups" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"bucket_start" timestamp with time zone NOT NULL,
	"bucket" "rollup_bucket" NOT NULL,
	"runs_count" integer DEFAULT 0 NOT NULL,
	"runs_success" integer DEFAULT 0 NOT NULL,
	"runs_error" integer DEFAULT 0 NOT NULL,
	"dur_p50" integer,
	"dur_p95" integer,
	"pdf_success" integer DEFAULT 0 NOT NULL,
	"pdf_error" integer DEFAULT 0 NOT NULL,
	"docx_success" integer DEFAULT 0 NOT NULL,
	"docx_error" integer DEFAULT 0 NOT NULL,
	"queue_enqueued" integer DEFAULT 0 NOT NULL,
	"queue_dequeued" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "review_tasks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"status" "review_task_status" DEFAULT 'pending' NOT NULL,
	"reviewer_id" varchar,
	"reviewer_email" varchar(255),
	"message" text,
	"comment" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"resolved_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "run_generated_documents" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"file_name" text NOT NULL,
	"file_url" text NOT NULL,
	"mime_type" text,
	"file_size" integer,
	"template_id" uuid,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"node_id" varchar(100),
	"level" "log_level" NOT NULL,
	"message" text NOT NULL,
	"context" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_outputs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_key" text NOT NULL,
	"file_type" "output_file_type" NOT NULL,
	"storage_path" text NOT NULL,
	"status" "output_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"input_json" jsonb,
	"output_refs" jsonb,
	"trace" jsonb,
	"status" "run_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"duration_ms" integer,
	"run_token" varchar,
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "script_execution_log" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"script_type" varchar(50) NOT NULL,
	"script_id" uuid NOT NULL,
	"script_name" varchar(255),
	"phase" varchar(50),
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "script_execution_status" NOT NULL,
	"error_message" text,
	"console_output" jsonb,
	"input_sample" jsonb,
	"output_sample" jsonb,
	"duration_ms" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "signature_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"signature_request_id" uuid NOT NULL,
	"type" "signature_event_type" NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb
);
--> statement-breakpoint
CREATE TABLE "signature_requests" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"signer_email" varchar(255) NOT NULL,
	"signer_name" varchar(255),
	"status" "signature_request_status" DEFAULT 'pending' NOT NULL,
	"provider" "signature_provider" DEFAULT 'native' NOT NULL,
	"provider_request_id" text,
	"token" text NOT NULL,
	"document_url" text,
	"redirect_url" text,
	"message" text,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"signed_at" timestamp,
	CONSTRAINT "signature_requests_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "sli_configs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"target_success_pct" integer DEFAULT 99 NOT NULL,
	"target_p95_ms" integer DEFAULT 5000 NOT NULL,
	"error_budget_pct" integer DEFAULT 1 NOT NULL,
	"window" "sli_window" DEFAULT '7d' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sli_windows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"window_start" timestamp with time zone NOT NULL,
	"window_end" timestamp with time zone NOT NULL,
	"success_pct" integer,
	"p95_ms" integer,
	"error_budget_burn_pct" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "step_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"step_id" uuid NOT NULL,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_generation_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"run_id" uuid,
	"result" varchar(50) NOT NULL,
	"duration_ms" integer,
	"error_message" text,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_block_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"block_id" uuid NOT NULL,
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "transform_block_run_status" NOT NULL,
	"error_message" text,
	"output_sample" jsonb
);
--> statement-breakpoint
CREATE TABLE "workflow_analytics_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"date" timestamp NOT NULL,
	"summary" jsonb NOT NULL,
	"dropoff" jsonb NOT NULL,
	"branching" jsonb NOT NULL,
	"heatmap" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_run_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"block_id" varchar,
	"page_id" uuid,
	"type" varchar NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb,
	"is_preview" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_run_metrics" (
	"run_id" uuid PRIMARY KEY NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"total_time_ms" integer,
	"pages_visited" integer DEFAULT 0,
	"blocks_visited" integer DEFAULT 0,
	"validation_errors" integer DEFAULT 0,
	"script_errors" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"is_preview" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"workflow_version_id" uuid,
	"run_token" text NOT NULL,
	"created_by" text,
	"current_section_id" uuid,
	"progress" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"metadata" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"client_email" varchar,
	"portal_access_key" varchar,
	"access_mode" "portal_access_mode" DEFAULT 'anonymous',
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"owner_type" varchar(50),
	"owner_uuid" uuid,
	CONSTRAINT "workflow_runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "workflow_runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "analytics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"survey_id" uuid NOT NULL,
	"page_id" uuid,
	"question_id" uuid,
	"event" varchar NOT NULL,
	"data" jsonb,
	"duration" integer,
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "anonymous_response_tracking" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"ip_address" varchar NOT NULL,
	"session_id" varchar,
	"response_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "answers" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"question_id" uuid NOT NULL,
	"subquestion_id" uuid,
	"loop_index" integer,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "conditional_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"condition_question_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_question_id" uuid,
	"target_page_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_queue" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"to" varchar NOT NULL,
	"subject" varchar NOT NULL,
	"html" text NOT NULL,
	"status" "email_queue_status" DEFAULT 'pending' NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_error" text,
	"next_attempt_at" timestamp DEFAULT now(),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "files" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"answer_id" uuid NOT NULL,
	"filename" varchar NOT NULL,
	"original_name" varchar NOT NULL,
	"mime_type" varchar NOT NULL,
	"size" integer NOT NULL,
	"uploaded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "loop_group_subquestions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"loop_question_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "questions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"page_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"conditional_logic" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "responses" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"completed" boolean DEFAULT false,
	"submitted_at" timestamp,
	"is_anonymous" boolean DEFAULT false,
	"ip_address" varchar,
	"user_agent" text,
	"session_id" varchar,
	"anonymous_metadata" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_pages" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" text NOT NULL,
	"description" text,
	"content" jsonb NOT NULL,
	"creator_id" varchar,
	"is_system" boolean DEFAULT false NOT NULL,
	"tags" text[] DEFAULT ARRAY[]::text[],
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "surveys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"creator_id" varchar NOT NULL,
	"workspace_id" uuid,
	"status" "survey_status" DEFAULT 'draft' NOT NULL,
	"allow_anonymous" boolean DEFAULT false,
	"anonymous_access_type" "anonymous_access_type" DEFAULT 'unlimited',
	"public_link" varchar,
	"anonymous_config" jsonb,
	"is_public" boolean DEFAULT false,
	"public_access_mode" "public_access_mode" DEFAULT 'link_only',
	"public_slug" varchar,
	"allowed_domains" jsonb,
	"public_settings" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "surveys_public_link_unique" UNIQUE("public_link"),
	CONSTRAINT "surveys_public_slug_unique" UNIQUE("public_slug")
);
--> statement-breakpoint
CREATE TABLE "template_shares" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"user_id" varchar,
	"pending_email" text,
	"access" "template_access" DEFAULT 'use' NOT NULL,
	"invited_at" timestamp with time zone DEFAULT now(),
	"accepted_at" timestamp with time zone
);
--> statement-breakpoint
CREATE TABLE "collection_fields" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"collection_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"type" varchar(50) NOT NULL,
	"options" jsonb,
	"required" boolean DEFAULT false,
	"order" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_api_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"database_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"label" text NOT NULL,
	"token_hash" text NOT NULL,
	"scopes" text[] DEFAULT ARRAY[]::text[] NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "datavault_columns" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"type" "datavault_column_type" NOT NULL,
	"description" text,
	"width_px" integer DEFAULT 150,
	"required" boolean DEFAULT false NOT NULL,
	"is_primary_key" boolean DEFAULT false NOT NULL,
	"is_unique" boolean DEFAULT false NOT NULL,
	"order_index" integer DEFAULT 0 NOT NULL,
	"auto_number_start" integer DEFAULT 1,
	"autonumber_prefix" text,
	"autonumber_padding" integer DEFAULT 4,
	"autonumber_reset_policy" "autonumber_reset_policy" DEFAULT 'never',
	"reference_table_id" uuid,
	"reference_display_column_slug" text,
	"options" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_databases" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"type" "data_source_type" DEFAULT 'native' NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"scope_type" "datavault_scope_type" DEFAULT 'account' NOT NULL,
	"scope_id" uuid,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_number_sequences" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"prefix" text,
	"padding" integer DEFAULT 4 NOT NULL,
	"next_value" integer DEFAULT 1 NOT NULL,
	"reset_policy" "autonumber_reset_policy" DEFAULT 'never' NOT NULL,
	"last_reset" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_row_notes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"text" text NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_rows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"deleted_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "datavault_table_permissions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "datavault_table_role" NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_tables" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"owner_user_id" varchar,
	"database_id" uuid,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"value" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_writeback_mappings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_mappings" jsonb NOT NULL,
	"trigger_phase" varchar(50) DEFAULT 'afterComplete' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar
);
--> statement-breakpoint
CREATE TABLE "records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"collection_id" uuid NOT NULL,
	"data" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workflow_data_sources" (
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "workflow_data_sources_workflow_id_data_source_id_pk" PRIMARY KEY("workflow_id","data_source_id")
);
--> statement-breakpoint
CREATE TABLE "workflow_queries" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"filters" jsonb DEFAULT '[]'::jsonb,
	"sort" jsonb DEFAULT '[]'::jsonb,
	"limit" integer,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "api_keys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"prefix" varchar(50) NOT NULL,
	"key_hash" varchar(255) NOT NULL,
	"scopes" text[] NOT NULL,
	"name" varchar NOT NULL,
	"expires_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "api_keys_key_hash_unique" UNIQUE("key_hash")
);
--> statement-breakpoint
CREATE TABLE "connections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"type" "connection_type" NOT NULL,
	"base_url" varchar(500),
	"auth_config" jsonb DEFAULT '{}'::jsonb,
	"secret_refs" jsonb DEFAULT '{}'::jsonb,
	"oauth_state" jsonb,
	"default_headers" jsonb DEFAULT '{}'::jsonb,
	"timeout_ms" integer DEFAULT 8000,
	"retries" integer DEFAULT 2,
	"backoff_ms" integer DEFAULT 250,
	"enabled" boolean DEFAULT true NOT NULL,
	"last_tested_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "external_destinations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"config" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "oauth_access_tokens" (
	"access_token" varchar PRIMARY KEY NOT NULL,
	"refresh_token" varchar,
	"client_id" varchar NOT NULL,
	"user_id" varchar,
	"workspace_id" uuid NOT NULL,
	"scope" jsonb,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_access_tokens_refresh_token_unique" UNIQUE("refresh_token")
);
--> statement-breakpoint
CREATE TABLE "oauth_apps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"client_id" varchar NOT NULL,
	"client_secret_hash" varchar NOT NULL,
	"redirect_uris" jsonb NOT NULL,
	"scopes" jsonb NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_apps_client_id_unique" UNIQUE("client_id")
);
--> statement-breakpoint
CREATE TABLE "oauth_auth_codes" (
	"code" varchar PRIMARY KEY NOT NULL,
	"client_id" varchar NOT NULL,
	"user_id" varchar NOT NULL,
	"scope" jsonb,
	"redirect_uri" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"key" varchar NOT NULL,
	"value" text,
	"value_enc" text NOT NULL,
	"type" "secret_type" DEFAULT 'api_key' NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"environment" varchar DEFAULT 'production',
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"event" varchar NOT NULL,
	"payload" jsonb NOT NULL,
	"status" varchar NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_attempt_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"target_url" varchar NOT NULL,
	"events" jsonb NOT NULL,
	"secret" varchar NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "billing_plans" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"price_monthly" integer DEFAULT 0 NOT NULL,
	"price_yearly" integer DEFAULT 0 NOT NULL,
	"features" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"limits" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"stripe_product_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "customer_billing_info" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"stripe_customer_id" varchar NOT NULL,
	"billing_email" varchar,
	"default_payment_method_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscription_seats" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"assigned_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"plan_id" uuid NOT NULL,
	"status" "subscription_status" DEFAULT 'active' NOT NULL,
	"stripe_subscription_id" varchar,
	"current_period_start" timestamp,
	"current_period_end" timestamp,
	"cancel_at_period_end" boolean DEFAULT false,
	"canceled_at" timestamp,
	"trial_start" timestamp,
	"trial_end" timestamp,
	"seat_quantity" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "usage_records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"metric" varchar NOT NULL,
	"quantity" integer DEFAULT 1 NOT NULL,
	"workflow_id" uuid,
	"metadata" jsonb,
	"recorded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_template_metadata" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_key" varchar(255) NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"subject_preview" text,
	"branding_tokens" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "email_template_metadata_template_key_unique" UNIQUE("template_key")
);
--> statement-breakpoint
CREATE TABLE "ai_settings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"scope" varchar DEFAULT 'global' NOT NULL,
	"system_prompt" text,
	"updated_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
ALTER TABLE "account_locks" ADD CONSTRAINT "account_locks_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "email_verification_tokens" ADD CONSTRAINT "email_verification_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_backup_codes" ADD CONSTRAINT "mfa_backup_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_secrets" ADD CONSTRAINT "mfa_secrets_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_user_id_users_id_fk" FOREIGN KEY ("invited_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_by_user_id_users_id_fk" FOREIGN KEY ("invited_by_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_created_by_user_id_users_id_fk" FOREIGN KEY ("created_by_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "password_reset_tokens" ADD CONSTRAINT "password_reset_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "refresh_tokens" ADD CONSTRAINT "refresh_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_team_id_teams_id_fk" FOREIGN KEY ("team_id") REFERENCES "test_schema_w0_v3"."teams"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "teams" ADD CONSTRAINT "teams_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "tenant_domains" ADD CONSTRAINT "tenant_domains_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "trusted_devices" ADD CONSTRAINT "trusted_devices_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_credentials" ADD CONSTRAINT "user_credentials_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_personalization_settings" ADD CONSTRAINT "user_personalization_settings_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_preferences" ADD CONSTRAINT "user_preferences_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "users" ADD CONSTRAINT "users_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspaces" ADD CONSTRAINT "workspaces_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_snapshots" ADD CONSTRAINT "collab_snapshots_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "test_schema_w0_v3"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_updates" ADD CONSTRAINT "collab_updates_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "test_schema_w0_v3"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "document_hooks" ADD CONSTRAINT "document_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_condition_step_id_steps_id_fk" FOREIGN KEY ("condition_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_step_id_steps_id_fk" FOREIGN KEY ("target_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_section_id_sections_id_fk" FOREIGN KEY ("target_section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "project_access" ADD CONSTRAINT "project_access_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sections" ADD CONSTRAINT "sections_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "steps" ADD CONSTRAINT "steps_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_last_modified_by_users_id_fk" FOREIGN KEY ("last_modified_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_access" ADD CONSTRAINT "workflow_access_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_source_workflow_id_workflows_id_fk" FOREIGN KEY ("source_workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_base_id_workflows_id_fk" FOREIGN KEY ("base_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_reviewer_id_users_id_fk" FOREIGN KEY ("reviewer_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_template_id_workflow_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."workflow_templates"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_logs" ADD CONSTRAINT "run_logs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "script_execution_log" ADD CONSTRAINT "script_execution_log_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_events" ADD CONSTRAINT "signature_events_signature_request_id_signature_requests_id_fk" FOREIGN KEY ("signature_request_id") REFERENCES "test_schema_w0_v3"."signature_requests"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_step_id_steps_id_fk" FOREIGN KEY ("step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_block_id_transform_blocks_id_fk" FOREIGN KEY ("block_id") REFERENCES "test_schema_w0_v3"."transform_blocks"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_current_section_id_sections_id_fk" FOREIGN KEY ("current_section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "test_schema_w0_v3"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "test_schema_w0_v3"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "test_schema_w0_v3"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "test_schema_w0_v3"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_subquestion_id_loop_group_subquestions_id_fk" FOREIGN KEY ("subquestion_id") REFERENCES "test_schema_w0_v3"."loop_group_subquestions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_condition_question_id_questions_id_fk" FOREIGN KEY ("condition_question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_question_id_questions_id_fk" FOREIGN KEY ("target_question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_page_id_survey_pages_id_fk" FOREIGN KEY ("target_page_id") REFERENCES "test_schema_w0_v3"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "files" ADD CONSTRAINT "files_answer_id_answers_id_fk" FOREIGN KEY ("answer_id") REFERENCES "test_schema_w0_v3"."answers"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "loop_group_subquestions" ADD CONSTRAINT "loop_group_subquestions_loop_question_id_questions_id_fk" FOREIGN KEY ("loop_question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "questions" ADD CONSTRAINT "questions_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "test_schema_w0_v3"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "responses" ADD CONSTRAINT "responses_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_pages" ADD CONSTRAINT "survey_pages_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_templates" ADD CONSTRAINT "survey_templates_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_template_id_survey_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."survey_templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collection_fields" ADD CONSTRAINT "collection_fields_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "test_schema_w0_v3"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collections" ADD CONSTRAINT "collections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_columns" ADD CONSTRAINT "datavault_columns_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_databases" ADD CONSTRAINT "datavault_databases_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "test_schema_w0_v3"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "test_schema_w0_v3"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_owner_user_id_users_id_fk" FOREIGN KEY ("owner_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "test_schema_w0_v3"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "test_schema_w0_v3"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "test_schema_w0_v3"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "api_keys" ADD CONSTRAINT "api_keys_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "external_destinations" ADD CONSTRAINT "external_destinations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "test_schema_w0_v3"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_apps" ADD CONSTRAINT "oauth_apps_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "test_schema_w0_v3"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "secrets" ADD CONSTRAINT "secrets_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_events" ADD CONSTRAINT "webhook_events_subscription_id_webhook_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "test_schema_w0_v3"."webhook_subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_subscriptions" ADD CONSTRAINT "webhook_subscriptions_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "customer_billing_info" ADD CONSTRAINT "customer_billing_info_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_subscription_id_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "test_schema_w0_v3"."subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_plan_id_billing_plans_id_fk" FOREIGN KEY ("plan_id") REFERENCES "test_schema_w0_v3"."billing_plans"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_settings" ADD CONSTRAINT "ai_settings_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
CREATE INDEX "account_locks_user_idx" ON "account_locks" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "account_locks_until_idx" ON "account_locks" USING btree ("locked_until");--> statement-breakpoint
CREATE INDEX "audit_logs_tenant_idx" ON "audit_logs" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "audit_logs_user_idx" ON "audit_logs" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "audit_logs_action_idx" ON "audit_logs" USING btree ("action");--> statement-breakpoint
CREATE INDEX "email_verify_token_idx" ON "email_verification_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "email_verify_user_idx" ON "email_verification_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "login_attempts_email_idx" ON "login_attempts" USING btree ("email");--> statement-breakpoint
CREATE INDEX "login_attempts_timestamp_idx" ON "login_attempts" USING btree ("attempted_at");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_user_idx" ON "mfa_backup_codes" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_hash_idx" ON "mfa_backup_codes" USING btree ("code_hash");--> statement-breakpoint
CREATE INDEX "mfa_secrets_user_idx" ON "mfa_secrets" USING btree ("user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "org_invites_token_unique_idx" ON "organization_invites" USING btree ("token");--> statement-breakpoint
CREATE INDEX "idx_org_invites_org_email_status" ON "organization_invites" USING btree ("org_id","invited_email","status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_status" ON "organization_invites" USING btree ("status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_expires" ON "organization_invites" USING btree ("expires_at");--> statement-breakpoint
CREATE UNIQUE INDEX "org_membership_unique_idx" ON "organization_memberships" USING btree ("org_id","user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_org" ON "organization_memberships" USING btree ("org_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_user" ON "organization_memberships" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_role" ON "organization_memberships" USING btree ("role");--> statement-breakpoint
CREATE INDEX "idx_organizations_created_by" ON "organizations" USING btree ("created_by_user_id");--> statement-breakpoint
CREATE INDEX "idx_organizations_tenant" ON "organizations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "pwd_reset_token_idx" ON "password_reset_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "pwd_reset_user_idx" ON "password_reset_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_user_idx" ON "refresh_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_token_idx" ON "refresh_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "IDX_session_expire" ON "sessions" USING btree ("expire");--> statement-breakpoint
CREATE UNIQUE INDEX "team_members_idx" ON "team_members" USING btree ("team_id","user_id");--> statement-breakpoint
CREATE INDEX "teams_tenant_idx" ON "teams" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_tenant_idx" ON "tenant_domains" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_domain_idx" ON "tenant_domains" USING btree ("domain");--> statement-breakpoint
CREATE INDEX "tenants_plan_idx" ON "tenants" USING btree ("plan");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_idx" ON "trusted_devices" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "trusted_devices_fingerprint_idx" ON "trusted_devices" USING btree ("device_fingerprint");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_fingerprint_idx" ON "trusted_devices" USING btree ("user_id","device_fingerprint");--> statement-breakpoint
CREATE INDEX "user_credentials_user_idx" ON "user_credentials" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "users_email_idx" ON "users" USING btree ("email");--> statement-breakpoint
CREATE INDEX "users_tenant_idx" ON "users" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "users_tenant_email_idx" ON "users" USING btree ("tenant_id","email");--> statement-breakpoint
CREATE INDEX "idx_users_is_placeholder" ON "users" USING btree ("is_placeholder");--> statement-breakpoint
CREATE INDEX "idx_users_placeholder_email" ON "users" USING btree ("placeholder_email");--> statement-breakpoint
CREATE INDEX "invitation_token_idx" ON "workspace_invitations" USING btree ("token");--> statement-breakpoint
CREATE INDEX "invitation_ws_email_idx" ON "workspace_invitations" USING btree ("workspace_id","email");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_member_idx" ON "workspace_members" USING btree ("workspace_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_org_slug_idx" ON "workspaces" USING btree ("organization_id","slug");--> statement-breakpoint
CREATE INDEX "blocks_workflow_phase_order_idx" ON "blocks" USING btree ("workflow_id","phase","order");--> statement-breakpoint
CREATE INDEX "collab_docs_workflow_idx" ON "collab_docs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "collab_snapshots_doc_clock_idx" ON "collab_snapshots" USING btree ("doc_id","clock");--> statement-breakpoint
CREATE INDEX "collab_updates_doc_seq_idx" ON "collab_updates" USING btree ("doc_id","seq");--> statement-breakpoint
CREATE INDEX "logic_rules_workflow_idx" ON "logic_rules" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "project_access_project_idx" ON "project_access" USING btree ("project_id");--> statement-breakpoint
CREATE UNIQUE INDEX "project_access_principal_idx" ON "project_access" USING btree ("project_id","principal_type","principal_id");--> statement-breakpoint
CREATE INDEX "projects_tenant_idx" ON "projects" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "projects_created_by_idx" ON "projects" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "projects_creator_idx" ON "projects" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "projects_owner_idx" ON "projects" USING btree ("owner_id");--> statement-breakpoint
CREATE INDEX "idx_projects_owner" ON "projects" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "projects_status_idx" ON "projects" USING btree ("status");--> statement-breakpoint
CREATE INDEX "projects_archived_idx" ON "projects" USING btree ("archived");--> statement-breakpoint
CREATE INDEX "sections_workflow_idx" ON "sections" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "steps_section_idx" ON "steps" USING btree ("section_id");--> statement-breakpoint
CREATE UNIQUE INDEX "template_versions_unique_idx" ON "template_versions" USING btree ("template_id","version_number");--> statement-breakpoint
CREATE INDEX "templates_project_idx" ON "templates" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflow_access_workflow_idx" ON "workflow_access" USING btree ("workflow_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_access_principal_idx" ON "workflow_access" USING btree ("workflow_id","principal_type","principal_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_snapshots_workflow_name_unique" ON "workflow_snapshots" USING btree ("workflow_id","name");--> statement-breakpoint
CREATE INDEX "workflow_templates_version_key_unique" ON "workflow_templates" USING btree ("workflow_version_id","key");--> statement-breakpoint
CREATE INDEX "workflow_versions_workflow_idx" ON "workflow_versions" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_versions_version_number_idx" ON "workflow_versions" USING btree ("workflow_id","version_number");--> statement-breakpoint
CREATE INDEX "workflow_versions_is_draft_idx" ON "workflow_versions" USING btree ("is_draft");--> statement-breakpoint
CREATE INDEX "workflows_project_idx" ON "workflows" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflows_status_idx" ON "workflows" USING btree ("status");--> statement-breakpoint
CREATE INDEX "workflows_is_public_idx" ON "workflows" USING btree ("is_public");--> statement-breakpoint
CREATE INDEX "workflows_slug_idx" ON "workflows" USING btree ("slug");--> statement-breakpoint
CREATE INDEX "workflows_pinned_version_idx" ON "workflows" USING btree ("pinned_version_id");--> statement-breakpoint
CREATE INDEX "idx_workflows_owner" ON "workflows" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "ai_feedback_workflow_idx" ON "ai_workflow_feedback" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "bm_version_block_idx" ON "block_metrics" USING btree ("version_id","block_id");--> statement-breakpoint
CREATE INDEX "metrics_events_project_ts_idx" ON "metrics_events" USING btree ("project_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_workflow_ts_idx" ON "metrics_events" USING btree ("workflow_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_type_idx" ON "metrics_events" USING btree ("type");--> statement-breakpoint
CREATE UNIQUE INDEX "metrics_rollups_unique_idx" ON "metrics_rollups" USING btree ("tenant_id","project_id",COALESCE("workflow_id", '00000000-0000-0000-0000-000000000000'::uuid),"bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "metrics_rollups_project_bucket_idx" ON "metrics_rollups" USING btree ("project_id","bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "review_tasks_run_idx" ON "review_tasks" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "review_tasks_workflow_idx" ON "review_tasks" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "review_tasks_status_idx" ON "review_tasks" USING btree ("status");--> statement-breakpoint
CREATE INDEX "review_tasks_reviewer_idx" ON "review_tasks" USING btree ("reviewer_id");--> statement-breakpoint
CREATE INDEX "run_generated_documents_run_idx" ON "run_generated_documents" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_run_idx" ON "run_logs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_level_idx" ON "run_logs" USING btree ("level");--> statement-breakpoint
CREATE INDEX "run_logs_created_at_idx" ON "run_logs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "run_outputs_run_idx" ON "run_outputs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_outputs_run_template_type_idx" ON "run_outputs" USING btree ("run_id","template_key","file_type");--> statement-breakpoint
CREATE INDEX "runs_workflow_version_idx" ON "runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "runs_status_idx" ON "runs" USING btree ("status");--> statement-breakpoint
CREATE INDEX "runs_created_by_idx" ON "runs" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "runs_created_at_idx" ON "runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "script_execution_log_run_idx" ON "script_execution_log" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_events_request_idx" ON "signature_events" USING btree ("signature_request_id");--> statement-breakpoint
CREATE INDEX "signature_requests_run_idx" ON "signature_requests" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_requests_token_idx" ON "signature_requests" USING btree ("token");--> statement-breakpoint
CREATE INDEX "sli_configs_project_idx" ON "sli_configs" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "sli_windows_project_window_idx" ON "sli_windows" USING btree ("project_id","window_start","window_end");--> statement-breakpoint
CREATE INDEX "step_values_run_idx" ON "step_values" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "step_values_step_idx" ON "step_values" USING btree ("step_id");--> statement-breakpoint
CREATE INDEX "step_values_run_step_idx" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE UNIQUE INDEX "step_values_run_step_unique" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE INDEX "template_metrics_template_idx" ON "template_generation_metrics" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_metrics_run_idx" ON "template_generation_metrics" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_run_idx" ON "transform_block_runs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_block_idx" ON "transform_block_runs" USING btree ("block_id");--> statement-breakpoint
CREATE UNIQUE INDEX "was_workflow_version_date_idx" ON "workflow_analytics_snapshots" USING btree ("workflow_id","version_id","date");--> statement-breakpoint
CREATE INDEX "wre_run_idx" ON "workflow_run_events" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "wre_workflow_ts_idx" ON "workflow_run_events" USING btree ("workflow_id","timestamp");--> statement-breakpoint
CREATE INDEX "wrm_workflow_created_idx" ON "workflow_run_metrics" USING btree ("workflow_id","created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_workflow_idx" ON "workflow_runs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_version_idx" ON "workflow_runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_completed_idx" ON "workflow_runs" USING btree ("completed");--> statement-breakpoint
CREATE INDEX "workflow_runs_run_token_idx" ON "workflow_runs" USING btree ("run_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_share_token_idx" ON "workflow_runs" USING btree ("share_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_current_section_idx" ON "workflow_runs" USING btree ("current_section_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_created_at_idx" ON "workflow_runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_owner_idx" ON "workflow_runs" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "analytics_survey_event_idx" ON "analytics_events" USING btree ("survey_id","event");--> statement-breakpoint
CREATE INDEX "analytics_response_event_idx" ON "analytics_events" USING btree ("response_id","event");--> statement-breakpoint
CREATE INDEX "analytics_timestamp_idx" ON "analytics_events" USING btree ("timestamp");--> statement-breakpoint
CREATE INDEX "anonymous_tracking_survey_ip_idx" ON "anonymous_response_tracking" USING btree ("survey_id","ip_address");--> statement-breakpoint
CREATE INDEX "email_queue_status_idx" ON "email_queue" USING btree ("status");--> statement-breakpoint
CREATE INDEX "email_queue_next_attempt_idx" ON "email_queue" USING btree ("next_attempt_at");--> statement-breakpoint
CREATE INDEX "survey_templates_creator_idx" ON "survey_templates" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "survey_templates_system_idx" ON "survey_templates" USING btree ("is_system");--> statement-breakpoint
CREATE INDEX "surveys_public_link_unique_idx" ON "surveys" USING btree ("public_link");--> statement-breakpoint
CREATE INDEX "surveys_workspace_idx" ON "surveys" USING btree ("workspace_id");--> statement-breakpoint
CREATE INDEX "template_shares_template_idx" ON "template_shares" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_shares_user_idx" ON "template_shares" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "template_shares_pending_email_idx" ON "template_shares" USING btree ("pending_email");--> statement-breakpoint
CREATE INDEX "collection_fields_collection_idx" ON "collection_fields" USING btree ("collection_id");--> statement-breakpoint
CREATE UNIQUE INDEX "collection_fields_slug_unique" ON "collection_fields" USING btree ("collection_id","slug");--> statement-breakpoint
CREATE UNIQUE INDEX "collections_slug_unique" ON "collections" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_database_id" ON "datavault_api_tokens" USING btree ("database_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE INDEX "datavault_columns_table_idx" ON "datavault_columns" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_columns_reference_table_idx" ON "datavault_columns" USING btree ("reference_table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_columns_table_slug_unique" ON "datavault_columns" USING btree ("table_id","slug");--> statement-breakpoint
CREATE INDEX "idx_databases_tenant" ON "datavault_databases" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_databases_scope" ON "datavault_databases" USING btree ("scope_type","scope_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_databases_owner" ON "datavault_databases" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_tenant" ON "datavault_number_sequences" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_table" ON "datavault_number_sequences" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "idx_datavault_sequences_column_unique" ON "datavault_number_sequences" USING btree ("tenant_id","table_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_row_id" ON "datavault_row_notes" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_tenant_id" ON "datavault_row_notes" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_table_idx" ON "datavault_rows" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_created_by_idx" ON "datavault_rows" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "idx_table_permissions_table" ON "datavault_table_permissions" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_table_user_permission" ON "datavault_table_permissions" USING btree ("table_id","user_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_tenant_idx" ON "datavault_tables" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_owner_idx" ON "datavault_tables" USING btree ("owner_user_id");--> statement-breakpoint
CREATE INDEX "idx_tables_database" ON "datavault_tables" USING btree ("database_id","tenant_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_tables_tenant_slug_unique" ON "datavault_tables" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "datavault_values_row_idx" ON "datavault_values" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "datavault_values_column_idx" ON "datavault_values" USING btree ("column_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_values_row_column_unique" ON "datavault_values" USING btree ("row_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_writeback_mappings_workflow" ON "datavault_writeback_mappings" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "records_collection_idx" ON "records" USING btree ("collection_id");--> statement-breakpoint
CREATE INDEX "records_tenant_idx" ON "records" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_data_sources_workflow" ON "workflow_data_sources" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_queries_workflow" ON "workflow_queries" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "api_keys_project_idx" ON "api_keys" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_tenant_idx" ON "connections" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "connections_project_idx" ON "connections" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_project_name_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "connections_type_idx" ON "connections" USING btree ("type");--> statement-breakpoint
CREATE INDEX "connections_enabled_idx" ON "connections" USING btree ("enabled");--> statement-breakpoint
CREATE UNIQUE INDEX "connections_project_name_unique_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "ext_dest_tenant_idx" ON "external_destinations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_client_id_idx" ON "oauth_apps" USING btree ("client_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_workspace_idx" ON "oauth_apps" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "secrets_project_key_env_unique" ON "secrets" USING btree ("project_id","key","environment");--> statement-breakpoint
CREATE INDEX "webhook_events_sub_idx" ON "webhook_events" USING btree ("subscription_id");--> statement-breakpoint
CREATE INDEX "webhook_subs_workspace_idx" ON "webhook_subscriptions" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_org_idx" ON "customer_billing_info" USING btree ("organization_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_stripe_idx" ON "customer_billing_info" USING btree ("stripe_customer_id");--> statement-breakpoint
CREATE UNIQUE INDEX "seat_sub_user_idx" ON "subscription_seats" USING btree ("subscription_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "sub_org_idx" ON "subscriptions" USING btree ("organization_id");--> statement-breakpoint
CREATE INDEX "usage_org_metric_date_idx" ON "usage_records" USING btree ("organization_id","metric","recorded_at");--> statement-breakpoint
CREATE INDEX "email_templates_key_idx" ON "email_template_metadata" USING btree ("template_key");--> statement-breakpoint
CREATE INDEX "ai_settings_scope_idx" ON "ai_settings" USING btree ("scope");
params: 
ΓÜá∩╕Å Migrations failed (non-fatal if DB exists): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public;

CREATE TYPE "test_schema_w0_v3"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint
CREATE TYPE "test_schema_w0_v3"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint
CREATE TABLE "account_locks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"locked_at" timestamp DEFAULT now() NOT NULL,
	"locked_until" timestamp NOT NULL,
	"reason" varchar(255),
	"unlocked" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "audit_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"workspace_id" uuid,
	"user_id" varchar,
	"action" varchar NOT NULL,
	"entity_type" varchar NOT NULL,
	"entity_id" varchar NOT NULL,
	"resource_type" varchar,
	"resource_id" varchar,
	"changes" jsonb,
	"details" jsonb,
	"ip_address" varchar,
	"user_agent" text,
	"created_at" timestamp DEFAULT now(),
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_verification_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "login_attempts" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"ip_address" varchar(45),
	"successful" boolean DEFAULT false NOT NULL,
	"attempted_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_backup_codes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"code_hash" text NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "mfa_secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"secret" text NOT NULL,
	"enabled" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"enabled_at" timestamp,
	CONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "organization_invites" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"invited_email" varchar(255) NOT NULL,
	"invited_user_id" varchar,
	"invited_by_user_id" varchar NOT NULL,
	"token" varchar(255) NOT NULL,
	"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp NOT NULL,
	"accepted_at" timestamp,
	"email_sent_at" timestamp,
	"email_failed" boolean DEFAULT false,
	"email_error" text,
	CONSTRAINT "organization_invites_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "organization_memberships" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"org_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "organization_role" DEFAULT 'member' NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "organizations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"slug" varchar,
	"domain" varchar,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"tenant_id" uuid NOT NULL,
	"created_by_user_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "organizations_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "password_reset_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "portal_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "portal_tokens_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "refresh_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"revoked" boolean DEFAULT false NOT NULL,
	"metadata" jsonb,
	"device_name" varchar(255),
	"ip_address" varchar(45),
	"location" varchar(255),
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sessions" (
	"sid" varchar PRIMARY KEY NOT NULL,
	"sess" jsonb NOT NULL,
	"expire" timestamp NOT NULL
);
--> statement-breakpoint
CREATE TABLE "team_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"team_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" varchar(50) DEFAULT 'member' NOT NULL,
	"joined_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "teams" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "tenant_domains" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"domain" text NOT NULL,
	"verified" boolean DEFAULT false,
	"verification_token" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "tenant_domains_domain_unique" UNIQUE("domain")
);
--> statement-breakpoint
CREATE TABLE "tenants" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar(255) NOT NULL,
	"billing_email" varchar(255),
	"plan" "tenant_plan" DEFAULT 'free' NOT NULL,
	"mfa_required" boolean DEFAULT false NOT NULL,
	"branding" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "trusted_devices" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"device_fingerprint" varchar(255) NOT NULL,
	"device_name" varchar(255),
	"trusted_until" timestamp NOT NULL,
	"ip_address" varchar(45),
	"location" varchar(255),
	"user_agent" text,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"last_used_at" timestamp,
	"revoked" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "user_credentials" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"user_id" varchar NOT NULL,
	"password_hash" text NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "user_credentials_user_id_unique" UNIQUE("user_id")
);
--> statement-breakpoint
CREATE TABLE "user_personalization_settings" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"reading_level" varchar DEFAULT 'standard' NOT NULL,
	"tone" varchar DEFAULT 'neutral' NOT NULL,
	"verbosity" varchar DEFAULT 'standard' NOT NULL,
	"language" varchar DEFAULT 'en' NOT NULL,
	"allow_adaptive_prompts" boolean DEFAULT true NOT NULL,
	"allow_ai_clarification" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "user_preferences" (
	"user_id" varchar PRIMARY KEY NOT NULL,
	"settings" jsonb DEFAULT '{"celebrationEffects":true,"darkMode":"system","aiHints":true}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "users" (
	"id" varchar PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"email" varchar(255) NOT NULL,
	"full_name" varchar(255),
	"first_name" varchar(255),
	"last_name" varchar(255),
	"profile_image_url" varchar(500),
	"tenant_id" uuid,
	"role" "user_role" DEFAULT 'creator' NOT NULL,
	"tenant_role" "user_tenant_role",
	"auth_provider" "auth_provider" DEFAULT 'local' NOT NULL,
	"default_mode" text DEFAULT 'easy' NOT NULL,
	"email_verified" boolean DEFAULT false NOT NULL,
	"mfa_enabled" boolean DEFAULT false NOT NULL,
	"last_password_change" timestamp,
	"is_placeholder" boolean DEFAULT false NOT NULL,
	"placeholder_email" varchar(255),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_invitations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"email" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"token" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"invited_by" varchar NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workspace_members" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "workspace_role" DEFAULT 'viewer' NOT NULL,
	"joined_at" timestamp DEFAULT now(),
	"invited_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workspaces" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"slug" varchar NOT NULL,
	"settings" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"type" "block_type" NOT NULL,
	"phase" "block_phase" NOT NULL,
	"config" jsonb NOT NULL,
	"virtual_step_id" uuid,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_docs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid,
	"tenant_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collab_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"clock" integer NOT NULL,
	"state" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "collab_updates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"doc_id" uuid NOT NULL,
	"seq" integer NOT NULL,
	"update" text NOT NULL,
	"ts" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "document_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"final_block_document_id" varchar(255),
	"name" varchar(255) NOT NULL,
	"phase" "document_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 3000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "lifecycle_hooks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar(255) NOT NULL,
	"phase" "lifecycle_hook_phase" NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"virtual_step_ids" uuid[] DEFAULT '{}'::uuid[],
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"mutation_mode" boolean DEFAULT false,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "logic_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"condition_step_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_type" "logic_rule_target_type" NOT NULL,
	"target_step_id" uuid,
	"target_section_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "project_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "projects" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"name" varchar(255),
	"description" text,
	"creator_id" varchar NOT NULL,
	"tenant_id" uuid,
	"created_by" varchar,
	"owner_id" varchar NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"status" "project_status" DEFAULT 'active' NOT NULL,
	"archived" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"order" integer NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"visible_if" jsonb,
	"skip_if" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "steps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"section_id" uuid NOT NULL,
	"type" "step_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"alias" text,
	"default_value" jsonb,
	"order" integer NOT NULL,
	"is_virtual" boolean DEFAULT false NOT NULL,
	"visible_if" jsonb,
	"repeater_config" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"version_number" integer NOT NULL,
	"file_ref" varchar(500) NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"notes" text,
	"is_active" boolean DEFAULT true
);
--> statement-breakpoint
CREATE TABLE "templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"file_ref" varchar(500) NOT NULL,
	"type" "template_type" NOT NULL,
	"helpers_version" integer DEFAULT 1 NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"mapping" jsonb DEFAULT '{}'::jsonb,
	"current_version" integer DEFAULT 1,
	"last_modified_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_blocks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"section_id" uuid,
	"name" varchar NOT NULL,
	"language" "transform_block_language" NOT NULL,
	"code" text NOT NULL,
	"input_keys" text[] DEFAULT '{}'::text[] NOT NULL,
	"output_key" varchar NOT NULL,
	"virtual_step_id" uuid,
	"phase" "block_phase" DEFAULT 'onSectionSubmit' NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"order" integer DEFAULT 0 NOT NULL,
	"timeout_ms" integer DEFAULT 1000,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_access" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"principal_type" varchar(20) NOT NULL,
	"principal_id" varchar NOT NULL,
	"role" varchar(20) NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_blueprints" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid,
	"creator_id" varchar NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"graph_json" jsonb NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"source_workflow_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"name" text NOT NULL,
	"values" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"workflow_version_id" uuid,
	"version_hash" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_id" uuid NOT NULL,
	"key" text NOT NULL,
	"is_primary" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_versions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"base_id" uuid,
	"version_number" integer DEFAULT 1 NOT NULL,
	"is_draft" boolean DEFAULT false NOT NULL,
	"graph_json" jsonb NOT NULL,
	"migration_info" jsonb,
	"changelog" jsonb,
	"notes" text,
	"checksum" text,
	"created_by" varchar NOT NULL,
	"published" boolean DEFAULT false NOT NULL,
	"published_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar(255) NOT NULL,
	"description" text,
	"creator_id" varchar,
	"owner_id" varchar,
	"mode_override" text,
	"public_link" text,
	"name" varchar(255),
	"project_id" uuid,
	"current_version_id" uuid,
	"is_public" boolean DEFAULT false NOT NULL,
	"slug" text,
	"require_login" boolean DEFAULT false NOT NULL,
	"intake_config" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"pinned_version_id" uuid,
	"status" "workflow_status" DEFAULT 'draft' NOT NULL,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"source_blueprint_id" uuid,
	CONSTRAINT "workflows_slug_unique" UNIQUE("slug")
);
--> statement-breakpoint
CREATE TABLE "ai_workflow_feedback" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid,
	"user_id" varchar,
	"operation_type" varchar NOT NULL,
	"rating" integer NOT NULL,
	"comment" text,
	"ai_provider" varchar,
	"ai_model" varchar,
	"prompt_version" varchar,
	"quality_score" integer,
	"quality_passed" boolean,
	"issues_count" integer,
	"request_description" text,
	"generated_sections" integer,
	"generated_steps" integer,
	"was_edited" boolean DEFAULT false,
	"edit_count" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "block_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"block_id" varchar NOT NULL,
	"total_visits" integer DEFAULT 0,
	"avg_time_ms" integer DEFAULT 0,
	"dropoff_count" integer DEFAULT 0,
	"validation_error_count" integer DEFAULT 0,
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"run_id" uuid,
	"type" "metrics_event_type" NOT NULL,
	"ts" timestamp with time zone DEFAULT now() NOT NULL,
	"duration_ms" integer,
	"payload" jsonb DEFAULT '{}'::jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "metrics_rollups" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"bucket_start" timestamp with time zone NOT NULL,
	"bucket" "rollup_bucket" NOT NULL,
	"runs_count" integer DEFAULT 0 NOT NULL,
	"runs_success" integer DEFAULT 0 NOT NULL,
	"runs_error" integer DEFAULT 0 NOT NULL,
	"dur_p50" integer,
	"dur_p95" integer,
	"pdf_success" integer DEFAULT 0 NOT NULL,
	"pdf_error" integer DEFAULT 0 NOT NULL,
	"docx_success" integer DEFAULT 0 NOT NULL,
	"docx_error" integer DEFAULT 0 NOT NULL,
	"queue_enqueued" integer DEFAULT 0 NOT NULL,
	"queue_dequeued" integer DEFAULT 0 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "review_tasks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"status" "review_task_status" DEFAULT 'pending' NOT NULL,
	"reviewer_id" varchar,
	"reviewer_email" varchar(255),
	"message" text,
	"comment" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"resolved_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "run_generated_documents" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"file_name" text NOT NULL,
	"file_url" text NOT NULL,
	"mime_type" text,
	"file_size" integer,
	"template_id" uuid,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_logs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"node_id" varchar(100),
	"level" "log_level" NOT NULL,
	"message" text NOT NULL,
	"context" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "run_outputs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"template_key" text NOT NULL,
	"file_type" "output_file_type" NOT NULL,
	"storage_path" text NOT NULL,
	"status" "output_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_version_id" uuid NOT NULL,
	"input_json" jsonb,
	"output_refs" jsonb,
	"trace" jsonb,
	"status" "run_status" DEFAULT 'pending' NOT NULL,
	"error" text,
	"duration_ms" integer,
	"run_token" varchar,
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"created_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "script_execution_log" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"script_type" varchar(50) NOT NULL,
	"script_id" uuid NOT NULL,
	"script_name" varchar(255),
	"phase" varchar(50),
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "script_execution_status" NOT NULL,
	"error_message" text,
	"console_output" jsonb,
	"input_sample" jsonb,
	"output_sample" jsonb,
	"duration_ms" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "signature_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"signature_request_id" uuid NOT NULL,
	"type" "signature_event_type" NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb
);
--> statement-breakpoint
CREATE TABLE "signature_requests" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"node_id" text NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"signer_email" varchar(255) NOT NULL,
	"signer_name" varchar(255),
	"status" "signature_request_status" DEFAULT 'pending' NOT NULL,
	"provider" "signature_provider" DEFAULT 'native' NOT NULL,
	"provider_request_id" text,
	"token" text NOT NULL,
	"document_url" text,
	"redirect_url" text,
	"message" text,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"signed_at" timestamp,
	CONSTRAINT "signature_requests_token_unique" UNIQUE("token")
);
--> statement-breakpoint
CREATE TABLE "sli_configs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"target_success_pct" integer DEFAULT 99 NOT NULL,
	"target_p95_ms" integer DEFAULT 5000 NOT NULL,
	"error_budget_pct" integer DEFAULT 1 NOT NULL,
	"window" "sli_window" DEFAULT '7d' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "sli_windows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"workflow_id" uuid,
	"window_start" timestamp with time zone NOT NULL,
	"window_end" timestamp with time zone NOT NULL,
	"success_pct" integer,
	"p95_ms" integer,
	"error_budget_burn_pct" integer,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "step_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"step_id" uuid NOT NULL,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "template_generation_metrics" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"run_id" uuid,
	"result" varchar(50) NOT NULL,
	"duration_ms" integer,
	"error_message" text,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "transform_block_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"block_id" uuid NOT NULL,
	"started_at" timestamp DEFAULT now() NOT NULL,
	"finished_at" timestamp,
	"status" "transform_block_run_status" NOT NULL,
	"error_message" text,
	"output_sample" jsonb
);
--> statement-breakpoint
CREATE TABLE "workflow_analytics_snapshots" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"date" timestamp NOT NULL,
	"summary" jsonb NOT NULL,
	"dropoff" jsonb NOT NULL,
	"branching" jsonb NOT NULL,
	"heatmap" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "workflow_run_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"run_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"workflow_id" uuid NOT NULL,
	"block_id" varchar,
	"page_id" uuid,
	"type" varchar NOT NULL,
	"timestamp" timestamp DEFAULT now() NOT NULL,
	"payload" jsonb,
	"is_preview" boolean DEFAULT false NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_run_metrics" (
	"run_id" uuid PRIMARY KEY NOT NULL,
	"workflow_id" uuid NOT NULL,
	"version_id" uuid NOT NULL,
	"total_time_ms" integer,
	"pages_visited" integer DEFAULT 0,
	"blocks_visited" integer DEFAULT 0,
	"validation_errors" integer DEFAULT 0,
	"script_errors" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"is_preview" boolean DEFAULT false NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL
);
--> statement-breakpoint
CREATE TABLE "workflow_runs" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"workflow_version_id" uuid,
	"run_token" text NOT NULL,
	"created_by" text,
	"current_section_id" uuid,
	"progress" integer DEFAULT 0,
	"completed" boolean DEFAULT false,
	"completed_at" timestamp,
	"metadata" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"client_email" varchar,
	"portal_access_key" varchar,
	"access_mode" "portal_access_mode" DEFAULT 'anonymous',
	"share_token" varchar,
	"share_token_expires_at" timestamp,
	"owner_type" varchar(50),
	"owner_uuid" uuid,
	CONSTRAINT "workflow_runs_run_token_unique" UNIQUE("run_token"),
	CONSTRAINT "workflow_runs_share_token_unique" UNIQUE("share_token")
);
--> statement-breakpoint
CREATE TABLE "analytics_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"survey_id" uuid NOT NULL,
	"page_id" uuid,
	"question_id" uuid,
	"event" varchar NOT NULL,
	"data" jsonb,
	"duration" integer,
	"timestamp" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "anonymous_response_tracking" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"ip_address" varchar NOT NULL,
	"session_id" varchar,
	"response_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "answers" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"response_id" uuid NOT NULL,
	"question_id" uuid NOT NULL,
	"subquestion_id" uuid,
	"loop_index" integer,
	"value" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "conditional_rules" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"condition_question_id" uuid NOT NULL,
	"operator" "condition_operator" NOT NULL,
	"condition_value" jsonb NOT NULL,
	"target_question_id" uuid,
	"target_page_id" uuid,
	"action" "conditional_action" NOT NULL,
	"logical_operator" varchar DEFAULT 'AND',
	"order" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_queue" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"to" varchar NOT NULL,
	"subject" varchar NOT NULL,
	"html" text NOT NULL,
	"status" "email_queue_status" DEFAULT 'pending' NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_error" text,
	"next_attempt_at" timestamp DEFAULT now(),
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "files" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"answer_id" uuid NOT NULL,
	"filename" varchar NOT NULL,
	"original_name" varchar NOT NULL,
	"mime_type" varchar NOT NULL,
	"size" integer NOT NULL,
	"uploaded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "loop_group_subquestions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"loop_question_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "questions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"page_id" uuid NOT NULL,
	"type" "question_type" NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"required" boolean DEFAULT false,
	"options" jsonb,
	"loop_config" jsonb,
	"conditional_logic" jsonb,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "responses" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"completed" boolean DEFAULT false,
	"submitted_at" timestamp,
	"is_anonymous" boolean DEFAULT false,
	"ip_address" varchar,
	"user_agent" text,
	"session_id" varchar,
	"anonymous_metadata" jsonb,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_pages" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"survey_id" uuid NOT NULL,
	"title" varchar NOT NULL,
	"order" integer NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "survey_templates" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" text NOT NULL,
	"description" text,
	"content" jsonb NOT NULL,
	"creator_id" varchar,
	"is_system" boolean DEFAULT false NOT NULL,
	"tags" text[] DEFAULT ARRAY[]::text[],
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "surveys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" varchar NOT NULL,
	"description" text,
	"creator_id" varchar NOT NULL,
	"workspace_id" uuid,
	"status" "survey_status" DEFAULT 'draft' NOT NULL,
	"allow_anonymous" boolean DEFAULT false,
	"anonymous_access_type" "anonymous_access_type" DEFAULT 'unlimited',
	"public_link" varchar,
	"anonymous_config" jsonb,
	"is_public" boolean DEFAULT false,
	"public_access_mode" "public_access_mode" DEFAULT 'link_only',
	"public_slug" varchar,
	"allowed_domains" jsonb,
	"public_settings" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "surveys_public_link_unique" UNIQUE("public_link"),
	CONSTRAINT "surveys_public_slug_unique" UNIQUE("public_slug")
);
--> statement-breakpoint
CREATE TABLE "template_shares" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_id" uuid NOT NULL,
	"user_id" varchar,
	"pending_email" text,
	"access" "template_access" DEFAULT 'use' NOT NULL,
	"invited_at" timestamp with time zone DEFAULT now(),
	"accepted_at" timestamp with time zone
);
--> statement-breakpoint
CREATE TABLE "collection_fields" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"collection_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"type" varchar(50) NOT NULL,
	"options" jsonb,
	"required" boolean DEFAULT false,
	"order" integer DEFAULT 0,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "collections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"slug" varchar(255) NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_api_tokens" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"database_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"label" text NOT NULL,
	"token_hash" text NOT NULL,
	"scopes" text[] DEFAULT ARRAY[]::text[] NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"expires_at" timestamp
);
--> statement-breakpoint
CREATE TABLE "datavault_columns" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"type" "datavault_column_type" NOT NULL,
	"description" text,
	"width_px" integer DEFAULT 150,
	"required" boolean DEFAULT false NOT NULL,
	"is_primary_key" boolean DEFAULT false NOT NULL,
	"is_unique" boolean DEFAULT false NOT NULL,
	"order_index" integer DEFAULT 0 NOT NULL,
	"auto_number_start" integer DEFAULT 1,
	"autonumber_prefix" text,
	"autonumber_padding" integer DEFAULT 4,
	"autonumber_reset_policy" "autonumber_reset_policy" DEFAULT 'never',
	"reference_table_id" uuid,
	"reference_display_column_slug" text,
	"options" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_databases" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"type" "data_source_type" DEFAULT 'native' NOT NULL,
	"config" jsonb DEFAULT '{}'::jsonb,
	"scope_type" "datavault_scope_type" DEFAULT 'account' NOT NULL,
	"scope_id" uuid,
	"owner_type" "owner_type",
	"owner_uuid" uuid,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_number_sequences" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"prefix" text,
	"padding" integer DEFAULT 4 NOT NULL,
	"next_value" integer DEFAULT 1 NOT NULL,
	"reset_policy" "autonumber_reset_policy" DEFAULT 'never' NOT NULL,
	"last_reset" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_row_notes" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"tenant_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"text" text NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_rows" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"deleted_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "datavault_table_permissions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"table_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"role" "datavault_table_role" NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_tables" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"owner_user_id" varchar,
	"database_id" uuid,
	"name" text NOT NULL,
	"slug" text NOT NULL,
	"description" text,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_values" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"row_id" uuid NOT NULL,
	"column_id" uuid NOT NULL,
	"value" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "datavault_writeback_mappings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"column_mappings" jsonb NOT NULL,
	"trigger_phase" varchar(50) DEFAULT 'afterComplete' NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar
);
--> statement-breakpoint
CREATE TABLE "records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"collection_id" uuid NOT NULL,
	"data" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	"created_by" varchar,
	"updated_by" varchar
);
--> statement-breakpoint
CREATE TABLE "workflow_data_sources" (
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "workflow_data_sources_workflow_id_data_source_id_pk" PRIMARY KEY("workflow_id","data_source_id")
);
--> statement-breakpoint
CREATE TABLE "workflow_queries" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workflow_id" uuid NOT NULL,
	"data_source_id" uuid NOT NULL,
	"table_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"filters" jsonb DEFAULT '[]'::jsonb,
	"sort" jsonb DEFAULT '[]'::jsonb,
	"limit" integer,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "api_keys" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"prefix" varchar(50) NOT NULL,
	"key_hash" varchar(255) NOT NULL,
	"scopes" text[] NOT NULL,
	"name" varchar NOT NULL,
	"expires_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "api_keys_key_hash_unique" UNIQUE("key_hash")
);
--> statement-breakpoint
CREATE TABLE "connections" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"project_id" uuid NOT NULL,
	"name" varchar(255) NOT NULL,
	"type" "connection_type" NOT NULL,
	"base_url" varchar(500),
	"auth_config" jsonb DEFAULT '{}'::jsonb,
	"secret_refs" jsonb DEFAULT '{}'::jsonb,
	"oauth_state" jsonb,
	"default_headers" jsonb DEFAULT '{}'::jsonb,
	"timeout_ms" integer DEFAULT 8000,
	"retries" integer DEFAULT 2,
	"backoff_ms" integer DEFAULT 250,
	"enabled" boolean DEFAULT true NOT NULL,
	"last_tested_at" timestamp,
	"last_used_at" timestamp,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "external_destinations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"tenant_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"config" jsonb NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "oauth_access_tokens" (
	"access_token" varchar PRIMARY KEY NOT NULL,
	"refresh_token" varchar,
	"client_id" varchar NOT NULL,
	"user_id" varchar,
	"workspace_id" uuid NOT NULL,
	"scope" jsonb,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_access_tokens_refresh_token_unique" UNIQUE("refresh_token")
);
--> statement-breakpoint
CREATE TABLE "oauth_apps" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"name" varchar NOT NULL,
	"client_id" varchar NOT NULL,
	"client_secret_hash" varchar NOT NULL,
	"redirect_uris" jsonb NOT NULL,
	"scopes" jsonb NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "oauth_apps_client_id_unique" UNIQUE("client_id")
);
--> statement-breakpoint
CREATE TABLE "oauth_auth_codes" (
	"code" varchar PRIMARY KEY NOT NULL,
	"client_id" varchar NOT NULL,
	"user_id" varchar NOT NULL,
	"scope" jsonb,
	"redirect_uri" varchar NOT NULL,
	"expires_at" timestamp NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "secrets" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"project_id" uuid NOT NULL,
	"key" varchar NOT NULL,
	"value" text,
	"value_enc" text NOT NULL,
	"type" "secret_type" DEFAULT 'api_key' NOT NULL,
	"metadata" jsonb DEFAULT '{}'::jsonb,
	"environment" varchar DEFAULT 'production',
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_events" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"event" varchar NOT NULL,
	"payload" jsonb NOT NULL,
	"status" varchar NOT NULL,
	"attempts" integer DEFAULT 0 NOT NULL,
	"last_attempt_at" timestamp,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "webhook_subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"workspace_id" uuid NOT NULL,
	"target_url" varchar NOT NULL,
	"events" jsonb NOT NULL,
	"secret" varchar NOT NULL,
	"enabled" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "billing_plans" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"name" varchar NOT NULL,
	"type" varchar NOT NULL,
	"price_monthly" integer DEFAULT 0 NOT NULL,
	"price_yearly" integer DEFAULT 0 NOT NULL,
	"features" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"limits" jsonb DEFAULT '{}'::jsonb NOT NULL,
	"stripe_product_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "customer_billing_info" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"stripe_customer_id" varchar NOT NULL,
	"billing_email" varchar,
	"default_payment_method_id" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscription_seats" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"subscription_id" uuid NOT NULL,
	"user_id" varchar NOT NULL,
	"assigned_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "subscriptions" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"plan_id" uuid NOT NULL,
	"status" "subscription_status" DEFAULT 'active' NOT NULL,
	"stripe_subscription_id" varchar,
	"current_period_start" timestamp,
	"current_period_end" timestamp,
	"cancel_at_period_end" boolean DEFAULT false,
	"canceled_at" timestamp,
	"trial_start" timestamp,
	"trial_end" timestamp,
	"seat_quantity" integer DEFAULT 1 NOT NULL,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "usage_records" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"organization_id" uuid NOT NULL,
	"metric" varchar NOT NULL,
	"quantity" integer DEFAULT 1 NOT NULL,
	"workflow_id" uuid,
	"metadata" jsonb,
	"recorded_at" timestamp DEFAULT now()
);
--> statement-breakpoint
CREATE TABLE "email_template_metadata" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"template_key" varchar(255) NOT NULL,
	"name" varchar(255) NOT NULL,
	"description" text,
	"subject_preview" text,
	"branding_tokens" jsonb,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "email_template_metadata_template_key_unique" UNIQUE("template_key")
);
--> statement-breakpoint
CREATE TABLE "ai_settings" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"scope" varchar DEFAULT 'global' NOT NULL,
	"system_prompt" text,
	"updated_by" varchar,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now()
);
--> statement-breakpoint
ALTER TABLE "account_locks" ADD CONSTRAINT "account_locks_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "audit_logs" ADD CONSTRAINT "audit_logs_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "email_verification_tokens" ADD CONSTRAINT "email_verification_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_backup_codes" ADD CONSTRAINT "mfa_backup_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "mfa_secrets" ADD CONSTRAINT "mfa_secrets_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_user_id_users_id_fk" FOREIGN KEY ("invited_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_invites" ADD CONSTRAINT "organization_invites_invited_by_user_id_users_id_fk" FOREIGN KEY ("invited_by_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_org_id_organizations_id_fk" FOREIGN KEY ("org_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organization_memberships" ADD CONSTRAINT "organization_memberships_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "organizations" ADD CONSTRAINT "organizations_created_by_user_id_users_id_fk" FOREIGN KEY ("created_by_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "password_reset_tokens" ADD CONSTRAINT "password_reset_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "refresh_tokens" ADD CONSTRAINT "refresh_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_team_id_teams_id_fk" FOREIGN KEY ("team_id") REFERENCES "test_schema_w0_v3"."teams"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "team_members" ADD CONSTRAINT "team_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "teams" ADD CONSTRAINT "teams_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "tenant_domains" ADD CONSTRAINT "tenant_domains_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "trusted_devices" ADD CONSTRAINT "trusted_devices_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_credentials" ADD CONSTRAINT "user_credentials_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_personalization_settings" ADD CONSTRAINT "user_personalization_settings_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "user_preferences" ADD CONSTRAINT "user_preferences_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "users" ADD CONSTRAINT "users_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_invitations" ADD CONSTRAINT "workspace_invitations_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspace_members" ADD CONSTRAINT "workspace_members_invited_by_users_id_fk" FOREIGN KEY ("invited_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workspaces" ADD CONSTRAINT "workspaces_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "blocks" ADD CONSTRAINT "blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_docs" ADD CONSTRAINT "collab_docs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_snapshots" ADD CONSTRAINT "collab_snapshots_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "test_schema_w0_v3"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collab_updates" ADD CONSTRAINT "collab_updates_doc_id_collab_docs_id_fk" FOREIGN KEY ("doc_id") REFERENCES "test_schema_w0_v3"."collab_docs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "document_hooks" ADD CONSTRAINT "document_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "lifecycle_hooks" ADD CONSTRAINT "lifecycle_hooks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_condition_step_id_steps_id_fk" FOREIGN KEY ("condition_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_step_id_steps_id_fk" FOREIGN KEY ("target_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "logic_rules" ADD CONSTRAINT "logic_rules_target_section_id_sections_id_fk" FOREIGN KEY ("target_section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "project_access" ADD CONSTRAINT "project_access_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "projects" ADD CONSTRAINT "projects_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sections" ADD CONSTRAINT "sections_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "steps" ADD CONSTRAINT "steps_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_versions" ADD CONSTRAINT "template_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "templates" ADD CONSTRAINT "templates_last_modified_by_users_id_fk" FOREIGN KEY ("last_modified_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_section_id_sections_id_fk" FOREIGN KEY ("section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_blocks" ADD CONSTRAINT "transform_blocks_virtual_step_id_steps_id_fk" FOREIGN KEY ("virtual_step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_access" ADD CONSTRAINT "workflow_access_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_blueprints" ADD CONSTRAINT "workflow_blueprints_source_workflow_id_workflows_id_fk" FOREIGN KEY ("source_workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_snapshots" ADD CONSTRAINT "workflow_snapshots_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_templates" ADD CONSTRAINT "workflow_templates_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_base_id_workflows_id_fk" FOREIGN KEY ("base_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_versions" ADD CONSTRAINT "workflow_versions_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_owner_id_users_id_fk" FOREIGN KEY ("owner_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflows" ADD CONSTRAINT "workflows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_workflow_feedback" ADD CONSTRAINT "ai_workflow_feedback_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "block_metrics" ADD CONSTRAINT "block_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_events" ADD CONSTRAINT "metrics_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "metrics_rollups" ADD CONSTRAINT "metrics_rollups_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "review_tasks" ADD CONSTRAINT "review_tasks_reviewer_id_users_id_fk" FOREIGN KEY ("reviewer_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_generated_documents" ADD CONSTRAINT "run_generated_documents_template_id_workflow_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."workflow_templates"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_logs" ADD CONSTRAINT "run_logs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "run_outputs" ADD CONSTRAINT "run_outputs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "runs" ADD CONSTRAINT "runs_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "script_execution_log" ADD CONSTRAINT "script_execution_log_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_events" ADD CONSTRAINT "signature_events_signature_request_id_signature_requests_id_fk" FOREIGN KEY ("signature_request_id") REFERENCES "test_schema_w0_v3"."signature_requests"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "signature_requests" ADD CONSTRAINT "signature_requests_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_configs" ADD CONSTRAINT "sli_configs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "sli_windows" ADD CONSTRAINT "sli_windows_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "step_values" ADD CONSTRAINT "step_values_step_id_steps_id_fk" FOREIGN KEY ("step_id") REFERENCES "test_schema_w0_v3"."steps"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_template_id_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_generation_metrics" ADD CONSTRAINT "template_generation_metrics_run_id_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "transform_block_runs" ADD CONSTRAINT "transform_block_runs_block_id_transform_blocks_id_fk" FOREIGN KEY ("block_id") REFERENCES "test_schema_w0_v3"."transform_blocks"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_analytics_snapshots" ADD CONSTRAINT "workflow_analytics_snapshots_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "test_schema_w0_v3"."workflow_runs"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_run_metrics" ADD CONSTRAINT "workflow_run_metrics_version_id_workflow_versions_id_fk" FOREIGN KEY ("version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_workflow_version_id_workflow_versions_id_fk" FOREIGN KEY ("workflow_version_id") REFERENCES "test_schema_w0_v3"."workflow_versions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_runs" ADD CONSTRAINT "workflow_runs_current_section_id_sections_id_fk" FOREIGN KEY ("current_section_id") REFERENCES "test_schema_w0_v3"."sections"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "test_schema_w0_v3"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "test_schema_w0_v3"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "analytics_events" ADD CONSTRAINT "analytics_events_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "anonymous_response_tracking" ADD CONSTRAINT "anonymous_response_tracking_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "test_schema_w0_v3"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_response_id_responses_id_fk" FOREIGN KEY ("response_id") REFERENCES "test_schema_w0_v3"."responses"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_question_id_questions_id_fk" FOREIGN KEY ("question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "answers" ADD CONSTRAINT "answers_subquestion_id_loop_group_subquestions_id_fk" FOREIGN KEY ("subquestion_id") REFERENCES "test_schema_w0_v3"."loop_group_subquestions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_condition_question_id_questions_id_fk" FOREIGN KEY ("condition_question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_question_id_questions_id_fk" FOREIGN KEY ("target_question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "conditional_rules" ADD CONSTRAINT "conditional_rules_target_page_id_survey_pages_id_fk" FOREIGN KEY ("target_page_id") REFERENCES "test_schema_w0_v3"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "files" ADD CONSTRAINT "files_answer_id_answers_id_fk" FOREIGN KEY ("answer_id") REFERENCES "test_schema_w0_v3"."answers"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "loop_group_subquestions" ADD CONSTRAINT "loop_group_subquestions_loop_question_id_questions_id_fk" FOREIGN KEY ("loop_question_id") REFERENCES "test_schema_w0_v3"."questions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "questions" ADD CONSTRAINT "questions_page_id_survey_pages_id_fk" FOREIGN KEY ("page_id") REFERENCES "test_schema_w0_v3"."survey_pages"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "responses" ADD CONSTRAINT "responses_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_pages" ADD CONSTRAINT "survey_pages_survey_id_surveys_id_fk" FOREIGN KEY ("survey_id") REFERENCES "test_schema_w0_v3"."surveys"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "survey_templates" ADD CONSTRAINT "survey_templates_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_creator_id_users_id_fk" FOREIGN KEY ("creator_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "surveys" ADD CONSTRAINT "surveys_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_template_id_survey_templates_id_fk" FOREIGN KEY ("template_id") REFERENCES "test_schema_w0_v3"."survey_templates"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "template_shares" ADD CONSTRAINT "template_shares_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collection_fields" ADD CONSTRAINT "collection_fields_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "test_schema_w0_v3"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "collections" ADD CONSTRAINT "collections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_api_tokens" ADD CONSTRAINT "datavault_api_tokens_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_columns" ADD CONSTRAINT "datavault_columns_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_databases" ADD CONSTRAINT "datavault_databases_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_number_sequences" ADD CONSTRAINT "datavault_number_sequences_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "test_schema_w0_v3"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "test_schema_w0_v3"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_row_notes" ADD CONSTRAINT "datavault_row_notes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_rows" ADD CONSTRAINT "datavault_rows_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_table_permissions" ADD CONSTRAINT "datavault_table_permissions_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_owner_user_id_users_id_fk" FOREIGN KEY ("owner_user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_tables" ADD CONSTRAINT "datavault_tables_database_id_datavault_databases_id_fk" FOREIGN KEY ("database_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_row_id_datavault_rows_id_fk" FOREIGN KEY ("row_id") REFERENCES "test_schema_w0_v3"."datavault_rows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_values" ADD CONSTRAINT "datavault_values_column_id_datavault_columns_id_fk" FOREIGN KEY ("column_id") REFERENCES "test_schema_w0_v3"."datavault_columns"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "datavault_writeback_mappings" ADD CONSTRAINT "datavault_writeback_mappings_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_collection_id_collections_id_fk" FOREIGN KEY ("collection_id") REFERENCES "test_schema_w0_v3"."collections"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_created_by_users_id_fk" FOREIGN KEY ("created_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "records" ADD CONSTRAINT "records_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_data_sources" ADD CONSTRAINT "workflow_data_sources_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_data_source_id_datavault_databases_id_fk" FOREIGN KEY ("data_source_id") REFERENCES "test_schema_w0_v3"."datavault_databases"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "workflow_queries" ADD CONSTRAINT "workflow_queries_table_id_datavault_tables_id_fk" FOREIGN KEY ("table_id") REFERENCES "test_schema_w0_v3"."datavault_tables"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "api_keys" ADD CONSTRAINT "api_keys_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "connections" ADD CONSTRAINT "connections_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "external_destinations" ADD CONSTRAINT "external_destinations_tenant_id_tenants_id_fk" FOREIGN KEY ("tenant_id") REFERENCES "test_schema_w0_v3"."tenants"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "test_schema_w0_v3"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_access_tokens" ADD CONSTRAINT "oauth_access_tokens_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_apps" ADD CONSTRAINT "oauth_apps_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_client_id_oauth_apps_client_id_fk" FOREIGN KEY ("client_id") REFERENCES "test_schema_w0_v3"."oauth_apps"("client_id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "oauth_auth_codes" ADD CONSTRAINT "oauth_auth_codes_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "secrets" ADD CONSTRAINT "secrets_project_id_projects_id_fk" FOREIGN KEY ("project_id") REFERENCES "test_schema_w0_v3"."projects"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_events" ADD CONSTRAINT "webhook_events_subscription_id_webhook_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "test_schema_w0_v3"."webhook_subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "webhook_subscriptions" ADD CONSTRAINT "webhook_subscriptions_workspace_id_workspaces_id_fk" FOREIGN KEY ("workspace_id") REFERENCES "test_schema_w0_v3"."workspaces"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "customer_billing_info" ADD CONSTRAINT "customer_billing_info_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_subscription_id_subscriptions_id_fk" FOREIGN KEY ("subscription_id") REFERENCES "test_schema_w0_v3"."subscriptions"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscription_seats" ADD CONSTRAINT "subscription_seats_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "subscriptions" ADD CONSTRAINT "subscriptions_plan_id_billing_plans_id_fk" FOREIGN KEY ("plan_id") REFERENCES "test_schema_w0_v3"."billing_plans"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_organization_id_organizations_id_fk" FOREIGN KEY ("organization_id") REFERENCES "test_schema_w0_v3"."organizations"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "usage_records" ADD CONSTRAINT "usage_records_workflow_id_workflows_id_fk" FOREIGN KEY ("workflow_id") REFERENCES "test_schema_w0_v3"."workflows"("id") ON DELETE no action ON UPDATE no action;--> statement-breakpoint
ALTER TABLE "ai_settings" ADD CONSTRAINT "ai_settings_updated_by_users_id_fk" FOREIGN KEY ("updated_by") REFERENCES "test_schema_w0_v3"."users"("id") ON DELETE set null ON UPDATE no action;--> statement-breakpoint
CREATE INDEX "account_locks_user_idx" ON "account_locks" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "account_locks_until_idx" ON "account_locks" USING btree ("locked_until");--> statement-breakpoint
CREATE INDEX "audit_logs_tenant_idx" ON "audit_logs" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "audit_logs_user_idx" ON "audit_logs" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "audit_logs_action_idx" ON "audit_logs" USING btree ("action");--> statement-breakpoint
CREATE INDEX "email_verify_token_idx" ON "email_verification_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "email_verify_user_idx" ON "email_verification_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "login_attempts_email_idx" ON "login_attempts" USING btree ("email");--> statement-breakpoint
CREATE INDEX "login_attempts_timestamp_idx" ON "login_attempts" USING btree ("attempted_at");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_user_idx" ON "mfa_backup_codes" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "mfa_backup_codes_hash_idx" ON "mfa_backup_codes" USING btree ("code_hash");--> statement-breakpoint
CREATE INDEX "mfa_secrets_user_idx" ON "mfa_secrets" USING btree ("user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "org_invites_token_unique_idx" ON "organization_invites" USING btree ("token");--> statement-breakpoint
CREATE INDEX "idx_org_invites_org_email_status" ON "organization_invites" USING btree ("org_id","invited_email","status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_status" ON "organization_invites" USING btree ("status");--> statement-breakpoint
CREATE INDEX "idx_org_invites_expires" ON "organization_invites" USING btree ("expires_at");--> statement-breakpoint
CREATE UNIQUE INDEX "org_membership_unique_idx" ON "organization_memberships" USING btree ("org_id","user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_org" ON "organization_memberships" USING btree ("org_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_user" ON "organization_memberships" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "idx_org_memberships_role" ON "organization_memberships" USING btree ("role");--> statement-breakpoint
CREATE INDEX "idx_organizations_created_by" ON "organizations" USING btree ("created_by_user_id");--> statement-breakpoint
CREATE INDEX "idx_organizations_tenant" ON "organizations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "pwd_reset_token_idx" ON "password_reset_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "pwd_reset_user_idx" ON "password_reset_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_user_idx" ON "refresh_tokens" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "refresh_token_token_idx" ON "refresh_tokens" USING btree ("token");--> statement-breakpoint
CREATE INDEX "IDX_session_expire" ON "sessions" USING btree ("expire");--> statement-breakpoint
CREATE UNIQUE INDEX "team_members_idx" ON "team_members" USING btree ("team_id","user_id");--> statement-breakpoint
CREATE INDEX "teams_tenant_idx" ON "teams" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_tenant_idx" ON "tenant_domains" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "tenant_domains_domain_idx" ON "tenant_domains" USING btree ("domain");--> statement-breakpoint
CREATE INDEX "tenants_plan_idx" ON "tenants" USING btree ("plan");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_idx" ON "trusted_devices" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "trusted_devices_fingerprint_idx" ON "trusted_devices" USING btree ("device_fingerprint");--> statement-breakpoint
CREATE INDEX "trusted_devices_user_fingerprint_idx" ON "trusted_devices" USING btree ("user_id","device_fingerprint");--> statement-breakpoint
CREATE INDEX "user_credentials_user_idx" ON "user_credentials" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "users_email_idx" ON "users" USING btree ("email");--> statement-breakpoint
CREATE INDEX "users_tenant_idx" ON "users" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "users_tenant_email_idx" ON "users" USING btree ("tenant_id","email");--> statement-breakpoint
CREATE INDEX "idx_users_is_placeholder" ON "users" USING btree ("is_placeholder");--> statement-breakpoint
CREATE INDEX "idx_users_placeholder_email" ON "users" USING btree ("placeholder_email");--> statement-breakpoint
CREATE INDEX "invitation_token_idx" ON "workspace_invitations" USING btree ("token");--> statement-breakpoint
CREATE INDEX "invitation_ws_email_idx" ON "workspace_invitations" USING btree ("workspace_id","email");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_member_idx" ON "workspace_members" USING btree ("workspace_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workspace_org_slug_idx" ON "workspaces" USING btree ("organization_id","slug");--> statement-breakpoint
CREATE INDEX "blocks_workflow_phase_order_idx" ON "blocks" USING btree ("workflow_id","phase","order");--> statement-breakpoint
CREATE INDEX "collab_docs_workflow_idx" ON "collab_docs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "collab_snapshots_doc_clock_idx" ON "collab_snapshots" USING btree ("doc_id","clock");--> statement-breakpoint
CREATE INDEX "collab_updates_doc_seq_idx" ON "collab_updates" USING btree ("doc_id","seq");--> statement-breakpoint
CREATE INDEX "logic_rules_workflow_idx" ON "logic_rules" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "project_access_project_idx" ON "project_access" USING btree ("project_id");--> statement-breakpoint
CREATE UNIQUE INDEX "project_access_principal_idx" ON "project_access" USING btree ("project_id","principal_type","principal_id");--> statement-breakpoint
CREATE INDEX "projects_tenant_idx" ON "projects" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "projects_created_by_idx" ON "projects" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "projects_creator_idx" ON "projects" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "projects_owner_idx" ON "projects" USING btree ("owner_id");--> statement-breakpoint
CREATE INDEX "idx_projects_owner" ON "projects" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "projects_status_idx" ON "projects" USING btree ("status");--> statement-breakpoint
CREATE INDEX "projects_archived_idx" ON "projects" USING btree ("archived");--> statement-breakpoint
CREATE INDEX "sections_workflow_idx" ON "sections" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "steps_section_idx" ON "steps" USING btree ("section_id");--> statement-breakpoint
CREATE UNIQUE INDEX "template_versions_unique_idx" ON "template_versions" USING btree ("template_id","version_number");--> statement-breakpoint
CREATE INDEX "templates_project_idx" ON "templates" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflow_access_workflow_idx" ON "workflow_access" USING btree ("workflow_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_access_principal_idx" ON "workflow_access" USING btree ("workflow_id","principal_type","principal_id");--> statement-breakpoint
CREATE UNIQUE INDEX "workflow_snapshots_workflow_name_unique" ON "workflow_snapshots" USING btree ("workflow_id","name");--> statement-breakpoint
CREATE INDEX "workflow_templates_version_key_unique" ON "workflow_templates" USING btree ("workflow_version_id","key");--> statement-breakpoint
CREATE INDEX "workflow_versions_workflow_idx" ON "workflow_versions" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_versions_version_number_idx" ON "workflow_versions" USING btree ("workflow_id","version_number");--> statement-breakpoint
CREATE INDEX "workflow_versions_is_draft_idx" ON "workflow_versions" USING btree ("is_draft");--> statement-breakpoint
CREATE INDEX "workflows_project_idx" ON "workflows" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "workflows_status_idx" ON "workflows" USING btree ("status");--> statement-breakpoint
CREATE INDEX "workflows_is_public_idx" ON "workflows" USING btree ("is_public");--> statement-breakpoint
CREATE INDEX "workflows_slug_idx" ON "workflows" USING btree ("slug");--> statement-breakpoint
CREATE INDEX "workflows_pinned_version_idx" ON "workflows" USING btree ("pinned_version_id");--> statement-breakpoint
CREATE INDEX "idx_workflows_owner" ON "workflows" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "ai_feedback_workflow_idx" ON "ai_workflow_feedback" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "bm_version_block_idx" ON "block_metrics" USING btree ("version_id","block_id");--> statement-breakpoint
CREATE INDEX "metrics_events_project_ts_idx" ON "metrics_events" USING btree ("project_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_workflow_ts_idx" ON "metrics_events" USING btree ("workflow_id","ts");--> statement-breakpoint
CREATE INDEX "metrics_events_type_idx" ON "metrics_events" USING btree ("type");--> statement-breakpoint
CREATE UNIQUE INDEX "metrics_rollups_unique_idx" ON "metrics_rollups" USING btree ("tenant_id","project_id",COALESCE("workflow_id", '00000000-0000-0000-0000-000000000000'::uuid),"bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "metrics_rollups_project_bucket_idx" ON "metrics_rollups" USING btree ("project_id","bucket_start","bucket");--> statement-breakpoint
CREATE INDEX "review_tasks_run_idx" ON "review_tasks" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "review_tasks_workflow_idx" ON "review_tasks" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "review_tasks_status_idx" ON "review_tasks" USING btree ("status");--> statement-breakpoint
CREATE INDEX "review_tasks_reviewer_idx" ON "review_tasks" USING btree ("reviewer_id");--> statement-breakpoint
CREATE INDEX "run_generated_documents_run_idx" ON "run_generated_documents" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_run_idx" ON "run_logs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_logs_level_idx" ON "run_logs" USING btree ("level");--> statement-breakpoint
CREATE INDEX "run_logs_created_at_idx" ON "run_logs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "run_outputs_run_idx" ON "run_outputs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "run_outputs_run_template_type_idx" ON "run_outputs" USING btree ("run_id","template_key","file_type");--> statement-breakpoint
CREATE INDEX "runs_workflow_version_idx" ON "runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "runs_status_idx" ON "runs" USING btree ("status");--> statement-breakpoint
CREATE INDEX "runs_created_by_idx" ON "runs" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "runs_created_at_idx" ON "runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "script_execution_log_run_idx" ON "script_execution_log" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_events_request_idx" ON "signature_events" USING btree ("signature_request_id");--> statement-breakpoint
CREATE INDEX "signature_requests_run_idx" ON "signature_requests" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "signature_requests_token_idx" ON "signature_requests" USING btree ("token");--> statement-breakpoint
CREATE INDEX "sli_configs_project_idx" ON "sli_configs" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "sli_windows_project_window_idx" ON "sli_windows" USING btree ("project_id","window_start","window_end");--> statement-breakpoint
CREATE INDEX "step_values_run_idx" ON "step_values" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "step_values_step_idx" ON "step_values" USING btree ("step_id");--> statement-breakpoint
CREATE INDEX "step_values_run_step_idx" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE UNIQUE INDEX "step_values_run_step_unique" ON "step_values" USING btree ("run_id","step_id");--> statement-breakpoint
CREATE INDEX "template_metrics_template_idx" ON "template_generation_metrics" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_metrics_run_idx" ON "template_generation_metrics" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_run_idx" ON "transform_block_runs" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "transform_block_runs_block_idx" ON "transform_block_runs" USING btree ("block_id");--> statement-breakpoint
CREATE UNIQUE INDEX "was_workflow_version_date_idx" ON "workflow_analytics_snapshots" USING btree ("workflow_id","version_id","date");--> statement-breakpoint
CREATE INDEX "wre_run_idx" ON "workflow_run_events" USING btree ("run_id");--> statement-breakpoint
CREATE INDEX "wre_workflow_ts_idx" ON "workflow_run_events" USING btree ("workflow_id","timestamp");--> statement-breakpoint
CREATE INDEX "wrm_workflow_created_idx" ON "workflow_run_metrics" USING btree ("workflow_id","created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_workflow_idx" ON "workflow_runs" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_version_idx" ON "workflow_runs" USING btree ("workflow_version_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_completed_idx" ON "workflow_runs" USING btree ("completed");--> statement-breakpoint
CREATE INDEX "workflow_runs_run_token_idx" ON "workflow_runs" USING btree ("run_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_share_token_idx" ON "workflow_runs" USING btree ("share_token");--> statement-breakpoint
CREATE INDEX "workflow_runs_current_section_idx" ON "workflow_runs" USING btree ("current_section_id");--> statement-breakpoint
CREATE INDEX "workflow_runs_created_at_idx" ON "workflow_runs" USING btree ("created_at");--> statement-breakpoint
CREATE INDEX "workflow_runs_owner_idx" ON "workflow_runs" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "analytics_survey_event_idx" ON "analytics_events" USING btree ("survey_id","event");--> statement-breakpoint
CREATE INDEX "analytics_response_event_idx" ON "analytics_events" USING btree ("response_id","event");--> statement-breakpoint
CREATE INDEX "analytics_timestamp_idx" ON "analytics_events" USING btree ("timestamp");--> statement-breakpoint
CREATE INDEX "anonymous_tracking_survey_ip_idx" ON "anonymous_response_tracking" USING btree ("survey_id","ip_address");--> statement-breakpoint
CREATE INDEX "email_queue_status_idx" ON "email_queue" USING btree ("status");--> statement-breakpoint
CREATE INDEX "email_queue_next_attempt_idx" ON "email_queue" USING btree ("next_attempt_at");--> statement-breakpoint
CREATE INDEX "survey_templates_creator_idx" ON "survey_templates" USING btree ("creator_id");--> statement-breakpoint
CREATE INDEX "survey_templates_system_idx" ON "survey_templates" USING btree ("is_system");--> statement-breakpoint
CREATE INDEX "surveys_public_link_unique_idx" ON "surveys" USING btree ("public_link");--> statement-breakpoint
CREATE INDEX "surveys_workspace_idx" ON "surveys" USING btree ("workspace_id");--> statement-breakpoint
CREATE INDEX "template_shares_template_idx" ON "template_shares" USING btree ("template_id");--> statement-breakpoint
CREATE INDEX "template_shares_user_idx" ON "template_shares" USING btree ("user_id");--> statement-breakpoint
CREATE INDEX "template_shares_pending_email_idx" ON "template_shares" USING btree ("pending_email");--> statement-breakpoint
CREATE INDEX "collection_fields_collection_idx" ON "collection_fields" USING btree ("collection_id");--> statement-breakpoint
CREATE UNIQUE INDEX "collection_fields_slug_unique" ON "collection_fields" USING btree ("collection_id","slug");--> statement-breakpoint
CREATE UNIQUE INDEX "collections_slug_unique" ON "collections" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_database_id" ON "datavault_api_tokens" USING btree ("database_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_api_tokens_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_token_hash" ON "datavault_api_tokens" USING btree ("token_hash");--> statement-breakpoint
CREATE INDEX "datavault_columns_table_idx" ON "datavault_columns" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_columns_reference_table_idx" ON "datavault_columns" USING btree ("reference_table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_columns_table_slug_unique" ON "datavault_columns" USING btree ("table_id","slug");--> statement-breakpoint
CREATE INDEX "idx_databases_tenant" ON "datavault_databases" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_databases_scope" ON "datavault_databases" USING btree ("scope_type","scope_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_databases_owner" ON "datavault_databases" USING btree ("owner_type","owner_uuid");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_tenant" ON "datavault_number_sequences" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_sequences_table" ON "datavault_number_sequences" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "idx_datavault_sequences_column_unique" ON "datavault_number_sequences" USING btree ("tenant_id","table_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_row_id" ON "datavault_row_notes" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "idx_datavault_row_notes_tenant_id" ON "datavault_row_notes" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_table_idx" ON "datavault_rows" USING btree ("table_id");--> statement-breakpoint
CREATE INDEX "datavault_rows_created_by_idx" ON "datavault_rows" USING btree ("created_by");--> statement-breakpoint
CREATE INDEX "idx_table_permissions_table" ON "datavault_table_permissions" USING btree ("table_id");--> statement-breakpoint
CREATE UNIQUE INDEX "unique_table_user_permission" ON "datavault_table_permissions" USING btree ("table_id","user_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_tenant_idx" ON "datavault_tables" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "datavault_tables_owner_idx" ON "datavault_tables" USING btree ("owner_user_id");--> statement-breakpoint
CREATE INDEX "idx_tables_database" ON "datavault_tables" USING btree ("database_id","tenant_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_tables_tenant_slug_unique" ON "datavault_tables" USING btree ("tenant_id","slug");--> statement-breakpoint
CREATE INDEX "datavault_values_row_idx" ON "datavault_values" USING btree ("row_id");--> statement-breakpoint
CREATE INDEX "datavault_values_column_idx" ON "datavault_values" USING btree ("column_id");--> statement-breakpoint
CREATE UNIQUE INDEX "datavault_values_row_column_unique" ON "datavault_values" USING btree ("row_id","column_id");--> statement-breakpoint
CREATE INDEX "idx_writeback_mappings_workflow" ON "datavault_writeback_mappings" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "records_collection_idx" ON "records" USING btree ("collection_id");--> statement-breakpoint
CREATE INDEX "records_tenant_idx" ON "records" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_data_sources_workflow" ON "workflow_data_sources" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "idx_workflow_queries_workflow" ON "workflow_queries" USING btree ("workflow_id");--> statement-breakpoint
CREATE INDEX "api_keys_project_idx" ON "api_keys" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_tenant_idx" ON "connections" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "connections_project_idx" ON "connections" USING btree ("project_id");--> statement-breakpoint
CREATE INDEX "connections_project_name_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "connections_type_idx" ON "connections" USING btree ("type");--> statement-breakpoint
CREATE INDEX "connections_enabled_idx" ON "connections" USING btree ("enabled");--> statement-breakpoint
CREATE UNIQUE INDEX "connections_project_name_unique_idx" ON "connections" USING btree ("project_id","name");--> statement-breakpoint
CREATE INDEX "ext_dest_tenant_idx" ON "external_destinations" USING btree ("tenant_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_client_id_idx" ON "oauth_apps" USING btree ("client_id");--> statement-breakpoint
CREATE INDEX "oauth_apps_workspace_idx" ON "oauth_apps" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "secrets_project_key_env_unique" ON "secrets" USING btree ("project_id","key","environment");--> statement-breakpoint
CREATE INDEX "webhook_events_sub_idx" ON "webhook_events" USING btree ("subscription_id");--> statement-breakpoint
CREATE INDEX "webhook_subs_workspace_idx" ON "webhook_subscriptions" USING btree ("workspace_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_org_idx" ON "customer_billing_info" USING btree ("organization_id");--> statement-breakpoint
CREATE UNIQUE INDEX "billing_info_stripe_idx" ON "customer_billing_info" USING btree ("stripe_customer_id");--> statement-breakpoint
CREATE UNIQUE INDEX "seat_sub_user_idx" ON "subscription_seats" USING btree ("subscription_id","user_id");--> statement-breakpoint
CREATE UNIQUE INDEX "sub_org_idx" ON "subscriptions" USING btree ("organization_id");--> statement-breakpoint
CREATE INDEX "usage_org_metric_date_idx" ON "usage_records" USING btree ("organization_id","metric","recorded_at");--> statement-breakpoint
CREATE INDEX "email_templates_key_idx" ON "email_template_metadata" USING btree ("template_key");--> statement-breakpoint
CREATE INDEX "ai_settings_scope_idx" ON "ai_settings" USING btree ("scope");
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:235:19 {
  query: 'SET search_path TO "test_schema_w0_v3", public;\n' +
    '\n' +
    `CREATE TYPE "test_schema_w0_v3"."anonymous_access_type" AS ENUM('disabled', 'unlimited', 'one_per_ip', 'one_per_session');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."auth_provider" AS ENUM('local', 'google', 'github', 'email');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."organization_invite_status" AS ENUM('pending', 'accepted', 'expired', 'revoked');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."organization_role" AS ENUM('admin', 'member');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."owner_type" AS ENUM('user', 'org');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."tenant_plan" AS ENUM('free', 'pro', 'enterprise');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."user_role" AS ENUM('admin', 'creator', 'user', 'guest');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."user_tenant_role" AS ENUM('owner', 'builder', 'runner', 'viewer');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."workspace_role" AS ENUM('owner', 'admin', 'editor', 'contributor', 'viewer');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."block_phase" AS ENUM('onRunStart', 'onSectionEnter', 'onSectionSubmit', 'onNext', 'onRunComplete');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."block_type" AS ENUM('prefill', 'validate', 'branch', 'create_record', 'update_record', 'find_record', 'delete_record', 'query', 'write', 'external_send', 'read_table', 'list_tools');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."condition_operator" AS ENUM('equals', 'not_equals', 'contains', 'not_contains', 'greater_than', 'less_than', 'between', 'is_empty', 'is_not_empty');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."conditional_action" AS ENUM('show', 'hide', 'require', 'make_optional', 'skip_to');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."document_hook_phase" AS ENUM('beforeGeneration', 'afterGeneration');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."lifecycle_hook_phase" AS ENUM('beforePage', 'afterPage', 'beforeFinalBlock', 'afterDocumentsGenerated');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."logic_rule_target_type" AS ENUM('section', 'step');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."project_status" AS ENUM('active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."step_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group', 'computed', 'js_question', 'repeater', 'final_documents', 'signature_block', 'true_false', 'phone', 'date', 'time', 'datetime', 'email', 'number', 'currency', 'scale', 'website', 'display', 'address', 'final', 'text', 'boolean', 'phone_advanced', 'datetime_unified', 'choice', 'email_advanced', 'number_advanced', 'scale_advanced', 'website_advanced', 'address_advanced', 'multi_field', 'display_advanced');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."template_type" AS ENUM('docx', 'html', 'pdf');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."transform_block_language" AS ENUM('javascript', 'python');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."transform_block_type" AS ENUM('map', 'rename', 'compute', 'conditional', 'loop', 'script');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."version_status" AS ENUM('draft', 'published');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."workflow_status" AS ENUM('draft', 'active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."log_level" AS ENUM('info', 'warn', 'error');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."metrics_event_type" AS ENUM('run_started', 'run_succeeded', 'run_failed', 'pdf_succeeded', 'pdf_failed', 'docx_succeeded', 'docx_failed', 'queue_enqueued', 'queue_dequeued');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."output_file_type" AS ENUM('docx', 'pdf');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."output_status" AS ENUM('pending', 'ready', 'failed');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."portal_access_mode" AS ENUM('anonymous', 'token', 'portal');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."review_task_status" AS ENUM('pending', 'approved', 'changes_requested', 'rejected');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."rollup_bucket" AS ENUM('1m', '5m', '1h', '1d');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."run_status" AS ENUM('pending', 'success', 'error', 'waiting_review', 'waiting_signature');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."script_execution_status" AS ENUM('success', 'error', 'timeout');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."signature_event_type" AS ENUM('sent', 'viewed', 'signed', 'declined');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."signature_provider" AS ENUM('native', 'docusign', 'hellosign');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."signature_request_status" AS ENUM('pending', 'signed', 'declined', 'expired');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."sli_window" AS ENUM('1d', '7d', '30d');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."transform_block_run_status" AS ENUM('success', 'timeout', 'error');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."email_queue_status" AS ENUM('pending', 'processing', 'completed', 'failed');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."public_access_mode" AS ENUM('open', 'link_only', 'domain_restricted');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."question_type" AS ENUM('short_text', 'long_text', 'multiple_choice', 'radio', 'yes_no', 'date_time', 'file_upload', 'loop_group');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."survey_status" AS ENUM('draft', 'open', 'closed', 'active', 'archived');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."template_access" AS ENUM('use', 'edit');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."autonumber_reset_policy" AS ENUM('never', 'yearly');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."data_source_type" AS ENUM('native', 'postgres', 'google_sheets', 'airtable', 'external');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."datavault_column_type" AS ENUM('text', 'number', 'boolean', 'date', 'datetime', 'email', 'phone', 'url', 'json', 'auto_number', 'autonumber', 'reference', 'select', 'multiselect');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."datavault_scope_type" AS ENUM('account', 'project', 'workflow');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."datavault_table_role" AS ENUM('owner', 'write', 'read');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."connection_type" AS ENUM('api_key', 'bearer', 'oauth2_client_credentials', 'oauth2_3leg');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."secret_type" AS ENUM('api_key', 'bearer', 'oauth2', 'basic_auth');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."webhook_event" AS ENUM('workflow_run.started', 'workflow_run.page_completed', 'workflow_run.completed', 'document.generated', 'signature.completed', 'signature.declined');--> statement-breakpoint\n` +
    `CREATE TYPE "test_schema_w0_v3"."subscription_status" AS ENUM('active', 'past_due', 'canceled', 'trialing', 'incomplete', 'incomplete_expired', 'unpaid');--> statement-breakpoint\n` +
    'CREATE TABLE "account_locks" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"locked_at" timestamp DEFAULT now() NOT NULL,\n' +
    '\t"locked_until" timestamp NOT NULL,\n' +
    '\t"reason" varchar(255),\n' +
    '\t"unlocked" boolean DEFAULT false NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "audit_logs" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"tenant_id" uuid,\n' +
    '\t"workspace_id" uuid,\n' +
    '\t"user_id" varchar,\n' +
    '\t"action" varchar NOT NULL,\n' +
    '\t"entity_type" varchar NOT NULL,\n' +
    '\t"entity_id" varchar NOT NULL,\n' +
    '\t"resource_type" varchar,\n' +
    '\t"resource_id" varchar,\n' +
    '\t"changes" jsonb,\n' +
    '\t"details" jsonb,\n' +
    '\t"ip_address" varchar,\n' +
    '\t"user_agent" text,\n' +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"timestamp" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "email_verification_tokens" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"token" varchar NOT NULL,\n' +
    '\t"expires_at" timestamp NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now()\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "login_attempts" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"email" varchar(255) NOT NULL,\n' +
    '\t"ip_address" varchar(45),\n' +
    '\t"successful" boolean DEFAULT false NOT NULL,\n' +
    '\t"attempted_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "mfa_backup_codes" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"code_hash" text NOT NULL,\n' +
    '\t"used" boolean DEFAULT false NOT NULL,\n' +
    '\t"used_at" timestamp,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "mfa_secrets" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"user_id" varchar NOT NULL,\n' +
    '\t"secret" text NOT NULL,\n' +
    '\t"enabled" boolean DEFAULT false NOT NULL,\n' +
    '\t"created_at" timestamp DEFAULT now() NOT NULL,\n' +
    '\t"enabled_at" timestamp,\n' +
    '\tCONSTRAINT "mfa_secrets_user_id_unique" UNIQUE("user_id")\n' +
    ');\n' +
    '--> statement-breakpoint\n' +
    'CREATE TABLE "organization_invites" (\n' +
    '\t"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n' +
    '\t"org_id" uuid NOT NULL,\n' +
    '\t"invited_email" varchar(255) NOT NULL,\n' +
    '\t"invited_user_id" varchar,\n' +
    '\t"invited_by_user_id" varchar NOT NULL,\n' +
    '\t"token" varchar(255) NOT NULL,\n' +
    `\t"status" "organization_invite_status" DEFAULT 'pending' NOT NULL,\n` +
    '\t"created_at" timestamp DEFAULT now(),\n' +
    '\t"expires_at" timestamp NOT NULL,\n' +
    '\t"accepted_at" timestamp,\n' +
    '\t"email_sent_at" timestamp,\n' +
    '\t"email_failed" boolean DEFAULT false,\n' +
    '\t"email_error" text,\n' +
    '\tCONSTRAINT "organization_invites_token_unique" UNIQUE("token")\n' +
    ');\n' +
    '--> st'... 111275 more characters,
  params: [],
  cause: error: duplicate key value violates unique constraint "pg_type_typname_nsp_index"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:235:19 {
    length: 264,
    severity: 'ERROR',
    code: '23505',
    detail: 'Key (typname, typnamespace)=(anonymous_access_type, 2456483) already exists.',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'pg_catalog',
    table: 'pg_type',
    column: undefined,
    dataType: undefined,
    constraint: 'pg_type_typname_nsp_index',
    file: 'nbtinsert.c',
    line: '667',
    routine: '_bt_check_unique'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

{"level":30,"time":1768675050133,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768675050151,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768675050141,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768675050141,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768675050146,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768675050146,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768675050150,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768675050150,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768675050151,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768675050151,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768675050457,"env":"test","module":"auth-routes","error":{},"msg":"Registration failed"}
{"level":30,"time":1768675050469,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768675050469,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
CRITICAL REGISTRATION ERROR: ReferenceError: SALT_ROUNDS is not defined
    at AuthService.hashPassword (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:168:38)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:242:46
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 4670ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  12:37:13
   Duration  16.25s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/AuthService.ts x2 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768675167756,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768675171136,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768675171186,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768675172948,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768675172968,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768675172957,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768675172957,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768675172962,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768675172963,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768675172967,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768675172968,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768675172968,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768675172968,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768675173571,"env":"test","module":"user-credentials-repository","userId":"6eefa06a-ab9c-45ab-bb0e-6315cfe32a42","msg":"User credentials created"}
{"level":30,"time":1768675173794,"env":"test","module":"email-queue","jobId":"3662c3ce-33ef-4d1e-a091-b3dd7e35d9c5","to":"test-MGz1HCyddZ-TFlklW0o_h@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768675173797,"env":"test","module":"auth-routes","error":{},"msg":"Registration failed"}
{"level":30,"time":1768675173807,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768675173807,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
CRITICAL REGISTRATION ERROR: ReferenceError: JWT_SECRET is not defined
    at AuthService.createToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:72:9)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:248:33
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 3503ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  12:39:17
   Duration  16.09s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/services/AuthService.ts x3 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöä add secrets lifecycle management: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768675270519,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

{"level":30,"time":1768675335411,"env":"test","msg":"DB: initializing... Local"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768675339895,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

{"level":30,"time":1768675341373,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768675341390,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768675341379,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768675341379,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768675341384,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768675341384,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768675341390,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768675341390,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768675341390,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768675341390,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768675341839,"env":"test","module":"user-credentials-repository","userId":"30e8ffbb-8ebc-4095-b402-c465447cf25e","msg":"User credentials created"}
{"level":30,"time":1768675341931,"env":"test","module":"email-queue","jobId":"2353c6b8-65b3-453d-a0e9-0ce8ae7cc967","to":"test-Hup4WzGAB9Voa05Xkm4qQ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675341982,"env":"test","module":"auth-routes","userId":"30e8ffbb-8ebc-4095-b402-c465447cf25e","email":"test-Hup4WzGAB9Voa05Xkm4qQ@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

{"level":30,"time":1768675342589,"env":"test","module":"user-credentials-repository","userId":"f24c5ce0-e124-4de3-9c0a-c069c1761311","msg":"User credentials created"}
{"level":30,"time":1768675342687,"env":"test","module":"email-queue","jobId":"bf945d5b-9f4e-455b-973d-09e94dc5eed4","to":"protected-test-iMXJHgFAHdxbW712ciiWa@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675342734,"env":"test","module":"auth-routes","userId":"f24c5ce0-e124-4de3-9c0a-c069c1761311","email":"protected-test-iMXJHgFAHdxbW712ciiWa@example.com","msg":"User registered"}
{"level":30,"time":1768675343334,"env":"test","module":"auth-routes","userId":"f24c5ce0-e124-4de3-9c0a-c069c1761311","msg":"User logged in successfully"}
{"level":30,"time":1768675343380,"env":"test","module":"audit-log-service","userId":"f24c5ce0-e124-4de3-9c0a-c069c1761311","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768675343806,"env":"test","module":"user-credentials-repository","userId":"ff59d224-84cf-41f7-b656-e280c5eca82b","msg":"User credentials created"}
{"level":30,"time":1768675343897,"env":"test","module":"email-queue","jobId":"f3b81b66-f326-4b75-b277-6d17020c0874","to":"protected-test-CRwZSq4PN0qwxnjC7nhlD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675343944,"env":"test","module":"auth-routes","userId":"ff59d224-84cf-41f7-b656-e280c5eca82b","email":"protected-test-CRwZSq4PN0qwxnjC7nhlD@example.com","msg":"User registered"}
{"level":30,"time":1768675344517,"env":"test","module":"auth-routes","userId":"ff59d224-84cf-41f7-b656-e280c5eca82b","msg":"User logged in successfully"}
{"level":30,"time":1768675344563,"env":"test","module":"audit-log-service","userId":"ff59d224-84cf-41f7-b656-e280c5eca82b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675344566,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675344927,"env":"test","module":"user-credentials-repository","userId":"9e00e951-28d0-4f45-a318-e942f0bf97b2","msg":"User credentials created"}
{"level":30,"time":1768675345018,"env":"test","module":"email-queue","jobId":"a15c1cf7-2a0e-48c3-ab10-31b74ef2daf3","to":"protected-test-MkSzond_xn2akbvWe9vnp@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675345067,"env":"test","module":"auth-routes","userId":"9e00e951-28d0-4f45-a318-e942f0bf97b2","email":"protected-test-MkSzond_xn2akbvWe9vnp@example.com","msg":"User registered"}
{"level":30,"time":1768675345657,"env":"test","module":"auth-routes","userId":"9e00e951-28d0-4f45-a318-e942f0bf97b2","msg":"User logged in successfully"}
{"level":30,"time":1768675345701,"env":"test","module":"audit-log-service","userId":"9e00e951-28d0-4f45-a318-e942f0bf97b2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675345706,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

{"level":30,"time":1768675346061,"env":"test","module":"user-credentials-repository","userId":"e0da1fd4-64bb-416d-90d7-2e9e02d06d4d","msg":"User credentials created"}
{"level":30,"time":1768675346157,"env":"test","module":"email-queue","jobId":"560d36e6-6b0e-43c5-9966-51ec56488460","to":"protected-test-zKBGD3CSrZA7Y_L2ouDUM@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675346203,"env":"test","module":"auth-routes","userId":"e0da1fd4-64bb-416d-90d7-2e9e02d06d4d","email":"protected-test-zKBGD3CSrZA7Y_L2ouDUM@example.com","msg":"User registered"}
{"level":30,"time":1768675346781,"env":"test","module":"auth-routes","userId":"e0da1fd4-64bb-416d-90d7-2e9e02d06d4d","msg":"User logged in successfully"}
{"level":30,"time":1768675346826,"env":"test","module":"audit-log-service","userId":"e0da1fd4-64bb-416d-90d7-2e9e02d06d4d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675346830,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768675347183,"env":"test","module":"user-credentials-repository","userId":"1453fcff-45a1-43fc-a01b-1972c4fa4dc3","msg":"User credentials created"}
{"level":30,"time":1768675347274,"env":"test","module":"email-queue","jobId":"16f98c66-6188-4ea2-9e9e-576f0da9291e","to":"protected-test-XjL7l_AeIf8Zj6Lqk3XDF@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675347323,"env":"test","module":"auth-routes","userId":"1453fcff-45a1-43fc-a01b-1972c4fa4dc3","email":"protected-test-XjL7l_AeIf8Zj6Lqk3XDF@example.com","msg":"User registered"}
{"level":30,"time":1768675347949,"env":"test","module":"auth-routes","userId":"1453fcff-45a1-43fc-a01b-1972c4fa4dc3","msg":"User logged in successfully"}
{"level":30,"time":1768675347999,"env":"test","module":"audit-log-service","userId":"1453fcff-45a1-43fc-a01b-1972c4fa4dc3","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768675348003,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768675348003,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675348372,"env":"test","module":"user-credentials-repository","userId":"c03615a1-d8ba-4122-aea7-fb7ef85c543a","msg":"User credentials created"}
{"level":30,"time":1768675348469,"env":"test","module":"email-queue","jobId":"007c0f11-218c-456d-8711-e7a55d442ce2","to":"protected-test-jzwsKqlVS2zbiL_cSgJon@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675348513,"env":"test","module":"auth-routes","userId":"c03615a1-d8ba-4122-aea7-fb7ef85c543a","email":"protected-test-jzwsKqlVS2zbiL_cSgJon@example.com","msg":"User registered"}
{"level":30,"time":1768675349090,"env":"test","module":"auth-routes","userId":"c03615a1-d8ba-4122-aea7-fb7ef85c543a","msg":"User logged in successfully"}
{"level":30,"time":1768675349138,"env":"test","module":"audit-log-service","userId":"c03615a1-d8ba-4122-aea7-fb7ef85c543a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675349557,"env":"test","module":"user-credentials-repository","userId":"7a9a6d3b-c020-4a3c-a21d-ed33bae09860","msg":"User credentials created"}
{"level":30,"time":1768675349646,"env":"test","module":"email-queue","jobId":"387e1b1a-5bc9-48ab-8865-43d8a83d30f4","to":"protected-test-S5IFfqhCu6FdvxL0GmVF-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675349691,"env":"test","module":"auth-routes","userId":"7a9a6d3b-c020-4a3c-a21d-ed33bae09860","email":"protected-test-S5IFfqhCu6FdvxL0GmVF-@example.com","msg":"User registered"}
{"level":30,"time":1768675350273,"env":"test","module":"auth-routes","userId":"7a9a6d3b-c020-4a3c-a21d-ed33bae09860","msg":"User logged in successfully"}
{"level":30,"time":1768675350318,"env":"test","module":"audit-log-service","userId":"7a9a6d3b-c020-4a3c-a21d-ed33bae09860","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675350323,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675350698,"env":"test","module":"user-credentials-repository","userId":"27e52d76-a149-46c3-a791-eb4d6a0282c5","msg":"User credentials created"}
{"level":30,"time":1768675350787,"env":"test","module":"email-queue","jobId":"5ee48995-b4ca-4d13-b143-5a94954c5fb0","to":"protected-test--hYp1sVdNONDHPQg0rWdi@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675350836,"env":"test","module":"auth-routes","userId":"27e52d76-a149-46c3-a791-eb4d6a0282c5","email":"protected-test--hYp1sVdNONDHPQg0rWdi@example.com","msg":"User registered"}
{"level":30,"time":1768675351428,"env":"test","module":"auth-routes","userId":"27e52d76-a149-46c3-a791-eb4d6a0282c5","msg":"User logged in successfully"}
{"level":30,"time":1768675351473,"env":"test","module":"audit-log-service","userId":"27e52d76-a149-46c3-a791-eb4d6a0282c5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675351477,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675351850,"env":"test","module":"user-credentials-repository","userId":"6d69fab1-a32d-4dda-b9f7-8a1d6d7891ec","msg":"User credentials created"}
{"level":30,"time":1768675351941,"env":"test","module":"email-queue","jobId":"9734b19a-231b-4ea7-a53c-387647c3bf27","to":"protected-test-fEboMYwWCJeAKOWPmq11l@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675351987,"env":"test","module":"auth-routes","userId":"6d69fab1-a32d-4dda-b9f7-8a1d6d7891ec","email":"protected-test-fEboMYwWCJeAKOWPmq11l@example.com","msg":"User registered"}
{"level":30,"time":1768675352596,"env":"test","module":"auth-routes","userId":"6d69fab1-a32d-4dda-b9f7-8a1d6d7891ec","msg":"User logged in successfully"}
{"level":30,"time":1768675352641,"env":"test","module":"audit-log-service","userId":"6d69fab1-a32d-4dda-b9f7-8a1d6d7891ec","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[DEBUG] BaseRepository.update users: id=6d69fab1-a32d-4dda-b9f7-8a1d6d7891ec, updates={"defaultMode":"advanced","updatedAt":"2026-01-17T18:42:32.749Z"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675353172,"env":"test","module":"user-credentials-repository","userId":"e676779f-3811-4130-a7b7-8ffdf50234ae","msg":"User credentials created"}
{"level":30,"time":1768675353264,"env":"test","module":"email-queue","jobId":"3ff80713-8f9b-46c1-ac9a-b59f860e9a51","to":"protected-test-IGMOUIrFqZQ5apmrnfYAP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675353308,"env":"test","module":"auth-routes","userId":"e676779f-3811-4130-a7b7-8ffdf50234ae","email":"protected-test-IGMOUIrFqZQ5apmrnfYAP@example.com","msg":"User registered"}
{"level":30,"time":1768675353905,"env":"test","module":"auth-routes","userId":"e676779f-3811-4130-a7b7-8ffdf50234ae","msg":"User logged in successfully"}
{"level":30,"time":1768675353950,"env":"test","module":"audit-log-service","userId":"e676779f-3811-4130-a7b7-8ffdf50234ae","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675353955,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675354312,"env":"test","module":"user-credentials-repository","userId":"c1a5daf0-0d67-45fb-bf34-0def9f11db03","msg":"User credentials created"}
{"level":30,"time":1768675354402,"env":"test","module":"email-queue","jobId":"7ca5bc1a-91ca-4c44-9d34-9ec7bcc59dbd","to":"protected-test-ajSI9ZVSVzoOeFRspyBpu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675354448,"env":"test","module":"auth-routes","userId":"c1a5daf0-0d67-45fb-bf34-0def9f11db03","email":"protected-test-ajSI9ZVSVzoOeFRspyBpu@example.com","msg":"User registered"}
{"level":30,"time":1768675355034,"env":"test","module":"auth-routes","userId":"c1a5daf0-0d67-45fb-bf34-0def9f11db03","msg":"User logged in successfully"}
{"level":30,"time":1768675355079,"env":"test","module":"audit-log-service","userId":"c1a5daf0-0d67-45fb-bf34-0def9f11db03","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675355586,"env":"test","module":"user-credentials-repository","userId":"d742df31-cf97-4eb8-a698-78239a120579","msg":"User credentials created"}
{"level":30,"time":1768675355679,"env":"test","module":"email-queue","jobId":"0a81f5bc-8301-42fa-b4f2-e0368d53c859","to":"protected-test-yDJ6UnlvhG5D6c1sjcplu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675355724,"env":"test","module":"auth-routes","userId":"d742df31-cf97-4eb8-a698-78239a120579","email":"protected-test-yDJ6UnlvhG5D6c1sjcplu@example.com","msg":"User registered"}
{"level":30,"time":1768675356320,"env":"test","module":"auth-routes","userId":"d742df31-cf97-4eb8-a698-78239a120579","msg":"User logged in successfully"}
{"level":30,"time":1768675356368,"env":"test","module":"audit-log-service","userId":"d742df31-cf97-4eb8-a698-78239a120579","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675356372,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675356725,"env":"test","module":"user-credentials-repository","userId":"a70cc8b2-537f-4afa-86a8-697b688b2909","msg":"User credentials created"}
{"level":30,"time":1768675356814,"env":"test","module":"email-queue","jobId":"56245b04-21ef-4d9d-bfff-1d95539fa201","to":"protected-test-nXgU4-2ciskhr5BhvqUvy@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675356860,"env":"test","module":"auth-routes","userId":"a70cc8b2-537f-4afa-86a8-697b688b2909","email":"protected-test-nXgU4-2ciskhr5BhvqUvy@example.com","msg":"User registered"}
{"level":30,"time":1768675357472,"env":"test","module":"auth-routes","userId":"a70cc8b2-537f-4afa-86a8-697b688b2909","msg":"User logged in successfully"}
{"level":30,"time":1768675357518,"env":"test","module":"audit-log-service","userId":"a70cc8b2-537f-4afa-86a8-697b688b2909","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675358502,"env":"test","module":"user-credentials-repository","userId":"ad12599e-feae-4223-bc67-54b0ce378da2","msg":"User credentials created"}
{"level":30,"time":1768675358609,"env":"test","module":"email-queue","jobId":"8fe607a6-ff40-4308-afdf-e9a32a4f582c","to":"protected-test-Hg1arqQkv_ICaUnyY82KA@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675358658,"env":"test","module":"auth-routes","userId":"ad12599e-feae-4223-bc67-54b0ce378da2","email":"protected-test-Hg1arqQkv_ICaUnyY82KA@example.com","msg":"User registered"}
{"level":30,"time":1768675359266,"env":"test","module":"auth-routes","userId":"ad12599e-feae-4223-bc67-54b0ce378da2","msg":"User logged in successfully"}
{"level":30,"time":1768675359318,"env":"test","module":"audit-log-service","userId":"ad12599e-feae-4223-bc67-54b0ce378da2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675359322,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675359681,"env":"test","module":"user-credentials-repository","userId":"d08d109a-941d-4960-b7ae-aafc452e7f28","msg":"User credentials created"}
{"level":30,"time":1768675359773,"env":"test","module":"email-queue","jobId":"0f90312e-38f0-4280-92aa-e45a53442c12","to":"protected-test-iK2uqyC43tg6hNy7k_Ltx@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675359822,"env":"test","module":"auth-routes","userId":"d08d109a-941d-4960-b7ae-aafc452e7f28","email":"protected-test-iK2uqyC43tg6hNy7k_Ltx@example.com","msg":"User registered"}
{"level":30,"time":1768675360400,"env":"test","module":"auth-routes","userId":"d08d109a-941d-4960-b7ae-aafc452e7f28","msg":"User logged in successfully"}
{"level":30,"time":1768675360445,"env":"test","module":"audit-log-service","userId":"d08d109a-941d-4960-b7ae-aafc452e7f28","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768675360449,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768675360449,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675360801,"env":"test","module":"user-credentials-repository","userId":"d61e2419-1bbb-40df-a2f8-da97ccc1d814","msg":"User credentials created"}
{"level":30,"time":1768675360895,"env":"test","module":"email-queue","jobId":"bd8f69e0-1710-435b-a7d7-0e1228db7180","to":"protected-test-_rgY5QM9SaLizmCTr-iq1@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675360944,"env":"test","module":"auth-routes","userId":"d61e2419-1bbb-40df-a2f8-da97ccc1d814","email":"protected-test-_rgY5QM9SaLizmCTr-iq1@example.com","msg":"User registered"}
{"level":30,"time":1768675361522,"env":"test","module":"auth-routes","userId":"d61e2419-1bbb-40df-a2f8-da97ccc1d814","msg":"User logged in successfully"}
{"level":30,"time":1768675361568,"env":"test","module":"audit-log-service","userId":"d61e2419-1bbb-40df-a2f8-da97ccc1d814","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675361573,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675361944,"env":"test","module":"user-credentials-repository","userId":"82922352-3f7f-4be5-841d-a257214ffbb2","msg":"User credentials created"}
{"level":30,"time":1768675362033,"env":"test","module":"email-queue","jobId":"7bf05783-8a12-449c-8650-e9ee18a1da2f","to":"protected-test-QL5YKdaoOMzJkE-m1mqt0@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675362078,"env":"test","module":"auth-routes","userId":"82922352-3f7f-4be5-841d-a257214ffbb2","email":"protected-test-QL5YKdaoOMzJkE-m1mqt0@example.com","msg":"User registered"}
{"level":30,"time":1768675362668,"env":"test","module":"auth-routes","userId":"82922352-3f7f-4be5-841d-a257214ffbb2","msg":"User logged in successfully"}
{"level":30,"time":1768675362712,"env":"test","module":"audit-log-service","userId":"82922352-3f7f-4be5-841d-a257214ffbb2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675362714,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675363078,"env":"test","module":"user-credentials-repository","userId":"6a8d7504-3aba-4827-b850-0f9f146b4375","msg":"User credentials created"}
{"level":30,"time":1768675363171,"env":"test","module":"email-queue","jobId":"f533dcf7-fd62-4c39-a102-cc50dc45ff7f","to":"protected-test-tZsRbBPHCcJMJu5s_JXFF@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675363215,"env":"test","module":"auth-routes","userId":"6a8d7504-3aba-4827-b850-0f9f146b4375","email":"protected-test-tZsRbBPHCcJMJu5s_JXFF@example.com","msg":"User registered"}
{"level":30,"time":1768675363803,"env":"test","module":"auth-routes","userId":"6a8d7504-3aba-4827-b850-0f9f146b4375","msg":"User logged in successfully"}
{"level":30,"time":1768675363852,"env":"test","module":"audit-log-service","userId":"6a8d7504-3aba-4827-b850-0f9f146b4375","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675363855,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675364211,"env":"test","module":"user-credentials-repository","userId":"b29afda8-142c-4e1e-87be-c57ca73e1f8f","msg":"User credentials created"}
{"level":30,"time":1768675364302,"env":"test","module":"email-queue","jobId":"3a791801-1735-496c-9339-29d87a3d517d","to":"protected-test-raCbbEzj9ZZKphDC6bc5l@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675364347,"env":"test","module":"auth-routes","userId":"b29afda8-142c-4e1e-87be-c57ca73e1f8f","email":"protected-test-raCbbEzj9ZZKphDC6bc5l@example.com","msg":"User registered"}
{"level":30,"time":1768675364946,"env":"test","module":"auth-routes","userId":"b29afda8-142c-4e1e-87be-c57ca73e1f8f","msg":"User logged in successfully"}
{"level":30,"time":1768675364992,"env":"test","module":"audit-log-service","userId":"b29afda8-142c-4e1e-87be-c57ca73e1f8f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675364994,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675365358,"env":"test","module":"user-credentials-repository","userId":"cfa0a765-b0c4-4037-aa99-4ef8d9bef7f8","msg":"User credentials created"}
{"level":30,"time":1768675365451,"env":"test","module":"email-queue","jobId":"f2a431d4-5a4a-41b7-9b18-90797fdc9df4","to":"protected-test-zfX1QwN3xISJV65f6MfH7@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675365503,"env":"test","module":"auth-routes","userId":"cfa0a765-b0c4-4037-aa99-4ef8d9bef7f8","email":"protected-test-zfX1QwN3xISJV65f6MfH7@example.com","msg":"User registered"}
{"level":30,"time":1768675366097,"env":"test","module":"auth-routes","userId":"cfa0a765-b0c4-4037-aa99-4ef8d9bef7f8","msg":"User logged in successfully"}
{"level":30,"time":1768675366150,"env":"test","module":"audit-log-service","userId":"cfa0a765-b0c4-4037-aa99-4ef8d9bef7f8","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675366153,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768675366500,"env":"test","module":"user-credentials-repository","userId":"94ac15a4-faee-4fcd-8095-b4a060f310bf","msg":"User credentials created"}
{"level":30,"time":1768675366593,"env":"test","module":"email-queue","jobId":"53b3c029-8984-49e2-9e3d-412eaa596947","to":"protected-test-1fVKCe5EQ2nEdJAG9sQif@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675366637,"env":"test","module":"auth-routes","userId":"94ac15a4-faee-4fcd-8095-b4a060f310bf","email":"protected-test-1fVKCe5EQ2nEdJAG9sQif@example.com","msg":"User registered"}
{"level":30,"time":1768675367239,"env":"test","module":"auth-routes","userId":"94ac15a4-faee-4fcd-8095-b4a060f310bf","msg":"User logged in successfully"}
{"level":30,"time":1768675367285,"env":"test","module":"audit-log-service","userId":"94ac15a4-faee-4fcd-8095-b4a060f310bf","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768675367288,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675367634,"env":"test","module":"user-credentials-repository","userId":"65355a87-2883-4c23-941f-7db1301464d6","msg":"User credentials created"}
{"level":30,"time":1768675367730,"env":"test","module":"email-queue","jobId":"3570bc5d-c902-404f-b377-b424fc08c377","to":"protected-test-sSQzZ-uS1EK2ma7qhWpHu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675367795,"env":"test","module":"auth-routes","userId":"65355a87-2883-4c23-941f-7db1301464d6","email":"protected-test-sSQzZ-uS1EK2ma7qhWpHu@example.com","msg":"User registered"}
{"level":30,"time":1768675368375,"env":"test","module":"auth-routes","userId":"65355a87-2883-4c23-941f-7db1301464d6","msg":"User logged in successfully"}
{"level":30,"time":1768675368428,"env":"test","module":"audit-log-service","userId":"65355a87-2883-4c23-941f-7db1301464d6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675368782,"env":"test","module":"user-credentials-repository","userId":"564daeff-13ef-421f-9589-5e429a8495ee","msg":"User credentials created"}
{"level":30,"time":1768675368895,"env":"test","module":"email-queue","jobId":"14a2b02a-fefa-42b6-89f2-dab1c606435d","to":"protected-test-B-WKgS5c9PP_bWqnz29dg@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675368947,"env":"test","module":"auth-routes","userId":"564daeff-13ef-421f-9589-5e429a8495ee","email":"protected-test-B-WKgS5c9PP_bWqnz29dg@example.com","msg":"User registered"}
{"level":30,"time":1768675369538,"env":"test","module":"auth-routes","userId":"564daeff-13ef-421f-9589-5e429a8495ee","msg":"User logged in successfully"}
{"level":30,"time":1768675369583,"env":"test","module":"audit-log-service","userId":"564daeff-13ef-421f-9589-5e429a8495ee","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675370027,"env":"test","module":"user-credentials-repository","userId":"0471747a-bcf6-4b9e-af37-d8bf26a2a81b","msg":"User credentials created"}
{"level":30,"time":1768675370114,"env":"test","module":"email-queue","jobId":"3e51b25c-2ac8-4452-83fa-680baac566b1","to":"protected-test-ijJH1uERNt1UUzvdc2t0N@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675370158,"env":"test","module":"auth-routes","userId":"0471747a-bcf6-4b9e-af37-d8bf26a2a81b","email":"protected-test-ijJH1uERNt1UUzvdc2t0N@example.com","msg":"User registered"}
{"level":30,"time":1768675370745,"env":"test","module":"auth-routes","userId":"0471747a-bcf6-4b9e-af37-d8bf26a2a81b","msg":"User logged in successfully"}
{"level":30,"time":1768675370789,"env":"test","module":"audit-log-service","userId":"0471747a-bcf6-4b9e-af37-d8bf26a2a81b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675371149,"env":"test","module":"user-credentials-repository","userId":"90642362-a334-4588-b49d-a556d23a4538","msg":"User credentials created"}
{"level":30,"time":1768675371244,"env":"test","module":"email-queue","jobId":"81a59078-06b0-499d-b70d-c5c5a2d0e1bd","to":"user2-TukjYOvMyFNnAkvsCxqA6@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675371290,"env":"test","module":"auth-routes","userId":"90642362-a334-4588-b49d-a556d23a4538","email":"user2-TukjYOvMyFNnAkvsCxqA6@example.com","msg":"User registered"}
{"level":30,"time":1768675371920,"env":"test","module":"auth-routes","userId":"90642362-a334-4588-b49d-a556d23a4538","msg":"User logged in successfully"}
{"level":30,"time":1768675371967,"env":"test","module":"audit-log-service","userId":"90642362-a334-4588-b49d-a556d23a4538","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768675372020,"env":"test","module":"rbac-middleware","userId":"90642362-a334-4588-b49d-a556d23a4538","userRole":"viewer","permission":"project:delete","path":"/ac341251-27ab-4572-a389-77f63cdf51a0","msg":"Permission denied"}
{"level":30,"time":1768675372384,"env":"test","module":"user-credentials-repository","userId":"2abe6c4e-f3a3-4b9c-989d-0d2296ff30e2","msg":"User credentials created"}
{"level":30,"time":1768675372472,"env":"test","module":"email-queue","jobId":"5d71a638-2a66-40ad-8c24-2b3c2377fb96","to":"protected-test-VGDYP-LDJmtVTOhiPv6cB@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675372518,"env":"test","module":"auth-routes","userId":"2abe6c4e-f3a3-4b9c-989d-0d2296ff30e2","email":"protected-test-VGDYP-LDJmtVTOhiPv6cB@example.com","msg":"User registered"}
{"level":30,"time":1768675373113,"env":"test","module":"auth-routes","userId":"2abe6c4e-f3a3-4b9c-989d-0d2296ff30e2","msg":"User logged in successfully"}
{"level":30,"time":1768675373159,"env":"test","module":"audit-log-service","userId":"2abe6c4e-f3a3-4b9c-989d-0d2296ff30e2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675373563,"env":"test","module":"user-credentials-repository","userId":"6fe789a9-963a-4690-a7a4-0ba41c30f28f","msg":"User credentials created"}
{"level":30,"time":1768675373652,"env":"test","module":"email-queue","jobId":"b126b83b-5c20-413c-9bc4-60bd7a6f099a","to":"protected-test-YTUz7S4WsDilUbBnvUzdE@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675373697,"env":"test","module":"auth-routes","userId":"6fe789a9-963a-4690-a7a4-0ba41c30f28f","email":"protected-test-YTUz7S4WsDilUbBnvUzdE@example.com","msg":"User registered"}
{"level":30,"time":1768675374281,"env":"test","module":"auth-routes","userId":"6fe789a9-963a-4690-a7a4-0ba41c30f28f","msg":"User logged in successfully"}
{"level":30,"time":1768675374326,"env":"test","module":"audit-log-service","userId":"6fe789a9-963a-4690-a7a4-0ba41c30f28f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675374722,"env":"test","module":"user-credentials-repository","userId":"7b7a0324-00b4-4f54-82fe-1e5ca190ba5b","msg":"User credentials created"}
{"level":30,"time":1768675374813,"env":"test","module":"email-queue","jobId":"cb188b6c-27d2-4390-b27c-c4848aea02b7","to":"protected-test-PPbwIWTQxedFJCDxmhvLJ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675374859,"env":"test","module":"auth-routes","userId":"7b7a0324-00b4-4f54-82fe-1e5ca190ba5b","email":"protected-test-PPbwIWTQxedFJCDxmhvLJ@example.com","msg":"User registered"}
{"level":30,"time":1768675375432,"env":"test","module":"auth-routes","userId":"7b7a0324-00b4-4f54-82fe-1e5ca190ba5b","msg":"User logged in successfully"}
{"level":30,"time":1768675375479,"env":"test","module":"audit-log-service","userId":"7b7a0324-00b4-4f54-82fe-1e5ca190ba5b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675375879,"env":"test","module":"user-credentials-repository","userId":"ac158905-e429-4986-b981-2eedf79bbed9","msg":"User credentials created"}
{"level":30,"time":1768675376012,"env":"test","module":"email-queue","jobId":"cec83545-c4a8-400c-a6fe-7016f1ba5f43","to":"protected-test-EBvZ4i4R3LqZihk7PS_EB@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675376057,"env":"test","module":"auth-routes","userId":"ac158905-e429-4986-b981-2eedf79bbed9","email":"protected-test-EBvZ4i4R3LqZihk7PS_EB@example.com","msg":"User registered"}
{"level":30,"time":1768675376646,"env":"test","module":"auth-routes","userId":"ac158905-e429-4986-b981-2eedf79bbed9","msg":"User logged in successfully"}
{"level":30,"time":1768675376691,"env":"test","module":"audit-log-service","userId":"ac158905-e429-4986-b981-2eedf79bbed9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675377537,"env":"test","module":"user-credentials-repository","userId":"745b4c9f-0a88-4dc2-a62f-6398f4166645","msg":"User credentials created"}
{"level":30,"time":1768675377652,"env":"test","module":"email-queue","jobId":"1b533514-3194-49e5-b58d-627ed517130e","to":"protected-test-Jm2kU2w7qmGL8BQmIOcTZ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675377709,"env":"test","module":"auth-routes","userId":"745b4c9f-0a88-4dc2-a62f-6398f4166645","email":"protected-test-Jm2kU2w7qmGL8BQmIOcTZ@example.com","msg":"User registered"}
{"level":30,"time":1768675378383,"env":"test","module":"auth-routes","userId":"745b4c9f-0a88-4dc2-a62f-6398f4166645","msg":"User logged in successfully"}
{"level":30,"time":1768675378439,"env":"test","module":"audit-log-service","userId":"745b4c9f-0a88-4dc2-a62f-6398f4166645","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675378992,"env":"test","module":"auth-routes","userId":"745b4c9f-0a88-4dc2-a62f-6398f4166645","msg":"User logged in successfully"}
{"level":30,"time":1768675379048,"env":"test","module":"audit-log-service","userId":"745b4c9f-0a88-4dc2-a62f-6398f4166645","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675379510,"env":"test","module":"user-credentials-repository","userId":"46edba9c-900b-409d-bdff-643d99dffac2","msg":"User credentials created"}
{"level":30,"time":1768675379637,"env":"test","module":"email-queue","jobId":"26ffc960-e625-43a5-bd5b-b54baf885b92","to":"protected-test-2eetrdJE3Wyr5PJtpMBmQ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675379694,"env":"test","module":"auth-routes","userId":"46edba9c-900b-409d-bdff-643d99dffac2","email":"protected-test-2eetrdJE3Wyr5PJtpMBmQ@example.com","msg":"User registered"}
{"level":30,"time":1768675380354,"env":"test","module":"auth-routes","userId":"46edba9c-900b-409d-bdff-643d99dffac2","msg":"User logged in successfully"}
{"level":30,"time":1768675380412,"env":"test","module":"audit-log-service","userId":"46edba9c-900b-409d-bdff-643d99dffac2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675380976,"env":"test","module":"auth-routes","userId":"46edba9c-900b-409d-bdff-643d99dffac2","msg":"User logged in successfully"}
{"level":30,"time":1768675381031,"env":"test","module":"audit-log-service","userId":"46edba9c-900b-409d-bdff-643d99dffac2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675381409,"env":"test","module":"user-credentials-repository","userId":"acabfd90-137d-47db-abad-6b525af6d10f","msg":"User credentials created"}
{"level":30,"time":1768675381518,"env":"test","module":"email-queue","jobId":"4c724173-1bb5-4d94-ba87-0920e95a8c3d","to":"user2-l4Ywu-GTSv_UsulzPZhNT@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675381576,"env":"test","module":"auth-routes","userId":"acabfd90-137d-47db-abad-6b525af6d10f","email":"user2-l4Ywu-GTSv_UsulzPZhNT@example.com","msg":"User registered"}
{"level":30,"time":1768675382136,"env":"test","module":"auth-routes","userId":"acabfd90-137d-47db-abad-6b525af6d10f","msg":"User logged in successfully"}
{"level":30,"time":1768675382196,"env":"test","module":"audit-log-service","userId":"acabfd90-137d-47db-abad-6b525af6d10f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675382711,"env":"test","module":"user-credentials-repository","userId":"aa79af2b-a3a6-4aca-894c-4ff2c034488f","msg":"User credentials created"}
{"level":30,"time":1768675382823,"env":"test","module":"email-queue","jobId":"03fb1e36-a200-442f-9cc2-a9fed50e85aa","to":"protected-test-nptSpwh9qH3Ei9BROTYSb@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675382878,"env":"test","module":"auth-routes","userId":"aa79af2b-a3a6-4aca-894c-4ff2c034488f","email":"protected-test-nptSpwh9qH3Ei9BROTYSb@example.com","msg":"User registered"}
{"level":30,"time":1768675383549,"env":"test","module":"auth-routes","userId":"aa79af2b-a3a6-4aca-894c-4ff2c034488f","msg":"User logged in successfully"}
{"level":30,"time":1768675383608,"env":"test","module":"audit-log-service","userId":"aa79af2b-a3a6-4aca-894c-4ff2c034488f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675384202,"env":"test","module":"intake-service","runId":"45e7c045-f13c-4572-864b-a5a63e591762","slug":"public-amKpxDYa8CRr8o7NGbNou","msg":"Created intake run"}
{"level":30,"time":1768675384656,"env":"test","module":"user-credentials-repository","userId":"d272766b-fc54-4a05-b1ca-f1f6389fb682","msg":"User credentials created"}
{"level":30,"time":1768675384766,"env":"test","module":"email-queue","jobId":"ed47f82f-729e-4ad2-b41c-fd23bcbea3ab","to":"protected-test-PAExpScyctr0rJ1mK4uN9@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675384822,"env":"test","module":"auth-routes","userId":"d272766b-fc54-4a05-b1ca-f1f6389fb682","email":"protected-test-PAExpScyctr0rJ1mK4uN9@example.com","msg":"User registered"}
{"level":30,"time":1768675385510,"env":"test","module":"auth-routes","userId":"d272766b-fc54-4a05-b1ca-f1f6389fb682","msg":"User logged in successfully"}
{"level":30,"time":1768675385567,"env":"test","module":"audit-log-service","userId":"d272766b-fc54-4a05-b1ca-f1f6389fb682","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675386150,"env":"test","module":"intake-service","runId":"c6439b44-03dd-4b42-bbcc-4fcafe4a5822","slug":"optional-MxJzvJ0U-T35A2pFqdMoF","userId":"d272766b-fc54-4a05-b1ca-f1f6389fb682","msg":"Created intake run"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675386678,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768675386679,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ£ô tests/integration/auth/protected.routes.test.ts (33 tests | 1 skipped) 52162ms
       Γ£ô should allow access with valid Bearer token  1204ms
       Γ£ô should reject access without Authorization header  1130ms
       Γ£ô should reject access with empty Bearer token  1140ms
       Γ£ô should reject access with malformed Authorization header  1124ms
       Γ£ô should reject access with wrong token type  1173ms
       Γ£ô should allow POST with valid Bearer token  1183ms
       Γ£ô should reject POST without Bearer token  1136ms
       Γ£ô should reject POST with invalid token  1153ms
       Γ£ô should allow PUT with valid Bearer token  1326ms
       Γ£ô should reject PUT without Bearer token  1153ms
       Γ£ô should allow DELETE with valid Bearer token  1278ms
       Γ£ô should reject DELETE without Bearer token  1138ms
       Γ£ô should allow PATCH with valid Bearer token  1777ms
       Γ£ô should reject PATCH without Bearer token  1174ms
       Γ£ô should handle Bearer token with extra spaces  1127ms
       Γ£ô should handle very long invalid token  1125ms
       Γ£ô should handle empty Authorization header  1140ms
       Γ£ô should handle Authorization header with only Bearer  1141ms
       Γ£ô should handle multiple Authorization headers  1139ms
       Γ£ô should reject token with SQL injection attempt  1159ms
       Γ£ô should reject token with XSS attempt  1135ms
       Γ£ô should reject token with missing userId  1146ms
       Γ£ô should reject token with non-existent userId  1244ms
       Γ£ô should not allow user to access another user's resources  2342ms
       Γ£ô should inject userId into request context  1187ms
       Γ£ô should inject tenantId into request context  1166ms
       Γ£ô should inject role into request context  1158ms
       Γ£ô should not apply general rate limiting to authenticated requests  1607ms
       Γ£ô should handle request with both Bearer token and cookies  1969ms
       Γ£ô should prioritize Bearer token over cookie when both present  3205ms
       Γ£ô should allow unauthenticated access to optional auth routes  1951ms
       Γ£ô should enhance optional auth routes with user context when authenticated  2004ms

 Test Files  1 passed (1)
      Tests  32 passed | 1 skipped (33)
   Start at  12:40:53
   Duration  129.24s

 PASS  Waiting for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/routes/auth.routes.ts x4 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768675488305,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768675493627,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768675493679,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768675495366,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768675495381,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768675495373,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768675495373,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768675495377,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768675495377,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768675495381,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768675495381,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768675495381,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768675495381,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768675495863,"env":"test","module":"user-credentials-repository","userId":"91ed944c-581c-46a2-8606-d3fab6d27817","msg":"User credentials created"}
{"level":30,"time":1768675495976,"env":"test","module":"email-queue","jobId":"ffa54d84-402e-46f0-8925-6ec68ef63efe","to":"test-RjWexO4YkcgkH0mTLhLYM@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675496049,"env":"test","module":"auth-routes","userId":"91ed944c-581c-46a2-8606-d3fab6d27817","email":"test-RjWexO4YkcgkH0mTLhLYM@example.com","msg":"User registered"}
{"level":30,"time":1768675496787,"env":"test","module":"user-credentials-repository","userId":"1da6d1a7-a196-4c04-8bb5-c71ea7dab7ef","msg":"User credentials created"}
{"level":30,"time":1768675496900,"env":"test","module":"email-queue","jobId":"0a224a8e-35c6-4a91-8d4c-9e32741c81e1","to":"protected-test-KPxVVmbCmfD3y21hUAOHR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675496955,"env":"test","module":"auth-routes","userId":"1da6d1a7-a196-4c04-8bb5-c71ea7dab7ef","email":"protected-test-KPxVVmbCmfD3y21hUAOHR@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768675497687,"env":"test","module":"auth-routes","userId":"1da6d1a7-a196-4c04-8bb5-c71ea7dab7ef","msg":"User logged in successfully"}
{"level":30,"time":1768675497745,"env":"test","module":"audit-log-service","userId":"1da6d1a7-a196-4c04-8bb5-c71ea7dab7ef","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768675498232,"env":"test","module":"user-credentials-repository","userId":"71c1081f-e31c-4f2f-8c72-21898fe89ae1","msg":"User credentials created"}
{"level":30,"time":1768675498359,"env":"test","module":"email-queue","jobId":"2a2103f2-d46f-4a6d-8c8b-6f73ab2ab25e","to":"protected-test-Vbfhx3bJf-eEmNsFVYJB8@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768675498425,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["71c1081f-e31c-4f2f-8c72-21898fe89ae1","6be70564b22fd384e9a0418d545df0ba794a85332db42fd411a64be70bcf644f","2026-02-16T18:44:58.360Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T18:44:58.360Z"],"cause":{"length":327,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(71c1081f-e31c-4f2f-8c72-21898fe89ae1) is not present in table \"users\".","schema":"public","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675499192,"env":"test","module":"user-credentials-repository","userId":"261d0bb7-60b7-4f91-8031-0fce16750430","msg":"User credentials created"}
{"level":30,"time":1768675499306,"env":"test","module":"email-queue","jobId":"efbf0ade-42f9-46b2-8f73-8bb0a002a382","to":"protected-test-ZPycCvBzoeVP6dnqcyb6j@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675499363,"env":"test","module":"auth-routes","userId":"261d0bb7-60b7-4f91-8031-0fce16750430","email":"protected-test-ZPycCvBzoeVP6dnqcyb6j@example.com","msg":"User registered"}
{"level":30,"time":1768675500212,"env":"test","module":"user-credentials-repository","userId":"36ed2b55-ef5a-488c-9376-efd98c806cbb","msg":"User credentials created"}
{"level":30,"time":1768675500334,"env":"test","module":"email-queue","jobId":"d19792ab-5e4c-4c86-92f1-0c1b0c73ee44","to":"protected-test-QHs_U-qCDX7BpVnk_1ZcD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675500392,"env":"test","module":"auth-routes","userId":"36ed2b55-ef5a-488c-9376-efd98c806cbb","email":"protected-test-QHs_U-qCDX7BpVnk_1ZcD@example.com","msg":"User registered"}
{"level":30,"time":1768675501095,"env":"test","module":"user-credentials-repository","userId":"46786a5f-3662-40e2-8c7d-cebfbba0dc3b","msg":"User credentials created"}
{"level":30,"time":1768675501189,"env":"test","module":"email-queue","jobId":"5a85e93c-888a-4d21-80d1-51f3db261895","to":"protected-test-jBkZltD9a0zcfgtbdPyuw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675501237,"env":"test","module":"auth-routes","userId":"46786a5f-3662-40e2-8c7d-cebfbba0dc3b","email":"protected-test-jBkZltD9a0zcfgtbdPyuw@example.com","msg":"User registered"}
{"level":30,"time":1768675501946,"env":"test","module":"user-credentials-repository","userId":"5bb2c4dd-99b4-4c67-90cd-5e8d265da600","msg":"User credentials created"}
{"level":30,"time":1768675502041,"env":"test","module":"email-queue","jobId":"0d310227-66f9-4458-b96b-3b7c1b49b766","to":"protected-test-owqglXN9xfMQdVE3L9Awx@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675502091,"env":"test","module":"auth-routes","userId":"5bb2c4dd-99b4-4c67-90cd-5e8d265da600","email":"protected-test-owqglXN9xfMQdVE3L9Awx@example.com","msg":"User registered"}
{"level":30,"time":1768675502786,"env":"test","module":"user-credentials-repository","userId":"fd317cf9-3988-4cf3-ac69-6f22b1f54f00","msg":"User credentials created"}
{"level":30,"time":1768675502884,"env":"test","module":"email-queue","jobId":"ff017cc5-ee0a-4e60-b413-3f0f532418e4","to":"protected-test-eAPB31NjflDGRHY2oQyfL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675502933,"env":"test","module":"auth-routes","userId":"fd317cf9-3988-4cf3-ac69-6f22b1f54f00","email":"protected-test-eAPB31NjflDGRHY2oQyfL@example.com","msg":"User registered"}
{"level":30,"time":1768675503623,"env":"test","module":"user-credentials-repository","userId":"87e8cb97-c686-4a7f-b6d9-4ebd07a46f08","msg":"User credentials created"}
{"level":30,"time":1768675503729,"env":"test","module":"email-queue","jobId":"b201cd08-b099-452d-a5a5-528f32e6ba99","to":"protected-test-DU8FuLhL2qegqIcDKRdiY@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675503793,"env":"test","module":"auth-routes","userId":"87e8cb97-c686-4a7f-b6d9-4ebd07a46f08","email":"protected-test-DU8FuLhL2qegqIcDKRdiY@example.com","msg":"User registered"}
{"level":30,"time":1768675504501,"env":"test","module":"user-credentials-repository","userId":"f6df6116-c7d1-4e96-9a18-f873485e4ad5","msg":"User credentials created"}
{"level":30,"time":1768675504595,"env":"test","module":"email-queue","jobId":"04537a25-256a-4d18-be7b-a6ca026f25e6","to":"protected-test-kGpbo3fN0vVBsiwbPipWH@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675504641,"env":"test","module":"auth-routes","userId":"f6df6116-c7d1-4e96-9a18-f873485e4ad5","email":"protected-test-kGpbo3fN0vVBsiwbPipWH@example.com","msg":"User registered"}
{"level":30,"time":1768675505344,"env":"test","module":"user-credentials-repository","userId":"187bdf22-2182-40cd-9449-3f56bfe0018f","msg":"User credentials created"}
{"level":30,"time":1768675505438,"env":"test","module":"email-queue","jobId":"eff48439-eed6-4fe3-83c8-45029ab08184","to":"protected-test-Ww9PBFUOdManQeuvgmeuO@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675505489,"env":"test","module":"auth-routes","userId":"187bdf22-2182-40cd-9449-3f56bfe0018f","email":"protected-test-Ww9PBFUOdManQeuvgmeuO@example.com","msg":"User registered"}
{"level":30,"time":1768675506287,"env":"test","module":"user-credentials-repository","userId":"f3b92a6d-5d29-4be6-a61c-6124bd2291a8","msg":"User credentials created"}
{"level":30,"time":1768675506404,"env":"test","module":"email-queue","jobId":"d079bb0e-4502-4a80-8da2-9775c54d71c7","to":"protected-test-q5C4tOfSatjZheV3stnx7@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675506465,"env":"test","module":"auth-routes","userId":"f3b92a6d-5d29-4be6-a61c-6124bd2291a8","email":"protected-test-q5C4tOfSatjZheV3stnx7@example.com","msg":"User registered"}
{"level":30,"time":1768675507170,"env":"test","module":"user-credentials-repository","userId":"654ad6a7-c4c0-4ade-9645-e8b7ae778737","msg":"User credentials created"}
{"level":30,"time":1768675507265,"env":"test","module":"email-queue","jobId":"a322d105-5aaf-4455-9dc7-96b1fbcfa7b2","to":"protected-test-ZkRhxn36gs_vGzK4jJ-SW@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675507314,"env":"test","module":"auth-routes","userId":"654ad6a7-c4c0-4ade-9645-e8b7ae778737","email":"protected-test-ZkRhxn36gs_vGzK4jJ-SW@example.com","msg":"User registered"}
{"level":50,"time":1768675508112,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["5dfb690d-fbd9-48ad-8404-fa3550b4219e","$2b$12$A77FzFzX7EN8N2GiIMsUuebCVA089Jjbh5inNJ8xBVm285dxgAR32"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5dfb690d-fbd9-48ad-8404-fa3550b4219e) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"5dfb690d-fbd9-48ad-8404-fa3550b4219e","msg":"Failed to create user credentials"}
{"level":50,"time":1768675508112,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["5dfb690d-fbd9-48ad-8404-fa3550b4219e","$2b$12$A77FzFzX7EN8N2GiIMsUuebCVA089Jjbh5inNJ8xBVm285dxgAR32"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5dfb690d-fbd9-48ad-8404-fa3550b4219e) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675508872,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["f4689e72-3b77-41d7-91de-6f6f6ce3dde3","$2b$12$fjYJ.TbVxShKZzuS0lrTG.Of0JQbMhwLMECgtnll36BomKDx2ofGO"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f4689e72-3b77-41d7-91de-6f6f6ce3dde3) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"f4689e72-3b77-41d7-91de-6f6f6ce3dde3","msg":"Failed to create user credentials"}
{"level":50,"time":1768675508872,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["f4689e72-3b77-41d7-91de-6f6f6ce3dde3","$2b$12$fjYJ.TbVxShKZzuS0lrTG.Of0JQbMhwLMECgtnll36BomKDx2ofGO"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f4689e72-3b77-41d7-91de-6f6f6ce3dde3) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675509623,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["ff3f988b-5345-4499-a63e-a5e1858900b7","$2b$12$lVyxotrlgT7snYNj3/UTUumtq5uCkzgBOs.csNp1VNKHa8lC2HEIS"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(ff3f988b-5345-4499-a63e-a5e1858900b7) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"ff3f988b-5345-4499-a63e-a5e1858900b7","msg":"Failed to create user credentials"}
{"level":50,"time":1768675509623,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["ff3f988b-5345-4499-a63e-a5e1858900b7","$2b$12$lVyxotrlgT7snYNj3/UTUumtq5uCkzgBOs.csNp1VNKHa8lC2HEIS"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(ff3f988b-5345-4499-a63e-a5e1858900b7) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675510354,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["e6208cb5-315c-4a25-bff4-64178ef5d142","$2b$12$WH7jnJakxgbuR2za8CsH3OKjNtXJ3RiAwM.voAC0eTUxaE6GfRgAu"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(e6208cb5-315c-4a25-bff4-64178ef5d142) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"e6208cb5-315c-4a25-bff4-64178ef5d142","msg":"Failed to create user credentials"}
{"level":50,"time":1768675510354,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["e6208cb5-315c-4a25-bff4-64178ef5d142","$2b$12$WH7jnJakxgbuR2za8CsH3OKjNtXJ3RiAwM.voAC0eTUxaE6GfRgAu"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(e6208cb5-315c-4a25-bff4-64178ef5d142) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675511151,"env":"test","module":"user-credentials-repository","userId":"16d04833-a614-431a-beea-505f118a2931","msg":"User credentials created"}
{"level":30,"time":1768675511272,"env":"test","module":"email-queue","jobId":"10256b93-90ba-49d5-9327-34cb6f69f214","to":"protected-test-D1M8lDxGo0INruv04b4A3@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768675511332,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["16d04833-a614-431a-beea-505f118a2931","7da78936089d5b3a81bafec373678f034277c4151cb3cee84472890ca8c3d9b4","2026-02-16T18:45:11.272Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T18:45:11.272Z"],"cause":{"length":338,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(16d04833-a614-431a-beea-505f118a2931) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675512127,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["524b3f9d-96c9-4bb7-8807-3e6a4b907542","$2b$12$fHbThia4YV4XWYVKUjFwSeeNVAtPS5HrmYXUFamRgpgpB4u485IBK"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(524b3f9d-96c9-4bb7-8807-3e6a4b907542) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"524b3f9d-96c9-4bb7-8807-3e6a4b907542","msg":"Failed to create user credentials"}
{"level":50,"time":1768675512127,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["524b3f9d-96c9-4bb7-8807-3e6a4b907542","$2b$12$fHbThia4YV4XWYVKUjFwSeeNVAtPS5HrmYXUFamRgpgpB4u485IBK"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(524b3f9d-96c9-4bb7-8807-3e6a4b907542) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675512911,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["bb43cf9f-4840-4a43-8ff7-51c193b3e265","$2b$12$9FR3EJ5ENj6t1/ah.AZIyus6yuqCyrwk8EgNhjjZ3kmF8XPq23FwO"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(bb43cf9f-4840-4a43-8ff7-51c193b3e265) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"bb43cf9f-4840-4a43-8ff7-51c193b3e265","msg":"Failed to create user credentials"}
{"level":50,"time":1768675512911,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["bb43cf9f-4840-4a43-8ff7-51c193b3e265","$2b$12$9FR3EJ5ENj6t1/ah.AZIyus6yuqCyrwk8EgNhjjZ3kmF8XPq23FwO"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(bb43cf9f-4840-4a43-8ff7-51c193b3e265) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675513594,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["2bfc182a-0deb-4319-9550-50484c42b8a4","$2b$12$QwIw2rpR9GX/UUxGumqhbe/l0Kgvxs3mc7YsSVKC.32nYg/Svk5C2"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(2bfc182a-0deb-4319-9550-50484c42b8a4) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"2bfc182a-0deb-4319-9550-50484c42b8a4","msg":"Failed to create user credentials"}
{"level":50,"time":1768675513594,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["2bfc182a-0deb-4319-9550-50484c42b8a4","$2b$12$QwIw2rpR9GX/UUxGumqhbe/l0Kgvxs3mc7YsSVKC.32nYg/Svk5C2"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(2bfc182a-0deb-4319-9550-50484c42b8a4) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675514259,"env":"test","module":"user-credentials-repository","userId":"7931a5e3-3d73-457c-9096-3f10a17531d4","msg":"User credentials created"}
{"level":30,"time":1768675514356,"env":"test","module":"email-queue","jobId":"76e98681-a486-4ab2-a576-845abb37edbd","to":"protected-test-HNAZTJ8LiSFvOn9lb3Zvu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675514398,"env":"test","module":"auth-routes","userId":"7931a5e3-3d73-457c-9096-3f10a17531d4","email":"protected-test-HNAZTJ8LiSFvOn9lb3Zvu@example.com","msg":"User registered"}
{"level":30,"time":1768675515191,"env":"test","module":"user-credentials-repository","userId":"cc65a314-686c-45d1-8471-c21fe461e3b7","msg":"User credentials created"}
{"level":30,"time":1768675515309,"env":"test","module":"email-queue","jobId":"ab74f688-5869-4dae-b664-8fa4d0ac5ddc","to":"protected-test-ZWjc6rAkFIrMAr9uPl23H@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675515368,"env":"test","module":"auth-routes","userId":"cc65a314-686c-45d1-8471-c21fe461e3b7","email":"protected-test-ZWjc6rAkFIrMAr9uPl23H@example.com","msg":"User registered"}
{"level":50,"time":1768675516065,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["ac9d164e-5fa4-482b-a421-01ffe8cfbd56","$2b$12$hNT1zct8G9rsdG6YRaHXP.a55dY4TDraJrihpXboh.obvIXFrYcpy"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(ac9d164e-5fa4-482b-a421-01ffe8cfbd56) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"ac9d164e-5fa4-482b-a421-01ffe8cfbd56","msg":"Failed to create user credentials"}
{"level":50,"time":1768675516065,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["ac9d164e-5fa4-482b-a421-01ffe8cfbd56","$2b$12$hNT1zct8G9rsdG6YRaHXP.a55dY4TDraJrihpXboh.obvIXFrYcpy"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(ac9d164e-5fa4-482b-a421-01ffe8cfbd56) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675516713,"env":"test","module":"user-credentials-repository","userId":"c2e3baf6-bde3-40ba-b3ac-0051e64e5fe3","msg":"User credentials created"}
{"level":30,"time":1768675516806,"env":"test","module":"email-queue","jobId":"e2e56063-ba9a-4a3b-99b0-3f91cda25a03","to":"protected-test-EU45EbEHroDEnXH6fCVOO@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675516850,"env":"test","module":"auth-routes","userId":"c2e3baf6-bde3-40ba-b3ac-0051e64e5fe3","email":"protected-test-EU45EbEHroDEnXH6fCVOO@example.com","msg":"User registered"}
{"level":30,"time":1768675517550,"env":"test","module":"user-credentials-repository","userId":"75355564-2520-45bf-863e-f4a1d8f1081c","msg":"User credentials created"}
{"level":30,"time":1768675517643,"env":"test","module":"email-queue","jobId":"94dc7050-4080-4b51-a403-c1cafd7c69ff","to":"protected-test-QIjDRdNuSCWRGeopejC14@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768675517691,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["75355564-2520-45bf-863e-f4a1d8f1081c","8541f63a06560c5b7618f5254d5d5620d7e26185ac9e8e1b4472fd555101f5c1","2026-02-16T18:45:17.644Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T18:45:17.644Z"],"cause":{"length":338,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(75355564-2520-45bf-863e-f4a1d8f1081c) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675518323,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["24d5edc1-c8a9-425d-989f-f239eded5f3d","$2b$12$w3WJCltqZs4Cxt3xBBNfXeSnfAzDjxADMKkPgQ8IauO1I/KgkQQDK"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(24d5edc1-c8a9-425d-989f-f239eded5f3d) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"24d5edc1-c8a9-425d-989f-f239eded5f3d","msg":"Failed to create user credentials"}
{"level":50,"time":1768675518323,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["24d5edc1-c8a9-425d-989f-f239eded5f3d","$2b$12$w3WJCltqZs4Cxt3xBBNfXeSnfAzDjxADMKkPgQ8IauO1I/KgkQQDK"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(24d5edc1-c8a9-425d-989f-f239eded5f3d) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675519067,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["0bd51b4a-c22b-4536-aa97-cf613de137f7","$2b$12$t3l9r4ADnNSaplfzHR4TDeU8kBdvYiSTfK5ZkGuVxiRWAusawTWkW"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(0bd51b4a-c22b-4536-aa97-cf613de137f7) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"0bd51b4a-c22b-4536-aa97-cf613de137f7","msg":"Failed to create user credentials"}
{"level":50,"time":1768675519067,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["0bd51b4a-c22b-4536-aa97-cf613de137f7","$2b$12$t3l9r4ADnNSaplfzHR4TDeU8kBdvYiSTfK5ZkGuVxiRWAusawTWkW"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(0bd51b4a-c22b-4536-aa97-cf613de137f7) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675519728,"env":"test","module":"user-credentials-repository","userId":"034573ba-c48a-4ef4-9752-8b39bf54f994","msg":"User credentials created"}
{"level":30,"time":1768675519826,"env":"test","module":"email-queue","jobId":"668bd07e-de36-49e0-bfa8-88090d48a2a1","to":"protected-test-pO1R9VRUbMUJ9ug-lQISc@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675519875,"env":"test","module":"auth-routes","userId":"034573ba-c48a-4ef4-9752-8b39bf54f994","email":"protected-test-pO1R9VRUbMUJ9ug-lQISc@example.com","msg":"User registered"}
{"level":50,"time":1768675520582,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8109fe01-8bb4-497c-8463-e2993db94b24","$2b$12$oyR4ElzpfQYgqJO3uT4kieaUW.o.O0ON2swT8ZaadrEzd9tBunl0S"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8109fe01-8bb4-497c-8463-e2993db94b24) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"8109fe01-8bb4-497c-8463-e2993db94b24","msg":"Failed to create user credentials"}
{"level":50,"time":1768675520582,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8109fe01-8bb4-497c-8463-e2993db94b24","$2b$12$oyR4ElzpfQYgqJO3uT4kieaUW.o.O0ON2swT8ZaadrEzd9tBunl0S"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8109fe01-8bb4-497c-8463-e2993db94b24) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675521222,"env":"test","module":"user-credentials-repository","userId":"db55d5d5-6286-450a-8e9d-ce50e1fdd9cb","msg":"User credentials created"}
{"level":30,"time":1768675521319,"env":"test","module":"email-queue","jobId":"0e75a1e5-02e3-4fa7-98db-eb3854669772","to":"protected-test-U7lozvulEtWKcecEN9Ivk@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768675521364,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["db55d5d5-6286-450a-8e9d-ce50e1fdd9cb","08c7829eef0d0006670b368c7642a7a010d6dad19bc74acf494f51adf64cccc7","2026-02-16T18:45:21.319Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T18:45:21.319Z"],"cause":{"length":338,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(db55d5d5-6286-450a-8e9d-ce50e1fdd9cb) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768675522050,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["d42ba1cf-3d69-4cb9-8889-1ba4b6a2d337","$2b$12$cGLcDQciJccRr66WHKW6uunMtqnX1jkZIFzP0tt7JRkAqyhABZy.O"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(d42ba1cf-3d69-4cb9-8889-1ba4b6a2d337) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"d42ba1cf-3d69-4cb9-8889-1ba4b6a2d337","msg":"Failed to create user credentials"}
{"level":50,"time":1768675522050,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["d42ba1cf-3d69-4cb9-8889-1ba4b6a2d337","$2b$12$cGLcDQciJccRr66WHKW6uunMtqnX1jkZIFzP0tt7JRkAqyhABZy.O"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(d42ba1cf-3d69-4cb9-8889-1ba4b6a2d337) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768675522812,"env":"test","module":"user-credentials-repository","userId":"cc344396-6077-47aa-a9df-cdbfcd3a2ccd","msg":"User credentials created"}
{"level":30,"time":1768675522929,"env":"test","module":"email-queue","jobId":"3106cee8-b50d-4951-87dd-5a9f1fbfbc35","to":"protected-test-HgEBqxC3DJz6RZ5kYgqyC@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768675522985,"env":"test","module":"auth-routes","userId":"cc344396-6077-47aa-a9df-cdbfcd3a2ccd","email":"protected-test-HgEBqxC3DJz6RZ5kYgqyC@example.com","msg":"User registered"}
{"level":30,"time":1768675523421,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768675523422,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 31 failed | 1 skipped) 30795ms
       Γ£ô should allow access with valid Bearer token  1447ms
       ├ù should reject access without Authorization header 620ms
       ├ù should reject access with empty Bearer token 999ms
       ├ù should reject access with malformed Authorization header 1025ms
       ├ù should reject access with wrong token type 837ms
       ├ù should allow POST with valid Bearer token 847ms
       ├ù should reject POST without Bearer token 846ms
       ├ù should reject POST with invalid token 860ms
       ├ù should allow PUT with valid Bearer token 847ms
       ├ù should reject PUT without Bearer token 845ms
       ├ù should allow DELETE with valid Bearer token 989ms
       ├ù should reject DELETE without Bearer token 836ms
       ├ù should allow PATCH with valid Bearer token 753ms
       ├ù should reject PATCH without Bearer token 759ms
       ├ù should handle Bearer token with extra spaces 751ms
       Γåô should handle token with newlines
       ├ù should handle very long invalid token 731ms
       ├ù should handle empty Authorization header 978ms
       ├ù should handle Authorization header with only Bearer 797ms
       ├ù should handle multiple Authorization headers 785ms
       ├ù should reject token with SQL injection attempt 681ms
       ├ù should reject token with XSS attempt 847ms
       ├ù should reject token with missing userId 982ms
       ├ù should reject token with non-existent userId 642ms
       ├ù should not allow user to access another user's resources 831ms
       ├ù should inject userId into request context 796ms
       ├ù should inject tenantId into request context 630ms
       ├ù should inject role into request context 745ms
       ├ù should not apply general rate limiting to authenticated requests 855ms
       ├ù should handle request with both Bearer token and cookies 660ms
       ├ù should prioritize Bearer token over cookie when both present 781ms
       ├ù should allow unauthenticated access to optional auth routes 687ms
       ├ù should enhance optional auth routes with user context when authenticated 991ms

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Tests 31 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
Error: expected 201 "Created", got 500 "Internal Server Error"
 Γ¥» tests/integration/auth/protected.routes.test.ts:56:14
     54|             .post("/api/auth/register")
     55|             .send(testUser)
     56|             .expect(201);
       |              ^
     57| 
     58|         const userId = registerRes.body.user.id;
 Γ¥» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Γ¥» node_modules/supertest/lib/test.js:365:13
 Γ¥» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Γ¥» Test.assert node_modules/supertest/lib/test.js:195:23
 Γ¥» localAssert node_modules/supertest/lib/test.js:138:14
 Γ¥» node_modules/supertest/lib/test.js:156:7
 Γ¥» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Γ¥» node_modules/superagent/lib/node/index.js:1102:18
 Γ¥» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: d4258575-0ec9-48f9-8025-ccba7e4515c9,owner,true,261d0bb7-60b7-4f91-8031-0fce16750430
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(d4258575-0ec9-48f9-8025-ccba7e4515c9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: d4258575-0ec9-48f9-8025-ccba7e4515c9,owner,true,36ed2b55-ef5a-488c-9376-efd98c806cbb
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(d4258575-0ec9-48f9-8025-ccba7e4515c9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[3/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: d4258575-0ec9-48f9-8025-ccba7e4515c9,owner,true,46786a5f-3662-40e2-8c7d-cebfbba0dc3b
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(d4258575-0ec9-48f9-8025-ccba7e4515c9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[4/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: d4258575-0ec9-48f9-8025-ccba7e4515c9,owner,true,5bb2c4dd-99b4-4c67-90cd-5e8d265da600
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(d4258575-0ec9-48f9-8025-ccba7e4515c9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[5/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: d4258575-0ec9-48f9-8025-ccba7e4515c9,owner,true,fd317cf9-3988-4cf3-ac69-6f22b1f54f00
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(d4258575-0ec9-48f9-8025-ccba7e4515c9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[6/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: d4258575-0ec9-48f9-8025-ccba7e4515c9,owner,true,87e8cb97-c686-4a7f-b6d9-4ebd07a46f08
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(d4258575-0ec9-48f9-8025-ccba7e4515c9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[7/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: d4258575-0ec9-48f9-8025-ccba7e4515c9,owner,true,f6df6116-c7d1-4e96-9a18-f873485e4ad5
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(d4258575-0ec9-48f9-8025-ccba7e4515c9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[8/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: d4258575-0ec9-48f9-8025-ccba7e4515c9,owner,true,187bdf22-2182-40cd-9449-3f56bfe0018f
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(d4258575-0ec9-48f9-8025-ccba7e4515c9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[9/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: d4258575-0ec9-48f9-8025-ccba7e4515c9,owner,true,f3b92a6d-5d29-4be6-a61c-6124bd2291a8
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(d4258575-0ec9-48f9-8025-ccba7e4515c9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[10/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: d4258575-0ec9-48f9-8025-ccba7e4515c9,owner,true,654ad6a7-c4c0-4ade-9645-e8b7ae778737
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(d4258575-0ec9-48f9-8025-ccba7e4515c9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[11/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: d4258575-0ec9-48f9-8025-ccba7e4515c9,owner,true,7931a5e3-3d73-457c-9096-3f10a17531d4
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(d4258575-0ec9-48f9-8025-ccba7e4515c9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[12/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: d4258575-0ec9-48f9-8025-ccba7e4515c9,owner,true,cc65a314-686c-45d1-8471-c21fe461e3b7
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(d4258575-0ec9-48f9-8025-ccba7e4515c9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[13/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: d4258575-0ec9-48f9-8025-ccba7e4515c9,owner,true,c2e3baf6-bde3-40ba-b3ac-0051e64e5fe3
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(d4258575-0ec9-48f9-8025-ccba7e4515c9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[14/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: d4258575-0ec9-48f9-8025-ccba7e4515c9,owner,true,034573ba-c48a-4ef4-9752-8b39bf54f994
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(d4258575-0ec9-48f9-8025-ccba7e4515c9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[15/31]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: d4258575-0ec9-48f9-8025-ccba7e4515c9,owner,true,cc344396-6077-47aa-a9df-cdbfcd3a2ccd
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9
     58|         const userId = registerRes.body.user.id;
     59| 
     60|         await db.update(users)
       |         ^
     61|             .set({
     62|                 emailVerified: true,

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 303, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(d4258575-0ec9-48f9-8025-ccba7e4515c9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[16/31]ΓÄ»


 Test Files  1 failed (1)
      Tests  31 failed | 1 passed | 1 skipped (33)
   Start at  12:44:04
   Duration  73.96s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x5 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöä add secrets lifecycle management: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768678738835,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768678746778,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768678746825,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: []

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768678748694,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768678748708,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768678748700,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768678748701,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768678748704,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768678748705,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768678748707,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768678748707,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768678748707,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768678748707,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768678749243,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["88ee9cfa-2436-4e82-8407-b86b823b2e62","$2b$12$T5lp/.NV0w6na73UIJOlb.GKfRj0uQRonSogElLnWLFJWtxfBzihG"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(88ee9cfa-2436-4e82-8407-b86b823b2e62) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"88ee9cfa-2436-4e82-8407-b86b823b2e62","msg":"Failed to create user credentials"}
{"level":50,"time":1768678749243,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["88ee9cfa-2436-4e82-8407-b86b823b2e62","$2b$12$T5lp/.NV0w6na73UIJOlb.GKfRj0uQRonSogElLnWLFJWtxfBzihG"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(88ee9cfa-2436-4e82-8407-b86b823b2e62) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

{"level":30,"time":1768678749253,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768678749254,"env":"test","msg":"DB: pool closed."}
 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 3279ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:38:49
   Duration  17.42s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x6 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768678769355,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768678777422,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768678777464,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:188:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:188:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768678777777,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768678777792,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768678777785,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768678777785,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768678777788,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768678777788,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768678777792,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768678777792,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768678777792,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768678777792,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant gLE-g_4q_RGHJ1mbrnWgx,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant gLE-g_4q_RGHJ1mbrnWgx', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768678778170,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1765ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated
{"level":30,"time":1768678778170,"env":"test","msg":"DB: pool closed."}

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant gLE-g_4q_RGHJ1mbrnWgx,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:39:17
   Duration  17.71s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x7 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768678786706,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

{"level":30,"time":1768678800194,"env":"test","msg":"DB: initializing... Local"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768678805709,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768678806093,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768678806110,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768678806100,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768678806101,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768678806104,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768678806105,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768678806110,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768678806110,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768678806110,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768678806110,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768678806414,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768678806414,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:191:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:191:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant Vy63DtjMIDq_QB5v4YZJm,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant Vy63DtjMIDq_QB5v4YZJm', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 7281ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant Vy63DtjMIDq_QB5v4YZJm,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:39:38
   Duration  27.72s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x8 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöæ add access controls to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768679038396,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

{"level":30,"time":1768679048860,"env":"test","msg":"DB: initializing... Local"}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768679053944,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

{"level":30,"time":1768679055536,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768679055564,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768679055546,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768679055547,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768679055554,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768679055560,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768679055564,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768679055564,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768679055564,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768679055564,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768679056079,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["6ebd7ccc-f8fa-430d-88c8-ed4ec5a44c23","$2b$12$Wt7E80Tkquti7bd4d.jvP.SB6jHsen5OarK5sN9ongmojUtiAZT9q"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(6ebd7ccc-f8fa-430d-88c8-ed4ec5a44c23) is not present in table \"users\".","schema":"test_schema_w8_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"6ebd7ccc-f8fa-430d-88c8-ed4ec5a44c23","msg":"Failed to create user credentials"}
{"level":50,"time":1768679056079,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["6ebd7ccc-f8fa-430d-88c8-ed4ec5a44c23","$2b$12$Wt7E80Tkquti7bd4d.jvP.SB6jHsen5OarK5sN9ongmojUtiAZT9q"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(6ebd7ccc-f8fa-430d-88c8-ed4ec5a44c23) is not present in table \"users\".","schema":"test_schema_w8_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768679056093,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768679056093,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w8_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w13_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w13_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 8167ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:43:48
   Duration  27.03s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x9 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöæ add access controls to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöæ add access controls to secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768679219112,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768679223995,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768679224467,"env":"test","msg":"DB: Set search_path on initial connection: \"test_schema_w0_v3\",public"}
{"level":30,"time":1768679224467,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public"}
{"level":30,"time":1768679227317,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768679228780,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768679228799,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768679228788,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768679228788,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768679228792,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768679228793,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768679228797,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768679228797,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768679228798,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768679228799,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768679229459,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["c7e0627c-62ba-4a0e-bb51-b2c3f4bf1171","$2b$12$gKWGMY9VCgfOHcSf/dZcKO3wXawqheuQqJvvKALQgt.vysREaL84m"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c7e0627c-62ba-4a0e-bb51-b2c3f4bf1171) is not present in table \"users\".","schema":"test_schema_w154_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"c7e0627c-62ba-4a0e-bb51-b2c3f4bf1171","msg":"Failed to create user credentials"}
{"level":50,"time":1768679229460,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["c7e0627c-62ba-4a0e-bb51-b2c3f4bf1171","$2b$12$gKWGMY9VCgfOHcSf/dZcKO3wXawqheuQqJvvKALQgt.vysREaL84m"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c7e0627c-62ba-4a0e-bb51-b2c3f4bf1171) is not present in table \"users\".","schema":"test_schema_w154_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768679229471,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768679229471,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w0_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w0_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 6544ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:114:13
    112| 
    113|     if (registerResponse.status !== 201) {
    114|       throw new Error(`User registration failed: ${JSON.stringify(regiΓÇª
       |             ^
    115|     }
    116| 
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:46:49
   Duration  19.53s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x10 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöä add secrets lifecycle management: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768679344584,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

{"level":30,"time":1768679431710,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768679431710,"env":"test","msg":"DB: Using test schema \"test_schema_w0_v3\" (from connection string options)"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768679442937,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768679444536,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768679444557,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768679444545,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768679444546,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768679444551,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768679444552,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768679444557,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768679444557,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768679444557,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768679444557,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768679445046,"env":"test","module":"user-credentials-repository","userId":"2ca8a5cd-db4c-4258-9069-d35ed1a04382","msg":"User credentials created"}
{"level":30,"time":1768679445146,"env":"test","module":"email-queue","jobId":"52aa3d70-85a9-4e3e-b07c-f6dade6319c5","to":"test-dRqkmsgTETnzfasKf7tOq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768679445197,"env":"test","module":"auth-routes","userId":"2ca8a5cd-db4c-4258-9069-d35ed1a04382","email":"test-dRqkmsgTETnzfasKf7tOq@example.com","msg":"User registered"}
{"level":30,"time":1768679445355,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768679445355,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, default, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"
params: Protected Routes Test Tenant Org,38c746dd-c474-408f-9673-73d45e587715
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:130:19)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, default, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"',
  params: [
    'Protected Routes Test Tenant Org',
    '38c746dd-c474-408f-9673-73d45e587715'
  ],
  cause: error: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:130:19)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 347,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (tenant_id)=(38c746dd-c474-408f-9673-73d45e587715) is not present in table "tenants".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w42_v3',
    table: 'organizations',
    column: undefined,
    dataType: undefined,
    constraint: 'organizations_tenant_id_tenants_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 14514ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, default, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"
params: Protected Routes Test Tenant Org,38c746dd-c474-408f-9673-73d45e587715
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:130:19
    128| 
    129|     // Create organization for ACL testing
    130|     const [org] = await db.insert(schema.organizations).values({
       |                   ^
    131|       name: `${tenantName} Org`,
    132|       tenantId: tenantId,
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:130:19
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 347, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(38c746dd-c474-408f-9673-73d45e587715) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w42_v3', table: 'organizations', dataType: undefined, constraint: 'organizations_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:47:44
   Duration  166.71s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x11 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768679566639,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0_v3,public

{"level":30,"time":1768679589242,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768679589243,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w0_v3\",public on all connections"}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0_v3%2Cpublic

{"level":30,"time":1768679589391,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768679888309,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 600014ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
Error: Hook timed out in 300000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Γ¥» tests/setup.ts:114:1
    112| 
    113| // Global test hooks
    114| beforeAll(async () => {
       | ^
    115|   // Conditionally load jest-dom for UI tests (JSDOM environment)
    116|   if (typeof window !== 'undefined') {

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
Error: Hook timed out in 300000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Γ¥» tests/setup.ts:334:1
    332| });
    333| 
    334| afterAll(async () => {
       | ^
    335|   // Cleanup test database
    336|   console.log("≡ƒº╣ Cleaning up test environment...");

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  13:52:34
   Duration  630.70s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/helpers/schemaManager.ts x12 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒùé∩╕Å backup and recover secrets: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768680390208,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768680395032,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768680395032,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w0_v3\",public on all connections"}
{"level":30,"time":1768680395084,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768680693968,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 600024ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
Error: Hook timed out in 300000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Γ¥» tests/setup.ts:114:1
    112| 
    113| // Global test hooks
    114| beforeAll(async () => {
       | ^
    115|   // Conditionally load jest-dom for UI tests (JSDOM environment)
    116|   if (typeof window !== 'undefined') {

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts [ tests/integration/auth/protected.routes.test.ts ]
Error: Hook timed out in 300000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Γ¥» tests/setup.ts:334:1
    332| });
    333| 
    334| afterAll(async () => {
       | ^
    335|   // Cleanup test database
    336|   console.log("≡ƒº╣ Cleaning up test environment...");

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:06:21
   Duration  611.93s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x13 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681263604,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681268983,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681268983,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w0_v3\",public on all connections"}
{"level":30,"time":1768681269036,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681270789,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681270810,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768681270798,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681270799,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681270804,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681270804,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681270809,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681270810,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681270810,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681270810,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768681271365,"env":"test","module":"user-credentials-repository","userId":"dbdafa34-ebb5-4caa-899a-fed280abc3cc","msg":"User credentials created"}
{"level":30,"time":1768681271484,"env":"test","module":"email-queue","jobId":"b00ec1d2-5f4a-4bfb-86ef-6c87f7884a05","to":"test-Zcb9Qv-LrIe5kb82BplmG@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681271545,"env":"test","module":"auth-routes","userId":"dbdafa34-ebb5-4caa-899a-fed280abc3cc","email":"test-Zcb9Qv-LrIe5kb82BplmG@example.com","msg":"User registered"}
{"level":30,"time":1768681272369,"env":"test","module":"user-credentials-repository","userId":"923cbb99-8185-4419-8ee3-dc0e4fd0f517","msg":"User credentials created"}
{"level":30,"time":1768681272506,"env":"test","module":"email-queue","jobId":"059f3ec0-f136-4fb7-a0f8-7463fca38818","to":"protected-test-_1-ggV4oK6kToiUGAMCLG@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681272563,"env":"test","module":"auth-routes","userId":"923cbb99-8185-4419-8ee3-dc0e4fd0f517","email":"protected-test-_1-ggV4oK6kToiUGAMCLG@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681273314,"env":"test","module":"auth-routes","userId":"923cbb99-8185-4419-8ee3-dc0e4fd0f517","msg":"User logged in successfully"}
{"level":30,"time":1768681273371,"env":"test","module":"audit-log-service","userId":"923cbb99-8185-4419-8ee3-dc0e4fd0f517","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681273894,"env":"test","module":"user-credentials-repository","userId":"be2ec0e3-cd1d-4eaf-b0dd-859e8d56a104","msg":"User credentials created"}
{"level":30,"time":1768681274004,"env":"test","module":"email-queue","jobId":"9f05b3f6-4a73-4afd-826d-480e4c647675","to":"protected-test-gvmpC7u4T10dhnHkzpBBZ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681274061,"env":"test","module":"auth-routes","userId":"be2ec0e3-cd1d-4eaf-b0dd-859e8d56a104","email":"protected-test-gvmpC7u4T10dhnHkzpBBZ@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681274245,"env":"test","module":"auth-routes","email":"protected-test-gvmpC7u4T10dhnHkzpBBZ@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768681274373,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768681274826,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["f0aab220-99d0-4bed-9243-c1fdf3049670","$2b$12$qWDcQJIDM6ENkkUAEtqrQ.DcEzZZfgicXGMS/eWcck/rPvA8muyY."],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f0aab220-99d0-4bed-9243-c1fdf3049670) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"f0aab220-99d0-4bed-9243-c1fdf3049670","msg":"Failed to create user credentials"}
{"level":50,"time":1768681274826,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["f0aab220-99d0-4bed-9243-c1fdf3049670","$2b$12$qWDcQJIDM6ENkkUAEtqrQ.DcEzZZfgicXGMS/eWcck/rPvA8muyY."],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f0aab220-99d0-4bed-9243-c1fdf3049670) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681275560,"env":"test","module":"user-credentials-repository","userId":"6c739659-605f-4857-abed-b0b4d5a7a099","msg":"User credentials created"}
{"level":30,"time":1768681275665,"env":"test","module":"email-queue","jobId":"2b783dcb-79e0-43ff-9dd3-f051e5042bca","to":"protected-test-FAdipm6FNpRztE6N3O71s@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681275712,"env":"test","module":"auth-routes","userId":"6c739659-605f-4857-abed-b0b4d5a7a099","email":"protected-test-FAdipm6FNpRztE6N3O71s@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681276382,"env":"test","module":"auth-routes","userId":"6c739659-605f-4857-abed-b0b4d5a7a099","msg":"User logged in successfully"}
{"level":30,"time":1768681276433,"env":"test","module":"audit-log-service","userId":"6c739659-605f-4857-abed-b0b4d5a7a099","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681276439,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681276853,"env":"test","module":"user-credentials-repository","userId":"dcc567f2-4adc-4a46-847c-7da2c38aa75a","msg":"User credentials created"}
{"level":30,"time":1768681276950,"env":"test","module":"email-queue","jobId":"5eb6d84e-a684-4dda-8998-32a8ad3220e5","to":"protected-test-iBV_QRmeNpDmXMCU2oghp@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681277001,"env":"test","module":"auth-routes","userId":"dcc567f2-4adc-4a46-847c-7da2c38aa75a","email":"protected-test-iBV_QRmeNpDmXMCU2oghp@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681277687,"env":"test","module":"auth-routes","userId":"dcc567f2-4adc-4a46-847c-7da2c38aa75a","msg":"User logged in successfully"}
{"level":30,"time":1768681277740,"env":"test","module":"audit-log-service","userId":"dcc567f2-4adc-4a46-847c-7da2c38aa75a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681277745,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768681277746,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768681278168,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b24d20e2-3f95-4d77-afe9-dda7a6d10199","$2b$12$lMfADUTUFQ9/kjIV8eklVu5jhz2Ry7UcoasuBiOV430aNtwi0soUq"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b24d20e2-3f95-4d77-afe9-dda7a6d10199) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"b24d20e2-3f95-4d77-afe9-dda7a6d10199","msg":"Failed to create user credentials"}
{"level":50,"time":1768681278168,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b24d20e2-3f95-4d77-afe9-dda7a6d10199","$2b$12$lMfADUTUFQ9/kjIV8eklVu5jhz2Ry7UcoasuBiOV430aNtwi0soUq"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b24d20e2-3f95-4d77-afe9-dda7a6d10199) is not present in table \"users\".","schema":"public","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681279020,"env":"test","module":"user-credentials-repository","userId":"b2cf2e07-902e-4f63-aba5-6831bc81ea4d","msg":"User credentials created"}
{"level":30,"time":1768681279115,"env":"test","module":"email-queue","jobId":"a04d2188-a729-4d90-8a8f-cd677515a964","to":"protected-test-2RSQaMEPCevA-MEW8lHxP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681279159,"env":"test","module":"auth-routes","userId":"b2cf2e07-902e-4f63-aba5-6831bc81ea4d","email":"protected-test-2RSQaMEPCevA-MEW8lHxP@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681279874,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["b2cf2e07-902e-4f63-aba5-6831bc81ea4d","d92a01293c1895599ebff34e4c86602888c74541a3168a45b2317ef3b2a0ef28","2026-02-16T20:21:19.822Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T20:21:19.822Z"],"cause":{"length":327,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b2cf2e07-902e-4f63-aba5-6831bc81ea4d) is not present in table \"users\".","schema":"public","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: b2cf2e07-902e-4f63-aba5-6831bc81ea4d,d92a01293c1895599ebff34e4c86602888c74541a3168a45b2317ef3b2a0ef28,2026-02-16T20:21:19.822Z,false,{"ip":"::1"},,::1,Location Unknown,2026-01-17T20:21:19.822Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
  query: 'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)',
  params: [
    'b2cf2e07-902e-4f63-aba5-6831bc81ea4d',
    'd92a01293c1895599ebff34e4c86602888c74541a3168a45b2317ef3b2a0ef28',
    '2026-02-16T20:21:19.822Z',
    false,
    '{"ip":"::1"}',
    null,
    '::1',
    'Location Unknown',
    '2026-01-17T20:21:19.822Z'
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
    length: 327,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(b2cf2e07-902e-4f63-aba5-6831bc81ea4d) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'public',
    table: 'refresh_tokens',
    column: undefined,
    dataType: undefined,
    constraint: 'refresh_tokens_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

{"level":30,"time":1768681280724,"env":"test","module":"user-credentials-repository","userId":"25e1a0b3-352c-48f6-bbf6-77b91101c153","msg":"User credentials created"}
{"level":30,"time":1768681280845,"env":"test","module":"email-queue","jobId":"7ff8bc3a-143e-4e1f-be35-28bb80063281","to":"protected-test-yRwtRhh6wlsAYQ1p1Twkk@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681280904,"env":"test","module":"auth-routes","userId":"25e1a0b3-352c-48f6-bbf6-77b91101c153","email":"protected-test-yRwtRhh6wlsAYQ1p1Twkk@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681281654,"env":"test","module":"auth-routes","userId":"25e1a0b3-352c-48f6-bbf6-77b91101c153","msg":"User logged in successfully"}
{"level":30,"time":1768681281714,"env":"test","module":"audit-log-service","userId":"25e1a0b3-352c-48f6-bbf6-77b91101c153","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681281720,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681282179,"env":"test","module":"user-credentials-repository","userId":"45649e64-87eb-4193-ba8a-21471557f5ab","msg":"User credentials created"}
{"level":30,"time":1768681282296,"env":"test","module":"email-queue","jobId":"28d82685-a08f-42ef-9ab0-e928d860aaea","to":"protected-test-MhYjb-ejccoYgme7s3AM8@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681282355,"env":"test","module":"auth-routes","userId":"45649e64-87eb-4193-ba8a-21471557f5ab","email":"protected-test-MhYjb-ejccoYgme7s3AM8@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681283111,"env":"test","module":"auth-routes","userId":"45649e64-87eb-4193-ba8a-21471557f5ab","msg":"User logged in successfully"}
{"level":30,"time":1768681283173,"env":"test","module":"audit-log-service","userId":"45649e64-87eb-4193-ba8a-21471557f5ab","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[DEBUG] BaseRepository.update users: id=45649e64-87eb-4193-ba8a-21471557f5ab, updates={"defaultMode":"advanced","updatedAt":"2026-01-17T20:21:23.295Z"}
{"level":30,"time":1768681283802,"env":"test","module":"user-credentials-repository","userId":"a18c6f3d-ee67-4abb-b8bd-cf3e034386c2","msg":"User credentials created"}
{"level":30,"time":1768681283928,"env":"test","module":"email-queue","jobId":"fedca801-d42d-4832-a16b-34099f697dd7","to":"protected-test-gYRR9b3_lxbo-TsfSQEu_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681283991,"env":"test","module":"auth-routes","userId":"a18c6f3d-ee67-4abb-b8bd-cf3e034386c2","email":"protected-test-gYRR9b3_lxbo-TsfSQEu_@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681284775,"env":"test","module":"auth-routes","userId":"a18c6f3d-ee67-4abb-b8bd-cf3e034386c2","msg":"User logged in successfully"}
{"level":30,"time":1768681284838,"env":"test","module":"audit-log-service","userId":"a18c6f3d-ee67-4abb-b8bd-cf3e034386c2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681284845,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681285359,"env":"test","module":"user-credentials-repository","userId":"d194f24a-8330-461c-a408-f7d7ca2283d4","msg":"User credentials created"}
{"level":30,"time":1768681285477,"env":"test","module":"email-queue","jobId":"8cc47107-e9e9-4c04-a5cd-c8365d9164aa","to":"protected-test-atknw7L65P4ms8AddcFEe@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681285540,"env":"test","module":"auth-routes","userId":"d194f24a-8330-461c-a408-f7d7ca2283d4","email":"protected-test-atknw7L65P4ms8AddcFEe@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681286297,"env":"test","module":"auth-routes","userId":"d194f24a-8330-461c-a408-f7d7ca2283d4","msg":"User logged in successfully"}
{"level":30,"time":1768681286355,"env":"test","module":"audit-log-service","userId":"d194f24a-8330-461c-a408-f7d7ca2283d4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681286985,"env":"test","module":"user-credentials-repository","userId":"04097143-401b-43a4-bed4-d01614e0670c","msg":"User credentials created"}
{"level":30,"time":1768681287123,"env":"test","module":"email-queue","jobId":"b1ab79ab-d22c-45f3-a973-49f48d66c34f","to":"protected-test-dgfZPIci4Mnsh2zUtCAUy@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681287181,"env":"test","module":"auth-routes","userId":"04097143-401b-43a4-bed4-d01614e0670c","email":"protected-test-dgfZPIci4Mnsh2zUtCAUy@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681287965,"env":"test","module":"auth-routes","userId":"04097143-401b-43a4-bed4-d01614e0670c","msg":"User logged in successfully"}
{"level":30,"time":1768681288022,"env":"test","module":"audit-log-service","userId":"04097143-401b-43a4-bed4-d01614e0670c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681288029,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681288461,"env":"test","module":"user-credentials-repository","userId":"505cc706-11ff-4b3f-a1b9-3afb86538f32","msg":"User credentials created"}
{"level":30,"time":1768681288574,"env":"test","module":"email-queue","jobId":"99cfc132-cfaa-4214-8ae0-b4905240a780","to":"protected-test-Ue3sIZz4-wd_zgnUqJDpQ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681288632,"env":"test","module":"auth-routes","userId":"505cc706-11ff-4b3f-a1b9-3afb86538f32","email":"protected-test-Ue3sIZz4-wd_zgnUqJDpQ@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681289340,"env":"test","module":"auth-routes","userId":"505cc706-11ff-4b3f-a1b9-3afb86538f32","msg":"User logged in successfully"}
{"level":30,"time":1768681289396,"env":"test","module":"audit-log-service","userId":"505cc706-11ff-4b3f-a1b9-3afb86538f32","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681290598,"env":"test","module":"user-credentials-repository","userId":"348f5638-f489-4a78-b198-6a825398a505","msg":"User credentials created"}
{"level":30,"time":1768681290719,"env":"test","module":"email-queue","jobId":"e1366b59-5a91-4952-b22f-13f1dbb4e009","to":"protected-test-R8TIaGoG0K2e2w5UsAoGf@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681290780,"env":"test","module":"auth-routes","userId":"348f5638-f489-4a78-b198-6a825398a505","email":"protected-test-R8TIaGoG0K2e2w5UsAoGf@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681291495,"env":"test","module":"auth-routes","userId":"348f5638-f489-4a78-b198-6a825398a505","msg":"User logged in successfully"}
{"level":30,"time":1768681291552,"env":"test","module":"audit-log-service","userId":"348f5638-f489-4a78-b198-6a825398a505","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681291557,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681292030,"env":"test","module":"user-credentials-repository","userId":"6e6da895-897d-47a0-b293-656ae7582fea","msg":"User credentials created"}
{"level":30,"time":1768681292142,"env":"test","module":"email-queue","jobId":"fe2c0a6a-c7b1-4162-8c51-15b10d36e86c","to":"protected-test-fGg2CryGTks3Zw-16sB6P@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681292200,"env":"test","module":"auth-routes","userId":"6e6da895-897d-47a0-b293-656ae7582fea","email":"protected-test-fGg2CryGTks3Zw-16sB6P@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681292927,"env":"test","module":"auth-routes","userId":"6e6da895-897d-47a0-b293-656ae7582fea","msg":"User logged in successfully"}
{"level":30,"time":1768681292988,"env":"test","module":"audit-log-service","userId":"6e6da895-897d-47a0-b293-656ae7582fea","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681292994,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768681292995,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681293464,"env":"test","module":"user-credentials-repository","userId":"66383ab8-b0ec-4145-9a83-62f61947ad8e","msg":"User credentials created"}
{"level":30,"time":1768681293580,"env":"test","module":"email-queue","jobId":"edfee508-1c9e-416a-b919-55843328f0f3","to":"protected-test-t9tlHAQIuZQ9Qme6AQSNS@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681293640,"env":"test","module":"auth-routes","userId":"66383ab8-b0ec-4145-9a83-62f61947ad8e","email":"protected-test-t9tlHAQIuZQ9Qme6AQSNS@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681294381,"env":"test","module":"auth-routes","userId":"66383ab8-b0ec-4145-9a83-62f61947ad8e","msg":"User logged in successfully"}
{"level":30,"time":1768681294440,"env":"test","module":"audit-log-service","userId":"66383ab8-b0ec-4145-9a83-62f61947ad8e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681294446,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681294904,"env":"test","module":"user-credentials-repository","userId":"2b727faa-518d-4295-8b12-f4cd27eab142","msg":"User credentials created"}
{"level":30,"time":1768681295020,"env":"test","module":"email-queue","jobId":"ca04f33f-5f6d-4bb1-97b4-b8f6e9c57bd2","to":"protected-test-xKbMN6M1N05fNBsr7tVQe@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681295078,"env":"test","module":"auth-routes","userId":"2b727faa-518d-4295-8b12-f4cd27eab142","email":"protected-test-xKbMN6M1N05fNBsr7tVQe@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681295863,"env":"test","module":"auth-routes","userId":"2b727faa-518d-4295-8b12-f4cd27eab142","msg":"User logged in successfully"}
{"level":30,"time":1768681295920,"env":"test","module":"audit-log-service","userId":"2b727faa-518d-4295-8b12-f4cd27eab142","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681295926,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681296385,"env":"test","module":"user-credentials-repository","userId":"cc8a82ef-7bbd-4e23-874c-3799cddf6afd","msg":"User credentials created"}
{"level":30,"time":1768681296505,"env":"test","module":"email-queue","jobId":"4d155798-d17b-43a8-b135-face9d6436b3","to":"protected-test-5AQI64ux-DfMDAW8sjwZd@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681296565,"env":"test","module":"auth-routes","userId":"cc8a82ef-7bbd-4e23-874c-3799cddf6afd","email":"protected-test-5AQI64ux-DfMDAW8sjwZd@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681297300,"env":"test","module":"auth-routes","userId":"cc8a82ef-7bbd-4e23-874c-3799cddf6afd","msg":"User logged in successfully"}
{"level":30,"time":1768681297356,"env":"test","module":"audit-log-service","userId":"cc8a82ef-7bbd-4e23-874c-3799cddf6afd","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681297362,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681297792,"env":"test","module":"user-credentials-repository","userId":"df16d068-9a29-474c-b932-38409b6475d1","msg":"User credentials created"}
{"level":30,"time":1768681297910,"env":"test","module":"email-queue","jobId":"ab0ede56-ee74-4e79-ad81-63b94bf294e5","to":"protected-test-5SLukArLCWvd1H36fttHB@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681297976,"env":"test","module":"auth-routes","userId":"df16d068-9a29-474c-b932-38409b6475d1","email":"protected-test-5SLukArLCWvd1H36fttHB@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681298763,"env":"test","module":"auth-routes","userId":"df16d068-9a29-474c-b932-38409b6475d1","msg":"User logged in successfully"}
{"level":30,"time":1768681298819,"env":"test","module":"audit-log-service","userId":"df16d068-9a29-474c-b932-38409b6475d1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681298823,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681299290,"env":"test","module":"user-credentials-repository","userId":"da1cfa5a-0637-410b-8063-57dc3206c00b","msg":"User credentials created"}
{"level":30,"time":1768681299409,"env":"test","module":"email-queue","jobId":"8e6e928b-bb42-4d5d-86ee-7a9b28a27653","to":"protected-test-_FHdi72o_tKsqgfSb1OHr@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681299466,"env":"test","module":"auth-routes","userId":"da1cfa5a-0637-410b-8063-57dc3206c00b","email":"protected-test-_FHdi72o_tKsqgfSb1OHr@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681300216,"env":"test","module":"auth-routes","userId":"da1cfa5a-0637-410b-8063-57dc3206c00b","msg":"User logged in successfully"}
{"level":30,"time":1768681300279,"env":"test","module":"audit-log-service","userId":"da1cfa5a-0637-410b-8063-57dc3206c00b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681300284,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681300790,"env":"test","module":"user-credentials-repository","userId":"da8483c6-fe3a-4056-be84-615c6bd3a45d","msg":"User credentials created"}
{"level":30,"time":1768681300936,"env":"test","module":"email-queue","jobId":"60d96184-6279-4bf3-afef-f82a5eab1799","to":"protected-test-mGq7tuVwRatnmEDYrj1DU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681300995,"env":"test","module":"auth-routes","userId":"da8483c6-fe3a-4056-be84-615c6bd3a45d","email":"protected-test-mGq7tuVwRatnmEDYrj1DU@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681301720,"env":"test","module":"auth-routes","userId":"da8483c6-fe3a-4056-be84-615c6bd3a45d","msg":"User logged in successfully"}
{"level":30,"time":1768681301781,"env":"test","module":"audit-log-service","userId":"da8483c6-fe3a-4056-be84-615c6bd3a45d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681301785,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681302248,"env":"test","module":"user-credentials-repository","userId":"69c8e64e-0b0a-4b27-b554-c86553c03295","msg":"User credentials created"}
{"level":30,"time":1768681302362,"env":"test","module":"email-queue","jobId":"09340a78-4e0f-48a4-8bfe-a61d9937d659","to":"protected-test-dfDRiW7LZKVJzHYLNAvNC@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681302421,"env":"test","module":"auth-routes","userId":"69c8e64e-0b0a-4b27-b554-c86553c03295","email":"protected-test-dfDRiW7LZKVJzHYLNAvNC@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681303199,"env":"test","module":"auth-routes","userId":"69c8e64e-0b0a-4b27-b554-c86553c03295","msg":"User logged in successfully"}
{"level":30,"time":1768681303256,"env":"test","module":"audit-log-service","userId":"69c8e64e-0b0a-4b27-b554-c86553c03295","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681303671,"env":"test","module":"user-credentials-repository","userId":"f09f3c0a-34c6-488b-bf05-5f15ffec8e14","msg":"User credentials created"}
{"level":30,"time":1768681303786,"env":"test","module":"email-queue","jobId":"4298f6fd-b722-485a-a277-9983d7cad8e6","to":"protected-test-UWA7lRCaVBj5HT2jp6_Bu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681303842,"env":"test","module":"auth-routes","userId":"f09f3c0a-34c6-488b-bf05-5f15ffec8e14","email":"protected-test-UWA7lRCaVBj5HT2jp6_Bu@example.com","msg":"User registered"}
{"level":30,"time":1768681304548,"env":"test","module":"auth-routes","userId":"f09f3c0a-34c6-488b-bf05-5f15ffec8e14","msg":"User logged in successfully"}
{"level":30,"time":1768681304603,"env":"test","module":"audit-log-service","userId":"f09f3c0a-34c6-488b-bf05-5f15ffec8e14","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681305137,"env":"test","module":"user-credentials-repository","userId":"85dd0892-685e-496e-9941-16a319677849","msg":"User credentials created"}
{"level":30,"time":1768681305256,"env":"test","module":"email-queue","jobId":"b69570cc-fda1-436a-9614-8dc61eea8196","to":"protected-test-1hXWZxZzu7yBtGtIf66MF@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681305319,"env":"test","module":"auth-routes","userId":"85dd0892-685e-496e-9941-16a319677849","email":"protected-test-1hXWZxZzu7yBtGtIf66MF@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681306018,"env":"test","module":"auth-routes","userId":"85dd0892-685e-496e-9941-16a319677849","msg":"User logged in successfully"}
{"level":30,"time":1768681306079,"env":"test","module":"audit-log-service","userId":"85dd0892-685e-496e-9941-16a319677849","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681306552,"env":"test","module":"user-credentials-repository","userId":"3d4db6cd-df3a-4b14-98ff-167945eefe44","msg":"User credentials created"}
{"level":30,"time":1768681306673,"env":"test","module":"email-queue","jobId":"6ba9d193-2da3-4e26-a746-a5323d67a3e8","to":"user2-z1yJl2D8I8B1lPce28rme@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681306729,"env":"test","module":"auth-routes","userId":"3d4db6cd-df3a-4b14-98ff-167945eefe44","email":"user2-z1yJl2D8I8B1lPce28rme@example.com","msg":"User registered"}
{"level":30,"time":1768681307353,"env":"test","module":"auth-routes","userId":"3d4db6cd-df3a-4b14-98ff-167945eefe44","msg":"User logged in successfully"}
{"level":30,"time":1768681307414,"env":"test","module":"audit-log-service","userId":"3d4db6cd-df3a-4b14-98ff-167945eefe44","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681307479,"env":"test","module":"rbac-middleware","userId":"3d4db6cd-df3a-4b14-98ff-167945eefe44","userRole":"viewer","permission":"project:delete","path":"/57ab1ba5-3c76-43fe-82c1-e895b3713262","msg":"Permission denied"}
{"level":30,"time":1768681307885,"env":"test","module":"user-credentials-repository","userId":"1fef28f6-61d3-4083-9135-76552ca46e14","msg":"User credentials created"}
{"level":30,"time":1768681307999,"env":"test","module":"email-queue","jobId":"9aac8920-d7a5-4944-baa8-76f6b08f29b4","to":"protected-test-9XAPdGTjyZmmWpmOqCqL6@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681308057,"env":"test","module":"auth-routes","userId":"1fef28f6-61d3-4083-9135-76552ca46e14","email":"protected-test-9XAPdGTjyZmmWpmOqCqL6@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681308740,"env":"test","module":"auth-routes","userId":"1fef28f6-61d3-4083-9135-76552ca46e14","msg":"User logged in successfully"}
{"level":30,"time":1768681308801,"env":"test","module":"audit-log-service","userId":"1fef28f6-61d3-4083-9135-76552ca46e14","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681309297,"env":"test","module":"user-credentials-repository","userId":"a5a38ab0-aaa1-4884-9485-22eebbd62fea","msg":"User credentials created"}
{"level":30,"time":1768681309408,"env":"test","module":"email-queue","jobId":"6cd2462e-599c-42d2-a986-c4c56d6627a9","to":"protected-test-Jz9FzA62m-z-2xaDSi0Up@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681309467,"env":"test","module":"auth-routes","userId":"a5a38ab0-aaa1-4884-9485-22eebbd62fea","email":"protected-test-Jz9FzA62m-z-2xaDSi0Up@example.com","msg":"User registered"}
{"level":30,"time":1768681310167,"env":"test","module":"auth-routes","userId":"a5a38ab0-aaa1-4884-9485-22eebbd62fea","msg":"User logged in successfully"}
{"level":30,"time":1768681310234,"env":"test","module":"audit-log-service","userId":"a5a38ab0-aaa1-4884-9485-22eebbd62fea","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681310712,"env":"test","module":"user-credentials-repository","userId":"a71d717c-5bd9-4f16-806a-0626eed3d392","msg":"User credentials created"}
{"level":30,"time":1768681310828,"env":"test","module":"email-queue","jobId":"daa4f40e-8c96-4d47-900c-f040f3f874cc","to":"protected-test-pe3KMInZQg_NUwzsQydaM@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681310891,"env":"test","module":"auth-routes","userId":"a71d717c-5bd9-4f16-806a-0626eed3d392","email":"protected-test-pe3KMInZQg_NUwzsQydaM@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681311584,"env":"test","module":"auth-routes","userId":"a71d717c-5bd9-4f16-806a-0626eed3d392","msg":"User logged in successfully"}
{"level":30,"time":1768681311642,"env":"test","module":"audit-log-service","userId":"a71d717c-5bd9-4f16-806a-0626eed3d392","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681312164,"env":"test","module":"user-credentials-repository","userId":"2506852b-0228-4b3b-89e5-e5e8ce14188d","msg":"User credentials created"}
{"level":30,"time":1768681312280,"env":"test","module":"email-queue","jobId":"1c7b7fb2-e07d-4e7e-8777-20f3bff61dd9","to":"protected-test-AByNFZJI9Yc7pig3YAyhl@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681312337,"env":"test","module":"auth-routes","userId":"2506852b-0228-4b3b-89e5-e5e8ce14188d","email":"protected-test-AByNFZJI9Yc7pig3YAyhl@example.com","msg":"User registered"}
{"level":30,"time":1768681313195,"env":"test","module":"auth-routes","userId":"2506852b-0228-4b3b-89e5-e5e8ce14188d","msg":"User logged in successfully"}
{"level":30,"time":1768681313259,"env":"test","module":"audit-log-service","userId":"2506852b-0228-4b3b-89e5-e5e8ce14188d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681314196,"env":"test","module":"user-credentials-repository","userId":"d4e91fbe-f160-4a0e-9908-2806255d1dca","msg":"User credentials created"}
{"level":30,"time":1768681314320,"env":"test","module":"email-queue","jobId":"eeeefcc9-d254-4506-9775-e2e650695226","to":"protected-test-Y3AdWed6SLEVClcEmbIF-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681314383,"env":"test","module":"auth-routes","userId":"d4e91fbe-f160-4a0e-9908-2806255d1dca","email":"protected-test-Y3AdWed6SLEVClcEmbIF-@example.com","msg":"User registered"}
{"level":30,"time":1768681315089,"env":"test","module":"auth-routes","userId":"d4e91fbe-f160-4a0e-9908-2806255d1dca","msg":"User logged in successfully"}
{"level":30,"time":1768681315147,"env":"test","module":"audit-log-service","userId":"d4e91fbe-f160-4a0e-9908-2806255d1dca","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681315725,"env":"test","module":"auth-routes","userId":"d4e91fbe-f160-4a0e-9908-2806255d1dca","msg":"User logged in successfully"}
{"level":30,"time":1768681315785,"env":"test","module":"audit-log-service","userId":"d4e91fbe-f160-4a0e-9908-2806255d1dca","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681316257,"env":"test","module":"user-credentials-repository","userId":"212cf0e0-a8e6-40a7-8f3f-fd57b2ff5397","msg":"User credentials created"}
{"level":30,"time":1768681316370,"env":"test","module":"email-queue","jobId":"4c8959f7-324b-4ac8-84a1-ed0e6d9b4908","to":"protected-test-WX-Xf8TYJnxEYxO5MppZ1@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681316428,"env":"test","module":"auth-routes","userId":"212cf0e0-a8e6-40a7-8f3f-fd57b2ff5397","email":"protected-test-WX-Xf8TYJnxEYxO5MppZ1@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681317137,"env":"test","module":"auth-routes","userId":"212cf0e0-a8e6-40a7-8f3f-fd57b2ff5397","msg":"User logged in successfully"}
{"level":30,"time":1768681317200,"env":"test","module":"audit-log-service","userId":"212cf0e0-a8e6-40a7-8f3f-fd57b2ff5397","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681317847,"env":"test","module":"auth-routes","userId":"212cf0e0-a8e6-40a7-8f3f-fd57b2ff5397","msg":"User logged in successfully"}
{"level":30,"time":1768681317903,"env":"test","module":"audit-log-service","userId":"212cf0e0-a8e6-40a7-8f3f-fd57b2ff5397","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681318338,"env":"test","module":"user-credentials-repository","userId":"25704d3f-6547-4405-a805-c4c7b82c2555","msg":"User credentials created"}
{"level":30,"time":1768681318461,"env":"test","module":"email-queue","jobId":"06e61755-f094-4a69-8f91-f465e1fb9dc4","to":"user2-MHxTgMBi_zzQL9gIZi1_z@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681318544,"env":"test","module":"auth-routes","userId":"25704d3f-6547-4405-a805-c4c7b82c2555","email":"user2-MHxTgMBi_zzQL9gIZi1_z@example.com","msg":"User registered"}
{"level":30,"time":1768681319254,"env":"test","module":"auth-routes","userId":"25704d3f-6547-4405-a805-c4c7b82c2555","msg":"User logged in successfully"}
{"level":30,"time":1768681319319,"env":"test","module":"audit-log-service","userId":"25704d3f-6547-4405-a805-c4c7b82c2555","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681319874,"env":"test","module":"user-credentials-repository","userId":"603d89dd-4191-47f9-bba6-662196371913","msg":"User credentials created"}
{"level":30,"time":1768681320019,"env":"test","module":"email-queue","jobId":"5ba3a9c8-55dd-43dc-a590-3a13a5dad58f","to":"protected-test-7Ujs09SjCIibfx_utIb73@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768681320110,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["603d89dd-4191-47f9-bba6-662196371913","b828191eddbe0ee85a84425402a7d36293c540139f405c649a824f0bcbc0f8b5","2026-02-16T20:22:00.020Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T20:22:00.020Z"],"cause":{"length":339,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(603d89dd-4191-47f9-bba6-662196371913) is not present in table \"users\".","schema":"test_schema_w15_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681320561,"env":"test","module":"user-credentials-repository","userId":"8d9b5a22-48af-4edc-b27d-bf20b6d61a69","msg":"User credentials created"}
{"level":30,"time":1768681320679,"env":"test","module":"email-queue","jobId":"a5d45d4b-09ed-44e6-b06d-d02b23d12c8b","to":"protected-test-RC5k2ugYkpozjXostD30A@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681320735,"env":"test","module":"auth-routes","userId":"8d9b5a22-48af-4edc-b27d-bf20b6d61a69","email":"protected-test-RC5k2ugYkpozjXostD30A@example.com","msg":"User registered"}
{"level":30,"time":1768681321496,"env":"test","module":"auth-routes","userId":"8d9b5a22-48af-4edc-b27d-bf20b6d61a69","msg":"User logged in successfully"}
{"level":30,"time":1768681321558,"env":"test","module":"audit-log-service","userId":"8d9b5a22-48af-4edc-b27d-bf20b6d61a69","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681321621,"env":"test","module":"tenant-middleware","userId":"dbdafa34-ebb5-4caa-899a-fed280abc3cc","path":"/projects/61957c04-72a8-479b-b6b2-65d1e80dc714/workflows","msg":"User does not have an associated tenant"}
{"level":30,"time":1768681321747,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681321748,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 6 failed | 1 skipped) 53713ms
       Γ£ô should allow access with valid Bearer token  1580ms
       ├ù should reject access without Authorization header 937ms
       ├ù should reject access with empty Bearer token 448ms
       Γ£ô should reject access with malformed Authorization header  1614ms
       Γ£ô should reject access with wrong token type  1305ms
       ├ù should allow POST with valid Bearer token 423ms
       ├ù should reject POST without Bearer token 1711ms
       Γ£ô should reject POST with invalid token  1841ms
       Γ£ô should allow PUT with valid Bearer token  1641ms
       Γ£ô should reject PUT without Bearer token  1484ms
       Γ£ô should allow DELETE with valid Bearer token  1698ms
       Γ£ô should reject DELETE without Bearer token  1486ms
       Γ£ô should allow PATCH with valid Bearer token  2129ms
       Γ£ô should reject PATCH without Bearer token  1400ms
       Γ£ô should handle Bearer token with extra spaces  1437ms
       Γåô should handle token with newlines
       Γ£ô should handle very long invalid token  1451ms
       Γ£ô should handle empty Authorization header  1480ms
       Γ£ô should handle Authorization header with only Bearer  1436ms
       Γ£ô should handle multiple Authorization headers  1463ms
       Γ£ô should reject token with SQL injection attempt  1458ms
       Γ£ô should reject token with XSS attempt  1501ms
       Γ£ô should reject token with missing userId  1477ms
       Γ£ô should reject token with non-existent userId  1466ms
       Γ£ô should not allow user to access another user's resources  2750ms
       Γ£ô should inject userId into request context  1383ms
       Γ£ô should inject tenantId into request context  1433ms
       Γ£ô should inject role into request context  1408ms
       Γ£ô should not apply general rate limiting to authenticated requests  2077ms
       Γ£ô should handle request with both Bearer token and cookies  2066ms
       Γ£ô should prioritize Bearer token over cookie when both present  3595ms
       ├ù should allow unauthenticated access to optional auth routes 671ms
       ├ù should enhance optional auth routes with user context when authenticated 1511ms
[vitest-pool]: Timeout terminating forks worker for test files C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts.

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Tests 6 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
Error: expected 200 "OK", got 401 "Unauthorized"
 Γ¥» tests/integration/auth/protected.routes.test.ts:84:14
     82|                 password: testUser.password,
     83|             })
     84|             .expect(200);
       |              ^
     85| 
     86|         userToken = loginRes.body.token;
 Γ¥» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Γ¥» node_modules/supertest/lib/test.js:365:13
 Γ¥» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Γ¥» Test.assert node_modules/supertest/lib/test.js:195:23
 Γ¥» localAssert node_modules/supertest/lib/test.js:138:14
 Γ¥» node_modules/supertest/lib/test.js:156:7
 Γ¥» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Γ¥» node_modules/superagent/lib/node/index.js:1102:18
 Γ¥» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/6]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
Error: expected 201 "Created", got 500 "Internal Server Error"
 Γ¥» tests/integration/auth/protected.routes.test.ts:56:14
     54|             .post("/api/auth/register")
     55|             .send(testUser)
     56|             .expect(201);
       |              ^
     57| 
     58|         const userId = registerRes.body.user.id;
 Γ¥» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Γ¥» node_modules/supertest/lib/test.js:365:13
 Γ¥» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Γ¥» Test.assert node_modules/supertest/lib/test.js:195:23
 Γ¥» localAssert node_modules/supertest/lib/test.js:138:14
 Γ¥» node_modules/supertest/lib/test.js:156:7
 Γ¥» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Γ¥» node_modules/superagent/lib/node/index.js:1102:18
 Γ¥» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/6]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
Error: expected 200 "OK", got 500 "Internal Server Error"
 Γ¥» tests/integration/auth/protected.routes.test.ts:84:14
     82|                 password: testUser.password,
     83|             })
     84|             .expect(200);
       |              ^
     85| 
     86|         userToken = loginRes.body.token;
 Γ¥» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Γ¥» node_modules/supertest/lib/test.js:365:13
 Γ¥» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Γ¥» Test.assert node_modules/supertest/lib/test.js:195:23
 Γ¥» localAssert node_modules/supertest/lib/test.js:138:14
 Γ¥» node_modules/supertest/lib/test.js:156:7
 Γ¥» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Γ¥» node_modules/superagent/lib/node/index.js:1102:18
 Γ¥» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[3/6]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Error: expected 201 "Created", got 403 "Forbidden"
 Γ¥» tests/integration/auth/protected.routes.test.ts:533:18
    531|                     slug: slug,
    532|                 })
    533|                 .expect(201);
       |                  ^
    534| 
    535|             // Manually publish
 Γ¥» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Γ¥» node_modules/supertest/lib/test.js:365:13
 Γ¥» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Γ¥» Test.assert node_modules/supertest/lib/test.js:195:23
 Γ¥» localAssert node_modules/supertest/lib/test.js:138:14
 Γ¥» node_modules/supertest/lib/test.js:156:7
 Γ¥» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Γ¥» node_modules/superagent/lib/node/index.js:1102:18
 Γ¥» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[4/6]ΓÄ»


 Test Files  1 failed (1)
      Tests  6 failed | 26 passed | 1 skipped (33)
   Start at  14:20:48
   Duration  67.95s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x14 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681467760,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681472179,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681472180,"env":"test","msg":"DB: Configured pool to set search_path=\"test_schema_w0_v3\",public on all connections"}
{"level":30,"time":1768681472232,"env":"test","msg":"DB: Wrapped execute() to set search_path=\"test_schema_w0_v3\",public"}
{"level":30,"time":1768681472232,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w137_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w137_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681475171,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681475188,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768681475179,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681475180,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681475183,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681475184,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681475188,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681475188,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681475188,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681475188,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768681475698,"env":"test","module":"user-credentials-repository","userId":"cb11d31e-89c6-4867-930c-fb61020c09cf","msg":"User credentials created"}
{"level":30,"time":1768681475818,"env":"test","module":"email-queue","jobId":"fa9e7759-e158-491f-a92a-2007b68e51fb","to":"test-1_Njdjy_Be3RS0rBZOJO-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681475879,"env":"test","module":"auth-routes","userId":"cb11d31e-89c6-4867-930c-fb61020c09cf","email":"test-1_Njdjy_Be3RS0rBZOJO-@example.com","msg":"User registered"}
{"level":30,"time":1768681476623,"env":"test","module":"user-credentials-repository","userId":"e891d3c2-69b1-471b-b431-ed234cc036eb","msg":"User credentials created"}
{"level":30,"time":1768681476740,"env":"test","module":"email-queue","jobId":"49672005-62f6-4264-a1f0-36578bc5fa47","to":"protected-test-z62q-ZCH7Rqv2lD_a6WKf@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681476798,"env":"test","module":"auth-routes","userId":"e891d3c2-69b1-471b-b431-ed234cc036eb","email":"protected-test-z62q-ZCH7Rqv2lD_a6WKf@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681477497,"env":"test","module":"auth-routes","userId":"e891d3c2-69b1-471b-b431-ed234cc036eb","msg":"User logged in successfully"}
{"level":30,"time":1768681477554,"env":"test","module":"audit-log-service","userId":"e891d3c2-69b1-471b-b431-ed234cc036eb","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681478021,"env":"test","module":"user-credentials-repository","userId":"becfe800-4805-4703-b5d3-8bbcb9a0d9ab","msg":"User credentials created"}
{"level":30,"time":1768681478141,"env":"test","module":"email-queue","jobId":"6519c407-aae6-4117-9685-518c274a77e2","to":"protected-test-k5AbVGZ7SfJRLMm-quMDw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681478202,"env":"test","module":"auth-routes","userId":"becfe800-4805-4703-b5d3-8bbcb9a0d9ab","email":"protected-test-k5AbVGZ7SfJRLMm-quMDw@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681478944,"env":"test","module":"auth-routes","userId":"becfe800-4805-4703-b5d3-8bbcb9a0d9ab","msg":"User logged in successfully"}
{"level":30,"time":1768681479008,"env":"test","module":"audit-log-service","userId":"becfe800-4805-4703-b5d3-8bbcb9a0d9ab","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681479014,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681479443,"env":"test","module":"user-credentials-repository","userId":"190f92e8-aa0e-4b6d-a9e7-675a0d22f9e8","msg":"User credentials created"}
{"level":30,"time":1768681479590,"env":"test","module":"email-queue","jobId":"f943a8de-548a-4789-97be-f487992b1bba","to":"protected-test-HxaeWKCww-OWh3rr-VfXl@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681479648,"env":"test","module":"auth-routes","userId":"190f92e8-aa0e-4b6d-a9e7-675a0d22f9e8","email":"protected-test-HxaeWKCww-OWh3rr-VfXl@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681480345,"env":"test","module":"auth-routes","userId":"190f92e8-aa0e-4b6d-a9e7-675a0d22f9e8","msg":"User logged in successfully"}
{"level":30,"time":1768681480408,"env":"test","module":"audit-log-service","userId":"190f92e8-aa0e-4b6d-a9e7-675a0d22f9e8","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681480412,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681480811,"env":"test","module":"user-credentials-repository","userId":"ed393f9b-414c-4a87-ad79-57ea9337289e","msg":"User credentials created"}
{"level":30,"time":1768681480935,"env":"test","module":"email-queue","jobId":"effa18d1-cd60-4f78-ade7-7f14bfadce96","to":"protected-test-jnirEEaqTkgm6jRzE5mRY@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681480992,"env":"test","module":"auth-routes","userId":"ed393f9b-414c-4a87-ad79-57ea9337289e","email":"protected-test-jnirEEaqTkgm6jRzE5mRY@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681481684,"env":"test","module":"auth-routes","userId":"ed393f9b-414c-4a87-ad79-57ea9337289e","msg":"User logged in successfully"}
{"level":30,"time":1768681481740,"env":"test","module":"audit-log-service","userId":"ed393f9b-414c-4a87-ad79-57ea9337289e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681481743,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681482151,"env":"test","module":"user-credentials-repository","userId":"6c396931-e9a0-409c-a17d-9011a04459d5","msg":"User credentials created"}
{"level":30,"time":1768681482267,"env":"test","module":"email-queue","jobId":"e885df84-95ea-45b1-b5ca-7d3418fd4b52","to":"protected-test-wQ4MfW_Eqd11HhusbdOpx@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681482350,"env":"test","module":"auth-routes","userId":"6c396931-e9a0-409c-a17d-9011a04459d5","email":"protected-test-wQ4MfW_Eqd11HhusbdOpx@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681483097,"env":"test","module":"auth-routes","userId":"6c396931-e9a0-409c-a17d-9011a04459d5","msg":"User logged in successfully"}
{"level":30,"time":1768681483155,"env":"test","module":"audit-log-service","userId":"6c396931-e9a0-409c-a17d-9011a04459d5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681483159,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768681483159,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681483574,"env":"test","module":"user-credentials-repository","userId":"6719172b-104c-46e9-9757-7855fe7822ff","msg":"User credentials created"}
{"level":30,"time":1768681483689,"env":"test","module":"email-queue","jobId":"74c47d08-8e9d-4d6e-bb8f-5788d77dfa4f","to":"protected-test-i83IfH9PqSyTU7rxogPzm@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681483745,"env":"test","module":"auth-routes","userId":"6719172b-104c-46e9-9757-7855fe7822ff","email":"protected-test-i83IfH9PqSyTU7rxogPzm@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681484428,"env":"test","module":"auth-routes","userId":"6719172b-104c-46e9-9757-7855fe7822ff","msg":"User logged in successfully"}
{"level":30,"time":1768681484490,"env":"test","module":"audit-log-service","userId":"6719172b-104c-46e9-9757-7855fe7822ff","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681484965,"env":"test","module":"user-credentials-repository","userId":"2f6e22d0-6b99-4ba9-b01b-ee05a90f61da","msg":"User credentials created"}
{"level":30,"time":1768681485084,"env":"test","module":"email-queue","jobId":"e7838417-f06e-453d-a9b3-a98ba8d87a05","to":"protected-test-DAihsKmvMkXS09P6aaEtH@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681485141,"env":"test","module":"auth-routes","userId":"2f6e22d0-6b99-4ba9-b01b-ee05a90f61da","email":"protected-test-DAihsKmvMkXS09P6aaEtH@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681485850,"env":"test","module":"auth-routes","userId":"2f6e22d0-6b99-4ba9-b01b-ee05a90f61da","msg":"User logged in successfully"}
{"level":30,"time":1768681485914,"env":"test","module":"audit-log-service","userId":"2f6e22d0-6b99-4ba9-b01b-ee05a90f61da","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681485918,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681486334,"env":"test","module":"user-credentials-repository","userId":"02c8313d-14d7-4fe8-8c26-762374f999ce","msg":"User credentials created"}
{"level":30,"time":1768681486449,"env":"test","module":"email-queue","jobId":"e6aaf084-3540-42f4-9db3-683ffc821d94","to":"protected-test-FNlSfflVajm5awKR8iiNX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681486505,"env":"test","module":"auth-routes","userId":"02c8313d-14d7-4fe8-8c26-762374f999ce","email":"protected-test-FNlSfflVajm5awKR8iiNX@example.com","msg":"User registered"}
{"level":30,"time":1768681487190,"env":"test","module":"auth-routes","userId":"02c8313d-14d7-4fe8-8c26-762374f999ce","msg":"User logged in successfully"}
{"level":30,"time":1768681487273,"env":"test","module":"audit-log-service","userId":"02c8313d-14d7-4fe8-8c26-762374f999ce","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681487277,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681487680,"env":"test","module":"user-credentials-repository","userId":"eb3736e8-1fa9-4e7a-8fb1-ecd9df125413","msg":"User credentials created"}
{"level":30,"time":1768681487792,"env":"test","module":"email-queue","jobId":"df0df440-751f-47bd-ac9a-f8f81321233d","to":"protected-test-3IUE3Y7mmKiYo5lqAcTl-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681487853,"env":"test","module":"auth-routes","userId":"eb3736e8-1fa9-4e7a-8fb1-ecd9df125413","email":"protected-test-3IUE3Y7mmKiYo5lqAcTl-@example.com","msg":"User registered"}
{"level":30,"time":1768681488578,"env":"test","module":"auth-routes","userId":"eb3736e8-1fa9-4e7a-8fb1-ecd9df125413","msg":"User logged in successfully"}
{"level":30,"time":1768681488639,"env":"test","module":"audit-log-service","userId":"eb3736e8-1fa9-4e7a-8fb1-ecd9df125413","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[DEBUG] BaseRepository.update users: id=eb3736e8-1fa9-4e7a-8fb1-ecd9df125413, updates={"defaultMode":"advanced","updatedAt":"2026-01-17T20:24:48.761Z"}
{"level":30,"time":1768681489231,"env":"test","module":"user-credentials-repository","userId":"2c745d92-3d69-447d-8620-6d8f8d84a4d9","msg":"User credentials created"}
{"level":30,"time":1768681489344,"env":"test","module":"email-queue","jobId":"1c043554-1697-45a3-b960-4583ca1b3d3d","to":"protected-test-cyd7yU01bR3oy2UqY1OWr@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681489406,"env":"test","module":"auth-routes","userId":"2c745d92-3d69-447d-8620-6d8f8d84a4d9","email":"protected-test-cyd7yU01bR3oy2UqY1OWr@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681490086,"env":"test","module":"auth-routes","userId":"2c745d92-3d69-447d-8620-6d8f8d84a4d9","msg":"User logged in successfully"}
{"level":30,"time":1768681490145,"env":"test","module":"audit-log-service","userId":"2c745d92-3d69-447d-8620-6d8f8d84a4d9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681490151,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681490554,"env":"test","module":"user-credentials-repository","userId":"b4c8593a-b5f2-40f4-b010-facb102567d9","msg":"User credentials created"}
{"level":30,"time":1768681490674,"env":"test","module":"email-queue","jobId":"3baa8d83-a7a2-45b1-bb4a-0f6f2fcd34a8","to":"protected-test-PIqyo14tHBp5J58B3QGY1@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681490735,"env":"test","module":"auth-routes","userId":"b4c8593a-b5f2-40f4-b010-facb102567d9","email":"protected-test-PIqyo14tHBp5J58B3QGY1@example.com","msg":"User registered"}
{"level":30,"time":1768681491443,"env":"test","module":"auth-routes","userId":"b4c8593a-b5f2-40f4-b010-facb102567d9","msg":"User logged in successfully"}
{"level":30,"time":1768681491500,"env":"test","module":"audit-log-service","userId":"b4c8593a-b5f2-40f4-b010-facb102567d9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681492135,"env":"test","module":"user-credentials-repository","userId":"656f9617-1e10-45cd-81c2-cca7574065a5","msg":"User credentials created"}
{"level":30,"time":1768681492253,"env":"test","module":"email-queue","jobId":"a6a48e7a-e0b1-4f5c-81a6-6dc75d06624a","to":"protected-test-zzpmENdAFvMLkx_VVkWFl@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681492314,"env":"test","module":"auth-routes","userId":"656f9617-1e10-45cd-81c2-cca7574065a5","email":"protected-test-zzpmENdAFvMLkx_VVkWFl@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681493090,"env":"test","module":"auth-routes","userId":"656f9617-1e10-45cd-81c2-cca7574065a5","msg":"User logged in successfully"}
{"level":30,"time":1768681493149,"env":"test","module":"audit-log-service","userId":"656f9617-1e10-45cd-81c2-cca7574065a5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681493153,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681493577,"env":"test","module":"user-credentials-repository","userId":"b1ddcb07-e919-49a6-ae60-f28fca99c7e2","msg":"User credentials created"}
{"level":30,"time":1768681493699,"env":"test","module":"email-queue","jobId":"0a9526ff-6fcc-44dd-876b-142c418a68eb","to":"protected-test-4SimAnFbcG55xhDhqjRQR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681493756,"env":"test","module":"auth-routes","userId":"b1ddcb07-e919-49a6-ae60-f28fca99c7e2","email":"protected-test-4SimAnFbcG55xhDhqjRQR@example.com","msg":"User registered"}
{"level":30,"time":1768681494485,"env":"test","module":"auth-routes","userId":"b1ddcb07-e919-49a6-ae60-f28fca99c7e2","msg":"User logged in successfully"}
{"level":30,"time":1768681494547,"env":"test","module":"audit-log-service","userId":"b1ddcb07-e919-49a6-ae60-f28fca99c7e2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681495746,"env":"test","module":"user-credentials-repository","userId":"dba99901-6f7a-4489-a822-14b2f44e6ea0","msg":"User credentials created"}
{"level":30,"time":1768681495868,"env":"test","module":"email-queue","jobId":"707af40c-cc8f-49be-a778-4380d623bc2d","to":"protected-test-NTWIlN8sXT_8g3AbhdhB8@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681495926,"env":"test","module":"auth-routes","userId":"dba99901-6f7a-4489-a822-14b2f44e6ea0","email":"protected-test-NTWIlN8sXT_8g3AbhdhB8@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681496653,"env":"test","module":"auth-routes","userId":"dba99901-6f7a-4489-a822-14b2f44e6ea0","msg":"User logged in successfully"}
{"level":30,"time":1768681496713,"env":"test","module":"audit-log-service","userId":"dba99901-6f7a-4489-a822-14b2f44e6ea0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681496717,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681497143,"env":"test","module":"user-credentials-repository","userId":"0d572dea-b14e-4057-9438-a5f0d91f9f2f","msg":"User credentials created"}
{"level":30,"time":1768681497287,"env":"test","module":"email-queue","jobId":"6a672316-e385-40d0-8b36-7ff701cf0d70","to":"protected-test-CIemQ8abGrGRoUl85ZW5l@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681497345,"env":"test","module":"auth-routes","userId":"0d572dea-b14e-4057-9438-a5f0d91f9f2f","email":"protected-test-CIemQ8abGrGRoUl85ZW5l@example.com","msg":"User registered"}
{"level":30,"time":1768681498063,"env":"test","module":"auth-routes","userId":"0d572dea-b14e-4057-9438-a5f0d91f9f2f","msg":"User logged in successfully"}
{"level":30,"time":1768681498125,"env":"test","module":"audit-log-service","userId":"0d572dea-b14e-4057-9438-a5f0d91f9f2f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681498128,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768681498128,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681498572,"env":"test","module":"user-credentials-repository","userId":"ecf6aa80-8070-46d6-889f-6df7351f92ca","msg":"User credentials created"}
{"level":30,"time":1768681498694,"env":"test","module":"email-queue","jobId":"3365a70a-1e6b-4a3c-8aa4-f22ef1a29d08","to":"protected-test-mZbFfjGIgysX8QjnSryRL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681498753,"env":"test","module":"auth-routes","userId":"ecf6aa80-8070-46d6-889f-6df7351f92ca","email":"protected-test-mZbFfjGIgysX8QjnSryRL@example.com","msg":"User registered"}
{"level":30,"time":1768681499474,"env":"test","module":"auth-routes","userId":"ecf6aa80-8070-46d6-889f-6df7351f92ca","msg":"User logged in successfully"}
{"level":30,"time":1768681499531,"env":"test","module":"audit-log-service","userId":"ecf6aa80-8070-46d6-889f-6df7351f92ca","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681499535,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681500148,"env":"test","module":"user-credentials-repository","userId":"783f1aad-7729-4630-86c7-6ac5243ec45f","msg":"User credentials created"}
{"level":30,"time":1768681500261,"env":"test","module":"email-queue","jobId":"b0446cc6-a5a5-42c3-bf64-d3bd5aef8d5b","to":"protected-test-qtNPo-M2XD_pMnEiYQEgP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681500322,"env":"test","module":"auth-routes","userId":"783f1aad-7729-4630-86c7-6ac5243ec45f","email":"protected-test-qtNPo-M2XD_pMnEiYQEgP@example.com","msg":"User registered"}
{"level":30,"time":1768681501188,"env":"test","module":"auth-routes","userId":"783f1aad-7729-4630-86c7-6ac5243ec45f","msg":"User logged in successfully"}
{"level":30,"time":1768681501243,"env":"test","module":"audit-log-service","userId":"783f1aad-7729-4630-86c7-6ac5243ec45f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681501260,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681501725,"env":"test","module":"user-credentials-repository","userId":"097dcd98-f937-40b2-921e-f24ac8198301","msg":"User credentials created"}
{"level":30,"time":1768681501844,"env":"test","module":"email-queue","jobId":"863322f7-d080-4592-b405-1d29f45cd5ce","to":"protected-test-QpYebj2lD6t4TnRL7ZI-M@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681501903,"env":"test","module":"auth-routes","userId":"097dcd98-f937-40b2-921e-f24ac8198301","email":"protected-test-QpYebj2lD6t4TnRL7ZI-M@example.com","msg":"User registered"}
{"level":30,"time":1768681502677,"env":"test","module":"auth-routes","userId":"097dcd98-f937-40b2-921e-f24ac8198301","msg":"User logged in successfully"}
{"level":30,"time":1768681502739,"env":"test","module":"audit-log-service","userId":"097dcd98-f937-40b2-921e-f24ac8198301","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681502743,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681503188,"env":"test","module":"user-credentials-repository","userId":"d374e754-e18b-4884-be62-70b0bde54675","msg":"User credentials created"}
{"level":30,"time":1768681503308,"env":"test","module":"email-queue","jobId":"ee339308-83b7-4261-b86e-18e57baad5f2","to":"protected-test-b-1iwYsIMXH9ZUN-TEcgR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681503369,"env":"test","module":"auth-routes","userId":"d374e754-e18b-4884-be62-70b0bde54675","email":"protected-test-b-1iwYsIMXH9ZUN-TEcgR@example.com","msg":"User registered"}
{"level":30,"time":1768681504118,"env":"test","module":"auth-routes","userId":"d374e754-e18b-4884-be62-70b0bde54675","msg":"User logged in successfully"}
{"level":30,"time":1768681504175,"env":"test","module":"audit-log-service","userId":"d374e754-e18b-4884-be62-70b0bde54675","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681504180,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681504662,"env":"test","module":"user-credentials-repository","userId":"db315243-b7c8-40a7-aa5e-6a76cdefc4d9","msg":"User credentials created"}
{"level":30,"time":1768681504783,"env":"test","module":"email-queue","jobId":"f7b62931-2345-437a-97ed-d67e09fb30af","to":"protected-test-IfQ8t0AQZG_Www5Mop8kf@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681504842,"env":"test","module":"auth-routes","userId":"db315243-b7c8-40a7-aa5e-6a76cdefc4d9","email":"protected-test-IfQ8t0AQZG_Www5Mop8kf@example.com","msg":"User registered"}
{"level":30,"time":1768681505553,"env":"test","module":"auth-routes","userId":"db315243-b7c8-40a7-aa5e-6a76cdefc4d9","msg":"User logged in successfully"}
{"level":30,"time":1768681505615,"env":"test","module":"audit-log-service","userId":"db315243-b7c8-40a7-aa5e-6a76cdefc4d9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681505619,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681506056,"env":"test","module":"user-credentials-repository","userId":"802bf543-a84a-43fe-8120-cd8231c68755","msg":"User credentials created"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681506177,"env":"test","module":"email-queue","jobId":"235183c2-6618-4f21-9bfa-9a674cf067c9","to":"protected-test-26qh_qdrq5cPTf7-CT84T@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681506240,"env":"test","module":"auth-routes","userId":"802bf543-a84a-43fe-8120-cd8231c68755","email":"protected-test-26qh_qdrq5cPTf7-CT84T@example.com","msg":"User registered"}
{"level":30,"time":1768681506983,"env":"test","module":"auth-routes","userId":"802bf543-a84a-43fe-8120-cd8231c68755","msg":"User logged in successfully"}
{"level":50,"time":1768681507182,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"802bf543-a84a-43fe-8120-cd8231c68755","login_success","security","802bf543-a84a-43fe-8120-cd8231c68755","security","802bf543-a84a-43fe-8120-cd8231c68755","{\"metadata\":{\"timestamp\":\"2026-01-17T20:25:06.983Z\"}}","::1",null,"2026-01-17T20:25:06.983Z"],"cause":{"length":322,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(802bf543-a84a-43fe-8120-cd8231c68755) is not present in table \"users\".","schema":"test_schema_w5_v3","table":"audit_logs","constraint":"audit_logs_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"802bf543-a84a-43fe-8120-cd8231c68755","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768681507194,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":[null,null,"802bf543-a84a-43fe-8120-cd8231c68755","login_success","security","802bf543-a84a-43fe-8120-cd8231c68755","security","802bf543-a84a-43fe-8120-cd8231c68755","{\"metadata\":{\"timestamp\":\"2026-01-17T20:25:06.983Z\"}}","::1",null,"2026-01-17T20:25:06.983Z"],"cause":{"length":322,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(802bf543-a84a-43fe-8120-cd8231c68755) is not present in table \"users\".","schema":"test_schema_w5_v3","table":"audit_logs","constraint":"audit_logs_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
{"level":50,"time":1768681508013,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["10fafc05-9bfe-4531-bb9b-be8ded63ae8f","$2b$12$o4Udvptjwi9CIhIOdd.MxeRMroMV.ZyHBwfF2f7Cl0c6ByhCz.ke."],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(10fafc05-9bfe-4531-bb9b-be8ded63ae8f) is not present in table \"users\".","schema":"test_schema_w1_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"10fafc05-9bfe-4531-bb9b-be8ded63ae8f","msg":"Failed to create user credentials"}
{"level":50,"time":1768681508013,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["10fafc05-9bfe-4531-bb9b-be8ded63ae8f","$2b$12$o4Udvptjwi9CIhIOdd.MxeRMroMV.ZyHBwfF2f7Cl0c6ByhCz.ke."],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(10fafc05-9bfe-4531-bb9b-be8ded63ae8f) is not present in table \"users\".","schema":"test_schema_w1_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681508859,"env":"test","module":"user-credentials-repository","userId":"ddea6e54-ae68-485b-a9f4-3f32082368cc","msg":"User credentials created"}
{"level":30,"time":1768681508974,"env":"test","module":"email-queue","jobId":"82fbff8d-9345-453b-910e-a4a1802177bc","to":"protected-test-vLIs0SFMZUtMsICvn0zar@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681509031,"env":"test","module":"auth-routes","userId":"ddea6e54-ae68-485b-a9f4-3f32082368cc","email":"protected-test-vLIs0SFMZUtMsICvn0zar@example.com","msg":"User registered"}
{"level":30,"time":1768681509926,"env":"test","module":"user-credentials-repository","userId":"094c7f0d-451c-418c-a9e4-3178fd313eb5","msg":"User credentials created"}
{"level":30,"time":1768681510018,"env":"test","module":"email-queue","jobId":"b34bbacd-0b08-4675-83ca-ec4a7ddb0025","to":"protected-test-tpfBTZdJBtv6N3lCB0TSW@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681510066,"env":"test","module":"auth-routes","userId":"094c7f0d-451c-418c-a9e4-3178fd313eb5","email":"protected-test-tpfBTZdJBtv6N3lCB0TSW@example.com","msg":"User registered"}
{"level":50,"time":1768681510219,"env":"test","module":"auth-routes","email":"protected-test-tpfBTZdJBtv6N3lCB0TSW@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768681510321,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768681510737,"env":"test","module":"user-credentials-repository","userId":"db120b0d-998d-4000-9c9b-50ec177a5071","msg":"User credentials created"}
{"level":30,"time":1768681510830,"env":"test","module":"email-queue","jobId":"816c2d29-13bb-486b-a27c-7eac720ac9db","to":"protected-test-5RRn9SHxgRNxVV1ZmLrBh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681510881,"env":"test","module":"auth-routes","userId":"db120b0d-998d-4000-9c9b-50ec177a5071","email":"protected-test-5RRn9SHxgRNxVV1ZmLrBh@example.com","msg":"User registered"}
{"level":50,"time":1768681511030,"env":"test","module":"auth-routes","email":"protected-test-5RRn9SHxgRNxVV1ZmLrBh@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768681511124,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1768681511566,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["f440ee93-3cee-4761-9626-9783cce2cc62","$2b$12$xhgKOhxOmPmXebnDxaOiGeVEdI8.9PhjR.L2HWgYMiPc2kv2F3U6q"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f440ee93-3cee-4761-9626-9783cce2cc62) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"f440ee93-3cee-4761-9626-9783cce2cc62","msg":"Failed to create user credentials"}
{"level":50,"time":1768681511566,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["f440ee93-3cee-4761-9626-9783cce2cc62","$2b$12$xhgKOhxOmPmXebnDxaOiGeVEdI8.9PhjR.L2HWgYMiPc2kv2F3U6q"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f440ee93-3cee-4761-9626-9783cce2cc62) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768681512365,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["d4ee8356-ab51-4936-aba4-92f67447fadf","$2b$12$KBWoNkNal/2mtqoA34Z34u.mCjM4D7FKvtKbIiSsos43PHcBx6/7y"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(d4ee8356-ab51-4936-aba4-92f67447fadf) is not present in table \"users\".","schema":"test_schema_w6_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"d4ee8356-ab51-4936-aba4-92f67447fadf","msg":"Failed to create user credentials"}
{"level":50,"time":1768681512365,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["d4ee8356-ab51-4936-aba4-92f67447fadf","$2b$12$KBWoNkNal/2mtqoA34Z34u.mCjM4D7FKvtKbIiSsos43PHcBx6/7y"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(d4ee8356-ab51-4936-aba4-92f67447fadf) is not present in table \"users\".","schema":"test_schema_w6_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768681513269,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["6e649a82-7038-4564-8c88-a8cf1dd7d2c0","$2b$12$9oDNHID6vdQ4H7dJNQVco.oI2SrKwpMFgiqSt8oPPU5WG0vMrV5iq"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(6e649a82-7038-4564-8c88-a8cf1dd7d2c0) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"6e649a82-7038-4564-8c88-a8cf1dd7d2c0","msg":"Failed to create user credentials"}
{"level":50,"time":1768681513269,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["6e649a82-7038-4564-8c88-a8cf1dd7d2c0","$2b$12$9oDNHID6vdQ4H7dJNQVco.oI2SrKwpMFgiqSt8oPPU5WG0vMrV5iq"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(6e649a82-7038-4564-8c88-a8cf1dd7d2c0) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681514316,"env":"test","module":"user-credentials-repository","userId":"0b5361c4-1c95-416e-a770-51d6203589bd","msg":"User credentials created"}
{"level":30,"time":1768681514440,"env":"test","module":"email-queue","jobId":"7126d9d9-8d21-4ccd-a385-c7f5e9b69e57","to":"protected-test-EBElQjsl0gmbhatbacuLn@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768681514525,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["0b5361c4-1c95-416e-a770-51d6203589bd","08ab79cce35e80737a9a0f6494eb744ef1a00d319a5590284d72c711fe0b8ba0","2026-02-16T20:25:14.440Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T20:25:14.440Z"],"cause":{"length":338,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(0b5361c4-1c95-416e-a770-51d6203589bd) is not present in table \"users\".","schema":"test_schema_w5_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681515325,"env":"test","module":"user-credentials-repository","userId":"004b1025-7f20-4d42-ab17-6080d001cdbc","msg":"User credentials created"}
{"level":30,"time":1768681515425,"env":"test","module":"email-queue","jobId":"8d0f22d0-b063-4c27-b635-59842ed8c78b","to":"protected-test-9RtmL7qlBb8a3ylKwu_-K@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681515472,"env":"test","module":"auth-routes","userId":"004b1025-7f20-4d42-ab17-6080d001cdbc","email":"protected-test-9RtmL7qlBb8a3ylKwu_-K@example.com","msg":"User registered"}
{"level":30,"time":1768681516112,"env":"test","module":"auth-routes","userId":"004b1025-7f20-4d42-ab17-6080d001cdbc","msg":"User logged in successfully"}
{"level":30,"time":1768681516159,"env":"test","module":"audit-log-service","userId":"004b1025-7f20-4d42-ab17-6080d001cdbc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681516768,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["004b1025-7f20-4d42-ab17-6080d001cdbc","eefd306f8d517efb29068f8109a3ae8766e95bd3619a99011a114810c173b5ba","2026-02-16T20:25:16.698Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T20:25:16.698Z"],"cause":{"length":338,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(004b1025-7f20-4d42-ab17-6080d001cdbc) is not present in table \"users\".","schema":"test_schema_w5_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
{"level":30,"time":1768681517635,"env":"test","module":"user-credentials-repository","userId":"55dfa892-91bc-4c86-9e73-0e9f5d695da1","msg":"User credentials created"}
{"level":30,"time":1768681517755,"env":"test","module":"email-queue","jobId":"b4af4793-f0fd-4eff-8b59-26df384aa97a","to":"protected-test-0Uw8pt5x4ShtQ0SaIdWCs@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681517811,"env":"test","module":"auth-routes","userId":"55dfa892-91bc-4c86-9e73-0e9f5d695da1","email":"protected-test-0Uw8pt5x4ShtQ0SaIdWCs@example.com","msg":"User registered"}
{"level":30,"time":1768681518539,"env":"test","module":"auth-routes","userId":"55dfa892-91bc-4c86-9e73-0e9f5d695da1","msg":"User logged in successfully"}
{"level":30,"time":1768681518599,"env":"test","module":"audit-log-service","userId":"55dfa892-91bc-4c86-9e73-0e9f5d695da1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
DEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768681519132,"env":"test","module":"intake-routes","error":{},"msg":"Error creating intake run"}
{"level":50,"time":1768681519538,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["88a75b5a-d8c7-4619-8640-023bb65f4a17","$2b$12$4QQU4oKp4LuCpkk6H0gWQO6hIA7fECCI3qTgilkm/wJqOa1urjSsK"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(88a75b5a-d8c7-4619-8640-023bb65f4a17) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"88a75b5a-d8c7-4619-8640-023bb65f4a17","msg":"Failed to create user credentials"}
{"level":50,"time":1768681519538,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["88a75b5a-d8c7-4619-8640-023bb65f4a17","$2b$12$4QQU4oKp4LuCpkk6H0gWQO6hIA7fECCI3qTgilkm/wJqOa1urjSsK"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(88a75b5a-d8c7-4619-8640-023bb65f4a17) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681520260,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681520260,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
DEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
AUDIT LOG ERROR: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,802bf543-a84a-43fe-8120-cd8231c68755,login_success,security,802bf543-a84a-43fe-8120-cd8231c68755,security,802bf543-a84a-43fe-8120-cd8231c68755,{"metadata":{"timestamp":"2026-01-17T20:25:06.983Z"}},::1,,2026-01-17T20:25:06.983Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"',
  params: [
    null,
    null,
    '802bf543-a84a-43fe-8120-cd8231c68755',
    'login_success',
    'security',
    '802bf543-a84a-43fe-8120-cd8231c68755',
    'security',
    '802bf543-a84a-43fe-8120-cd8231c68755',
    '{"metadata":{"timestamp":"2026-01-17T20:25:06.983Z"}}',
    '::1',
    null,
    '2026-01-17T20:25:06.983Z'
  ],
  cause: error: insert or update on table "audit_logs" violates foreign key constraint "audit_logs_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
    length: 322,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(802bf543-a84a-43fe-8120-cd8231c68755) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w5_v3',
    table: 'audit_logs',
    column: undefined,
    dataType: undefined,
    constraint: 'audit_logs_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ,,802bf543-a84a-43fe-8120-cd8231c68755,login_success,security,802bf543-a84a-43fe-8120-cd8231c68755,security,802bf543-a84a-43fe-8120-cd8231c68755,{"metadata":{"timestamp":"2026-01-17T20:25:06.983Z"}},::1,,2026-01-17T20:25:06.983Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
  query: 'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default, $10, $11, default, $12) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"',
  params: [
    null,
    null,
    '802bf543-a84a-43fe-8120-cd8231c68755',
    'login_success',
    'security',
    '802bf543-a84a-43fe-8120-cd8231c68755',
    'security',
    '802bf543-a84a-43fe-8120-cd8231c68755',
    '{"metadata":{"timestamp":"2026-01-17T20:25:06.983Z"}}',
    '::1',
    null,
    '2026-01-17T20:25:06.983Z'
  ],
  cause: error: insert or update on table "audit_logs" violates foreign key constraint "audit_logs_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:99:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:329:7 {
    length: 322,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(802bf543-a84a-43fe-8120-cd8231c68755) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w5_v3',
    table: 'audit_logs',
    column: undefined,
    dataType: undefined,
    constraint: 'audit_logs_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
DEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
DEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:56:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:307:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
DEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
Login Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: 004b1025-7f20-4d42-ab17-6080d001cdbc,eefd306f8d517efb29068f8109a3ae8766e95bd3619a99011a114810c173b5ba,2026-02-16T20:25:16.698Z,false,{"ip":"::1"},,::1,Location Unknown,2026-01-17T20:25:16.698Z
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
  query: 'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)',
  params: [
    '004b1025-7f20-4d42-ab17-6080d001cdbc',
    'eefd306f8d517efb29068f8109a3ae8766e95bd3619a99011a114810c173b5ba',
    '2026-02-16T20:25:16.698Z',
    false,
    '{"ip":"::1"}',
    null,
    '::1',
    'Location Unknown',
    '2026-01-17T20:25:16.698Z'
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:153:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:326:24 {
    length: 338,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(004b1025-7f20-4d42-ab17-6080d001cdbc) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w5_v3',
    table: 'refresh_tokens',
    column: undefined,
    dataType: undefined,
    constraint: 'refresh_tokens_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2599',
    routine: 'ri_ReportViolation'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
DEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Cleanup error: DrizzleQueryError: Failed query: delete from "tenants" where "tenants"."id" = $1
params: b3c0b519-0275-43fc-a255-f39cf3341a31
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at Object.cleanup (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:173:11)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:41:9 {
  query: 'delete from "tenants" where "tenants"."id" = $1',
  params: [ 'b3c0b519-0275-43fc-a255-f39cf3341a31' ],
  cause: error: update or delete on table "users" violates foreign key constraint "audit_logs_user_id_users_id_fk" on table "audit_logs"
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at Object.cleanup (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:173:11)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:41:9 {
    length: 346,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (id)=(ed393f9b-414c-4a87-ad79-57ea9337289e) is still referenced from table "audit_logs".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'test_schema_w0_v3',
    table: 'audit_logs',
    column: undefined,
    dataType: undefined,
    constraint: 'audit_logs_user_id_users_id_fk',
    file: 'ri_triggers.c',
    line: '2612',
    routine: 'ri_ReportViolation'
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 12 failed | 1 skipped) 49127ms
       Γ£ô should allow access with valid Bearer token  1411ms
       Γ£ô should reject access without Authorization header  1395ms
       Γ£ô should reject access with empty Bearer token  1396ms
       Γ£ô should reject access with malformed Authorization header  1331ms
       Γ£ô should reject access with wrong token type  1416ms
       Γ£ô should allow POST with valid Bearer token  1396ms
       Γ£ô should reject POST without Bearer token  1362ms
       Γ£ô should reject POST with invalid token  1360ms
       Γ£ô should allow PUT with valid Bearer token  1547ms
       Γ£ô should reject PUT without Bearer token  1327ms
       Γ£ô should allow DELETE with valid Bearer token  1533ms
       Γ£ô should reject DELETE without Bearer token  1469ms
       Γ£ô should allow PATCH with valid Bearer token  2167ms
       Γ£ô should reject PATCH without Bearer token  1398ms
       Γ£ô should handle Bearer token with extra spaces  1411ms
       Γåô should handle token with newlines
       Γ£ô should handle very long invalid token  1407ms
       Γ£ô should handle empty Authorization header  1726ms
       Γ£ô should handle Authorization header with only Bearer  1481ms
       Γ£ô should handle multiple Authorization headers  1438ms
       Γ£ô should reject token with SQL injection attempt  1437ms
       ├ù should reject token with XSS attempt 1588ms
       ├ù should reject token with missing userId 808ms
       ├ù should reject token with non-existent userId 1147ms
       ├ù should not allow user to access another user's resources 1161ms
       ├ù should inject userId into request context 803ms
       ├ù should inject tenantId into request context 441ms
       ├ù should inject role into request context 798ms
       ├ù should not apply general rate limiting to authenticated requests 904ms
       ├ù should handle request with both Bearer token and cookies 1256ms
       ├ù should prioritize Bearer token over cookie when both present 2245ms
       ├ù should allow unauthenticated access to optional auth routes 2362ms
       ├ù should enhance optional auth routes with user context when authenticated 407ms

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Tests 12 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
Error: expected 200 "OK", got 500 "Internal Server Error"
 Γ¥» tests/integration/auth/protected.routes.test.ts:84:14
 Γ¥» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Γ¥» node_modules/supertest/lib/test.js:365:13
 Γ¥» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Γ¥» Test.assert node_modules/supertest/lib/test.js:195:23
 Γ¥» localAssert node_modules/supertest/lib/test.js:138:14
 Γ¥» node_modules/supertest/lib/test.js:156:7
 Γ¥» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Γ¥» node_modules/superagent/lib/node/index.js:1102:18
 Γ¥» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/12]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Error: expected 201 "Created", got 500 "Internal Server Error"
 Γ¥» tests/integration/auth/protected.routes.test.ts:56:14
 Γ¥» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Γ¥» node_modules/supertest/lib/test.js:365:13
 Γ¥» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Γ¥» Test.assert node_modules/supertest/lib/test.js:195:23
 Γ¥» localAssert node_modules/supertest/lib/test.js:138:14
 Γ¥» node_modules/supertest/lib/test.js:156:7
 Γ¥» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Γ¥» node_modules/superagent/lib/node/index.js:1102:18
 Γ¥» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/12]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
Error: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 029d7581-168d-4a11-ad8d-6fd4879fd1af,ddea6e54-ae68-485b-a9f4-3f32082368cc,admin
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:71:13

Caused by: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:71:13

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 399, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(029d7581-168d-4a11-ad8d-6fd4879fd1af) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[3/12]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
Error: expected 200 "OK", got 401 "Unauthorized"
 Γ¥» tests/integration/auth/protected.routes.test.ts:84:14
 Γ¥» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Γ¥» node_modules/supertest/lib/test.js:365:13
 Γ¥» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Γ¥» Test.assert node_modules/supertest/lib/test.js:195:23
 Γ¥» localAssert node_modules/supertest/lib/test.js:138:14
 Γ¥» node_modules/supertest/lib/test.js:156:7
 Γ¥» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Γ¥» node_modules/superagent/lib/node/index.js:1102:18
 Γ¥» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[4/12]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
Error: expected 200 "OK", got 500 "Internal Server Error"
 Γ¥» tests/integration/auth/protected.routes.test.ts:448:18
 Γ¥» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Γ¥» node_modules/supertest/lib/test.js:365:13
 Γ¥» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Γ¥» Test.assert node_modules/supertest/lib/test.js:195:23
 Γ¥» localAssert node_modules/supertest/lib/test.js:138:14
 Γ¥» node_modules/supertest/lib/test.js:156:7
 Γ¥» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Γ¥» node_modules/superagent/lib/node/index.js:1102:18
 Γ¥» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[5/12]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
Error: expected 201 "Created", got 404 "Not Found"
 Γ¥» tests/integration/auth/protected.routes.test.ts:513:18
 Γ¥» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Γ¥» node_modules/supertest/lib/test.js:365:13
 Γ¥» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Γ¥» Test.assert node_modules/supertest/lib/test.js:195:23
 Γ¥» localAssert node_modules/supertest/lib/test.js:138:14
 Γ¥» node_modules/supertest/lib/test.js:156:7
 Γ¥» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Γ¥» node_modules/superagent/lib/node/index.js:1102:18
 Γ¥» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[6/12]ΓÄ»


 Test Files  1 failed (1)
      Tests  12 failed | 20 passed | 1 skipped (33)
   Start at  14:24:19
   Duration  60.33s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x15 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681613603,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

{"level":30,"time":1768681623979,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681623980,"env":"test","msg":"DB: Configured pool.connect() to set search_path=\"test_schema_w0_v3\",public on all clients"}
stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681628030,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Enforced search_path: test_schema_w0_v3, public

stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Database initialized. Current schema: test_schema_w0_v3
ΓÅ⌐ Schema reused, skipping migrations.

{"level":30,"time":1768681629604,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681629623,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768681629612,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681629613,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681629617,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681629618,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681629622,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681629622,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681629623,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681629623,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768681630064,"env":"test","module":"user-credentials-repository","userId":"f6918f1a-68e0-4ad6-b43b-551aaafd5029","msg":"User credentials created"}
{"level":30,"time":1768681630151,"env":"test","module":"email-queue","jobId":"d91d2404-f2eb-4813-8999-c83996567ff2","to":"test-SMNbB_ytUz1U23OIZgjQu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681630199,"env":"test","module":"auth-routes","userId":"f6918f1a-68e0-4ad6-b43b-551aaafd5029","email":"test-SMNbB_ytUz1U23OIZgjQu@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à Applied failsafe schema fixes

{"level":30,"time":1768681630819,"env":"test","module":"user-credentials-repository","userId":"dce9ec33-cbed-4ab4-9a3a-a662c63cd8c8","msg":"User credentials created"}
{"level":30,"time":1768681630910,"env":"test","module":"email-queue","jobId":"99a008f7-dcdc-4582-b606-e9844520cd4b","to":"protected-test-t8zF3F5-KBZ0oCuwfWrws@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681630958,"env":"test","module":"auth-routes","userId":"dce9ec33-cbed-4ab4-9a3a-a662c63cd8c8","email":"protected-test-t8zF3F5-KBZ0oCuwfWrws@example.com","msg":"User registered"}
{"level":30,"time":1768681631774,"env":"test","module":"user-credentials-repository","userId":"9b28aa1f-a573-4f3a-ba02-ed3ad4f27684","msg":"User credentials created"}
stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w139_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w140_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w139_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681631869,"env":"test","module":"email-queue","jobId":"c5696385-09e1-4560-81ac-bd1ac0f34916","to":"protected-test-1AX1RFgrcsyqguwy7VSy6@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681631913,"env":"test","module":"auth-routes","userId":"9b28aa1f-a573-4f3a-ba02-ed3ad4f27684","email":"protected-test-1AX1RFgrcsyqguwy7VSy6@example.com","msg":"User registered"}
{"level":30,"time":1768681632709,"env":"test","module":"user-credentials-repository","userId":"e9a0b477-c9f3-4805-9e3e-b7681e7ca2cf","msg":"User credentials created"}
{"level":30,"time":1768681632825,"env":"test","module":"email-queue","jobId":"0b16eeae-d665-4527-8543-93380c985dbf","to":"protected-test-caxUtWe5sL2MSGCGIVmOD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
stdout | tests/integration/auth/protected.routes.test.ts
DEBUG: Dropping existing function: test_schema_w140_v3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768681632882,"env":"test","module":"auth-routes","userId":"e9a0b477-c9f3-4805-9e3e-b7681e7ca2cf","email":"protected-test-caxUtWe5sL2MSGCGIVmOD@example.com","msg":"User registered"}
{"level":30,"time":1768681633590,"env":"test","module":"user-credentials-repository","userId":"396989f6-9ef6-49f4-ac15-4e5f4add91c1","msg":"User credentials created"}
{"level":30,"time":1768681633686,"env":"test","module":"email-queue","jobId":"e114db25-9275-402a-a1d3-5867d15f1770","to":"protected-test-92OISgNdRUJ7o7WtCsHXK@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681633729,"env":"test","module":"auth-routes","userId":"396989f6-9ef6-49f4-ac15-4e5f4add91c1","email":"protected-test-92OISgNdRUJ7o7WtCsHXK@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

{"level":30,"time":1768681634413,"env":"test","module":"user-credentials-repository","userId":"c2fd1a14-8c02-421a-975a-7166a5d70f56","msg":"User credentials created"}
{"level":30,"time":1768681634507,"env":"test","module":"email-queue","jobId":"38630117-7506-4171-8918-79a5be892714","to":"protected-test-PRzgk-eC2gU27sCKGhPMh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681634560,"env":"test","module":"auth-routes","userId":"c2fd1a14-8c02-421a-975a-7166a5d70f56","email":"protected-test-PRzgk-eC2gU27sCKGhPMh@example.com","msg":"User registered"}
{"level":30,"time":1768681635347,"env":"test","module":"user-credentials-repository","userId":"981161f7-1d35-495c-8a4a-9a6425980e8e","msg":"User credentials created"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681635463,"env":"test","module":"email-queue","jobId":"04342912-fdbb-484b-8f2e-3693ee8fdbbf","to":"protected-test-lfcbvdOHPIpS1cK3-d7tV@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768681635520,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["981161f7-1d35-495c-8a4a-9a6425980e8e","adf16fd618ef6663779f3ce4eaa1816a99ffdb9bc52d52a116b438155d388a81","2026-02-16T20:27:15.464Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T20:27:15.464Z"],"cause":{"length":338,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(981161f7-1d35-495c-8a4a-9a6425980e8e) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681636263,"env":"test","module":"user-credentials-repository","userId":"41376f31-f750-4715-a9ae-e363b54fc9c8","msg":"User credentials created"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768681636378,"env":"test","module":"email-queue","jobId":"7cc60c9f-510e-4992-ba42-af98971a2e12","to":"protected-test-BWfYVgIuEGFYkhpmCGrP1@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681636434,"env":"test","module":"auth-routes","userId":"41376f31-f750-4715-a9ae-e363b54fc9c8","email":"protected-test-BWfYVgIuEGFYkhpmCGrP1@example.com","msg":"User registered"}
{"level":30,"time":1768681637102,"env":"test","module":"auth-routes","userId":"41376f31-f750-4715-a9ae-e363b54fc9c8","msg":"User logged in successfully"}
{"level":30,"time":1768681637157,"env":"test","module":"audit-log-service","userId":"41376f31-f750-4715-a9ae-e363b54fc9c8","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681637162,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681637551,"env":"test","module":"user-credentials-repository","userId":"41e3f722-00ea-49b7-a0c7-f511679712ed","msg":"User credentials created"}
{"level":30,"time":1768681637661,"env":"test","module":"email-queue","jobId":"5e39ae30-c984-4cf1-8b7b-6ee3054c3020","to":"protected-test-4L64kurKmPwiXZdYPgn2E@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681637719,"env":"test","module":"auth-routes","userId":"41e3f722-00ea-49b7-a0c7-f511679712ed","email":"protected-test-4L64kurKmPwiXZdYPgn2E@example.com","msg":"User registered"}
{"level":30,"time":1768681638389,"env":"test","module":"auth-routes","userId":"41e3f722-00ea-49b7-a0c7-f511679712ed","msg":"User logged in successfully"}
{"level":30,"time":1768681638445,"env":"test","module":"audit-log-service","userId":"41e3f722-00ea-49b7-a0c7-f511679712ed","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681638450,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681638859,"env":"test","module":"user-credentials-repository","userId":"494a62e2-2391-406b-bf32-356c9e7e25b5","msg":"User credentials created"}
{"level":30,"time":1768681638972,"env":"test","module":"email-queue","jobId":"cfd4e436-aa1f-48b5-bb58-767c77289c48","to":"protected-test-u6t5PLq-PLeeiwjOdKiRt@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681639027,"env":"test","module":"auth-routes","userId":"494a62e2-2391-406b-bf32-356c9e7e25b5","email":"protected-test-u6t5PLq-PLeeiwjOdKiRt@example.com","msg":"User registered"}
{"level":30,"time":1768681639687,"env":"test","module":"auth-routes","userId":"494a62e2-2391-406b-bf32-356c9e7e25b5","msg":"User logged in successfully"}
{"level":30,"time":1768681639746,"env":"test","module":"audit-log-service","userId":"494a62e2-2391-406b-bf32-356c9e7e25b5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[DEBUG] BaseRepository.update users: id=494a62e2-2391-406b-bf32-356c9e7e25b5, updates={"defaultMode":"advanced","updatedAt":"2026-01-17T20:27:19.860Z"}
{"level":30,"time":1768681640306,"env":"test","module":"user-credentials-repository","userId":"f584fc13-84cc-4170-af11-3eae1c3985de","msg":"User credentials created"}
{"level":30,"time":1768681640418,"env":"test","module":"email-queue","jobId":"b6ee1534-25e2-47ac-a430-eace04a06c0e","to":"protected-test-YkFKdhnIhdsY7hchNMqK0@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681640479,"env":"test","module":"auth-routes","userId":"f584fc13-84cc-4170-af11-3eae1c3985de","email":"protected-test-YkFKdhnIhdsY7hchNMqK0@example.com","msg":"User registered"}
{"level":30,"time":1768681641157,"env":"test","module":"auth-routes","userId":"f584fc13-84cc-4170-af11-3eae1c3985de","msg":"User logged in successfully"}
{"level":30,"time":1768681641212,"env":"test","module":"audit-log-service","userId":"f584fc13-84cc-4170-af11-3eae1c3985de","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681641216,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681641607,"env":"test","module":"user-credentials-repository","userId":"b1dcb46b-aff7-4700-84fd-3478d76b1df9","msg":"User credentials created"}
{"level":30,"time":1768681641718,"env":"test","module":"email-queue","jobId":"a9120413-9efb-49ea-b5f5-a500f0c6bb9d","to":"protected-test-yg1Reb2h1X3UW0LmMzPYk@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681641773,"env":"test","module":"auth-routes","userId":"b1dcb46b-aff7-4700-84fd-3478d76b1df9","email":"protected-test-yg1Reb2h1X3UW0LmMzPYk@example.com","msg":"User registered"}
{"level":30,"time":1768681642441,"env":"test","module":"auth-routes","userId":"b1dcb46b-aff7-4700-84fd-3478d76b1df9","msg":"User logged in successfully"}
{"level":30,"time":1768681642497,"env":"test","module":"audit-log-service","userId":"b1dcb46b-aff7-4700-84fd-3478d76b1df9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681643082,"env":"test","module":"user-credentials-repository","userId":"e301576c-4c8b-422e-9292-e5a7f2c8d501","msg":"User credentials created"}
{"level":30,"time":1768681643195,"env":"test","module":"email-queue","jobId":"befd2a59-641c-4a96-8c8f-bcca00dd0c7a","to":"protected-test-C6IRDMgGNh86C52IWK7t-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681643257,"env":"test","module":"auth-routes","userId":"e301576c-4c8b-422e-9292-e5a7f2c8d501","email":"protected-test-C6IRDMgGNh86C52IWK7t-@example.com","msg":"User registered"}
{"level":30,"time":1768681643925,"env":"test","module":"auth-routes","userId":"e301576c-4c8b-422e-9292-e5a7f2c8d501","msg":"User logged in successfully"}
{"level":30,"time":1768681643979,"env":"test","module":"audit-log-service","userId":"e301576c-4c8b-422e-9292-e5a7f2c8d501","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681643983,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681644373,"env":"test","module":"user-credentials-repository","userId":"34f0193e-22c9-4382-bc52-bb1d66684c41","msg":"User credentials created"}
{"level":30,"time":1768681644482,"env":"test","module":"email-queue","jobId":"3d8ce670-54a7-4aee-ac1d-bed4bb2ffde1","to":"protected-test-GpNv8Ky8RP6Y9zgt5r8rq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681644536,"env":"test","module":"auth-routes","userId":"34f0193e-22c9-4382-bc52-bb1d66684c41","email":"protected-test-GpNv8Ky8RP6Y9zgt5r8rq@example.com","msg":"User registered"}
{"level":30,"time":1768681645204,"env":"test","module":"auth-routes","userId":"34f0193e-22c9-4382-bc52-bb1d66684c41","msg":"User logged in successfully"}
{"level":30,"time":1768681645260,"env":"test","module":"audit-log-service","userId":"34f0193e-22c9-4382-bc52-bb1d66684c41","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768681646531,"env":"test","module":"user-credentials-repository","userId":"74242df1-5db5-43a7-83dd-5fd785765ebe","msg":"User credentials created"}
{"level":30,"time":1768681646639,"env":"test","module":"email-queue","jobId":"29021843-cb17-4333-a21c-c8d01002adb9","to":"protected-test-F2ceIJKsdUR2h_Px3Umi9@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681646695,"env":"test","module":"auth-routes","userId":"74242df1-5db5-43a7-83dd-5fd785765ebe","email":"protected-test-F2ceIJKsdUR2h_Px3Umi9@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST without Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should reject PUT without Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should allow DELETE with valid Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > DELETE Protected Routes > should reject DELETE without Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should allow PATCH with valid Bearer token
DEBUG: LOGIN HANDLER HIT

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PATCH Protected Routes > should reject PATCH without Bearer token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681647361,"env":"test","module":"auth-routes","userId":"74242df1-5db5-43a7-83dd-5fd785765ebe","msg":"User logged in successfully"}
{"level":30,"time":1768681647424,"env":"test","module":"audit-log-service","userId":"74242df1-5db5-43a7-83dd-5fd785765ebe","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681647429,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681647824,"env":"test","module":"user-credentials-repository","userId":"60692b89-5ce7-4a72-8583-2068cdf50186","msg":"User credentials created"}
{"level":30,"time":1768681647934,"env":"test","module":"email-queue","jobId":"706bd556-b435-4021-893e-a248a0531593","to":"protected-test-cTn9T5YIUETlamwefjLKJ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681647988,"env":"test","module":"auth-routes","userId":"60692b89-5ce7-4a72-8583-2068cdf50186","email":"protected-test-cTn9T5YIUETlamwefjLKJ@example.com","msg":"User registered"}
{"level":30,"time":1768681648684,"env":"test","module":"auth-routes","userId":"60692b89-5ce7-4a72-8583-2068cdf50186","msg":"User logged in successfully"}
{"level":30,"time":1768681648739,"env":"test","module":"audit-log-service","userId":"60692b89-5ce7-4a72-8583-2068cdf50186","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768681648743,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768681648744,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768681649156,"env":"test","module":"user-credentials-repository","userId":"a41e85ff-591f-47c5-a0b4-8c18c51f5b63","msg":"User credentials created"}
{"level":30,"time":1768681649272,"env":"test","module":"email-queue","jobId":"db9f839c-4c12-4f13-8067-6683296b88b6","to":"protected-test--hpsma08b3-H4Zu02U3jT@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681649329,"env":"test","module":"auth-routes","userId":"a41e85ff-591f-47c5-a0b4-8c18c51f5b63","email":"protected-test--hpsma08b3-H4Zu02U3jT@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Bearer token with extra spaces
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681649998,"env":"test","module":"auth-routes","userId":"a41e85ff-591f-47c5-a0b4-8c18c51f5b63","msg":"User logged in successfully"}
{"level":30,"time":1768681650053,"env":"test","module":"audit-log-service","userId":"a41e85ff-591f-47c5-a0b4-8c18c51f5b63","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768681650057,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768681650458,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["981c9262-4e2e-49cc-a3ef-2049c54b6166","$2b$12$xGLAyJhhQeLHbV2GY2nuke2.ZTKG49HZWHEj0UW0uWd3y3nDCSTx6"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(981c9262-4e2e-49cc-a3ef-2049c54b6166) is not present in table \"users\".","schema":"test_schema_w140_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"981c9262-4e2e-49cc-a3ef-2049c54b6166","msg":"Failed to create user credentials"}
{"level":50,"time":1768681650458,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["981c9262-4e2e-49cc-a3ef-2049c54b6166","$2b$12$xGLAyJhhQeLHbV2GY2nuke2.ZTKG49HZWHEj0UW0uWd3y3nDCSTx6"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(981c9262-4e2e-49cc-a3ef-2049c54b6166) is not present in table \"users\".","schema":"test_schema_w140_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681651110,"env":"test","module":"user-credentials-repository","userId":"81076fd8-a992-4a76-90a2-a539b663a9fc","msg":"User credentials created"}
{"level":30,"time":1768681651201,"env":"test","module":"email-queue","jobId":"08b09ba3-b2f9-4e27-9aec-9a52d65d9391","to":"protected-test-mGnQb7vgiBm2DysUFy7Lx@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768681651247,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["81076fd8-a992-4a76-90a2-a539b663a9fc","35519ce40baf18f096c9831fd87763db968bfc0d2bd99dab15052c83241efce7","2026-02-16T20:27:31.202Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-17T20:27:31.202Z"],"cause":{"length":340,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(81076fd8-a992-4a76-90a2-a539b663a9fc) is not present in table \"users\".","schema":"test_schema_w140_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768681651901,"env":"test","module":"user-credentials-repository","userId":"a4b47835-6b54-47b6-9440-697fb4c18c22","msg":"User credentials created"}
{"level":30,"time":1768681651995,"env":"test","module":"email-queue","jobId":"e8f6f279-0f70-45a4-b9de-8d9b834c523f","to":"protected-test-o_KxkyrpA7FlPwp41RAoE@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681652040,"env":"test","module":"auth-routes","userId":"a4b47835-6b54-47b6-9440-697fb4c18c22","email":"protected-test-o_KxkyrpA7FlPwp41RAoE@example.com","msg":"User registered"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle very long invalid token
DEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768681652736,"env":"test","module":"user-credentials-repository","userId":"bd83659d-31ce-4307-b248-227d00ecfaee","msg":"User credentials created"}
{"level":30,"time":1768681652825,"env":"test","module":"email-queue","jobId":"946e930a-2f80-4fc2-926a-d3e40667d5dc","to":"protected-test-UW_6dqQk0yNiQIrUoI6_7@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681652880,"env":"test","module":"auth-routes","userId":"bd83659d-31ce-4307-b248-227d00ecfaee","email":"protected-test-UW_6dqQk0yNiQIrUoI6_7@example.com","msg":"User registered"}
{"level":30,"time":1768681653568,"env":"test","module":"user-credentials-repository","userId":"737c0725-2402-482e-9c31-2bcb4043c0cd","msg":"User credentials created"}
{"level":30,"time":1768681653661,"env":"test","module":"email-queue","jobId":"cde16e43-da07-432f-ba55-ba7668aff555","to":"protected-test-GovxZlsem2IBvsSjka8uU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681653708,"env":"test","module":"auth-routes","userId":"737c0725-2402-482e-9c31-2bcb4043c0cd","email":"protected-test-GovxZlsem2IBvsSjka8uU@example.com","msg":"User registered"}
{"level":30,"time":1768681654402,"env":"test","module":"user-credentials-repository","userId":"34b54646-87c6-47fa-bf54-4fe6faec37ba","msg":"User credentials created"}
{"level":30,"time":1768681654493,"env":"test","module":"email-queue","jobId":"83105c8b-2870-411c-82bd-ad74f9cb1a74","to":"protected-test-XU45TtcReDcF_RrFVYUk8@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681654538,"env":"test","module":"auth-routes","userId":"34b54646-87c6-47fa-bf54-4fe6faec37ba","email":"protected-test-XU45TtcReDcF_RrFVYUk8@example.com","msg":"User registered"}
{"level":30,"time":1768681655327,"env":"test","module":"user-credentials-repository","userId":"6f5380f4-2661-4ab1-8320-9aec5716f276","msg":"User credentials created"}
{"level":30,"time":1768681655439,"env":"test","module":"email-queue","jobId":"3d37045a-7e67-412c-bed6-a819a398bbb6","to":"protected-test-1U_DIM_s3ZjNrKbwGiv-P@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681655494,"env":"test","module":"auth-routes","userId":"6f5380f4-2661-4ab1-8320-9aec5716f276","email":"protected-test-1U_DIM_s3ZjNrKbwGiv-P@example.com","msg":"User registered"}
{"level":30,"time":1768681656205,"env":"test","module":"user-credentials-repository","userId":"b6b5c2cf-b7ca-411f-9fc6-f0073120503f","msg":"User credentials created"}
{"level":30,"time":1768681656299,"env":"test","module":"email-queue","jobId":"3b9991d3-55c4-45e0-b472-d32731134815","to":"protected-test-26s3UWy4_SoA8FmPaUQDB@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681656347,"env":"test","module":"auth-routes","userId":"b6b5c2cf-b7ca-411f-9fc6-f0073120503f","email":"protected-test-26s3UWy4_SoA8FmPaUQDB@example.com","msg":"User registered"}
{"level":30,"time":1768681657045,"env":"test","module":"user-credentials-repository","userId":"7db4c45d-035e-4f19-ba99-fa70da55e183","msg":"User credentials created"}
{"level":30,"time":1768681657139,"env":"test","module":"email-queue","jobId":"986a6b57-8421-4081-9f99-bfef4bd0c122","to":"protected-test-MZDunIY8hTv42FXfMSMN7@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681657187,"env":"test","module":"auth-routes","userId":"7db4c45d-035e-4f19-ba99-fa70da55e183","email":"protected-test-MZDunIY8hTv42FXfMSMN7@example.com","msg":"User registered"}
{"level":30,"time":1768681657854,"env":"test","module":"user-credentials-repository","userId":"af0d51da-0e40-41b1-b954-5dbb4f9e96b9","msg":"User credentials created"}
{"level":30,"time":1768681657955,"env":"test","module":"email-queue","jobId":"cbbfe59e-1698-4136-b740-54c6a8d4eb7a","to":"protected-test-7Wc9Ubq7ZF7dJbdpjPuS2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681658000,"env":"test","module":"auth-routes","userId":"af0d51da-0e40-41b1-b954-5dbb4f9e96b9","email":"protected-test-7Wc9Ubq7ZF7dJbdpjPuS2@example.com","msg":"User registered"}
{"level":30,"time":1768681658684,"env":"test","module":"user-credentials-repository","userId":"7a7fb6df-e392-4bc3-8ca8-612c54327034","msg":"User credentials created"}
{"level":30,"time":1768681658778,"env":"test","module":"email-queue","jobId":"00321d6e-4d4d-4e04-b9c7-ad085ed62e7d","to":"protected-test-aY_plh_KNNjCd2lxgCzQk@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681658822,"env":"test","module":"auth-routes","userId":"7a7fb6df-e392-4bc3-8ca8-612c54327034","email":"protected-test-aY_plh_KNNjCd2lxgCzQk@example.com","msg":"User registered"}
{"level":30,"time":1768681659602,"env":"test","module":"user-credentials-repository","userId":"1d661017-1d22-4de4-8ca7-18f363f21e50","msg":"User credentials created"}
{"level":30,"time":1768681659719,"env":"test","module":"email-queue","jobId":"624f5b31-96e5-42aa-8bd4-9a8a19e59bd1","to":"protected-test-4hEAUcg919cGnmVQ84r9U@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681659860,"env":"test","module":"auth-routes","userId":"1d661017-1d22-4de4-8ca7-18f363f21e50","email":"protected-test-4hEAUcg919cGnmVQ84r9U@example.com","msg":"User registered"}
{"level":30,"time":1768681660596,"env":"test","module":"user-credentials-repository","userId":"807d1536-669c-4aa8-8e09-0b068d9b6c34","msg":"User credentials created"}
{"level":30,"time":1768681660687,"env":"test","module":"email-queue","jobId":"7b470728-fd4d-4f54-855e-1ee75f7772d8","to":"protected-test-CnWfq5s4CaSJC63Gcwh--@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681660733,"env":"test","module":"auth-routes","userId":"807d1536-669c-4aa8-8e09-0b068d9b6c34","email":"protected-test-CnWfq5s4CaSJC63Gcwh--@example.com","msg":"User registered"}
{"level":30,"time":1768681661505,"env":"test","module":"user-credentials-repository","userId":"69be7754-b6a4-4013-9d34-3be06a036295","msg":"User credentials created"}
{"level":30,"time":1768681661596,"env":"test","module":"email-queue","jobId":"d3c0fada-8884-49c9-b37a-822685591cec","to":"protected-test-WMX6jJbda5BsFza1et_m6@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681661639,"env":"test","module":"auth-routes","userId":"69be7754-b6a4-4013-9d34-3be06a036295","email":"protected-test-WMX6jJbda5BsFza1et_m6@example.com","msg":"User registered"}
{"level":30,"time":1768681662433,"env":"test","module":"user-credentials-repository","userId":"cb583098-24b3-4e8c-9f23-8801aec8240d","msg":"User credentials created"}
{"level":30,"time":1768681662548,"env":"test","module":"email-queue","jobId":"1eb94745-aa0a-4358-aeb3-71d22561f60c","to":"protected-test-VnqKn7z4sqIux01glnH4Q@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681662605,"env":"test","module":"auth-routes","userId":"cb583098-24b3-4e8c-9f23-8801aec8240d","email":"protected-test-VnqKn7z4sqIux01glnH4Q@example.com","msg":"User registered"}
{"level":30,"time":1768681663410,"env":"test","module":"user-credentials-repository","userId":"bc6eaea9-847c-4679-acb3-3c9d919faf76","msg":"User credentials created"}
{"level":30,"time":1768681663524,"env":"test","module":"email-queue","jobId":"6e059378-57d4-4edf-b852-8ad492ab2587","to":"protected-test-3UgC-935Aawhsc_lnARNL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768681663579,"env":"test","module":"auth-routes","userId":"bc6eaea9-847c-4679-acb3-3c9d919faf76","email":"protected-test-3UgC-935Aawhsc_lnARNL@example.com","msg":"User registered"}
{"level":30,"time":1768681664006,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681664006,"env":"test","msg":"DB: pool closed."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 22 failed | 1 skipped) 40848ms
       ├ù should allow access with valid Bearer token 602ms
       ├ù should reject access without Authorization header 898ms
       ├ù should reject access with empty Bearer token 980ms
       ├ù should reject access with malformed Authorization header 836ms
       ├ù should reject access with wrong token type 838ms
       ├ù should allow POST with valid Bearer token 910ms
       Γ£ô should reject POST without Bearer token  1641ms
       Γ£ô should reject POST with invalid token  1287ms
       Γ£ô should allow PUT with valid Bearer token  1466ms
       Γ£ô should reject PUT without Bearer token  1300ms
       Γ£ô should allow DELETE with valid Bearer token  1458ms
       Γ£ô should reject DELETE without Bearer token  1310ms
       Γ£ô should allow PATCH with valid Bearer token  2152ms
       Γ£ô should reject PATCH without Bearer token  1295ms
       Γ£ô should handle Bearer token with extra spaces  1314ms
       Γåô should handle token with newlines
       Γ£ô should handle very long invalid token  1313ms
       ├ù should handle empty Authorization header 402ms
       ├ù should handle Authorization header with only Bearer 789ms
       ├ù should handle multiple Authorization headers 836ms
       ├ù should reject token with SQL injection attempt 838ms
       ├ù should reject token with XSS attempt 828ms
       ├ù should reject token with missing userId 834ms
       ├ù should reject token with non-existent userId 966ms
       ├ù should not allow user to access another user's resources 840ms
       ├ù should inject userId into request context 839ms
       ├ù should inject tenantId into request context 812ms
       ├ù should inject role into request context 822ms
       ├ù should not apply general rate limiting to authenticated requests 1048ms
       ├ù should handle request with both Bearer token and cookies 945ms
       ├ù should prioritize Bearer token over cookie when both present 824ms
       ├ù should allow unauthenticated access to optional auth routes 976ms
       ├ù should enhance optional auth routes with user context when authenticated 976ms

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Tests 22 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
Error: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: cd32fad6-8320-4fc4-9627-74005c5556f2,dce9ec33-cbed-4ab4-9a3a-a662c63cd8c8,admin
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:71:13

Caused by: error: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:71:13

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 401, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(cd32fad6-8320-4fc4-9627-74005c5556f2) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w140_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/22]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 19a276fe-0346-4314-ab2b-d6a95b467857,owner,true,9b28aa1f-a573-4f3a-ba02-ed3ad4f27684
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(19a276fe-0346-4314-ab2b-d6a95b467857) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w140_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/22]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 19a276fe-0346-4314-ab2b-d6a95b467857,owner,true,e9a0b477-c9f3-4805-9e3e-b7681e7ca2cf
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(19a276fe-0346-4314-ab2b-d6a95b467857) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w140_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[3/22]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with malformed Authorization header
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 19a276fe-0346-4314-ab2b-d6a95b467857,owner,true,396989f6-9ef6-49f4-ac15-4e5f4add91c1
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(19a276fe-0346-4314-ab2b-d6a95b467857) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w140_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[4/22]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 19a276fe-0346-4314-ab2b-d6a95b467857,owner,true,c2fd1a14-8c02-421a-975a-7166a5d70f56
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(19a276fe-0346-4314-ab2b-d6a95b467857) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w140_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[5/22]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle empty Authorization header
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle Authorization header with only Bearer
Error: expected 201 "Created", got 500 "Internal Server Error"
 Γ¥» tests/integration/auth/protected.routes.test.ts:56:14
 Γ¥» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Γ¥» node_modules/supertest/lib/test.js:365:13
 Γ¥» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Γ¥» Test.assert node_modules/supertest/lib/test.js:195:23
 Γ¥» localAssert node_modules/supertest/lib/test.js:138:14
 Γ¥» node_modules/supertest/lib/test.js:156:7
 Γ¥» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Γ¥» node_modules/superagent/lib/node/index.js:1102:18
 Γ¥» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[6/22]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should handle multiple Authorization headers
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 19a276fe-0346-4314-ab2b-d6a95b467857,owner,true,a4b47835-6b54-47b6-9440-697fb4c18c22
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(19a276fe-0346-4314-ab2b-d6a95b467857) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w140_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[7/22]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with SQL injection attempt
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 19a276fe-0346-4314-ab2b-d6a95b467857,owner,true,bd83659d-31ce-4307-b248-227d00ecfaee
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(19a276fe-0346-4314-ab2b-d6a95b467857) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w140_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[8/22]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Edge Cases > should reject token with XSS attempt
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 19a276fe-0346-4314-ab2b-d6a95b467857,owner,true,737c0725-2402-482e-9c31-2bcb4043c0cd
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(19a276fe-0346-4314-ab2b-d6a95b467857) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w140_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[9/22]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with missing userId
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 19a276fe-0346-4314-ab2b-d6a95b467857,owner,true,34b54646-87c6-47fa-bf54-4fe6faec37ba
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(19a276fe-0346-4314-ab2b-d6a95b467857) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w140_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[10/22]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Token Payload Validation > should reject token with non-existent userId
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 19a276fe-0346-4314-ab2b-d6a95b467857,owner,true,6f5380f4-2661-4ab1-8320-9aec5716f276
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(19a276fe-0346-4314-ab2b-d6a95b467857) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w140_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[11/22]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Cross-User Authorization > should not allow user to access another user's resources
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 19a276fe-0346-4314-ab2b-d6a95b467857,owner,true,b6b5c2cf-b7ca-411f-9fc6-f0073120503f
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(19a276fe-0346-4314-ab2b-d6a95b467857) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w140_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[12/22]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject userId into request context
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 19a276fe-0346-4314-ab2b-d6a95b467857,owner,true,7db4c45d-035e-4f19-ba99-fa70da55e183
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(19a276fe-0346-4314-ab2b-d6a95b467857) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w140_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[13/22]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject tenantId into request context
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 19a276fe-0346-4314-ab2b-d6a95b467857,owner,true,af0d51da-0e40-41b1-b954-5dbb4f9e96b9
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(19a276fe-0346-4314-ab2b-d6a95b467857) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w140_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[14/22]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > User Context Injection > should inject role into request context
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 19a276fe-0346-4314-ab2b-d6a95b467857,owner,true,7a7fb6df-e392-4bc3-8ca8-612c54327034
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(19a276fe-0346-4314-ab2b-d6a95b467857) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w140_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[15/22]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Rate Limiting on Protected Routes > should not apply general rate limiting to authenticated requests
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 19a276fe-0346-4314-ab2b-d6a95b467857,owner,true,1d661017-1d22-4de4-8ca7-18f363f21e50
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(19a276fe-0346-4314-ab2b-d6a95b467857) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w140_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[16/22]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should handle request with both Bearer token and cookies
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 19a276fe-0346-4314-ab2b-d6a95b467857,owner,true,807d1536-669c-4aa8-8e09-0b068d9b6c34
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(19a276fe-0346-4314-ab2b-d6a95b467857) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w140_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[17/22]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Mixed Auth Scenarios > should prioritize Bearer token over cookie when both present
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 19a276fe-0346-4314-ab2b-d6a95b467857,owner,true,69be7754-b6a4-4013-9d34-3be06a036295
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(19a276fe-0346-4314-ab2b-d6a95b467857) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w140_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[18/22]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should allow unauthenticated access to optional auth routes
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 19a276fe-0346-4314-ab2b-d6a95b467857,owner,true,cb583098-24b3-4e8c-9f23-8801aec8240d
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(19a276fe-0346-4314-ab2b-d6a95b467857) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w140_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[19/22]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > Optional Auth Routes > should enhance optional auth routes with user context when authenticated
Error: Failed query: update "users" set "tenant_id" = $1, "tenant_role" = $2, "email_verified" = $3 where "users"."id" = $4
params: 19a276fe-0346-4314-ab2b-d6a95b467857,owner,true,bc6eaea9-847c-4679-acb3-3c9d919faf76
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

Caused by: error: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:113:20
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» tests/integration/auth/protected.routes.test.ts:60:9

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 316, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(19a276fe-0346-4314-ab2b-d6a95b467857) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w140_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[20/22]ΓÄ»


 Test Files  1 failed (1)
      Tests  22 failed | 10 passed | 1 skipped (33)
   Start at  14:25:29
   Duration  121.24s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x16 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  suppress all logs with { quiet: true }

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ΓÜÖ∩╕Å  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681690046,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stderr | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Failed to create schema test_schema_w0_v3: error: Too many connections attempts
    at Parser.parseErrorMessage (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:285:98)
    at Parser.handlePacket (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:122:29)
    at Parser.parse (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:35:38)
    at TLSSocket.<anonymous> (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\index.js:11:42)
    at TLSSocket.emit (node:events:508:28)
    at addChunk (node:internal/streams/readable:559:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
    at TLSSocket.Readable.push (node:internal/streams/readable:390:5)
    at TLSWrap.onStreamRead (node:internal/stream_base_commons:189:23) {
  length: 50,
  severity: 'ERROR',
  code: 'XX000',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: undefined,
  line: undefined,
  routine: undefined
}

stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): error: Too many connections attempts
    at Parser.parseErrorMessage (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:285:98)
    at Parser.handlePacket (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:122:29)
    at Parser.parse (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\parser.js:35:38)
    at TLSSocket.<anonymous> (C:\Users\scoot\poll\VaultLogic\node_modules\pg-protocol\dist\index.js:11:42)
    at TLSSocket.emit (node:events:508:28)
    at addChunk (node:internal/streams/readable:559:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
    at TLSSocket.Readable.push (node:internal/streams/readable:390:5)
    at TLSWrap.onStreamRead (node:internal/stream_base_commons:189:23) {
  length: 50,
  severity: 'ERROR',
  code: 'XX000',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: undefined,
  line: undefined,
  routine: undefined
}

{"level":30,"time":1768681696674,"env":"test","msg":"DB: initializing... Local"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

{"level":30,"time":1768681696730,"env":"test","msg":"DB: initialized flag set."}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681696808,"env":"test","msg":"Real-time collaboration server initialized"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768681696738,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681696796,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681696796,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681696801,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681696801,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681696806,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681696807,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681696807,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681696808,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant xDwzTYV5NUK3cf_INSbXT,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant xDwzTYV5NUK3cf_INSbXT', 'pro' ],
  cause: error: Too many connections attempts
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 50,
    severity: 'ERROR',
    code: 'XX000',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 996ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant xDwzTYV5NUK3cf_INSbXT,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: Too many connections attempts
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 50, severity: 'ERROR', code: 'XX000', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:27:49
   Duration  20.21s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  server/db.ts x17 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681927603,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768681931600,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681931600,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681935438,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768681935823,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768681935841,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768681935831,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681935831,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681935836,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681935836,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681935840,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681935840,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681935841,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681935841,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768681936144,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768681936145,"env":"test","msg":"DB: pool closed."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:196:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:196:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant TAgYERNBpMSCSha7F_4Ht,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant TAgYERNBpMSCSha7F_4Ht', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 5555ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant TAgYERNBpMSCSha7F_4Ht,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:31:54
   Duration  19.00s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  tests/setup.ts x18 
        Filename pattern: tests/integration/auth/protected.routes.test.ts

stdout | tests/integration/auth/protected.routes.test.ts
SETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/auth/protected.routes.test.ts
[dotenv@17.2.3] injecting env (0) from .env -- tip: ≡ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768681990065,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
stdout | tests/integration/auth/protected.routes.test.ts
Γ£à OpenAPI specification loaded successfully

stdout | tests/integration/auth/protected.routes.test.ts
[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒöÆ Test Schema Isolated: test_schema_w0_v3 (Reused: true)
≡ƒöº Set PGOPTIONS: -c search_path="test_schema_w0_v3",public

stdout | tests/integration/auth/protected.routes.test.ts
≡ƒôè Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768681994162,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768681994163,"env":"test","msg":"DB: Configured pool with search_path=\"test_schema_w0_v3\",public via connect event"}
{"level":30,"time":1768681994298,"env":"test","msg":"DB: initialized flag set."}
stderr | tests/integration/auth/protected.routes.test.ts
ΓÜá∩╕Å Database initialization failed (ignoring for unit tests or mock scenarios): DrizzleQueryError: Failed query: SET search_path TO "test_schema_w0_v3", public
params: 
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
  query: 'SET search_path TO "test_schema_w0_v3", public',
  params: [],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:199:11 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[DEBUG] Database initialized.

{"level":30,"time":1768681994648,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
stdout | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
≡ƒôÜ API Documentation available at /api-docs

{"level":30,"time":1768681994669,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768681994657,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768681994658,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768681994663,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768681994663,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768681994668,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768681994668,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768681994668,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768681994669,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
[FATAL] setupIntegrationTest failed: DrizzleQueryError: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant NYQ5ROvTTf-vC3Kf5mYsk,pro
    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
  query: 'insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"',
  params: [ 'Protected Routes Test Tenant NYQ5ROvTTf-vC3Kf5mYsk', 'pro' ],
  cause: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
      at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
      at processTicksAndRejections (node:internal/process/task_queues:103:5)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)
      at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22
      at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:96:22)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15 {
    length: 250,
    severity: 'ERROR',
    code: '08P01',
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined
  }
}

{"level":30,"time":1768681994984,"env":"test","msg":"DB: closing pool..."}
stdout | tests/integration/auth/protected.routes.test.ts
≡ƒº╣ Cleaning up test environment...

 Γ¥» tests/integration/auth/protected.routes.test.ts (33 tests | 33 skipped) 1752ms
       Γåô should allow access with valid Bearer token
       Γåô should reject access without Authorization header
       Γåô should reject access with empty Bearer token
       Γåô should reject access with malformed Authorization header
       Γåô should reject access with wrong token type
       Γåô should allow POST with valid Bearer token
       Γåô should reject POST without Bearer token
       Γåô should reject POST with invalid token
       Γåô should allow PUT with valid Bearer token
       Γåô should reject PUT without Bearer token
       Γåô should allow DELETE with valid Bearer token
       Γåô should reject DELETE without Bearer token
       Γåô should allow PATCH with valid Bearer token
       Γåô should reject PATCH without Bearer token
       Γåô should handle Bearer token with extra spaces
       Γåô should handle token with newlines
       Γåô should handle very long invalid token
       Γåô should handle empty Authorization header
       Γåô should handle Authorization header with only Bearer
       Γåô should handle multiple Authorization headers
       Γåô should reject token with SQL injection attempt
       Γåô should reject token with XSS attempt
       Γåô should reject token with missing userId
       Γåô should reject token with non-existent userId
       Γåô should not allow user to access another user's resources
       Γåô should inject userId into request context
       Γåô should inject tenantId into request context
       Γåô should inject role into request context
       Γåô should not apply general rate limiting to authenticated requests
       Γåô should handle request with both Bearer token and cookies
       Γåô should prioritize Bearer token over cookie when both present
       Γåô should allow unauthenticated access to optional auth routes
       Γåô should enhance optional auth routes with user context when authenticated
{"level":30,"time":1768681994984,"env":"test","msg":"DB: pool closed."}

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ» Failed Suites 1 ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
Error: Failed query: insert into "tenants" ("id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at") values (default, $1, default, $2, default, default, default, default) returning "id", "name", "billing_email", "plan", "mfa_required", "branding", "created_at", "updated_at"
params: Protected Routes Test Tenant NYQ5ROvTTf-vC3Kf5mYsk,pro
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:41:15
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
     94| 
     95|     // Create tenant
     96|     const [tenant] = await db.insert(schema.tenants).values({
       |                      ^
     97|       name: `${tenantName} ${nanoid()}`,
     98|       plan: 'pro',
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

Caused by: error: unsupported startup parameter in options: search_path. Please use unpooled connection or remove this parameter from the startup package. More details: https://neon.tech/docs/connect/connection-errors#unsupported-startup-parameter
 Γ¥» node_modules/pg-pool/index.js:45:11
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:124:18
 Γ¥» NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:39:16
 Γ¥» node_modules/drizzle-orm/node-postgres/session.js:117:22
 Γ¥» setupIntegrationTest tests/helpers/integrationTestHelper.ts:96:22
 Γ¥» tests/integration/auth/protected.routes.test.ts:31:15

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»
Serialized Error: { length: 250, severity: 'ERROR', code: '08P01', detail: undefined, hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: undefined, routine: undefined }
ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[1/2]ΓÄ»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests
TypeError: Cannot read properties of undefined (reading 'cleanup')
 Γ¥» tests/integration/auth/protected.routes.test.ts:41:19
     39| 
     40|     afterAll(async () => {
     41|         await ctx.cleanup();
       |                   ^
     42|     });
     43| 

ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»ΓÄ»[2/2]ΓÄ»


 Test Files  1 failed (1)
      Tests  33 skipped (33)
   Start at  14:32:18
   Duration  54.06s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
